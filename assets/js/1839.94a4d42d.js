/*! For license information please see 1839.94a4d42d.js.LICENSE.txt */
(self.webpackChunkvis_engine_docs=self.webpackChunkvis_engine_docs||[]).push([[1839],{1839:function(t,e,n){!function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var r,o=i(e),s=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self&&self,{exports:{}});r=s,function(t,e){r.exports=e()}(0,(function(){var t=function(t){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof Float64Array||t instanceof Uint8ClampedArray},e=function(t,e){for(var n=Object.keys(e),i=0;i<n.length;++i)t[n[i]]=e[n[i]];return t},n="\n";function i(t){return"undefined"!=typeof atob?atob(t):"base64:"+t}function r(t){var e=new Error("(regl) "+t);throw console.error(e),e}function o(t,e){t||r(e)}function s(t){return t?": "+t:""}function a(t,e,n){t in e||r("unknown parameter ("+t+")"+s(n)+". possible values: "+Object.keys(e).join())}function h(e,n){t(e)||r("invalid parameter type"+s(n)+". must be a typed array")}function l(t,e){switch(e){case"number":return"number"==typeof t;case"object":return"object"==typeof t;case"string":return"string"==typeof t;case"boolean":return"boolean"==typeof t;case"function":return"function"==typeof t;case"undefined":return void 0===t;case"symbol":return"symbol"==typeof t}}function c(t,e,n){l(t,e)||r("invalid parameter type"+s(n)+". expected "+e+", got "+typeof t)}function u(t,e){t>=0&&(0|t)===t||r("invalid parameter type, ("+t+")"+s(e)+". must be a nonnegative integer")}function f(t,e,n){e.indexOf(t)<0&&r("invalid value"+s(n)+". must be one of: "+e)}var d=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function m(t){Object.keys(t).forEach((function(t){d.indexOf(t)<0&&r('invalid regl constructor argument "'+t+'". must be one of '+d)}))}function g(t,e){for(t+="";t.length<e;)t=" "+t;return t}function p(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function _(t,e){this.number=t,this.line=e,this.errors=[]}function v(t,e,n){this.file=t,this.line=e,this.message=n}function y(){var t=new Error,e=(t.stack||t).toString(),n=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(e);if(n)return n[1];var i=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(e);return i?i[1]:"unknown"}function x(){var t=new Error,e=(t.stack||t).toString(),n=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(e);if(n)return n[1];var i=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(e);return i?i[1]:"unknown"}function b(t,e){var n=t.split("\n"),r=1,o=0,s={unknown:new p,0:new p};s.unknown.name=s[0].name=e||y(),s.unknown.lines.push(new _(0,""));for(var a=0;a<n.length;++a){var h=n[a],l=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(h);if(l)switch(l[1]){case"line":var c=/(\d+)(\s+\d+)?/.exec(l[2]);c&&(r=0|c[1],c[2]&&((o=0|c[2])in s||(s[o]=new p)));break;case"define":var u=/SHADER_NAME(_B64)?\s+(.*)$/.exec(l[2]);u&&(s[o].name=u[1]?i(u[2]):u[2])}s[o].lines.push(new _(r++,h))}return Object.keys(s).forEach((function(t){var e=s[t];e.lines.forEach((function(t){e.index[t.number]=t}))})),s}function w(t){var e=[];return t.split("\n").forEach((function(t){if(!(t.length<5)){var n=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(t);n?e.push(new v(0|n[1],0|n[2],n[3].trim())):t.length>0&&e.push(new v("unknown",0,t))}})),e}function T(t,e){e.forEach((function(e){var n=t[e.file];if(n){var i=n.index[e.line];if(i)return i.errors.push(e),void(n.hasErrors=!0)}t.unknown.hasErrors=!0,t.unknown.lines[0].errors.push(e)}))}function M(t,e,i,r,s){if(!t.getShaderParameter(e,t.COMPILE_STATUS)){var a=t.getShaderInfoLog(e),h=r===t.FRAGMENT_SHADER?"fragment":"vertex";O(i,"string",h+" shader source must be a string",s);var l=b(i,s),c=w(a);T(l,c),Object.keys(l).forEach((function(t){var e=l[t];if(e.hasErrors){var i=[""],r=[""];o("file number "+t+": "+e.name+"\n","color:red;text-decoration:underline;font-weight:bold"),e.lines.forEach((function(t){if(t.errors.length>0){o(g(t.number,4)+"|  ","background-color:yellow; font-weight:bold"),o(t.line+n,"color:red; background-color:yellow; font-weight:bold");var e=0;t.errors.forEach((function(i){var r=i.message,s=/^\s*'(.*)'\s*:\s*(.*)$/.exec(r);if(s){var a=s[1];r=s[2],"assign"===a&&(a="="),e=Math.max(t.line.indexOf(a,e),0)}else e=0;o(g("| ",6)),o(g("^^^",e+3)+n,"font-weight:bold"),o(g("| ",6)),o(r+n,"font-weight:bold")})),o(g("| ",6)+n)}else o(g(t.number,4)+"|  "),o(t.line+n,"color:red")})),"undefined"==typeof document||window.chrome?console.log(i.join("")):(r[0]=i.join("%c"),console.log.apply(console,r))}function o(t,e){i.push(t),r.push(e||"")}})),o.raise("Error compiling "+h+" shader, "+l[0].name)}}function A(t,e,i,r,s){if(!t.getProgramParameter(e,t.LINK_STATUS)){var a=t.getProgramInfoLog(e),h=b(i,s),l='Error linking program with vertex shader, "'+b(r,s)[0].name+'", and fragment shader "'+h[0].name+'"';"undefined"!=typeof document?console.log("%c"+l+n+"%c"+a,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(l+n+a),o.raise(l)}}function E(t){t._commandRef=y()}function C(t,e,n,i){function r(t){return t?i.id(t):0}function o(t,e){Object.keys(e).forEach((function(e){t[i.id(e)]=!0}))}E(t),t._fragId=r(t.static.frag),t._vertId=r(t.static.vert);var s=t._uniformSet={};o(s,e.static),o(s,e.dynamic);var a=t._attributeSet={};o(a,n.static),o(a,n.dynamic),t._hasCount="count"in t.static||"count"in t.dynamic||"elements"in t.static||"elements"in t.dynamic}function S(t,e){var n=x();r(t+" in command "+(e||y())+("unknown"===n?"":" called from "+n))}function P(t,e,n){t||S(e,n||y())}function R(t,e,n,i){t in e||S("unknown parameter ("+t+")"+s(n)+". possible values: "+Object.keys(e).join(),i||y())}function O(t,e,n,i){l(t,e)||S("invalid parameter type"+s(n)+". expected "+e+", got "+typeof t,i||y())}function I(t){t()}function D(t,e,n){t.texture?f(t.texture._texture.internalformat,e,"unsupported texture format for attachment"):f(t.renderbuffer._renderbuffer.format,n,"unsupported renderbuffer format for attachment")}var k=33071,L=9728,F=9984,N=9985,B=9986,H=9987,j=5121,z=5122,G=5123,U=5124,V=5125,W=5126,X=32819,Z=32820,q=33635,Y=34042,K=36193,J={};function Q(t,e){return t===Z||t===X||t===q?2:t===Y?4:J[t]*e}function $(t){return!(t&t-1||!t)}function tt(t,e,n){var i,r=e.width,s=e.height,a=e.channels;o(r>0&&r<=n.maxTextureSize&&s>0&&s<=n.maxTextureSize,"invalid texture shape"),t.wrapS===k&&t.wrapT===k||o($(r)&&$(s),"incompatible wrap mode for texture, both width and height must be power of 2"),1===e.mipmask?1!==r&&1!==s&&o(t.minFilter!==F&&t.minFilter!==B&&t.minFilter!==N&&t.minFilter!==H,"min filter requires mipmap"):(o($(r)&&$(s),"texture must be a square power of 2 to support mipmapping"),o(e.mipmask===(r<<1)-1,"missing or incomplete mipmap data")),e.type===W&&(n.extensions.indexOf("oes_texture_float_linear")<0&&o(t.minFilter===L&&t.magFilter===L,"filter not supported, must enable oes_texture_float_linear"),o(!t.genMipmaps,"mipmap generation not supported with float textures"));var h=e.images;for(i=0;i<16;++i)if(h[i]){var l=r>>i,c=s>>i;o(e.mipmask&1<<i,"missing mipmap data");var u=h[i];if(o(u.width===l&&u.height===c,"invalid shape for mip images"),o(u.format===e.format&&u.internalformat===e.internalformat&&u.type===e.type,"incompatible type for mip image"),u.compressed);else if(u.data){var f=Math.ceil(Q(u.type,a)*l/u.unpackAlignment)*u.unpackAlignment;o(u.data.byteLength===f*c,"invalid data for image, buffer size is inconsistent with image format")}else u.element||u.copy}else t.genMipmaps||o(0==(e.mipmask&1<<i),"extra mipmap data");e.compressed&&o(!t.genMipmaps,"mipmap generation for compressed images not supported")}function et(t,e,n,i){var r=t.width,s=t.height,a=t.channels;o(r>0&&r<=i.maxTextureSize&&s>0&&s<=i.maxTextureSize,"invalid texture shape"),o(r===s,"cube map must be square"),o(e.wrapS===k&&e.wrapT===k,"wrap mode not supported by cube map");for(var h=0;h<n.length;++h){var l=n[h];o(l.width===r&&l.height===s,"inconsistent cube map face shape"),e.genMipmaps&&(o(!l.compressed,"can not generate mipmap for compressed textures"),o(1===l.mipmask,"can not specify mipmaps and generate mipmaps"));for(var c=l.images,u=0;u<16;++u){var f=c[u];if(f){var d=r>>u,m=s>>u;o(l.mipmask&1<<u,"missing mipmap data"),o(f.width===d&&f.height===m,"invalid shape for mip images"),o(f.format===t.format&&f.internalformat===t.internalformat&&f.type===t.type,"incompatible type for mip image"),f.compressed||(f.data?o(f.data.byteLength===d*m*Math.max(Q(f.type,a),f.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):f.element||f.copy)}}}}J[5120]=J[j]=1,J[z]=J[G]=J[K]=J[q]=J[X]=J[Z]=2,J[U]=J[V]=J[W]=J[Y]=4;var nt=e(o,{optional:I,raise:r,commandRaise:S,command:P,parameter:a,commandParameter:R,constructor:m,type:c,commandType:O,isTypedArray:h,nni:u,oneOf:f,shaderError:M,linkError:A,callSite:x,saveCommandRef:E,saveDrawInfo:C,framebufferFormat:D,guessCommand:y,texture2D:tt,textureCube:et}),it=0,rt=0,ot=5,st=6;function at(t,e){this.id=it++,this.type=t,this.data=e}function ht(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function lt(t){if(0===t.length)return[];var e=t.charAt(0),n=t.charAt(t.length-1);if(t.length>1&&e===n&&('"'===e||"'"===e))return['"'+ht(t.substr(1,t.length-2))+'"'];var i=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(t);if(i)return lt(t.substr(0,i.index)).concat(lt(i[1])).concat(lt(t.substr(i.index+i[0].length)));var r=t.split(".");if(1===r.length)return['"'+ht(t)+'"'];for(var o=[],s=0;s<r.length;++s)o=o.concat(lt(r[s]));return o}function ct(t){return"["+lt(t).join("][")+"]"}function ut(t,e){return new at(t,ct(e+""))}function ft(t){return"function"==typeof t&&!t._reglType||t instanceof at}function dt(t,e){return"function"==typeof t?new at(rt,t):"number"==typeof t||"boolean"==typeof t?new at(ot,t):Array.isArray(t)?new at(st,t.map((function(t,n){return dt(t,e+"["+n+"]")}))):t instanceof at?t:void nt(!1,"invalid option type in uniform "+e)}var mt={DynamicVariable:at,define:ut,isDynamic:ft,unbox:dt,accessor:ct},gt={next:"function"==typeof requestAnimationFrame?function(t){return requestAnimationFrame(t)}:function(t){return setTimeout(t,16)},cancel:"function"==typeof cancelAnimationFrame?function(t){return cancelAnimationFrame(t)}:clearTimeout},pt="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function _t(){var t={"":0},e=[""];return{id:function(n){var i=t[n];return i||(i=t[n]=e.length,e.push(n),i)},str:function(t){return e[t]}}}function vt(t,n,i){var r,o=document.createElement("canvas");function s(){var n=window.innerWidth,r=window.innerHeight;if(t!==document.body){var s=t.getBoundingClientRect();n=s.right-s.left,r=s.bottom-s.top}o.width=i*n,o.height=i*r,e(o.style,{width:n+"px",height:r+"px"})}function a(){r?r.disconnect():window.removeEventListener("resize",s),t.removeChild(o)}return e(o.style,{border:0,margin:0,padding:0,top:0,left:0}),t.appendChild(o),t===document.body&&(o.style.position="absolute",e(t.style,{margin:0,padding:0})),t!==document.body&&"function"==typeof ResizeObserver?(r=new ResizeObserver((function(){setTimeout(s)}))).observe(t):window.addEventListener("resize",s,!1),s(),{canvas:o,onDestroy:a}}function yt(t,e){function n(n){try{return t.getContext(n,e)}catch(mA){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function xt(t){return"string"==typeof t.nodeName&&"function"==typeof t.appendChild&&"function"==typeof t.getBoundingClientRect}function bt(t){return"function"==typeof t.drawArrays||"function"==typeof t.drawElements}function wt(t){return"string"==typeof t?t.split():(nt(Array.isArray(t),"invalid extension array"),t)}function Tt(t){return"string"==typeof t?(nt("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(t)):t}function Mt(t){var e,n,i,r,o=t||{},s={},a=[],h=[],l="undefined"==typeof window?1:window.devicePixelRatio,c=!1,u=function(t){t&&nt.raise(t)},f=function(){};if("string"==typeof o?(nt("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),e=document.querySelector(o),nt(e,"invalid query string for element")):"object"==typeof o?xt(o)?e=o:bt(o)?i=(r=o).canvas:(nt.constructor(o),"gl"in o?r=o.gl:"canvas"in o?i=Tt(o.canvas):"container"in o&&(n=Tt(o.container)),"attributes"in o&&(s=o.attributes,nt.type(s,"object","invalid context attributes")),"extensions"in o&&(a=wt(o.extensions)),"optionalExtensions"in o&&(h=wt(o.optionalExtensions)),"onDone"in o&&(nt.type(o.onDone,"function","invalid or missing onDone callback"),u=o.onDone),"profile"in o&&(c=!!o.profile),"pixelRatio"in o&&(l=+o.pixelRatio,nt(l>0,"invalid pixel ratio"))):nt.raise("invalid arguments to regl"),e&&("canvas"===e.nodeName.toLowerCase()?i=e:n=e),!r){if(!i){nt("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var d=vt(n||document.body,u,l);if(!d)return null;i=d.canvas,f=d.onDestroy}void 0===s.premultipliedAlpha&&(s.premultipliedAlpha=!0),r=yt(i,s)}return r?{gl:r,canvas:i,container:n,extensions:a,optionalExtensions:h,pixelRatio:l,profile:c,onDone:u,onDestroy:f}:(f(),u("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function At(t,e){var n={};function i(e){nt.type(e,"string","extension name must be string");var i,r=e.toLowerCase();try{i=n[r]=t.getExtension(r)}catch(mA){}return!!i}for(var r=0;r<e.extensions.length;++r){var o=e.extensions[r];if(!i(o))return e.onDestroy(),e.onDone('"'+o+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return e.optionalExtensions.forEach(i),{extensions:n,restore:function(){Object.keys(n).forEach((function(t){if(n[t]&&!i(t))throw new Error("(regl): error restoring extension "+t)}))}}}function Et(t,e){for(var n=Array(t),i=0;i<t;++i)n[i]=e(i);return n}var Ct=5120,St=5121,Pt=5122,Rt=5123,Ot=5124,It=5125,Dt=5126;function kt(t){for(var e=16;e<=1<<28;e*=16)if(t<=e)return e;return 0}function Lt(t){var e,n;return e=(t>65535)<<4,e|=n=((t>>>=e)>255)<<3,e|=n=((t>>>=n)>15)<<2,(e|=n=((t>>>=n)>3)<<1)|(t>>>=n)>>1}function Ft(){var t=Et(8,(function(){return[]}));function e(e){var n=kt(e),i=t[Lt(n)>>2];return i.length>0?i.pop():new ArrayBuffer(n)}function n(e){t[Lt(e.byteLength)>>2].push(e)}function i(t,n){var i=null;switch(t){case Ct:i=new Int8Array(e(n),0,n);break;case St:i=new Uint8Array(e(n),0,n);break;case Pt:i=new Int16Array(e(2*n),0,n);break;case Rt:i=new Uint16Array(e(2*n),0,n);break;case Ot:i=new Int32Array(e(4*n),0,n);break;case It:i=new Uint32Array(e(4*n),0,n);break;case Dt:i=new Float32Array(e(4*n),0,n);break;default:return null}return i.length!==n?i.subarray(0,n):i}function r(t){n(t.buffer)}return{alloc:e,free:n,allocType:i,freeType:r}}var Nt=Ft();Nt.zero=Ft();var Bt=3408,Ht=3410,jt=3411,zt=3412,Gt=3413,Ut=3414,Vt=3415,Wt=33901,Xt=33902,Zt=3379,qt=3386,Yt=34921,Kt=36347,Jt=36348,Qt=35661,$t=35660,te=34930,ee=36349,ne=34076,ie=34024,re=7936,oe=7937,se=7938,ae=35724,he=34047,le=36063,ce=34852,ue=3553,fe=34067,de=34069,me=33984,ge=6408,pe=5126,_e=5121,ve=36160,ye=36053,xe=36064,be=16384,we=function(t,e){var n=1;e.ext_texture_filter_anisotropic&&(n=t.getParameter(he));var i=1,r=1;e.webgl_draw_buffers&&(i=t.getParameter(ce),r=t.getParameter(le));var o=!!e.oes_texture_float;if(o){var s=t.createTexture();t.bindTexture(ue,s),t.texImage2D(ue,0,ge,1,1,0,ge,pe,null);var a=t.createFramebuffer();if(t.bindFramebuffer(ve,a),t.framebufferTexture2D(ve,xe,ue,s,0),t.bindTexture(ue,null),t.checkFramebufferStatus(ve)!==ye)o=!1;else{t.viewport(0,0,1,1),t.clearColor(1,0,0,1),t.clear(be);var h=Nt.allocType(pe,4);t.readPixels(0,0,1,1,ge,pe,h),t.getError()?o=!1:(t.deleteFramebuffer(a),t.deleteTexture(s),o=1===h[0]),Nt.freeType(h)}}var l=!0;if("undefined"==typeof navigator||!(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))){var c=t.createTexture(),u=Nt.allocType(_e,36);t.activeTexture(me),t.bindTexture(fe,c),t.texImage2D(de,0,ge,3,3,0,ge,_e,u),Nt.freeType(u),t.bindTexture(fe,null),t.deleteTexture(c),l=!t.getError()}return{colorBits:[t.getParameter(Ht),t.getParameter(jt),t.getParameter(zt),t.getParameter(Gt)],depthBits:t.getParameter(Ut),stencilBits:t.getParameter(Vt),subpixelBits:t.getParameter(Bt),extensions:Object.keys(e).filter((function(t){return!!e[t]})),maxAnisotropic:n,maxDrawbuffers:i,maxColorAttachments:r,pointSizeDims:t.getParameter(Wt),lineWidthDims:t.getParameter(Xt),maxViewportDims:t.getParameter(qt),maxCombinedTextureUnits:t.getParameter(Qt),maxCubeMapSize:t.getParameter(ne),maxRenderbufferSize:t.getParameter(ie),maxTextureUnits:t.getParameter(te),maxTextureSize:t.getParameter(Zt),maxAttributes:t.getParameter(Yt),maxVertexUniforms:t.getParameter(Kt),maxVertexTextureUnits:t.getParameter($t),maxVaryingVectors:t.getParameter(Jt),maxFragmentUniforms:t.getParameter(ee),glsl:t.getParameter(ae),renderer:t.getParameter(oe),vendor:t.getParameter(re),version:t.getParameter(se),readFloat:o,npotTextureCube:l}};function Te(e){return!!e&&"object"==typeof e&&Array.isArray(e.shape)&&Array.isArray(e.stride)&&"number"==typeof e.offset&&e.shape.length===e.stride.length&&(Array.isArray(e.data)||t(e.data))}var Me=function(t){return Object.keys(t).map((function(e){return t[e]}))},Ae={shape:Oe,flatten:Re};function Ee(t,e,n){for(var i=0;i<e;++i)n[i]=t[i]}function Ce(t,e,n,i){for(var r=0,o=0;o<e;++o)for(var s=t[o],a=0;a<n;++a)i[r++]=s[a]}function Se(t,e,n,i,r,o){for(var s=o,a=0;a<e;++a)for(var h=t[a],l=0;l<n;++l)for(var c=h[l],u=0;u<i;++u)r[s++]=c[u]}function Pe(t,e,n,i,r){for(var o=1,s=n+1;s<e.length;++s)o*=e[s];var a=e[n];if(e.length-n==4){var h=e[n+1],l=e[n+2],c=e[n+3];for(s=0;s<a;++s)Se(t[s],h,l,c,i,r),r+=o}else for(s=0;s<a;++s)Pe(t[s],e,n+1,i,r),r+=o}function Re(t,e,n,i){var r=1;if(e.length)for(var o=0;o<e.length;++o)r*=e[o];else r=0;var s=i||Nt.allocType(n,r);switch(e.length){case 0:break;case 1:Ee(t,e[0],s);break;case 2:Ce(t,e[0],e[1],s);break;case 3:Se(t,e[0],e[1],e[2],s,0);break;default:Pe(t,e,0,s,0)}return s}function Oe(t){for(var e=[],n=t;n.length;n=n[0])e.push(n.length);return e}var Ie={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},De={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},ke={dynamic:35048,stream:35040,static:35044},Le=Ae.flatten,Fe=Ae.shape,Ne=35044,Be=35040,He=5121,je=5126,ze=[];function Ge(t){return 0|Ie[Object.prototype.toString.call(t)]}function Ue(t,e){for(var n=0;n<e.length;++n)t[n]=e[n]}function Ve(t,e,n,i,r,o,s){for(var a=0,h=0;h<n;++h)for(var l=0;l<i;++l)t[a++]=e[r*h+o*l+s]}function We(e,n,i,r){var o=0,s={};function a(t){this.id=o++,this.buffer=e.createBuffer(),this.type=t,this.usage=Ne,this.byteLength=0,this.dimension=1,this.dtype=He,this.persistentData=null,i.profile&&(this.stats={size:0})}a.prototype.bind=function(){e.bindBuffer(this.type,this.buffer)},a.prototype.destroy=function(){d(this)};var h=[];function l(t,e){var n=h.pop();return n||(n=new a(t)),n.bind(),f(n,e,Be,0,1,!1),n}function c(t){h.push(t)}function u(t,n,i){t.byteLength=n.byteLength,e.bufferData(t.type,n,i)}function f(e,n,i,r,o,s){var a,h;if(e.usage=i,Array.isArray(n)){if(e.dtype=r||je,n.length>0)if(Array.isArray(n[0])){a=Fe(n);for(var l=1,c=1;c<a.length;++c)l*=a[c];e.dimension=l,u(e,h=Le(n,a,e.dtype),i),s?e.persistentData=h:Nt.freeType(h)}else if("number"==typeof n[0]){e.dimension=o;var f=Nt.allocType(e.dtype,n.length);Ue(f,n),u(e,f,i),s?e.persistentData=f:Nt.freeType(f)}else t(n[0])?(e.dimension=n[0].length,e.dtype=r||Ge(n[0])||je,u(e,h=Le(n,[n.length,n[0].length],e.dtype),i),s?e.persistentData=h:Nt.freeType(h)):nt.raise("invalid buffer data")}else if(t(n))e.dtype=r||Ge(n),e.dimension=o,u(e,n,i),s&&(e.persistentData=new Uint8Array(new Uint8Array(n.buffer)));else if(Te(n)){a=n.shape;var d=n.stride,m=n.offset,g=0,p=0,_=0,v=0;1===a.length?(g=a[0],p=1,_=d[0],v=0):2===a.length?(g=a[0],p=a[1],_=d[0],v=d[1]):nt.raise("invalid shape"),e.dtype=r||Ge(n.data)||je,e.dimension=p;var y=Nt.allocType(e.dtype,g*p);Ve(y,n.data,g,p,_,v,m),u(e,y,i),s?e.persistentData=y:Nt.freeType(y)}else n instanceof ArrayBuffer?(e.dtype=He,e.dimension=o,u(e,n,i),s&&(e.persistentData=new Uint8Array(new Uint8Array(n)))):nt.raise("invalid buffer data")}function d(t){n.bufferCount--,r(t);var i=t.buffer;nt(i,"buffer must not be deleted already"),e.deleteBuffer(i),t.buffer=null,delete s[t.id]}function m(r,o,h,l){n.bufferCount++;var c=new a(o);function u(n){var r=Ne,o=null,s=0,a=0,h=1;return Array.isArray(n)||t(n)||Te(n)||n instanceof ArrayBuffer?o=n:"number"==typeof n?s=0|n:n&&(nt.type(n,"object","buffer arguments must be an object, a number or an array"),"data"in n&&(nt(null===o||Array.isArray(o)||t(o)||Te(o),"invalid data for buffer"),o=n.data),"usage"in n&&(nt.parameter(n.usage,ke,"invalid buffer usage"),r=ke[n.usage]),"type"in n&&(nt.parameter(n.type,De,"invalid buffer type"),a=De[n.type]),"dimension"in n&&(nt.type(n.dimension,"number","invalid dimension"),h=0|n.dimension),"length"in n&&(nt.nni(s,"buffer length must be a nonnegative integer"),s=0|n.length)),c.bind(),o?f(c,o,r,a,h,l):(s&&e.bufferData(c.type,s,r),c.dtype=a||He,c.usage=r,c.dimension=h,c.byteLength=s),i.profile&&(c.stats.size=c.byteLength*ze[c.dtype]),u}function m(t,n){nt(n+t.byteLength<=c.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+t.byteLength+" starting from offset "+n+" to a buffer of size "+c.byteLength),e.bufferSubData(c.type,n,t)}function g(e,n){var i,r=0|(n||0);if(c.bind(),t(e)||e instanceof ArrayBuffer)m(e,r);else if(Array.isArray(e)){if(e.length>0)if("number"==typeof e[0]){var o=Nt.allocType(c.dtype,e.length);Ue(o,e),m(o,r),Nt.freeType(o)}else if(Array.isArray(e[0])||t(e[0])){i=Fe(e);var s=Le(e,i,c.dtype);m(s,r),Nt.freeType(s)}else nt.raise("invalid buffer data")}else if(Te(e)){i=e.shape;var a=e.stride,h=0,l=0,f=0,d=0;1===i.length?(h=i[0],l=1,f=a[0],d=0):2===i.length?(h=i[0],l=i[1],f=a[0],d=a[1]):nt.raise("invalid shape");var g=Array.isArray(e.data)?c.dtype:Ge(e.data),p=Nt.allocType(g,h*l);Ve(p,e.data,h,l,f,d,e.offset),m(p,r),Nt.freeType(p)}else nt.raise("invalid data for buffer subdata");return u}return s[c.id]=c,h||u(r),u._reglType="buffer",u._buffer=c,u.subdata=g,i.profile&&(u.stats=c.stats),u.destroy=function(){d(c)},u}function g(){Me(s).forEach((function(t){t.buffer=e.createBuffer(),e.bindBuffer(t.type,t.buffer),e.bufferData(t.type,t.persistentData||t.byteLength,t.usage)}))}return i.profile&&(n.getTotalBufferSize=function(){var t=0;return Object.keys(s).forEach((function(e){t+=s[e].stats.size})),t}),{create:m,createStream:l,destroyStream:c,clear:function(){Me(s).forEach(d),h.forEach(d)},getBuffer:function(t){return t&&t._buffer instanceof a?t._buffer:null},restore:g,_initBuffer:f}}ze[5120]=1,ze[5122]=2,ze[5124]=4,ze[5121]=1,ze[5123]=2,ze[5125]=4,ze[5126]=4;var Xe={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},Ze=0,qe=1,Ye=4,Ke=5120,Je=5121,Qe=5122,$e=5123,tn=5124,en=5125,nn=34963,rn=35040,on=35044;function sn(e,n,i,r){var o={},s=0,a={uint8:Je,uint16:$e};function h(t){this.id=s++,o[this.id]=this,this.buffer=t,this.primType=Ye,this.vertCount=0,this.type=0}n.oes_element_index_uint&&(a.uint32=en),h.prototype.bind=function(){this.buffer.bind()};var l=[];function c(t){var e=l.pop();return e||(e=new h(i.create(null,nn,!0,!1)._buffer)),f(e,t,rn,-1,-1,0,0),e}function u(t){l.push(t)}function f(r,o,s,a,h,l,c){var u;if(r.buffer.bind(),o){var f=c;c||t(o)&&(!Te(o)||t(o.data))||(f=n.oes_element_index_uint?en:$e),i._initBuffer(r.buffer,o,s,f,3)}else e.bufferData(nn,l,s),r.buffer.dtype=u||Je,r.buffer.usage=s,r.buffer.dimension=3,r.buffer.byteLength=l;if(u=c,!c){switch(r.buffer.dtype){case Je:case Ke:u=Je;break;case $e:case Qe:u=$e;break;case en:case tn:u=en;break;default:nt.raise("unsupported type for element array")}r.buffer.dtype=u}r.type=u,nt(u!==en||!!n.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var d=h;d<0&&(d=r.buffer.byteLength,u===$e?d>>=1:u===en&&(d>>=2)),r.vertCount=d;var m=a;if(a<0){m=Ye;var g=r.buffer.dimension;1===g&&(m=Ze),2===g&&(m=qe),3===g&&(m=Ye)}r.primType=m}function d(t){r.elementsCount--,nt(null!==t.buffer,"must not double destroy elements"),delete o[t.id],t.buffer.destroy(),t.buffer=null}function m(e,n){var o=i.create(null,nn,!0),s=new h(o._buffer);function l(e){if(e)if("number"==typeof e)o(e),s.primType=Ye,s.vertCount=0|e,s.type=Je;else{var n=null,i=on,r=-1,h=-1,c=0,u=0;Array.isArray(e)||t(e)||Te(e)?n=e:(nt.type(e,"object","invalid arguments for elements"),"data"in e&&(n=e.data,nt(Array.isArray(n)||t(n)||Te(n),"invalid data for element buffer")),"usage"in e&&(nt.parameter(e.usage,ke,"invalid element buffer usage"),i=ke[e.usage]),"primitive"in e&&(nt.parameter(e.primitive,Xe,"invalid element buffer primitive"),r=Xe[e.primitive]),"count"in e&&(nt("number"==typeof e.count&&e.count>=0,"invalid vertex count for elements"),h=0|e.count),"type"in e&&(nt.parameter(e.type,a,"invalid buffer type"),u=a[e.type]),"length"in e?c=0|e.length:(c=h,u===$e||u===Qe?c*=2:u!==en&&u!==tn||(c*=4))),f(s,n,i,r,h,c,u)}else o(),s.primType=Ye,s.vertCount=0,s.type=Je;return l}return r.elementsCount++,l(e),l._reglType="elements",l._elements=s,l.subdata=function(t,e){return o.subdata(t,e),l},l.destroy=function(){d(s)},l}return{create:m,createStream:c,destroyStream:u,getElements:function(t){return"function"==typeof t&&t._elements instanceof h?t._elements:null},clear:function(){Me(o).forEach(d)}}}var an=new Float32Array(1),hn=new Uint32Array(an.buffer),ln=5123;function cn(t){for(var e=Nt.allocType(ln,t.length),n=0;n<t.length;++n)if(isNaN(t[n]))e[n]=65535;else if(t[n]===1/0)e[n]=31744;else if(t[n]===-1/0)e[n]=64512;else{an[0]=t[n];var i=hn[0],r=i>>>31<<15,o=(i<<1>>>24)-127,s=i>>13&1023;if(o<-24)e[n]=r;else if(o<-14){var a=-14-o;e[n]=r+(s+1024>>a)}else e[n]=o>15?r+31744:r+(o+15<<10)+s}return e}function un(e){return Array.isArray(e)||t(e)}var fn=function(t){return!(t&t-1||!t)},dn=34467,mn=3553,gn=34067,pn=34069,_n=6408,vn=6406,yn=6407,xn=6409,bn=6410,wn=32854,Tn=32855,Mn=36194,An=32819,En=32820,Cn=33635,Sn=34042,Pn=6402,Rn=34041,On=35904,In=35906,Dn=36193,kn=33776,Ln=33777,Fn=33778,Nn=33779,Bn=35986,Hn=35987,jn=34798,zn=35840,Gn=35841,Un=35842,Vn=35843,Wn=36196,Xn=5121,Zn=5123,qn=5125,Yn=5126,Kn=10242,Jn=10243,Qn=10497,$n=33071,ti=33648,ei=10240,ni=10241,ii=9728,ri=9729,oi=9984,si=9985,ai=9986,hi=9987,li=33170,ci=4352,ui=4353,fi=4354,di=34046,mi=3317,gi=37440,pi=37441,_i=37443,vi=37444,yi=33984,xi=[oi,ai,si,hi],bi=[0,xn,bn,yn,_n],wi={};function Ti(t){return"[object "+t+"]"}wi[xn]=wi[vn]=wi[Pn]=1,wi[Rn]=wi[bn]=2,wi[yn]=wi[On]=3,wi[_n]=wi[In]=4;var Mi=Ti("HTMLCanvasElement"),Ai=Ti("OffscreenCanvas"),Ei=Ti("CanvasRenderingContext2D"),Ci=Ti("ImageBitmap"),Si=Ti("HTMLImageElement"),Pi=Ti("HTMLVideoElement"),Ri=Object.keys(Ie).concat([Mi,Ai,Ei,Ci,Si,Pi]),Oi=[];Oi[Xn]=1,Oi[Yn]=4,Oi[Dn]=2,Oi[Zn]=2,Oi[qn]=4;var Ii=[];function Di(t){return Array.isArray(t)&&(0===t.length||"number"==typeof t[0])}function ki(t){return!!Array.isArray(t)&&!(0===t.length||!un(t[0]))}function Li(t){return Object.prototype.toString.call(t)}function Fi(t){return Li(t)===Mi}function Ni(t){return Li(t)===Ai}function Bi(t){return Li(t)===Ei}function Hi(t){return Li(t)===Ci}function ji(t){return Li(t)===Si}function zi(t){return Li(t)===Pi}function Gi(t){if(!t)return!1;var e=Li(t);return Ri.indexOf(e)>=0||Di(t)||ki(t)||Te(t)}function Ui(t){return 0|Ie[Object.prototype.toString.call(t)]}function Vi(t,e){var n=e.length;switch(t.type){case Xn:case Zn:case qn:case Yn:var i=Nt.allocType(t.type,n);i.set(e),t.data=i;break;case Dn:t.data=cn(e);break;default:nt.raise("unsupported texture type, must specify a typed array")}}function Wi(t,e){return Nt.allocType(t.type===Dn?Yn:t.type,e)}function Xi(t,e){t.type===Dn?(t.data=cn(e),Nt.freeType(e)):t.data=e}function Zi(t,e,n,i,r,o){for(var s=t.width,a=t.height,h=t.channels,l=Wi(t,s*a*h),c=0,u=0;u<a;++u)for(var f=0;f<s;++f)for(var d=0;d<h;++d)l[c++]=e[n*f+i*u+r*d+o];Xi(t,l)}function qi(t,e,n,i,r,o){var s;if(s=void 0!==Ii[t]?Ii[t]:wi[t]*Oi[e],o&&(s*=6),r){for(var a=0,h=n;h>=1;)a+=s*h*h,h/=2;return a}return s*n*i}function Yi(n,i,r,o,s,a,h){var l={"don't care":ci,"dont care":ci,nice:fi,fast:ui},c={repeat:Qn,clamp:$n,mirror:ti},u={nearest:ii,linear:ri},f=e({mipmap:hi,"nearest mipmap nearest":oi,"linear mipmap nearest":si,"nearest mipmap linear":ai,"linear mipmap linear":hi},u),d={none:0,browser:vi},m={uint8:Xn,rgba4:An,rgb565:Cn,"rgb5 a1":En},g={alpha:vn,luminance:xn,"luminance alpha":bn,rgb:yn,rgba:_n,rgba4:wn,"rgb5 a1":Tn,rgb565:Mn},p={};i.ext_srgb&&(g.srgb=On,g.srgba=In),i.oes_texture_float&&(m.float32=m.float=Yn),i.oes_texture_half_float&&(m.float16=m["half float"]=Dn),i.webgl_depth_texture&&(e(g,{depth:Pn,"depth stencil":Rn}),e(m,{uint16:Zn,uint32:qn,"depth stencil":Sn})),i.webgl_compressed_texture_s3tc&&e(p,{"rgb s3tc dxt1":kn,"rgba s3tc dxt1":Ln,"rgba s3tc dxt3":Fn,"rgba s3tc dxt5":Nn}),i.webgl_compressed_texture_atc&&e(p,{"rgb atc":Bn,"rgba atc explicit alpha":Hn,"rgba atc interpolated alpha":jn}),i.webgl_compressed_texture_pvrtc&&e(p,{"rgb pvrtc 4bppv1":zn,"rgb pvrtc 2bppv1":Gn,"rgba pvrtc 4bppv1":Un,"rgba pvrtc 2bppv1":Vn}),i.webgl_compressed_texture_etc1&&(p["rgb etc1"]=Wn);var _=Array.prototype.slice.call(n.getParameter(dn));Object.keys(p).forEach((function(t){var e=p[t];_.indexOf(e)>=0&&(g[t]=e)}));var v=Object.keys(g);r.textureFormats=v;var y=[];Object.keys(g).forEach((function(t){var e=g[t];y[e]=t}));var x=[];Object.keys(m).forEach((function(t){var e=m[t];x[e]=t}));var b=[];Object.keys(u).forEach((function(t){var e=u[t];b[e]=t}));var w=[];Object.keys(f).forEach((function(t){var e=f[t];w[e]=t}));var T=[];Object.keys(c).forEach((function(t){var e=c[t];T[e]=t}));var M=v.reduce((function(t,e){var n=g[e];return n===xn||n===vn||n===xn||n===bn||n===Pn||n===Rn||i.ext_srgb&&(n===On||n===In)?t[n]=n:n===Tn||e.indexOf("rgba")>=0?t[n]=_n:t[n]=yn,t}),{});function A(){this.internalformat=_n,this.format=_n,this.type=Xn,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=vi,this.width=0,this.height=0,this.channels=0}function E(t,e){t.internalformat=e.internalformat,t.format=e.format,t.type=e.type,t.compressed=e.compressed,t.premultiplyAlpha=e.premultiplyAlpha,t.flipY=e.flipY,t.unpackAlignment=e.unpackAlignment,t.colorSpace=e.colorSpace,t.width=e.width,t.height=e.height,t.channels=e.channels}function C(t,e){if("object"==typeof e&&e){if("premultiplyAlpha"in e&&(nt.type(e.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),t.premultiplyAlpha=e.premultiplyAlpha),"flipY"in e&&(nt.type(e.flipY,"boolean","invalid texture flip"),t.flipY=e.flipY),"alignment"in e&&(nt.oneOf(e.alignment,[1,2,4,8],"invalid texture unpack alignment"),t.unpackAlignment=e.alignment),"colorSpace"in e&&(nt.parameter(e.colorSpace,d,"invalid colorSpace"),t.colorSpace=d[e.colorSpace]),"type"in e){var n=e.type;nt(i.oes_texture_float||!("float"===n||"float32"===n),"you must enable the OES_texture_float extension in order to use floating point textures."),nt(i.oes_texture_half_float||!("half float"===n||"float16"===n),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),nt(i.webgl_depth_texture||!("uint16"===n||"uint32"===n||"depth stencil"===n),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),nt.parameter(n,m,"invalid texture type"),t.type=m[n]}var o=t.width,s=t.height,a=t.channels,h=!1;"shape"in e?(nt(Array.isArray(e.shape)&&e.shape.length>=2,"shape must be an array"),o=e.shape[0],s=e.shape[1],3===e.shape.length&&(a=e.shape[2],nt(a>0&&a<=4,"invalid number of channels"),h=!0),nt(o>=0&&o<=r.maxTextureSize,"invalid width"),nt(s>=0&&s<=r.maxTextureSize,"invalid height")):("radius"in e&&(o=s=e.radius,nt(o>=0&&o<=r.maxTextureSize,"invalid radius")),"width"in e&&(o=e.width,nt(o>=0&&o<=r.maxTextureSize,"invalid width")),"height"in e&&(s=e.height,nt(s>=0&&s<=r.maxTextureSize,"invalid height")),"channels"in e&&(a=e.channels,nt(a>0&&a<=4,"invalid number of channels"),h=!0)),t.width=0|o,t.height=0|s,t.channels=0|a;var l=!1;if("format"in e){var c=e.format;nt(i.webgl_depth_texture||!("depth"===c||"depth stencil"===c),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),nt.parameter(c,g,"invalid texture format");var u=t.internalformat=g[c];t.format=M[u],c in m&&("type"in e||(t.type=m[c])),c in p&&(t.compressed=!0),l=!0}!h&&l?t.channels=wi[t.format]:h&&!l?t.channels!==bi[t.format]&&(t.format=t.internalformat=bi[t.channels]):l&&h&&nt(t.channels===wi[t.format],"number of channels inconsistent with specified format")}}function S(t){n.pixelStorei(gi,t.flipY),n.pixelStorei(pi,t.premultiplyAlpha),n.pixelStorei(_i,t.colorSpace),n.pixelStorei(mi,t.unpackAlignment)}function P(){A.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function R(e,n){var i=null;if(Gi(n)?i=n:n&&(nt.type(n,"object","invalid pixel data type"),C(e,n),"x"in n&&(e.xOffset=0|n.x),"y"in n&&(e.yOffset=0|n.y),Gi(n.data)&&(i=n.data)),nt(!e.compressed||i instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),n.copy){nt(!i,"can not specify copy and data field for the same texture");var o=s.viewportWidth,a=s.viewportHeight;e.width=e.width||o-e.xOffset,e.height=e.height||a-e.yOffset,e.needsCopy=!0,nt(e.xOffset>=0&&e.xOffset<o&&e.yOffset>=0&&e.yOffset<a&&e.width>0&&e.width<=o&&e.height>0&&e.height<=a,"copy texture read out of bounds")}else if(i){if(t(i))e.channels=e.channels||4,e.data=i,"type"in n||e.type!==Xn||(e.type=Ui(i));else if(Di(i))e.channels=e.channels||4,Vi(e,i),e.alignment=1,e.needsFree=!0;else if(Te(i)){var h=i.data;Array.isArray(h)||e.type!==Xn||(e.type=Ui(h));var l,c,u,f,d,m,g=i.shape,p=i.stride;3===g.length?(u=g[2],m=p[2]):(nt(2===g.length,"invalid ndarray pixel data, must be 2 or 3D"),u=1,m=1),l=g[0],c=g[1],f=p[0],d=p[1],e.alignment=1,e.width=l,e.height=c,e.channels=u,e.format=e.internalformat=bi[u],e.needsFree=!0,Zi(e,h,f,d,m,i.offset)}else if(Fi(i)||Ni(i)||Bi(i))Fi(i)||Ni(i)?e.element=i:e.element=i.canvas,e.width=e.element.width,e.height=e.element.height,e.channels=4;else if(Hi(i))e.element=i,e.width=i.width,e.height=i.height,e.channels=4;else if(ji(i))e.element=i,e.width=i.naturalWidth,e.height=i.naturalHeight,e.channels=4;else if(zi(i))e.element=i,e.width=i.videoWidth,e.height=i.videoHeight,e.channels=4;else if(ki(i)){var _=e.width||i[0].length,v=e.height||i.length,y=e.channels;y=un(i[0][0])?y||i[0][0].length:y||1;for(var x=Ae.shape(i),b=1,w=0;w<x.length;++w)b*=x[w];var T=Wi(e,b);Ae.flatten(i,x,"",T),Xi(e,T),e.alignment=1,e.width=_,e.height=v,e.channels=y,e.format=e.internalformat=bi[y],e.needsFree=!0}}else e.width=e.width||1,e.height=e.height||1,e.channels=e.channels||4;e.type===Yn?nt(r.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):e.type===Dn&&nt(r.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function O(t,e,i){var r=t.element,s=t.data,a=t.internalformat,h=t.format,l=t.type,c=t.width,u=t.height;S(t),r?n.texImage2D(e,i,h,h,l,r):t.compressed?n.compressedTexImage2D(e,i,a,c,u,0,s):t.needsCopy?(o(),n.copyTexImage2D(e,i,h,t.xOffset,t.yOffset,c,u,0)):n.texImage2D(e,i,h,c,u,0,h,l,s||null)}function I(t,e,i,r,s){var a=t.element,h=t.data,l=t.internalformat,c=t.format,u=t.type,f=t.width,d=t.height;S(t),a?n.texSubImage2D(e,s,i,r,c,u,a):t.compressed?n.compressedTexSubImage2D(e,s,i,r,l,f,d,h):t.needsCopy?(o(),n.copyTexSubImage2D(e,s,i,r,t.xOffset,t.yOffset,f,d)):n.texSubImage2D(e,s,i,r,f,d,c,u,h)}var D=[];function k(){return D.pop()||new P}function L(t){t.needsFree&&Nt.freeType(t.data),P.call(t),D.push(t)}function F(){A.call(this),this.genMipmaps=!1,this.mipmapHint=ci,this.mipmask=0,this.images=Array(16)}function N(t,e,n){var i=t.images[0]=k();t.mipmask=1,i.width=t.width=e,i.height=t.height=n,i.channels=t.channels=4}function B(t,e){var n=null;if(Gi(e))E(n=t.images[0]=k(),t),R(n,e),t.mipmask=1;else if(C(t,e),Array.isArray(e.mipmap))for(var i=e.mipmap,r=0;r<i.length;++r)E(n=t.images[r]=k(),t),n.width>>=r,n.height>>=r,R(n,i[r]),t.mipmask|=1<<r;else E(n=t.images[0]=k(),t),R(n,e),t.mipmask=1;E(t,t.images[0]),!t.compressed||t.internalformat!==kn&&t.internalformat!==Ln&&t.internalformat!==Fn&&t.internalformat!==Nn||nt(t.width%4==0&&t.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function H(t,e){for(var n=t.images,i=0;i<n.length;++i){if(!n[i])return;O(n[i],e,i)}}var j=[];function z(){var t=j.pop()||new F;A.call(t),t.mipmask=0;for(var e=0;e<16;++e)t.images[e]=null;return t}function G(t){for(var e=t.images,n=0;n<e.length;++n)e[n]&&L(e[n]),e[n]=null;j.push(t)}function U(){this.minFilter=ii,this.magFilter=ii,this.wrapS=$n,this.wrapT=$n,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=ci}function V(t,e){if("min"in e){var n=e.min;nt.parameter(n,f),t.minFilter=f[n],xi.indexOf(t.minFilter)>=0&&!("faces"in e)&&(t.genMipmaps=!0)}if("mag"in e){var i=e.mag;nt.parameter(i,u),t.magFilter=u[i]}var o=t.wrapS,s=t.wrapT;if("wrap"in e){var a=e.wrap;"string"==typeof a?(nt.parameter(a,c),o=s=c[a]):Array.isArray(a)&&(nt.parameter(a[0],c),nt.parameter(a[1],c),o=c[a[0]],s=c[a[1]])}else{if("wrapS"in e){var h=e.wrapS;nt.parameter(h,c),o=c[h]}if("wrapT"in e){var d=e.wrapT;nt.parameter(d,c),s=c[d]}}if(t.wrapS=o,t.wrapT=s,"anisotropic"in e){var m=e.anisotropic;nt("number"==typeof m&&m>=1&&m<=r.maxAnisotropic,"aniso samples must be between 1 and "),t.anisotropic=e.anisotropic}if("mipmap"in e){var g=!1;switch(typeof e.mipmap){case"string":nt.parameter(e.mipmap,l,"invalid mipmap hint"),t.mipmapHint=l[e.mipmap],t.genMipmaps=!0,g=!0;break;case"boolean":g=t.genMipmaps=e.mipmap;break;case"object":nt(Array.isArray(e.mipmap),"invalid mipmap type"),t.genMipmaps=!1,g=!0;break;default:nt.raise("invalid mipmap type")}g&&!("min"in e)&&(t.minFilter=oi)}}function W(t,e){n.texParameteri(e,ni,t.minFilter),n.texParameteri(e,ei,t.magFilter),n.texParameteri(e,Kn,t.wrapS),n.texParameteri(e,Jn,t.wrapT),i.ext_texture_filter_anisotropic&&n.texParameteri(e,di,t.anisotropic),t.genMipmaps&&(n.hint(li,t.mipmapHint),n.generateMipmap(e))}var X=0,Z={},q=r.maxTextureUnits,Y=Array(q).map((function(){return null}));function K(t){A.call(this),this.mipmask=0,this.internalformat=_n,this.id=X++,this.refCount=1,this.target=t,this.texture=n.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new U,h.profile&&(this.stats={size:0})}function J(t){n.activeTexture(yi),n.bindTexture(t.target,t.texture)}function Q(){var t=Y[0];t?n.bindTexture(t.target,t.texture):n.bindTexture(mn,null)}function $(t){var e=t.texture;nt(e,"must not double destroy texture");var i=t.unit,r=t.target;i>=0&&(n.activeTexture(yi+i),n.bindTexture(r,null),Y[i]=null),n.deleteTexture(e),t.texture=null,t.params=null,t.pixels=null,t.refCount=0,delete Z[t.id],a.textureCount--}function tt(t,e){var i=new K(mn);function o(t,e){var n=i.texInfo;U.call(n);var s=z();return"number"==typeof t?N(s,0|t,"number"==typeof e?0|e:0|t):t?(nt.type(t,"object","invalid arguments to regl.texture"),V(n,t),B(s,t)):N(s,1,1),n.genMipmaps&&(s.mipmask=(s.width<<1)-1),i.mipmask=s.mipmask,E(i,s),nt.texture2D(n,s,r),i.internalformat=s.internalformat,o.width=s.width,o.height=s.height,J(i),H(s,mn),W(n,mn),Q(),G(s),h.profile&&(i.stats.size=qi(i.internalformat,i.type,s.width,s.height,n.genMipmaps,!1)),o.format=y[i.internalformat],o.type=x[i.type],o.mag=b[n.magFilter],o.min=w[n.minFilter],o.wrapS=T[n.wrapS],o.wrapT=T[n.wrapT],o}function s(t,e,n,r){nt(!!t,"must specify image data");var s=0|e,a=0|n,h=0|r,l=k();return E(l,i),l.width=0,l.height=0,R(l,t),l.width=l.width||(i.width>>h)-s,l.height=l.height||(i.height>>h)-a,nt(i.type===l.type&&i.format===l.format&&i.internalformat===l.internalformat,"incompatible format for texture.subimage"),nt(s>=0&&a>=0&&s+l.width<=i.width&&a+l.height<=i.height,"texture.subimage write out of bounds"),nt(i.mipmask&1<<h,"missing mipmap data"),nt(l.data||l.element||l.needsCopy,"missing image data"),J(i),I(l,mn,s,a,h),Q(),L(l),o}function l(t,e){var r=0|t,s=0|e||r;if(r===i.width&&s===i.height)return o;o.width=i.width=r,o.height=i.height=s,J(i);for(var a=0;i.mipmask>>a;++a){var l=r>>a,c=s>>a;if(!l||!c)break;n.texImage2D(mn,a,i.format,l,c,0,i.format,i.type,null)}return Q(),h.profile&&(i.stats.size=qi(i.internalformat,i.type,r,s,!1,!1)),o}return Z[i.id]=i,a.textureCount++,o(t,e),o.subimage=s,o.resize=l,o._reglType="texture2d",o._texture=i,h.profile&&(o.stats=i.stats),o.destroy=function(){i.decRef()},o}function et(t,e,i,o,s,l){var c=new K(gn);Z[c.id]=c,a.cubeCount++;var u=new Array(6);function f(t,e,n,i,o,s){var a,l=c.texInfo;for(U.call(l),a=0;a<6;++a)u[a]=z();if("number"!=typeof t&&t)if("object"==typeof t)if(e)B(u[0],t),B(u[1],e),B(u[2],n),B(u[3],i),B(u[4],o),B(u[5],s);else if(V(l,t),C(c,t),"faces"in t){var d=t.faces;for(nt(Array.isArray(d)&&6===d.length,"cube faces must be a length 6 array"),a=0;a<6;++a)nt("object"==typeof d[a]&&!!d[a],"invalid input for cube map face"),E(u[a],c),B(u[a],d[a])}else for(a=0;a<6;++a)B(u[a],t);else nt.raise("invalid arguments to cube map");else{var m=0|t||1;for(a=0;a<6;++a)N(u[a],m,m)}for(E(c,u[0]),nt.optional((function(){r.npotTextureCube||nt(fn(c.width)&&fn(c.height),"your browser does not support non power or two texture dimensions")})),l.genMipmaps?c.mipmask=(u[0].width<<1)-1:c.mipmask=u[0].mipmask,nt.textureCube(c,l,u,r),c.internalformat=u[0].internalformat,f.width=u[0].width,f.height=u[0].height,J(c),a=0;a<6;++a)H(u[a],pn+a);for(W(l,gn),Q(),h.profile&&(c.stats.size=qi(c.internalformat,c.type,f.width,f.height,l.genMipmaps,!0)),f.format=y[c.internalformat],f.type=x[c.type],f.mag=b[l.magFilter],f.min=w[l.minFilter],f.wrapS=T[l.wrapS],f.wrapT=T[l.wrapT],a=0;a<6;++a)G(u[a]);return f}function d(t,e,n,i,r){nt(!!e,"must specify image data"),nt("number"==typeof t&&t===(0|t)&&t>=0&&t<6,"invalid face");var o=0|n,s=0|i,a=0|r,h=k();return E(h,c),h.width=0,h.height=0,R(h,e),h.width=h.width||(c.width>>a)-o,h.height=h.height||(c.height>>a)-s,nt(c.type===h.type&&c.format===h.format&&c.internalformat===h.internalformat,"incompatible format for texture.subimage"),nt(o>=0&&s>=0&&o+h.width<=c.width&&s+h.height<=c.height,"texture.subimage write out of bounds"),nt(c.mipmask&1<<a,"missing mipmap data"),nt(h.data||h.element||h.needsCopy,"missing image data"),J(c),I(h,pn+t,o,s,a),Q(),L(h),f}function m(t){var e=0|t;if(e!==c.width){f.width=c.width=e,f.height=c.height=e,J(c);for(var i=0;i<6;++i)for(var r=0;c.mipmask>>r;++r)n.texImage2D(pn+i,r,c.format,e>>r,e>>r,0,c.format,c.type,null);return Q(),h.profile&&(c.stats.size=qi(c.internalformat,c.type,f.width,f.height,!1,!0)),f}}return f(t,e,i,o,s,l),f.subimage=d,f.resize=m,f._reglType="textureCube",f._texture=c,h.profile&&(f.stats=c.stats),f.destroy=function(){c.decRef()},f}function it(){for(var t=0;t<q;++t)n.activeTexture(yi+t),n.bindTexture(mn,null),Y[t]=null;Me(Z).forEach($),a.cubeCount=0,a.textureCount=0}function rt(){for(var t=0;t<q;++t){var e=Y[t];e&&(e.bindCount=0,e.unit=-1,Y[t]=null)}Me(Z).forEach((function(t){t.texture=n.createTexture(),n.bindTexture(t.target,t.texture);for(var e=0;e<32;++e)if(0!=(t.mipmask&1<<e))if(t.target===mn)n.texImage2D(mn,e,t.internalformat,t.width>>e,t.height>>e,0,t.internalformat,t.type,null);else for(var i=0;i<6;++i)n.texImage2D(pn+i,e,t.internalformat,t.width>>e,t.height>>e,0,t.internalformat,t.type,null);W(t.texInfo,t.target)}))}function ot(){for(var t=0;t<q;++t){var e=Y[t];e&&(e.bindCount=0,e.unit=-1,Y[t]=null),n.activeTexture(yi+t),n.bindTexture(mn,null),n.bindTexture(gn,null)}}return e(K.prototype,{bind:function(){var t=this;t.bindCount+=1;var e=t.unit;if(e<0){for(var i=0;i<q;++i){var r=Y[i];if(r){if(r.bindCount>0)continue;r.unit=-1}Y[i]=t,e=i;break}e>=q&&nt.raise("insufficient number of texture units"),h.profile&&a.maxTextureUnits<e+1&&(a.maxTextureUnits=e+1),t.unit=e,n.activeTexture(yi+e),n.bindTexture(t.target,t.texture)}return e},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&$(this)}}),h.profile&&(a.getTotalTextureSize=function(){var t=0;return Object.keys(Z).forEach((function(e){t+=Z[e].stats.size})),t}),{create2D:tt,createCube:et,clear:it,getTexture:function(t){return null},restore:rt,refresh:ot}}Ii[wn]=2,Ii[Tn]=2,Ii[Mn]=2,Ii[Rn]=4,Ii[kn]=.5,Ii[Ln]=.5,Ii[Fn]=1,Ii[Nn]=1,Ii[Bn]=.5,Ii[Hn]=1,Ii[jn]=1,Ii[zn]=.5,Ii[Gn]=.25,Ii[Un]=.5,Ii[Vn]=.25,Ii[Wn]=.5;var Ki=36161,Ji=32854,Qi=32855,$i=32856,tr=36194,er=33189,nr=36168,ir=34041,rr=35056,or=35907,sr=34836,ar=34842,hr=34843,lr=[];function cr(t,e,n){return lr[t]*e*n}lr[Ji]=2,lr[Qi]=2,lr[tr]=2,lr[er]=2,lr[nr]=1,lr[ir]=4,lr[rr]=4,lr[or]=4,lr[sr]=16,lr[ar]=8,lr[hr]=6;var ur=function(t,e,n,i,r){var o={rgba4:Ji,rgba8:$i,rgb565:tr,"rgb5 a1":Qi,depth:er,stencil:nr,"depth stencil":ir,"depth24 stencil8":rr};e.ext_srgb&&(o.srgba=or),e.ext_color_buffer_half_float&&(o.rgba16f=ar,o.rgb16f=hr),e.webgl_color_buffer_float&&(o.rgba32f=sr);var s=[];Object.keys(o).forEach((function(t){var e=o[t];s[e]=t}));var a=0,h={};function l(t){this.id=a++,this.refCount=1,this.renderbuffer=t,this.format=Ji,this.width=0,this.height=0,r.profile&&(this.stats={size:0})}function c(e){var n=e.renderbuffer;nt(n,"must not double destroy renderbuffer"),t.bindRenderbuffer(Ki,null),t.deleteRenderbuffer(n),e.renderbuffer=null,e.refCount=0,delete h[e.id],i.renderbufferCount--}function u(e,a){var c=new l(t.createRenderbuffer());function u(e,i){var a=0,h=0,l=Ji,f=0;if("object"==typeof e&&e){var d=e;if("shape"in d){var m=d.shape;nt(Array.isArray(m)&&m.length>=2,"invalid renderbuffer shape"),a=0|m[0],h=0|m[1]}else"radius"in d&&(a=h=0|d.radius),"width"in d&&(a=0|d.width),"height"in d&&(h=0|d.height);"format"in d&&(nt.parameter(d.format,o,"invalid renderbuffer format"),l=o[d.format]),"samples"in d&&(f=d.samples)}else"number"==typeof e?(a=0|e,h="number"==typeof i?0|i:a):e?nt.raise("invalid arguments to renderbuffer constructor"):a=h=1;if(nt(a>0&&h>0&&a<=n.maxRenderbufferSize&&h<=n.maxRenderbufferSize,"invalid renderbuffer size"),a!==c.width||h!==c.height||l!==c.format)return u.width=c.width=a,u.height=c.height=h,u.samples=f,c.format=l,c.samples=f,t.bindRenderbuffer(Ki,c.renderbuffer),f&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(Ki,f,l,a,h):t.renderbufferStorage(Ki,l,a,h),r.profile&&(c.stats.size=cr(c.format,c.width,c.height)),u.format=s[c.format],u}function f(e,i){var o=0|e,s=0|i||o;if(o===c.width&&s===c.height)return u;nt(o>0&&s>0&&o<=n.maxRenderbufferSize&&s<=n.maxRenderbufferSize,"invalid renderbuffer size"),u.width=c.width=o,u.height=c.height=s;var a=u.samples;return t.bindRenderbuffer(Ki,c.renderbuffer),a&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(Ki,a,c.format,o,s):t.renderbufferStorage(Ki,c.format,o,s),r.profile&&(c.stats.size=cr(c.format,c.width,c.height)),u}return h[c.id]=c,i.renderbufferCount++,u(e,a),u.resize=f,u._reglType="renderbuffer",u._renderbuffer=c,r.profile&&(u.stats=c.stats),u.destroy=function(){c.decRef()},u}function f(){Me(h).forEach((function(e){e.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(Ki,e.renderbuffer),e.samples&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(Ki,e.samples,e.format,e.width,e.height):t.renderbufferStorage(Ki,e.format,e.width,e.height)})),t.bindRenderbuffer(Ki,null)}return l.prototype.decRef=function(){--this.refCount<=0&&c(this)},r.profile&&(i.getTotalRenderbufferSize=function(){var t=0;return Object.keys(h).forEach((function(e){t+=h[e].stats.size})),t}),{create:u,clear:function(){Me(h).forEach(c)},restore:f}},fr=36160,dr=36161,mr=3553,gr=34069,pr=36064,_r=36096,vr=36128,yr=33306,xr=36053,br=36054,wr=36055,Tr=36057,Mr=36061,Ar=36193,Er=5121,Cr=5126,Sr=6407,Pr=6408,Rr=6402,Or=36008,Ir=36009,Dr=9728,kr=9729,Lr=16384,Fr=[Sr,Pr],Nr=[];Nr[Pr]=4,Nr[Sr]=3;var Br=[];Br[Er]=1,Br[Cr]=4,Br[Ar]=2;var Hr=33189,jr=36168,zr=34041,Gr=35056,Ur=[32854,32856,32855,36194,35907,34842,34843,34836],Vr={};function Wr(t,n,i,r,o,s){var a={cur:null,next:null,dirty:!1,setFBO:null},h=["rgba"],l=["rgba4","rgb565","rgb5 a1"];n.ext_srgb&&l.push("srgba"),n.ext_color_buffer_half_float&&l.push("rgba16f","rgb16f"),n.webgl_color_buffer_float&&l.push("rgba32f");var c=["uint8"];function u(t,e,n){this.target=t,this.texture=e,this.renderbuffer=n;var i=0,r=0;e?(i=e.width,r=e.height):n&&(i=n.width,r=n.height),this.width=i,this.height=r}function f(t){t&&(t.texture&&t.texture._texture.decRef(),t.renderbuffer&&t.renderbuffer._renderbuffer.decRef())}function d(t,e,n){if(t)if(t.texture){var i=t.texture._texture,r=Math.max(1,i.width),o=Math.max(1,i.height);nt(r===e&&o===n,"inconsistent width/height for supplied texture"),i.refCount+=1}else{var s=t.renderbuffer._renderbuffer;nt(s.width===e&&s.height===n,"inconsistent width/height for renderbuffer"),s.refCount+=1}}function m(e,n){n&&(n.texture?t.framebufferTexture2D(fr,e,n.target,n.texture._texture.texture,0):t.framebufferRenderbuffer(fr,e,dr,n.renderbuffer._renderbuffer.renderbuffer))}function g(t){var e=mr,n=null,i=null,r=t;"object"==typeof t&&(r=t.data,"target"in t&&(e=0|t.target)),nt.type(r,"function","invalid attachment data");var o=r._reglType;return"texture2d"===o?(n=r,nt(e===mr)):"textureCube"===o?(n=r,nt(e>=gr&&e<gr+6,"invalid cube map target")):"renderbuffer"===o?(i=r,e=dr):nt.raise("invalid regl object for attachment"),new u(e,n,i)}function p(t,e,n,i,s){if(n){var a=r.create2D({width:t,height:e,format:i,type:s});return a._texture.refCount=0,new u(mr,a,null)}var h=o.create({width:t,height:e,format:i});return h._renderbuffer.refCount=0,new u(dr,null,h)}function _(t){return t&&(t.texture||t.renderbuffer)}function v(t,e,n){t&&(t.texture?t.texture.resize(e,n):t.renderbuffer&&t.renderbuffer.resize(e,n),t.width=e,t.height=n)}n.oes_texture_half_float&&c.push("half float","float16"),n.oes_texture_float&&c.push("float","float32");var y=0,x={};function b(){this.id=y++,x[this.id]=this,this.framebuffer=t.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function w(t){t.colorAttachments.forEach(f),f(t.depthAttachment),f(t.stencilAttachment),f(t.depthStencilAttachment)}function T(e){var n=e.framebuffer;nt(n,"must not double destroy framebuffer"),t.deleteFramebuffer(n),e.framebuffer=null,s.framebufferCount--,delete x[e.id]}function M(e){var n;t.bindFramebuffer(fr,e.framebuffer);var r=e.colorAttachments;for(n=0;n<r.length;++n)m(pr+n,r[n]);for(n=r.length;n<i.maxColorAttachments;++n)t.framebufferTexture2D(fr,pr+n,mr,null,0);t.framebufferTexture2D(fr,yr,mr,null,0),t.framebufferTexture2D(fr,_r,mr,null,0),t.framebufferTexture2D(fr,vr,mr,null,0),m(_r,e.depthAttachment),m(vr,e.stencilAttachment),m(yr,e.depthStencilAttachment);var o=t.checkFramebufferStatus(fr);t.isContextLost()||o===xr||nt.raise("framebuffer configuration not supported, status = "+Vr[o]),t.bindFramebuffer(fr,a.next?a.next.framebuffer:null),a.cur=a.next,t.getError()}function A(r,o){var u=new b;function f(t,e){var r;nt(a.next!==u,"can not update framebuffer which is currently in use");var o=0,s=0,m=!0,v=!0,y=null,x=!0,b="rgba",T="uint8",A=1,E=null,C=null,S=null,P=!1;if("number"==typeof t)o=0|t,s=0|e||o;else if(t){nt.type(t,"object","invalid arguments for framebuffer");var R=t;if("shape"in R){var O=R.shape;nt(Array.isArray(O)&&O.length>=2,"invalid shape for framebuffer"),o=O[0],s=O[1]}else"radius"in R&&(o=s=R.radius),"width"in R&&(o=R.width),"height"in R&&(s=R.height);("color"in R||"colors"in R)&&(y=R.color||R.colors,Array.isArray(y)&&nt(1===y.length||n.webgl_draw_buffers,"multiple render targets not supported")),y||("colorCount"in R&&(A=0|R.colorCount,nt(A>0,"invalid color buffer count")),"colorTexture"in R&&(x=!!R.colorTexture,b="rgba4"),"colorType"in R&&(T=R.colorType,x?(nt(n.oes_texture_float||!("float"===T||"float32"===T),"you must enable OES_texture_float in order to use floating point framebuffer objects"),nt(n.oes_texture_half_float||!("half float"===T||"float16"===T),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===T||"float16"===T?(nt(n.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),b="rgba16f"):"float"!==T&&"float32"!==T||(nt(n.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),b="rgba32f"),nt.oneOf(T,c,"invalid color type")),"colorFormat"in R&&(b=R.colorFormat,h.indexOf(b)>=0?x=!0:l.indexOf(b)>=0?x=!1:nt.optional((function(){x?nt.oneOf(R.colorFormat,h,"invalid color format for texture"):nt.oneOf(R.colorFormat,l,"invalid color format for renderbuffer")})))),("depthTexture"in R||"depthStencilTexture"in R)&&(P=!(!R.depthTexture&&!R.depthStencilTexture),nt(!P||n.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in R&&("boolean"==typeof R.depth?m=R.depth:(E=R.depth,v=!1)),"stencil"in R&&("boolean"==typeof R.stencil?v=R.stencil:(C=R.stencil,m=!1)),"depthStencil"in R&&("boolean"==typeof R.depthStencil?m=v=R.depthStencil:(S=R.depthStencil,m=!1,v=!1))}else o=s=1;var I=null,D=null,k=null,L=null;if(Array.isArray(y))I=y.map(g);else if(y)I=[g(y)];else for(I=new Array(A),r=0;r<A;++r)I[r]=p(o,s,x,b,T);nt(n.webgl_draw_buffers||I.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),nt(I.length<=i.maxColorAttachments,"too many color attachments, not supported"),o=o||I[0].width,s=s||I[0].height,E?D=g(E):m&&!v&&(D=p(o,s,P,"depth","uint32")),C?k=g(C):v&&!m&&(k=p(o,s,!1,"stencil","uint8")),S?L=g(S):!E&&!C&&v&&m&&(L=p(o,s,P,"depth stencil","depth stencil")),nt(!!E+!!C+!!S<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var F=null;for(r=0;r<I.length;++r)if(d(I[r],o,s),nt(!I[r]||I[r].texture&&Fr.indexOf(I[r].texture._texture.format)>=0||I[r].renderbuffer&&Ur.indexOf(I[r].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+r+" is invalid"),I[r]&&I[r].texture){var N=Nr[I[r].texture._texture.format]*Br[I[r].texture._texture.type];null===F?F=N:nt(F===N,"all color attachments much have the same number of bits per pixel.")}return d(D,o,s),nt(!D||D.texture&&D.texture._texture.format===Rr||D.renderbuffer&&D.renderbuffer._renderbuffer.format===Hr,"invalid depth attachment for framebuffer object"),d(k,o,s),nt(!k||k.renderbuffer&&k.renderbuffer._renderbuffer.format===jr,"invalid stencil attachment for framebuffer object"),d(L,o,s),nt(!L||L.texture&&L.texture._texture.format===zr||L.renderbuffer&&(L.renderbuffer._renderbuffer.format===zr||L.renderbuffer._renderbuffer.format===Gr),"invalid depth-stencil attachment for framebuffer object"),w(u),u.width=o,u.height=s,u.colorAttachments=I,u.depthAttachment=D,u.stencilAttachment=k,u.depthStencilAttachment=L,f.color=I.map(_),f.depth=_(D),f.stencil=_(k),f.depthStencil=_(L),f.width=u.width,f.height=u.height,M(u),f}function m(t,e){nt(a.next!==u,"can not resize a framebuffer which is currently in use");var n=Math.max(0|t,1),i=Math.max(0|e||n,1);if(n===u.width&&i===u.height)return f;for(var r=u.colorAttachments,o=0;o<r.length;++o)v(r[o],n,i);return v(u.depthAttachment,n,i),v(u.stencilAttachment,n,i),v(u.depthStencilAttachment,n,i),u.width=f.width=n,u.height=f.height=i,M(u),f}function y(e,n,i){t.bindFramebuffer(Or,e._framebuffer.framebuffer),t.bindFramebuffer(Ir,u.framebuffer),n||(n=Lr),i="linear"===i?kr:Dr,t.blitFramebuffer(0,0,e.width,e.height,0,0,u.width,u.height,n,i),t.bindFramebuffer(Or,null),t.bindFramebuffer(Ir,null)}return s.framebufferCount++,f(r,o),e(f,{resize:m,blit:y,_reglType:"framebuffer",_framebuffer:u,destroy:function(){T(u),w(u)},use:function(t){a.setFBO({framebuffer:f},t)}})}function E(t){var o=Array(6);function s(t){var i;nt(o.indexOf(a.next)<0,"can not update framebuffer which is currently in use");var l,u={color:null},f=0,d=null,m="rgba",g="uint8",p=1;if("number"==typeof t)f=0|t;else if(t){nt.type(t,"object","invalid arguments for framebuffer");var _=t;if("shape"in _){var v=_.shape;nt(Array.isArray(v)&&v.length>=2,"invalid shape for framebuffer"),nt(v[0]===v[1],"cube framebuffer must be square"),f=v[0]}else"radius"in _&&(f=0|_.radius),"width"in _?(f=0|_.width,"height"in _&&nt(_.height===f,"must be square")):"height"in _&&(f=0|_.height);("color"in _||"colors"in _)&&(d=_.color||_.colors,Array.isArray(d)&&nt(1===d.length||n.webgl_draw_buffers,"multiple render targets not supported")),d||("colorCount"in _&&(p=0|_.colorCount,nt(p>0,"invalid color buffer count")),"colorType"in _&&(nt.oneOf(_.colorType,c,"invalid color type"),g=_.colorType),"colorFormat"in _&&(m=_.colorFormat,nt.oneOf(_.colorFormat,h,"invalid color format for texture"))),"depth"in _&&(u.depth=_.depth),"stencil"in _&&(u.stencil=_.stencil),"depthStencil"in _&&(u.depthStencil=_.depthStencil)}else f=1;if(d)if(Array.isArray(d))for(l=[],i=0;i<d.length;++i)l[i]=d[i];else l=[d];else{l=Array(p);var y={radius:f,format:m,type:g};for(i=0;i<p;++i)l[i]=r.createCube(y)}for(u.color=Array(l.length),i=0;i<l.length;++i){var x=l[i];nt("function"==typeof x&&"textureCube"===x._reglType,"invalid cube map"),f=f||x.width,nt(x.width===f&&x.height===f,"invalid cube map shape"),u.color[i]={target:gr,data:l[i]}}for(i=0;i<6;++i){for(var b=0;b<l.length;++b)u.color[b].target=gr+i;i>0&&(u.depth=o[0].depth,u.stencil=o[0].stencil,u.depthStencil=o[0].depthStencil),o[i]?o[i](u):o[i]=A(u)}return e(s,{width:f,height:f,color:l})}function l(t){var e,n=0|t;if(nt(n>0&&n<=i.maxCubeMapSize,"invalid radius for cube fbo"),n===s.width)return s;var r=s.color;for(e=0;e<r.length;++e)r[e].resize(n);for(e=0;e<6;++e)o[e].resize(n);return s.width=s.height=n,s}return s(t),e(s,{faces:o,resize:l,_reglType:"framebufferCube",destroy:function(){o.forEach((function(t){t.destroy()}))}})}function C(){a.cur=null,a.next=null,a.dirty=!0,Me(x).forEach((function(e){e.framebuffer=t.createFramebuffer(),M(e)}))}return e(a,{getFramebuffer:function(t){if("function"==typeof t&&"framebuffer"===t._reglType){var e=t._framebuffer;if(e instanceof b)return e}return null},create:A,createCube:E,clear:function(){Me(x).forEach(T)},restore:C})}Vr[xr]="complete",Vr[br]="incomplete attachment",Vr[Tr]="incomplete dimensions",Vr[wr]="incomplete, missing attachment",Vr[Mr]="unsupported";var Xr=5126,Zr=34962,qr=34963,Yr=["attributes","elements","offset","count","primitive","instances"];function Kr(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=Xr,this.offset=0,this.stride=0,this.divisor=0}function Jr(e,n,i,r,o,s,a){for(var h=i.maxAttributes,l=new Array(h),c=0;c<h;++c)l[c]=new Kr;var u=0,f={},d={Record:Kr,scope:{},state:l,currentVAO:null,targetVAO:null,restore:g()?w:function(){},createVAO:T,getVAO:_,destroyBuffer:m,setVAO:g()?v:y,clear:g()?x:function(){}};function m(t){for(var n=0;n<l.length;++n){var i=l[n];i.buffer===t&&(e.disableVertexAttribArray(n),i.buffer=null)}}function g(){return n.oes_vertex_array_object}function p(){return n.angle_instanced_arrays}function _(t){return"function"==typeof t&&t._vao?t._vao:null}function v(t){if(t!==d.currentVAO){var e=g();t?e.bindVertexArrayOES(t.vao):e.bindVertexArrayOES(null),d.currentVAO=t}}function y(t){if(t!==d.currentVAO){if(t)t.bindAttrs();else{for(var n=p(),i=0;i<l.length;++i){var r=l[i];r.buffer?(e.enableVertexAttribArray(i),r.buffer.bind(),e.vertexAttribPointer(i,r.size,r.type,r.normalized,r.stride,r.offfset),n&&r.divisor&&n.vertexAttribDivisorANGLE(i,r.divisor)):(e.disableVertexAttribArray(i),e.vertexAttrib4f(i,r.x,r.y,r.z,r.w))}a.elements?e.bindBuffer(qr,a.elements.buffer.buffer):e.bindBuffer(qr,null)}d.currentVAO=t}}function x(){Me(f).forEach((function(t){t.destroy()}))}function b(){this.id=++u,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var t=g();this.vao=t?t.createVertexArrayOES():null,f[this.id]=this,this.buffers=[]}function w(){g()&&Me(f).forEach((function(t){t.refresh()}))}function T(e){var i=new b;function a(e){var r;if(Array.isArray(e))r=e,i.elements&&i.ownsElements&&i.elements.destroy(),i.elements=null,i.ownsElements=!1,i.offset=0,i.count=0,i.instances=-1,i.primitive=4;else{if(nt("object"==typeof e,"invalid arguments for create vao"),nt("attributes"in e,"must specify attributes for vao"),e.elements){var l=e.elements;i.ownsElements?"function"==typeof l&&"elements"===l._reglType?(i.elements.destroy(),i.ownsElements=!1):(i.elements(l),i.ownsElements=!1):s.getElements(e.elements)?(i.elements=e.elements,i.ownsElements=!1):(i.elements=s.create(e.elements),i.ownsElements=!0)}else i.elements=null,i.ownsElements=!1;r=e.attributes,i.offset=0,i.count=-1,i.instances=-1,i.primitive=4,i.elements&&(i.count=i.elements._elements.vertCount,i.primitive=i.elements._elements.primType),"offset"in e&&(i.offset=0|e.offset),"count"in e&&(i.count=0|e.count),"instances"in e&&(i.instances=0|e.instances),"primitive"in e&&(nt(e.primitive in Xe,"bad primitive type: "+e.primitive),i.primitive=Xe[e.primitive]),nt.optional((()=>{for(var t=Object.keys(e),n=0;n<t.length;++n)nt(Yr.indexOf(t[n])>=0,'invalid option for vao: "'+t[n]+'" valid options are '+Yr)})),nt(Array.isArray(r),"attributes must be an array")}nt(r.length<h,"too many attributes"),nt(r.length>0,"must specify at least one attribute");var c={},u=i.attributes;u.length=r.length;for(var f=0;f<r.length;++f){var d,m=r[f],g=u[f]=new Kr,p=m.data||m;Array.isArray(p)||t(p)||Te(p)?(i.buffers[f]&&(d=i.buffers[f],t(p)&&d._buffer.byteLength>=p.byteLength?d.subdata(p):(d.destroy(),i.buffers[f]=null)),i.buffers[f]||(d=i.buffers[f]=o.create(m,Zr,!1,!0)),g.buffer=o.getBuffer(d),g.size=0|g.buffer.dimension,g.normalized=!1,g.type=g.buffer.dtype,g.offset=0,g.stride=0,g.divisor=0,g.state=1,c[f]=1):o.getBuffer(m)?(g.buffer=o.getBuffer(m),g.size=0|g.buffer.dimension,g.normalized=!1,g.type=g.buffer.dtype,g.offset=0,g.stride=0,g.divisor=0,g.state=1):o.getBuffer(m.buffer)?(g.buffer=o.getBuffer(m.buffer),g.size=0|(+m.size||g.buffer.dimension),g.normalized=!!m.normalized||!1,"type"in m?(nt.parameter(m.type,De,"invalid buffer type"),g.type=De[m.type]):g.type=g.buffer.dtype,g.offset=0|(m.offset||0),g.stride=0|(m.stride||0),g.divisor=0|(m.divisor||0),g.state=1,nt(g.size>=1&&g.size<=4,"size must be between 1 and 4"),nt(g.offset>=0,"invalid offset"),nt(g.stride>=0&&g.stride<=255,"stride must be between 0 and 255"),nt(g.divisor>=0,"divisor must be positive"),nt(!g.divisor||!!n.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in m?(nt(f>0,"first attribute must not be a constant"),g.x=+m.x||0,g.y=+m.y||0,g.z=+m.z||0,g.w=+m.w||0,g.state=2):nt(!1,"invalid attribute spec for location "+f)}for(var _=0;_<i.buffers.length;++_)!c[_]&&i.buffers[_]&&(i.buffers[_].destroy(),i.buffers[_]=null);return i.refresh(),a}return r.vaoCount+=1,a.destroy=function(){for(var t=0;t<i.buffers.length;++t)i.buffers[t]&&i.buffers[t].destroy();i.buffers.length=0,i.ownsElements&&(i.elements.destroy(),i.elements=null,i.ownsElements=!1),i.destroy()},a._vao=i,a._reglType="vao",a(e)}return b.prototype.bindAttrs=function(){for(var t=p(),n=this.attributes,i=0;i<n.length;++i){var r=n[i];r.buffer?(e.enableVertexAttribArray(i),e.bindBuffer(Zr,r.buffer.buffer),e.vertexAttribPointer(i,r.size,r.type,r.normalized,r.stride,r.offset),t&&r.divisor&&t.vertexAttribDivisorANGLE(i,r.divisor)):(e.disableVertexAttribArray(i),e.vertexAttrib4f(i,r.x,r.y,r.z,r.w))}for(var o=n.length;o<h;++o)e.disableVertexAttribArray(o);var a=s.getElements(this.elements);a?e.bindBuffer(qr,a.buffer.buffer):e.bindBuffer(qr,null)},b.prototype.refresh=function(){var t=g();t&&(t.bindVertexArrayOES(this.vao),this.bindAttrs(),d.currentVAO=null,t.bindVertexArrayOES(null))},b.prototype.destroy=function(){if(this.vao){var t=g();this===d.currentVAO&&(d.currentVAO=null,t.bindVertexArrayOES(null)),t.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),f[this.id]&&(delete f[this.id],r.vaoCount-=1)},d}var Qr=35632,$r=35633,to=35718,eo=35721;function no(t,n,i,r){var o={},s={};function a(t,e,n,i){this.name=t,this.id=e,this.location=n,this.info=i}function h(t,e){for(var n=0;n<t.length;++n)if(t[n].id===e.id)return void(t[n].location=e.location);t.push(e)}function l(e,i,r){var a=e===Qr?o:s,h=a[i];if(!h){var l=n.str(i);h=t.createShader(e),t.shaderSource(h,l),t.compileShader(h),nt.shaderError(t,h,l,e,r),a[i]=h}return h}var c={},u=[],f=0;function d(t,e){this.id=f++,this.fragId=t,this.vertId=e,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function m(e,i,o){var s,c,u=l(Qr,e.fragId),f=l($r,e.vertId),d=e.program=t.createProgram();if(t.attachShader(d,u),t.attachShader(d,f),o)for(s=0;s<o.length;++s){var m=o[s];t.bindAttribLocation(d,m[0],m[1])}t.linkProgram(d),nt.linkError(t,d,n.str(e.fragId),n.str(e.vertId),i);var g=t.getProgramParameter(d,to);r.profile&&(e.stats.uniformsCount=g);var p=e.uniforms;for(s=0;s<g;++s)if(c=t.getActiveUniform(d,s)){if(c.size>1)for(var _=0;_<c.size;++_){var v=c.name.replace("[0]","["+_+"]");h(p,new a(v,n.id(v),t.getUniformLocation(d,v),c))}var y=c.name;c.size>1&&(y=y.replace("[0]","")),h(p,new a(y,n.id(y),t.getUniformLocation(d,y),c))}var x=t.getProgramParameter(d,eo);r.profile&&(e.stats.attributesCount=x);var b=e.attributes;for(s=0;s<x;++s)(c=t.getActiveAttrib(d,s))&&h(b,new a(c.name,n.id(c.name),t.getAttribLocation(d,c.name),c))}function g(){o={},s={};for(var t=0;t<u.length;++t)m(u[t],null,u[t].attributes.map((function(t){return[t.location,t.name]})))}return r.profile&&(i.getMaxUniformsCount=function(){var t=0;return u.forEach((function(e){e.stats.uniformsCount>t&&(t=e.stats.uniformsCount)})),t},i.getMaxAttributesCount=function(){var t=0;return u.forEach((function(e){e.stats.attributesCount>t&&(t=e.stats.attributesCount)})),t}),{clear:function(){var e=t.deleteShader.bind(t);Me(o).forEach(e),o={},Me(s).forEach(e),s={},u.forEach((function(e){t.deleteProgram(e.program)})),u.length=0,c={},i.shaderCount=0},program:function(n,r,a,h){nt.command(n>=0,"missing vertex shader",a),nt.command(r>=0,"missing fragment shader",a);var l=c[r];l||(l=c[r]={});var f=l[n];if(f&&(f.refCount++,!h))return f;var g=new d(r,n);return i.shaderCount++,m(g,a,h),f||(l[n]=g),u.push(g),e(g,{destroy:function(){if(g.refCount--,g.refCount<=0){t.deleteProgram(g.program);var e=u.indexOf(g);u.splice(e,1),i.shaderCount--}l[g.vertId].refCount<=0&&(t.deleteShader(s[g.vertId]),delete s[g.vertId],delete c[g.fragId][g.vertId]),Object.keys(c[g.fragId]).length||(t.deleteShader(o[g.fragId]),delete o[g.fragId],delete c[g.fragId])}})},restore:g,shader:l,frag:-1,vert:-1}}var io=6408,ro=5121,oo=3333,so=5126;function ao(e,n,i,r,o,s,a){function h(h){var l;null===n.next?(nt(o.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),l=ro):(nt(null!==n.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),l=n.next.colorAttachments[0].texture._texture.type,nt.optional((function(){s.oes_texture_float?(nt(l===ro||l===so,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),l===so&&nt(a.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):nt(l===ro,"Reading from a framebuffer is only allowed for the type 'uint8'")})));var c=0,u=0,f=r.framebufferWidth,d=r.framebufferHeight,m=null;t(h)?m=h:h&&(nt.type(h,"object","invalid arguments to regl.read()"),c=0|h.x,u=0|h.y,nt(c>=0&&c<r.framebufferWidth,"invalid x offset for regl.read"),nt(u>=0&&u<r.framebufferHeight,"invalid y offset for regl.read"),f=0|(h.width||r.framebufferWidth-c),d=0|(h.height||r.framebufferHeight-u),m=h.data||null),m&&(l===ro?nt(m instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):l===so&&nt(m instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),nt(f>0&&f+c<=r.framebufferWidth,"invalid width for read pixels"),nt(d>0&&d+u<=r.framebufferHeight,"invalid height for read pixels"),i();var g=f*d*4;return m||(l===ro?m=new Uint8Array(g):l===so&&(m=m||new Float32Array(g))),nt.isTypedArray(m,"data buffer for regl.read() must be a typedarray"),nt(m.byteLength>=g,"data buffer for regl.read() too small"),e.pixelStorei(oo,4),e.readPixels(c,u,f,d,io,l,m),m}function l(t){var e;return n.setFBO({framebuffer:t.framebuffer},(function(){e=h(t)})),e}function c(t){return t&&"framebuffer"in t?l(t):h(t)}return c}function ho(t){return Array.prototype.slice.call(t)}function lo(t){return ho(t).join("")}function co(){var t=0,n=[],i=[];function r(e){for(var r=0;r<i.length;++r)if(i[r]===e)return n[r];var o="g"+t++;return n.push(o),i.push(e),o}function o(){var n=[];function i(){n.push.apply(n,ho(arguments))}var r=[];function o(){var e="v"+t++;return r.push(e),arguments.length>0&&(n.push(e,"="),n.push.apply(n,ho(arguments)),n.push(";")),e}return e(i,{def:o,toString:function(){return lo([r.length>0?"var "+r.join(",")+";":"",lo(n)])}})}function s(){var t=o(),n=o(),i=t.toString,r=n.toString;function s(e,i){n(e,i,"=",t.def(e,i),";")}return e((function(){t.apply(t,ho(arguments))}),{def:t.def,entry:t,exit:n,save:s,set:function(e,n,i){s(e,n),t(e,n,"=",i,";")},toString:function(){return i()+r()}})}function a(){var t=lo(arguments),n=s(),i=s(),r=n.toString,o=i.toString;return e(n,{then:function(){return n.apply(n,ho(arguments)),this},else:function(){return i.apply(i,ho(arguments)),this},toString:function(){var e=o();return e&&(e="else{"+e+"}"),lo(["if(",t,"){",r(),"}",e])}})}var h=o(),l={};function c(t,n){var i=[];function r(){var t="a"+i.length;return i.push(t),t}n=n||0;for(var o=0;o<n;++o)r();var a=s(),h=a.toString;return l[t]=e(a,{arg:r,toString:function(){return lo(["function(",i.join(),"){",h(),"}"])}})}function u(){var t=['"use strict";',h,"return {"];Object.keys(l).forEach((function(e){t.push('"',e,'":',l[e].toString(),",")})),t.push("}");var e=lo(t).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,n.concat(e)).apply(null,i)}return{global:h,link:r,block:o,proc:c,scope:s,cond:a,compile:u}}var uo="xyzw".split(""),fo=5121,mo=1,go=2,po=0,_o=1,vo=2,yo=3,xo=4,bo=5,wo=6,To="dither",Mo="blend.enable",Ao="blend.color",Eo="blend.equation",Co="blend.func",So="depth.enable",Po="depth.func",Ro="depth.range",Oo="depth.mask",Io="colorMask",Do="cull.enable",ko="cull.face",Lo="frontFace",Fo="lineWidth",No="polygonOffset.enable",Bo="polygonOffset.offset",Ho="sample.alpha",jo="sample.enable",zo="sample.coverage",Go="stencil.enable",Uo="stencil.mask",Vo="stencil.func",Wo="stencil.opFront",Xo="stencil.opBack",Zo="scissor.enable",qo="scissor.box",Yo="viewport",Ko="profile",Jo="framebuffer",Qo="vert",$o="frag",ts="elements",es="primitive",ns="count",is="offset",rs="instances",os="vao",ss="Width",as="Height",hs=Jo+ss,ls=Jo+as,cs=Yo+ss,us=Yo+as,fs="drawingBuffer",ds=fs+ss,ms=fs+as,gs=[Co,Eo,Vo,Wo,Xo,zo,Yo,qo,Bo],ps=34962,_s=34963,vs=3553,ys=34067,xs=2884,bs=3042,ws=3024,Ts=2960,Ms=2929,As=3089,Es=32823,Cs=32926,Ss=32928,Ps=5126,Rs=35664,Os=35665,Is=35666,Ds=5124,ks=35667,Ls=35668,Fs=35669,Ns=35670,Bs=35671,Hs=35672,js=35673,zs=35674,Gs=35675,Us=35676,Vs=35678,Ws=35680,Xs=4,Zs=1028,qs=1029,Ys=2304,Ks=2305,Js=32775,Qs=32776,$s=519,ta=7680,ea=0,na=1,ia=32774,ra=513,oa=36160,sa=36064,aa={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},ha=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],la={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},ca={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},ua={frag:35632,vert:35633},fa={cw:Ys,ccw:Ks};function da(e){return Array.isArray(e)||t(e)||Te(e)}function ma(t){return t.sort((function(t,e){return t===Yo?-1:e===Yo?1:t<e?-1:1}))}function ga(t,e,n,i){this.thisDep=t,this.contextDep=e,this.propDep=n,this.append=i}function pa(t){return t&&!(t.thisDep||t.contextDep||t.propDep)}function _a(t){return new ga(!1,!1,!1,t)}function va(t,e){var n=t.type;if(n===po){var i=t.data.length;return new ga(!0,i>=1,i>=2,e)}if(n===xo){var r=t.data;return new ga(r.thisDep,r.contextDep,r.propDep,e)}if(n===bo)return new ga(!1,!1,!1,e);if(n===wo){for(var o=!1,s=!1,a=!1,h=0;h<t.data.length;++h){var l=t.data[h];if(l.type===_o)a=!0;else if(l.type===vo)s=!0;else if(l.type===yo)o=!0;else if(l.type===po){o=!0;var c=l.data;c>=1&&(s=!0),c>=2&&(a=!0)}else l.type===xo&&(o=o||l.data.thisDep,s=s||l.data.contextDep,a=a||l.data.propDep)}return new ga(o,s,a,e)}return new ga(n===yo,n===vo,n===_o,e)}var ya=new ga(!1,!1,!1,(function(){}));function xa(t,n,i,r,o,s,a,h,l,c,u,f,d,m,g){var p=c.Record,_={add:32774,subtract:32778,"reverse subtract":32779};i.ext_blend_minmax&&(_.min=Js,_.max=Qs);var v=i.angle_instanced_arrays,y=i.webgl_draw_buffers,x=i.oes_vertex_array_object,b={dirty:!0,profile:g.profile},w={},T=[],M={},A={};function E(t){return t.replace(".","_")}function C(t,e,n){var i=E(t);T.push(t),w[i]=b[i]=!!n,M[i]=e}function S(t,e,n){var i=E(t);T.push(t),Array.isArray(n)?(b[i]=n.slice(),w[i]=n.slice()):b[i]=w[i]=n,A[i]=e}C(To,ws),C(Mo,bs),S(Ao,"blendColor",[0,0,0,0]),S(Eo,"blendEquationSeparate",[ia,ia]),S(Co,"blendFuncSeparate",[na,ea,na,ea]),C(So,Ms,!0),S(Po,"depthFunc",ra),S(Ro,"depthRange",[0,1]),S(Oo,"depthMask",!0),S(Io,Io,[!0,!0,!0,!0]),C(Do,xs),S(ko,"cullFace",qs),S(Lo,Lo,Ks),S(Fo,Fo,1),C(No,Es),S(Bo,"polygonOffset",[0,0]),C(Ho,Cs),C(jo,Ss),S(zo,"sampleCoverage",[1,!1]),C(Go,Ts),S(Uo,"stencilMask",-1),S(Vo,"stencilFunc",[$s,0,-1]),S(Wo,"stencilOpSeparate",[Zs,ta,ta,ta]),S(Xo,"stencilOpSeparate",[qs,ta,ta,ta]),C(Zo,As),S(qo,"scissor",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]),S(Yo,Yo,[0,0,t.drawingBufferWidth,t.drawingBufferHeight]);var P={gl:t,context:d,strings:n,next:w,current:b,draw:f,elements:s,buffer:o,shader:u,attributes:c.state,vao:c,uniforms:l,framebuffer:h,extensions:i,timer:m,isBufferArgs:da},R={primTypes:Xe,compareFuncs:la,blendFuncs:aa,blendEquations:_,stencilOps:ca,glTypes:De,orientationType:fa};nt.optional((function(){P.isArrayLike=un})),y&&(R.backBuffer=[qs],R.drawBuffer=Et(r.maxDrawbuffers,(function(t){return 0===t?[0]:Et(t,(function(t){return sa+t}))})));var O=0;function I(){var t=co(),e=t.link,i=t.global;t.id=O++,t.batchId="0";var r=e(P),o=t.shared={props:"a0"};Object.keys(P).forEach((function(t){o[t]=i.def(r,".",t)})),nt.optional((function(){t.CHECK=e(nt),t.commandStr=nt.guessCommand(),t.command=e(t.commandStr),t.assert=function(t,n,i){t("if(!(",n,"))",this.CHECK,".commandRaise(",e(i),",",this.command,");")},R.invalidBlendCombinations=ha}));var s=t.next={},a=t.current={};Object.keys(A).forEach((function(t){Array.isArray(b[t])&&(s[t]=i.def(o.next,".",t),a[t]=i.def(o.current,".",t))}));var h=t.constants={};Object.keys(R).forEach((function(t){h[t]=i.def(JSON.stringify(R[t]))})),t.invoke=function(n,i){switch(i.type){case po:var r=["this",o.context,o.props,t.batchId];return n.def(e(i.data),".call(",r.slice(0,Math.max(i.data.length+1,4)),")");case _o:return n.def(o.props,i.data);case vo:return n.def(o.context,i.data);case yo:return n.def("this",i.data);case xo:return i.data.append(t,n),i.data.ref;case bo:return i.data.toString();case wo:return i.data.map((function(e){return t.invoke(n,e)}))}},t.attribCache={};var l={};return t.scopeAttrib=function(t){var i=n.id(t);if(i in l)return l[i];var r=c.scope[i];return r||(r=c.scope[i]=new p),l[i]=e(r)},t}function D(t){var e,n=t.static,i=t.dynamic;if(Ko in n){var r=!!n[Ko];(e=_a((function(t,e){return r}))).enable=r}else if(Ko in i){var o=i[Ko];e=va(o,(function(t,e){return t.invoke(e,o)}))}return e}function k(t,e){var n=t.static,i=t.dynamic;if(Jo in n){var r=n[Jo];return r?(r=h.getFramebuffer(r),nt.command(r,"invalid framebuffer object"),_a((function(t,e){var n=t.link(r),i=t.shared;e.set(i.framebuffer,".next",n);var o=i.context;return e.set(o,"."+hs,n+".width"),e.set(o,"."+ls,n+".height"),n}))):_a((function(t,e){var n=t.shared;e.set(n.framebuffer,".next","null");var i=n.context;return e.set(i,"."+hs,i+"."+ds),e.set(i,"."+ls,i+"."+ms),"null"}))}if(Jo in i){var o=i[Jo];return va(o,(function(t,e){var n=t.invoke(e,o),i=t.shared,r=i.framebuffer,s=e.def(r,".getFramebuffer(",n,")");nt.optional((function(){t.assert(e,"!"+n+"||"+s,"invalid framebuffer object")})),e.set(r,".next",s);var a=i.context;return e.set(a,"."+hs,s+"?"+s+".width:"+a+"."+ds),e.set(a,"."+ls,s+"?"+s+".height:"+a+"."+ms),s}))}return null}function L(t,e,n){var i=t.static,r=t.dynamic;function o(t){if(t in i){var o=i[t];nt.commandType(o,"object","invalid "+t,n.commandStr);var s,a,h=!0,l=0|o.x,c=0|o.y;return"width"in o?(s=0|o.width,nt.command(s>=0,"invalid "+t,n.commandStr)):h=!1,"height"in o?(a=0|o.height,nt.command(a>=0,"invalid "+t,n.commandStr)):h=!1,new ga(!h&&e&&e.thisDep,!h&&e&&e.contextDep,!h&&e&&e.propDep,(function(t,e){var n=t.shared.context,i=s;"width"in o||(i=e.def(n,".",hs,"-",l));var r=a;return"height"in o||(r=e.def(n,".",ls,"-",c)),[l,c,i,r]}))}if(t in r){var u=r[t],f=va(u,(function(e,n){var i=e.invoke(n,u);nt.optional((function(){e.assert(n,i+"&&typeof "+i+'==="object"',"invalid "+t)}));var r=e.shared.context,o=n.def(i,".x|0"),s=n.def(i,".y|0"),a=n.def('"width" in ',i,"?",i,".width|0:","(",r,".",hs,"-",o,")"),h=n.def('"height" in ',i,"?",i,".height|0:","(",r,".",ls,"-",s,")");return nt.optional((function(){e.assert(n,a+">=0&&"+h+">=0","invalid "+t)})),[o,s,a,h]}));return e&&(f.thisDep=f.thisDep||e.thisDep,f.contextDep=f.contextDep||e.contextDep,f.propDep=f.propDep||e.propDep),f}return e?new ga(e.thisDep,e.contextDep,e.propDep,(function(t,e){var n=t.shared.context;return[0,0,e.def(n,".",hs),e.def(n,".",ls)]})):null}var s=o(Yo);if(s){var a=s;s=new ga(s.thisDep,s.contextDep,s.propDep,(function(t,e){var n=a.append(t,e),i=t.shared.context;return e.set(i,"."+cs,n[2]),e.set(i,"."+us,n[3]),n}))}return{viewport:s,scissor_box:o(qo)}}function F(t,e){var n=t.static;if("string"==typeof n[$o]&&"string"==typeof n[Qo]){if(Object.keys(e.dynamic).length>0)return null;var i=e.static,r=Object.keys(i);if(r.length>0&&"number"==typeof i[r[0]]){for(var o=[],s=0;s<r.length;++s)nt("number"==typeof i[r[s]],"must specify all vertex attribute locations when using vaos"),o.push([0|i[r[s]],r[s]]);return o}}return null}function N(t,e,i){var r=t.static,o=t.dynamic;function s(t){if(t in r){var e=n.id(r[t]);nt.optional((function(){u.shader(ua[t],e,nt.guessCommand())}));var i=_a((function(){return e}));return i.id=e,i}if(t in o){var s=o[t];return va(s,(function(e,n){var i=e.invoke(n,s),r=n.def(e.shared.strings,".id(",i,")");return nt.optional((function(){n(e.shared.shader,".shader(",ua[t],",",r,",",e.command,");")})),r}))}return null}var a,h=s($o),l=s(Qo),c=null;return pa(h)&&pa(l)?(c=u.program(l.id,h.id,null,i),a=_a((function(t,e){return t.link(c)}))):a=new ga(h&&h.thisDep||l&&l.thisDep,h&&h.contextDep||l&&l.contextDep,h&&h.propDep||l&&l.propDep,(function(t,e){var n,i=t.shared.shader;n=h?h.append(t,e):e.def(i,".",$o);var r=i+".program("+(l?l.append(t,e):e.def(i,".",Qo))+","+n;return nt.optional((function(){r+=","+t.command})),e.def(r+")")})),{frag:h,vert:l,progVar:a,program:c}}function B(t,e){var n=t.static,i=t.dynamic,r={},o=!1;function a(){if(os in n){var t=n[os];return null!==t&&null===c.getVAO(t)&&(t=c.createVAO(t)),o=!0,r.vao=t,_a((function(e){var n=c.getVAO(t);return n?e.link(n):"null"}))}if(os in i){o=!0;var e=i[os];return va(e,(function(t,n){var i=t.invoke(n,e);return n.def(t.shared.vao+".getVAO("+i+")")}))}return null}var h=a(),l=!1;function u(){if(ts in n){var t=n[ts];if(r.elements=t,da(t)){var a=r.elements=s.create(t,!0);t=s.getElements(a),l=!0}else t&&(t=s.getElements(t),l=!0,nt.command(t,"invalid elements",e.commandStr));var c=_a((function(e,n){if(t){var i=e.link(t);return e.ELEMENTS=i,i}return e.ELEMENTS=null,null}));return c.value=t,c}if(ts in i){l=!0;var u=i[ts];return va(u,(function(t,e){var n=t.shared,i=n.isBufferArgs,r=n.elements,o=t.invoke(e,u),s=e.def("null"),a=e.def(i,"(",o,")"),h=t.cond(a).then(s,"=",r,".createStream(",o,");").else(s,"=",r,".getElements(",o,");");return nt.optional((function(){t.assert(h.else,"!"+o+"||"+s,"invalid elements")})),e.entry(h),e.exit(t.cond(a).then(r,".destroyStream(",s,");")),t.ELEMENTS=s,s}))}return o?new ga(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.elements+".getElements("+t.shared.vao+".currentVAO.elements):null")})):null}var f=u();function d(){if(es in n){var t=n[es];return r.primitive=t,nt.commandParameter(t,Xe,"invalid primitve",e.commandStr),_a((function(e,n){return Xe[t]}))}if(es in i){var s=i[es];return va(s,(function(t,e){var n=t.constants.primTypes,i=t.invoke(e,s);return nt.optional((function(){t.assert(e,i+" in "+n,"invalid primitive, must be one of "+Object.keys(Xe))})),e.def(n,"[",i,"]")}))}return l?pa(f)?f.value?_a((function(t,e){return e.def(t.ELEMENTS,".primType")})):_a((function(){return Xs})):new ga(f.thisDep,f.contextDep,f.propDep,(function(t,e){var n=t.ELEMENTS;return e.def(n,"?",n,".primType:",Xs)})):o?new ga(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.primitive:"+Xs)})):null}function m(t,s){if(t in n){var a=0|n[t];return s?r.offset=a:r.instances=a,nt.command(!s||a>=0,"invalid "+t,e.commandStr),_a((function(t,e){return s&&(t.OFFSET=a),a}))}if(t in i){var c=i[t];return va(c,(function(e,n){var i=e.invoke(n,c);return s&&(e.OFFSET=i,nt.optional((function(){e.assert(n,i+">=0","invalid "+t)}))),i}))}if(s){if(l)return _a((function(t,e){return t.OFFSET=0,0}));if(o)return new ga(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.offset:0")}))}else if(o)return new ga(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.instances:-1")}));return null}var g=m(is,!0);function p(){if(ns in n){var t=0|n[ns];return r.count=t,nt.command("number"==typeof t&&t>=0,"invalid vertex count",e.commandStr),_a((function(){return t}))}if(ns in i){var s=i[ns];return va(s,(function(t,e){var n=t.invoke(e,s);return nt.optional((function(){t.assert(e,"typeof "+n+'==="number"&&'+n+">=0&&"+n+"===("+n+"|0)","invalid vertex count")})),n}))}if(l){if(pa(f)){if(f)return g?new ga(g.thisDep,g.contextDep,g.propDep,(function(t,e){var n=e.def(t.ELEMENTS,".vertCount-",t.OFFSET);return nt.optional((function(){t.assert(e,n+">=0","invalid vertex offset/element buffer too small")})),n})):_a((function(t,e){return e.def(t.ELEMENTS,".vertCount")}));var a=_a((function(){return-1}));return nt.optional((function(){a.MISSING=!0})),a}var c=new ga(f.thisDep||g.thisDep,f.contextDep||g.contextDep,f.propDep||g.propDep,(function(t,e){var n=t.ELEMENTS;return t.OFFSET?e.def(n,"?",n,".vertCount-",t.OFFSET,":-1"):e.def(n,"?",n,".vertCount:-1")}));return nt.optional((function(){c.DYNAMIC=!0})),c}if(o){var u=new ga(h.thisDep,h.contextDep,h.propDep,(function(t,e){return e.def(t.shared.vao,".currentVAO?",t.shared.vao,".currentVAO.count:-1")}));return u}return null}var _=d(),v=p(),y=m(rs,!1);return{elements:f,primitive:_,count:v,instances:y,offset:g,vao:h,vaoActive:o,elementsActive:l,static:r}}function H(t,e){var n=t.static,i=t.dynamic,o={};return T.forEach((function(t){var s=E(t);function a(e,r){if(t in n){var a=e(n[t]);o[s]=_a((function(){return a}))}else if(t in i){var h=i[t];o[s]=va(h,(function(t,e){return r(t,e,t.invoke(e,h))}))}}switch(t){case Do:case Mo:case To:case Go:case So:case Zo:case No:case Ho:case jo:case Oo:return a((function(n){return nt.commandType(n,"boolean",t,e.commandStr),n}),(function(e,n,i){return nt.optional((function(){e.assert(n,"typeof "+i+'==="boolean"',"invalid flag "+t,e.commandStr)})),i}));case Po:return a((function(n){return nt.commandParameter(n,la,"invalid "+t,e.commandStr),la[n]}),(function(e,n,i){var r=e.constants.compareFuncs;return nt.optional((function(){e.assert(n,i+" in "+r,"invalid "+t+", must be one of "+Object.keys(la))})),n.def(r,"[",i,"]")}));case Ro:return a((function(t){return nt.command(un(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1]&&t[0]<=t[1],"depth range is 2d array",e.commandStr),t}),(function(t,e,n){return nt.optional((function(){t.assert(e,t.shared.isArrayLike+"("+n+")&&"+n+".length===2&&typeof "+n+'[0]==="number"&&typeof '+n+'[1]==="number"&&'+n+"[0]<="+n+"[1]","depth range must be a 2d array")})),[e.def("+",n,"[0]"),e.def("+",n,"[1]")]}));case Co:return a((function(t){nt.commandType(t,"object","blend.func",e.commandStr);var n="srcRGB"in t?t.srcRGB:t.src,i="srcAlpha"in t?t.srcAlpha:t.src,r="dstRGB"in t?t.dstRGB:t.dst,o="dstAlpha"in t?t.dstAlpha:t.dst;return nt.commandParameter(n,aa,s+".srcRGB",e.commandStr),nt.commandParameter(i,aa,s+".srcAlpha",e.commandStr),nt.commandParameter(r,aa,s+".dstRGB",e.commandStr),nt.commandParameter(o,aa,s+".dstAlpha",e.commandStr),nt.command(-1===ha.indexOf(n+", "+r),"unallowed blending combination (srcRGB, dstRGB) = ("+n+", "+r+")",e.commandStr),[aa[n],aa[r],aa[i],aa[o]]}),(function(e,n,i){var r=e.constants.blendFuncs;function o(o,s){var a=n.def('"',o,s,'" in ',i,"?",i,".",o,s,":",i,".",o);return nt.optional((function(){e.assert(n,a+" in "+r,"invalid "+t+"."+o+s+", must be one of "+Object.keys(aa))})),a}nt.optional((function(){e.assert(n,i+"&&typeof "+i+'==="object"',"invalid blend func, must be an object")}));var s=o("src","RGB"),a=o("dst","RGB");nt.optional((function(){var t=e.constants.invalidBlendCombinations;e.assert(n,t+".indexOf("+s+'+", "+'+a+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var h=n.def(r,"[",s,"]"),l=n.def(r,"[",o("src","Alpha"),"]");return[h,n.def(r,"[",a,"]"),l,n.def(r,"[",o("dst","Alpha"),"]")]}));case Eo:return a((function(n){return"string"==typeof n?(nt.commandParameter(n,_,"invalid "+t,e.commandStr),[_[n],_[n]]):"object"==typeof n?(nt.commandParameter(n.rgb,_,t+".rgb",e.commandStr),nt.commandParameter(n.alpha,_,t+".alpha",e.commandStr),[_[n.rgb],_[n.alpha]]):void nt.commandRaise("invalid blend.equation",e.commandStr)}),(function(e,n,i){var r=e.constants.blendEquations,o=n.def(),s=n.def(),a=e.cond("typeof ",i,'==="string"');return nt.optional((function(){function n(t,n,i){e.assert(t,i+" in "+r,"invalid "+n+", must be one of "+Object.keys(_))}n(a.then,t,i),e.assert(a.else,i+"&&typeof "+i+'==="object"',"invalid "+t),n(a.else,t+".rgb",i+".rgb"),n(a.else,t+".alpha",i+".alpha")})),a.then(o,"=",s,"=",r,"[",i,"];"),a.else(o,"=",r,"[",i,".rgb];",s,"=",r,"[",i,".alpha];"),n(a),[o,s]}));case Ao:return a((function(t){return nt.command(un(t)&&4===t.length,"blend.color must be a 4d array",e.commandStr),Et(4,(function(e){return+t[e]}))}),(function(t,e,n){return nt.optional((function(){t.assert(e,t.shared.isArrayLike+"("+n+")&&"+n+".length===4","blend.color must be a 4d array")})),Et(4,(function(t){return e.def("+",n,"[",t,"]")}))}));case Uo:return a((function(t){return nt.commandType(t,"number",s,e.commandStr),0|t}),(function(t,e,n){return nt.optional((function(){t.assert(e,"typeof "+n+'==="number"',"invalid stencil.mask")})),e.def(n,"|0")}));case Vo:return a((function(n){nt.commandType(n,"object",s,e.commandStr);var i=n.cmp||"keep",r=n.ref||0,o="mask"in n?n.mask:-1;return nt.commandParameter(i,la,t+".cmp",e.commandStr),nt.commandType(r,"number",t+".ref",e.commandStr),nt.commandType(o,"number",t+".mask",e.commandStr),[la[i],r,o]}),(function(t,e,n){var i=t.constants.compareFuncs;return nt.optional((function(){function r(){t.assert(e,Array.prototype.join.call(arguments,""),"invalid stencil.func")}r(n+"&&typeof ",n,'==="object"'),r('!("cmp" in ',n,")||(",n,".cmp in ",i,")")})),[e.def('"cmp" in ',n,"?",i,"[",n,".cmp]",":",ta),e.def(n,".ref|0"),e.def('"mask" in ',n,"?",n,".mask|0:-1")]}));case Wo:case Xo:return a((function(n){nt.commandType(n,"object",s,e.commandStr);var i=n.fail||"keep",r=n.zfail||"keep",o=n.zpass||"keep";return nt.commandParameter(i,ca,t+".fail",e.commandStr),nt.commandParameter(r,ca,t+".zfail",e.commandStr),nt.commandParameter(o,ca,t+".zpass",e.commandStr),[t===Xo?qs:Zs,ca[i],ca[r],ca[o]]}),(function(e,n,i){var r=e.constants.stencilOps;function o(o){return nt.optional((function(){e.assert(n,'!("'+o+'" in '+i+")||("+i+"."+o+" in "+r+")","invalid "+t+"."+o+", must be one of "+Object.keys(ca))})),n.def('"',o,'" in ',i,"?",r,"[",i,".",o,"]:",ta)}return nt.optional((function(){e.assert(n,i+"&&typeof "+i+'==="object"',"invalid "+t)})),[t===Xo?qs:Zs,o("fail"),o("zfail"),o("zpass")]}));case Bo:return a((function(t){nt.commandType(t,"object",s,e.commandStr);var n=0|t.factor,i=0|t.units;return nt.commandType(n,"number",s+".factor",e.commandStr),nt.commandType(i,"number",s+".units",e.commandStr),[n,i]}),(function(e,n,i){return nt.optional((function(){e.assert(n,i+"&&typeof "+i+'==="object"',"invalid "+t)})),[n.def(i,".factor|0"),n.def(i,".units|0")]}));case ko:return a((function(t){var n=0;return"front"===t?n=Zs:"back"===t&&(n=qs),nt.command(!!n,s,e.commandStr),n}),(function(t,e,n){return nt.optional((function(){t.assert(e,n+'==="front"||'+n+'==="back"',"invalid cull.face")})),e.def(n,'==="front"?',Zs,":",qs)}));case Fo:return a((function(t){return nt.command("number"==typeof t&&t>=r.lineWidthDims[0]&&t<=r.lineWidthDims[1],"invalid line width, must be a positive number between "+r.lineWidthDims[0]+" and "+r.lineWidthDims[1],e.commandStr),t}),(function(t,e,n){return nt.optional((function(){t.assert(e,"typeof "+n+'==="number"&&'+n+">="+r.lineWidthDims[0]+"&&"+n+"<="+r.lineWidthDims[1],"invalid line width")})),n}));case Lo:return a((function(t){return nt.commandParameter(t,fa,s,e.commandStr),fa[t]}),(function(t,e,n){return nt.optional((function(){t.assert(e,n+'==="cw"||'+n+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),e.def(n+'==="cw"?'+Ys+":"+Ks)}));case Io:return a((function(t){return nt.command(un(t)&&4===t.length,"color.mask must be length 4 array",e.commandStr),t.map((function(t){return!!t}))}),(function(t,e,n){return nt.optional((function(){t.assert(e,t.shared.isArrayLike+"("+n+")&&"+n+".length===4","invalid color.mask")})),Et(4,(function(t){return"!!"+n+"["+t+"]"}))}));case zo:return a((function(t){nt.command("object"==typeof t&&t,s,e.commandStr);var n="value"in t?t.value:1,i=!!t.invert;return nt.command("number"==typeof n&&n>=0&&n<=1,"sample.coverage.value must be a number between 0 and 1",e.commandStr),[n,i]}),(function(t,e,n){return nt.optional((function(){t.assert(e,n+"&&typeof "+n+'==="object"',"invalid sample.coverage")})),[e.def('"value" in ',n,"?+",n,".value:1"),e.def("!!",n,".invert")]}))}})),o}function j(t,e){var n=t.static,i=t.dynamic,r={};return Object.keys(n).forEach((function(t){var i,o=n[t];if("number"==typeof o||"boolean"==typeof o)i=_a((function(){return o}));else if("function"==typeof o){var s=o._reglType;"texture2d"===s||"textureCube"===s?i=_a((function(t){return t.link(o)})):"framebuffer"===s||"framebufferCube"===s?(nt.command(o.color.length>0,'missing color attachment for framebuffer sent to uniform "'+t+'"',e.commandStr),i=_a((function(t){return t.link(o.color[0])}))):nt.commandRaise('invalid data for uniform "'+t+'"',e.commandStr)}else un(o)?i=_a((function(e){var n=e.global.def("[",Et(o.length,(function(n){return nt.command("number"==typeof o[n]||"boolean"==typeof o[n],"invalid uniform "+t,e.commandStr),o[n]})),"]");return n})):nt.commandRaise('invalid or missing data for uniform "'+t+'"',e.commandStr);i.value=o,r[t]=i})),Object.keys(i).forEach((function(t){var e=i[t];r[t]=va(e,(function(t,n){return t.invoke(n,e)}))})),r}function z(t,e){var i=t.static,r=t.dynamic,s={};return Object.keys(i).forEach((function(t){var r=i[t],a=n.id(t),h=new p;if(da(r))h.state=mo,h.buffer=o.getBuffer(o.create(r,ps,!1,!0)),h.type=0;else{var l=o.getBuffer(r);if(l)h.state=mo,h.buffer=l,h.type=0;else if(nt.command("object"==typeof r&&r,"invalid data for attribute "+t,e.commandStr),"constant"in r){var c=r.constant;h.buffer="null",h.state=go,"number"==typeof c?h.x=c:(nt.command(un(c)&&c.length>0&&c.length<=4,"invalid constant for attribute "+t,e.commandStr),uo.forEach((function(t,e){e<c.length&&(h[t]=c[e])})))}else{l=da(r.buffer)?o.getBuffer(o.create(r.buffer,ps,!1,!0)):o.getBuffer(r.buffer),nt.command(!!l,'missing buffer for attribute "'+t+'"',e.commandStr);var u=0|r.offset;nt.command(u>=0,'invalid offset for attribute "'+t+'"',e.commandStr);var f=0|r.stride;nt.command(f>=0&&f<256,'invalid stride for attribute "'+t+'", must be integer betweeen [0, 255]',e.commandStr);var d=0|r.size;nt.command(!("size"in r)||d>0&&d<=4,'invalid size for attribute "'+t+'", must be 1,2,3,4',e.commandStr);var m=!!r.normalized,g=0;"type"in r&&(nt.commandParameter(r.type,De,"invalid type for attribute "+t,e.commandStr),g=De[r.type]);var _=0|r.divisor;nt.optional((function(){"divisor"in r&&(nt.command(0===_||v,'cannot specify divisor for attribute "'+t+'", instancing not supported',e.commandStr),nt.command(_>=0,'invalid divisor for attribute "'+t+'"',e.commandStr));var n=e.commandStr,i=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(r).forEach((function(e){nt.command(i.indexOf(e)>=0,'unknown parameter "'+e+'" for attribute pointer "'+t+'" (valid parameters are '+i+")",n)}))})),h.buffer=l,h.state=mo,h.size=d,h.normalized=m,h.type=g||l.dtype,h.offset=u,h.stride=f,h.divisor=_}}s[t]=_a((function(t,e){var n=t.attribCache;if(a in n)return n[a];var i={isStream:!1};return Object.keys(h).forEach((function(t){i[t]=h[t]})),h.buffer&&(i.buffer=t.link(h.buffer),i.type=i.type||i.buffer+".dtype"),n[a]=i,i}))})),Object.keys(r).forEach((function(t){var e=r[t];function n(n,i){var r=n.invoke(i,e),o=n.shared,s=n.constants,a=o.isBufferArgs,h=o.buffer;nt.optional((function(){n.assert(i,r+"&&(typeof "+r+'==="object"||typeof '+r+'==="function")&&('+a+"("+r+")||"+h+".getBuffer("+r+")||"+h+".getBuffer("+r+".buffer)||"+a+"("+r+'.buffer)||("constant" in '+r+"&&(typeof "+r+'.constant==="number"||'+o.isArrayLike+"("+r+".constant))))",'invalid dynamic attribute "'+t+'"')}));var l={isStream:i.def(!1)},c=new p;c.state=mo,Object.keys(c).forEach((function(t){l[t]=i.def(""+c[t])}));var u=l.buffer,f=l.type;function d(t){i(l[t],"=",r,".",t,"|0;")}return i("if(",a,"(",r,")){",l.isStream,"=true;",u,"=",h,".createStream(",ps,",",r,");",f,"=",u,".dtype;","}else{",u,"=",h,".getBuffer(",r,");","if(",u,"){",f,"=",u,".dtype;",'}else if("constant" in ',r,"){",l.state,"=",go,";","if(typeof "+r+'.constant === "number"){',l[uo[0]],"=",r,".constant;",uo.slice(1).map((function(t){return l[t]})).join("="),"=0;","}else{",uo.map((function(t,e){return l[t]+"="+r+".constant.length>"+e+"?"+r+".constant["+e+"]:0;"})).join(""),"}}else{","if(",a,"(",r,".buffer)){",u,"=",h,".createStream(",ps,",",r,".buffer);","}else{",u,"=",h,".getBuffer(",r,".buffer);","}",f,'="type" in ',r,"?",s.glTypes,"[",r,".type]:",u,".dtype;",l.normalized,"=!!",r,".normalized;"),d("size"),d("offset"),d("stride"),d("divisor"),i("}}"),i.exit("if(",l.isStream,"){",h,".destroyStream(",u,");","}"),l}s[t]=va(e,n)})),s}function G(t){var e=t.static,n=t.dynamic,i={};return Object.keys(e).forEach((function(t){var n=e[t];i[t]=_a((function(t,e){return"number"==typeof n||"boolean"==typeof n?""+n:t.link(n)}))})),Object.keys(n).forEach((function(t){var e=n[t];i[t]=va(e,(function(t,n){return t.invoke(n,e)}))})),i}function U(t,e,n,r,o){var s=t.static,a=t.dynamic;nt.optional((function(){var t=[Jo,Qo,$o,ts,es,is,ns,rs,Ko,os].concat(T);function e(e){Object.keys(e).forEach((function(e){nt.command(t.indexOf(e)>=0,'unknown parameter "'+e+'"',o.commandStr)}))}e(s),e(a)}));var h=F(t,e),l=k(t),u=L(t,l,o),f=B(t,o),d=H(t,o),m=N(t,o,h);function g(t){var e=u[t];e&&(d[t]=e)}g(Yo),g(E(qo));var p=Object.keys(d).length>0,_={framebuffer:l,draw:f,shader:m,state:d,dirty:p,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(_.profile=D(t),_.uniforms=j(n,o),_.drawVAO=_.scopeVAO=f.vao,!_.drawVAO&&m.program&&!h&&i.angle_instanced_arrays&&f.static.elements){var v=!0,y=m.program.attributes.map((function(t){var n=e.static[t];return v=v&&!!n,n}));if(v&&y.length>0){var x=c.getVAO(c.createVAO({attributes:y,elements:f.static.elements}));_.drawVAO=new ga(null,null,null,(function(t,e){return t.link(x)})),_.useVAO=!0}}return h?_.useVAO=!0:_.attributes=z(e,o),_.context=G(r),_}function V(t,e,n){var i=t.shared.context,r=t.scope();Object.keys(n).forEach((function(o){e.save(i,"."+o);var s=n[o].append(t,e);Array.isArray(s)?r(i,".",o,"=[",s.join(),"];"):r(i,".",o,"=",s,";")})),e(r)}function W(t,e,n,i){var r,o=t.shared,s=o.gl,a=o.framebuffer;y&&(r=e.def(o.extensions,".webgl_draw_buffers"));var h,l=t.constants,c=l.drawBuffer,u=l.backBuffer;h=n?n.append(t,e):e.def(a,".next"),i||e("if(",h,"!==",a,".cur){"),e("if(",h,"){",s,".bindFramebuffer(",oa,",",h,".framebuffer);"),y&&e(r,".drawBuffersWEBGL(",c,"[",h,".colorAttachments.length]);"),e("}else{",s,".bindFramebuffer(",oa,",null);"),y&&e(r,".drawBuffersWEBGL(",u,");"),e("}",a,".cur=",h,";"),i||e("}")}function X(t,e,n){var i=t.shared,r=i.gl,o=t.current,s=t.next,a=i.current,h=i.next,l=t.cond(a,".dirty");T.forEach((function(e){var i,c,u=E(e);if(!(u in n.state))if(u in s){i=s[u],c=o[u];var f=Et(b[u].length,(function(t){return l.def(i,"[",t,"]")}));l(t.cond(f.map((function(t,e){return t+"!=="+c+"["+e+"]"})).join("||")).then(r,".",A[u],"(",f,");",f.map((function(t,e){return c+"["+e+"]="+t})).join(";"),";"))}else{i=l.def(h,".",u);var d=t.cond(i,"!==",a,".",u);l(d),u in M?d(t.cond(i).then(r,".enable(",M[u],");").else(r,".disable(",M[u],");"),a,".",u,"=",i,";"):d(r,".",A[u],"(",i,");",a,".",u,"=",i,";")}})),0===Object.keys(n.state).length&&l(a,".dirty=false;"),e(l)}function Z(t,e,n,i){var r=t.shared,o=t.current,s=r.current,a=r.gl;ma(Object.keys(n)).forEach((function(r){var h=n[r];if(!i||i(h)){var l=h.append(t,e);if(M[r]){var c=M[r];pa(h)?e(a,l?".enable(":".disable(",c,");"):e(t.cond(l).then(a,".enable(",c,");").else(a,".disable(",c,");")),e(s,".",r,"=",l,";")}else if(un(l)){var u=o[r];e(a,".",A[r],"(",l,");",l.map((function(t,e){return u+"["+e+"]="+t})).join(";"),";")}else e(a,".",A[r],"(",l,");",s,".",r,"=",l,";")}}))}function q(t,e){v&&(t.instancing=e.def(t.shared.extensions,".angle_instanced_arrays"))}function Y(t,e,n,i,r){var o,s,a,h=t.shared,l=t.stats,c=h.current,u=h.timer,f=n.profile;function d(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function g(t){t(o=e.def(),"=",d(),";"),"string"==typeof r?t(l,".count+=",r,";"):t(l,".count++;"),m&&(i?t(s=e.def(),"=",u,".getNumPendingQueries();"):t(u,".beginQuery(",l,");"))}function p(t){t(l,".cpuTime+=",d(),"-",o,";"),m&&(i?t(u,".pushScopeStats(",s,",",u,".getNumPendingQueries(),",l,");"):t(u,".endQuery();"))}function _(t){var n=e.def(c,".profile");e(c,".profile=",t,";"),e.exit(c,".profile=",n,";")}if(f){if(pa(f))return void(f.enable?(g(e),p(e.exit),_("true")):_("false"));_(a=f.append(t,e))}else a=e.def(c,".profile");var v=t.block();g(v),e("if(",a,"){",v,"}");var y=t.block();p(y),e.exit("if(",a,"){",y,"}")}function K(t,e,n,i,r){var o=t.shared;function s(t){switch(t){case Rs:case ks:case Bs:return 2;case Os:case Ls:case Hs:return 3;case Is:case Fs:case js:return 4;default:return 1}}function a(n,i,r){var s=o.gl,a=e.def(n,".location"),h=e.def(o.attributes,"[",a,"]"),l=r.state,c=r.buffer,u=[r.x,r.y,r.z,r.w],f=["buffer","normalized","offset","stride"];function d(){e(s,".enableVertexAttribArray(",a,");");var n,o=r.type;if(n=r.size?e.def(r.size,"||",i):i,e(s,".bindBuffer(",ps,",",c,".buffer);",s,".vertexAttribPointer(",[a,n,o,r.normalized,r.stride,r.offset],");",h,".type=",o,";",h,".size=",n,";",f.map((function(t){return h+"."+t+"="+r[t]+";"})).join("")),v){var l=r.divisor;e("if(",h,".divisor!==",l,"){",t.instancing,".vertexAttribDivisorANGLE(",[a,l],");",h,".divisor=",l,";}")}}function m(){e("if(",h,".buffer){",s,".disableVertexAttribArray(",a,");",h,".buffer=null;","}if(",uo.map((function(t,e){return h+"."+t+"!=="+u[e]})).join("||"),"){",s,".vertexAttrib4f(",a,",",u,");",uo.map((function(t,e){return h+"."+t+"="+u[e]+";"})).join(""),"}")}l===mo?d():l===go?m():(e("if(",l,"===",mo,"){"),d(),e("}else{"),m(),e("}"))}i.forEach((function(i){var o,h=i.name,l=n.attributes[h];if(l){if(!r(l))return;o=l.append(t,e)}else{if(!r(ya))return;var c=t.scopeAttrib(h);nt.optional((function(){t.assert(e,c+".state","missing attribute "+h)})),o={},Object.keys(new p).forEach((function(t){o[t]=e.def(c,".",t)}))}a(t.link(i),s(i.info.type),o)}))}function J(t,e,i,r,o,s){for(var a,h=t.shared,l=h.gl,c={},u=0;u<r.length;++u){var f=r[u],d=f.name,m=f.info.type,g=f.info.size,p=i.uniforms[d];if(g>1){if(!p)continue;var _=d.replace("[0]","");if(c[_])continue;c[_]=1}var v,y=t.link(f)+".location";if(p){if(!o(p))continue;if(pa(p)){var x=p.value;if(nt.command(null!=x,'missing uniform "'+d+'"',t.commandStr),m===Vs||m===Ws){nt.command("function"==typeof x&&(m===Vs&&("texture2d"===x._reglType||"framebuffer"===x._reglType)||m===Ws&&("textureCube"===x._reglType||"framebufferCube"===x._reglType)),"invalid texture for uniform "+d,t.commandStr);var b=t.link(x._texture||x.color[0]._texture);e(l,".uniform1i(",y,",",b+".bind());"),e.exit(b,".unbind();")}else if(m===zs||m===Gs||m===Us){nt.optional((function(){nt.command(un(x),"invalid matrix for uniform "+d,t.commandStr),nt.command(m===zs&&4===x.length||m===Gs&&9===x.length||m===Us&&16===x.length,"invalid length for matrix uniform "+d,t.commandStr)}));var w=t.global.def("new Float32Array(["+Array.prototype.slice.call(x)+"])"),T=2;m===Gs?T=3:m===Us&&(T=4),e(l,".uniformMatrix",T,"fv(",y,",false,",w,");")}else{switch(m){case Ps:1===g?nt.commandType(x,"number","uniform "+d,t.commandStr):nt.command(un(x)&&x.length===g,"uniform "+d,t.commandStr),a="1f";break;case Rs:nt.command(un(x)&&x.length&&x.length%2==0&&x.length<=2*g,"uniform "+d,t.commandStr),a="2f";break;case Os:nt.command(un(x)&&x.length&&x.length%3==0&&x.length<=3*g,"uniform "+d,t.commandStr),a="3f";break;case Is:nt.command(un(x)&&x.length&&x.length%4==0&&x.length<=4*g,"uniform "+d,t.commandStr),a="4f";break;case Ns:1===g?nt.commandType(x,"boolean","uniform "+d,t.commandStr):nt.command(un(x)&&x.length===g,"uniform "+d,t.commandStr),a="1i";break;case Ds:1===g?nt.commandType(x,"number","uniform "+d,t.commandStr):nt.command(un(x)&&x.length===g,"uniform "+d,t.commandStr),a="1i";break;case Bs:case ks:nt.command(un(x)&&x.length&&x.length%2==0&&x.length<=2*g,"uniform "+d,t.commandStr),a="2i";break;case Hs:case Ls:nt.command(un(x)&&x.length&&x.length%3==0&&x.length<=3*g,"uniform "+d,t.commandStr),a="3i";break;case js:case Fs:nt.command(un(x)&&x.length&&x.length%4==0&&x.length<=4*g,"uniform "+d,t.commandStr),a="4i"}g>1?(a+="v",x=t.global.def("["+Array.prototype.slice.call(x)+"]")):x=un(x)?Array.prototype.slice.call(x):x,e(l,".uniform",a,"(",y,",",x,");")}continue}v=p.append(t,e)}else{if(!o(ya))continue;v=e.def(h.uniforms,"[",n.id(d),"]")}m===Vs?(nt(!Array.isArray(v),"must specify a scalar prop for textures"),e("if(",v,"&&",v,'._reglType==="framebuffer"){',v,"=",v,".color[0];","}")):m===Ws&&(nt(!Array.isArray(v),"must specify a scalar prop for cube maps"),e("if(",v,"&&",v,'._reglType==="framebufferCube"){',v,"=",v,".color[0];","}")),nt.optional((function(){function n(n,i){t.assert(e,n,'bad data or missing for uniform "'+d+'".  '+i)}function i(t,e){1===e&&nt(!Array.isArray(v),"must not specify an array type for uniform"),n("Array.isArray("+v+") && typeof "+v+'[0]===" '+t+'" || typeof '+v+'==="'+t+'"',"invalid type, expected "+t)}function r(e,i,r){Array.isArray(v)?nt(v.length&&v.length%e==0&&v.length<=e*r,"must have length of "+(1===r?"":"n * ")+e):n(h.isArrayLike+"("+v+")&&"+v+".length && "+v+".length % "+e+" === 0 && "+v+".length<="+e*r,"invalid vector, should have length of "+(1===r?"":"n * ")+e,t.commandStr)}function o(e){nt(!Array.isArray(v),"must not specify a value type"),n("typeof "+v+'==="function"&&'+v+'._reglType==="texture'+(e===vs?"2d":"Cube")+'"',"invalid texture type",t.commandStr)}switch(m){case Ds:i("number",g);break;case ks:r(2,"number",g);break;case Ls:r(3,"number",g);break;case Fs:r(4,"number",g);break;case Ps:i("number",g);break;case Rs:r(2,"number",g);break;case Os:r(3,"number",g);break;case Is:r(4,"number",g);break;case Ns:i("boolean",g);break;case Bs:r(2,"boolean",g);break;case Hs:r(3,"boolean",g);break;case js:r(4,"boolean",g);break;case zs:r(4,"number",g);break;case Gs:r(9,"number",g);break;case Us:r(16,"number",g);break;case Vs:o(vs);break;case Ws:o(ys)}}));var M=1;switch(m){case Vs:case Ws:var A=e.def(v,"._texture");e(l,".uniform1i(",y,",",A,".bind());"),e.exit(A,".unbind();");continue;case Ds:case Ns:a="1i";break;case ks:case Bs:a="2i",M=2;break;case Ls:case Hs:a="3i",M=3;break;case Fs:case js:a="4i",M=4;break;case Ps:a="1f";break;case Rs:a="2f",M=2;break;case Os:a="3f",M=3;break;case Is:a="4f",M=4;break;case zs:a="Matrix2fv";break;case Gs:a="Matrix3fv";break;case Us:a="Matrix4fv"}if(-1===a.indexOf("Matrix")&&g>1&&(a+="v",M=1),"M"===a.charAt(0)){e(l,".uniform",a,"(",y,",");var E=Math.pow(m-zs+2,2),C=t.global.def("new Float32Array(",E,")");Array.isArray(v)?e("false,(",Et(E,(function(t){return C+"["+t+"]="+v[t]})),",",C,")"):e("false,(Array.isArray(",v,")||",v," instanceof Float32Array)?",v,":(",Et(E,(function(t){return C+"["+t+"]="+v+"["+t+"]"})),",",C,")"),e(");")}else if(M>1){for(var S=[],P=[],R=0;R<M;++R)Array.isArray(v)?P.push(v[R]):P.push(e.def(v+"["+R+"]")),s&&S.push(e.def());s&&e("if(!",t.batchId,"||",S.map((function(t,e){return t+"!=="+P[e]})).join("||"),"){",S.map((function(t,e){return t+"="+P[e]+";"})).join("")),e(l,".uniform",a,"(",y,",",P.join(","),");"),s&&e("}")}else{if(nt(!Array.isArray(v),"uniform value must not be an array"),s){var O=e.def();e("if(!",t.batchId,"||",O,"!==",v,"){",O,"=",v,";")}e(l,".uniform",a,"(",y,",",v,");"),s&&e("}")}}}function Q(t,e,n,i){var r=t.shared,o=r.gl,s=r.draw,a=i.draw;function h(){var h,l=a.elements,c=e;return l?((l.contextDep&&i.contextDynamic||l.propDep)&&(c=n),h=l.append(t,c),a.elementsActive&&c("if("+h+")"+o+".bindBuffer("+_s+","+h+".buffer.buffer);")):(h=c.def(),c(h,"=",s,".",ts,";","if(",h,"){",o,".bindBuffer(",_s,",",h,".buffer.buffer);}","else if(",r.vao,".currentVAO){",h,"=",t.shared.elements+".getElements("+r.vao,".currentVAO.elements);",x?"":"if("+h+")"+o+".bindBuffer("+_s+","+h+".buffer.buffer);","}")),h}function l(){var r,o=a.count,h=e;return o?((o.contextDep&&i.contextDynamic||o.propDep)&&(h=n),r=o.append(t,h),nt.optional((function(){o.MISSING&&t.assert(e,"false","missing vertex count"),o.DYNAMIC&&t.assert(h,r+">=0","missing vertex count")}))):(r=h.def(s,".",ns),nt.optional((function(){t.assert(h,r+">=0","missing vertex count")}))),r}var c=h();function u(r){var o=a[r];return o?o.contextDep&&i.contextDynamic||o.propDep?o.append(t,n):o.append(t,e):e.def(s,".",r)}var f,d,m=u(es),g=u(is),p=l();if("number"==typeof p){if(0===p)return}else n("if(",p,"){"),n.exit("}");v&&(f=u(rs),d=t.instancing);var _=c+".type",y=a.elements&&pa(a.elements)&&!a.vaoActive;function b(){function t(){n(d,".drawElementsInstancedANGLE(",[m,p,_,g+"<<(("+_+"-"+fo+")>>1)",f],");")}function e(){n(d,".drawArraysInstancedANGLE(",[m,g,p,f],");")}c&&"null"!==c?y?t():(n("if(",c,"){"),t(),n("}else{"),e(),n("}")):e()}function w(){function t(){n(o+".drawElements("+[m,p,_,g+"<<(("+_+"-"+fo+")>>1)"]+");")}function e(){n(o+".drawArrays("+[m,g,p]+");")}c&&"null"!==c?y?t():(n("if(",c,"){"),t(),n("}else{"),e(),n("}")):e()}v&&("number"!=typeof f||f>=0)?"string"==typeof f?(n("if(",f,">0){"),b(),n("}else if(",f,"<0){"),w(),n("}")):b():w()}function $(t,e,n,i,r){var o=I(),s=o.proc("body",r);return nt.optional((function(){o.commandStr=e.commandStr,o.command=o.link(e.commandStr)})),v&&(o.instancing=s.def(o.shared.extensions,".angle_instanced_arrays")),t(o,s,n,i),o.compile().body}function tt(t,e,n,i){q(t,e),n.useVAO?n.drawVAO?e(t.shared.vao,".setVAO(",n.drawVAO.append(t,e),");"):e(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(e(t.shared.vao,".setVAO(null);"),K(t,e,n,i.attributes,(function(){return!0}))),J(t,e,n,i.uniforms,(function(){return!0}),!1),Q(t,e,e,n)}function et(t,e){var n=t.proc("draw",1);q(t,n),V(t,n,e.context),W(t,n,e.framebuffer),X(t,n,e),Z(t,n,e.state),Y(t,n,e,!1,!0);var i=e.shader.progVar.append(t,n);if(n(t.shared.gl,".useProgram(",i,".program);"),e.shader.program)tt(t,n,e,e.shader.program);else{n(t.shared.vao,".setVAO(null);");var r=t.global.def("{}"),o=n.def(i,".id"),s=n.def(r,"[",o,"]");n(t.cond(s).then(s,".call(this,a0);").else(s,"=",r,"[",o,"]=",t.link((function(n){return $(tt,t,e,n,1)})),"(",i,");",s,".call(this,a0);"))}Object.keys(e.state).length>0&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}function it(t,e,n,i){function r(){return!0}t.batchId="a1",q(t,e),K(t,e,n,i.attributes,r),J(t,e,n,i.uniforms,r,!1),Q(t,e,e,n)}function rt(t,e,n,i){q(t,e);var r=n.contextDep,o=e.def(),s="a0",a="a1",h=e.def();t.shared.props=h,t.batchId=o;var l=t.scope(),c=t.scope();function u(t){return t.contextDep&&r||t.propDep}function f(t){return!u(t)}if(e(l.entry,"for(",o,"=0;",o,"<",a,";++",o,"){",h,"=",s,"[",o,"];",c,"}",l.exit),n.needsContext&&V(t,c,n.context),n.needsFramebuffer&&W(t,c,n.framebuffer),Z(t,c,n.state,u),n.profile&&u(n.profile)&&Y(t,c,n,!1,!0),i)n.useVAO?n.drawVAO?u(n.drawVAO)?c(t.shared.vao,".setVAO(",n.drawVAO.append(t,c),");"):l(t.shared.vao,".setVAO(",n.drawVAO.append(t,l),");"):l(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(l(t.shared.vao,".setVAO(null);"),K(t,l,n,i.attributes,f),K(t,c,n,i.attributes,u)),J(t,l,n,i.uniforms,f,!1),J(t,c,n,i.uniforms,u,!0),Q(t,l,c,n);else{var d=t.global.def("{}"),m=n.shader.progVar.append(t,c),g=c.def(m,".id"),p=c.def(d,"[",g,"]");c(t.shared.gl,".useProgram(",m,".program);","if(!",p,"){",p,"=",d,"[",g,"]=",t.link((function(e){return $(it,t,n,e,2)})),"(",m,");}",p,".call(this,a0[",o,"],",o,");")}}function ot(t,e){var n=t.proc("batch",2);t.batchId="0",q(t,n);var i=!1,r=!0;Object.keys(e.context).forEach((function(t){i=i||e.context[t].propDep})),i||(V(t,n,e.context),r=!1);var o=e.framebuffer,s=!1;function a(t){return t.contextDep&&i||t.propDep}o?(o.propDep?i=s=!0:o.contextDep&&i&&(s=!0),s||W(t,n,o)):W(t,n,null),e.state.viewport&&e.state.viewport.propDep&&(i=!0),X(t,n,e),Z(t,n,e.state,(function(t){return!a(t)})),e.profile&&a(e.profile)||Y(t,n,e,!1,"a1"),e.contextDep=i,e.needsContext=r,e.needsFramebuffer=s;var h=e.shader.progVar;if(h.contextDep&&i||h.propDep)rt(t,n,e,null);else{var l=h.append(t,n);if(n(t.shared.gl,".useProgram(",l,".program);"),e.shader.program)rt(t,n,e,e.shader.program);else{n(t.shared.vao,".setVAO(null);");var c=t.global.def("{}"),u=n.def(l,".id"),f=n.def(c,"[",u,"]");n(t.cond(f).then(f,".call(this,a0,a1);").else(f,"=",c,"[",u,"]=",t.link((function(n){return $(rt,t,e,n,2)})),"(",l,");",f,".call(this,a0,a1);"))}}Object.keys(e.state).length>0&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}function st(t,e){var i=t.proc("scope",3);t.batchId="a2";var r=t.shared,o=r.current;function s(n){var o=e.shader[n];o&&i.set(r.shader,"."+n,o.append(t,i))}V(t,i,e.context),e.framebuffer&&e.framebuffer.append(t,i),ma(Object.keys(e.state)).forEach((function(n){var o=e.state[n].append(t,i);un(o)?o.forEach((function(e,r){i.set(t.next[n],"["+r+"]",e)})):i.set(r.next,"."+n,o)})),Y(t,i,e,!0,!0),[ts,is,ns,rs,es].forEach((function(n){var o=e.draw[n];o&&i.set(r.draw,"."+n,""+o.append(t,i))})),Object.keys(e.uniforms).forEach((function(o){var s=e.uniforms[o].append(t,i);Array.isArray(s)&&(s="["+s.join()+"]"),i.set(r.uniforms,"["+n.id(o)+"]",s)})),Object.keys(e.attributes).forEach((function(n){var r=e.attributes[n].append(t,i),o=t.scopeAttrib(n);Object.keys(new p).forEach((function(t){i.set(o,"."+t,r[t])}))})),e.scopeVAO&&i.set(r.vao,".targetVAO",e.scopeVAO.append(t,i)),s(Qo),s($o),Object.keys(e.state).length>0&&(i(o,".dirty=true;"),i.exit(o,".dirty=true;")),i("a1(",t.shared.context,",a0,",t.batchId,");")}function at(t){if("object"==typeof t&&!un(t)){for(var e=Object.keys(t),n=0;n<e.length;++n)if(mt.isDynamic(t[e[n]]))return!0;return!1}}function ht(t,e,n){var i=e.static[n];if(i&&at(i)){var r=t.global,o=Object.keys(i),s=!1,a=!1,h=!1,l=t.global.def("{}");o.forEach((function(e){var n=i[e];if(mt.isDynamic(n)){"function"==typeof n&&(n=i[e]=mt.unbox(n));var o=va(n,null);s=s||o.thisDep,h=h||o.propDep,a=a||o.contextDep}else{switch(r(l,".",e,"="),typeof n){case"number":r(n);break;case"string":r('"',n,'"');break;case"object":Array.isArray(n)&&r("[",n.join(),"]");break;default:r(t.link(n))}r(";")}})),e.dynamic[n]=new mt.DynamicVariable(xo,{thisDep:s,contextDep:a,propDep:h,ref:l,append:c}),delete e.static[n]}function c(t,e){o.forEach((function(n){var r=i[n];if(mt.isDynamic(r)){var o=t.invoke(e,r);e(l,".",n,"=",o,";")}}))}}function lt(t,n,i,r,o){var s=I();s.stats=s.link(o),Object.keys(n.static).forEach((function(t){ht(s,n,t)})),gs.forEach((function(e){ht(s,t,e)}));var a=U(t,n,i,r,s);return et(s,a),st(s,a),ot(s,a),e(s.compile(),{destroy:function(){a.shader.program.destroy()}})}return{next:w,current:b,procs:function(){var t=I(),e=t.proc("poll"),n=t.proc("refresh"),o=t.block();e(o),n(o);var s,a=t.shared,h=a.gl,l=a.next,c=a.current;o(c,".dirty=false;"),W(t,e),W(t,n,null,!0),v&&(s=t.link(v)),i.oes_vertex_array_object&&n(t.link(i.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var u=0;u<r.maxAttributes;++u){var f=n.def(a.attributes,"[",u,"]"),d=t.cond(f,".buffer");d.then(h,".enableVertexAttribArray(",u,");",h,".bindBuffer(",ps,",",f,".buffer.buffer);",h,".vertexAttribPointer(",u,",",f,".size,",f,".type,",f,".normalized,",f,".stride,",f,".offset);").else(h,".disableVertexAttribArray(",u,");",h,".vertexAttrib4f(",u,",",f,".x,",f,".y,",f,".z,",f,".w);",f,".buffer=null;"),n(d),v&&n(s,".vertexAttribDivisorANGLE(",u,",",f,".divisor);")}return n(t.shared.vao,".currentVAO=null;",t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"),Object.keys(M).forEach((function(i){var r=M[i],s=o.def(l,".",i),a=t.block();a("if(",s,"){",h,".enable(",r,")}else{",h,".disable(",r,")}",c,".",i,"=",s,";"),n(a),e("if(",s,"!==",c,".",i,"){",a,"}")})),Object.keys(A).forEach((function(i){var r,s,a=A[i],u=b[i],f=t.block();if(f(h,".",a,"("),un(u)){var d=u.length;r=t.global.def(l,".",i),s=t.global.def(c,".",i),f(Et(d,(function(t){return r+"["+t+"]"})),");",Et(d,(function(t){return s+"["+t+"]="+r+"["+t+"];"})).join("")),e("if(",Et(d,(function(t){return r+"["+t+"]!=="+s+"["+t+"]"})).join("||"),"){",f,"}")}else r=o.def(l,".",i),s=o.def(c,".",i),f(r,");",c,".",i,"=",r,";"),e("if(",r,"!==",s,"){",f,"}");n(f)})),t.compile()}(),compile:lt}}function ba(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var wa=34918,Ta=34919,Ma=35007,Aa=function(t,e){if(!e.ext_disjoint_timer_query)return null;var n=[];function i(){return n.pop()||e.ext_disjoint_timer_query.createQueryEXT()}function r(t){n.push(t)}var o=[];function s(t){var n=i();e.ext_disjoint_timer_query.beginQueryEXT(Ma,n),o.push(n),d(o.length-1,o.length,t)}function a(){e.ext_disjoint_timer_query.endQueryEXT(Ma)}function h(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var l=[];function c(){return l.pop()||new h}function u(t){l.push(t)}var f=[];function d(t,e,n){var i=c();i.startQueryIndex=t,i.endQueryIndex=e,i.sum=0,i.stats=n,f.push(i)}var m=[],g=[];function p(){var t,n,i=o.length;if(0!==i){g.length=Math.max(g.length,i+1),m.length=Math.max(m.length,i+1),m[0]=0,g[0]=0;var s=0;for(t=0,n=0;n<o.length;++n){var a=o[n];e.ext_disjoint_timer_query.getQueryObjectEXT(a,Ta)?(s+=e.ext_disjoint_timer_query.getQueryObjectEXT(a,wa),r(a)):o[t++]=a,m[n+1]=s,g[n+1]=t}for(o.length=t,t=0,n=0;n<f.length;++n){var h=f[n],l=h.startQueryIndex,c=h.endQueryIndex;h.sum+=m[c]-m[l];var d=g[l],p=g[c];p===d?(h.stats.gpuTime+=h.sum/1e6,u(h)):(h.startQueryIndex=d,h.endQueryIndex=p,f[t++]=h)}f.length=t}}return{beginQuery:s,endQuery:a,pushScopeStats:d,update:p,getNumPendingQueries:function(){return o.length},clear:function(){n.push.apply(n,o);for(var t=0;t<n.length;t++)e.ext_disjoint_timer_query.deleteQueryEXT(n[t]);o.length=0,n.length=0},restore:function(){o.length=0,n.length=0}}},Ea=16384,Ca=256,Sa=1024,Pa=34962,Ra="webglcontextlost",Oa="webglcontextrestored",Ia=1,Da=2,ka=3;function La(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return n;return-1}function Fa(t){var n=Mt(t);if(!n)return null;var i=n.gl,r=i.getContextAttributes(),o=i.isContextLost(),s=At(i,n);if(!s)return null;var a=_t(),h=ba(),l=s.extensions,c=Aa(i,l),u=pt(),f=i.drawingBufferWidth,d=i.drawingBufferHeight,m={tick:0,time:0,viewportWidth:f,viewportHeight:d,framebufferWidth:f,framebufferHeight:d,drawingBufferWidth:f,drawingBufferHeight:d,pixelRatio:n.pixelRatio},g={},p={elements:null,primitive:4,count:-1,offset:0,instances:-1},_=we(i,l),v=We(i,h,n,b),y=sn(i,l,v,h),x=Jr(i,l,_,h,v,y,p);function b(t){return x.destroyBuffer(t)}var w=no(i,a,h,n),T=Yi(i,l,_,(function(){E.procs.poll()}),m,h,n),M=ur(i,l,_,h,n),A=Wr(i,l,_,T,M,h),E=xa(i,a,l,_,v,y,T,A,g,x,w,p,m,c,n),C=ao(i,A,E.procs.poll,m,r,l,_),S=E.next,P=i.canvas,R=[],O=[],I=[],D=[n.onDestroy],k=null;function L(){if(0===R.length)return c&&c.update(),void(k=null);k=gt.next(L),Z();for(var t=R.length-1;t>=0;--t){var e=R[t];e&&e(m,null,0)}i.flush(),c&&c.update()}function F(){!k&&R.length>0&&(k=gt.next(L))}function N(){k&&(gt.cancel(L),k=null)}function B(t){t.preventDefault(),o=!0,N(),O.forEach((function(t){t()}))}function H(t){i.getError(),o=!1,s.restore(),w.restore(),v.restore(),T.restore(),M.restore(),A.restore(),x.restore(),c&&c.restore(),E.procs.refresh(),F(),I.forEach((function(t){t()}))}function j(){R.length=0,N(),P&&(P.removeEventListener(Ra,B),P.removeEventListener(Oa,H)),w.clear(),A.clear(),M.clear(),x.clear(),T.clear(),y.clear(),v.clear(),c&&c.clear(),D.forEach((function(t){t()}))}function z(t){function n(t){var n=e({},t);function i(t){if(t in n){var e=n[t];delete n[t],Object.keys(e).forEach((function(i){n[t+"."+i]=e[i]}))}}return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),i("blend"),i("depth"),i("cull"),i("stencil"),i("polygonOffset"),i("scissor"),i("sample"),"vao"in t&&(n.vao=t.vao),n}function i(t,e){var n={},i={};return Object.keys(t).forEach((function(r){var o=t[r];if(mt.isDynamic(o))i[r]=mt.unbox(o,r);else{if(e&&Array.isArray(o))for(var s=0;s<o.length;++s)if(mt.isDynamic(o[s]))return void(i[r]=mt.unbox(o,r));n[r]=o}})),{dynamic:i,static:n}}nt(!!t,"invalid args to regl({...})"),nt.type(t,"object","invalid args to regl({...})");var r=i(t.context||{},!0),s=i(t.uniforms||{},!0),a=i(t.attributes||{},!1),h=i(n(t),!1),l={gpuTime:0,cpuTime:0,count:0},c=E.compile(h,a,s,r,l),u=c.draw,f=c.batch,d=c.scope,m=[];function g(t){for(;m.length<t;)m.push(null);return m}function p(t,e){var n;if(o&&nt.raise("context lost"),"function"==typeof t)return d.call(this,null,t,0);if("function"==typeof e)if("number"==typeof t)for(n=0;n<t;++n)d.call(this,null,e,n);else{if(!Array.isArray(t))return d.call(this,t,e,0);for(n=0;n<t.length;++n)d.call(this,t[n],e,n)}else if("number"==typeof t){if(t>0)return f.call(this,g(0|t),0|t)}else{if(!Array.isArray(t))return u.call(this,t);if(t.length)return f.call(this,t,t.length)}}return e(p,{stats:l,destroy:function(){c.destroy()}})}P&&(P.addEventListener(Ra,B,!1),P.addEventListener(Oa,H,!1));var G=A.setFBO=z({framebuffer:mt.define.call(null,Ia,"framebuffer")});function U(t,e){var n=0;E.procs.poll();var r=e.color;r&&(i.clearColor(+r[0]||0,+r[1]||0,+r[2]||0,+r[3]||0),n|=Ea),"depth"in e&&(i.clearDepth(+e.depth),n|=Ca),"stencil"in e&&(i.clearStencil(0|e.stencil),n|=Sa),nt(!!n,"called regl.clear with no buffer specified"),i.clear(n)}function V(t){if(nt("object"==typeof t&&t,"regl.clear() takes an object as input"),"framebuffer"in t)if(t.framebuffer&&"framebufferCube"===t.framebuffer_reglType)for(var n=0;n<6;++n)G(e({framebuffer:t.framebuffer.faces[n]},t),U);else G(t,U);else U(null,t)}function W(t){function e(){var e=La(R,t);function n(){var t=La(R,n);R[t]=R[R.length-1],R.length-=1,R.length<=0&&N()}nt(e>=0,"cannot cancel a frame twice"),R[e]=n}return nt.type(t,"function","regl.frame() callback must be a function"),R.push(t),F(),{cancel:e}}function X(){var t=S.viewport,e=S.scissor_box;t[0]=t[1]=e[0]=e[1]=0,m.viewportWidth=m.framebufferWidth=m.drawingBufferWidth=t[2]=e[2]=i.drawingBufferWidth,m.viewportHeight=m.framebufferHeight=m.drawingBufferHeight=t[3]=e[3]=i.drawingBufferHeight}function Z(){m.tick+=1,m.time=Y(),X(),E.procs.poll()}function q(){T.refresh(),X(),E.procs.refresh(),c&&c.update()}function Y(){return(pt()-u)/1e3}function K(t,e){var n;switch(nt.type(e,"function","listener callback must be a function"),t){case"frame":return W(e);case"lost":n=O;break;case"restore":n=I;break;case"destroy":n=D;break;default:nt.raise("invalid event, must be one of frame,lost,restore,destroy")}return n.push(e),{cancel:function(){for(var t=0;t<n.length;++t)if(n[t]===e)return n[t]=n[n.length-1],void n.pop()}}}q();var J=e(z,{clear:V,prop:mt.define.bind(null,Ia),context:mt.define.bind(null,Da),this:mt.define.bind(null,ka),draw:z({}),buffer:function(t){return v.create(t,Pa,!1,!1)},elements:function(t){return y.create(t,!1)},texture:T.create2D,cube:T.createCube,renderbuffer:M.create,framebuffer:A.create,framebufferCube:A.createCube,vao:x.createVAO,attributes:r,frame:W,on:K,limits:_,hasExtension:function(t){return _.extensions.indexOf(t.toLowerCase())>=0},read:C,destroy:j,_gl:i,_refresh:q,poll:function(){Z(),c&&c.update()},now:Y,stats:h,blit:A.blit});return n.onDone(null,J),J}return Fa}));var a=s.exports,h=1e-6,l="undefined"!=typeof Float32Array?Float32Array:Array,c=Math.random;function u(t){l=t}var f=Math.PI/180;function d(t){return t*f}function m(t,e){return Math.abs(t-e)<=h*Math.max(1,Math.abs(t),Math.abs(e))}var g=Object.freeze({__proto__:null,EPSILON:h,get ARRAY_TYPE(){return l},RANDOM:c,setMatrixArrayType:u,toRadian:d,equals:m});function p(){var t=new l(4);return l!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t}function _(t){var e=new l(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function v(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function y(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function x(t,e,n,i){var r=new l(4);return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r}function b(t,e,n,i,r){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t}function w(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function T(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=n*o-r*i;return s?(s=1/s,t[0]=o*s,t[1]=-i*s,t[2]=-r*s,t[3]=n*s,t):null}function M(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t}function A(t){return t[0]*t[3]-t[2]*t[1]}function E(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=n[0],h=n[1],l=n[2],c=n[3];return t[0]=i*a+o*h,t[1]=r*a+s*h,t[2]=i*l+o*c,t[3]=r*l+s*c,t}function C(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=Math.sin(n),h=Math.cos(n);return t[0]=i*h+o*a,t[1]=r*h+s*a,t[2]=i*-a+o*h,t[3]=r*-a+s*h,t}function S(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=n[0],h=n[1];return t[0]=i*a,t[1]=r*a,t[2]=o*h,t[3]=s*h,t}function P(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=-n,t[3]=i,t}function R(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function O(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function I(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))}function D(t,e,n,i){return t[2]=i[2]/i[0],n[0]=i[0],n[1]=i[1],n[3]=i[3]-t[2]*n[1],[t,e,n]}function k(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function L(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function F(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function N(t,e){var n=t[0],i=t[1],r=t[2],o=t[3],s=e[0],a=e[1],l=e[2],c=e[3];return Math.abs(n-s)<=h*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-l)<=h*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(o-c)<=h*Math.max(1,Math.abs(o),Math.abs(c))}function B(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function H(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t}var j=E,z=L,G=Object.freeze({__proto__:null,create:p,clone:_,copy:v,identity:y,fromValues:x,set:b,transpose:w,invert:T,adjoint:M,determinant:A,multiply:E,rotate:C,scale:S,fromRotation:P,fromScaling:R,str:O,frob:I,LDU:D,add:k,subtract:L,exactEquals:F,equals:N,multiplyScalar:B,multiplyScalarAndAdd:H,mul:j,sub:z});function U(){var t=new l(6);return l!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t}function V(t){var e=new l(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function W(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function X(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function Z(t,e,n,i,r,o){var s=new l(6);return s[0]=t,s[1]=e,s[2]=n,s[3]=i,s[4]=r,s[5]=o,s}function q(t,e,n,i,r,o,s){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=o,t[5]=s,t}function Y(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=n*o-i*r;return h?(h=1/h,t[0]=o*h,t[1]=-i*h,t[2]=-r*h,t[3]=n*h,t[4]=(r*a-o*s)*h,t[5]=(i*s-n*a)*h,t):null}function K(t){return t[0]*t[3]-t[1]*t[2]}function J(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=n[0],c=n[1],u=n[2],f=n[3],d=n[4],m=n[5];return t[0]=i*l+o*c,t[1]=r*l+s*c,t[2]=i*u+o*f,t[3]=r*u+s*f,t[4]=i*d+o*m+a,t[5]=r*d+s*m+h,t}function Q(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=Math.sin(n),c=Math.cos(n);return t[0]=i*c+o*l,t[1]=r*c+s*l,t[2]=i*-l+o*c,t[3]=r*-l+s*c,t[4]=a,t[5]=h,t}function $(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=n[0],c=n[1];return t[0]=i*l,t[1]=r*l,t[2]=o*c,t[3]=s*c,t[4]=a,t[5]=h,t}function tt(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=n[0],c=n[1];return t[0]=i,t[1]=r,t[2]=o,t[3]=s,t[4]=i*l+o*c+a,t[5]=r*l+s*c+h,t}function et(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=-n,t[3]=i,t[4]=0,t[5]=0,t}function nt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function it(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function rt(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function ot(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)}function st(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t}function at(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t}function ht(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t}function lt(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t}function ct(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function ut(t,e){var n=t[0],i=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=e[0],c=e[1],u=e[2],f=e[3],d=e[4],m=e[5];return Math.abs(n-l)<=h*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(i-c)<=h*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(r-u)<=h*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(o-f)<=h*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(s-d)<=h*Math.max(1,Math.abs(s),Math.abs(d))&&Math.abs(a-m)<=h*Math.max(1,Math.abs(a),Math.abs(m))}var ft=J,dt=at,mt=Object.freeze({__proto__:null,create:U,clone:V,copy:W,identity:X,fromValues:Z,set:q,invert:Y,determinant:K,multiply:J,rotate:Q,scale:$,translate:tt,fromRotation:et,fromScaling:nt,fromTranslation:it,str:rt,frob:ot,add:st,subtract:at,multiplyScalar:ht,multiplyScalarAndAdd:lt,exactEquals:ct,equals:ut,mul:ft,sub:dt});function gt(){var t=new l(9);return l!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function pt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function _t(t){var e=new l(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function vt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function yt(t,e,n,i,r,o,s,a,h){var c=new l(9);return c[0]=t,c[1]=e,c[2]=n,c[3]=i,c[4]=r,c[5]=o,c[6]=s,c[7]=a,c[8]=h,c}function xt(t,e,n,i,r,o,s,a,h,l){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=o,t[5]=s,t[6]=a,t[7]=h,t[8]=l,t}function bt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function wt(t,e){if(t===e){var n=e[1],i=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=i,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function Tt(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=c*s-a*l,f=-c*o+a*h,d=l*o-s*h,m=n*u+i*f+r*d;return m?(m=1/m,t[0]=u*m,t[1]=(-c*i+r*l)*m,t[2]=(a*i-r*s)*m,t[3]=f*m,t[4]=(c*n-r*h)*m,t[5]=(-a*n+r*o)*m,t[6]=d*m,t[7]=(-l*n+i*h)*m,t[8]=(s*n-i*o)*m,t):null}function Mt(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=e[8];return t[0]=s*c-a*l,t[1]=r*l-i*c,t[2]=i*a-r*s,t[3]=a*h-o*c,t[4]=n*c-r*h,t[5]=r*o-n*a,t[6]=o*l-s*h,t[7]=i*h-n*l,t[8]=n*s-i*o,t}function At(t){var e=t[0],n=t[1],i=t[2],r=t[3],o=t[4],s=t[5],a=t[6],h=t[7],l=t[8];return e*(l*o-s*h)+n*(-l*r+s*a)+i*(h*r-o*a)}function Et(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],f=n[0],d=n[1],m=n[2],g=n[3],p=n[4],_=n[5],v=n[6],y=n[7],x=n[8];return t[0]=f*i+d*s+m*l,t[1]=f*r+d*a+m*c,t[2]=f*o+d*h+m*u,t[3]=g*i+p*s+_*l,t[4]=g*r+p*a+_*c,t[5]=g*o+p*h+_*u,t[6]=v*i+y*s+x*l,t[7]=v*r+y*a+x*c,t[8]=v*o+y*h+x*u,t}function Ct(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],f=n[0],d=n[1];return t[0]=i,t[1]=r,t[2]=o,t[3]=s,t[4]=a,t[5]=h,t[6]=f*i+d*s+l,t[7]=f*r+d*a+c,t[8]=f*o+d*h+u,t}function St(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],f=Math.sin(n),d=Math.cos(n);return t[0]=d*i+f*s,t[1]=d*r+f*a,t[2]=d*o+f*h,t[3]=d*s-f*i,t[4]=d*a-f*r,t[5]=d*h-f*o,t[6]=l,t[7]=c,t[8]=u,t}function Pt(t,e,n){var i=n[0],r=n[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function Rt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function Ot(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=-n,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function It(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Dt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function kt(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=n+n,a=i+i,h=r+r,l=n*s,c=i*s,u=i*a,f=r*s,d=r*a,m=r*h,g=o*s,p=o*a,_=o*h;return t[0]=1-u-m,t[3]=c-_,t[6]=f+p,t[1]=c+_,t[4]=1-l-m,t[7]=d-g,t[2]=f-p,t[5]=d+g,t[8]=1-l-u,t}function Lt(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],f=e[10],d=e[11],m=e[12],g=e[13],p=e[14],_=e[15],v=n*a-i*s,y=n*h-r*s,x=n*l-o*s,b=i*h-r*a,w=i*l-o*a,T=r*l-o*h,M=c*g-u*m,A=c*p-f*m,E=c*_-d*m,C=u*p-f*g,S=u*_-d*g,P=f*_-d*p,R=v*P-y*S+x*C+b*E-w*A+T*M;return R?(R=1/R,t[0]=(a*P-h*S+l*C)*R,t[1]=(h*E-s*P-l*A)*R,t[2]=(s*S-a*E+l*M)*R,t[3]=(r*S-i*P-o*C)*R,t[4]=(n*P-r*E+o*A)*R,t[5]=(i*E-n*S-o*M)*R,t[6]=(g*T-p*w+_*b)*R,t[7]=(p*x-m*T-_*y)*R,t[8]=(m*w-g*x+_*v)*R,t):null}function Ft(t,e,n){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/n,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function Nt(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function Bt(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))}function Ht(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t}function jt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}function zt(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t}function Gt(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t[6]=e[6]+n[6]*i,t[7]=e[7]+n[7]*i,t[8]=e[8]+n[8]*i,t}function Ut(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function Vt(t,e){var n=t[0],i=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],f=e[0],d=e[1],m=e[2],g=e[3],p=e[4],_=e[5],v=e[6],y=e[7],x=e[8];return Math.abs(n-f)<=h*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(i-d)<=h*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(r-m)<=h*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(o-g)<=h*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(s-p)<=h*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(a-_)<=h*Math.max(1,Math.abs(a),Math.abs(_))&&Math.abs(l-v)<=h*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(c-y)<=h*Math.max(1,Math.abs(c),Math.abs(y))&&Math.abs(u-x)<=h*Math.max(1,Math.abs(u),Math.abs(x))}var Wt=Et,Xt=jt,Zt=Object.freeze({__proto__:null,create:gt,fromMat4:pt,clone:_t,copy:vt,fromValues:yt,set:xt,identity:bt,transpose:wt,invert:Tt,adjoint:Mt,determinant:At,multiply:Et,translate:Ct,rotate:St,scale:Pt,fromTranslation:Rt,fromRotation:Ot,fromScaling:It,fromMat2d:Dt,fromQuat:kt,normalFromMat4:Lt,projection:Ft,str:Nt,frob:Bt,add:Ht,subtract:jt,multiplyScalar:zt,multiplyScalarAndAdd:Gt,exactEquals:Ut,equals:Vt,mul:Wt,sub:Xt});function qt(){var t=new l(16);return l!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Yt(t){var e=new l(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Kt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Jt(t,e,n,i,r,o,s,a,h,c,u,f,d,m,g,p){var _=new l(16);return _[0]=t,_[1]=e,_[2]=n,_[3]=i,_[4]=r,_[5]=o,_[6]=s,_[7]=a,_[8]=h,_[9]=c,_[10]=u,_[11]=f,_[12]=d,_[13]=m,_[14]=g,_[15]=p,_}function Qt(t,e,n,i,r,o,s,a,h,l,c,u,f,d,m,g,p){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=o,t[5]=s,t[6]=a,t[7]=h,t[8]=l,t[9]=c,t[10]=u,t[11]=f,t[12]=d,t[13]=m,t[14]=g,t[15]=p,t}function $t(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function te(t,e){if(t===e){var n=e[1],i=e[2],r=e[3],o=e[6],s=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=o,t[11]=e[14],t[12]=r,t[13]=s,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function ee(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],f=e[10],d=e[11],m=e[12],g=e[13],p=e[14],_=e[15],v=n*a-i*s,y=n*h-r*s,x=n*l-o*s,b=i*h-r*a,w=i*l-o*a,T=r*l-o*h,M=c*g-u*m,A=c*p-f*m,E=c*_-d*m,C=u*p-f*g,S=u*_-d*g,P=f*_-d*p,R=v*P-y*S+x*C+b*E-w*A+T*M;return R?(R=1/R,t[0]=(a*P-h*S+l*C)*R,t[1]=(r*S-i*P-o*C)*R,t[2]=(g*T-p*w+_*b)*R,t[3]=(f*w-u*T-d*b)*R,t[4]=(h*E-s*P-l*A)*R,t[5]=(n*P-r*E+o*A)*R,t[6]=(p*x-m*T-_*y)*R,t[7]=(c*T-f*x+d*y)*R,t[8]=(s*S-a*E+l*M)*R,t[9]=(i*E-n*S-o*M)*R,t[10]=(m*w-g*x+_*v)*R,t[11]=(u*x-c*w-d*v)*R,t[12]=(a*A-s*C-h*M)*R,t[13]=(n*C-i*A+r*M)*R,t[14]=(g*y-m*b-p*v)*R,t[15]=(c*b-u*y+f*v)*R,t):null}function ne(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],f=e[10],d=e[11],m=e[12],g=e[13],p=e[14],_=e[15];return t[0]=a*(f*_-d*p)-u*(h*_-l*p)+g*(h*d-l*f),t[1]=-(i*(f*_-d*p)-u*(r*_-o*p)+g*(r*d-o*f)),t[2]=i*(h*_-l*p)-a*(r*_-o*p)+g*(r*l-o*h),t[3]=-(i*(h*d-l*f)-a*(r*d-o*f)+u*(r*l-o*h)),t[4]=-(s*(f*_-d*p)-c*(h*_-l*p)+m*(h*d-l*f)),t[5]=n*(f*_-d*p)-c*(r*_-o*p)+m*(r*d-o*f),t[6]=-(n*(h*_-l*p)-s*(r*_-o*p)+m*(r*l-o*h)),t[7]=n*(h*d-l*f)-s*(r*d-o*f)+c*(r*l-o*h),t[8]=s*(u*_-d*g)-c*(a*_-l*g)+m*(a*d-l*u),t[9]=-(n*(u*_-d*g)-c*(i*_-o*g)+m*(i*d-o*u)),t[10]=n*(a*_-l*g)-s*(i*_-o*g)+m*(i*l-o*a),t[11]=-(n*(a*d-l*u)-s*(i*d-o*u)+c*(i*l-o*a)),t[12]=-(s*(u*p-f*g)-c*(a*p-h*g)+m*(a*f-h*u)),t[13]=n*(u*p-f*g)-c*(i*p-r*g)+m*(i*f-r*u),t[14]=-(n*(a*p-h*g)-s*(i*p-r*g)+m*(i*h-r*a)),t[15]=n*(a*f-h*u)-s*(i*f-r*u)+c*(i*h-r*a),t}function ie(t){var e=t[0],n=t[1],i=t[2],r=t[3],o=t[4],s=t[5],a=t[6],h=t[7],l=t[8],c=t[9],u=t[10],f=t[11],d=t[12],m=t[13],g=t[14],p=t[15];return(e*s-n*o)*(u*p-f*g)-(e*a-i*o)*(c*p-f*m)+(e*h-r*o)*(c*g-u*m)+(n*a-i*s)*(l*p-f*d)-(n*h-r*s)*(l*g-u*d)+(i*h-r*a)*(l*m-c*d)}function re(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],f=e[9],d=e[10],m=e[11],g=e[12],p=e[13],_=e[14],v=e[15],y=n[0],x=n[1],b=n[2],w=n[3];return t[0]=y*i+x*a+b*u+w*g,t[1]=y*r+x*h+b*f+w*p,t[2]=y*o+x*l+b*d+w*_,t[3]=y*s+x*c+b*m+w*v,y=n[4],x=n[5],b=n[6],w=n[7],t[4]=y*i+x*a+b*u+w*g,t[5]=y*r+x*h+b*f+w*p,t[6]=y*o+x*l+b*d+w*_,t[7]=y*s+x*c+b*m+w*v,y=n[8],x=n[9],b=n[10],w=n[11],t[8]=y*i+x*a+b*u+w*g,t[9]=y*r+x*h+b*f+w*p,t[10]=y*o+x*l+b*d+w*_,t[11]=y*s+x*c+b*m+w*v,y=n[12],x=n[13],b=n[14],w=n[15],t[12]=y*i+x*a+b*u+w*g,t[13]=y*r+x*h+b*f+w*p,t[14]=y*o+x*l+b*d+w*_,t[15]=y*s+x*c+b*m+w*v,t}function oe(t,e,n){var i=n[0],r=n[1],o=n[2],s=void 0,a=void 0,h=void 0,l=void 0,c=void 0,u=void 0,f=void 0,d=void 0,m=void 0,g=void 0,p=void 0,_=void 0;return e===t?(t[12]=e[0]*i+e[4]*r+e[8]*o+e[12],t[13]=e[1]*i+e[5]*r+e[9]*o+e[13],t[14]=e[2]*i+e[6]*r+e[10]*o+e[14],t[15]=e[3]*i+e[7]*r+e[11]*o+e[15]):(s=e[0],a=e[1],h=e[2],l=e[3],c=e[4],u=e[5],f=e[6],d=e[7],m=e[8],g=e[9],p=e[10],_=e[11],t[0]=s,t[1]=a,t[2]=h,t[3]=l,t[4]=c,t[5]=u,t[6]=f,t[7]=d,t[8]=m,t[9]=g,t[10]=p,t[11]=_,t[12]=s*i+c*r+m*o+e[12],t[13]=a*i+u*r+g*o+e[13],t[14]=h*i+f*r+p*o+e[14],t[15]=l*i+d*r+_*o+e[15]),t}function se(t,e,n){var i=n[0],r=n[1],o=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ae(t,e,n,i){var r=i[0],o=i[1],s=i[2],a=Math.sqrt(r*r+o*o+s*s),l=void 0,c=void 0,u=void 0,f=void 0,d=void 0,m=void 0,g=void 0,p=void 0,_=void 0,v=void 0,y=void 0,x=void 0,b=void 0,w=void 0,T=void 0,M=void 0,A=void 0,E=void 0,C=void 0,S=void 0,P=void 0,R=void 0,O=void 0,I=void 0;return a<h?null:(r*=a=1/a,o*=a,s*=a,l=Math.sin(n),u=1-(c=Math.cos(n)),f=e[0],d=e[1],m=e[2],g=e[3],p=e[4],_=e[5],v=e[6],y=e[7],x=e[8],b=e[9],w=e[10],T=e[11],M=r*r*u+c,A=o*r*u+s*l,E=s*r*u-o*l,C=r*o*u-s*l,S=o*o*u+c,P=s*o*u+r*l,R=r*s*u+o*l,O=o*s*u-r*l,I=s*s*u+c,t[0]=f*M+p*A+x*E,t[1]=d*M+_*A+b*E,t[2]=m*M+v*A+w*E,t[3]=g*M+y*A+T*E,t[4]=f*C+p*S+x*P,t[5]=d*C+_*S+b*P,t[6]=m*C+v*S+w*P,t[7]=g*C+y*S+T*P,t[8]=f*R+p*O+x*I,t[9]=d*R+_*O+b*I,t[10]=m*R+v*O+w*I,t[11]=g*R+y*O+T*I,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function he(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e[4],s=e[5],a=e[6],h=e[7],l=e[8],c=e[9],u=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*r+l*i,t[5]=s*r+c*i,t[6]=a*r+u*i,t[7]=h*r+f*i,t[8]=l*r-o*i,t[9]=c*r-s*i,t[10]=u*r-a*i,t[11]=f*r-h*i,t}function le(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e[0],s=e[1],a=e[2],h=e[3],l=e[8],c=e[9],u=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r-l*i,t[1]=s*r-c*i,t[2]=a*r-u*i,t[3]=h*r-f*i,t[8]=o*i+l*r,t[9]=s*i+c*r,t[10]=a*i+u*r,t[11]=h*i+f*r,t}function ce(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e[0],s=e[1],a=e[2],h=e[3],l=e[4],c=e[5],u=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r+l*i,t[1]=s*r+c*i,t[2]=a*r+u*i,t[3]=h*r+f*i,t[4]=l*r-o*i,t[5]=c*r-s*i,t[6]=u*r-a*i,t[7]=f*r-h*i,t}function ue(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function fe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function de(t,e,n){var i=n[0],r=n[1],o=n[2],s=Math.sqrt(i*i+r*r+o*o),a=void 0,l=void 0,c=void 0;return s<h?null:(i*=s=1/s,r*=s,o*=s,a=Math.sin(e),c=1-(l=Math.cos(e)),t[0]=i*i*c+l,t[1]=r*i*c+o*a,t[2]=o*i*c-r*a,t[3]=0,t[4]=i*r*c-o*a,t[5]=r*r*c+l,t[6]=o*r*c+i*a,t[7]=0,t[8]=i*o*c+r*a,t[9]=r*o*c-i*a,t[10]=o*o*c+l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function me(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ge(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function pe(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function _e(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=i+i,h=r+r,l=o+o,c=i*a,u=i*h,f=i*l,d=r*h,m=r*l,g=o*l,p=s*a,_=s*h,v=s*l;return t[0]=1-(d+g),t[1]=u+v,t[2]=f-_,t[3]=0,t[4]=u-v,t[5]=1-(c+g),t[6]=m+p,t[7]=0,t[8]=f+_,t[9]=m-p,t[10]=1-(c+d),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function ve(t,e){var n=new l(3),i=-e[0],r=-e[1],o=-e[2],s=e[3],a=e[4],h=e[5],c=e[6],u=e[7],f=i*i+r*r+o*o+s*s;return f>0?(n[0]=2*(a*s+u*i+h*o-c*r)/f,n[1]=2*(h*s+u*r+c*i-a*o)/f,n[2]=2*(c*s+u*o+a*r-h*i)/f):(n[0]=2*(a*s+u*i+h*o-c*r),n[1]=2*(h*s+u*r+c*i-a*o),n[2]=2*(c*s+u*o+a*r-h*i)),_e(t,e,n),t}function ye(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function xe(t,e){var n=e[0],i=e[1],r=e[2],o=e[4],s=e[5],a=e[6],h=e[8],l=e[9],c=e[10];return t[0]=Math.sqrt(n*n+i*i+r*r),t[1]=Math.sqrt(o*o+s*s+a*a),t[2]=Math.sqrt(h*h+l*l+c*c),t}function be(t,e){var n=e[0]+e[5]+e[10],i=0;return n>0?(i=2*Math.sqrt(n+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i),t}function we(t,e,n,i){var r=e[0],o=e[1],s=e[2],a=e[3],h=r+r,l=o+o,c=s+s,u=r*h,f=r*l,d=r*c,m=o*l,g=o*c,p=s*c,_=a*h,v=a*l,y=a*c,x=i[0],b=i[1],w=i[2];return t[0]=(1-(m+p))*x,t[1]=(f+y)*x,t[2]=(d-v)*x,t[3]=0,t[4]=(f-y)*b,t[5]=(1-(u+p))*b,t[6]=(g+_)*b,t[7]=0,t[8]=(d+v)*w,t[9]=(g-_)*w,t[10]=(1-(u+m))*w,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Te(t,e,n,i,r){var o=e[0],s=e[1],a=e[2],h=e[3],l=o+o,c=s+s,u=a+a,f=o*l,d=o*c,m=o*u,g=s*c,p=s*u,_=a*u,v=h*l,y=h*c,x=h*u,b=i[0],w=i[1],T=i[2],M=r[0],A=r[1],E=r[2],C=(1-(g+_))*b,S=(d+x)*b,P=(m-y)*b,R=(d-x)*w,O=(1-(f+_))*w,I=(p+v)*w,D=(m+y)*T,k=(p-v)*T,L=(1-(f+g))*T;return t[0]=C,t[1]=S,t[2]=P,t[3]=0,t[4]=R,t[5]=O,t[6]=I,t[7]=0,t[8]=D,t[9]=k,t[10]=L,t[11]=0,t[12]=n[0]+M-(C*M+R*A+D*E),t[13]=n[1]+A-(S*M+O*A+k*E),t[14]=n[2]+E-(P*M+I*A+L*E),t[15]=1,t}function Me(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=n+n,a=i+i,h=r+r,l=n*s,c=i*s,u=i*a,f=r*s,d=r*a,m=r*h,g=o*s,p=o*a,_=o*h;return t[0]=1-u-m,t[1]=c+_,t[2]=f-p,t[3]=0,t[4]=c-_,t[5]=1-l-m,t[6]=d+g,t[7]=0,t[8]=f+p,t[9]=d-g,t[10]=1-l-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ae(t,e,n,i,r,o,s){var a=1/(n-e),h=1/(r-i),l=1/(o-s);return t[0]=2*o*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*h,t[6]=0,t[7]=0,t[8]=(n+e)*a,t[9]=(r+i)*h,t[10]=(s+o)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=s*o*2*l,t[15]=0,t}function Ee(t,e,n,i,r){var o=1/Math.tan(e/2),s=void 0;return t[0]=o/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(s=1/(i-r),t[10]=(r+i)*s,t[14]=2*r*i*s):(t[10]=-1,t[14]=-2*i),t}function Ce(t,e,n,i){var r=Math.tan(e.upDegrees*Math.PI/180),o=Math.tan(e.downDegrees*Math.PI/180),s=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),h=2/(s+a),l=2/(r+o);return t[0]=h,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=l,t[6]=0,t[7]=0,t[8]=-(s-a)*h*.5,t[9]=(r-o)*l*.5,t[10]=i/(n-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*n/(n-i),t[15]=0,t}function Se(t,e,n,i,r,o,s){var a=1/(e-n),h=1/(i-r),l=1/(o-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+n)*a,t[13]=(r+i)*h,t[14]=(s+o)*l,t[15]=1,t}function Pe(t,e,n,i){var r=void 0,o=void 0,s=void 0,a=void 0,l=void 0,c=void 0,u=void 0,f=void 0,d=void 0,m=void 0,g=e[0],p=e[1],_=e[2],v=i[0],y=i[1],x=i[2],b=n[0],w=n[1],T=n[2];return Math.abs(g-b)<h&&Math.abs(p-w)<h&&Math.abs(_-T)<h?$t(t):(u=g-b,f=p-w,d=_-T,r=y*(d*=m=1/Math.sqrt(u*u+f*f+d*d))-x*(f*=m),o=x*(u*=m)-v*d,s=v*f-y*u,(m=Math.sqrt(r*r+o*o+s*s))?(r*=m=1/m,o*=m,s*=m):(r=0,o=0,s=0),a=f*s-d*o,l=d*r-u*s,c=u*o-f*r,(m=Math.sqrt(a*a+l*l+c*c))?(a*=m=1/m,l*=m,c*=m):(a=0,l=0,c=0),t[0]=r,t[1]=a,t[2]=u,t[3]=0,t[4]=o,t[5]=l,t[6]=f,t[7]=0,t[8]=s,t[9]=c,t[10]=d,t[11]=0,t[12]=-(r*g+o*p+s*_),t[13]=-(a*g+l*p+c*_),t[14]=-(u*g+f*p+d*_),t[15]=1,t)}function Re(t,e,n,i){var r=e[0],o=e[1],s=e[2],a=i[0],h=i[1],l=i[2],c=r-n[0],u=o-n[1],f=s-n[2],d=c*c+u*u+f*f;d>0&&(c*=d=1/Math.sqrt(d),u*=d,f*=d);var m=h*f-l*u,g=l*c-a*f,p=a*u-h*c;return(d=m*m+g*g+p*p)>0&&(m*=d=1/Math.sqrt(d),g*=d,p*=d),t[0]=m,t[1]=g,t[2]=p,t[3]=0,t[4]=u*p-f*g,t[5]=f*m-c*p,t[6]=c*g-u*m,t[7]=0,t[8]=c,t[9]=u,t[10]=f,t[11]=0,t[12]=r,t[13]=o,t[14]=s,t[15]=1,t}function Oe(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function Ie(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))}function De(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t}function ke(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}function Le(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t}function Fe(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t[6]=e[6]+n[6]*i,t[7]=e[7]+n[7]*i,t[8]=e[8]+n[8]*i,t[9]=e[9]+n[9]*i,t[10]=e[10]+n[10]*i,t[11]=e[11]+n[11]*i,t[12]=e[12]+n[12]*i,t[13]=e[13]+n[13]*i,t[14]=e[14]+n[14]*i,t[15]=e[15]+n[15]*i,t}function Ne(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function Be(t,e){var n=t[0],i=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],f=t[9],d=t[10],m=t[11],g=t[12],p=t[13],_=t[14],v=t[15],y=e[0],x=e[1],b=e[2],w=e[3],T=e[4],M=e[5],A=e[6],E=e[7],C=e[8],S=e[9],P=e[10],R=e[11],O=e[12],I=e[13],D=e[14],k=e[15];return Math.abs(n-y)<=h*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(i-x)<=h*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(r-b)<=h*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(o-w)<=h*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(s-T)<=h*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(a-M)<=h*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(l-A)<=h*Math.max(1,Math.abs(l),Math.abs(A))&&Math.abs(c-E)<=h*Math.max(1,Math.abs(c),Math.abs(E))&&Math.abs(u-C)<=h*Math.max(1,Math.abs(u),Math.abs(C))&&Math.abs(f-S)<=h*Math.max(1,Math.abs(f),Math.abs(S))&&Math.abs(d-P)<=h*Math.max(1,Math.abs(d),Math.abs(P))&&Math.abs(m-R)<=h*Math.max(1,Math.abs(m),Math.abs(R))&&Math.abs(g-O)<=h*Math.max(1,Math.abs(g),Math.abs(O))&&Math.abs(p-I)<=h*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(_-D)<=h*Math.max(1,Math.abs(_),Math.abs(D))&&Math.abs(v-k)<=h*Math.max(1,Math.abs(v),Math.abs(k))}var He=re,je=ke,ze=Object.freeze({__proto__:null,create:qt,clone:Yt,copy:Kt,fromValues:Jt,set:Qt,identity:$t,transpose:te,invert:ee,adjoint:ne,determinant:ie,multiply:re,translate:oe,scale:se,rotate:ae,rotateX:he,rotateY:le,rotateZ:ce,fromTranslation:ue,fromScaling:fe,fromRotation:de,fromXRotation:me,fromYRotation:ge,fromZRotation:pe,fromRotationTranslation:_e,fromQuat2:ve,getTranslation:ye,getScaling:xe,getRotation:be,fromRotationTranslationScale:we,fromRotationTranslationScaleOrigin:Te,fromQuat:Me,frustum:Ae,perspective:Ee,perspectiveFromFieldOfView:Ce,ortho:Se,lookAt:Pe,targetTo:Re,str:Oe,frob:Ie,add:De,subtract:ke,multiplyScalar:Le,multiplyScalarAndAdd:Fe,exactEquals:Ne,equals:Be,mul:He,sub:je});function Ge(){var t=new l(3);return l!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ue(t){var e=new l(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Ve(t){var e=t[0],n=t[1],i=t[2];return Math.sqrt(e*e+n*n+i*i)}function We(t,e,n){var i=new l(3);return i[0]=t,i[1]=e,i[2]=n,i}function Xe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Ze(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function qe(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Ye(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Ke(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function Je(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function Qe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function $e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function tn(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t}function en(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t}function nn(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function rn(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function on(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function sn(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(n*n+i*i+r*r)}function an(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return n*n+i*i+r*r}function hn(t){var e=t[0],n=t[1],i=t[2];return e*e+n*n+i*i}function ln(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function cn(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function un(t,e){var n=e[0],i=e[1],r=e[2],o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function fn(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function dn(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],h=n[2];return t[0]=r*h-o*a,t[1]=o*s-i*h,t[2]=i*a-r*s,t}function mn(t,e,n,i){var r=e[0],o=e[1],s=e[2];return t[0]=r+i*(n[0]-r),t[1]=o+i*(n[1]-o),t[2]=s+i*(n[2]-s),t}function gn(t,e,n,i,r,o){var s=o*o,a=s*(2*o-3)+1,h=s*(o-2)+o,l=s*(o-1),c=s*(3-2*o);return t[0]=e[0]*a+n[0]*h+i[0]*l+r[0]*c,t[1]=e[1]*a+n[1]*h+i[1]*l+r[1]*c,t[2]=e[2]*a+n[2]*h+i[2]*l+r[2]*c,t}function pn(t,e,n,i,r,o){var s=1-o,a=s*s,h=o*o,l=a*s,c=3*o*a,u=3*h*s,f=h*o;return t[0]=e[0]*l+n[0]*c+i[0]*u+r[0]*f,t[1]=e[1]*l+n[1]*c+i[1]*u+r[1]*f,t[2]=e[2]*l+n[2]*c+i[2]*u+r[2]*f,t}function _n(t,e){e=e||1;var n=2*c()*Math.PI,i=2*c()-1,r=Math.sqrt(1-i*i)*e;return t[0]=Math.cos(n)*r,t[1]=Math.sin(n)*r,t[2]=i*e,t}function vn(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[3]*i+n[7]*r+n[11]*o+n[15];return s=s||1,t[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])/s,t[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])/s,t[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])/s,t}function yn(t,e,n){var i=e[0],r=e[1],o=e[2];return t[0]=i*n[0]+r*n[3]+o*n[6],t[1]=i*n[1]+r*n[4]+o*n[7],t[2]=i*n[2]+r*n[5]+o*n[8],t}function xn(t,e,n){var i=n[0],r=n[1],o=n[2],s=n[3],a=e[0],h=e[1],l=e[2],c=r*l-o*h,u=o*a-i*l,f=i*h-r*a,d=r*f-o*u,m=o*c-i*f,g=i*u-r*c,p=2*s;return c*=p,u*=p,f*=p,d*=2,m*=2,g*=2,t[0]=a+c+d,t[1]=h+u+m,t[2]=l+f+g,t}function bn(t,e,n,i){var r=[],o=[];return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],o[0]=r[0],o[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),o[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t}function wn(t,e,n,i){var r=[],o=[];return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],o[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),o[1]=r[1],o[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t}function Tn(t,e,n,i){var r=[],o=[];return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],o[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),o[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),o[2]=r[2],t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t}function Mn(t,e){var n=We(t[0],t[1],t[2]),i=We(e[0],e[1],e[2]);un(n,n),un(i,i);var r=fn(n,i);return r>1?0:r<-1?Math.PI:Math.acos(r)}function An(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function En(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Cn(t,e){var n=t[0],i=t[1],r=t[2],o=e[0],s=e[1],a=e[2];return Math.abs(n-o)<=h*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-s)<=h*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-a)<=h*Math.max(1,Math.abs(r),Math.abs(a))}var Sn,Pn=Ye,Rn=Ke,On=Je,In=sn,Dn=an,kn=Ve,Ln=hn,Fn=(Sn=Ge(),function(t,e,n,i,r,o){var s=void 0,a=void 0;for(e||(e=3),n||(n=0),a=i?Math.min(i*e+n,t.length):t.length,s=n;s<a;s+=e)Sn[0]=t[s],Sn[1]=t[s+1],Sn[2]=t[s+2],r(Sn,Sn,o),t[s]=Sn[0],t[s+1]=Sn[1],t[s+2]=Sn[2];return t}),Nn=Object.freeze({__proto__:null,create:Ge,clone:Ue,length:Ve,fromValues:We,copy:Xe,set:Ze,add:qe,subtract:Ye,multiply:Ke,divide:Je,ceil:Qe,floor:$e,min:tn,max:en,round:nn,scale:rn,scaleAndAdd:on,distance:sn,squaredDistance:an,squaredLength:hn,negate:ln,inverse:cn,normalize:un,dot:fn,cross:dn,lerp:mn,hermite:gn,bezier:pn,random:_n,transformMat4:vn,transformMat3:yn,transformQuat:xn,rotateX:bn,rotateY:wn,rotateZ:Tn,angle:Mn,str:An,exactEquals:En,equals:Cn,sub:Pn,mul:Rn,div:On,dist:In,sqrDist:Dn,len:kn,sqrLen:Ln,forEach:Fn});function Bn(){var t=new l(4);return l!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Hn(t){var e=new l(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function jn(t,e,n,i){var r=new l(4);return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r}function zn(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Gn(t,e,n,i,r){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t}function Un(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function Vn(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function Wn(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function Xn(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function Zn(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function qn(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function Yn(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t}function Kn(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t}function Jn(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function Qn(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function $n(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t}function ti(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],o=e[3]-t[3];return Math.sqrt(n*n+i*i+r*r+o*o)}function ei(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],o=e[3]-t[3];return n*n+i*i+r*r+o*o}function ni(t){var e=t[0],n=t[1],i=t[2],r=t[3];return Math.sqrt(e*e+n*n+i*i+r*r)}function ii(t){var e=t[0],n=t[1],i=t[2],r=t[3];return e*e+n*n+i*i+r*r}function ri(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function oi(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function si(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=n*n+i*i+r*r+o*o;return s>0&&(s=1/Math.sqrt(s),t[0]=n*s,t[1]=i*s,t[2]=r*s,t[3]=o*s),t}function ai(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function hi(t,e,n,i){var r=e[0],o=e[1],s=e[2],a=e[3];return t[0]=r+i*(n[0]-r),t[1]=o+i*(n[1]-o),t[2]=s+i*(n[2]-s),t[3]=a+i*(n[3]-a),t}function li(t,e){var n,i,r,o,s,a;e=e||1;do{s=(n=2*c()-1)*n+(i=2*c()-1)*i}while(s>=1);do{a=(r=2*c()-1)*r+(o=2*c()-1)*o}while(a>=1);var h=Math.sqrt((1-s)/a);return t[0]=e*n,t[1]=e*i,t[2]=e*r*h,t[3]=e*o*h,t}function ci(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3];return t[0]=n[0]*i+n[4]*r+n[8]*o+n[12]*s,t[1]=n[1]*i+n[5]*r+n[9]*o+n[13]*s,t[2]=n[2]*i+n[6]*r+n[10]*o+n[14]*s,t[3]=n[3]*i+n[7]*r+n[11]*o+n[15]*s,t}function ui(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],h=n[2],l=n[3],c=l*i+a*o-h*r,u=l*r+h*i-s*o,f=l*o+s*r-a*i,d=-s*i-a*r-h*o;return t[0]=c*l+d*-s+u*-h-f*-a,t[1]=u*l+d*-a+f*-s-c*-h,t[2]=f*l+d*-h+c*-a-u*-s,t[3]=e[3],t}function fi(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function di(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function mi(t,e){var n=t[0],i=t[1],r=t[2],o=t[3],s=e[0],a=e[1],l=e[2],c=e[3];return Math.abs(n-s)<=h*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-l)<=h*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(o-c)<=h*Math.max(1,Math.abs(o),Math.abs(c))}var gi=Vn,pi=Wn,_i=Xn,vi=ti,yi=ei,xi=ni,bi=ii,wi=function(){var t=Bn();return function(e,n,i,r,o,s){var a=void 0,h=void 0;for(n||(n=4),i||(i=0),h=r?Math.min(r*n+i,e.length):e.length,a=i;a<h;a+=n)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],t[3]=e[a+3],o(t,t,s),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=t[3];return e}}(),Ti=Object.freeze({__proto__:null,create:Bn,clone:Hn,fromValues:jn,copy:zn,set:Gn,add:Un,subtract:Vn,multiply:Wn,divide:Xn,ceil:Zn,floor:qn,min:Yn,max:Kn,round:Jn,scale:Qn,scaleAndAdd:$n,distance:ti,squaredDistance:ei,length:ni,squaredLength:ii,negate:ri,inverse:oi,normalize:si,dot:ai,lerp:hi,random:li,transformMat4:ci,transformQuat:ui,str:fi,exactEquals:di,equals:mi,sub:gi,mul:pi,div:_i,dist:vi,sqrDist:yi,len:xi,sqrLen:bi,forEach:wi});function Mi(){var t=new l(4);return l!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Ai(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function Ei(t,e,n){n*=.5;var i=Math.sin(n);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(n),t}function Ci(t,e){var n=2*Math.acos(e[3]),i=Math.sin(n/2);return i>h?(t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i):(t[0]=1,t[1]=0,t[2]=0),n}function Si(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=n[0],h=n[1],l=n[2],c=n[3];return t[0]=i*c+s*a+r*l-o*h,t[1]=r*c+s*h+o*a-i*l,t[2]=o*c+s*l+i*h-r*a,t[3]=s*c-i*a-r*h-o*l,t}function Pi(t,e,n){n*=.5;var i=e[0],r=e[1],o=e[2],s=e[3],a=Math.sin(n),h=Math.cos(n);return t[0]=i*h+s*a,t[1]=r*h+o*a,t[2]=o*h-r*a,t[3]=s*h-i*a,t}function Ri(t,e,n){n*=.5;var i=e[0],r=e[1],o=e[2],s=e[3],a=Math.sin(n),h=Math.cos(n);return t[0]=i*h-o*a,t[1]=r*h+s*a,t[2]=o*h+i*a,t[3]=s*h-r*a,t}function Oi(t,e,n){n*=.5;var i=e[0],r=e[1],o=e[2],s=e[3],a=Math.sin(n),h=Math.cos(n);return t[0]=i*h+r*a,t[1]=r*h-i*a,t[2]=o*h+s*a,t[3]=s*h-o*a,t}function Ii(t,e){var n=e[0],i=e[1],r=e[2];return t[0]=n,t[1]=i,t[2]=r,t[3]=Math.sqrt(Math.abs(1-n*n-i*i-r*r)),t}function Di(t,e,n,i){var r=e[0],o=e[1],s=e[2],a=e[3],l=n[0],c=n[1],u=n[2],f=n[3],d=void 0,m=void 0,g=void 0,p=void 0,_=void 0;return(m=r*l+o*c+s*u+a*f)<0&&(m=-m,l=-l,c=-c,u=-u,f=-f),1-m>h?(d=Math.acos(m),g=Math.sin(d),p=Math.sin((1-i)*d)/g,_=Math.sin(i*d)/g):(p=1-i,_=i),t[0]=p*r+_*l,t[1]=p*o+_*c,t[2]=p*s+_*u,t[3]=p*a+_*f,t}function ki(t){var e=c(),n=c(),i=c(),r=Math.sqrt(1-e),o=Math.sqrt(e);return t[0]=r*Math.sin(2*Math.PI*n),t[1]=r*Math.cos(2*Math.PI*n),t[2]=o*Math.sin(2*Math.PI*i),t[3]=o*Math.cos(2*Math.PI*i),t}function Li(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=n*n+i*i+r*r+o*o,a=s?1/s:0;return t[0]=-n*a,t[1]=-i*a,t[2]=-r*a,t[3]=o*a,t}function Fi(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function Ni(t,e){var n=e[0]+e[4]+e[8],i=void 0;if(n>0)i=Math.sqrt(n+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);var o=(r+1)%3,s=(r+2)%3;i=Math.sqrt(e[3*r+r]-e[3*o+o]-e[3*s+s]+1),t[r]=.5*i,i=.5/i,t[3]=(e[3*o+s]-e[3*s+o])*i,t[o]=(e[3*o+r]+e[3*r+o])*i,t[s]=(e[3*s+r]+e[3*r+s])*i}return t}function Bi(t,e,n,i){var r=.5*Math.PI/180;e*=r,n*=r,i*=r;var o=Math.sin(e),s=Math.cos(e),a=Math.sin(n),h=Math.cos(n),l=Math.sin(i),c=Math.cos(i);return t[0]=o*h*c-s*a*l,t[1]=s*a*c+o*h*l,t[2]=s*h*l-o*a*c,t[3]=s*h*c+o*a*l,t}function Hi(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}var ji,zi,Gi,Ui,Vi,Wi,Xi=Hn,Zi=jn,qi=zn,Yi=Gn,Ki=Un,Ji=Si,Qi=Qn,$i=ai,tr=hi,er=ni,nr=er,ir=ii,rr=ir,or=si,sr=di,ar=mi,hr=(Ui=Ge(),Vi=We(1,0,0),Wi=We(0,1,0),function(t,e,n){var i=fn(e,n);return i<-.999999?(dn(Ui,Vi,e),kn(Ui)<1e-6&&dn(Ui,Wi,e),un(Ui,Ui),Ei(t,Ui,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(dn(Ui,e,n),t[0]=Ui[0],t[1]=Ui[1],t[2]=Ui[2],t[3]=1+i,or(t,t))}),lr=(zi=Mi(),Gi=Mi(),function(t,e,n,i,r,o){return Di(zi,e,r,o),Di(Gi,n,i,o),Di(t,zi,Gi,2*o*(1-o)),t}),cr=(ji=gt(),function(t,e,n,i){return ji[0]=n[0],ji[3]=n[1],ji[6]=n[2],ji[1]=i[0],ji[4]=i[1],ji[7]=i[2],ji[2]=-e[0],ji[5]=-e[1],ji[8]=-e[2],or(t,Ni(t,ji))}),ur=Object.freeze({__proto__:null,create:Mi,identity:Ai,setAxisAngle:Ei,getAxisAngle:Ci,multiply:Si,rotateX:Pi,rotateY:Ri,rotateZ:Oi,calculateW:Ii,slerp:Di,random:ki,invert:Li,conjugate:Fi,fromMat3:Ni,fromEuler:Bi,str:Hi,clone:Xi,fromValues:Zi,copy:qi,set:Yi,add:Ki,mul:Ji,scale:Qi,dot:$i,lerp:tr,length:er,len:nr,squaredLength:ir,sqrLen:rr,normalize:or,exactEquals:sr,equals:ar,rotationTo:hr,sqlerp:lr,setAxes:cr});function fr(){var t=new l(8);return l!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t}function dr(t){var e=new l(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function mr(t,e,n,i,r,o,s,a){var h=new l(8);return h[0]=t,h[1]=e,h[2]=n,h[3]=i,h[4]=r,h[5]=o,h[6]=s,h[7]=a,h}function gr(t,e,n,i,r,o,s){var a=new l(8);a[0]=t,a[1]=e,a[2]=n,a[3]=i;var h=.5*r,c=.5*o,u=.5*s;return a[4]=h*i+c*n-u*e,a[5]=c*i+u*t-h*n,a[6]=u*i+h*e-c*t,a[7]=-h*t-c*e-u*n,a}function pr(t,e,n){var i=.5*n[0],r=.5*n[1],o=.5*n[2],s=e[0],a=e[1],h=e[2],l=e[3];return t[0]=s,t[1]=a,t[2]=h,t[3]=l,t[4]=i*l+r*h-o*a,t[5]=r*l+o*s-i*h,t[6]=o*l+i*a-r*s,t[7]=-i*s-r*a-o*h,t}function _r(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t}function vr(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t}function yr(t,e){var n=Mi();be(n,e);var i=new l(3);return ye(i,e),pr(t,n,i),t}function xr(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function br(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t}function wr(t,e,n,i,r,o,s,a,h){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=o,t[5]=s,t[6]=a,t[7]=h,t}var Tr=qi;function Mr(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t}var Ar=qi;function Er(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t}function Cr(t,e){var n=e[4],i=e[5],r=e[6],o=e[7],s=-e[0],a=-e[1],h=-e[2],l=e[3];return t[0]=2*(n*l+o*s+i*h-r*a),t[1]=2*(i*l+o*a+r*s-n*h),t[2]=2*(r*l+o*h+n*a-i*s),t}function Sr(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=.5*n[0],h=.5*n[1],l=.5*n[2],c=e[4],u=e[5],f=e[6],d=e[7];return t[0]=i,t[1]=r,t[2]=o,t[3]=s,t[4]=s*a+r*l-o*h+c,t[5]=s*h+o*a-i*l+u,t[6]=s*l+i*h-r*a+f,t[7]=-i*a-r*h-o*l+d,t}function Pr(t,e,n){var i=-e[0],r=-e[1],o=-e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=a*s+c*i+h*o-l*r,f=h*s+c*r+l*i-a*o,d=l*s+c*o+a*r-h*i,m=c*s-a*i-h*r-l*o;return Pi(t,e,n),i=t[0],r=t[1],o=t[2],s=t[3],t[4]=u*s+m*i+f*o-d*r,t[5]=f*s+m*r+d*i-u*o,t[6]=d*s+m*o+u*r-f*i,t[7]=m*s-u*i-f*r-d*o,t}function Rr(t,e,n){var i=-e[0],r=-e[1],o=-e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=a*s+c*i+h*o-l*r,f=h*s+c*r+l*i-a*o,d=l*s+c*o+a*r-h*i,m=c*s-a*i-h*r-l*o;return Ri(t,e,n),i=t[0],r=t[1],o=t[2],s=t[3],t[4]=u*s+m*i+f*o-d*r,t[5]=f*s+m*r+d*i-u*o,t[6]=d*s+m*o+u*r-f*i,t[7]=m*s-u*i-f*r-d*o,t}function Or(t,e,n){var i=-e[0],r=-e[1],o=-e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=a*s+c*i+h*o-l*r,f=h*s+c*r+l*i-a*o,d=l*s+c*o+a*r-h*i,m=c*s-a*i-h*r-l*o;return Oi(t,e,n),i=t[0],r=t[1],o=t[2],s=t[3],t[4]=u*s+m*i+f*o-d*r,t[5]=f*s+m*r+d*i-u*o,t[6]=d*s+m*o+u*r-f*i,t[7]=m*s-u*i-f*r-d*o,t}function Ir(t,e,n){var i=n[0],r=n[1],o=n[2],s=n[3],a=e[0],h=e[1],l=e[2],c=e[3];return t[0]=a*s+c*i+h*o-l*r,t[1]=h*s+c*r+l*i-a*o,t[2]=l*s+c*o+a*r-h*i,t[3]=c*s-a*i-h*r-l*o,a=e[4],h=e[5],l=e[6],c=e[7],t[4]=a*s+c*i+h*o-l*r,t[5]=h*s+c*r+l*i-a*o,t[6]=l*s+c*o+a*r-h*i,t[7]=c*s-a*i-h*r-l*o,t}function Dr(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=n[0],h=n[1],l=n[2],c=n[3];return t[0]=i*c+s*a+r*l-o*h,t[1]=r*c+s*h+o*a-i*l,t[2]=o*c+s*l+i*h-r*a,t[3]=s*c-i*a-r*h-o*l,a=n[4],h=n[5],l=n[6],c=n[7],t[4]=i*c+s*a+r*l-o*h,t[5]=r*c+s*h+o*a-i*l,t[6]=o*c+s*l+i*h-r*a,t[7]=s*c-i*a-r*h-o*l,t}function kr(t,e,n,i){if(Math.abs(i)<h)return xr(t,e);var r=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);i*=.5;var o=Math.sin(i),s=o*n[0]/r,a=o*n[1]/r,l=o*n[2]/r,c=Math.cos(i),u=e[0],f=e[1],d=e[2],m=e[3];t[0]=u*c+m*s+f*l-d*a,t[1]=f*c+m*a+d*s-u*l,t[2]=d*c+m*l+u*a-f*s,t[3]=m*c-u*s-f*a-d*l;var g=e[4],p=e[5],_=e[6],v=e[7];return t[4]=g*c+v*s+p*l-_*a,t[5]=p*c+v*a+_*s-g*l,t[6]=_*c+v*l+g*a-p*s,t[7]=v*c-g*s-p*a-_*l,t}function Lr(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t}function Fr(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=n[4],h=n[5],l=n[6],c=n[7],u=e[4],f=e[5],d=e[6],m=e[7],g=n[0],p=n[1],_=n[2],v=n[3];return t[0]=i*v+s*g+r*_-o*p,t[1]=r*v+s*p+o*g-i*_,t[2]=o*v+s*_+i*p-r*g,t[3]=s*v-i*g-r*p-o*_,t[4]=i*c+s*a+r*l-o*h+u*v+m*g+f*_-d*p,t[5]=r*c+s*h+o*a-i*l+f*v+m*p+d*g-u*_,t[6]=o*c+s*l+i*h-r*a+d*v+m*_+u*p-f*g,t[7]=s*c-i*a-r*h-o*l+m*v-u*g-f*p-d*_,t}var Nr=Fr;function Br(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t}var Hr=$i;function jr(t,e,n,i){var r=1-i;return Hr(e,n)<0&&(i=-i),t[0]=e[0]*r+n[0]*i,t[1]=e[1]*r+n[1]*i,t[2]=e[2]*r+n[2]*i,t[3]=e[3]*r+n[3]*i,t[4]=e[4]*r+n[4]*i,t[5]=e[5]*r+n[5]*i,t[6]=e[6]*r+n[6]*i,t[7]=e[7]*r+n[7]*i,t}function zr(t,e){var n=Wr(e);return t[0]=-e[0]/n,t[1]=-e[1]/n,t[2]=-e[2]/n,t[3]=e[3]/n,t[4]=-e[4]/n,t[5]=-e[5]/n,t[6]=-e[6]/n,t[7]=e[7]/n,t}function Gr(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t}var Ur=er,Vr=Ur,Wr=ir,Xr=Wr;function Zr(t,e){var n=Wr(e);if(n>0){n=Math.sqrt(n);var i=e[0]/n,r=e[1]/n,o=e[2]/n,s=e[3]/n,a=e[4],h=e[5],l=e[6],c=e[7],u=i*a+r*h+o*l+s*c;t[0]=i,t[1]=r,t[2]=o,t[3]=s,t[4]=(a-i*u)/n,t[5]=(h-r*u)/n,t[6]=(l-o*u)/n,t[7]=(c-s*u)/n}return t}function qr(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"}function Yr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]}function Kr(t,e){var n=t[0],i=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=e[0],f=e[1],d=e[2],m=e[3],g=e[4],p=e[5],_=e[6],v=e[7];return Math.abs(n-u)<=h*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(i-f)<=h*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(r-d)<=h*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(o-m)<=h*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(s-g)<=h*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(a-p)<=h*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(l-_)<=h*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(c-v)<=h*Math.max(1,Math.abs(c),Math.abs(v))}var Jr=Object.freeze({__proto__:null,create:fr,clone:dr,fromValues:mr,fromRotationTranslationValues:gr,fromRotationTranslation:pr,fromTranslation:_r,fromRotation:vr,fromMat4:yr,copy:xr,identity:br,set:wr,getReal:Tr,getDual:Mr,setReal:Ar,setDual:Er,getTranslation:Cr,translate:Sr,rotateX:Pr,rotateY:Rr,rotateZ:Or,rotateByQuatAppend:Ir,rotateByQuatPrepend:Dr,rotateAroundAxis:kr,add:Lr,multiply:Fr,mul:Nr,scale:Br,dot:Hr,lerp:jr,invert:zr,conjugate:Gr,length:Ur,len:Vr,squaredLength:Wr,sqrLen:Xr,normalize:Zr,str:qr,exactEquals:Yr,equals:Kr});function Qr(){var t=new l(2);return l!=Float32Array&&(t[0]=0,t[1]=0),t}function $r(t){var e=new l(2);return e[0]=t[0],e[1]=t[1],e}function to(t,e){var n=new l(2);return n[0]=t,n[1]=e,n}function eo(t,e){return t[0]=e[0],t[1]=e[1],t}function no(t,e,n){return t[0]=e,t[1]=n,t}function io(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function ro(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function oo(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function so(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function ao(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function ho(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function lo(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t}function co(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t}function uo(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function fo(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t}function mo(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t}function go(t,e){var n=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(n*n+i*i)}function po(t,e){var n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i}function _o(t){var e=t[0],n=t[1];return Math.sqrt(e*e+n*n)}function vo(t){var e=t[0],n=t[1];return e*e+n*n}function yo(t,e){return t[0]=-e[0],t[1]=-e[1],t}function xo(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function bo(t,e){var n=e[0],i=e[1],r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),t[0]=e[0]*r,t[1]=e[1]*r),t}function wo(t,e){return t[0]*e[0]+t[1]*e[1]}function To(t,e,n){var i=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=i,t}function Mo(t,e,n,i){var r=e[0],o=e[1];return t[0]=r+i*(n[0]-r),t[1]=o+i*(n[1]-o),t}function Ao(t,e){e=e||1;var n=2*c()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t}function Eo(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[2]*r,t[1]=n[1]*i+n[3]*r,t}function Co(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[2]*r+n[4],t[1]=n[1]*i+n[3]*r+n[5],t}function So(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[3]*r+n[6],t[1]=n[1]*i+n[4]*r+n[7],t}function Po(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[4]*r+n[12],t[1]=n[1]*i+n[5]*r+n[13],t}function Ro(t,e,n,i){var r=e[0]-n[0],o=e[1]-n[1],s=Math.sin(i),a=Math.cos(i);return t[0]=r*a-o*s+n[0],t[1]=r*s+o*a+n[1],t}function Oo(t,e){var n=t[0],i=t[1],r=e[0],o=e[1],s=n*n+i*i;s>0&&(s=1/Math.sqrt(s));var a=r*r+o*o;a>0&&(a=1/Math.sqrt(a));var h=(n*r+i*o)*s*a;return h>1?0:h<-1?Math.PI:Math.acos(h)}function Io(t){return"vec2("+t[0]+", "+t[1]+")"}function Do(t,e){return t[0]===e[0]&&t[1]===e[1]}function ko(t,e){var n=t[0],i=t[1],r=e[0],o=e[1];return Math.abs(n-r)<=h*Math.max(1,Math.abs(n),Math.abs(r))&&Math.abs(i-o)<=h*Math.max(1,Math.abs(i),Math.abs(o))}var Lo=_o,Fo=ro,No=oo,Bo=so,Ho=go,jo=po,zo=vo,Go=function(){var t=Qr();return function(e,n,i,r,o,s){var a=void 0,h=void 0;for(n||(n=2),i||(i=0),h=r?Math.min(r*n+i,e.length):e.length,a=i;a<h;a+=n)t[0]=e[a],t[1]=e[a+1],o(t,t,s),e[a]=t[0],e[a+1]=t[1];return e}}(),Uo=Object.freeze({__proto__:null,create:Qr,clone:$r,fromValues:to,copy:eo,set:no,add:io,subtract:ro,multiply:oo,divide:so,ceil:ao,floor:ho,min:lo,max:co,round:uo,scale:fo,scaleAndAdd:mo,distance:go,squaredDistance:po,length:_o,squaredLength:vo,negate:yo,inverse:xo,normalize:bo,dot:wo,cross:To,lerp:Mo,random:Ao,transformMat2:Eo,transformMat2d:Co,transformMat3:So,transformMat4:Po,rotate:Ro,angle:Oo,str:Io,exactEquals:Do,equals:ko,len:Lo,sub:Fo,mul:No,div:Bo,dist:Ho,sqrDist:jo,sqrLen:zo,forEach:Go});let Vo=0;function Wo(t){return null==t}function Xo(t){return!Wo(t)}function Zo(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function qo(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function Yo(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function Ko(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,i=new Uint8Array(n);for(let r=0;r<n;r++)i[r]=e.charCodeAt(r);return i.buffer}const Jo=[],Qo=[],$o=[],ts=[0,0,0],es=Ai([]),ns=[1,1,1];function is(t,e,n,i,r,o,s){const a=qo(s);if((0===r||r===i*a.BYTES_PER_ELEMENT)&&o%a.BYTES_PER_ELEMENT==0){const r=new a(e,o,n*i);return t.set(r),t}0===r&&(r=i*a.BYTES_PER_ELEMENT);const h=new Uint8Array(i*a.BYTES_PER_ELEMENT);for(let l=0;l<n;l++){let n=null;const s=new Uint8Array(e,r*l+o,i*a.BYTES_PER_ELEMENT);h.set(s),n=new a(h.buffer,0,i);for(let e=0;e<i;e++)t[l*i+e]=n[e]}return t}const rs="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function os(t,e,n){const i=new Uint8Array(t,e,n);return rs.decode(i)}const ss={get:function(t,e={}){e||(e={});const n=new AbortController,i=n.signal,r=Zo({},e);r.signal=i,r.method||(r.method="GET");const o=fetch(t,r).then((t=>{const n=this._parseResponse(t,e.responseType);return n.message?n:n.then((n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n)).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}))})).catch((t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t}));return o.xhr=n,o},_parseResponse:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={})=>(e||(e={}),e.responseType="arraybuffer",ss.get(t,e)),getJSON:function(t,e={}){return e&&e.jsonp?ss.jsonp(t):((e=e||{}).responseType="json",ss.get(t,e))},jsonp:function(t){const e="_maptalks_jsonp_"+Vo++;t.match(/\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise((t=>{window[e]=function(i){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(i)},document.getElementsByTagName("head")[0].appendChild(n)}))}};class as{constructor(t,e,n){this._requestImage=t,this.decoders=e,this._supportedFormats=n,this.images={},this._imgRequests={}}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const i=this.buffers[t.id],r=this._createDataView(e,i);return this.getImageByBuffer(r,n)}if(this._imgRequests[t.id])return this._imgRequests[t.id].then((()=>{const i=this.buffers[t.id],r=this._createDataView(e,i);return this.getImageByBuffer(r,n)}));if(Yo(t.uri)){const i=this.buffers[t.id]=Ko(t.uri),r=this._createDataView(e,i);return this.getImageByBuffer(r,n)}return this._imgRequests[t.id]=ss.getArrayBuffer(t.uri,null).then((i=>{const r=this.buffers[t.id]=i.data,o=this._createDataView(e,r);return this.getImageByBuffer(o,n)}))}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;if(n[e.mimeType])return n[e.mimeType](t,{supportedFormats:this._supportedFormats});if("image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType)return console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null);{const n=new Blob([t],{type:e.mimeType}),i=URL.createObjectURL(n);return this._getImageInfo(e.id,i)}}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this._imgRequests[t.id]?this._imgRequests[t.id].then((()=>this.images[t.id])):this._imgRequests[t.id]=this._getImageInfo(t.id,e)}_getImageInfo(t,e){return new Promise(((n,i)=>{this._requestImage(e,((r,o)=>{r?i(r):(URL.revokeObjectURL(e),this.images[t]=o,n(this.images[t]))}))}))}}const hs=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16];class ls{constructor(t,e,n){this.rootPath=t,this.gltf=e,this._enableInterleave=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this._compareAccessor()}_requestData(t,e){const n=this.gltf,i=n.accessors[e];if(void 0===i.bufferView)return this.accessors[i.id]=this._toBufferData(t,e,null,0),Promise.resolve(this.accessors[i.id]);if(i&&this.accessors[i.id])return Promise.resolve(this.accessors[i.id]);const r=n.bufferViews[i.bufferView];return this._requestBufferOfBufferView(r).then((n=>{const{buffer:r,byteOffset:o}=n;return this.accessors[i.id]=this._toBufferData(t,e,r,o)}))}_requestBufferOfBufferView(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then((()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}));if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(Yo(e.uri)){const t=this.buffers[e.id]=Ko(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=ss.getArrayBuffer(t,null).then((i=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=i.data,byteOffset:0})))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}_toBufferData(t,e,n,i=0){const r=this.gltf,o=r.accessors[e],s=void 0!==o.bufferView?r.bufferViews[o.bufferView]:{},a=(s.byteOffset||0)+i,h=this._getTypeItemSize(o.type),l=qo(o.componentType),c=s.byteStride||0,u={array:void 0,name:t,accessorName:e,byteLength:o.count*h*l.BYTES_PER_ELEMENT,componentType:o.componentType,count:o.count,type:o.type,itemSize:h};if(o.min&&(u.min=o.min),o.max&&(u.max=o.max),n)if(this._enableInterleave)u.byteStride=c,u.byteOffset=a+(o.byteOffset||0),!c||c===h*l.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(u.array=this._typedArray(n,o.count,h,a+(o.byteOffset||0),l),u.array.buffer.byteLength===u.byteLength&&(u.byteOffset=0)):u.array=new Uint8Array(n,a,s.byteLength);else if(o.interleaved){u.byteStride=0,u.byteOffset=0;const t=new l(o.count*h);u.array=is(t,n,o.count,h,c,a+(o.byteOffset||0),o.componentType)}else u.byteStride=0,u.array=this._typedArray(n,o.count,h,a+(o.byteOffset||0),l),u.byteOffset=u.array.byteOffset;else{u.array=new l(o.count);const t=u.min||u.max;t&&(u.array[0]=t[0],u.array[1]=t[1],u.array[2]=t[2])}return u}_compareAccessor(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}_typedArray(t,e,n,i,r){return i%r.BYTES_PER_ELEMENT!=0&&(t=t.slice(i,i+e*n*r.BYTES_PER_ELEMENT),i=0),new r(t,i,n*e)}_getTypeItemSize(t){const e=hs.indexOf(t);return hs[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map((t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this._requestBufferOfBufferView(e).then((i=>{const{buffer:r,byteOffset:o}=i,s=os(r,o+(e.byteOffset||0),n);return t.content=s,t}))}if(t.uri){if(Yo(t.uri)){const e=Ko(t.uri),n=os(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return ss.get(e).then((e=>(t.content=e,t)))}}return Promise.resolve(t)}));return Promise.all(n).then((()=>t))}}class cs extends as{constructor(t,e,n,i,r,o){super(i,r,o),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new ls(t,e,n)}iterate(t,e){const n=this.gltf[e];if(!n)return;let i=0;for(const r in n)t(r,n[r],i++)}createNode(t){const e={};if(Xo(t.name)&&(e.name=t.name),Xo(t.children)&&(e.children=t.children),Xo(t.jointName)&&(e.jointName=t.jointName),Xo(t.matrix)&&(e.matrix=t.matrix),Xo(t.rotation)&&(e.rotation=t.rotation),Xo(t.scale)&&(e.scale=t.scale),Xo(t.translation)&&(e.translation=t.translation),Xo(t.extras)&&(e.extras=t.extras),Xo(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=ue(Jo,e.translation||ts),i=Me(Qo,e.rotation||es),r=fe($o,e.scale||ns);return re(r,i,r),re(t,n,r)}return $t(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}_loadMaterials(t){const e={};for(const n in t){const i=t[n];let r,o;i.instanceTechnique&&i.instanceTechnique.values?(r=i.instanceTechnique,o=r.values.diffuse):(r=i,o=r.values.tex||r.values.diffuseTex||r.values.diffuse);const s={baseColorTexture:{index:o}};i.name&&(s.name=i.name),i.extensions&&(s.extensions=i.extensions),i.extras&&(s.extras=i.extras),e[n]=s}return e}_loadImage(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],i=(n.byteOffset||0)+this.glbBuffer.byteOffset,r=n.byteLength,o=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,i,r);return this.getImageByBuffer(o,t)}return this.requestExternalImage(t)}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this._loadImage(n).then((t=>{const i=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:i}}))}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,i;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,i=n.values.diffuse):(n=e,i=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===i||void 0===this.gltf.textures)return null;const r=this.gltf.textures[i];if(!r)return null;const o=this.gltf.samplers[r.sampler];return{format:r.format||6408,internalFormat:r.internalFormat||6408,type:r.type||5121,sampler:o,source:this.gltf.images[r.source]}}getMaterial(){return null}getAnimations(){return null}}class us extends as{constructor(t,e,n,i,r,o){super(i,r,o),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new ls(t,e,n)}iterate(t,e){const n=this.gltf[e];if(n)for(let i=0;i<n.length;i++)t(i,n[i],i)}createNode(t){const e={};return Zo(e,t),!Xo(t.weights)&&this.gltf.meshes&&Xo(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this._loadImage(n).then((t=>{if(!t)return null;const i={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extensions:n.extensions,extras:n.extras}};Zo(i,e);const r=Xo(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return r&&(i.sampler=r),t.format&&(i.format=t.format),i}))}_loadImage(t){if(!Xo(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this._requestFromGlbBuffer(e,t)}return null}_requestFromGlbBuffer(t,e){const n=this._createDataView(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}_createDataView(t,e,n){n=n||0;const i=t.byteOffset+n,r=t.byteLength;return new Uint8Array(e,i,r)}_transformArrayBufferToBase64(t,e){const n=new Array(t.byteLength);for(let i=0;i<t.byteLength;i++)n[i]=String.fromCharCode(t[i]);return n.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)))}getAnimations(t){const e=[];return t.forEach((t=>{e.push(this.getSamplers(t.samplers))})),Promise.all(e).then((e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t}))}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(Xo(t[n].input)||Xo(t[n].output))&&(e.push(this.accessor._requestData("input",t[n].input)),e.push(this.accessor._requestData("output",t[n].output)));return Promise.all(e).then((e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t}))}}const fs="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null,ds=1313821514,ms=5130562;class gs{static read(t,e=0,n=0){n||(n=t.byteLength);const i=new DataView(t,e,n),r=i.getUint32(4,!0);if(1===r)return gs.readV1(i,e);if(2===r)return gs.readV2(t,e);throw new Error("Unsupported glb version : "+r)}static readV1(t,e){const n=t.getUint32(8,!0),i=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const r=ps(t.buffer,20+e,i);return{json:JSON.parse(r),glbBuffer:{byteOffset:20+e+i,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,i,r;const o=new DataView(t,e+12);let s=0;for(;s<o.byteLength;){const a=o.getUint32(s,!0);s+=4;const h=o.getUint32(s,!0);if(s+=4,h===ds)n=ps(t,e+12+s,a);else if(h===ms){r=e+12+s,i=a;break}s+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:r,buffer:t,byteLength:i}}}}function ps(t,e,n){if(fs){const i=new Uint8Array(t,e,n);return fs.decode(i)}return function(t){const e=t.length;let n="";for(let i=0;i<e;){let r=t[i++];if(128&r){let n=_s[r>>3&7];if(!(64&r)||!n||i+n>e)return null;for(r&=63>>n;n>0;n-=1){const e=t[i++];if(128!=(192&e))return null;r=r<<6|63&e}}n+=String.fromCharCode(r)}return n}(new Uint8Array(t,e,n))}const _s=[1,1,1,1,2,2,3,0],vs=[0,0,0],ys=[0,0,0,1],xs=[1,1,1],bs={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},ws={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},Ts={_getTRSW(t,e,n,i,r,o,s,a){const h=Xo(t)?e.animations:[e.animations[0]],l={};for(let c=0;c<h.length;c++){const e=h[c],u=e.name||c;if(Xo(t)&&u!==t)continue;const f=e.channelsMap[n];if(f)for(let t=0;t<f.length;t++){const n=f[t];"translation"===n.target.path?(this._getAnimateData(r,e.samplers[n.sampler],i,1),l.translation=Xe(vs,r)):"rotation"===n.target.path?(this._getQuaternion(o,e.samplers[n.sampler],i,1),l.rotation=qi(ys,o)):"scale"===n.target.path?(this._getAnimateData(s,e.samplers[n.sampler],i,1),l.scale=Xe(xs,s)):"weights"===n.target.path&&a&&(this._getAnimateData(a,e.samplers[n.sampler],i,a.length),l.weights=a)}}return l},_getAnimateData(t,e,n,i){switch(e.interpolation){case"LINEAR":{const r=this._getPreNext(ws,e,n,1*i);r&&(t=function(t,e,n,i){for(let r=0;r<t.length;r++)t[r]=e[r]+i*(n[r]-e[r]);return t}(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION));break}case"STEP":{const r=this._getPreNext(ws,e,n,1*i);r&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this._getPreNext(ws,e,n,3*i);r&&(t=this._getCubicSpline(t,r,e.input.array,3*i));break}}return t},_getQuaternion(t,e,n){switch(e.interpolation){case"LINEAR":{const i=this._getPreNext(ws,e,n,1);i&&Di(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION);break}case"STEP":{const i=this._getPreNext(ws,e,n,1);i&&(t=Gn(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this._getPreNext(ws,e,n,3);if(i){for(let t=0;t<i.PREVIOUS.length;t++)i.PREVIOUS[t]=Math.acos(i.PREVIOUS[t]),i.NEXT[t]=Math.acos(i.NEXT[t]);t=this._getCubicSpline(t,i,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},_search(t,e){const n=t.length;let i,r,o,s=0,a=n-1,h=Math.floor((s+a)/2);for(;s<=n-1&&a>=0;){if(s===a)return null;if(t[h]<=e&&e<=t[h+1]){const n=t[h];return i=h,r=h+1,o=(e-n)/(t[h+1]-n),{preIndx:i,nextIndex:r,interpolation:o}}e<t[h]?(a=h,h=Math.floor((s+a)/2)):t[h+1]<e&&(s=h,h=Math.floor((s+a)/2))}return null},_getPreNext(t,e,n,i){const r=e.input.array,o=e.output.array,s=e.output.itemSize;(n<r[0]||n>r[r.length-1])&&(n=Math.max(r[0],Math.min(r[r.length-1],n))),n===r[r.length-1]&&(n=r[0]);const a=this._search(r,n);if(!a||!a.nextIndex)return null;const{preIndx:h,nextIndex:l,interpolation:c}=a;t.PREINDEX=h,t.NEXTINDEX=l,t.INTERPOLATION=c;const u=s*i;return t.PREVIOUS=o.subarray(t.PREINDEX*u,(t.PREINDEX+1)*u),t.NEXT=o.subarray(t.NEXTINDEX*u,(t.NEXTINDEX+1)*u),t},_getCubicSpline(t,e,n,i){const r=e.INTERPOLATION,o=n[e.PREINDEX],s=n[e.NEXTINDEX];for(let a=0;a<3;a++){const n=e.PREVIOUS[i+a],h=(s-o)*e.PREVIOUS[2*i+a],l=e.NEXT[3+a],c=(s-o)*e.NEXT[a],u=(2*Math.pow(r,3)-3*Math.pow(r,2)+1)*n+(Math.pow(r,3)-2*Math.pow(r,2)+r)*h+(2*-Math.pow(r,3)+3*Math.pow(r,2))*l+(Math.pow(r,3)-Math.pow(r,2))*c;t[a]=u}return t},getAnimationClip(t,e,n,i){const r=t.nodes[e]&&t.nodes[e].weights;return Ze(vs,...bs.TRANSLATION),Gn(ys,...bs.ROTATION),Ze(xs,...bs.SCALE),this._getTRSW(i,t,e,n,vs,ys,xs,r)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach(((e,n)=>{let i=-1/0,r=1/0;const o=e.channels;for(let t=0;t<o.length;t++){const n=o[t],s=e.samplers[n.sampler].input.array;s[s.length-1]>i&&(i=s[s.length-1]),s[0]<r&&(r=s[0])}const s=e.name||n;t.timeSpan[s]={max:i,min:r}})),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?Xo(e)?n[e]:n[Object.keys(n)[0]]:null}};let Ms=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(mA){}t&&"undefined"!=typeof createImageBitmap&&(Ms=!0)}const As="undefined"==typeof document?null:document.createElement("canvas");class Es{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:i}=gs.read(e.buffer,e.byteOffset,e.byteLength);this._init(t,n,i)}else this._init(t,e);this._accessor=new ls(this.rootPath,this.gltf,this.glbBuffer),this._checkExtensions()}_checkExtensions(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}_loadExtensions(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this._accessor.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then((e=>(t.KHR_techniques_webgl=e,t))):Promise.resolve(t)}load(t){t=t||{};const e=this._loadScene(t),n=this._loadAnimations(),i=this._loadTextures(),r=this._loadExtensions();return Promise.all([e,n,i,r]).then((t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0])))}createChannelsMap(t){const e=t.animations;if(e)for(let n=0;n<e.length;n++){const t=e[n];t.channelsMap={};for(let e=0;e<t.channels.length;e++){const n=t.channels[e];t.channelsMap[n.target.node]||(t.channelsMap[n.target.node]=[]),t.channelsMap[n.target.node].push(n)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let i=0;i<e.length;i++)e[i].uri&&e[i].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[i].uri});for(let i=0;i<n.length;i++)n[i].uri&&n[i].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[i].uri})}return t}static getAnimationClip(t,e,n,i){return Ts.getAnimationClip(t,e,n,i)}static getAnimationTimeSpan(t,e){return Ts.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return qo(t)}static readInterleavedArray(t,e,n,i,r,o,s){return is(t,e,n,i,r,o,s)}_init(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=Ms?Rs.bind(this):this.options.requestImage||Cs,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new us(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{}),this.adapter.iterate(((t,e,n)=>{e.id="buffer_"+n}),"buffers"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors")):(this.adapter=new cs(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{}),this.adapter.iterate(((t,e,n)=>{e.id="accessor_"+n}),"accessors"),this.adapter.iterate(((t,e,n)=>{e.id="image_"+n}),"images"))}_parseNodes(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||function(t){return!Wo(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}(t.children[0])))return t;const i=t.children.map((t=>{const n=e[t];return n.nodeIndex=t,this._parseNodes(n,e)}));t.children=i}var n;return t}_loadScene(t){return this._loadNodes(t).then((t=>{const e=this.scenes=[];let n;for(const r in t)t[r]=this._parseNodes(t[r],t),t[r].nodeIndex=Number(r)?Number(r):r;this.adapter.iterate(((i,r,o)=>{const s={};r.name&&(s.name=r.name),r.nodes&&(s.nodes=r.nodes.map((e=>t[e]))),this.gltf.scene===i&&(n=o),e.push(s)}),"scenes");const i={asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins};if(this.gltf.extensions&&(i.extensions=this.gltf.extensions),1===this.version){const t=this.adapter._loadMaterials(this.gltf.materials);i.materials=t}return i}))}_loadNodes(t){return this._loadMeshes(t).then((()=>{const t=this.nodes={};return this.adapter.iterate(((e,n)=>{const i=this.adapter.createNode(n,this.meshes,this.skins);t[e]=i}),"nodes"),t}))}_loadSkins(){this.skins=[];const t=[];return this.adapter.iterate(((e,n,i)=>{t.push(this._loadSkin(n).then((t=>{t.index=i,this.skins.push(t)})))}),"skins"),t}_loadSkin(t){const e=t.inverseBindMatrices;return this.adapter.accessor._requestData("inverseBindMatrices",e).then((e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t)))}_loadAnimations(){const t=this.gltf.animations;return Xo(t)?this.adapter.getAnimations(t):null}_loadMeshes(t){this.meshes={};let e=[];return this.adapter.iterate(((n,i,r)=>{e.push(this._loadMesh(i,t).then((t=>{t.index=r,this.meshes[n]=t})))}),"meshes"),e=e.concat(this._loadSkins()),Promise.all(e)}_loadMesh(t,e){const n=t.primitives.map((t=>this._loadPrimitive(t,e))).filter((t=>!!t));return Promise.all(n).then((e=>{const n={};return Zo(n,t),n.primitives=e,n}))}_loadTextures(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter._getTexture(n));return Promise.all(e).then((e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t].image.array;if(e[t]&&n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},i=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[i[t]]=e[t]);return n}return e}))}_loadPrimitive(t,e){let n;const i=[],r=t.extensions;if(Xo(t.targets))for(let o=0;o<t.targets.length;o++){const e=t.targets[o];for(const t in e){const n=this.adapter.accessor._requestData(`morphTargets_${t}_${o}`,e[t]);n&&i.push(n)}}if(r&&r.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:o,attributes:s}=r.KHR_draco_mesh_compression,a=this.gltf.bufferViews[o],h=this._accessor._requestBufferOfBufferView(a).then((n=>{const{buffer:i,byteOffset:r}=n;let{byteOffset:o,byteLength:h}=a;o||(o=0);const l=new DataView(i,r+o,h),c={attributes:s,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(l,c).then((t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e}))}));i.push(h),n=Promise.all(i)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor._requestData(t,e[t]);n&&i.push(n)}if(Xo(t.indices)){const e=this.adapter.accessor._requestData("indices",t.indices);e&&i.push(e)}n=Promise.all(i)}return n.then((e=>{if(r&&r.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,i;const o={attributes:e.reduce(((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)i=i||{},i[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:i,array:r}=e,o=r.length/i;for(let e=0;e<o;e++)for(let o=0;o<i;o++){const s=e*i+o;r[s]<t[o]&&(t[o]=r[s]),r[s]>n[o]&&(n[o]=r[s])}if(e.quantization){const i=e.quantization,r=i.range/(1<<i.quantizationBits),o=i.minValues;rn(t,t,r),qe(t,t,o),rn(n,n,r),qe(n,n,o)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t}),{}),material:t.material};return n&&(o.indices=n),i&&(o.morphTargets=i),o.mode=Xo(t.mode)?t.mode:4,Xo(t.extras)&&(o.extras=t.extras),o}))}}function Cs(t,e){const n=new Image;n.crossOrigin="",n.onload=()=>{if(!As)return void e(new Error("There is no canvas to draw image!"));As.width=n.width,As.height=n.height;const t=As.getContext("2d",{willReadFrequently:!0});t.drawImage(n,0,0,n.width,n.height);const i=t.getImageData(0,0,n.width,n.height),r={width:n.width,height:n.height,data:new Uint8Array(i.data)};e(null,r)},n.onerror=function(t){e(t)},n.src=t}let Ss,Ps;function Rs(t,e){Ss||(Ss=new OffscreenCanvas(2,2),Ps=Ss.getContext("2d",{willReadFrequently:!0})),fetch(t).then((t=>t.arrayBuffer())).then((t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)})).then((t=>{let{width:n,height:i}=t;Os(n)||(n=Is(n)),Os(i)||(i=Is(i));const r=this.options.maxTextureSize;r&&(n=Math.min(r,n),i=Math.min(r,i)),Ss.width=n,Ss.height=i,Ps.drawImage(t,0,0,n,i),t.close();const o=Ps.getImageData(0,0,n,i);e(null,{width:n,height:i,data:new Uint8Array(o.data)})})).catch((t=>{console.warn(t),e(t)}))}function Os(t){return 0==(t&t-1)&&0!==t}function Is(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}class Ds{constructor(t,e){this.position=t,this.index=e,this.faces=[],this.neighbors=[]}addUniqueNeighbor(t){-1===this.neighbors.indexOf(t)&&this.neighbors.push(t)}}class ks{constructor(t,e,n,i){this.a=i.a,this.b=i.b,this.c=i.c,this.v1=t,this.v2=e,this.v3=n,this.normal=[],this.computeNormal(),t.faces.push(this),t.addUniqueNeighbor(e),t.addUniqueNeighbor(n),e.faces.push(this),e.addUniqueNeighbor(t),e.addUniqueNeighbor(n),n.faces.push(this),n.addUniqueNeighbor(t),n.addUniqueNeighbor(e)}computeNormal(){const t=this.v1.position,e=this.v2.position,n=this.v3.position,i=dn([],Pn([],n,e),Pn([],t,e));un(this.normal,i)}hasVertex(t){return t===this.v1||t===this.v2||t===this.v3}}const Ls=8,Fs=[],Ns=[],Bs=[],Hs=[];function js(t,e,n){const i=dn(Ns,e,n);t=Ni(t,zs(Fs,n[0],n[1],n[2],...i,...e)),t=Gs(t=or(t,t));const r=1/((1<<2*Ls-1)-1);if(t[3]<r){t[3]=r;const e=Math.sqrt(1-r*r);t[0]*=e,t[1]*=e,t[2]*=e}const o=n[3]>0?dn(Bs,n,e):dn(Bs,e,n);return fn(dn(Hs,n,e),o)<0&&Qi(t,t,-1),t}function zs(t,e,n,i,r,o,s,a,h,l){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=o,t[5]=s,t[6]=a,t[7]=h,t[8]=l,t}function Gs(t){return t[3]<0?Qi(t,t,-1):t}function Us(t,e){const n=[],i=[];let r=0;for(r=0;r<t.length;r+=3){const e=new Ds([t[r],t[r+1],t[r+2]],r/3);n.push(e)}if(!e.length){const t=e;e=[];for(let n=0;n<t;n++)e.push(n)}for(r=0;r<e.length/3;r++){const t={a:e[3*r],b:e[3*r+1],c:e[3*r+2]};new ks(n[t.a],n[t.b],n[t.c],t)}const o=[],s=[0,0,0];for(r=0;r<n.length;r++){const t=n[r],e=t.index;Ze(s,0,0,0);let a=t.faces.length;for(let n=0;n<a;n++)qe(s,s,t.faces[n].normal);a=a||1,Ze(o,a,a,a),Je(s,s,o),i[3*e]=s[0],i[3*e+1]=s[1],i[3*e+2]=s[2]}return i}function Vs(t,e,n,i){const r=t.length/3,o=new Array(4*r),s=[],a=[];for(let A=0;A<r;A++)s[A]=[0,0,0],a[A]=[0,0,0];const h=[0,0,0],l=[0,0,0],c=[0,0,0],u=[0,0],f=[0,0],d=[0,0],m=[0,0,0],g=[0,0,0];function p(e,i,r){Ws(h,t,3*e),Ws(l,t,3*i),Ws(c,t,3*r),Xs(u,n,2*e),Xs(f,n,2*i),Xs(d,n,2*r);const o=l[0]-h[0],p=c[0]-h[0],_=l[1]-h[1],v=c[1]-h[1],y=l[2]-h[2],x=c[2]-h[2],b=f[0]-u[0],w=d[0]-u[0],T=f[1]-u[1],M=d[1]-u[1],A=1/(b*M-w*T);Ze(m,(M*o-T*p)*A,(M*_-T*v)*A,(M*y-T*x)*A),Ze(g,(b*p-w*o)*A,(b*v-w*_)*A,(b*x-w*y)*A),qe(s[e],s[e],m),qe(s[i],s[i],m),qe(s[r],s[r],m),qe(a[e],a[e],g),qe(a[i],a[i],g),qe(a[r],a[r],g)}for(let A=0,E=i.length;A<E;A+=3)p(i[A+0],i[A+1],i[A+2]);const _=[],v=[],y=[],x=[];let b,w,T;function M(t){Ws(y,e,3*t),Xe(x,y),w=s[t],Xe(_,w),Pn(_,_,rn(y,y,fn(y,w))),un(_,_),dn(v,x,w),T=fn(v,a[t]),b=T<0?-1:1,o[4*t]=_[0],o[4*t+1]=_[1],o[4*t+2]=_[2],o[4*t+3]=b}for(let A=0,E=i.length;A<E;A+=3)M(i[A+0]),M(i[A+1]),M(i[A+2]);return o}function Ws(t,e,n){return t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2],t}function Xs(t,e,n){return t[0]=e[n],t[1]=e[n+1],t}function Zs(t){return!qs(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function qs(t){return null==t}function Ys(t){return!qs(t)}function Ks(t){return!qs(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const Js="function"==typeof Object.assign;function Qs(t){if(Js)Object.assign.apply(Object,arguments);else for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function $s(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)null!=n[e]&&(t[e]=n[e])}return t}function ta(t){return"number"==typeof t&&!isNaN(t)}function ea(t,e,n){return t*(1-n)+e*n}function na(t){return Array.isArray(t)||t instanceof Uint8Array||t instanceof Int8Array||t instanceof Uint16Array||t instanceof Int16Array||t instanceof Uint32Array||t instanceof Int32Array||t instanceof Uint8ClampedArray||t instanceof Float32Array||t instanceof Float64Array}function ia(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function ra(t,e,n){return Math.min(n,Math.max(e,t))}function oa(t){return t&&t.hasExtension("oes_vertex_array_object")}function sa(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function aa(t){if(t.data){if(t.data.BYTES_PER_ELEMENT)return t.data.length*t.data.BYTES_PER_ELEMENT;if(t.data.length)return 4*t.data.length}else{if(t.BYTES_PER_ELEMENT)return t.length*t.BYTES_PER_ELEMENT;if(t.length)return 4*t.length;if(t.buffer&&t.buffer.destroy)return t.buffer._buffer.byteLength}return 0}function ha(t){return t.width*t.height*ca(t.format)*la(t.type)*("textureCube"===t._reglType?6:1)}function la(t){return"uint8"===t?1:"uint16"===t||"float16"===t||"half float"===t?2:"uint32"===t||"float"===t||"float32"===t?4:0}function ca(t){return"depth"===t||"alpha"===t||"luminance"===t?1:"luminance alpha"===t||"depth stencil"===t?2:"srgba"===t||"rgb5 a1"===t||"rgba"===t.substring(0,4)?4:"srgb"===t||"rgb"===t.substring(0,3)?3:1}function ua(t){if(!t.componentType)return!1;const e=Es.getTypedArrayCtor(t.componentType);return t.byteStride>0&&t.byteStride!==t.itemSize*e.BYTES_PER_ELEMENT}function fa(t){return t&&(t.stride>0||ua(t))}function da(t){let e=0;const n=t&&t.length||0;if(!n)return e;let i;for(let r=0;r<n;r++)i=t.charCodeAt(r),e=(e<<5)-e+i,e&=e;return e}function ma(t){return 0==(t&t-1)&&0!==t}function ga(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}var pa=Object.freeze({__proto__:null,isString:Zs,isNil:qs,defined:Ys,isFunction:Ks,extend:Qs,extend1:$s,extend2:function(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)void 0===t[e]&&(t[e]=n[e])}return t},isNumber:ta,log2:function(t){if(Math.log2)return Math.log2(t);const e=Math.log(t)*Math.LOG2E,n=Math.round(e);return Math.abs(n-e)<1e-14?n:e},normalize:function(t,e){let n=0;for(let i=0,r=e.length;i<r;i++)n+=e[i];for(let i=0,r=e.length;i<r;i++)t[i]=e[i]/n;return t},interpolate:ea,isArray:na,lerp:function(t,e,n,i){for(let r=0;r<t.length;r++)t[r]=e[r]+i*(n[r]-e[r]);return t},set:function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t},getPosArrayType:ia,clamp:ra,isSupportVAO:oa,hasOwn:sa,getBufferSize:aa,getTexMemorySize:ha,getTextureByteWidth:la,getTextureChannels:ca,isInStride:ua,isInterleaved:fa,getSupportedFormats:function(t){return{etc:!!t.getExtension("WEBGL_compressed_texture_etc"),etc1:!!t.getExtension("WEBGL_compressed_texture_etc1"),s3tc:!!t.getExtension("WEBGL_compressed_texture_s3tc"),pvrtc:!!t.getExtension("WEBGL_compressed_texture_pvrtc"),astc:!!t.getExtension("WEBGL_compressed_texture_astc"),bc7:!!t.getExtension("EXT_texture_compression_bptc")}},hashCode:da,isPowerOfTwo:ma,floorPowerOfTwo:ga});const _a=t=>class extends t{on(t,e){return this._events||(this._events={type:[e]}),this._events[t]=this._events[t]||[],this._events[t].push(e),this}once(t,e){return this.on(t,this._wrapOnce(t,e))}off(t,e){return this._events&&this._events[t]?(this._events[t].splice(this._events[t].indexOf(e),1),this):this}fire(t,e={}){if(!this._events||!this._events[t])return this;e.target||(e.target=this);const n=this._events[t].slice(0);for(const i of n)i(e);return this}_wrapOnce(t,e){const n=this;let i=!1;return function r(o){i||(i=!0,e(o),n.off(t,r))}}},va="__reshader_disposed";var ya=Object.freeze({__proto__:null,KEY_DISPOSED:va,WEBGL_EXTENSIONS:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],WEBGL_OPTIONAL_EXTENSIONS:["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_texture_filter_anisotropic"]}),xa=_a(class{constructor(t,e){if(Ks(t)){this._texture=t,t=this.config={};for(const e in this._texture)sa(this._texture,e)&&(Ks(this._texture[e])||(t[e]=this._texture[e]))}else if(this.config=t||{},this.resLoader=e,!t.url&&!t.promise||t.data)t.data&&this._needPowerOf2()&&(t.data instanceof Image&&(t.data=ba(t.data),t.width=t.data.width,t.height=t.data.height),t.hdr||!na(t.data)||ma(t.width)&&ma(t.height)||(t.data=function(t,e,n){let i=e,r=n;ma(e)||(i=ga(e)),ma(n)||(r=ga(n));const o=new ImageData(new Uint8ClampedArray(t),e,n),s=document.createElement("canvas");s.width=e,s.height=n,s.getContext("2d").putImageData(o,0,0);const a=document.createElement("canvas");return a.width=i,a.height=r,a.getContext("2d").drawImage(s,0,0,i,r),console.warn(`Texture's size is not power of two, resize from (${e}, ${n}) to (${i}, ${r})`),a}(t.data,t.width,t.height),t.width=t.data.width,t.height=t.data.height));else{this._loading=!0;const n=this;let i;if(t.promise)i=t.promise;else{let n;n=t.arrayBuffer?e.getArrayBuffer:e.get,i=n.call(e,t.url)}t.data=e.getDefaultTexture(t.url),this.promise=i,i.then((t=>(delete this.promise,n._loading=!1,n.config?(t.data instanceof Image&&this._needPowerOf2()&&(t.data=ba(t.data)),n.onLoad(t),Array.isArray(t)||(t=[t]),n.fire("complete",{target:this,resources:t}),t):t))).catch((t=>{console.error("error when loading texture image.",t),n.fire("error",{target:this,error:t})}))}}isReady(){return!this._loading}set(t,e){return this.config[t]=e,this.dirty=!0,this}get(t){return this.config[t]}getREGLTexture(t){return this._texture||(this._texture=this.createREGLTexture(t),this.config.persistent||(this.config.data&&(this.config.data instanceof ImageBitmap&&this.config.data.close(),this.config.data=[]),this.config.faces&&(this.config.faces=[]),this.config.image&&(this.config.image.array=[]),this.config.mipmap&&delete this.config.mipmap)),this.dirty&&this._updateREGL(),this._texture}getMemorySize(){if(!this.config)return 0;const{width:t,height:e,type:n,format:i}=this.config,r=la(n||"uint8"),o=ca(i||"rgba");return this.config.faces?t*e*r*o*6:t*e*r*o}_updateREGL(){this._texture&&!this._texture[va]&&this._texture(this.config),this.dirty=!1}dispose(){this.config&&this.config.url&&(URL.revokeObjectURL(this.config.url),this.resLoader.disposeRes(this.config.url)),this._texture&&!this._texture[va]&&(this._texture._reshader_refCount&&this._texture._reshader_refCount--,this._texture._reshader_refCount||(this._texture.destroy(),this._texture[va]=!0,delete this._texture)),delete this.resLoader;const t=this.config&&this.config.url;delete this.config,t&&this.fire("disposed",{target:this,url:t})}_needPowerOf2(){const t=this.config;return t.wrap&&"clamp"!==t.wrap||t.wrapS&&"clamp"!==t.wrapS||t.wrapT&&"clamp"!==t.wrapT||t.min&&"nearest"!==t.min&&"linear"!==t.min}});function ba(t){if(ma(t.width)&&ma(t.height))return t;let e=t.width,n=t.height;ma(e)||(e=ga(e)),ma(n)||(n=ga(n));const i=document.createElement("canvas");i.width=e,i.height=n,i.getContext("2d").drawImage(t,0,0,e,n);const r=t.src,o=r.lastIndexOf("/")+1,s=r.substring(o);return console.warn(`Texture(${s})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),i}const wa={};class Ta{constructor(t){this.regl=t}render(t,e,n,i){t.setUniforms(e||wa),t.setFramebuffer(i);let r=0;if(n){const{opaques:e,transparents:i}=n.getSortedMeshes();r+=t.draw(this.regl,e),r+=t.draw(this.regl,i)}else r+=t.draw(this.regl);return r}clear(t){this.regl.clear(t)}}class Ma extends Ta{}const Aa=[],Ea=$t([]),Ca={min:[],max:[]};class Sa{constructor(t,e){this.min=t||[1/0,1/0,1/0],this.max=e||[-1/0,-1/0,-1/0],this.updateVertex()}static copy(t,e){Xe(t.min,e.min),Xe(t.max,e.max);for(let n=0;n<e.vertex.length;n++)Xe(t.vertex[n],e.vertex[n]);return t}combine(t){return t?(Array.isArray(t)&&(Xe(Ca.min,t[0]),Xe(Ca.max,t[1]),t=Ca),t.min[0]<this.min[0]&&(this.min[0]=t.min[0],this._dirty=!0),t.min[1]<this.min[1]&&(this.min[1]=t.min[1],this._dirty=!0),t.min[2]<this.min[2]&&(this.min[2]=t.min[2],this._dirty=!0),t.max[0]>this.max[0]&&(this.max[0]=t.max[0],this._dirty=!0),t.max[1]>this.max[1]&&(this.max[1]=t.max[1],this._dirty=!0),t.max[2]>this.max[2]&&(this.max[2]=t.max[2],this._dirty=!0),this):this}dirty(){return this._dirty=!0,this}getCenter(){return this.center||(this.center=[],this._dirty=!0),this._dirty&&(qe(this.center,this.min,this.max),rn(this.center,this.center,.5)),this._dirty=!1,this.center}containPoint(t){const e=this.min,n=this.max;return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&n[0]>=t[0]&&n[1]>=t[1]&&n[2]>=t[2]}isFinite(){const t=this.min,e=this.max;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])}updateVertex(){if(!this.vertex){this.vertex=[];for(let t=0;t<8;t++)this.vertex.push([])}return this.vertex[0][0]=this.min[0],this.vertex[0][1]=this.min[1],this.vertex[0][2]=this.min[2],this.vertex[1][0]=this.min[0],this.vertex[1][1]=this.min[1],this.vertex[1][2]=this.max[2],this.vertex[2][0]=this.min[0],this.vertex[2][1]=this.max[1],this.vertex[2][2]=this.max[2],this.vertex[3][0]=this.min[0],this.vertex[3][1]=this.max[1],this.vertex[3][2]=this.min[2],this.vertex[4][0]=this.max[0],this.vertex[4][1]=this.min[1],this.vertex[4][2]=this.min[2],this.vertex[5][0]=this.max[0],this.vertex[5][1]=this.min[1],this.vertex[5][2]=this.max[2],this.vertex[6][0]=this.max[0],this.vertex[6][1]=this.max[1],this.vertex[6][2]=this.max[2],this.vertex[7][0]=this.max[0],this.vertex[7][1]=this.max[1],this.vertex[7][2]=this.min[2],this.vertex}copy(){return new Sa(this.min.slice(),this.max.slice())}equals(t){if(!Cn(this.min,t.min)||!Cn(this.max,t.max))return!1;const e=t.vertex;for(let n=0;n<this.vertex.length;n++)if(!Cn(e[n],this.vertex[n]))return!1;return!0}transform(t,e){if(t=t||Ea,(e=e||Ea)[1]||e[2]||e[4]||e[6]||e[8]||e[9]){const n=this.vertex,i=re(Aa,e,t);for(let t=0;t<n.length;t++)vn(this.vertex[t],this.vertex[t],i);const r=this.vertex.map((t=>t[0])),o=this.vertex.map((t=>t[1])),s=this.vertex.map((t=>t[2])),a=Math.min(...r),h=Math.max(...r),l=Math.min(...o),c=Math.max(...o),u=Math.min(...s),f=Math.max(...s);Ze(this.min,a,l,u),Ze(this.max,h,c,f)}else{const n=re(Aa,e,t);vn(this.min,this.min,n),vn(this.max,this.max,n)}return this}}const Pa=[],Ra={5120:"int8",5122:"int16",5124:"int32",5121:"uint8",5123:"uint16",5125:"uint32",5126:"float"},Oa={5120:1,5122:2,5124:4,5121:1,5123:2,5125:4,5126:4},Ia={positionSize:3,primitive:"triangles",positionAttribute:"aPosition",normalAttribute:"aNormal",uv0Attribute:"aTexCoord",uv1Attribute:"aTexCoord1",color0Attribute:"aColor0",tangentAttribute:"aTangent",pickingIdAttribute:"aPickingId"};let Da=1;const ka="_reshader_refCount";class La{constructor(t,e,n,i){this._version=0,this.data=t,this.elements=e,this.desc=Qs({},Ia,i);const r=t[this.desc.positionAttribute];n||(e?n=Fa(e):r&&r.length?n=r.length/this.desc.positionSize:r&&r.interleavedArray?n=r.interleavedArray.length/this.desc.positionSize:r&&r.array&&(n=r.array.length/this.desc.positionSize)),this.count=n,this.elements||(this.elements=n),this.properties={},this._buffers={},this._vao={},this.getVertexCount(),this._prepareData(),this.updateBoundingBox()}set version(t){throw new Error("Geometry.version is read only.")}get version(){return this._version}_prepareData(){if(!this.data)return;const t=this._buffers||{};for(const n in this.data){const e=this.data[n];if(e)if(e.buffer&&e.buffer.destroy){const t=e.buffer;t[ka]||(t[ka]=0),t[ka]++}else if(e&&e.array)if(ua(e)){let i=e.array.buffer.__id;i||(i=e.array.buffer.__id=Da++),this.data[n]={buffer:i,offset:e.byteOffset,stride:e.byteStride,type:Ra[e.componentType],size:e.itemSize,count:e.count,componentType:e.componentType},t[i]||(t[i]={data:e.array.buffer})}else this.data[n]=e.array}this._buffers=t;const e=this.elements;e&&e.array&&(this.elements=this.elements.array)}getAttrData(t){const e=t.key,n=!this._reglData||!this._reglData[e];if(this._reglData||(this._reglData={}),n){const t=this._reglData[e]={},n=this.data,{positionAttribute:i,normalAttribute:r,uv0Attribute:o,uv1Attribute:s,tangentAttribute:a,color0Attribute:h,pickingIdAttribute:l}=this.desc;Qs(t,this.data),t.aPosition=n[i],n[r]&&(t.aNormal=n[r]),n[o]&&(t.aTexCoord=n[o]),n[s]&&(t.aTexCoord1=n[s]),n[a]&&(t.aTangent=n[a]),n[h]&&(t.aColor0=n[h]),n[l]&&(t.aPickingId=n[l])}return this._reglData[e]}getREGLData(t,e,n){this.getAttrData(e);const i=!this._reglData||!this._reglData[e.key];if(oa(t)&&!n){const n=e&&e.key||"default";if(!this._vao[n]||i||this._elementsUpdated){const i=this._reglData[e.key],r=this._vertexCount,o=[];for(let t=0;t<e.length;t++){const n=e[t].name,s=i[n]&&i[n].buffer;if(s&&s.destroy)o.push(void 0!==i[n].stride?i[n]:s);else{const t=i[n];if(!t){o.push(this.desc.fillEmptyDataInMissingAttribute?new Uint8Array(4*r):Pa);continue}const e=(t.data&&na(t.data)?t.data.length:t.length)/r;t.data?(t.dimension=e,o.push(t)):o.push({data:t,dimension:e})}}const s={attributes:o,primitive:this.getPrimitive()};if(this.elements&&!ta(this.elements))if(this.elements.destroy)s.elements=this.elements;else{s.elements={primitive:this.getPrimitive(),data:this.elements};const t=this.getElementsType(this.elements);t&&(s.elements.type=t)}this._vao[n]?this._vao[n].vao(s):this._vao[n]={vao:t.vao(s)},delete this._elementsUpdated}return this._vao[n]}return this._reglData[e.key]}_isAttrChanged(t){if(t===this._activeAttributes)return!1;if(t.length!==this._activeAttributes.length)return!0;for(let e=0;e<t.length;e++)if(t[e]!==this._activeAttributes[e])return!0;return!1}generateBuffers(t){const e=this._buffers;for(const o in e)e[o].buffer||(e[o].buffer=t.buffer(e[o].data)),delete e[o].data;const n=this.data,i=this._vertexCount,r={};for(const o in n)if(n[o]){if(void 0===n[o].buffer||n[o].buffer instanceof ArrayBuffer){const e=n[o].data?n[o]:{data:n[o]};e.dimension=(n[o].data?n[o].data:n[o]).length/i;const s=t.buffer(e);s[ka]=1,r[o]={buffer:s}}else n[o].buffer.destroy?r[o]=n[o]:e[n[o].buffer]&&(r[o]=Qs({},n[o]),r[o].buffer=e[n[o].buffer].buffer);delete n[o].array}if(this.data=r,delete this._reglData,this.elements&&!ta(this.elements)){const e={primitive:this.getPrimitive(),data:this.elements},n=this.getElementsType(this.elements);n&&(e.type=n),this.elements=this.elements.destroy?this.elements:t.elements(e);const i=this.elements;i[ka]||(i[ka]=0),i[ka]++}}getVertexCount(){const{positionAttribute:t,positionSize:e,color0Attribute:n}=this.desc;let i=this.data[t];i.data&&(i=i.data),i.array&&(i=i.array),na(i)?this._vertexCount=Math.ceil(i.length/e):i&&void 0!==i.count&&(this._vertexCount=i.count);const r=n;if(this.data[r]){const t=this.data[r].data||this.data[r].array||this.data[r];Array.isArray(t)?this._color0Size=t.length/this._vertexCount:t&&t.count?this._color0Size=t.count/this._vertexCount:this.data[r].buffer&&this.data[r].buffer.destroy&&(this._color0Size=this.data[r].buffer._buffer.dimension)}return this._vertexCount}getColor0Size(){return this._color0Size||0}addBuffer(t,e){return this._buffers[t]={data:e},delete this._reglData,this._deleteVAO(),this}updateBuffer(t,e){if(!this._buffers[t])throw new Error(`invalid buffer ${t} in geometry`);return this._buffers[t].buffer?this._buffers[t].buffer.subdata(e):this._buffers[t].data=e,delete this._reglData,this._deleteVAO(),this}updateData(t,e){const n=this.data[t];if(!n)return this;let i;this._incrVersion(),this.data[t]=e,n.buffer&&n.buffer.destroy&&(i=n);const r=this._vertexCount;t===this.desc.positionAttribute&&this.updateBoundingBox();const o=this.getVertexCount();return i&&(o<=r?i.buffer.subdata(e):i.buffer(e),this.data[t]=i),this._prepareData(),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}updateSubData(t,e,n){const i=this.data[t];if(!i)return this;let r;if(this._incrVersion(),i.buffer&&i.buffer.destroy&&(r=i),t===this.desc.positionAttribute&&this._updateSubBoundingBox(e),r){const t=Oa[r.buffer._buffer.dtype];e.BYTES_PER_ELEMENT!==t&&(e=new(function(t,e){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Uint8ClampedArray?1===e?Uint8Array:2===e?Uint16Array:Uint32Array:t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array?1===e?Int8Array:2===e?Int16Array:Int32Array:t instanceof Float32Array||t instanceof Float64Array?4===e?Float32Array:Float64Array:void 0}(e,t))(e)),r.buffer.subdata(e,n*t)}else{const i=this.data[t].data?this.data[t].data:this.data[t];for(let t=0;t<e.length;t++)i[n+t]=e[t]}return this._prepareData(),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}getPrimitive(){return this.desc.primitive}getElements(){return this.elements}setElements(t,e){if(!t)throw new Error("elements data is invalid");this._incrVersion();const n=this.elements;return this.count=void 0===e?Fa(t):e,this.elements=t&&t.destroy?t:n.destroy?n(t):t,this._elementsUpdated=!0,this}setDrawCount(t){return this._incrVersion(),this.count1=t,this}getDrawCount(){return this.count1||this.count}setDrawOffset(t){return this._incrVersion(),this.offset=t,this}getDrawOffset(){return this.offset||0}dispose(){this._deleteVAO(),this._forEachBuffer((t=>{if(!t[va]){let e=t[ka];e&&e--,e<=0?(t[va]=!0,t.destroy()):t[ka]=e}})),this.data={},this._buffers={},delete this._reglData,delete this._attributes,this.count=0,this.elements=[],delete this._tempPosArray,this._disposed=!0}isDisposed(){return!!this._disposed}updateBoundingBox(){let t=this.boundingBox;t||(t=this.boundingBox=new Sa);let e,n,i=this.data[this.desc.positionAttribute];if(na(i)||(i.data?i=i.data:fa(i)?i=this._getAttributeData(this.desc.positionAttribute):i.array&&(e=i.min,n=i.max,i=i.array)),i&&i.length){const r=t.min,o=t.max;if(e&&n)Ze(r,...e),Ze(o,...n);else{Ze(r,i[0],i[1],i[2]),Ze(o,i[0],i[1],i[2]);for(let t=3;t<i.length;){const e=i[t++],n=i[t++],s=i[t++];e<r[0]&&(r[0]=e),n<r[1]&&(r[1]=n),s<r[2]&&(r[2]=s),e>o[0]&&(o[0]=e),n>o[1]&&(o[1]=n),s>o[2]&&(o[2]=s)}}t.updateVertex(),t.dirty()}}_updateSubBoundingBox(t){const e=this.boundingBox,n=e.min,i=e.max;for(let r=0;r<t.length;){const e=t[r++],o=t[r++],s=t[r++];e<n[0]&&(n[0]=e),o<n[1]&&(n[1]=o),s<n[2]&&(n[2]=s),e>i[0]&&(i[0]=e),o>i[1]&&(i[1]=o),s>i[2]&&(i[2]=s)}e.updateVertex(),e.dirty()}_getAttributeData(t){const e=this.data[t],n=e.buffer;if(fa(e)){const i=this._buffers[n]?this._buffers[n].data:e.array,{count:r,size:o,stride:s,offset:a,componentType:h}=e,l=Es.getTypedArrayCtor(h);if((0===s||s===o*l.BYTES_PER_ELEMENT)&&a%l.BYTES_PER_ELEMENT==0)return new l(i,a,r*o);if(t===this.desc.positionAttribute)return!this._tempPosArray||this._tempPosArray&&this._tempPosArray.length<o*r?(this._tempPosArray=new l(o*r),Es.readInterleavedArray(this._tempPosArray,i,r,o,s,a,h)):this._posDirty?(this._posDirty=!1,Es.readInterleavedArray(this._tempPosArray,i,r,o,s,a,h)):this._tempPosArray;{const t=new l(o*r);return Es.readInterleavedArray(t,i,r,o,s,a,h)}}return e}createTangent(t="aTangent"){this._incrVersion();const{normalAttribute:e,positionAttribute:n,uv0Attribute:i}=this.desc,r=this._getAttributeData(e),o=Vs(this._getAttributeData(n),r,this.data[i],this.elements),s=this.data[t]=new Float32Array(o.length),a=[],h=[],l=[];for(let c=0;c<o.length;c+=4){const t=c/4*3;Ze(h,r[t],r[t+1],r[t+2]),Gn(a,o[c],o[c+1],o[c+2],o[c+3]),js(l,h,a),zn(s.subarray(c,c+4),l)}delete this._reglData}createNormal(t="aNormal"){this._incrVersion();const e=this._getAttributeData(this.desc.positionAttribute);this.data[t]=Us(e.array||e,this.elements),delete this._reglData}createBarycentric(t="aBarycentric"){if("triangles"!==this.desc.primitive)throw new Error("Primitive must be triangles to create bary centric data");this._incrVersion();const e=new Uint8Array(3*this._vertexCount);for(let n=0,i=this.elements.length;n<i;)for(let t=0;t<3;t++)e[3*this.elements[n++]+t]=1;this.data[t]=e,delete this._reglData}buildUniqueVertex(){this._incrVersion();const t=this.data,e=this.elements;if(!na(e))throw new Error("elements must be array to build unique vertex.");const n=Object.keys(t),i={};let r=t[this.desc.positionAttribute];if(r=r.length?r:r.array,!na(r))throw new Error(this.desc.positionAttribute+" must be array to build unique vertex.");const o=this._vertexCount,s=e.length;for(let h=0;h<n.length;h++){const e=n[h],r=na(t[e])?t[e]:t[e].array,a=r.length/o;if(!na(r))throw new Error(e+" must be array to build unique vertex.");i[e]=r,i[e].size=a,t[e]=new r.constructor(s*a)}let a=0;for(let h=0;h<s;h++){const r=e[h];for(let e=0;e<n.length;e++){const o=n[e],s=t[o],h=i[o].size;for(let t=0;t<h;t++)s[a*h+t]=i[o][r*h+t]}e[h]=a++}delete this._reglData}getMemorySize(){let t=0;for(const e in this.data)sa(this.data,e)&&(t+=aa(this.data[e]));if(this.elements){const e=this.elements;e.destroy?t+=e._elements.buffer.byteLength:e.BYTES_PER_ELEMENT?t+=e.length*e.BYTES_PER_ELEMENT:e.length&&(t+=4*e.length)}return t}_deleteVAO(){for(const t in this._vao)this._vao[t].vao.destroy();this._vao={}}_forEachBuffer(t){this.elements&&this.elements.destroy&&t(this.elements);for(const e in this.data)sa(this.data,e)&&this.data[e]&&this.data[e].buffer&&this.data[e].buffer.destroy&&t(this.data[e].buffer);for(const e in this._buffers)sa(this._buffers,e)&&this._buffers[e]&&this._buffers[e].buffer&&this._buffers[e].buffer.destroy&&t(this._buffers[e].buffer)}getElementsType(t){return t instanceof Uint8Array?"uint8":t instanceof Uint16Array?"uint16":t instanceof Uint32Array?"uint32":void 0}_incrVersion(){this._version++}}function Fa(t){if(ta(t))return t;if(void 0!==t.count)return t.count;if(t.destroy)return t._elements.vertCount;if(void 0!==t.length)return t.length;if(t.data)return t.data.length;throw new Error("invalid elements length")}var Na=_a(class{constructor(t={},e){this._version=0,this.uniforms=$s({},e||{},t);for(const n in t){const e=Object.getOwnPropertyDescriptor(t,n).get;e&&Object.defineProperty(this.uniforms,n,{get:e})}this._reglUniforms={},this.refCount=0,this._bindedOnTextureComplete=this._onTextureComplete.bind(this),this._genUniformKeys(),this._checkTextures()}set version(t){throw new Error("Material.version is read only.")}get version(){return this._version}isReady(){return this._loadingCount<=0}set(t,e){const n=qs(this.uniforms[t])&&!qs(e)||!qs(this.uniforms[t])&&qs(e);return this.uniforms[t]&&this.isTexture(t)&&this.uniforms[t].dispose(),qs(e)?qs(this.uniforms[t])||delete this.uniforms[t]:this.uniforms[t]=e,this._dirtyUniforms=!0,this.isTexture(t)&&this._checkTextures(),n&&(this._genUniformKeys(),this._incrVersion()),this}get(t){return this.uniforms[t]}isDirty(){return this._uniformVer!==this.version}appendDefines(t){const e=this.uniforms;return e.jointTexture&&(t.HAS_SKIN=1),e.morphWeights1&&(t.HAS_MORPH=1),(e.khr_offset||e.khr_rotation||e.khr_scale)&&(t.HAS_KHR_TEXTURE_TRANSFORM=1),t}hasSkinAnimation(){return this.uniforms.jointTexture&&this.uniforms.skinAnimation}getUniforms(t){if(this._reglUniforms&&!this.isDirty())return this._reglUniforms;const e=this.uniforms,n={};for(const i in e)this.isTexture(i)?Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return e[i].getREGLTexture(t)}}):Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return e[i]}});return this._reglUniforms=n,this._uniformVer=this.version,n}isTexture(t){return this.uniforms[t]instanceof xa}dispose(){for(const t in this.uniforms){const e=this.uniforms[t];e&&(e.dispose?e.dispose():e.destroy&&!e[va]&&(e.destroy(),e[va]=!0))}delete this.uniforms,delete this._reglUniforms,this._disposed=!0}isDisposed(){return!!this._disposed}_checkTextures(){this._loadingCount=0;for(const t in this.uniforms)if(this.isTexture(t)){const e=this.uniforms[t];e.isReady()||(this._loadingCount++,e.on("complete",this._bindedOnTextureComplete))}}_onTextureComplete(){this._loadingCount--,this._incrVersion(),this._loadingCount<=0&&(this._disposed||this.fire("complete"))}getUniformKeys(){return this._uniformKeys}_genUniformKeys(){const t=[];for(const e in this.uniforms)sa(this.uniforms,e)&&!qs(this.uniforms[e])&&t.push(e);this._uniformKeys=t.join()}_incrVersion(){this._version++}getMemorySize(){const t=this.uniforms;let e=0;for(const n in t)this.isTexture(n)?e+=t[n].getMemorySize():this.uniforms[n].destroy&&(e+=ha(this.uniforms[n]));return e}});const Ba={time:0,seeThrough:!0,thickness:.03,fill:[1,.5137254902,.98,1],stroke:[.7019607843,.9333333333,.2274509804,1],dashEnabled:!1,dashAnimate:!1,dashRepeats:1,dashLength:.8,dashOverlap:!0,insideAltColor:!1,squeeze:!1,squeezeMin:.5,squeezeMax:1,dualStroke:!1,secondThickness:.05,opacity:1,noiseEnable:!1};class Ha extends Na{constructor(t){super(t,Ba)}}const ja={baseColorFactor:[1,1,1,1],materialShininess:32,environmentExposure:1,specularStrength:32,opacity:1,extrusionOpacity:0,extrusionOpacityRange:[0,1.8],baseColorTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null,uvScale:[1,1],uvOffset:[0,0]};class za extends Na{constructor(t){super(t,ja)}static convertFrom(t){const e={};for(const n in ja)e[n]=t.get(n);return new za(e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t):t}}const Ga={toons:4,specularToons:2};class Ua extends za{constructor(t){super(t,Ga)}}const Va={diffuseFactor:[1,1,1,1],specularFactor:[1,1,1],glossinessFactor:1,diffuseTexture:null,specularGlossinessTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null},Wa=t=>class extends t{constructor(t){super(t=Qs({},Va,t||{}))}appendDefines(t,e){if(super.appendDefines(t,e),t.SHADING_MODEL_SPECULAR_GLOSSINESS=1,!e.data[e.desc.uv0Attribute])return t;const n=this.uniforms;return n.diffuseTexture&&(t.HAS_DIFFUSE_MAP=1),n.specularGlossinessTexture&&(t.HAS_SPECULARGLOSSINESS_MAP=1),(t.HAS_SPECULARGLOSSINESS_MAP||t.HAS_DIFFUSE_MAP)&&(t.HAS_MAP=1),t}};class Xa extends(Wa(za)){}const Za=[];let qa=0;class Ya{constructor(t,e,n={}){this._version=0,this._geometry=t,this._material=e,this.transparent=!!n.transparent,this.bloom=!!n.bloom,this.ssr=!!n.ssr,this.castShadow=qs(n.castShadow)||n.castShadow,this.picking=!!n.picking,this.disableVAO=!!n.disableVAO,this.uniforms={},this._localTransform=$t(new Array(16)),this._positionMatrix=$t(new Array(16)),this.properties={},this._dirtyUniforms=!0,this._dirtyGeometry=!0,Object.defineProperty(this,"uuid",{value:qa++}),qa>Number.MAX_VALUE-10&&(qa=0)}set material(t){this._material!==t&&this.setMaterial(t)}get material(){return this._material}set version(t){throw new Error("Mesh.version is read only.")}get version(){return this._version}get geometry(){return this._geometry}set geometry(t){this._geometry!==t&&(this._incrVersion(),this._dirtyGeometry=!0),this._geometry=t}set localTransform(t){this._prevTMat||(this._prevTMat=[]),Array.isArray(t)&&!Ne(this._prevTMat,t)&&(this._incrVersion(),this._prevTMat=Kt(this._prevTMat,t)),this._localTransform=t}get localTransform(){return this._localTransform}set positionMatrix(t){this._prevPMat||(this._prevPMat=[]),Array.isArray(t)&&!Ne(this._prevPMat,t)&&(this._incrVersion(),this._prevPMat=Kt(this._prevPMat,t)),this._positionMatrix=t}get positionMatrix(){return this._positionMatrix}get config(){return this._cfg||(this._cfg={}),this._cfg.transparent=this.transparent,this._cfg.castShadow=this.castShadow,this._cfg.bloom=this.bloom,this._cfg.ssr=this.ssr,this._cfg.picking=this.picking,this._cfg}get defines(){return this._getDefines()}set defines(t){this.setDefines(t)}setMaterial(t){return this._material=t,this._dirtyUniforms=!0,delete this._materialVer,this.dirtyDefines=!0,this}setParent(t){return this.parent=t,this}setLocalTransform(t){return this.localTransform=t,this}setPositionMatrix(t){this.positionMatrix=t}setUniform(t,e){return void 0===this.uniforms[t]&&(this._dirtyUniforms=!0),this.uniforms[t]=e,this}getUniform(t){return this.uniforms[t]}getDefines(){const t={};return Qs(t,this._getDefines()),this._material&&this._geometry&&this._material.appendDefines(t,this._geometry),t}_getDefines(){this._defines||(this._defines={});const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],i=t.data[t.desc.normalAttribute];return e&&e.quantization&&(this._defines.HAS_DECODE_POSITION=1),n&&n.quantization&&(this._defines.HAS_DECODE_TEXCOORD=1),i&&i.quantization&&(this._defines.HAS_DECODE_NORMAL=1),this._defines}setDefines(t){const e=this._bakDefines;return this._defines=t,this.dirtyDefines=this.dirtyDefines||!!e!=!!t||!function(t,e){if(!t&&!e)return!0;const n=Object.getOwnPropertyNames(t),i=Object.getOwnPropertyNames(e);if(n.length!==i.length)return!1;for(let r=0;r<n.length;r++)if(t[n[r]]!==e[n[r]])return!1;return!0}(e,t),this.dirtyDefines&&(this._bakDefines=Qs({},t)),this}hasSkinAnimation(){return this._material&&this._material.hasSkinAnimation()}_getDefinesKey(){return this.dirtyDefines=!1,this._createDefinesKey(this.getDefines())}getCommandKey(){if(!this._commandKey||this.dirtyDefines||this._material&&this._materialKeys!==this._material.getUniformKeys()){let t=this._getDefinesKey();t+="_"+(ta(this.getElements())?"count":"elements"),t+="_"+ +!!this.disableVAO,this._commandKey=t,this._material&&(this._materialKeys=this._material.getUniformKeys())}return this._commandKey}getUniforms(t){if(this._dirtyUniforms||this._dirtyGeometry||this._material&&this._materialVer!==this._material.version){if(this._realUniforms={},this._getUniformsForDraco(),this._material){const e=this._material.getUniforms(t);for(const t in e)sa(e,t)&&Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}})}const e=this.uniforms;for(const t in this.uniforms)sa(this.uniforms,t)&&Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}});this._dirtyUniforms=!1,this._dirtyGeometry=!1,this._materialVer=this._material&&this._material.version}return this._realUniforms.modelMatrix=Ks(this._localTransform)?this._localTransform():this._localTransform,this._realUniforms.positionMatrix=Ks(this._positionMatrix)?this._positionMatrix():this._positionMatrix,this._realUniforms}_getUniformsForDraco(){const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],i=t.data[t.desc.normalAttribute];if(e&&e.quantization){const t=e.quantization,n=t.range/(1<<t.quantizationBits);this._defineUniformsProperty(this._realUniforms,"minValues_pos",t.minValues),this._defineUniformsProperty(this._realUniforms,"gltf_u_dec_position_normConstant",n)}if(n&&n.quantization){const t=n.quantization;this._defineUniformsProperty(this._realUniforms,"minValues_tex",t.minValues),this._defineUniformsProperty(this._realUniforms,"gltf_u_dec_texcoord_0_normConstant",t.range/(1<<t.quantizationBits))}i&&i.quantization&&this._defineUniformsProperty(this._realUniforms,"gltf_u_dec_normal_rangeConstant",(1<<i.quantization.quantizationBits)-1)}_defineUniformsProperty(t,e,n){Ys(t[e])||Object.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return n}})}getMaterial(){return this._material}getElements(){return this._geometry.getElements()}_getREGLAttrData(t,e){return this._geometry.getREGLData(t,e,this.disableVAO)}getREGLProps(t,e){const n=this.getUniforms(t);return Qs(n,this._getREGLAttrData(t,e)),oa(t)&&!this.disableVAO||(n.elements=this._geometry.getElements()),n.meshProperties=this.properties,n.meshConfig=this.config,n.count=this._geometry.getDrawCount(),n.offset=this._geometry.getDrawOffset(),n.primitive=this._geometry.getPrimitive(),n}dispose(){const t=this.properties.oldElementsBeforeHighlight;return t&&(t.destroy&&t.destroy(),delete this.properties.oldElementsBeforeHighlight,delete this.properties.hasInvisible),delete this._geometry,delete this._material,this.uniforms={},this}isValid(){return this._geometry&&!this._geometry.isDisposed()&&(!this._material||!this._material.isDisposed())}getBoundingBox(){return this._bbox||this.updateBoundingBox(),re(Za,this._localTransform,this._positionMatrix),Ne(Za,this._currentTransform)&&this._geometry.boundingBox.equals(this._geoBox)||this.updateBoundingBox(),this._bboxArr}updateBoundingBox(){const t=this._geometry.boundingBox;this._bbox||(this._bbox=new Sa),this._bboxArr||(this._bboxArr=[[],[]]),this._geoBox||(this._geoBox=new Sa),Sa.copy(this._bbox,t),this._bbox.updateVertex(),"InstancedMesh"===this.constructor.name?(this._bbox.transform(this._localTransform,this._positionMatrix),this._currentTransform=re(this._currentTransform||[],this._positionMatrix,this._localTransform)):(this._bbox.transform(this._positionMatrix,this._localTransform),this._currentTransform=re(this._currentTransform||[],this._localTransform,this._positionMatrix)),Sa.copy(this._geoBox,t),Xe(this._bboxArr[0],this._bbox.min),Xe(this._bboxArr[1],this._bbox.max)}_createDefinesKey(t){const e=[];for(const n in t)e.push(n,t[n]);return e.join(",")}_incrVersion(){this._version++}getMemorySize(){return(this.geometry&&this.geometry.getMemorySize()||0)+(this.material&&this.material.getMemorySize()||0)}}Ya.prototype.getWorldTransform=function(){const t=[];return function(){const e=this.parent;return e?re(t,e.getWorldTransform(),this._localTransform):this._localTransform}}();class Ka extends Ya{constructor(t,e,n,i,r={}){super(n,i,r),this._instanceCount=e,this.instancedData=t||{},this._checkInstancedProp(),this._vao={}}get instanceCount(){return this._instanceCount}set instanceCount(t){this._incrVersion(),this._instanceCount=t}getMemorySize(){return super.getMemorySize()+this._getInstanceMemorySize()}_getInstanceMemorySize(){let t=0;for(const e in this.instancedData)sa(this.instancedData,e)&&(t+=aa(this.instancedData[e]));return t}_checkInstancedProp(){for(const t in this.instancedData)if(this.geometry.data[t])throw new Error(`Duplicate attribute ${t} defined in geometry and instanced data`)}_getREGLAttrData(t,e){const n=this.geometry.getAttrData(e);if(oa(t)){const i=e.key;if(!this._vao[i]||this._instanceDataUpdated){const r=e.map((t=>t.name)),o=[];for(let t=0;t<r.length;t++){const e=n[r[t]];o.push(e&&e.buffer?e.buffer:this.instancedData[r[t]])}const s={attributes:o,primitive:this.geometry.getPrimitive()};this._vao[i]?this._vao[i].vao(s):this._vao[i]={vao:t.vao(s)},delete this._instanceDataUpdated}return this._vao[i]}return n}getDefines(){const t=super.getDefines();return t.HAS_INSTANCE=1,t}getCommandKey(t){return"i_"+super.getCommandKey(t)}updateInstancedData(t,e){const n=this.instancedData[t];return n?(this._incrVersion(),this.instancedData[t]=e,n.buffer&&n.buffer.destroy&&n.buffer.destroy(),this._instanceDataUpdated=!0,this):this}generateInstancedBuffers(t){const e=this.instancedData,n={};for(const i in e)e[i]&&(void 0!==e[i].buffer&&e[i].buffer.destroy?(n[i]=e[i],n[i].divisor&&(n[i].divisor=1)):n[i]=e[i].destroy?{buffer:e[i],divisor:1}:{buffer:t.buffer({data:e[i],dimension:e[i].length/this._instanceCount}),divisor:1});return this.instancedData=n,this}getREGLProps(t,e){const n=super.getREGLProps(t,e);return oa(t)||Qs(n,this.instancedData),n.elements=this.geometry.getElements(),n.instances=this._instanceCount,n}disposeInstanceData(){const t=this.instancedData;if(t)for(const e in t)t[e]&&t[e].destroy&&!t[e][va]&&(t[e][va]=1,t[e].destroy());this.instancedData={};for(const e in this._vao)this._vao[e].vao.destroy();this._vao={}}_getBytesPerElement(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}throw new Error("unsupported data type: "+t)}}const Ja={getArrayBuffer:(t,e)=>Ja.get(t,{responseType:"arraybuffer"},e),get:function(t,e,n){const i=Ja._getClient(n);if(i.open("GET",t,!0),e){for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(null),i},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=Ja._wrapCallback(e,t),e}};var Qa=_a(class{constructor(t){this.defaultTexture=t,this.defaultCubeTexture=new Array(6),this.resources={}}get(t){return Array.isArray(t)?this._loadImages(t):this._loadImage(t)}getArrayBuffer(t){if(Array.isArray(t)){const e=t.map((t=>this.getArrayBuffer(t)));return Promise.all(e)}return new Promise(((e,n)=>{Ja.getArrayBuffer(t,((i,r)=>{i?n(i):e({url:t,data:r})}))}))}disposeRes(t){return Array.isArray(t)?t.forEach((t=>this._disposeOne(t))):this._disposeOne(t),this}isLoading(){return this._count&&this._count>0}getDefaultTexture(t){return Array.isArray(t)?this._getBlankTextures(t.length):this.defaultTexture}_disposeOne(t){const e=this.resources;e[t]&&(e[t].count--,e[t].count<=0&&delete e[t])}_loadImage(t){const e=this.resources;return e[t]?Promise.resolve({url:t,data:e[t].image}):new Promise(((n,i)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=function(){e[t]={image:r,count:1},n({url:t,data:r})},r.onerror=function(t){i(t)},r.onabort=function(){i(`image(${t}) loading aborted.`)},r.src=t}))}_loadImages(t){const e=t.map((t=>this._loadImage(t,!0)));return Promise.all(e)}_getBlankTextures(t){const e=new Array(t);for(let n=0;n<6;n++)e.push(this.defaultTexture);return e}});const $a=[],th=[];let eh=0;class nh{constructor(t){this._id=eh++,this.sortedMeshes={},this.setMeshes(t),this._compareBinded=this._compare.bind(this),this.dirty()}setMeshes(t){if(this.clear(),!t||Array.isArray(t)&&!t.length||t===this.meshes)return this;t=Array.isArray(t)?t:[t],this.meshes=[];for(let e=0;e<t.length;e++){const n=t[e];n&&(n._scenes=n._scenes||{},n._scenes[this._id]=1,this.meshes.push(n))}return this.dirty(),this}addMesh(t){return!t||Array.isArray(t)&&!t.length||(Array.isArray(t)?t.forEach((t=>{t._scenes=t._scenes||{},t._scenes[this._id]||(t._scenes[this._id]=1,this.meshes.push(t),this.dirty())})):(t._scenes=t._scenes||{},t._scenes[this._id]||(t._scenes[this._id]=1,this.meshes.push(t),this.dirty()))),this}removeMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t)){let e=!1;for(let n=0;n<t.length;n++)t[n]._scenes&&t[n]._scenes[this._id]&&(e=!0,this.dirty(),delete t[n]._scenes[this._id]);e&&(this.meshes=this.meshes.filter((e=>t.indexOf(e)<0)))}else{if(!t._scenes||!t._scenes[this._id])return this;const e=this.meshes.indexOf(t);e>=0&&this.meshes.splice(e,1),delete t._scenes[this._id],this.dirty()}return this}getMeshes(){return this.meshes}clear(){if(this.meshes)for(let t=0;t<this.meshes.length;t++)delete this.meshes[t]._scenes[this._id];return this.meshes=[],this.sortedMeshes.opaques=[],this.sortedMeshes.transparents=[],this}dirty(){return this._dirty=!0,this}sortMeshes(t){const e=this.meshes;this.sortFunction&&e.sort(this.sortFunction);let n=this.sortedMeshes.transparents;if(this._dirty){const t=this.sortedMeshes.opaques=[];n=this.sortedMeshes.transparents=[];for(let i=0,r=e.length;i<r;i++)e[i].transparent?n.push(e[i]):t.push(e[i])}t&&n.length>1&&(this._cameraPosition=t,n.sort(this._compareBinded),delete this._cameraPosition),this._dirty=!1}getSortedMeshes(){return this._dirty&&this.sortMeshes(),this.sortedMeshes}_compare(t,e){return vn($a,t.geometry.boundingBox.getCenter(),t.localTransform),vn(th,e.geometry.boundingBox.getCenter(),e.localTransform),In(th,this._cameraPosition)-In($a,this._cameraPosition)}}var ih=String.fromCharCode;function rh(t,e,n,i){if(t[3]>0){var r=Math.pow(2,t[3]-128-8+i);e[n+0]=t[0]*r,e[n+1]=t[1]*r,e[n+2]=t[2]*r}else e[n+0]=0,e[n+1]=0,e[n+2]=0;return e[n+3]=1,e}function oh(t,e,n){let i=t[e]/n,r=t[e+1]/n,o=t[e+2]/n,s=ra(Math.max(Math.max(i,r),Math.max(o,1e-6)),0,1);s=Math.ceil(255*s)/255,t[e]=Math.min(255,i/s*255),t[e+1]=Math.min(255,r/s*255),t[e+2]=Math.min(255,o/s*255),t[e+3]=Math.min(255,255*s)}function sh(t,e,n,i){for(var r,o,s=0,a=0,h=i;h>0;)if(t[a][0]=e[n++],t[a][1]=e[n++],t[a][2]=e[n++],t[a][3]=e[n++],1===t[a][0]&&1===t[a][1]&&1===t[a][2]){for(var l=t[a][3]<<s>>>0;l>0;l--)(o=t[a])[0]=(r=t[a-1])[0],o[1]=r[1],o[2]=r[2],o[3]=r[3],a++,h--;s+=8}else a++,h--,s=0;return n}function ah(t,e,n,i){if(i<8|i>32767)return sh(t,e,n,i);var r=e[n++];if(2!==r)return sh(t,e,n-1,i);if(t[0][1]=e[n++],t[0][2]=e[n++],r=e[n++],(t[0][2]<<8>>>0|r)>>>0!==i)return null;for(let a=0;a<4;a++)for(let r=0;r<i;){var o=e[n++];if(o>128){o=(127&o)>>>0;for(var s=e[n++];o--;)t[r++][a]=s}else for(;o--;)t[r++][a]=e[n++]}return n}function hh(t,e=0,n=9){var i=new Uint8Array(t),r=i.length;if("#?"!==function(t,e,n){for(var i="",r=0;r<n;r++)i+=ih(t[r]);return i}(i,0,2))return null;for(var o=2;o<r&&("\n"!==ih(i[o])||"\n"!==ih(i[o+1]));o++);if(o>=r)return null;o+=2;for(var s="";o<r;o++){var a=ih(i[o]);if("\n"===a)break;s+=a}var h=s.split(" "),l=parseInt(h[1]),c=parseInt(h[3]);if(!c||!l)return null;for(var u=o+1,f=[],d=0;d<c;d++){f[d]=[];for(var m=0;m<4;m++)f[d][m]=0}var g=0,p=new Array(c*l*4),_=0;for(let v=0;v<l;v++){if(!(u=ah(f,i,u,c)))return null;for(let t=0;t<c;t++)rh(f[t],p,_,e),g=Math.max(g,p[_],p[_+1],p[_+2],p[_+3]),_+=4}g=Math.min(g,n),_=0;for(let v=0;v<l;v++)for(let t=0;t<c;t++)oh(p,_,g),_+=4;return{width:c,height:l,pixels:p,rgbmRange:g}}const lh=["points","lines","line strip","line loop","triangles","triangle strip","triangle fan"];function ch(t){return lh[t]}const uh={5121:"uint8",5123:"uint16",5125:"uint32",5126:"float",36193:"half float"};function fh(t){return uh[t]}const dh={6406:"alpha",6407:"rgb",6408:"rgba",6409:"luminance",6410:"luminance alpha",33776:"rgb s3tc dxt1",33777:"rgba s3tc dxt1",33778:"rgba s3tc dxt3",33779:"rgba s3tc dxt5",35840:"rgb pvrtc 4bppv1",35841:"rgb pvrtc 2bppv1",35842:"rgba pvrtc 4bppv1",35843:"rgba pvrtc 2bppv1",35986:"rgb atc",35987:"rgba atc explicit alpha",34798:"rgba atc interpolated alpha",36196:"rgb etc1"};function mh(t){return dh[t]}const gh={9729:"linear",9728:"nearest"};function ph(t){return gh[t]}const _h={9729:"linear",9728:"nearest",9984:"nearest mipmap nearest",9985:"linear mipmap nearest",9986:"nearest mipmap linear",9987:"linear mipmap linear"};function vh(t){return _h[t]}const yh={10497:"repeat",33071:"clamp",33648:"mirror"};function xh(t){return yh[t]}const bh="__reshader_webgl_buffer",wh="__reshader_webgl_tex";function Th(t,e,n){let i;if(na(e)?e.buffer&&void 0!==e.byteOffset&&(i=e):e.array&&e.array.buffer&&void 0!==e.array.byteOffset&&(i=e.array),!i)return null;const r=i.buffer,o=i.byteOffset;r[bh]||(r[bh]={});let s=r[bh][o];if(!s){const e={};n&&Qs(e,n),e.data=i,s=t.buffer(e),r[bh][o]=s}return s}function Mh(t,e){const n=e.data;if(!n||!n.buffer)return t.texture(e);const i=n.buffer,r=n.byteOffset;i[wh]||(i[wh]={});let o=i[wh][r];return o||(o=t.texture(e),i[wh][r]=o),o}var Ah=Object.freeze({__proto__:null,getPrimitive:ch,getMaterialType:fh,getMaterialFormat:mh,getTextureMagFilter:ph,getTextureMinFilter:vh,getTextureWrap:xh,getUniqueREGLBuffer:Th,getUniqueTexture:Mh});class Eh extends xa{onLoad({data:t}){const e=this.config;if(e){if(e.hdr){if(!(t=hh(t.data,0,e.maxRange)))throw new Error("Invalid hdr data"+(e.url?":"+e.url:""));this.rgbmRange=t.rgbmRange,e.data=t.pixels}else e.data=t;e.width=e.width||t.width,e.height=e.height||t.height,this._updateREGL()}}createREGLTexture(t){if(na(this.config.data)||na(this.config.mipmap)){const e=Mh(t,this.config);return e._reshader_refCount||(e._reshader_refCount=0),e._reshader_refCount++,e}return t.texture(this.config)}}class Ch extends xa{onLoad(t){const e=this.config;if(!e)return;const n=this._createFaces(t);e.faces=n.map((t=>t.data)),this._updateREGL()}createREGLTexture(t){return t.cube(this.config)}_createFaces(){return[]}}class Sh extends La{constructor(t){super({aPosition:new(ia(t=t||0))([-1,-1,t,1,-1,t,-1,1,t,1,1,t]),aNormal:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1])},new Uint16Array([0,1,3,3,2,0]))}}const Ph={vsm_shadow_vert:"\nuniform mat4 shadow_lightProjViewModelMatrix;\nvarying vec4 shadow_vLightSpacePos;\nvoid shadow_computeShadowPars(vec4 position) {\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\n}",vsm_shadow_frag:"\nuniform sampler2D shadow_shadowMap;\nuniform float shadow_opacity;\nuniform vec3 shadow_color;\n#if defined(USE_ESM)\n    uniform float esm_shadow_threshold;\n#endif\nvarying vec4 shadow_vLightSpacePos;\n#ifdef PACK_FLOAT\n    #include <common_pack_float>\n#endif\n#if defined(USE_ESM)\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\n    float compare = projCoords.z;\n    float c = 120.0;\n    #ifdef PACK_FLOAT\n        float depth = common_decodeDepth(shadowTexel);\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\n            return 1.0;\n        }\n    #else\n        float depth = shadowTexel.r;\n    #endif\n    depth = exp(-c * min(compare - depth, 0.05));\n    return clamp(depth, esm_shadow_threshold, 1.0);\n}\n#endif\n#if defined(USE_VSM)\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\n    vec2 moments = shadowTexel.rg;\n    float distance = projCoords.z;\n    if (distance >= 1.0 || distance <= moments.x)\n        return 1.0 ;\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, 0.00002);\n    float d = distance - moments.x;\n    float p_max = variance / (variance + d * d);\n    return p_max;\n}\n#endif\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\n    vec2 uv = projCoords.xy;\n    vec4 shadowTexel = texture2D(shadowMap, uv);\n    #if defined(USE_ESM)\n        float esm_coeff = esm(projCoords, shadowTexel);\n        float coeff = esm_coeff * esm_coeff;\n    #endif\n    #if defined(USE_VSM)\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\n        float coeff = vsm_coeff;\n    #endif\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\n}\nfloat shadow_computeShadow() {\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\n    projCoords = projCoords * 0.5 + 0.5;\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\n}\nvec3 shadow_blend(vec3 color, float coeff) {\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\n    return color;\n}",fbo_picking_vert:"\n#ifdef ENABLE_PICKING\n#if HAS_PICKING_ID == 1\nattribute float aPickingId;\n#elif HAS_PICKING_ID == 2\nuniform float uPickingId;\n#endif\nvarying float vPickingId;\nvarying float vFbo_picking_viewZ;\nvarying float vFbo_picking_visible;\n#endif\nvarying float vFbo_picking_fragDepth;\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\n    #ifdef ENABLE_PICKING\n    #if HAS_PICKING_ID == 1\n       vPickingId = aPickingId;\n    #elif HAS_PICKING_ID == 2\n        vPickingId = uPickingId;\n    #endif\n        vFbo_picking_viewZ = viewPosZ;\n    #endif\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\nfloat common_packFloat(vec4 val){\n    vec4 scl = floor(255.0 * val + 0.5);\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\n    float man = 1.0 +\n        (scl.r / 8388608.0) +\n        (scl.g / 32768.0) +\n        mod(scl.b, 128.0) / 128.0;\n    return sgn * man * pow(2.0, exn);\n}\nvec4 common_unpackFloat(highp float v) {\n    highp float av = abs(v);\n    if(av < COMMON_FLOAT_MIN) {\n        return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > COMMON_FLOAT_MAX) {\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n    } else if(v < -COMMON_FLOAT_MAX) {\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n    }\n    highp vec4 c = vec4(0,0,0,0);\n    highp float e = floor(log2(av));\n    highp float m = av * pow(2.0, -e) - 1.0;\n    c[1] = floor(128.0 * m);\n    m -= c[1] / 128.0;\n    c[2] = floor(32768.0 * m);\n    m -= c[2] / 32768.0;\n    c[3] = floor(8388608.0 * m);\n    highp float ebias = e + 127.0;\n    c[0] = floor(ebias / 2.0);\n    ebias -= c[0] * 2.0;\n    c[1] += floor(ebias) * 128.0;\n    c[0] += 128.0 * step(0.0, -v);\n    return c / 255.0;\n}\nvec4 common_encodeDepth(const in float depth) {\n    float alpha = 1.0;\n    vec4 pack = vec4(0.0);\n    pack.a = alpha;\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n    pack.rgb = vec3(code * depth);\n    pack.gb = fract(pack.gb);\n    pack.rg -= pack.gb * (1.0 / 256.0);\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n    return pack;\n}\nfloat common_decodeDepth(const in vec4 pack) {\n    return pack.r + pack.g / 255.0;\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return inverse(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\n        float b00 = a00 * a11 - a01 * a10;\n        float b01 = a00 * a12 - a02 * a10;\n        float b02 = a00 * a13 - a03 * a10;\n        float b03 = a01 * a12 - a02 * a11;\n        float b04 = a01 * a13 - a03 * a11;\n        float b05 = a02 * a13 - a03 * a12;\n        float b06 = a20 * a31 - a21 * a30;\n        float b07 = a20 * a32 - a22 * a30;\n        float b08 = a20 * a33 - a23 * a30;\n        float b09 = a21 * a32 - a22 * a31;\n        float b10 = a21 * a33 - a23 * a31;\n        float b11 = a22 * a33 - a23 * a32;\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n        det = 1.0 / det;\n        mat4 m = mat4(\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\n        );\n        return m;\n    #endif\n}\nmat4 transpose_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return transpose(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a12 = vector2.z, a13 = vector2.w;\n        float a23 = vector3.w;\n        mat4 m = mat4(\n            vector1.x,\n            vector2.x,\n            vector3.x,\n            vector4.x,\n            a01,\n            vector2.y,\n            vector3.y,\n            vector4.y,\n            a02,\n            a12,\n            vector3.z,\n            vector4.z,\n            a03,\n            a13,\n            a23,\n            vector4.w\n        );\n        return m;\n    #endif\n}",get_output:"#include <invert_matrix>\n#include <draco_decode_vert>\n#ifdef HAS_INSTANCE\n    #include <instance_vert>\n    #ifdef HAS_INSTANCE_COLOR\n        varying vec4 vInstanceColor;\n    #endif\n#endif\n#ifdef HAS_SKIN\n    uniform int skinAnimation;\n    #include <skin_vert>\n#endif\n#include <mask_vert>\n#ifdef HAS_MORPH\n    attribute vec3 POSITION0;\n    attribute vec3 POSITION1;\n    attribute vec3 POSITION2;\n    attribute vec3 POSITION3;\n    attribute vec3 POSITION4;\n    attribute vec3 POSITION5;\n    attribute vec3 POSITION6;\n    attribute vec3 POSITION7;\n    #ifdef HAS_MORPHNORMALS\n        attribute vec3 NORMAL0;\n        attribute vec3 NORMAL1;\n        attribute vec3 NORMAL2;\n        attribute vec3 NORMAL3;\n    #endif\n    uniform vec4 morphWeights1;\n    uniform vec4 morphWeights2;\n#endif\nmat4 getPositionMatrix() {\n    mat4 worldMatrix;\n    #ifdef HAS_INSTANCE\n        #ifdef HAS_INSTANCE_COLOR\n            vInstanceColor = instance_getInstanceColor();\n        #endif\n        mat4 attributeMatrix = instance_getAttributeMatrix();\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\n            } else {\n                worldMatrix = attributeMatrix * positionMatrix;\n            }\n        #else\n            worldMatrix = attributeMatrix * positionMatrix;\n        #endif\n    #else\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\n            } else {\n                worldMatrix = positionMatrix;\n            }\n        #else\n            worldMatrix = positionMatrix;\n        #endif\n    #endif\n    return worldMatrix;\n}\nvec4 getPosition(vec3 aPosition) {\n    vec3 position = getPositionAsDraco(aPosition);\n    #ifdef HAS_MORPH\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\n        , 1.0);\n    #else\n        vec4 POSITION = vec4(position, 1.0);\n    #endif\n    return POSITION;\n}\nvec3 appendMorphNormal(vec3 NORMAL) {\n    #ifdef HAS_MORPHNORMALS\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\n    #else\n        vec3 normal = NORMAL;\n    #endif\n    return normal;\n}",instance_vert:"attribute vec4 instance_vectorA;\nattribute vec4 instance_vectorB;\nattribute vec4 instance_vectorC;\nmat4 instance_getAttributeMatrix() {\n    mat4 mat =  mat4(\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\n    );\n    return mat;\n}\n#ifdef HAS_INSTANCE_COLOR\n    attribute vec4 instance_color;\n    vec4 instance_getInstanceColor() {\n        return instance_color;\n    }\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\nattribute vec4 JOINTS_0;\nuniform sampler2D jointTexture;\nuniform vec2 jointTextureSize;\nuniform float numJoints;\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\nmat4 skin_getBoneMatrix(float jointNdx) {\n    float v = (jointNdx + 0.5) / numJoints;\n    return mat4(\n        texture2D(jointTexture, vec2(ROW0_U, v)),\n        texture2D(jointTexture, vec2(ROW1_U, v)),\n        texture2D(jointTexture, vec2(ROW2_U, v)),\n        texture2D(jointTexture, vec2(ROW3_U, v)));\n}\nmat4 skin_getSkinMatrix() {\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\n        return skinMatrix;\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\nvarying vec2 heatmap_vTexCoord;\nvoid heatmap_compute(mat4 matrix, vec3 position) {\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\n}\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\nuniform sampler2D heatmap_inputTexture;\nuniform sampler2D heatmap_colorRamp;\nuniform float heatmap_heatmapOpacity;\nvarying vec2 heatmap_vTexCoord;\nvec4 heatmap_getColor(vec4 color) {\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\n}\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\n    #define ALTITUDE_SCALE 32767.0;\n    #define EXTRUDE_SCALE 63.0;\n    attribute vec2 aExtrude;\n    #ifdef HAS_LINE_WIDTH\n        attribute float aLineWidth;\n    #else\n        uniform float lineWidth;\n    #endif\n    #ifdef HAS_LINE_HEIGHT\n        attribute float aLineHeight;\n    #else\n        uniform float lineHeight;\n    #endif\n    uniform float linePixelScale;\n    vec3 getLineExtrudePosition(vec3 position) {\n        #ifdef HAS_LINE_WIDTH\n            float lineWidth = aLineWidth / 2.0;\n        #endif\n        #ifdef HAS_LINE_HEIGHT\n            float lineHeight = aLineHeight / 10.0;\n        #endif\n        float halfwidth = lineWidth / 2.0;\n        float outset = halfwidth;\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\n        position.z *= lineHeight / ALTITUDE_SCALE;\n        return position + vec3(dist, 0.0) * linePixelScale;\n    }\n#endif",gl2_vert:"#if __VERSION__ == 300\n    #define texture2D texture\n    #define varying out\n    #define attribute in\n#endif",gl2_frag:"#if __VERSION__ == 300\n    #define varying in\n    #define gl_FragDepthEXT gl_FragDepth\n    #define texture2D texture\n    #define textureCube texture\n    #define texture2DProj textureProj\n    #define texture2DLodEXT textureLod\n    #define texture2DProjLodEXT textureProjLod\n    #define textureCubeLodEXT textureLod\n    #define texture2DGradEXT textureGrad\n    #define texture2DProjGradEXT textureProjGrad\n    #define textureCubeGradEXT textureGrad\n    #define texture2D texture\n    out vec4 glFragColor;\n#else\n    vec4 glFragColor;\n#endif",hsv_frag:"\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nconst mediump float HSV_E = 1.0e-10;\nvec3 hsv_rgb2hsv(vec3 c) {\n    vec4 K = HSV_K0;\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = HSV_E;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\nvec3 hsv_hsv2rgb(vec3 c) {\n    vec4 K = HSV_K1;\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return vec4(hsv_hsv2rgb(hsv), c.a);\n}\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return hsv_hsv2rgb(hsv);\n}\nmat4 contrastMatrix(float contrast)\n{\n    float t = (1.0 - contrast) / 2.0;\n    return mat4(\n        contrast, 0., 0., 0.,\n        0., contrast, 0., 0.,\n        0., 0., contrast, 0.,\n        t, t, t, 1\n    );\n}",snow_frag:"#ifdef HAS_SNOW\n    float lerp(float a, float b, float w) {\n        return a + w * (b - a);\n    }\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\n        float snowIntense = normalColor.b;\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\n        if (height < 1.0) {\n            float r = lerp(0.5, fixedC.x, snowIntense);\n            float g = lerp(0.5, fixedC.y, snowIntense);\n            float b = lerp(0.5, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        } else {\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        }\n    }\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\n    attribute vec4 aTangent;\n#elif defined(HAS_NORMAL)\n    #ifdef HAS_DECODE_NORMAL\n        attribute vec2 aNormal;\n        uniform float gltf_u_dec_normal_rangeConstant;\n    #else\n        attribute vec3 aNormal;\n    #endif\n#endif\n#ifdef HAS_DECODE_POSITION\n    uniform float gltf_u_dec_position_normConstant;\n    uniform vec3 minValues_pos;\n    vec3 decodeDracoPosition(vec3 aPosition) {\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\n    }\n#endif\n#ifdef HAS_DECODE_TEXCOORD\n    uniform vec2 minValues_tex;\n    uniform float gltf_u_dec_texcoord_0_normConstant;\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\n    }\n#endif\n#ifdef HAS_DECODE_NORMAL\n    float czm_signNotZero(float value) {\n        return value >= 0.0 ? 1.0 : -1.0;\n    }\n    vec2 czm_signNotZero(vec2 value) {\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\n    }\n    vec3 decodeDracoNormal(vec2 encoded, float range)\n    {\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\n            return vec3(0.0, 0.0, 0.0);\n        }\n        encoded = encoded / range * 2.0 - 1.0;\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n        if (v.z < 0.0) {\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\n        }\n        return normalize(v);\n    }\n    vec3 getNormal(vec2 aNormal) {\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\n    }\n#endif\nvec3 getPositionAsDraco(vec3 aPosition) {\n    #ifdef HAS_DECODE_POSITION\n        return decodeDracoPosition(aPosition);\n    #else\n        return aPosition;\n    #endif\n}\nvec2 getTexcoord(vec2 aTexCoord) {\n    #ifdef HAS_DECODE_TEXCOORD\n        return decodeDracoTexcoord(aTexCoord);\n    #else\n        return aTexCoord;\n    #endif\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\n    attribute vec4 aHighlightColor;\n    varying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    attribute float aHighlightOpacity;\n    varying float vHighlightOpacity;\n#endif\nvoid highlight_setVarying() {\n    #if defined(HAS_HIGHLIGHT_COLOR)\n        vHighlightColor = aHighlightColor / 255.0;\n    #endif\n    #if defined(HAS_HIGHLIGHT_OPACITY)\n        vHighlightOpacity = aHighlightOpacity / 255.0;\n    #endif\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\n\tvarying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    varying float vHighlightOpacity;\n#endif\nvec4 highlight_blendColor(vec4 color) {\n\tvec4 outColor;\n\t#if defined(HAS_HIGHLIGHT_COLOR)\n\t\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\n\t\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\n        \tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\n        #endif\n        outColor = color;\n\t#else\n\t\toutColor = color;\n\t#endif\n\t#if defined(HAS_HIGHLIGHT_OPACITY)\n\t\toutColor *= vHighlightOpacity;\n\t#endif\n\treturn outColor;\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\n    uniform vec4 mask_extent;\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_maskMode;\n    uniform float mask_hasFlatOut;\n    uniform mat4 viewMatrix;\n    uniform float mask_heightRatio;\n    uniform float mask_heightOffset;\n    varying vec4 vWorldPosition;\n    varying vec2 vUVInExtent;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    float random (vec2 st) {\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\n    }\n    bool isInExtent(vec4 color) {\n        if (color.r > 0.0 || color.g > 0.0 || color.b > 0.0 || color.a > 0.0) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\n        vWorldPosition = modelMatrix * position;\n        float w = mask_extent.z - mask_extent.x;\n        float h = mask_extent.y - mask_extent.w;\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / w, 1.0 - (vWorldPosition.y - mask_extent.w) / h);\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\n        float maskMode = maskOptionColor.r;\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\n        float height = flatHeight + random(uvInExtent);\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\n        vUVInExtent = uvInExtent;\n        vHeightRatio = mask_heightRatio;\n        vHeightOffset = mask_heightOffset;\n        if (maskMode <= 0.4 && maskMode > 0.3) {\n            return viewMatrix * modelMatrix * position;\n        } else if (mask_hasFlatOut == 1.0) {\n            return viewMatrix * wPosition;\n        }\n        if (isInExtent(extentColor) == true && maskMode <= 0.3 && maskMode > 0.2) {\n            return viewMatrix * wPosition;\n        } else {\n            return viewMatrix * modelMatrix * position;\n        }\n    }\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_hasClipOut;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    varying vec2 vUVInExtent;\n    varying vec4 vWorldPosition;\n    bool isInExtent(vec4 color) {\n        if (color.r > 0.0 || color.g > 0.0 || color.b > 0.0) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n    \n    vec4 setMask(vec4 glFragColor) {\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\n        float maskMode = modeColor.r;\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\n        if (maskMode > 0.1 && maskMode <= 0.2) {\n            return glFragColor;\n        } else if (mask_hasClipOut == 1.0) {\n            discard;\n        }\n        if (isInExtent(extentColor) == true && maskMode > 0.0 && maskMode <= 0.1) {\n            discard;\n        } else if (isInExtent(extentColor) == true && maskMode <= 0.5 && maskMode > 0.4) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            }\n        }\n        return glFragColor;\n    }\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\n    uniform vec2 khr_offset;\n    uniform float khr_rotation;\n    uniform vec2 khr_scale;\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\n        rotation = -rotation;\n        mat3 transform = mat3(\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\n        return transformedTexCoords;\n    }\n#endif\nvarying highp vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\n    varying vec4 vUvRegion;\n#endif\nvec2 computeTexCoord() {\n    #ifdef HAS_I3S_UVREGION\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\n        vec2 uvAtlas = fract(vTexCoord) * atlasScale + vUvRegion.xy;\n        return uvAtlas;\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\n        return khr_tex_transformTexCoord(vTexCoord, khr_offset, khr_rotation, khr_scale);\n    #else\n        return vTexCoord;;\n    #endif\n}"};var Rh={register(t,e){if(Ph[t])throw new Error(`Key of ${t} is already registered in ShaderLib.`);Ph[t]=e},compile:t=>Ih(t)};const Oh=/^[ \t]*#include +<([\w\d.]+)>/gm;function Ih(t){return t.replace(Oh,Dh)}function Dh(t,e){const n=Ph[e];if(!n)throw new Error("Can not resolve #include <"+e+">");return Ih(n)}const kh="function",Lh="array";let Fh=0;const Nh={};class Bh{constructor({vert:t,frag:e,uniforms:n,defines:i,extraCommandProps:r}){this.vert=t,this.frag=e;const o=Fh++;Object.defineProperty(this,"uid",{enumerable:!0,configurable:!1,get:()=>o}),this.shaderDefines=i&&Qs({},i)||{},n=this.uniforms=(n||[]).slice(),this.contextDesc={};for(let s=0,a=n.length;s<a;s++){const t=n[s];if(Zs(t))if(t.indexOf("[")>0){const{name:e,len:n}=Hh(t);this.contextDesc[e]={name:e,type:"array",length:n}}else this.contextDesc[t]=null;else if(t.name.indexOf("[")>0){const{name:e,len:n}=Hh(t.name);this.contextDesc[e]={name:e,type:"array",length:n,fn:t.fn}}else this.contextDesc[t.name]=t}this.extraCommandProps=r&&Qs({},r)||{},this.commands={},this._compileSource()}set shaderDefines(t){this._shaderDefines=t,this.dkey=Object.keys(this._shaderDefines).join()}get shaderDefines(){return this._shaderDefines||{}}setDefines(t){this.shaderDefines=t}setFramebuffer(t){return this.context.framebuffer=t,this}appendDescUniforms(t,e){const n=e,i=this.contextDesc;for(const r in i)if(i[r])if("array"===i[r].type){const o=r,s=i[r].length;let a=e[r];if(i[r].fn&&(a=i[r].fn(null,e)),!a)continue;if(a.length!==s)throw new Error(`${o} uniform's length is not ${s}`);n[o]=n[o]||{};for(let e=0;e<s;e++)n[o][""+e]=a[e].getREGLTexture?a[e].getREGLTexture(t):a[e]}else"function"===i[r].type&&(Object.getOwnPropertyDescriptor(n,r)||Object.defineProperty(n,r,{configurable:!1,enumerable:!0,get:function(){return i[r].fn(null,e)}}));return n}setUniforms(t){if(t.modelMatrix||t.positionMatrix)throw new Error("modelMatrix or positionMatrix is reserved uniform name for Mesh, please change to another name");return this.contextKeys=t?Object.keys(t).join():null,this.context=t,this}getVersion(t,e){return"#version"===e.substring(0,8)?"":0===t.limits.version.indexOf("WebGL 2.0")&&300===this.version?"#version 300 es\n":"#version 100\n"}getActiveVars(t,e,n,i){const r=i;if(Nh[r])return Nh[r];const o=t._gl,s=o.createProgram(),a=o.createShader(35633);o.shaderSource(a,e),o.compileShader(a);const h=o.createShader(35632);o.shaderSource(h,n),o.compileShader(h),o.attachShader(s,h),o.attachShader(s,a),o.linkProgram(s);const l=o.getProgramParameter(s,35721),c=[];for(let d=0;d<l;++d){const t=o.getActiveAttrib(s,d);t&&c.push({name:t.name,type:t.type})}const u=o.getProgramParameter(s,35718),f=[];for(let d=0;d<u;++d){const t=o.getActiveUniform(s,d);let e=t.name;t.name.indexOf("[")>0&&(e=e.replace("[0]","")),f.push(e)}return o.deleteProgram(s),o.deleteShader(a),o.deleteShader(h),Nh[r]={activeUniforms:f,activeAttributes:c},Nh[r]}createREGLCommand(t,e,n,i,r){const o=oa(t)&&!r,s=Qs({},this.shaderDefines||{},e||{}),a=this._insertDefines(this.vert,s),h=this.getVersion(t,a)+a,l=this._insertDefines(this.frag,s),c=this.getVersion(t,l)+l,u=da(h)+"_"+da(c),{activeAttributes:f,activeUniforms:d}=this.getActiveVars(t,h,c,u),m={};f.forEach(((e,n)=>{const i=e.name;m[i]=o?n:t.prop(i)}));const g={};d.forEach((e=>{g[e]=t.prop(e)}));const p=this.contextDesc;for(const y in p)if(p[y]&&p[y].type===kh)g[y]=p[y].fn;else if(p[y]&&p[y].type===Lh){const e=p[y].name,n=p[y].length;for(let i=0;i<n;i++){const n=`${e}[${i}]`;g[n]=t.prop(n)}}else g[y]=t.prop(y);const _={vert:h,frag:c,uniforms:g,attributes:m};o&&(_.vao=t.prop("vao")),o&&!i||!n||ta(n)||(_.elements=t.prop("elements")),_.count=t.prop("count"),_.offset=t.prop("offset"),_.primitive=t.prop("primitive"),_.framebuffer=t.prop("framebuffer"),i&&(_.instances=t.prop("instances")),Qs(_,this.extraCommandProps);const v=t(_);return f.key=f.map((t=>t.name)).join(),v.activeAttributes=f,v}dispose(){for(const t in this.commands){const e=this.commands[t];e&&e.destroy&&!e[va]&&(e[va]=!0,e.destroy())}this.commands={},delete this.vert,delete this.frag}_insertDefines(t,e){const n=[];for(const i in e)sa(e,i)&&!Ks(e[i])&&n.push(`#define ${i} ${e[i]}\n`);return n.join("")+t}_compileSource(){this.vert=Rh.compile(this.vert),this.frag=Rh.compile(this.frag)}}function Hh(t){const e=t.indexOf("["),n=t.indexOf("]");return{name:t.substring(0,e),len:+t.substring(e+1,n)}}class jh extends Bh{draw(t,e){if(!e||!e.length)return 0;const n=[];let i,r=0;for(let o=0,s=e.length;o<s;o++){if(!e[o].isValid()){o===s-1&&i&&n.length&&i(n);continue}if(!e[o].geometry.getDrawCount()||!this._runFilter(e[o])){o===s-1&&i&&n.length&&i(n);continue}const a=this.getMeshCommand(t,e[o]);n.length&&i!==a&&(i(n),n.length=0);const h=e[o].getREGLProps(t,a.activeAttributes);this._ensureContextDefines(h),h.shaderContext=this.context,this.appendDescUniforms(t,h),n.push(h),r++,o<s-1?i=a:o===s-1&&a(n)}return r}_ensureContextDefines(t){if(this.context&&(t.contextKeys||(t.contextKeys={}),t.contextKeys[this.uid]!==this.contextKeys)){for(const e in this.context)Object.getOwnPropertyDescriptor(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:function(){return this.shaderContext&&this.shaderContext[e]}});t.contextKeys[this.uid]=this.contextKeys}}_runFilter(t){const e=this.filter;if(!e)return!0;if(Array.isArray(e)){for(let n=0;n<e.length;n++)if(!e[n](t))return!1;return!0}return e(t)}getMeshCommand(t,e){this._cmdKeys||(this._cmdKeys={});const n=this.dkey||"default";let i=this._cmdKeys[n];i||(i=this._cmdKeys[n]={});const r=e.getCommandKey(t);i[r]||(i[r]=n+"_"+e.getCommandKey(t));const o=i[r];let s=this.commands[o];if(!s){const n=e.getDefines(),i=e.getMaterial();i&&i.doubleSided&&this.extraCommandProps&&this.extraCommandProps.cull&&(this.extraCommandProps.cull.enable=!1),s=this.commands[o]=this.createREGLCommand(t,n,e.getElements(),e instanceof Ka,e.disableVAO)}return s}}class zh extends jh{constructor(t={}){let e=t.extraCommandProps||{};const n=[];e=Qs({},e,{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},sample:{alpha:!0}}),super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aBarycentric;\nvarying vec3 vBarycentric;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nvarying vec3 vPosition;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = getPosition(aPosition);\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(c * d, modelMatrix);\n#else\ngl_Position = projMatrix * modelViewMatrix * c * d;\n#endif\nvBarycentric = aBarycentric;\n  vPosition = aPosition;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec3 vBarycentric;\nuniform float time;\nuniform float thickness;\nuniform float secondThickness;\nuniform float dashRepeats;\nuniform float dashLength;\nuniform bool dashOverlap;\nuniform bool dashEnabled;\nuniform bool dashAnimate;\nuniform bool seeThrough;\nuniform bool insideAltColor;\nuniform bool dualStroke;\nuniform bool squeeze;\nuniform float squeezeMin;\nuniform float squeezeMax;\nuniform vec4 stroke;\nuniform vec4 fill;\nuniform float opacity;\nuniform bool noiseEnable;\nvarying vec3 vPosition;\n#ifdef HAS_INSTANCE\nvarying vec4 vInstanceColor;\n#endif\n#include <mask_frag>\n#define F4 0.309016994374947451\n#define halfDist 0.5\nvec4 c(vec4 x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nfloat c(float x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nvec4 d(vec4 x) {\n  return c((x * 34. + 1.) * x);\n}\nfloat d(float x) {\n  return c((x * 34. + 1.) * x);\n}\nvec4 e(vec4 r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nfloat e(float r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nvec4 f(float h, vec4 i) {\n  const vec4 k = vec4(1., 1., 1., -1.);\n  vec4 p, s;\n  p.xyz = floor(fract(vec3(h) * i.xyz) * 7.) * i.z - 1.;\n  p.w = 1.5 - dot(abs(p.xyz), k.xyz);\n  s = vec4(lessThan(p, vec4(.0)));\n  p.xyz = p.xyz + (s.xyz * 2. - 1.) * s.www;\n  return p;\n}\nfloat l(vec4 m) {\n  const vec4 n = vec4(.138196601125011, .276393202250021, .414589803375032, -.447213595499958);\n  vec4 o = floor(m + dot(m, vec4(F4)));\n  vec4 u = m - o + dot(o, n.xxxx);\n  vec4 A;\n  vec3 B = step(u.yzw, u.xxx);\n  vec3 D = step(u.zww, u.yyz);\n  A.x = B.x + B.y + B.z;\n  A.yzw = 1. - B;\n  A.y += D.x + D.y;\n  A.zw += 1. - D.xy;\n  A.z += D.z;\n  A.w += 1. - D.z;\n  vec4 E = clamp(A, .0, 1.);\n  vec4 F = clamp(A - 1., .0, 1.);\n  vec4 G = clamp(A - 2., .0, 1.);\n  vec4 H = u - G + n.xxxx;\n  vec4 I = u - F + n.yyyy;\n  vec4 J = u - E + n.zzzz;\n  vec4 K = u + n.wwww;\n  o = c(o);\n  float L = d(d(d(d(o.w) + o.z) + o.y) + o.x);\n  vec4 M = d(d(d(d(o.w + vec4(G.w, F.w, E.w, 1.)) + o.z + vec4(G.z, F.z, E.z, 1.)) + o.y + vec4(G.y, F.y, E.y, 1.)) + o.x + vec4(G.x, F.x, E.x, 1.));\n  vec4 i = vec4(1. / 294., 1. / 49., 1. / 7., .0);\n  vec4 N = f(L, i);\n  vec4 O = f(M.x, i);\n  vec4 P = f(M.y, i);\n  vec4 Q = f(M.z, i);\n  vec4 R = f(M.w, i);\n  vec4 S = e(vec4(dot(N, N), dot(O, O), dot(P, P), dot(Q, Q)));\n  N *= S.x;\n  O *= S.y;\n  P *= S.z;\n  Q *= S.w;\n  R *= e(dot(R, R));\n  vec3 T = max(.6 - vec3(dot(u, u), dot(H, H), dot(I, I)), .0);\n  vec2 U = max(.6 - vec2(dot(J, J), dot(K, K)), .0);\n  T = T * T;\n  U = U * U;\n  return 49. * (dot(T * T, vec3(dot(N, u), dot(O, H), dot(P, I))) + dot(U * U, vec2(dot(Q, J), dot(R, K))));\n}\nconst float V = 3.14159265359;\nfloat W(float X, float Y) {\n  float Z = fwidth(Y) * halfDist;\n  return smoothstep(X - Z, X + Z, Y);\n}\nvec4 ba(vec3 bb) {\n  float bc = min(min(bb.x, bb.y), bb.z);\n  float bd = .0;\n  if(noiseEnable)\n    bd += l(vec4(vPosition.xyz * 80.0, time * halfDist)) * .12;\n  bc += bd;\n  float be = max(bb.x, bb.y);\n  if(bb.y < bb.x && bb.y < bb.z) {\n    be = 1. - be;\n  }\n  float bf = thickness;\n  if(squeeze) {\n    bf *= mix(squeezeMin, squeezeMax, (1. - sin(be * V)));\n  }\n  if(dashEnabled) {\n    float bg = 1. / dashRepeats * dashLength / 2.;\n    if(!dashOverlap) {\n      bg += 1. / dashRepeats / 2.;\n    }\n    if(dashAnimate) {\n      bg += time * .22;\n    }\n    float bh = fract((be + bg) * dashRepeats);\n    bf *= 1. - W(dashLength, bh);\n  }\n  float bi = 1. - W(bf, bc);\n#ifdef HAS_INSTANCE\nvec4 bj = vInstanceColor;\n#else\nvec4 bj = stroke;\n#endif\nvec4 bk = vec4(.0);\n  if(seeThrough) {\n    bk = vec4(bj.xyz, bi);\n    if(insideAltColor && !gl_FrontFacing) {\n      bk.rgb = fill.xyz;\n    }\n  } else {\n    vec3 bl = mix(fill.xyz, bj.xyz, bi);\n    bk.a = fill.a;\n    if(dualStroke) {\n      float bm = 1. - W(secondThickness, bc);\n      vec3 bn = mix(fill.xyz, stroke.xyz, abs(bm - bi));\n      bk.rgb = bn;\n    } else {\n      bk.rgb = bl;\n    }\n  }\n  return bk;\n}\nvoid main() {\n  glFragColor = ba(vBarycentric);\n  glFragColor *= halfDist + opacity;\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>re(n,e.viewMatrix,e.modelMatrix)}],extraCommandProps:e}),this.version=300}}var Gh="precision mediump float;\n#include <gl2_frag>\nuniform vec4 baseColorFactor;\nuniform float materialShininess;\nuniform float environmentExposure;\nuniform float specularStrength;\nuniform vec3 light0_viewDirection;\nuniform vec3 ambientColor;\nuniform vec4 light0_diffuse;\nuniform vec3 lightSpecular;\nuniform vec3 cameraPosition;\n#ifdef HAS_TOON\nuniform float toons;\nuniform float specularToons;\n#endif\n#ifdef HAS_TANGENT\nvarying vec4 vTangent;\n#endif\n#ifdef HAS_MAP\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vNormal;\nvarying vec3 vFragPos;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nuniform vec2 extrusionOpacityRange;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_OCCLUSION_MAP\nuniform sampler2D occlusionTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#include <heatmap_render_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#include <mask_frag>\nvec3 c() {\n  \n#if defined(HAS_NORMAL_MAP)\nvec3 d = normalize(vNormal);\n  vec3 e = texture2D(normalTexture, computeTexCoord()).xyz * 2. - 1.;\n#if defined(HAS_TANGENT)\nvec3 t = normalize(vTangent.xyz);\n  vec3 b = normalize(cross(d, t) * sign(vTangent.w));\n  mat3 f = mat3(t, b, d);\n  return normalize(f * e);\n#else\nreturn normalize(e);\n#endif\n#else\nreturn normalize(vNormal);\n#endif\n}\nvec4 h(const in vec4 i) {\n  return vec4(i.r < .0031308 ? i.r * 12.92 : 1.055 * pow(i.r, 1. / 2.4) - .055, i.g < .0031308 ? i.g * 12.92 : 1.055 * pow(i.g, 1. / 2.4) - .055, i.b < .0031308 ? i.b * 12.92 : 1.055 * pow(i.b, 1. / 2.4) - .055, i.a);\n}\nvec4 j() {\n  \n#if defined(HAS_BASECOLOR_MAP)\nreturn texture2D(baseColorTexture, computeTexCoord());\n#elif defined(HAS_DIFFUSE_MAP)\nreturn texture2D(diffuseTexture, computeTexCoord());\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn diffuseFactor;\n#else\nreturn baseColorFactor;\n#endif\n}\nvec3 k() {\n  \n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nreturn texture2D(specularGlossinessTexture, computeTexCoord()).rgb;\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn specularFactor;\n#else\nreturn vec3(1.);\n#endif\n}\nvoid main() {\n  vec4 l = j();\n  vec3 m = environmentExposure * ambientColor * l.rgb;\n#ifdef HAS_INSTANCE_COLOR\nm *= vInstanceColor.rgb;\n#endif\nvec3 o = c();\n  vec3 u = normalize(-light0_viewDirection);\n  float v = max(dot(o, u), .0);\n#ifdef HAS_TOON\nfloat A = floor(v * toons);\n  v = A / toons;\n#endif\nvec3 B = light0_diffuse.rgb * v * l.rgb;\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvec3 i = vColor.rgb;\n#elif defined(IS_LINE_EXTRUSION)\nvec3 i = lineColor.rgb;\n#else\nvec3 i = polygonFill.rgb;\n#endif\n#ifdef HAS_INSTANCE_COLOR\ni *= vInstanceColor.rgb;\n#endif\nm *= i.rgb;\n  B *= i.rgb;\n  vec3 C = normalize(cameraPosition - vFragPos);\n  vec3 D = normalize(u + C);\n  float E = pow(max(dot(o, D), .0), materialShininess);\n#ifdef HAS_TOON\nfloat F = floor(E * specularToons);\n  E = F / specularToons;\n#endif\nvec3 G = specularStrength * lightSpecular * E * k();\n#ifdef HAS_OCCLUSION_MAP\nfloat H = texture2D(occlusionTexture, computeTexCoord()).r;\n  m *= H;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat I = shadow_computeShadow();\n  B = shadow_blend(B, I).rgb;\n  G = shadow_blend(G, I).rgb;\n#endif\nvec3 J = m + B + G;\n#ifdef HAS_EMISSIVE_MAP\nvec3 K = texture2D(emissiveTexture, computeTexCoord()).rgb;\n  J += K;\n#endif\n#ifdef IS_LINE_EXTRUSION\nglFragColor = vec4(J, lineOpacity);\n#else\nglFragColor = vec4(J, polygonOpacity);\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nfloat L = vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nfloat L = lineColor.a;\n#else\nfloat L = polygonFill.a;\n#endif\nglFragColor *= L;\n#ifdef HAS_EXTRUSION_OPACITY\nfloat M = extrusionOpacityRange.x;\n  float N = extrusionOpacityRange.y;\n  float O = M + vExtrusionOpacity * (N - M);\n  O = clamp(O, .0, 1.);\n  glFragColor *= O;\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",Uh="#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nvarying vec3 vFragPos;\nvarying vec3 vNormal;\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <highlight_vert>\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nattribute float aExtrusionOpacity;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_TANGENT)\nvarying vec4 vTangent;\n#endif\nvoid c(const highp vec4 q, out highp vec3 d) {\n  d = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid c(const highp vec4 q, out highp vec3 d, out highp vec3 t) {\n  c(q, d);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 e = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 e = getPosition(aPosition);\n#endif\nmat4 f = getPositionMatrix();\n  vFragPos = vec3(modelMatrix * f * e);\n#if defined(HAS_NORMAL) || defined(HAS_TANGENT)\nmat3 h = modelNormalMatrix * mat3(f);\n  vec3 i;\n#if defined(HAS_TANGENT)\nvec3 t;\n  c(aTangent, i, t);\n  vTangent = vec4(h * t, aTangent.w);\n#else\n#ifdef HAS_DECODE_NORMAL\ni = getNormal(aNormal);\n#else\ni = aNormal;\n#endif\n#endif\nvec3 j = appendMorphNormal(i);\n  vNormal = normalize(h * j);\n#else\nvNormal = vec3(.0);\n#endif\nmat4 k = projMatrix;\n  k[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = k * getMaskPosition(f * e, modelMatrix);\n#else\ngl_Position = k * modelViewMatrix * f * e;\n#endif\n#ifdef HAS_MAP\nvec2 l = getTexcoord(aTexCoord);\n  vTexCoord = l * uvScale + uvOffset;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nvExtrusionOpacity = aExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(f * e);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * f, e);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\nhighlight_setVarying();\n}";class Vh extends jh{constructor(t={}){const e=[],n=[],i=t.uniforms,r=[{name:"modelNormalMatrix",type:"function",fn:function(t,n){return pt(e,n.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(t,e){return re(n,e.viewMatrix,e.modelMatrix)}}];i&&r.push(...i),super({vert:t.vert||Uh,frag:t.frag||Gh,uniforms:r,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),e}}class Wh extends jh{constructor(t={}){const e=[];super({vert:"attribute vec3 aPosition;\n#ifdef HAS_COLOR0\nattribute vec4 aColor0;\nvarying vec4 vColor;\n#endif\nuniform mat4 modelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float pointSize;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#endif\n#include <get_output>\n#include <heatmap_render_vert>\n#ifdef HAS_FLOODANALYSE\nvarying float vHeight;\n#endif\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_PointSize = pointSize;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = projViewModelMatrix * d * c;\n#endif\n#ifdef HAS_COLOR0\nvColor = aColor0 / 255.;\n#endif\n#ifdef HAS_MAP\nvTexCoord = aTexCoord;\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * d, c);\n#endif\n}",frag:"precision mediump float;\n#include <gl2_frag>\n#if defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#include <heatmap_render_frag>\nuniform vec4 baseColorFactor;\n#if defined(HAS_MAP)\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec2 vTexCoord;\n#endif\n#include <mask_frag>\nvoid main() {\n  \n#ifdef HAS_COLOR0\nglFragColor = vColor * baseColorFactor;\n#else\nglFragColor = vec4(1.) * baseColorFactor;\n#endif\n#ifdef HAS_MAP\n#ifdef HAS_ALBEDO_MAP\nglFragColor *= texture2D(baseColorTexture, vTexCoord);\n#endif\n#ifdef HAS_DIFFUSE_MAP\nglFragColor *= texture2D(diffuseTexture, vTexCoord);\n#endif\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,n)=>re(e,n.projViewMatrix,n.modelMatrix)}],defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}class Xh extends Vh{constructor(t={}){super({vert:Uh,frag:Gh,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}var Zh="#if __VERSION__ == 300\n#define attribute in\n#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}";const qh=new Int8Array([-1,1,-1,-1,1,1,1,1,-1,-1,1,-1]),Yh=new Uint8Array([0,1,0,0,1,1,1,1,0,0,1,0]);class Kh extends jh{constructor(t){t.vert=t.vert||Zh,t.extraCommandProps=t.extraCommandProps||{},t.extraCommandProps.depth||(t.extraCommandProps.depth={enable:!1,mask:!1}),t.extraCommandProps.stencil||(t.extraCommandProps.stencil={enable:!1}),super(t)}draw(t){return this._quadMesh||this._createQuadMesh(t),super.draw(t,this._quadMesh)}getMeshCommand(t){const e=this.dkey||"";return this.commands[e+"_quad"]||(this.commands[e+"_quad"]=this.createREGLCommand(t,null,this._quadMesh[0].getElements())),this.commands[e+"_quad"]}_createQuadMesh(t){const e=new La({aPosition:qh,aTexCoord:Yh},null,qh.length/2,{positionSize:2,primitive:"triangles"});e.generateBuffers(t),this._quadMesh=[new Ya(e)]}dispose(){if(this._quadMesh){const t=this._quadMesh[0];t.geometry.dispose(),t.dispose()}return delete this._quadMesh,super.dispose()}}class Jh extends Kh{constructor(){super({vert:Zh,frag:"#define SHADER_NAME FXAA\n#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#define FXAA_SPAN_MAX     8.0\nprecision mediump float;\nvarying vec2 vTexCoord;\nuniform float enableFXAA;\nuniform float enableToneMapping;\nuniform float enableSharpen;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\n#ifdef HAS_TAA_TEX\nuniform sampler2D taaTextureSource;\n#ifdef HAS_FXAA_TEX\nuniform sampler2D fxaaTextureSource;\n#endif\n#endif\nuniform float pixelRatio;\nuniform float sharpFactor;\n#ifdef HAS_OUTLINE_TEX\nuniform sampler2D textureOutline;\nuniform float enableOutline;\nuniform float highlightFactor;\nuniform float outlineFactor;\nuniform float outlineWidth;\nuniform vec3 outlineColor;\n#endif\nvec2 c;\nvec4 d(vec2 e) {\n  \n#ifdef HAS_TAA_TEX\nvec4 f = texture2D(textureSource, e);\n  vec4 taa = texture2D(taaTextureSource, e);\n#ifdef HAS_FXAA_TEX\nvec4 h = texture2D(fxaaTextureSource, e);\n#else\nvec4 h = vec4(.0);\n#endif\nvec4 i = taa + f * (1. - taa.a);\n  return h + i * (1. - h.a);\n#else\nreturn texture2D(textureSource, e);\n#endif\n}\nvec4 j(vec2 k) {\n  vec4 l;\n  mediump vec2 m = vec2(1. / resolution.x, 1. / resolution.y);\n  vec3 n = d((k + vec2(-1., -1.)) * m).xyz;\n  vec3 o = d((k + vec2(1., -1.)) * m).xyz;\n  vec3 u = d((k + vec2(-1., 1.)) * m).xyz;\n  vec3 v = d((k + vec2(1.)) * m).xyz;\n  vec4 A = d(k * m);\n  vec3 B = A.xyz;\n  vec3 C = vec3(.299, .587, .114);\n  float D = dot(n, C);\n  float E = dot(o, C);\n  float F = dot(u, C);\n  float G = dot(v, C);\n  float H = dot(B, C);\n  float I = min(H, min(min(D, E), min(F, G)));\n  float J = max(H, max(max(D, E), max(F, G)));\n  mediump vec2 K;\n  K.x = -((D + E) - (F + G));\n  K.y = (D + F) - (E + G);\n  float L = max((D + E + F + G) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n  float M = 1. / (min(abs(K.x), abs(K.y)) + L);\n  K = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), K * M)) * m;\n  vec4 N = .5 * (d(k * m + K * (1. / 3. - .5)) + d(k * m + K * (2. / 3. - .5)));\n  vec4 O = N * .5 + .25 * (d(k * m + K * -.5) + d(k * m + K * .5));\n  float P = dot(O.xyz, C);\n  if(P < I || P > J)\n    l = N;\n  else\n    l = O;\n  return l;\n}\nvec3 Q(const in vec3 l, const float R) {\n  vec2 S = pixelRatio / resolution.xy;\n  float T = .0;\n  vec4 n = texture2D(textureSource, c + S * vec2(-1., -1.));\n  n.rgb = mix(vec3(.0), n.rgb, sign(n.a));\n  T += mix(.0, 1., sign(n.a));\n  vec4 v = texture2D(textureSource, c + S * vec2(1.));\n  v.rgb = mix(vec3(.0), v.rgb, sign(v.a));\n  T += mix(.0, 1., sign(v.a));\n  vec4 o = texture2D(textureSource, c + S * vec2(1., -1.));\n  o.rgb = mix(vec3(.0), o.rgb, sign(o.a));\n  T += mix(.0, 1., sign(o.a));\n  vec4 u = texture2D(textureSource, c + S * vec2(-1., 1.));\n  u.rgb = mix(vec3(.0), u.rgb, sign(u.a));\n  T += mix(.0, 1., sign(u.a));\n  return l + R * (T * l - n.rgb - o.rgb - u.rgb - v.rgb);\n}\nvec4 U(const in vec4 l) {\n  return vec4(Q(l.rgb, sharpFactor), l.a);\n}\nvec3 V(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float W = 2.43;\n  const float X = .59;\n  const float Y = .14;\n  return (x * (a * x + b)) / (x * (W * x + X) + Y);\n}\nvec3 Z(vec3 l) {\n  l = l / (l + vec3(1.));\n  return l = pow(l, vec3(1. / 2.2));\n}\n#ifdef HAS_OUTLINE_TEX\nvec4 ba() {\n  float bb = 2.;\n  float bc = 1.;\n  float bd = pixelRatio / resolution[0] * outlineWidth;\n  float be = pixelRatio / resolution[1] * outlineWidth;\n  vec4 bf = (texture2D(textureOutline, c + vec2(bd, be)));\n  vec4 bg = (texture2D(textureOutline, c + vec2(bd, .0)));\n  vec4 bh = (texture2D(textureOutline, c + vec2(bd, -be)));\n  vec4 bi = (texture2D(textureOutline, c + vec2(.0, -be)));\n  vec4 bj = (texture2D(textureOutline, c + vec2(-bd, -be)));\n  vec4 bk = (texture2D(textureOutline, c + vec2(-bd, .0)));\n  vec4 bl = (texture2D(textureOutline, c + vec2(-bd, be)));\n  vec4 bm = (texture2D(textureOutline, c + vec2(.0, be)));\n  vec4 bn = -bb * bk + bb * bg + -bc * bl + bc * bf + -bc * bj + bc * bh;\n  vec4 bo = -bb * bi + bb * bm + -bc * bj + bc * bl + -bc * bh + bc * bf;\n  float bp = sqrt(dot(bo, bo) + dot(bn, bn));\n  bool bq = bp < 1. / 65025.;\n  vec3 br = (texture2D(textureOutline, c)).r * outlineColor;\n  if(br == vec3(.0) || (highlightFactor == .0 && bq)) {\n    return vec4(.0);\n  }\n  float bs = bq ? highlightFactor : min(1., sqrt(bp) * outlineFactor);\n  return bs * vec4(br, 1.);\n}\nvec4 bt(const in vec4 l) {\n  vec4 ba = ba();\n  return ba + vec4(l) * (1. - ba.a);\n}\n#endif\nvoid main() {\n  c = vTexCoord;\n  vec4 l;\n  if(enableFXAA == 1.) {\n    l = j(c * resolution);\n  } else {\n    l = d(vTexCoord);\n  }\n  if(enableSharpen == 1.) {\n    l = U(l);\n  }\n#if defined(HAS_NOAA_TEX) || defined(HAS_POINT_TEX)\nvec4 bu = vec4(.0);\n  vec4 bv = vec4(.0);\n#ifdef HAS_POINT_TEX\nbu = texture2D(pointTextureSource, vTexCoord);\n#endif\n#ifdef HAS_NOAA_TEX\nbv = texture2D(noAaTextureSource, vTexCoord);\n#endif\nvec4 bw = bu + bv * (1. - bu.a);\n  l = bw + l * (1. - bw.a);\n#endif\nif(enableToneMapping == 1.) {\n    l.rgb = Z(l.rgb);\n  }\n#ifdef HAS_OUTLINE_TEX\nl = bt(l);\n#endif\ngl_FragColor = l;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){const n=this.dkey||"";return this.commands[n+"_fxaa"]||(this.commands[n+"_fxaa"]=this.createREGLCommand(t,null,e.getElements())),this.commands[n+"_fxaa"]}}class Qh extends Kh{constructor({blurOffset:t}){super({vert:Zh,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\nuniform float ignoreTransparent;\nvoid main() {\n  vec4 c = vec4(.0);\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      vec4 f = texture2D(textureSource, e);\n      float h;\n      if(ignoreTransparent == 1.) {\n        h = sign(f.a);\n      } else {\n        h = 1.;\n      }\n      d += h;\n      c += h * f;\n    }\n  gl_FragColor = c / max(d, 1.) * clamp(sign(d - 1.), .0, 1.);\n}",defines:{BOXBLUR_OFFSET:t||2},extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}}class $h extends Kh{constructor(){super({vert:Zh,frag:"precision mediump float;\n#define SHADER_NAME SSAO_BLUR\nstruct MaterialParams {\n  float farPlaneOverEdgeDistance;\n  vec2 axis;\n  vec2 resolution;\n};\nuniform sampler2D materialParams_ssao;\nuniform sampler2D TextureInput;\nuniform MaterialParams materialParams;\nvarying vec2 vTexCoord;\nconst int c = 6;\nfloat d[8];\nvoid e() {\n  d[0] = .099736;\n  d[1] = .096667;\n  d[2] = .088016;\n  d[3] = .075284;\n  d[4] = .060493;\n  d[5] = .045662;\n}\nfloat f(vec2 h) {\n  return (h.x * (256. / 257.) + h.y * (1. / 257.));\n}\nvoid tap(inout float i, inout float j, float k, float h, vec2 l) {\n  vec3 m = texture2D(materialParams_ssao, l).rgb;\n  float n = k;\n  i += m.r * n;\n  j += n;\n}\nvoid main() {\n  e();\n  highp vec2 o = vTexCoord;\n  vec3 m = texture2D(materialParams_ssao, o).rgb;\n  if(m.g * m.b == 1.) {\n    if(materialParams.axis.y > .0) {\n      vec4 u = texture2D(TextureInput, o);\n      gl_FragColor = u;\n    } else {\n      gl_FragColor = vec4(m, 1.);\n    }\n    return;\n  }\n  float h = f(m.gb);\n  float j = d[0];\n  float i = m.r * j;\n  vec2 v = materialParams.axis / materialParams.resolution;\n  vec2 A = v;\n  for(int B = 1; B < c; B++) {\n    float k = d[B];\n    tap(i, j, k, h, o + A);\n    tap(i, j, k, h, o - A);\n    A += v;\n  }\n  float C = i * (1. / j);\n  vec2 gb = m.gb;\n  if(materialParams.axis.y > .0) {\n    vec4 u = texture2D(TextureInput, o);\n    gl_FragColor = vec4(u.rgb * C, u.a);\n  } else {\n    gl_FragColor = vec4(C, gb, 1.);\n  }\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}})}getMeshCommand(t,e){return this.commands.ssao_blur||(this.commands.ssao_blur=this.createREGLCommand(t,null,e.getElements())),this.commands.ssao_blur}}const tl=[-2e-6,0,2e-6,-.095089,.004589,-.031253,.01518,-.025586,.003765,.073426,.021802,.002778,.094587,.043218,.089148,-.009509,.051369,.019673,.139973,-.101685,.10857,-.103804,.219853,-.043016,.004841,-.033988,.094187,.028011,.058466,-.25711,-.051031,.074993,.259843,.118822,-.186537,-.134192,.063949,-.094894,-.072683,.108176,.327108,-.254058,-.04718,.21918,.263895,-.407709,.240834,-.200352];class el extends Kh{constructor(){super({vert:Zh,frag:"#if __VERSION__ == 100\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision highp float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#define SHADER_NAME SSAO_EXTRACT\n#define PI 3.14159265359\nconst float c = .0625;\nstruct MaterialParams {\n  mat4 projMatrix;\n  mat4 invProjMatrix;\n  vec4 resolution;\n  float radius;\n  float bias;\n  float power;\n  vec2 cameraNearFar;\n};\nuniform MaterialParams materialParams;\nuniform sampler2D materialParams_depth;\n#define NOISE_NONE      0\n#define NOISE_PATTERN   1\n#define NOISE_RANDOM    2\n#define NOISE_TYPE      NOISE_PATTERN\nconst int d = 16;\nuniform vec3 kSphereSamples[16];\nvec3 e(const int x) {\n  if(x == 0) {\n    return vec3(-.078247, -.749924, -.656880);\n  } else if(x == 1) {\n    return vec3(-.572319, -.102379, -.813615);\n  } else if(x == 2) {\n    return vec3(.048653, -.380791, .923380);\n  } else if(x == 3) {\n    return vec3(.281202, -.656664, -.699799);\n  } else if(x == 4) {\n    return vec3(.711911, -.235841, -.661485);\n  } else if(x == 5) {\n    return vec3(-.445893, .611063, .654050);\n  } else if(x == 6) {\n    return vec3(-.703598, .674837, .222587);\n  } else if(x == 7) {\n    return vec3(.768236, .507457, .390257);\n  } else if(x == 8) {\n    return vec3(-.670286, -.470387, .573980);\n  } else if(x == 9) {\n    return vec3(.199235, .849336, -.488808);\n  } else if(x == 10) {\n    return vec3(-.768068, -.583633, -.263520);\n  } else if(x == 11) {\n    return vec3(-.897330, .328853, .294372);\n  } else if(x == 12) {\n    return vec3(-.570930, -.531056, -.626114);\n  } else if(x == 13) {\n    return vec3(.699014, .063283, -.712303);\n  } else if(x == 14) {\n    return vec3(.207495, .976129, -.064172);\n  } else if(x == 15) {\n    return vec3(-.060901, -.869738, -.489742);\n  } else {\n    return vec3(.0);\n  }\n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n}\nvec2 f(highp float h) {\n  highp float z = clamp(h * 1. / -materialParams.cameraNearFar.y, .0, 1.);\n  highp float t = floor(256. * z);\n  mediump float i = t * (1. / 256.);\n  mediump float j = 256. * z - t;\n  return vec2(i, j);\n}\nfloat k(highp vec2 l) {\n  l = fract(l * vec2(5.3987, 5.4421));\n  l += dot(l.yx, l.xy + vec2(21.5351, 14.3137));\n  highp float xy = l.x * l.y;\n  return fract(xy * 95.4307) + fract(xy * 75.04961) * .5;\n}\nvec3 m(const vec2 o) {\n  \n#if NOISE_TYPE == NOISE_RANDOM\nreturn normalize(2. * vec3(k(o), k(o * 2.), k(o * 4.)) - vec3(1.));\n#elif NOISE_TYPE == NOISE_PATTERN\nvec2 xy = floor(gl_FragCoord.xy);\n  float u = mod(xy.x, 4.);\n  float v = mod(xy.y, 4.);\n  return e(int(u + v * 4.));\n#else\nreturn vec3(.0);\n#endif\n}\nhighp mat4 A() {\n  return materialParams.projMatrix;\n}\nhighp mat4 B() {\n  return materialParams.invProjMatrix;\n}\nhighp float C(const vec2 o) {\n  return texture2D(materialParams_depth, o).r;\n}\nhighp float D(highp float h) {\n  highp mat4 E = A();\n  highp float z = h * 2. - 1.;\n  return -E[3].z / (z + E[2].z);\n}\nhighp float F(const vec2 o) {\n  return D(texture2D(materialParams_depth, o).r);\n}\nhighp vec3 G(in vec2 p, highp float H) {\n  p = p * 2. - 1.;\n  highp mat4 I = B();\n  p.x *= I[0].x;\n  p.y *= I[1].y;\n  return vec3(p * -H, H);\n}\nhighp vec3 J(const highp vec3 K) {\n  highp vec3 L = dFdx(K);\n  highp vec3 M = dFdy(K);\n  return cross(L, M);\n}\nhighp vec3 J(const highp vec3 K, const vec2 o) {\n  vec2 N = o + vec2(materialParams.resolution.z, .0);\n  vec2 O = o + vec2(.0, materialParams.resolution.w);\n  highp vec3 px = G(N, F(N));\n  highp vec3 py = G(O, F(O));\n  highp vec3 L = px - K;\n  highp vec3 M = py - K;\n  return cross(L, M);\n}\nfloat P(const highp vec3 Q, const highp float R, mat3 S, const vec3 T, const vec3 U) {\n  highp mat4 E = A();\n  float V = materialParams.radius;\n  float W = materialParams.bias;\n  highp vec3 X = S * U;\n  float Y = dot(X, T);\n  X = sign(Y) * X;\n  X = Q + X * V;\n  highp vec4 Z = E * vec4(X, 1.);\n  Z.xy = Z.xy * (.5 / Z.w) + .5;\n  highp float ba = C(Z.xy);\n  ba = D(ba);\n  float t = saturate(V / abs(R - ba));\n  float bb = t * t * (3. - 2. * t);\n  return (ba >= X.z + W ? bb : .0);\n}\nvoid main() {\n  highp vec2 o = vTexCoord;\n  highp float h = C(o);\n  highp float bc = D(h);\n  highp vec3 Q = G(o, bc);\n  highp vec3 T = J(Q, o);\n  T = normalize(T);\n  vec3 bd = m(o);\n  vec3 be = bd.xyz;\n  vec3 bf = normalize(be - T * dot(be, T));\n  vec3 bg = cross(T, bf);\n  mat3 S = mat3(bf, bg, T);\n  float bh = .0;\n  for(int bi = 0; bi < d; bi++) {\n    bh += P(Q, bc, S, T, kSphereSamples[bi]);\n  }\n  float bj = 1. - bh / float(d);\n  bj = mix(bj, bj * bj, materialParams.power);\n  glFragColor = vec4(bj, f(Q.z), 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"kSphereSamples",type:"function",fn:function(){return tl}}],extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}),this.version=300}getMeshCommand(t,e){return this.commands.ssao_extract||(this.commands.ssao_extract=this.createREGLCommand(t,null,e.getElements())),this.commands.ssao_extract}}const nl=[];class il{constructor(t){this._renderer=t}render(t,e,n){const{width:i,height:r}=n;return this._initShaders(),this._extractFBO||this._createTextures(n),this._extract(t,i,r,n),this._blurAndCombine(e,t.cameraFar,i,r)}_blurAndCombine(t,e,n,i){const r=Math.floor(n/2),o=Math.floor(i/2);this._blurHTex.width===r&&this._blurHTex.height===o||(this._blurHFBO.resize(r,o),this._blurVFBO.resize(n,i));const s=[n,i],a=[1,0];return this._renderer.render(this._ssaoBlurShader,{TextureInput:t,materialParams_ssao:this._extractTex,materialParams:{axis:a,farPlaneOverEdgeDistance:-e/.0625,resolution:s},outputSize:[r,o]},null,this._blurHFBO),a[0]=0,a[1]=1,this._renderer.render(this._ssaoBlurShader,{TextureInput:t,materialParams_ssao:this._blurHTex,materialParams:{axis:a,farPlaneOverEdgeDistance:-e/.0625,resolution:s},outputSize:[n,i]},null,this._blurVFBO),this._blurVTex}_extract(t,e,n,i){const r=Math.floor(e/2),o=Math.floor(n/2);this._extractFBO.width===r&&this._extractFBO.height===o||this._extractFBO.resize(r,o);const{projMatrix:s}=t,a=ee(nl,s);this._renderer.render(this._ssaoExtractShader,{materialParams_depth:i,materialParams:{projMatrix:s,invProjMatrix:a,resolution:[r,o,1/r,1/o],radius:t.radius,bias:t.bias,power:t.power||1,cameraNearFar:[t.cameraNear,t.cameraFar]},outputSize:[r,o]},null,this._extractFBO)}_createTextures(t){const e=Math.floor(t.width/2),n=Math.floor(t.height/2);this._extractTex=this._createTex(e,n,"uint8"),this._extractFBO=this._createFBO(this._extractTex),this._blurHTex=this._createTex(e,n,"uint8"),this._blurHFBO=this._createFBO(this._blurHTex),this._blurVTex=this._createTex(t.width,t.height,"uint8"),this._blurVFBO=this._createFBO(this._blurVTex)}_createTex(t,e,n){return this._renderer.regl.texture({min:"linear",mag:"linear",wrap:"clamp",type:n,width:t,height:e})}_createFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}dispose(){this._extractFBO&&(this._extractFBO.destroy(),delete this._extractFBO,this._blurVFBO.destroy(),this._blurHFBO.destroy(),this._ssaoExtractShader.dispose(),this._ssaoBlurShader.dispose(),delete this._ssaoExtractShader)}_initShaders(){this._ssaoExtractShader||(this._ssaoExtractShader=new el,this._ssaoBlurShader=new $h)}}class rl extends Kh{constructor(){super({vert:Zh,frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\nuniform float enableVignette;\nuniform float enableGrain;\nuniform float enableLut;\nuniform float timeGrain;\nuniform float grainFactor;\nuniform vec2 lensRadius;\nuniform float frameMod;\nuniform sampler2D lookupTable;\nfloat c(const in vec2 d) {\n  vec3 e = fract(vec3(d.xyx) * .1031);\n  e += dot(e, e.yzx + 19.19);\n  return fract((e.x + e.y) * e.z);\n}\nfloat f() {\n  float h = c(gl_FragCoord.xy + 1000.0 * fract(timeGrain));\n  float i = h * 2. - 1.;\n  h = i * inversesqrt(abs(i));\n  h = max(-1., h);\n  h = h - sign(i) + .5;\n  return (h + .5) * .5;\n}\nvec4 j(const in vec4 k) {\n  float l = f();\n  return vec4(mix(k.rgb, k.rgb * (k.rgb + (1. - k.rgb) * 2. * l), grainFactor), k.a);\n}\nfloat m(const in float k) {\n  return k < .0031308 ? k * 12.92 : 1.055 * pow(k, 1. / 2.4) - .055;\n}\nvec3 m(const in vec3 k) {\n  return vec3(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055);\n}\nvec4 m(const in vec4 k) {\n  return vec4(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055, k.a);\n}\nfloat n(const in float k) {\n  return k < .04045 ? k * (1. / 12.92) : pow((k + .055) * (1. / 1.055), 2.4);\n}\nvec3 n(const in vec3 k) {\n  return vec3(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4));\n}\nvec4 n(const in vec4 k) {\n  return vec4(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4), k.a);\n}\nfloat o(const in vec2 d, const in float u) {\n  vec3 v = vec3(.06711056, .00583715, 52.9829189);\n  return fract(v.z * fract(dot(d.xy + u * vec2(47., 17.) * .695, v.xy)));\n}\nfloat A() {\n  vec2 B = lensRadius;\n  B.y = min(B.y, B.x - 1e-4);\n  float C = o(gl_FragCoord.xy, frameMod);\n  C = (B.x - B.y) * (B.x + B.y) * .07 * (C - .5);\n  return smoothstep(B.x, B.y, C + distance(vTexCoord, vec2(.5)));\n}\nvec4 D(const in vec4 k) {\n  float l = A();\n  return vec4(m(n(k.rgb) * l), clamp(k.a + (1. - l), .0, 1.));\n}\nvec4 E(in vec4 F, in sampler2D G) {\n  mediump float H = F.b * 63.;\n  mediump vec2 I;\n  I.y = floor(floor(H) / 8.);\n  I.x = floor(H) - I.y * 8.;\n  mediump vec2 J;\n  J.y = floor(ceil(H) / 8.);\n  J.x = ceil(H) - J.y * 8.;\n  highp vec2 K;\n  K.x = I.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;\n  K.y = I.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;\n#ifdef LUT_FLIP_Y\nK.y = 1. - K.y;\n#endif\nhighp vec2 L;\n  L.x = J.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;\n  L.y = J.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;\n#ifdef LUT_FLIP_Y\nL.y = 1. - L.y;\n#endif\nlowp vec4 M = texture2D(G, K);\n  lowp vec4 N = texture2D(G, L);\n  lowp vec4 O = mix(M, N, fract(H));\n  return O;\n}\nvoid main() {\n  vec4 k = texture2D(textureSource, vTexCoord);\n  if(enableLut == 1.) {\n    k = E(k, lookupTable);\n  }\n  if(enableVignette == 1.) {\n    k = D(k);\n  }\n  if(enableGrain == 1.) {\n    k = j(k);\n  }\n  gl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){return this.commands.postprocess||(this.commands.postprocess=this.createREGLCommand(t,null,e.getElements())),this.commands.postprocess}}class ol extends Kh{constructor(){super({vert:Zh,frag:"#define SHADER_NAME TAA\nprecision mediump float;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#if defined(TARGET_METAL_ENVIRONMENT) || defined(TARGET_VULKAN_ENVIRONMENT)\n#define TEXTURE_SPACE_UP    -1\n#define TEXTURE_SPACE_DN     1\n#else\n#define TEXTURE_SPACE_UP     1\n#define TEXTURE_SPACE_DN    -1\n#endif\n#define BOX_TYPE_AABB           0\n#define BOX_TYPE_VARIANCE       1\n#define BOX_TYPE_AABB_VARIANCE  2\n#define VARIANCE_GAMMA          1.0\n#define BOX_CLIPPING_ACCURATE   0\n#define BOX_CLIPPING_CLAMP      1\n#define BOX_CLIPPING_NONE       2\n#if defined(TARGET_MOBILE)\n#define BOX_CLIPPING            BOX_CLIPPING_ACCURATE\n#define BOX_TYPE                BOX_TYPE_VARIANCE\n#define USE_YCoCg               0\n#define FILTER_INPUT            1\n#define FILTER_HISTORY          0\n#else\n#define BOX_CLIPPING            BOX_CLIPPING_ACCURATE\n#define BOX_TYPE                BOX_TYPE_AABB_VARIANCE\n#define USE_YCoCg               0\n#define FILTER_INPUT            0\n#define FILTER_HISTORY          0\n#endif\n#define HISTORY_REPROJECTION    1\n#define PREVENT_FLICKERING      0\nstruct MaterialParams {\n  float alpha;\n  mat4 reprojection;\n};\nuniform sampler2D materialParams_color;\nuniform sampler2D materialParams_history;\nuniform vec2 materialParams_history_size;\nuniform vec2 textureOutputSize;\nuniform sampler2D materialParams_depth;\nuniform MaterialParams materialParams;\nfloat c(const vec3 d) {\n  return dot(d, vec3(.2126, .7152, .0722));\n}\nfloat e(const vec3 f) {\n  \n#if USE_YCoCg\nreturn f.x;\n#else\nreturn c(f);\n#endif\n}\nvec3 h(const vec3 i) {\n  float j = dot(i.rgb, vec3(1, 2, 1) * .25);\n  float k = dot(i.rgb, vec3(2, 0, -2) * .25);\n  float l = dot(i.rgb, vec3(-1, 2, -1) * .25);\n  return vec3(j, k, l);\n}\nvec3 m(const vec3 i) {\n  float j = i.x;\n  float k = i.y;\n  float l = i.z;\n  float r = j + k - l;\n  float g = j + l;\n  float b = j - k - l;\n  return vec3(r, g, b);\n}\nvec4 n(const int o, const vec3 u, const vec3 v, const vec4 i, const vec4 A) {\n  const float B = .0001;\n  if(o == BOX_CLIPPING_ACCURATE) {\n    vec4 r = i - A;\n    vec3 C = 1. / (B + r.rgb);\n    vec3 D = (v - A.rgb) * C;\n    vec3 E = (u - A.rgb) * C;\n    vec3 F = min(D, E);\n    return A + r * saturate(max(max(F.x, F.y), F.z));\n  } else if(o == BOX_CLIPPING_CLAMP) {\n    return vec4(clamp(A.rgb, u, v), A.a);\n  }\n  return A;\n}\nvec4 G(const sampler2D H, const highp vec2 I, const highp vec2 J) {\n  highp vec2 K = I * J;\n  highp vec2 L = floor(K - .5) + .5;\n  highp vec2 M = K - L;\n  highp vec2 N = M * M;\n  highp vec2 O = N * M;\n  vec2 P = N - .5 * (O + M);\n  vec2 Q = 1.5 * O - 2.5 * N + 1.;\n  vec2 R = .5 * (O - N);\n  vec2 S = 1. - P - Q - R;\n  vec2 T = Q + S;\n  highp vec2 U = L - vec2(1.);\n  highp vec2 V = L + vec2(2.);\n  highp vec2 W = L + S / T;\n  highp vec2 X = 1. / J;\n  U *= X;\n  V *= X;\n  W *= X;\n  float Z = T.x * P.y;\n  float ba = P.x * T.y;\n  float bb = T.x * T.y;\n  float bc = R.x * T.y;\n  float bd = T.x * R.y;\n  vec4 be = texture2D(H, vec2(W.x, U.y)) * Z + texture2D(H, vec2(U.x, W.y)) * ba + texture2D(H, vec2(W.x, W.y)) * bb + texture2D(H, vec2(V.x, W.y)) * bc + texture2D(H, vec2(W.x, V.y)) * bd;\n  be *= 1. / (Z + ba + bb + bc + bd);\n  return be;\n}\nvec4 bf(sampler2D H, vec2 I, float bg, ivec2 bh) {\n  return texture2D(H, I + vec2(bh));\n}\nvoid main() {\n  highp vec4 I = (gl_FragCoord.xy / textureOutputSize.xy).xyxy;\n  float bi = texture2D(materialParams_depth, I.xy).r;\n#if HISTORY_REPROJECTION\n#if defined(TARGET_METAL_ENVIRONMENT) || defined(TARGET_VULKAN_ENVIRONMENT)\nI.w = 1. - I.w;\n#endif\nhighp vec4 q = materialParams.reprojection * vec4(I.zw, bi, 1.);\n  I.zw = (q.xy * (1. / q.w)) * .5 + .5;\n#if defined(TARGET_METAL_ENVIRONMENT) || defined(TARGET_VULKAN_ENVIRONMENT)\nI.w = 1. - I.w;\n#endif\n#endif\nvec4 f = bf(materialParams_color, I.xy, .0, ivec2(0));\n#if FILTER_HISTORY\nvec4 bj = G(materialParams_history, I.zw, materialParams_history_size);\n#else\nvec4 bj = texture2D(materialParams_history, I.zw);\n#endif\n#if USE_YCoCg\nbj.rgb = h(bj.rgb);\n#endif\nvec3 s[9];\n  s[0] = bf(materialParams_color, I.xy, .0, ivec2(-1, TEXTURE_SPACE_DN)).rgb;\n  s[1] = bf(materialParams_color, I.xy, .0, ivec2(0, TEXTURE_SPACE_DN)).rgb;\n  s[2] = bf(materialParams_color, I.xy, .0, ivec2(1, TEXTURE_SPACE_DN)).rgb;\n  s[3] = bf(materialParams_color, I.xy, .0, ivec2(-1, 0)).rgb;\n  s[4] = f.rgb;\n  s[5] = bf(materialParams_color, I.xy, .0, ivec2(1, 0)).rgb;\n  s[6] = bf(materialParams_color, I.xy, .0, ivec2(-1, TEXTURE_SPACE_UP)).rgb;\n  s[7] = bf(materialParams_color, I.xy, .0, ivec2(0, TEXTURE_SPACE_UP)).rgb;\n  s[8] = bf(materialParams_color, I.xy, .0, ivec2(1, TEXTURE_SPACE_UP)).rgb;\n#if USE_YCoCg\nfor(int bk = 0; bk < 9; bk++) {\n    s[bk] = h(s[bk]);\n  }\n  f.rgb = s[4].rgb;\n#endif\n#if FILTER_INPUT\n#else\nvec4 bl = f;\n#endif\n#if BOX_TYPE == BOX_TYPE_AABB || BOX_TYPE == BOX_TYPE_AABB_VARIANCE\nvec3 u = min(s[4], min(min(s[1], s[3]), min(s[5], s[7])));\n  vec3 v = max(s[4], max(max(s[1], s[3]), max(s[5], s[7])));\n  vec3 bm = min(u, min(min(s[0], s[2]), min(s[6], s[8])));\n  vec3 bn = max(v, max(max(s[0], s[2]), max(s[6], s[8])));\n  u = (u + bm) * .5;\n  v = (v + bn) * .5;\n#endif\n#if BOX_TYPE == BOX_TYPE_VARIANCE || BOX_TYPE == BOX_TYPE_AABB_VARIANCE\nvec3 bo = s[4];\n  vec3 bp = s[4] * s[4];\n  for(int bk = 1; bk < 9; bk += 2) {\n    bo += s[bk];\n    bp += s[bk] * s[bk];\n  }\n  vec3 bq = bo * (1. / 5.);\n  vec3 br = bp * (1. / 5.);\n  vec3 bs = sqrt(br - bq * bq);\n#if BOX_TYPE == BOX_TYPE_VARIANCE\nvec3 u = bq - VARIANCE_GAMMA * bs;\n  vec3 v = bq + VARIANCE_GAMMA * bs;\n#else\nu = min(u, bq - VARIANCE_GAMMA * bs);\n  v = max(v, bq + VARIANCE_GAMMA * bs);\n#endif\n#endif\nfloat bt = e(bl.rgb);\n  float bu = e(bj.rgb);\n  float bv = materialParams.alpha;\n#if PREVENT_FLICKERING\nfloat bw = 1. - abs(bt - bu) / (.001 + max(bt, bu));\n  bv *= bw * bw;\n#endif\nbl.rgb *= 1. / (1. + bt);\n  bj.rgb *= 1. / (1. + bu);\n  vec4 be = mix(bj, bl, bv);\n  be.rgb *= 1. / (1. - e(be.rgb));\n#if USE_YCoCg\nbe.rgb = m(be.rgb);\n#endif\nbe = max(vec4(0), be);\n  gl_FragColor = be;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.materialParams_color.width,height:(t,e)=>e.materialParams_color.height},blend:{enable:!1}}})}getMeshCommand(t,e){return this.commands.taa||(this.commands.taa=this.createREGLCommand(t,null,e.getElements())),this.commands.taa}}const sl=[2,0,0,0,0,2,0,0,0,0,-2,0,-1,-1,1,1];class al{constructor(t,e){this._jitter=e,this._renderer=t,this._halton=[],this._counter=0}needToRedraw(){return this._counter<this._jitter.getSampleCount()}render(t,e,n,i){const r=this._jitter;this._initShaders(),this._createTextures(t),i&&(this._counter=0),this._counter++;const o=r.getSampleCount();if(this._counter>=o)return this._prevTex;this._fbo.width===t.width&&this._fbo.height===t.height||this._fbo.resize(t.width,t.height);const s=this._outputTex,a=this._prevTex,h=this._uniforms||{materialParams_history_size:[a.width,a.height],textureOutputSize:[],materialParams:{alpha:1,reprojection:[],filterWeights:[]}};h.materialParams.alpha=1/this._counter;const l=h.materialParams.reprojection;re(l,this._prevProjMatrix||n,ee(l,n)),re(l,l,sl),no(h.materialParams_history_size,a.width,a.height),no(h.textureOutputSize,t.width,t.height),h.materialParams_depth=e,h.materialParams_color=t,h.materialParams_history=a,this._renderer.render(this._shader,h,null,this._fbo);const c=this._outputTex,u=this._fbo;return this._outputTex=this._prevTex,this._fbo=this._prevFbo,this._prevTex=c,this._prevFbo=u,this._prevProjMatrix=Kt(this._prevProjMatrix||[],n),s}dispose(){this._shader&&(this._shader.dispose(),delete this._shader),this._fbo&&this._fbo.destroy(),this._prevFbo&&this._prevFbo.destroy(),delete this._uniforms}_createTextures(t){if(this._outputTex)return;const e=this._renderer.regl;this._outputTex=this._createColorTex(t),this._fbo=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1}),this._prevTex=this._createColorTex(t),this._prevFbo=e.framebuffer({width:t.width,height:t.height,colors:[this._prevTex],depth:!1,stencil:!1})}_createColorTex(t){return this._renderer.regl.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height})}_initShaders(){this._shader||(this._shader=new ol)}}const hl=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],ll=hl.length,cl=[0,0];for(let n=0;n<hl.length;n++)cl[0]+=hl[n][0],cl[1]+=hl[n][1];cl[0]/=ll,cl[1]/=ll;class ul{constructor(t){this._frameNum=0,this._ratio=t||.05,this._avg=[cl[0]*this._ratio,cl[1]*this._ratio]}getRatio(){return this._ratio}setRatio(t){this._ratio!==t&&(this._ratio=t,this.reset()),this._avg=[cl[0]*this._ratio,cl[1]*this._ratio]}getAverage(){return this._avg}reset(){this._frameNum=0}getJitter(t){const e=this._frameNum%ll,n=this._ratio;return no(t,hl[e][0]*n,hl[e][1]*n),t}frame(){this._frameNum++,this._frameNum%ll==0&&(this._frameNum=0)}getSampleCount(){return ll}}class fl{constructor(t,e,n=5){this._regl=t,this._renderer=new Ta(t),this._inputRGBM=e,this._level=n}render(t,e){this._initShaders(),this._createTextures(t),this._blur(t,e||0);const n={blurTex0:this._blur01Tex,blurTex1:this._blur11Tex,blurTex2:this._blur21Tex,blurTex3:this._blur31Tex,blurTex4:this._blur41Tex};return this._level>5&&(n.blurTex5=this._blur51Tex,n.blurTex6=this._blur61Tex),n}_blur(t,e){let n=this._blurUniforms;n||(n=this._blurUniforms={rgbmRange:7,blurDir:[0,0],outSize:[0,0],pixelRatio:[1,1],outputSize:[0,0]}),no(n.outSize,t.width,t.height),this._blurOnce(this._blur0Shader,t,this._blur00FBO,this._blur01FBO,.5,e),this._blurOnce(this._blur1Shader,this._blur01FBO.color[0],this._blur10FBO,this._blur11FBO,.5),this._blurOnce(this._blur2Shader,this._blur11FBO.color[0],this._blur20FBO,this._blur21FBO,.5),this._blurOnce(this._blur3Shader,this._blur21FBO.color[0],this._blur30FBO,this._blur31FBO,.5),this._blurOnce(this._blur4Shader,this._blur31FBO.color[0],this._blur40FBO,this._blur41FBO,.5),this._level>5&&(this._blurOnce(this._blur5Shader,this._blur41FBO.color[0],this._blur50FBO,this._blur51FBO,.5),this._blurOnce(this._blur6Shader,this._blur51FBO.color[0],this._blur60FBO,this._blur51FBO,.5))}_blurOnce(t,e,n,i,r,o){const s=Math.ceil(r*e.width),a=Math.ceil(r*e.height);n.width===s&&n.height===a||n.resize(s,a),i.width===s&&i.height===a||i.resize(s,a);const h=this._blurUniforms;h.luminThreshold=o,h.TextureBlurInput=e,h.inputRGBM=+this._inputRGBM,no(h.blurDir,0,1),no(h.outputSize,n.width,n.height),this._renderer.render(t,h,null,n),h.luminThreshold=0,h.inputRGBM=1,no(h.blurDir,1,0),h.TextureBlurInput=n.color[0],this._renderer.render(t,h,null,i)}dispose(){this._blur0Shader&&(this._blur0Shader.dispose(),delete this._blur0Shader,this._blur1Shader.dispose(),this._blur2Shader.dispose(),this._blur3Shader.dispose(),this._blur4Shader.dispose(),this._blur5Shader&&(this._blur5Shader.dispose(),this._blur6Shader.dispose(),delete this._blur5Shader)),this._blur00Tex&&(delete this._blur00Tex,this._blur00FBO.destroy(),this._blur01FBO.destroy(),this._blur10FBO.destroy(),this._blur11FBO.destroy(),this._blur20FBO.destroy(),this._blur21FBO.destroy(),this._blur30FBO.destroy(),this._blur31FBO.destroy(),this._blur40FBO.destroy(),this._blur41FBO.destroy(),this._blur50FBO&&(this._blur50FBO.destroy(),this._blur51FBO.destroy(),this._blur60FBO.destroy(),this._blur61FBO.destroy()))}_createTextures(t){if(this._blur00Tex)return;let e=t.width,n=t.height;this._blur00Tex=this._createColorTex(t,e,n),this._blur00FBO=this._createBlurFBO(this._blur00Tex),this._blur01Tex=this._createColorTex(t),this._blur01FBO=this._createBlurFBO(this._blur01Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur10Tex=this._createColorTex(t,e,n),this._blur10FBO=this._createBlurFBO(this._blur10Tex),this._blur11Tex=this._createColorTex(t,e,n),this._blur11FBO=this._createBlurFBO(this._blur11Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur20Tex=this._createColorTex(t,e,n),this._blur20FBO=this._createBlurFBO(this._blur20Tex),this._blur21Tex=this._createColorTex(t,e,n),this._blur21FBO=this._createBlurFBO(this._blur21Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur30Tex=this._createColorTex(t,e,n),this._blur30FBO=this._createBlurFBO(this._blur30Tex),this._blur31Tex=this._createColorTex(t,e,n),this._blur31FBO=this._createBlurFBO(this._blur31Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur40Tex=this._createColorTex(t,e,n),this._blur40FBO=this._createBlurFBO(this._blur40Tex),this._blur41Tex=this._createColorTex(t,e,n),this._blur41FBO=this._createBlurFBO(this._blur41Tex),this._level>5&&(e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur50Tex=this._createColorTex(t,e,n),this._blur50FBO=this._createBlurFBO(this._blur50Tex),this._blur51Tex=this._createColorTex(t,e,n),this._blur51FBO=this._createBlurFBO(this._blur51Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur60Tex=this._createColorTex(t,e,n),this._blur60FBO=this._createBlurFBO(this._blur60Tex),this._blur61Tex=this._createColorTex(t,e,n),this._blur61FBO=this._createBlurFBO(this._blur61Tex))}_createColorTex(t,e,n){return this._regl.texture({min:"linear",mag:"linear",type:"uint8",width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._blur0Shader){const t={vert:Zh,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}},frag:"#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\nuniform float inputRGBM;\nuniform float luminThreshold;\n#define SHADER_NAME GAUSSIAN_BLUR0\nconst vec3 c = vec3(.2126, .7152, .0722);\nfloat d(const in vec3 e) {\n  return dot(e, c);\n}\nvec4 f(vec4 e) {\n  float h = max(sign(d(e.rgb) - luminThreshold), .0);\n  return e * h;\n}\nvec2 i;\nvec4 j(const in vec3 e, const in float k) {\n  vec4 l;\n  vec3 m = e / k;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvec3 n(const in vec4 e, const in float k) {\n  if(inputRGBM == .0)\n    return e.rgb;\n  return k * e.rgb * e.a;\n}\nvec4 o() {\n  vec3 u = .375 * (f(vec4(n(texture2D(TextureBlurInput, i.xy), rgbmRange), 1.))).rgb;\n  vec2 v;\n  vec2 A = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  v = A * 1.2;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy + v.xy), rgbmRange), 1.))).rgb;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy - v.xy), rgbmRange), 1.))).rgb;\n  return vec4(u, 1.);\n}\nvoid main(void) {\n  i = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = o();\n  e = j(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}"};this._blur0Shader=new Kh(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR1\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .3125 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.2857142857142858;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur1Shader=new Kh(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR2\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2734375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3333333333333333;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.111111111111111;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur2Shader=new Kh(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR3\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .24609375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3636363636363635;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.1818181818181817;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur3Shader=new Kh(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR4\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2255859375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3846153846153846;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.230769230769231;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.076923076923077;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur4Shader=new Kh(t),this._level>5&&(t.frag="precision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR5\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .20947265625 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.4;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2666666666666666;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.133333333333334;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur5Shader=new Kh(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR6\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .196380615234375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.411764705882353;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2941176470588234;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.176470588235294;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur6Shader=new Kh(t))}}}class dl{constructor(t){this._regl=t,this._renderer=new Ta(t)}render(t,e,n,i,r,o,s,a,h){this._initShaders(),this._createTextures(t);const l=this._blurPass.render(e,n);return this._combine(t,l,e,i,r,o,s,a,h)}_combine(t,e,n,i,r,o,s,a,h){h||this._combineTex.width===t.width&&this._combineTex.height===t.height||this._combineFBO.resize(t.width,t.height);let l=this._combineUniforms;const{blurTex0:c,blurTex1:u,blurTex2:f,blurTex3:d,blurTex4:m}=e;l||(l=this._combineUniforms={bloomFactor:0,bloomRadius:0,rgbmRange:7,TextureBloomBlur1:c,TextureBloomBlur2:u,TextureBloomBlur3:f,TextureBloomBlur4:d,TextureBloomBlur5:m,TextureInput:null,TextureSource:null,outputSize:[0,0]}),l.noAaTextureSource=o,l.pointTextureSource=s,l.enableAA=a,l.bloomFactor=i,l.bloomRadius=r,l.TextureInput=n,l.TextureSource=t,no(l.outputSize,t.width,t.height);const g={};return o?g.HAS_NOAA_TEX=1:delete g.HAS_NOAA_TEX,s?g.HAS_POINT_TEX=1:delete g.HAS_POINT_TEX,this._combineShader.setDefines(g),this._renderer.render(this._combineShader,l,null,h?null:this._combineFBO),h?null:this._combineTex}dispose(){this._combineFBO&&(this._combineFBO.destroy(),delete this._combineFBO),this._blurPass&&(this._blurPass.dispose(),delete this._blurPass),delete this._uniforms}_createTextures(t){this._combineTex||(this._combineTex=this._createColorTex(t,t.width,t.height,"uint8"),this._combineFBO=this._createBlurFBO(this._combineTex))}_createColorTex(t,e,n,i){const r=this._renderer.regl,o=i||(r.hasExtension("OES_texture_half_float")?"float16":"float");return r.texture({min:"linear",mag:"linear",type:o,width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._combineShader){const t={x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]};this._blurPass=new fl(this._regl,!1),this._combineShader=new Kh({vert:Zh,frag:"#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#define FXAA_SPAN_MAX     8.0\nprecision highp float;\nuniform float bloomFactor;\nuniform float bloomRadius;\nuniform float rgbmRange;\nuniform sampler2D TextureBloomBlur1;\nuniform sampler2D TextureBloomBlur2;\nuniform sampler2D TextureBloomBlur3;\nuniform sampler2D TextureBloomBlur4;\nuniform sampler2D TextureBloomBlur5;\nuniform sampler2D TextureInput;\nuniform sampler2D TextureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\nuniform float enableAA;\nuniform vec2 outputSize;\n#define SHADER_NAME bloomCombine\nvec2 c;\nvec3 d(const in vec3 e) {\n  return vec3(e.r < .0031308 ? e.r * 12.92 : 1.055 * pow(e.r, 1. / 2.4) - .055, e.g < .0031308 ? e.g * 12.92 : 1.055 * pow(e.g, 1. / 2.4) - .055, e.b < .0031308 ? e.b * 12.92 : 1.055 * pow(e.b, 1. / 2.4) - .055);\n}\nvec3 f(const in vec4 e, const in float h) {\n  if(h <= .0)\n    return e.rgb;\n  return h * e.rgb * e.a;\n}\nfloat i(const float j, const float k) {\n  return mix(j, k * 2. - j, bloomRadius);\n}\nvec4 l(sampler2D m, vec2 n) {\n  vec4 e;\n  mediump vec2 o = vec2(1. / outputSize.x, 1. / outputSize.y);\n  vec3 u = texture2D(m, (n + vec2(-1., -1.)) * o).xyz;\n  vec3 v = texture2D(m, (n + vec2(1., -1.)) * o).xyz;\n  vec3 A = texture2D(m, (n + vec2(-1., 1.)) * o).xyz;\n  vec3 B = texture2D(m, (n + vec2(1.)) * o).xyz;\n  vec4 C = texture2D(m, n * o);\n  vec3 D = C.xyz;\n  vec3 E = vec3(.299, .587, .114);\n  float F = dot(u, E);\n  float G = dot(v, E);\n  float H = dot(A, E);\n  float I = dot(B, E);\n  float J = dot(D, E);\n  float K = min(J, min(min(F, G), min(H, I)));\n  float L = max(J, max(max(F, G), max(H, I)));\n  mediump vec2 M;\n  M.x = -((F + G) - (H + I));\n  M.y = (F + H) - (G + I);\n  float N = max((F + G + H + I) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n  float O = 1. / (min(abs(M.x), abs(M.y)) + N);\n  M = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), M * O)) * o;\n  vec4 P = .5 * (texture2D(m, n * o + M * (1. / 3. - .5)) + texture2D(m, n * o + M * (2. / 3. - .5)));\n  vec4 Q = P * .5 + .25 * (texture2D(m, n * o + M * -.5) + texture2D(m, n * o + M * .5));\n  float R = dot(Q.xyz, E);\n  if(R < K || R > L)\n    e = P;\n  else\n    e = Q;\n  return e;\n}\nvec4 S() {\n  vec3 T = vec3(.0);\n  const float U = .6;\n  const float V = 1.1;\n  const float W = .9;\n  const float X = .6;\n  const float Y = .3;\n  const float Z = .1;\n  T += (vec4(f(texture2D(TextureBloomBlur1, c), rgbmRange), 1.)).rgb * i(V, U);\n  T += (vec4(f(texture2D(TextureBloomBlur2, c), rgbmRange), 1.)).rgb * i(W, U);\n  T += (vec4(f(texture2D(TextureBloomBlur3, c), rgbmRange), 1.)).rgb * i(X, U);\n  T += (vec4(f(texture2D(TextureBloomBlur4, c), rgbmRange), 1.)).rgb * i(Y, U);\n  T += (vec4(f(texture2D(TextureBloomBlur5, c), rgbmRange), 1.)).rgb * i(Z, U);\n  vec4 ba;\n  if(enableAA == 1.) {\n    ba = l(TextureInput, gl_FragCoord.xy);\n  } else {\n    ba = texture2D(TextureInput, c);\n  }\n  ba.rgb = mix(vec3(.0), ba.rgb, sign(ba.a));\n  vec4 bb = texture2D(TextureSource, c);\n#ifdef HAS_NOAA_TEX\nvec4 bc = texture2D(noAaTextureSource, c);\n  bb = bc + bb * (1. - bc.a);\n#endif\nvec4 bd = vec4(.0);\n#ifdef HAS_POINT_TEX\nbd = texture2D(pointTextureSource, c);\n#endif\nfloat be = sqrt((T.r + T.g + T.b) / 3.);\n  vec4 bf = vec4(d(T * bloomFactor), be);\n  return bd + (ba + bb * (1. - ba.a)) * (1. - bd.a) + bf;\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = S();\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:t}})}}}class ml extends Kh{constructor(){const t=[];super({vert:Zh,frag:"precision highp float;\n#include <gl2_frag>\n#define SHADER_NAME COPY_DEPTH\nuniform sampler2D TextureDepth;\nuniform vec2 textureSize;\n#include <common_pack_float>\nvoid main(void) {\n  vec2 c = gl_FragCoord.xy / textureSize.xy;\n  float d = texture2D(TextureDepth, c).r;\n  glFragColor = common_encodeDepth(d);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"textureSize",type:"function",fn:(e,n)=>(t[0]=n.TextureDepth.width,t[1]=n.TextureDepth.height,t)}],extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.TextureDepth.width,height:(t,e)=>e.TextureDepth.height}}}),this.version=300}getMeshCommand(t,e){return this.commands.copy_depth||(this.commands.copy_depth=this.createREGLCommand(t,null,e.getElements())),this.commands.copy_depth}}class gl{static getUniformDeclares(){const t=[[0,0,0,0],[0,0,0,0]],e=new Array(16);return[{name:"invProjMatrix",type:"function",fn:(t,n)=>ee(e,n.projMatrix)},{name:"outputFovInfo",type:"array",length:2,fn:function(e,n){const i=Math.tan(.5*n.fov),r=n.outSize[0]/n.outSize[1]*i;return Gn(t[0],r,i,r,-i),Gn(t[1],-r,i,-r,-i),t}},{name:"reprojViewProjMatrix",type:"function",fn:(t,e)=>re([],e.prevProjViewMatrix,e.cameraWorldMatrix)}]}static getDefines(){return{HAS_SSR:1}}constructor(t){this._regl=t,this._renderer=new Ta(t),this._inputRGBM=0}setup(t){this._initShaders(),this._createTextures(t)}getSSRUniforms(t,e,n){if(!this._depthCopy)return null;const i=this._depthCopy;return{TextureDepth:i,TextureReflected:this.getMipmapTexture(),ssrFactor:e||1,ssrQuality:n||2,outSize:[i.width,i.height],fov:t.getFov()*Math.PI/180,prevProjViewMatrix:this._projViewMatrix||t.projViewMatrix,cameraWorldMatrix:t.cameraWorldMatrix}}genMipMap(t,e,n){return this.setup(t),this._mipmap(t),this.copyDepthTex(e),this._projViewMatrix||(this._projViewMatrix=[]),Kt(this._projViewMatrix,n),delete this._depthCopied,this._outputTex}getPrevProjViewMatrix(){return this._projViewMatrix}copyDepthTex(t){return this._depthCopied?null:(this.setup(t),this._depthCopy?t.width===this._depthCopy.width&&t.height===this._depthCopy.height||this._depthCopyFBO.resize(t.width,t.height):(this._depthCopy=this._regl.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"uint8",width:t.width,height:t.height}),this._depthCopyFBO=this._regl.framebuffer({width:t.width,height:t.height,colors:[this._depthCopy],colorFormat:"rgba"})),this._renderer.render(this._copyDepthShader,{TextureDepth:t},null,this._depthCopyFBO),this._depthCopied=!0,this._depthCopy)}_mipmap(t){const e=this._targetFBO,n=Math.ceil(.5*t.width),i=Math.ceil(.5*t.height);e.width===n&&e.height===i||e.resize(n,i);let r=this._blurUniforms;r||(r=this._blurUniforms={rgbmRange:7,outputSize:[0,0]}),r.TextureInput=t,r.inputRGBM=+this._inputRGBM,no(r.outputSize,e.width,e.height),this._renderer.render(this._ssrQuadShader,r,null,e)}getMipmapTexture(){return this._outputTex||(this._outputTex=this._renderer.regl.texture({type:"uint8",width:2,height:2})),this._outputTex}dispose(){this._copyDepthShader&&(this._ssrQuadShader.dispose(),this._copyDepthShader.dispose(),this._targetFBO.destroy(),delete this._copyDepthShader),this._depthCopy&&(this._depthCopyFBO.destroy(),delete this._depthCopy,delete this._depthCopyFBO)}_initShaders(){this._copyDepthShader||(this._copyDepthShader=new ml,this._ssrQuadShader=new Kh({vert:Zh,frag:"#version 100\nprecision mediump float;\nuniform sampler2D TextureInput;\nuniform vec2 outputSize;\n#define SHADER_NAME QUAD\nvec2 c;\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 d = texture2D(TextureInput, c.xy);\n  gl_FragColor = d;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}))}_createTextures(t){if(!this._targetFBO){const e=this._regl;this._outputTex&&this._outputTex.destroy(),this._outputTex=e.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height}),this._targetFBO=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1})}}}class pl extends jh{constructor(t){const e=[];super({vert:"#define SHADER_NAME HEATMAP\nfloat c(const vec2 d, const float t) {\n  return mix(d[0], d[1], t);\n}\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\nuniform float heatmapIntensity;\nattribute vec3 aPosition;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nuniform lowp float heatmapWeightT;\nattribute highp vec2 aWeight;\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\nuniform mediump float heatmapRadius;\nconst highp float e = 1. / 255. / 16.;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n  \n#ifdef HAS_HEAT_WEIGHT\nweight = c(aWeight, heatmapWeightT);\n#else\nhighp float f = heatmapWeight;\n#endif\nmediump float h = heatmapRadius;\n  vec2 i = vec2(mod(aPosition.xy, 2.) * 2. - 1.);\n  float j = sqrt(-2. * log(e / f / heatmapIntensity / GAUSS_COEF)) / 3.;\n  vExtrude = j * i;\n  vec2 k = vExtrude * h * extrudeScale;\n  vec4 l = vec4(floor(aPosition.xy * .5) + k, aPosition.z, 1);\n  gl_Position = projViewModelMatrix * l;\n}",frag:"#define SHADER_NAME HEATMAP\nprecision mediump float;\nuniform highp float heatmapIntensity;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n  \n#ifndef HAS_HEAT_WEIGHT\nhighp float c = heatmapWeight;\n#endif\nfloat d = -.5 * 3. * 3. * dot(vExtrude, vExtrude);\n  float e = c * heatmapIntensity * GAUSS_COEF * exp(d);\n  gl_FragColor = vec4(e, 1., 1., 1.);\n}",uniforms:[{name:"extrudeScale",type:"function",fn:function(t,e){return e.resolution/e.dataResolution*e.tileRatio}},{name:"projViewModelMatrix",type:"function",fn:function(t,n){return re(e,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:Qs({},t&&t.extraCommandProps||{},{blend:{enable:!0,func:{src:"one",dst:"one"},equation:"add"}})})}}var _l=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],vl="#if __VERSION__ == 100\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\nprecision highp float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nvarying vec3 vWorldPos;\n#ifdef USE_AMBIENT\nuniform vec3 diffuseSPH[9];\n#else\nuniform samplerCube cubeMap;\nuniform float bias;\nuniform float size;\n#endif\nuniform float environmentExposure;\n#if defined(INPUT_RGBM) || defined(ENC_RGBM)\nuniform float rgbmRange;\n#endif\nvec4 c(const in vec3 d, const in float e) {\n  if(e <= .0)\n    return vec4(d, 1.);\n  vec4 f;\n  vec3 h = d / e;\n  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);\n  f.a = ceil(f.a * 255.) / 255.;\n  f.rgb = h / f.a;\n  return f;\n}\nvec3 i(const in vec4 d, const in float e) {\n  if(e <= .0)\n    return d.rgb;\n  return e * d.rgb * d.a;\n}\nvec4 j(const in samplerCube k, const in vec3 l, const in float m, const in float n) {\n  vec3 o = l;\n  return textureCubeLod(k, o, n);\n}\nvec3 u(const in vec3 v, const in vec3 A[9]) {\n  float x = v.x;\n  float y = v.y;\n  float z = v.z;\n  vec3 B = (A[0] + A[1] * x + A[2] * y + A[3] * z + A[4] * z * x + A[5] * y * z + A[6] * y * x + A[7] * (3. * z * z - 1.) + A[8] * (x * x - y * y));\n  return max(B, vec3(.0));\n}\nfloat C(const in vec2 D) {\n  vec3 E = fract(vec3(D.xyx) * .1031);\n  E += dot(E, E.yzx + 19.19);\n  return fract((E.x + E.y) * E.z);\n}\nvoid main() {\n  vec4 F;\n#ifdef USE_AMBIENT\nvec3 v = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., C(gl_FragCoord.xy)) * 2.);\n  F = vec4(u(v, diffuseSPH), 1.);\n  if(length(hsv) > .0) {\n    F.rgb = hsv_apply(F.rgb, hsv);\n  }\n#ifdef ENC_RGBM\nF = c(F.rgb, rgbmRange);\n#endif\n#else\nF = j(cubeMap, normalize(vWorldPos), size, bias);\n#endif\nF.rgb *= environmentExposure;\n#ifdef ENC_RGBM\n#if !defined(USE_AMBIENT) && defined(INPUT_RGBM)\nif(length(hsv) > .0) {\n    F.rgb = hsv_apply(i(F, rgbmRange).rgb, hsv);\n    F = c(F.rgb, rgbmRange);\n  }\n#endif\nglFragColor = vec4(clamp(F.rgb, .0, 1.), 1.);\n#elif !defined(USE_AMBIENT) && defined(INPUT_RGBM)\nglFragColor = vec4(i(F, rgbmRange), 1.);\n  if(length(hsv) > .0) {\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\n  }\n#else\nif(length(hsv) > .0) {\n    F.rgb = hsv_apply(F.rgb, hsv);\n  }\n  glFragColor = F;\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}";class yl extends jh{constructor(){super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 transformMatrix;\nvarying vec3 vWorldPos;\nvoid main() {\n  vWorldPos = aPosition;\n  mat4 c = mat4(mat3(viewMatrix) * transformMatrix);\n  vec4 d = projMatrix * c * vec4(vWorldPos, 1.);\n  gl_Position = d.xyww;\n}",frag:vl,extraCommandProps:{depth:{enable:!0,range:[1,1],func:"lequal"},viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this.version=300}setMode(t,e,n){const i={};return t&&(i.INPUT_RGBM=1),e&&(i.ENC_RGBM=1),0===n&&(i.USE_AMBIENT=1),this._skyboxMesh?this._skyboxMesh[0].setDefines(i):this._meshDefines=i,this}draw(t){return this._skyboxMesh||this._createSkyboxMesh(t),super.draw(t,this._skyboxMesh)}_createSkyboxMesh(t){const e=new La({aPosition:new Int8Array(_l)},null,_l.length/3);e.generateBuffers(t),this._skyboxMesh=[new Ya(e)],this._meshDefines&&(this._skyboxMesh[0].setDefines(this._meshDefines),delete this._meshDefines)}dispose(){if(this._skyboxMesh){const t=this._skyboxMesh[0];t.geometry.dispose(),t.dispose()}return delete this._skyboxMesh,super.dispose()}}class xl extends jh{constructor(t,e){const n={blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:t};e&&e.extraCommandProps&&Qs(n,e.extraCommandProps);const i=[];super({vert:"#define SHADER_NAME HEATMAP_DISPLAY\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nvoid main() {\n  gl_Position = projViewModelMatrix * vec4(aPosition, 1.);\n}",frag:"#define SHADER_NAME HEATMAP_DISPLAY\nprecision mediump float;\nuniform sampler2D inputTexture;\nuniform sampler2D colorRamp;\nuniform vec2 textureOutputSize;\nuniform float heatmapOpacity;\nvoid main() {\n  vec2 c = gl_FragCoord.xy / textureOutputSize.xy;\n  float t = texture2D(inputTexture, c).r;\n  vec4 d = texture2D(colorRamp, vec2(t, .5));\n  gl_FragColor = d * heatmapOpacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return re(i,e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:n})}}class bl extends jh{constructor(t={}){super({vert:"precision highp float;\nprecision highp sampler2D;\nconst float c = 3.141592653589793;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nvec4 d(mat4 e, mat4 f, vec3 h) {\n  return e * modelMatrix * f * vec4(h, 1.);\n}\nvec3 i(in vec3 h, in vec3 j) {\n  return normalize(h + j);\n}\nmat3 k(in vec3 l) {\n  vec3 t = normalize(cross(vec3(.0, .0, 1.), l));\n  vec3 b = normalize(cross(l, t));\n  return mat3(t, b, l);\n}\nvoid m() {\n  \n}\nvoid main(void) {\n  vuv = aTexCoord;\n  vpos = (modelMatrix * vec4(aPosition, 1.)).xyz;\n  vnormal = aNormal;\n  vtbnMatrix = k(vnormal);\n  gl_Position = d(projMatrix, viewMatrix, vpos);\n  m();\n}",frag:"precision highp float;\nprecision highp sampler2D;\nuniform sampler2D texWaveNormal;\nuniform sampler2D texWavePerturbation;\nuniform vec3 octaveTextureRepeat;\nuniform vec4 waveParams;\nuniform vec2 waveDirection;\nuniform vec4 waterColor;\nuniform vec3 lightingDirection;\nuniform vec3 lightingIntensity;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nconst vec2 c = vec2(6. / 25., 5. / 24.);\nvec2 d(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rg - 1.;\n}\nfloat h(vec2 f) {\n  return texture2D(texWavePerturbation, f).b;\n}\nvec3 i(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rgb - 1.;\n}\nfloat j(vec2 f, float k) {\n  return fract(k);\n}\nfloat l(vec2 f, float k) {\n  float m = j(f, k);\n  return 1. - abs(1. - 2. * m);\n}\nvec3 n(sampler2D o, vec2 f, float k, float u) {\n  float v = waveParams[2];\n  float A = waveParams[3];\n  vec2 B = d(o, f) * v;\n  float m = j(f, k + u);\n  float C = l(f, k + u);\n  vec2 D = f;\n  D -= B * (m + A);\n  D += u;\n  D += (k - m) * c;\n  return vec3(D, C);\n}\nconst float E = .3737;\nconst float F = 7.77;\nvec3 G(sampler2D H, sampler2D I, vec2 f, vec2 J, float k) {\n  float K = waveParams[0];\n  vec2 L = k * -J;\n  float M = h(f * E) * F;\n  vec3 N = n(I, f + L, k + M, .0);\n  vec3 O = n(I, f + L, k + M, .5);\n  vec3 P = i(H, N.xy) * N.z;\n  vec3 Q = i(H, O.xy) * O.z;\n  vec3 R = normalize(P + Q);\n  R.xy *= K;\n  R.z = sqrt(1. - dot(R.xy, R.xy));\n  return R;\n}\nvec3 S(vec2 f, float k) {\n  float T = waveParams[1];\n  return G(texWaveNormal, texWavePerturbation, f * T, waveDirection, k);\n}\nconst float U = 3.141592653589793;\nconst float V = 1. / U;\nconst float W = .3183098861837907;\nconst float X = 1.570796326794897;\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nfloat Y = 2.2;\nvec3 Z(float ba, vec3 bb, float bc) {\n  return bb + (bc - bb) * pow(1. - ba, 5.);\n}\nfloat bd(float be, float bf) {\n  float bg = bf * bf;\n  float bh = be * be;\n  float bi = pow((bh * (bg - 1.) + 1.), Y) * U;\n  return bg / bi;\n}\nfloat bj(float bk) {\n  return .25 / (bk * bk);\n}\nvec3 bl(in PBRShadingWater bm, float bf, vec3 bn, float bo) {\n  vec3 bp = Z(bm.VdotH, bn, bo);\n  float bq = bd(bm.NdotH, bf);\n  float br = bj(bm.LdotH);\n  return (bq * br) * bp;\n}\nvec3 bs(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float bt = 2.2;\nconst float bu = .4545454545;\nvec4 bv(vec4 bw) {\n  return vec4(pow(bw.rgb, vec3(bu)), bw.w);\n}\nvec3 bx(vec3 bw) {\n  return pow(bw, vec3(bt));\n}\nconst vec3 by = vec3(.02, 1., 5.);\nconst vec2 bz = vec2(.02, .1);\nconst float bf = .06;\nconst vec3 bA = vec3(0, .6, .9);\nconst vec3 bB = vec3(.72, .92, 1.);\nPBRShadingWater bC;\nvec3 bD(in float bE, in vec3 bF, in vec3 bG) {\n  float bH = pow((1. - bE), by[2]);\n  return mix(bG, bF, bH);\n}\nvec3 bI(in vec3 bJ, in vec3 bK, in vec3 bL, vec3 bw, in vec3 bM, in vec3 bN, in float bO) {\n  vec3 bP = bx(bw);\n  vec3 bQ = normalize(bL + bK);\n  bC.NdotL = clamp(dot(bJ, bL), .0, 1.);\n  bC.NdotV = clamp(dot(bJ, bK), .001, 1.);\n  bC.VdotN = clamp(dot(bK, bJ), .001, 1.);\n  bC.NdotH = clamp(dot(bJ, bQ), .0, 1.);\n  bC.VdotH = clamp(dot(bK, bQ), .0, 1.);\n  bC.LdotH = clamp(dot(bL, bQ), .0, 1.);\n  float bR = max(dot(bN, bK), .0);\n  vec3 bS = bx(bB);\n  vec3 bT = bx(bA);\n  vec3 bB = bD(bR, bS, bT);\n  float bU = max(dot(bN, bL), .0);\n  bB *= .1 + bU * .9;\n  float bV = clamp(bO, .8, 1.);\n  vec3 bW = Z(bC.VdotN, vec3(by[0]), by[1]) * bB * bV;\n  vec3 bX = bP * mix(bB, bU * bM * V, 2. / 3.) * bV;\n  vec3 bY = vec3(.0);\n  if(bR > .0 && bU > .0) {\n    vec3 bZ = bl(bC, bf, vec3(bz[0]), bz[1]);\n    vec3 ca = bM * V * bO;\n    bY = bC.NdotL * ca * bZ;\n  }\n  return bs(bW + bX + bY);\n}\nvoid main() {\n  vec3 bN = vnormal;\n  vec3 cb = S(vuv, timeElapsed);\n  vec3 bJ = normalize(vtbnMatrix * cb);\n  vec3 bK = -normalize(vpos - camPos);\n  vec3 bL = normalize(-lightingDirection);\n  float bO = 1.;\n  vec4 cc = vec4(bI(bJ, bK, bL, waterColor.rgb, lightingIntensity, bN, bO), waterColor.w);\n  gl_FragColor = bv(cc);\n}",defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}class wl extends Kh{constructor(){super({vert:Zh,frag:"precision highp float;\nuniform sampler2D texture;\nuniform vec2 size;\nuniform float enableSharpen;\nuniform float sharpFactor;\nuniform float pixelRatio;\nvec2 c;\nvec3 d(const in vec3 e, const float f) {\n  vec2 h = pixelRatio / size.xy;\n  float i = .0;\n  vec4 j = texture2D(texture, c + h * vec2(-1., -1.));\n  j.rgb = mix(vec3(.0), j.rgb, sign(j.a));\n  i += mix(.0, 1., sign(j.a));\n  vec4 k = texture2D(texture, c + h * vec2(1.));\n  k.rgb = mix(vec3(.0), k.rgb, sign(k.a));\n  i += mix(.0, 1., sign(k.a));\n  vec4 l = texture2D(texture, c + h * vec2(1., -1.));\n  l.rgb = mix(vec3(.0), l.rgb, sign(l.a));\n  i += mix(.0, 1., sign(l.a));\n  vec4 m = texture2D(texture, c + h * vec2(-1., 1.));\n  m.rgb = mix(vec3(.0), m.rgb, sign(m.a));\n  i += mix(.0, 1., sign(m.a));\n  return e + f * (i * e - j.rgb - l.rgb - m.rgb - k.rgb);\n}\nvoid main() {\n  c = gl_FragCoord.xy / size;\n  vec4 e = texture2D(texture, c);\n  if(enableSharpen == 1.) {\n    e.rgb = d(e.rgb, sharpFactor);\n  }\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.size[0],height:(t,e)=>e.size[1]}}})}getMeshCommand(t,e){return this.commands.copy||(this.commands.copy=this.createREGLCommand(t,null,e.getElements())),this.commands.copy}}const Tl=[];class Ml{constructor(t,e){this._regl=t,this._viewport=e,this._init()}_init(){this._shader=new jh({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec4 vWorldPosition;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  vec4 e = modelMatrix * d * c;\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vWorldPosition = e;\n}",frag:"precision mediump float;\nvarying vec4 vWorldPosition;\nuniform vec2 fogDist;\nuniform vec3 cameraPosition;\nvoid main() {\n  vec3 c = vec3(vWorldPosition[0] - cameraPosition[0], vWorldPosition[1] - cameraPosition[1], vWorldPosition[2] - cameraPosition[2]);\n  float d = length(c);\n  float e = clamp(1. - (d - fogDist.x) / (fogDist.y - fogDist.x), .0, 1.);\n  if(vWorldPosition[2] < .01) {\n    gl_FragColor = vec4(e, .0, .0, 1.);\n  } else {\n    gl_FragColor = vec4(e, 1., .0, 1.);\n  }\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return re(Tl,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new nh,this.renderer=new Ta(this._regl)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition,fogDist:e.fogDist},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Ks(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Ks(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}}class Al extends Kh{constructor(){super({vert:Zh,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_RAIN\nuniform sampler2D ripplesMap;\n#endif\n#ifdef HAS_SNOW\nuniform sampler2D normalMap;\n#endif\n#ifdef HAS_FOG\nuniform vec3 fogColor;\n#endif\nuniform sampler2D sceneMap;\nuniform sampler2D mixFactorMap;\nuniform float time;\nuniform vec2 resolution;\nfloat c(float a, float b, float w) {\n  return a + w * (b - a);\n}\n#define HASHSCALE1 .1031\n#define HASHSCALE3 vec3(.1031, .1030, .0973)\n#define HASHSCALE4 vec3(.1031, .1030, .0973, .1099)\nfloat d = .1;\nfloat e = .2;\nfloat f = .5;\nfloat h = 10.;\nfloat i(float p) {\n  vec3 j = fract(vec3(p) * HASHSCALE1);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.x + j.y) * j.z);\n}\nvec2 k(vec2 p) {\n  vec3 j = fract(vec3(p.xyx) * HASHSCALE3);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.xx + j.yz) * j.zy);\n}\nvec2 l(vec2 m) {\n  float x = fract(sin(dot(m.xy, vec2(122.9898, 783.233))) * 43758.5453);\n  float y = fract(sin(dot(m.xy, vec2(457.6537, 537.2793))) * 37573.5913);\n  return vec2(x, y);\n}\nvec3 n(vec2 o, float u) {\n  vec3 v = vec3(.0);\n  o = o * (2. + u);\n  float A = o.y * (((i(u) * 2. - 1.) * .5 + 1.) * e);\n  float B = (f * time);\n  o += vec2(A, B);\n  vec2 C = k(floor(o) + 31.1759 * u);\n  o = fract(o);\n  o -= (C * 2. - 1.) * .35;\n  o -= .5;\n  float r = length(o);\n  float D = .05 * (1. + .3 * sin(time * d));\n  float E = smoothstep(D, -D, r);\n  vec3 F = vec3(E) * C.x;\n  return F;\n}\nvec3 G() {\n  vec3 v = vec3(0);\n  vec2 o = gl_FragCoord.xy / resolution.xy;\n  o *= vec2(resolution.x / resolution.y, 1.);\n  for(float H = 0.; H < h; H++) {\n    v += n(o, H);\n  }\n  return v;\n}\nvec3 I(vec4 J, vec4 K, float L) {\n  float M = K.b;\n  vec3 N = vec3(1.);\n  if(L < 1.) {\n    float r = c(.5, N.x, M);\n    float g = c(.5, N.y, M);\n    float b = c(.5, N.z, M);\n    return vec3(r, g, b);\n  } else {\n    float r = c(J.r, N.x, M);\n    float g = c(J.g, N.y, M);\n    float b = c(J.b, N.z, M);\n    return vec3(r, g, b);\n  }\n}\nvoid main() {\n  vec4 J = texture2D(sceneMap, vTexCoord);\n  glFragColor = J;\n  vec4 O = texture2D(mixFactorMap, vTexCoord);\n#ifdef HAS_RAIN\nvec4 P = texture2D(ripplesMap, vTexCoord);\n  if(O.g < 1.) {\n    J = mix(J, P, .4);\n  }\n  glFragColor = J;\n#endif\n#ifdef HAS_SNOW\nvec3 Q = G();\n  glFragColor = vec4(J.rgb + Q, J.a);\n#endif\n#ifdef HAS_FOG\nfloat R = O.r;\n  vec3 S = mix(fogColor, glFragColor.rgb, R);\n  glFragColor = vec4(S, J.a);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}}const El=[],Cl=[.03,.03,.03],Sl=[],Pl=[],Rl=[],Ol=_e([],Bi([],90,0,0),[0,0,0]);class Il{constructor(t,e){this._regl=t,this._viewport=e,this._init()}_init(){this._shader=new jh({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec2 vTexCoord;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform float rippleRadius;\nuniform float density;\nuniform float time;\nvec3 c(vec2 p) {\n  vec3 q = vec3(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)), dot(p, vec2(419.2, 371.9)));\n  return fract(sin(q) * 43758.5453);\n}\nfloat d(in vec2 x) {\n  vec2 e = x * density / 4000.0;\n  vec2 p = floor(e);\n  vec2 f = fract(e);\n  float h = .0;\n  for(int i = -4; i <= 4; i++)\n    for(int k = -4; k <= 4; k++) {\n      vec2 g = vec2(float(k), float(i));\n      vec3 l = c(p + g);\n      vec2 r = g - f + l.xy;\n      float m = sqrt(dot(r, r));\n      float n = max(mix(smoothstep(.99, .999, max(cos(m - time * 2. + (l.x + l.y) * 5.), 0.)), 0., m), 0.);\n      h += n;\n    }\n  return h;\n}\nvoid main() {\n  vec2 u = vTexCoord;\n  float A = 24. / (rippleRadius * .01);\n  float f = d(A * u) * smoothstep(.0, .4, sin(u.x * 3.151592) * sin(u.y * 3.141592));\n  vec3 B = vec3(-dFdx(f), -dFdy(f), -dFdy(f));\n  glFragColor = vec4(B, 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return re(El,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._shader.version=300,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new nh,this.renderer=new Ta(this._regl)}_transformRipples(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes());let n=t.getGLScale()/t.getGLScale(this._fixZoom);const i=Ze(Pl,n,n,n),r=Ke(i,Cl,i),o=$t(Rl);we(o,Bi(Sl,0,0,0),[e.x,e.y,0],r),re(o,o,Ol),this._mesh.setLocalTransform(o)}_createRipplesMask(t){this._fixZoom=t.getZoom();const e=800*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new La(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const r=new Na;return new Ya(i,r)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._mesh=this._mesh||this._createRipplesMask(t),this._scene.setMeshes(this._mesh),this._transformRipples(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,time:e.time,rippleRadius:e.rippleRadius,density:e.density},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Ks(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Ks(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}}var Dl,kl="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},Ll={exports:{}};Dl=Ll,function(t){var e,n,i="fulfilled",r="undefined",o=function(){var e=[],i=0;function o(){for(;e.length-i;){try{e[i]()}catch(e){t.console&&t.console.error(e)}e[i++]=n,1024==i&&(e.splice(0,1024),i=0)}}var s=function(){if(typeof MutationObserver===r)return typeof process!==r&&"function"==typeof process.nextTick?function(){process.nextTick(o)}:typeof setImmediate!==r?function(){setImmediate(o)}:function(){setTimeout(o,0)};var t=document.createElement("div");return new MutationObserver(o).observe(t,{attributes:!0}),function(){t.setAttribute("a",0)}}();return function(t){e.push(t),e.length-i==1&&s()}}();function s(t){if(!(this instanceof s))throw new TypeError("Zousan must be created with the new keyword");if("function"==typeof t){var e=this;try{t((function(t){e.resolve(t)}),(function(t){e.reject(t)}))}catch(t){e.reject(t)}}else if(0<arguments.length)throw new TypeError("Zousan resolver "+t+" is not a function")}function a(t,e){if("function"==typeof t.y)try{var i=t.y.call(n,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.resolve(e)}function h(t,e){if("function"==typeof t.n)try{var i=t.n.call(n,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.reject(e)}s.prototype={resolve:function(t){if(this.state===e){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var n=this;if(t&&("function"==typeof t||"object"==typeof t))try{var r=!0,s=t.then;if("function"==typeof s)return void s.call(t,(function(t){r&&(r=!1,n.resolve(t))}),(function(t){r&&(r=!1,n.reject(t))}))}catch(s){return void(r&&this.reject(s))}this.state=i,this.v=t,n.c&&o((function(){for(var e=0,i=n.c.length;e<i;e++)a(n.c[e],t)}))}},reject:function(n){if(this.state===e){var i=this;this.state="rejected",this.v=n;var r=this.c;o(r?function(){for(var t=0,e=r.length;t<e;t++)h(r[t],n)}:function(){i.handled||!s.suppressUncaughtRejectionError&&t.console&&s.warn("You upset Zousan. Please catch rejections: ",n,n?n.stack:null)})}},then:function(t,n){var r=new s,l={y:t,n:n,p:r};if(this.state===e)this.c?this.c.push(l):this.c=[l];else{var c=this.state,u=this.v;this.handled=!0,o((function(){c===i?a(l,u):h(l,u)}))}return r},catch:function(t){return this.then(null,t)},finally:function(t){return this.then(t,t)},timeout:function(t,e){e=e||"Timeout";var n=this;return new s((function(i,r){setTimeout((function(){r(Error(e))}),t),n.then((function(t){i(t)}),(function(t){r(t)}))}))}},s.resolve=function(t){var e=new s;return e.resolve(t),e},s.reject=function(t){var e=new s;return e.c=[],e.reject(t),e},s.all=function(t){var e=[],n=0,i=new s;function r(r,o){r&&"function"==typeof r.then||(r=s.resolve(r)),r.then((function(r){e[o]=r,++n==t.length&&i.resolve(e)}),(function(t){i.reject(t)}))}for(var o=0;o<t.length;o++)r(t[o],o);return t.length||i.resolve(e),i},s.warn=console.warn,Dl.exports&&(Dl.exports=s),t.define&&t.define.amd&&t.define([],(function(){return s})),(t.Zousan=s).soon=o}(kl);var Fl=Ll.exports,Nl={exports:{}},Bl={exports:{}};Bl.exports=function(){function t(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function e(t,e){return t<e?-1:t>e?1:0}return function(n,i,r,o,s){!function e(n,i,r,o,s){for(;o>r;){if(o-r>600){var a=o-r+1,h=i-r+1,l=Math.log(a),c=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*c*(a-c)/a)*(h-a/2<0?-1:1);e(n,i,Math.max(r,Math.floor(i-h*c/a+u)),Math.min(o,Math.floor(i+(a-h)*c/a+u)),s)}var f=n[i],d=r,m=o;for(t(n,r,i),s(n[o],f)>0&&t(n,r,o);d<m;){for(t(n,d,m),d++,m--;s(n[d],f)<0;)d++;for(;s(n[m],f)>0;)m--}0===s(n[r],f)?t(n,r,m):t(n,++m,o),m<=i&&(r=m+1),i<=m&&(o=m-1)}}(n,i,r||0,o||n.length-1,s||e)}}(),Nl.exports=jl,Nl.exports.default=jl;var Hl=Bl.exports;function jl(t,e){if(!(this instanceof jl))return new jl(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function zl(t,e,n){if(!n)return e.indexOf(t);for(var i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function Gl(t,e){Ul(t,0,t.children.length,e,t)}function Ul(t,e,n,i,r){r||(r=Jl(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o,s=e;s<n;s++)o=t.children[s],Vl(r,t.leaf?i(o):o);return r}function Vl(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function Wl(t,e){return t.minX-e.minX}function Xl(t,e){return t.minY-e.minY}function Zl(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function ql(t){return t.maxX-t.minX+(t.maxY-t.minY)}function Yl(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function Kl(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function Jl(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Ql(t,e,n,i,r){for(var o,s=[e,n];s.length;)(n=s.pop())-(e=s.pop())<=i||(o=e+Math.ceil((n-e)/i/2)*i,Hl(t,o,e,n,r),s.push(e,o,o,n))}jl.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],i=this.toBBox;if(!Kl(t,e))return n;for(var r,o,s,a,h=[];e;){for(r=0,o=e.children.length;r<o;r++)s=e.children[r],Kl(t,a=e.leaf?i(s):s)&&(e.leaf?n.push(s):Yl(t,a)?this._all(s,n):h.push(s));e=h.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!Kl(t,e))return!1;for(var i,r,o,s,a=[];e;){for(i=0,r=e.children.length;i<r;i++)if(o=e.children[i],Kl(t,s=e.leaf?n(o):o)){if(e.leaf||Yl(t,s))return!0;a.push(o)}e=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var r=this.data;this.data=i,i=r}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=Jl([]),this},remove:function(t,e){if(!t)return this;for(var n,i,r,o,s=this.data,a=this.toBBox(t),h=[],l=[];s||h.length;){if(s||(s=h.pop(),i=h[h.length-1],n=l.pop(),o=!0),s.leaf&&-1!==(r=zl(t,s.children,e)))return s.children.splice(r,1),h.push(s),this._condense(h),this;o||s.leaf||!Yl(s,a)?i?(n++,s=i.children[n],o=!1):s=null:(h.push(s),l.push(n),n=0,i=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:Wl,compareMinY:Xl,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,i){var r,o=n-e+1,s=this._maxEntries;if(o<=s)return Gl(r=Jl(t.slice(e,n+1)),this.toBBox),r;i||(i=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,i-1))),(r=Jl([])).leaf=!1,r.height=i;var a,h,l,c,u=Math.ceil(o/s),f=u*Math.ceil(Math.sqrt(s));for(Ql(t,e,n,f,this.compareMinX),a=e;a<=n;a+=f)for(Ql(t,a,l=Math.min(a+f-1,n),u,this.compareMinY),h=a;h<=l;h+=u)c=Math.min(h+u-1,l),r.children.push(this._build(t,h,c,i-1));return Gl(r,this.toBBox),r},_chooseSubtree:function(t,e,n,i){for(var r,o,s,a,h,l,c,u,f,d;i.push(e),!e.leaf&&i.length-1!==n;){for(c=u=1/0,r=0,o=e.children.length;r<o;r++)h=Zl(s=e.children[r]),f=t,d=s,(l=(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-h)<u?(u=l,c=h<c?h:c,a=s):l===u&&h<c&&(c=h,a=s);e=a||e.children[0]}return e},_insert:function(t,e,n){var i=n?t:(0,this.toBBox)(t),r=[],o=this._chooseSubtree(i,this.data,e,r);for(o.children.push(t),Vl(o,i);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(i,r,e)},_split:function(t,e){var n=t[e],i=n.children.length,r=this._minEntries;this._chooseSplitAxis(n,r,i);var o=this._chooseSplitIndex(n,r,i),s=Jl(n.children.splice(o,n.children.length-o));s.height=n.height,s.leaf=n.leaf,Gl(n,this.toBBox),Gl(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)},_splitRoot:function(t,e){this.data=Jl([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Gl(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){var i,r,o,s,a,h,l,c,u,f,d,m,g,p;for(h=l=1/0,i=e;i<=n-e;i++)u=r=Ul(t,0,i,this.toBBox),f=o=Ul(t,i,n,this.toBBox),d=void 0,m=void 0,g=void 0,p=void 0,d=Math.max(u.minX,f.minX),m=Math.max(u.minY,f.minY),g=Math.min(u.maxX,f.maxX),p=Math.min(u.maxY,f.maxY),s=Math.max(0,g-d)*Math.max(0,p-m),a=Zl(r)+Zl(o),s<h?(h=s,c=i,l=a<l?a:l):s===h&&a<l&&(l=a,c=i);return c},_chooseSplitAxis:function(t,e,n){var i=t.leaf?this.compareMinX:Wl,r=t.leaf?this.compareMinY:Xl;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,r)&&t.children.sort(i)},_allDistMargin:function(t,e,n,i){t.children.sort(i);var r,o,s=this.toBBox,a=Ul(t,0,e,s),h=Ul(t,n-e,n,s),l=ql(a)+ql(h);for(r=e;r<n-e;r++)o=t.children[r],Vl(a,t.leaf?s(o):o),l+=ql(a);for(r=n-e-1;r>=e;r--)o=t.children[r],Vl(h,t.leaf?s(o):o),l+=ql(h);return l},_adjustParentBBoxes:function(t,e,n){for(var i=n;i>=0;i--)Vl(e[i],t)},_condense:function(t){for(var e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children).splice(e.indexOf(t[n]),1):this.clear():Gl(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};var $l=Nl.exports,tc={exports:{}};!function(t){!function(){function e(t,e,n){var i=e.x,r=e.y,o=n.x-i,s=n.y-r;if(0!==o||0!==s){var a=((t.x-i)*o+(t.y-r)*s)/(o*o+s*s);a>1?(i=n.x,r=n.y):a>0&&(i+=o*a,r+=s*a)}return(o=t.x-i)*o+(s=t.y-r)*s}function n(t,n){var i=t.length-1,r=[t[0]];return function t(n,i,r,o,s){for(var a,h=o,l=i+1;l<r;l++){var c=e(n[l],n[i],n[r]);c>h&&(a=l,h=c)}h>o&&(a-i>1&&t(n,i,a,o,s),s.push(n[a]),r-a>1&&t(n,a,r,o,s))}(t,0,i,n,r),r.push(t[i]),r}function i(t,e,i){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return n(t=i?t:function(t,e){for(var n,i,r,o,s,a=t[0],h=[a],l=1,c=t.length;l<c;l++)o=void 0,s=void 0,(o=(i=n=t[l]).x-(r=a).x)*o+(s=i.y-r.y)*s>e&&(h.push(n),a=n);return a!==n&&h.push(n),h}(t,r),r)}t.exports=i,t.exports.default=i}()}(tc);for(var ec=tc.exports,nc=[],ic=0;ic<6;ic++)nc[ic]=[];var rc=[];function oc(t,e,n){var i,r,o,s,a,h,l,c,u,f,d,m,g,p,_,v,y;o=(i=t)[1],s=i[2],l=i[5],c=i[6],d=i[9],m=i[10],_=i[13],v=i[14],sc(nc[0],(a=i[3])-(r=i[0]),(u=i[7])-(h=i[4]),(g=i[11])-(f=i[8]),(y=i[15])-(p=i[12])),sc(nc[1],a+r,u+h,g+f,y+p),sc(nc[2],a+o,u+l,g+d,y+_),sc(nc[3],a-o,u-l,g-d,y-_),sc(nc[4],a-s,u-c,g-m,y-v),sc(nc[5],a+s,u+c,g+m,y+v);for(var x=0;x<6;x++)if(!n||"0"!==n.charAt(x)){var b=nc[x];if(rc[0]=b[0]>0?e[1][0]:e[0][0],rc[1]=b[1]>0?e[1][1]:e[0][1],rc[2]=b[2]>0?e[1][2]:e[0][2],ac(b,rc)<0)return!1}return!0}function sc(t,e,n,i,r){return t[0]=e*(1/6),t[1]=n*(1/6),t[2]=i*(1/6),t[3]=r*(1/6),t}function ac(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}var hc=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],lc=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(hc),cc=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],uc=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],fc={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},dc=["lineColor","polygonFill","markerFill","markerLineColor","textFill"];function mc(){return Date.now()}function gc(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)t[i]=n[i]}return t}function pc(t){return null==t}function _c(t){return"number"==typeof t&&!isNaN(t)}function vc(t){return(0|t)===t}function yc(t){return"object"==typeof t&&!!t}function xc(t){return!pc(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function bc(t){return!pc(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var wc=Object.prototype.hasOwnProperty;function Tc(t,e){return wc.call(t,e)}var Mc=Math.PI/180;function Ac(t){return t*Mc}function Ec(t){return t/Mc}var Cc="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"],Sc={},Pc={};function Rc(){return window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}if(!Cc){var Oc=navigator.userAgent.toLowerCase(),Ic=document.documentElement,Dc="ActiveXObject"in window,kc=-1!==Oc.indexOf("webkit"),Lc=-1!==Oc.indexOf("phantom"),Fc=-1!==Oc.search("android [23]"),Nc=-1!==Oc.indexOf("chrome"),Bc=-1!==Oc.indexOf("gecko")&&!kc&&!window.opera&&!Dc,Hc="undefined"!=typeof orientation||-1!==Oc.indexOf("mobile"),jc=!window.PointerEvent&&window.MSPointerEvent,zc=window.PointerEvent&&navigator.pointerEnabled||jc,Gc=Dc&&"transition"in Ic.style,Uc="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!Fc,Vc="MozPerspective"in Ic.style,Wc="OTransition"in Ic.style,Xc=(Gc||Uc||Vc)&&!Wc&&!Lc,Zc="undefined"!=typeof window&&bc(window.createImageBitmap),qc="undefined"!=typeof window&&bc(window.ResizeObserver),Yc="undefined"!=typeof window&&bc(window.btoa),Kc=0;Nc&&(Kc=Oc.match(/chrome\/([\d.]+)/)[1]);var Jc=!Lc&&(zc||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),Qc="undefined"!=typeof window&&"WebGLRenderingContext"in window,$c=Rc(),tu=!1;try{new OffscreenCanvas(2,2).getContext("2d"),tu=!0}catch(aw){tu=!1}var eu=!1;try{window.addEventListener("testPassive",(function(){}),{get passive(){eu=!0}})}catch(aw){}if(Sc={ie:Dc,ielt9:Dc&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:kc,gecko:Bc,android:-1!==Oc.indexOf("android"),android23:Fc,chrome:Nc,chromeVersion:Kc,safari:!Nc&&-1!==Oc.indexOf("safari"),phantomjs:Lc,ie3d:Gc,webkit3d:Uc,gecko3d:Vc,opera12:Wc,any3d:Xc,mobile:Hc,mobileWebkit:Hc&&kc,mobileWebkit3d:Hc&&Uc,mobileOpera:Hc&&window.opera,mobileGecko:Hc&&Bc,touch:!!Jc,msPointer:!!jc,pointer:!!zc,retina:$c>1,devicePixelRatio:$c,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:Dc&&9===document.documentMode,ie10:Dc&&10===document.documentMode,webgl:Qc,imageBitMap:Zc,resizeObserver:qc,btoa:Yc,decodeImageInWorker:tu,monitorDPRChange:!0,supportsPassive:eu,removeDPRListening:function(t){t&&delete Pc[t.id]},checkDevicePixelRatio:function(){if("undefined"!=typeof window&&Sc.monitorDPRChange){var t=Rc(),e=t!==Sc.devicePixelRatio;return e&&(Sc.devicePixelRatio=t),e}return!1},addDPRListening:function(t){t&&(Pc[t.id]=t)}},"undefined"!=typeof window&&window.matchMedia)for(var nu=1;nu<500;nu++){var iu=(.01*nu).toFixed(2),ru=window.matchMedia("screen and (resolution: "+iu+"dppx)");ru&&(ru.addEventListener?ru.addEventListener("change",Sc.checkDevicePixelRatio):ru.addListener&&ru.addListener(Sc.checkDevicePixelRatio))}if(Sc.devicePixelRatio){var ou=Sc.devicePixelRatio;Object.defineProperty(Sc,"devicePixelRatio",{get:function(){return ou},set:function(t){if(t!==ou&&(ou=t,Sc.monitorDPRChange))for(var e in Pc){var n=Pc[e];n&&n.options&&!n.options.devicePixelRatio&&n.checkSize&&n.getRenderer&&n.getRenderer()&&n.checkSize(!0)}}})}}var su=Sc;function au(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function hu(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var lu,cu,uu=function(){function t(t,e,n){if(pc(t)||pc(e)?pc(t.x)||pc(t.y)?Array.isArray(t)&&(this.x=+t[0],this.y=+t[1],this.z=t[2]):(this.x=+t.x,this.y=+t.y,this.z=t.z):(this.x=+t,this.y=+e,this.z=n),this._isNaN())throw new Error("Position is NaN")}var e=t.prototype;return e.set=function(t,e,n){return this.x=t,this.y=e,this.z=n||0,this},e.abs=function(){return new this.constructor(Math.abs(this.x),Math.abs(this.y))},e._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},e._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},e.round=function(){return new this.constructor(Math.round(this.x),Math.round(this.y))},e._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},e.ceil=function(){return new this.constructor(Math.ceil(this.x),Math.ceil(this.y))},e.distanceTo=function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)},e.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},e.floor=function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))},e.copy=function(){return new this.constructor(this.x,this.y,this.z)},e._add=function(t,e){return pc(t.x)?pc(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},e.add=function(t,e){var n,i;return pc(t.x)?pc(t[0])?(n=this.x+t,i=this.y+e):(n=this.x+t[0],i=this.y+t[1]):(n=this.x+t.x,i=this.y+t.y),new this.constructor(n,i)},e._sub=function(t,e){return pc(t.x)?pc(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(t,e){var n,i;return pc(t.x)?pc(t[0])?(n=this.x-t,i=this.y-e):(n=this.x-t[0],i=this.y-t[1]):(n=this.x-t.x,i=this.y-t.y),new this.constructor(n,i)},e.substract=function(){return this.sub.apply(this,arguments)},e.multi=function(t){return new this.constructor(this.x*t,this.y*t)},e._multi=function(t){return this.x*=t,this.y*=t,this},e.div=function(t){return this.multi(1/t)},e._div=function(t){return this._multi(1/t)},e.equals=function(t){return t instanceof this.constructor&&this.x===t.x&&this.y===t.y&&this.z===t.z},e._isNaN=function(){return isNaN(this.x)||isNaN(this.y)},e.isZero=function(){return 0===this.x&&0===this.y},e.toArray=function(){return _c(this.z)?[this.x,this.y,this.z]:[this.x,this.y]},e.toFixed=function(t){return new this.constructor(this.x.toFixed(t),this.y.toFixed(t))},e.toJSON=function(){return{x:this.x,y:this.y}},t}(),fu=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},n.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.unit=function(){return this.copy()._unit()},n._unit=function(){return this._div(this.mag()),this},n.perp=function(){return this.copy()._perp()},n._perp=function(){var t=this.y;return this.y=this.x,this.x=-t,this},n.angleWith=function(t){return this.angleWithSep(t.x,t.y)},n.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},n._rotate=function(t){var e=Math.cos(t),n=Math.sin(t),i=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=i,this},n.rotate=function(t){return this.copy()._rotate(t)},e}(uu);function du(t){return t.length>4&&".svg"===t.slice(-4)?1:"data:image/svg+xml"===t.slice(0,18)?2:0}function mu(t,e){Cc&&mu.node?mu.node(t,e):t.src=e[0]}!function(){if(Cc)return lu=function(t){return setTimeout(t,16)},void(cu=clearTimeout);var t,e;function n(t){return setTimeout(t,1e3/30)}function i(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}"undefined"!=typeof window?(t=window.requestAnimationFrame||i("RequestAnimationFrame")||n,e=window.cancelAnimationFrame||i("CancelAnimationFrame")||i("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(t=n,e=clearTimeout),lu=function(e){return t(e)},cu=function(t){t&&e(t)}}();var gu=0;function pu(){return gu++}var _u=pu;function vu(t){return t&&xc(t)?JSON.parse(t):t}function yu(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(n)for(var i=0,r=n.length;i<r;i++)t.push(n[i])}return t.length}function xu(t,e){var n=e.indexOf(t);n>-1&&e.splice(n,1)}function bu(t,e,n){if(!Array.isArray(t))return n?e.call(n,t):e(t);for(var i,r,o=[],s=0,a=t.length;s<a;s++)pc(i=t[s])?o.push(null):Array.isArray(i)?o.push(bu(i,e,n)):(r=n?e.call(n,i):e(i),o.push(r));return o}function wu(t,e){return void 0===t?e:t}function Tu(t){return Math.sign?Math.sign(t):0==(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function Mu(t){if(Math.log2)return Math.log2(t);var e=Math.log(t)*Math.LOG2E,n=Math.round(e);return Math.abs(n-e)<1e-14?n:e}function Au(t,e,n){return t*(1-n)+e*n}function Eu(t,e,n){if(t===n||t===e)return t;var i=n-e;return((t-e)%i+i)%i+e}function Cu(t,e,n){return Math.min(n,Math.max(e,t))}function Su(t){return Array.isArray(t)&&t.length>0}var Pu=/^([a-z][a-z\d+\-.]*:)?\/\//i,Ru=/^url\((['"])(.+)\1\)$/i,Ou=/^url\(([^'"].*[^'"])\)$/i;function Iu(t){return xc(t)?Ou.test(t)?1:Ru.test(t)?2:3:0}function Du(t){var e=Iu(t);return 3===e?t:1===e?Ou.exec(t)[1]:2===e?Ru.exec(t)[2]:t}function ku(t){if(su.btoa)return window.btoa(t);for(var e,n,i=String(t),r="",o=0,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.charAt(0|o)||(s="=",o%1);r+=s.charAt(63&e>>8-o%1*8)){if((n=i.charCodeAt(o+=3/4))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|n}return r}function Lu(t,e){for(var n=atob(t),i=new ArrayBuffer(n.length),r=new Uint8Array(i),o=0;o<n.length;o++)r[o]=255&n.charCodeAt(o);return new Blob([i],{type:e})}function Fu(t,e,n,i){return Math.atan2(i-e,n-t)}var Nu,Bu="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function Hu(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var n in t)if("center"===n){if(!e[n]||!ju(t[n][0],e[n][0])||!ju(t[n][1],e[n][1]))return!1}else if(t[n]!==e[n])return!1;return!0}function ju(t,e,n){return null==n&&(n=1e-6),t>=e-n&&t<=e+n}function zu(t,e,n,i){t||(t=100),e||(e=4);var r=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout((function o(){if(0===e)return r.show(),void(n&&(i?n.call(i):n()));e%2==0?r.hide():r.show(),e--,r._flashTimeout=setTimeout(o,t)}),t),this}function Gu(t,e){void 0===t&&(t=[]),void 0===e&&(e="_pt");for(var n=[],i=0,r=t.length;i<r;i++){var o=t[i];if(o){o[e]||(o[e]=new fu(0,0));var s=o[e];s.x=0,s.y=0,n.push(s)}else n.push(null)}return n}if(su.decodeImageInWorker){var Uu=document.createElement("canvas");Uu.width=1,Uu.height=1,Nu=Uu.getContext("2d")}function Vu(t,e){var n=Nu.createImageData(t.width,t.height);n.data.set(t.data),createImageBitmap(n).then((function(t){e(t)}))}function Wu(t){if(t&&0===t.indexOf("http://")||0===t.indexOf("https://"))return t;var e=document.createElement("a");return e.href=t,t=e.href,e=null,t}var Xu={cssWidth:"1px",cssHeight:"1px",width:1,height:1};function Zu(t,e){void 0===e&&(e=1);var n=t.width,i=t.height;return Xu.cssWidth=n+"px",Xu.cssHeight=i+"px",Xu.width=Math.round(n*e),Xu.height=Math.round(i*e),Xu}function qu(t,e){for(var n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function Yu(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function Ku(t,e){for(var n=void 0!==t.base?t.base:1,i=0;!(i>=t.stops.length||e<=t.stops[i][0]);)i++;return 0===i?t.stops[i][1]:i===t.stops.length?t.stops[i-1][1]:function t(e,n,i,r,o,s){return"function"==typeof o?function(){var a=o.apply(void 0,arguments),h=s.apply(void 0,arguments);return t(e,n,i,r,a,h)}:o.length?function(t,e,n,i,r,o){for(var s=[],a=0;a<r.length;a++)s[a]=Qu(t,e,n,i,r[a],o[a]);return s}(e,n,i,r,o,s):Qu(e,n,i,r,o,s)}(e,n,t.stops[i-1][0],t.stops[i][0],t.stops[i-1][1],t.stops[i][1])}function Ju(t,e){return i=t.default,void 0!==(n=e)?n:void 0!==i?i:void 0!==r?r:null;var n,i,r}function Qu(t,e,n,i,r,o){var s,a=i-n,h=t-n;return r*(1-(s=1===e?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)))+o*s}function $u(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function tf(t){for(var e in t)if($u(t[e]))return!0;return!1}function ef(t){return function t(e,n){if(!$u(e))return function(){return e};var i=!0,r=!0,o=(e=JSON.parse(JSON.stringify(e))).stops;if(o)for(var s=0;s<o.length;s++)if($u(o[s][1])){var a=t(o[s][1],n);i=i&&a.isZoomConstant,r=r&&a.isFeatureConstant,o[s]=[o[s][0],a]}var h=function t(e,n){var i,r,o;if($u(e)){var s,a=e.stops&&"object"==typeof e.stops[0][0],h=a||!(a||void 0!==e.property),l=e.type||n||"exponential";if("exponential"===l)s=Ku;else if("interval"===l)s=Yu;else if("categorical"===l)s=qu;else{if("identity"!==l)throw new Error('Unknown function type "'+l+'"');s=Ju}if(a){for(var c={},u=[],f=0;f<e.stops.length;f++){var d=e.stops[f];void 0===c[d[0].zoom]&&(c[d[0].zoom]={zoom:d[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),c[d[0].zoom].stops.push([d[0].value,d[1]])}for(var m in c)u.push([c[m].zoom,t(c[m])]);i=function(t,n){var i=Ku({stops:u,base:e.base},t)(t,n);return"function"==typeof i?i(t,n):i},r=!1,o=!1}else h?(i=function(t){var n=s(e,t);return"function"==typeof n?n(t):n},r=!0,o=!1):(i=function(t,n){var i=s(e,n?n[e.property]:null);return"function"==typeof i?i(t,n):i},r=!1,o=!0)}else i=function(){return e},r=!0,o=!0;return i.isZoomConstant=o,i.isFeatureConstant=r,i}(e,n);return h.isZoomConstant=i&&h.isZoomConstant,h.isFeatureConstant=r&&h.isFeatureConstant,h}(t,"exponential")}function nf(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){for(var i,r=[],o=0;o<t.length;o++)(i=nf(t[o],e))?(r.push(i),n=!0):r.push(t[o]);return n?r:t}var s,a={__fn_types_loaded:!0},h=[];for(s in t)t.hasOwnProperty(s)&&h.push(s);for(var l=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=ef(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},c=0,u=h.length;c<u;c++)$u(t[s=h[c]])?(n=!0,a["_"+s]=t[s],l(s)):a[s]=t[s];return n?a:t}function rf(t){if(!t||!t.stops)return[];for(var e=[],n=0,i=t.stops.length;n<i;n++)e.push(t.stops[n][1]);return e}var of=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function sf(t){return new Function("f","var p = (f && f.properties || {}); return "+af(t))}function af(t){if(!t)return"true";var e=t[0];return t.length<=1?"any"===e?"false":"true":"("+("=="===e?lf(t[1],t[2],"===",!1):"!="===e?lf(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?lf(t[1],t[2],e,!0):"any"===e?cf(t.slice(1),"||"):"all"===e?cf(t.slice(1),"&&"):"none"===e?df(cf(t.slice(1),"||")):"in"===e?uf(t[1],t.slice(2)):"!in"===e?df(uf(t[1],t.slice(2))):"has"===e?ff(t[1]):"!has"===e?df(ff(t[1])):"true")+")"}function hf(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function lf(t,e,n,i){var r=hf(t),o="$type"===t?of.indexOf(e):JSON.stringify(e);return(i?"typeof "+r+"=== typeof "+o+"&&":"")+r+n+o}function cf(t,e){return t.map(af).join(e)}function uf(t,e){"$type"===t&&(e=e.map((function(t){return of.indexOf(t)})));var n=JSON.stringify(e.sort(mf)),i=hf(t);return e.length<=200?n+".indexOf("+i+") !== -1":"function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }("+i+", "+n+",0,"+(e.length-1)+")"}function ff(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function df(t){return"!("+t+")"}function mf(t,e){return t<e?-1:t>e?1:0}function gf(t){var e=t._toJSON(),n=e.feature;return n.type=of.indexOf(n.geometry.type),n.subType=e.subType,n}function pf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)t[i]=n[i]}return t}var _f=[],vf={};function yf(t,e){return nf(t,(function(){var t=e.getMap();return function(t,e,n){return t[0]=e,t[1]=n,t}(_f,t?t.getZoom():12,gc({},e.getProperties(),function(t,e,n,i){return t["{bearing}"]=e,t["{pitch}"]=n,t["{zoom}"]=i,t}(vf,t&&t.getBearing()||0,t&&t.getPitch()||0,t?t.getZoom():10)))}))}function xf(t){var e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}function bf(t,e,n){if(!t.markerPath)return null;var i=1,r=xf(t);_c(t.markerOpacity)&&(i=t.markerOpacity),_c(t.opacity)&&(i*=t.opacity);var o={};if(r){for(var s in r.stroke)r.stroke.hasOwnProperty(s)&&(pc(r.stroke[s])||(o[s]=r.stroke[s]));for(var a in r.fill)r.fill.hasOwnProperty(a)&&(pc(r.fill[a])||(o[a]=r.fill[a]))}for(var h,l=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath],c=[],u=0;u<l.length;u++)(h=gc({},h=xc(l[u])?{path:l[u]}:l[u],o)).d=h.path,delete h.path,c.push(h);var f=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];i<1&&f.push('opacity="'+i+'"'),t.markerPathWidth&&t.markerPathHeight&&f.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),f.push('preserveAspectRatio="none"'),e&&f.push('width="'+e+'"'),n&&f.push('height="'+n+'"'),f.push("><defs></defs>");for(var d=0;d<c.length;d++){var m="<path ";for(var g in c[d])c[d].hasOwnProperty(g)&&(m+=" "+g+'="'+c[d][g]+'"');f.push(m+="></path>")}return f.push("</svg>"),"data:image/svg+xml;base64,"+ku(f.join(" "))}function wf(t,e){if(!t)return[];var n=t;Array.isArray(t)||(n=[t]);for(var i,r,o,s,a=[],h=cc,l=n.length-1;l>=0;l--)if(t=n[l]){e&&(t=Tf(t));for(var c=0;c<h.length;c++)if($u(i=t[h[c]])&&(i=rf(i)),i){Array.isArray(i)||(i=[i]);for(var u=0;u<i.length;u++)"url("===i[u].slice(0,4)&&(i[u]=Du(i[u])),a.push([i[u],t[(r=uc[c])[0]],t[r[1]]])}if("path"===t.markerType&&t.markerPath)if(o=$u(t.markerWidth)?200:t.markerWidth,s=$u(t.markerHeight)?200:t.markerHeight,$u(t.markerPath)){i=rf(t.markerPath);for(var f=t.markerPath,d=0;d<i.length;d++)t.markerPath=i[d],a.push([bf(t),o,s]);t.markerPath=f}else a.push([bf(t),o,s])}return a}function Tf(t){if(!t)return null;var e=t;if(Cc)return e;for(var n,i=cc,r=0,o=i.length;r<o;r++)(n=e[i[r]])&&(e[i[r]]=Mf(n));return e}function Mf(t){if($u(t)){for(var e=t.stops,n=0;n<e.length;n++)e[n][1]=Mf(e[n][1]);return t}return"url("===t.slice(0,4)&&(t=Du(t)),t}var Af=function(){function t(t,e){_c(t)&&_c(e)?(this.width=t,this.height=e):_c(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}var e=t.prototype;return e.copy=function(){return new t(this.width,this.height)},e.add=function(e,n){var i,r;return e instanceof t?(i=this.width+e.width,r=this.height+e.height):(i=this.width+e,r=this.height+n),new t(i,r)},e.equals=function(t){return this.width===t.width&&this.height===t.height},e.multi=function(e){return new t(this.width*e,this.height*e)},e._multi=function(t){return this.width*=t,this.height*=t,this},e._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},e.toPoint=function(){return new fu(this.width,this.height)},e.toArray=function(){return[this.width,this.height]},e.toJSON=function(){return{width:this.width,height:this.height}},t}();function Ef(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}var Cf=/[\b\t\r\v\f]/gim;function Sf(t){return xc(t)?t.replace(Cf,""):t}function Pf(t){return Ef(t).split(/\s+/)}var Rf="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function Of(t,e){return Of.node?Of.node(t,e):(Rf.font=e,Rf.measureText(t).width)}function If(t,e,n){var i=Of(t,e);return new Af(i,n||14)}function Df(t,e,n,i){if(!t||0===t.length)return[{text:"",width:0}];var r=pc(i)?Of(t,e):i,o=r/t.length,s=Math.floor(n/o/2);if(o>=n||s<=0)return[{text:"",width:n}];if(r<=n)return[{text:t,width:r}];for(var a=[],h=t.substring(0,s),l=o*s,c=s,u=t.length;c<u;c++){var f=t[c],d=Of(h+f);d>=n?(a.push({text:h,width:l}),h=t.substring(c,s+c),c+=s-1,l=o*s):(h+=f,l=d),c>=u-1&&(l=Of(h),a.push({text:h,width:l}))}return a}var kf=/\{([\w_]+)\}/g;function Lf(t,e){return xc(t)?t.replace(kf,(function(t,n){if(!e)return"";var i=e[n];return pc(i)?"":Array.isArray(i)?i.join():i})):t}function Ff(t,e){_c(t)&&(t+="");var n=e.textMaxHeight||0,i=Hf(t=t||"",e);return n&&n<i.size.height&&(i.size.height=n),i}function Nf(t,e,n){var i=t.width,r=t.height;return new fu("left"===e?-i:"right"===e?0:-i/2,"top"===n?-r:"bottom"===n?0:-r/2)}function Bf(t){return t.textFont?t.textFont:(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+t.textSize+"px "+(t.textFaceName?'"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"':"monospace")}function Hf(t,e){var n=Bf(e),i=e.textLineSpacing||0,r=If(t,n,e.textSize),o=r.width,s=r.height,a=e.textWrapCharacter,h=[],l=e.textWrapWidth;(!l||l>o)&&(l=o),xc(t)||(t+="");var c=0;if(a&&t.indexOf(a)>=0)for(var u=t.split(a),f=0,d=u.length;f<d;f++){var m=u[f],g=Of(m,n);if(g>l)for(var p=Df(m,n,l,g),_=0,v=p.length;_<v;_++){var y=p[_].width;y>c&&(c=y),h.push({text:p[_].text,size:new Af(y,s)})}else g>c&&(c=g),h.push({text:m,size:new Af(g,s)})}else if(o>l)for(var x=Df(t,n,l,o),b=0;b<x.length;b++){var w=x[b].width;w>c&&(c=w),h.push({text:x[b].text,size:new Af(w,s)})}else o>c&&(c=o),h.push({text:t,size:r});var T=h.length;return{total:T,size:new Af(c,s*T+i*(T-1)),rows:h,rawSize:r}}function jf(t){var e=0,n=t&&t.length||0;if(!n)return e;for(var i=0;i<n;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;return e}function zf(t){return t&&t.colorStops}function Gf(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var n=[],i=t.colorStops.length-1;i>=0;i--)n.push(t.colorStops[i].join());e.push(n.join(","))}return e.join("_")}function Uf(t,e){if(!t)return 1;var n=[];if(Array.isArray(t)){for(var i=0;i<t.length;i++)n.push(Uf(t[i],e));return n.sort().join(",")}var r=Object.keys(t).sort().reduce((function(n,i){return e&&0!==i.indexOf(e)||(n[i]=t[i]),n}),{});return jf(JSON.stringify(r))}function Vf(t,e){function n(t,e){pc(t.opacity)?t.opacity=e:t.opacity*=e}var i;if(Array.isArray(t)){i=[];for(var r=0;r<t.length;r++){var o=gc({},t[r]);n(o,e),i.push(o)}}else n(i=gc({},t),e);return i}function Wf(t){var e=Array.prototype.slice.call(arguments,1);if(e&&e.length||(e=[{}]),Array.isArray(t)){for(var n,i,r=[],o=0,s=t.length;o<s;o++){n=t[o],i={};for(var a=0,h=e.length;a<h;a++)Array.isArray(e[a])?pc(e[a][o])?gc(i,n||{}):gc(i,n,e[a][o]):gc(i,n,e[a]?e[a]:{});r.push(i)}return r}var l=[{},t];return l.push.apply(l,e),gc.apply(this,l)}function Xf(t){if(t.symbol&&(t=[t]),Array.isArray(t))return t;var e=t.$root,n=t.$iconset;return t=t.style,(e||n)&&(e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),n&&"/"===n[n.length-1]&&(n=n.substring(0,n.length-1)),Zf(t,(function(t){return"{$root}"===t?e:"{$iconset}"===t?n:null}))),t}function Zf(t,e){for(var n=0;n<t.length;n++){var i=t[n].symbol;i&&Yf(i,e)}}var qf=/(\{\$root\}|\{\$iconset\})/g;function Yf(t,e){for(var n in t)t.hasOwnProperty(n)&&"textName"!==n&&(xc(t[n])&&t[n].length>2?t[n]=t[n].replace(qf,e):$u(t[n])?t[n]=Kf(t[n],e):yc(t[n])&&Yf(t[n],e))}function Kf(t,e){var n=t.default;xc(n)&&(t.default=n.replace(qf,e));for(var i=t.stops,r=0;r<i.length;r++)Array.isArray(i[r])&&(xc(i[r][1])?i[r][1]=i[r][1].replace(qf,e):$u(i[r][1])&&(i[r][1]=Kf(i[r][1],e)));return t}function Jf(t){void 0===t&&(t=[]),Array.isArray(t)||(t=[t]);for(var e=t.length,n=0;n<e;n++){var i=t[n];if(i.style){var r=i.style,o=r.lineDasharray,s=r.lineWidth;if(s&&_c(s)&&s>0&&o&&Array.isArray(o)&&o.length)return!0}}return!1}var Qf=Object.freeze({now:mc,extend:gc,isNil:pc,isNumber:_c,isInteger:vc,isObject:yc,isString:xc,isFunction:bc,hasOwn:Tc,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},isEmpty:function(t){var e;for(e in t)return!1;return!e},toRadian:Ac,toDegree:Ec,IS_NODE:Cc,get requestAnimFrame(){return lu},get cancelAnimFrame(){return cu},isSVG:du,loadImage:mu,UID:pu,GUID:_u,parseJSON:vu,pushIn:yu,removeFromArray:xu,forEachCoord:bu,getValueOrDefault:wu,sign:Tu,log2:Mu,interpolate:Au,wrap:Eu,clamp:Cu,isArrayHasData:Su,isURL:function(t){return Pu.test(t)},isCssUrl:Iu,extractCssUrl:Du,btoa:ku,b64toBlob:Lu,computeDegree:Fu,emptyImageUrl:Bu,equalMapView:Hu,flash:zu,_defaults:function(t,e){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i],o=Object.getOwnPropertyDescriptor(e,r);o&&o.configurable&&void 0===t[r]&&Object.defineProperty(t,r,o)}return t},getPointsResultPts:Gu,getImageBitMap:Vu,getAbsoluteURL:Wu,calCanvasSize:Zu,translateToSVGStyles:xf,getMarkerPathBase64:bf,getExternalResources:wf,convertResourceUrl:Tf,isGradient:zf,getGradientStamp:Gf,getSymbolStamp:function(t,e){return Uf(t,e)},getSymbolHash:Uf,lowerSymbolOpacity:Vf,extendSymbol:Wf,parseStyleRootPath:Xf,convertStylePath:Zf,parseSymbolPath:Yf,isDashLine:Jf,trim:Ef,escapeSpecialChars:Sf,splitWords:Pf,stringWidth:Of,stringLength:If,splitContent:Df,CONTENT_EXPRE:kf,replaceVariable:Lf,describeText:Ff,getAlignPoint:Nf,getFont:Bf,splitTextToRow:Hf,hashCode:jf}),$f=Cc?function(t){return t[0]}:function(t){for(var e=document.documentElement.style,n=0;n<t.length;n++)if(t[n]in e)return t[n];return!1},td=$f(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),ed=$f(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),nd=$f(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]);function id(t,e){var n=document.createElement(t);return e&&_d(n,e),n}function rd(t,e,n){var i=id(t);return e&&md(i,e),n&&n.appendChild(i),i}function od(t){if(!t)return this;if(su.ielt9||su.ie9){var e=id("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function sd(t,e,n,i){if(!(t&&t.addEventListener&&e&&n))return this;for(var r=function(e){e||(e=window.event),n.call(i||t,e)},o=e.split(" "),s=o.length-1;s>=0;s--){var a=o[s];a&&(t["Z__"+a]||(t["Z__"+a]=[]),hd(t,a,n)>=0&&(console.warn(t,"find '"+a+"' handler:",n," The old listener function will be removed"),ad(t,a,n)),t["Z__"+a].push({callback:r,src:n}),t.addEventListener(a,r,!!su.supportsPassive&&{capture:!1,passive:!1}))}return this}function ad(t,e,n){function i(e,n){"mousewheel"===e&&su.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,n,!1)}if(!t||!t.removeEventListener||!e)return this;for(var r=e.split(" "),o=r.length-1;o>=0;o--){var s=r[o];if(s){if(!n&&t["Z__"+s]){for(var a=t["Z__"+s],h=0,l=a.length;h<l;h++)i(a[h].callback);return delete t["Z__"+s],this}var c=hd(t,s,n);if(c<0)return this;i(s,t["Z__"+s][c].callback),t["Z__"+s].splice(c,1)}}return this}function hd(t,e,n){if(!t||!t["Z__"+e]||!n)return-1;for(var i=t["Z__"+e],r=0,o=i.length;r<o;r++)if(i[r].src===n)return r;return-1}function ld(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function cd(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function ud(t,e){return t?(su.any3d?function(t,e){var n=e||new fu(0,0);t.style[td]=su.any3d?"translate3d("+n.x+"px,"+n.y+"px,0px)":"translate("+n.x+"px,"+n.y+"px)"}(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function fd(t){var e=window.getComputedStyle(t),n=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],i=t.getBoundingClientRect(),r=t.offsetWidth,o=t.offsetHeight;return t.__position=[i.left+n[0],i.top+n[1],r?i.width/r:1,o?i.height/o:1],t.__position}function dd(t,e){t||(t=window.event);var n=e.__position;return n||(n=fd(e)),new fu((t.clientX-n[0]-e.clientLeft)/n[2],(t.clientY-n[1]-e.clientTop)/n[3])}function md(t,e){var n,i,r,o=t.style.cssText;return(r=(n=o).length-(i=";").length)>=0&&n.indexOf(i,r)===r||(o+=";"),t.style.cssText=o+e,this}function gd(t,e){if(void 0!==t.classList)return t.classList.contains(e);var n=vd(t);return n.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(n)}function pd(t,e){if(void 0===t.classList||gd(t,e)){var n=vd(t);_d(t,(n?n+" ":"")+e)}else for(var i=Pf(e),r=0,o=i.length;r<o;r++)t.classList.add(i[r]);return this}function _d(t,e){return pc(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function vd(t){return pc(t.className.baseVal)?t.className:t.className.baseVal}function yd(t,e){var n,i=((n=document.createElement(t)).style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(n),n);xc(e)?i.innerHTML=e:i.appendChild(e);var r=new Af(i.clientWidth,i.clientHeight);return od(i),r}$f(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);var xd,bd=sd,wd=ad,Td="function"==typeof Map,Md=function(){},Ad=function(){function t(t,e){this.max=t,this.onRemove=e||Md,this.reset()}var e=t.prototype;return e.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var n=this.getAndRemove(this.order[0]);n&&this.onRemove(n)}return this},e.has=function(t){return t in this.data},e.keys=function(){return this.order},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},e.get=function(t){return this.has(t)?this.data[t]:null},e.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},e.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},t}();Td&&(xd=function(){function t(t,e){this.max=t,this.onRemove=e||Md,this.reset()}var e=t.prototype;return e.reset=function(){if(this.data){var t=this.data.values(),e=Array.isArray(t),n=0;for(t=e?t:t[Symbol.iterator]();;){var i;if(e){if(n>=t.length)break;i=t[n++]}else{if((n=t.next()).done)break;i=n.value}this.onRemove(i)}}return this.data=new Map,this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e),this.data.size>this.max&&this.shrink()):this.data.set(t,e),this):this},e.keys=function(){var t=new Array(this.data.size),e=0,n=this.data.keys(),i=Array.isArray(n),r=0;for(n=i?n:n[Symbol.iterator]();;){var o;if(i){if(r>=n.length)break;o=n[r++]}else{if((r=n.next()).done)break;o=r.value}t[e++]=o}return t},e.shrink=function(){for(var t=this.data.keys(),e=t.next();this.data.size>this.max;){var n=this.getAndRemove(e.value);n&&this.onRemove(n),e=t.next()}},e.has=function(t){return this.data.has(t)},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data.get(t);return this.data.delete(t),e},e.get=function(t){return this.has(t)?this.data.get(t):null},e.remove=function(t){if(!this.has(t))return this;var e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this},e.setMaxSize=function(t){return this.max=t,this.data.size>this.max&&this.shrink(),this},t}());var Ed=Td?xd:Ad,Cd={jsonp:function(t,e){var n="_maptalks_jsonp_"+pu();t.match(/\?/)?t+="&callback="+n:t+="?callback="+n;var i=document.createElement("script");return i.type="text/javascript",i.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(i),i=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(i),this},get:function(t,e,n){if(bc(e)){var i=n;n=e,e=i}if(Cc&&Cd.get.node)return Cd.get.node(t,n,e);var r=Cd._getClient(n);if(r.open("GET",t,!0),e){for(var o in e.headers)r.setRequestHeader(o,e.headers[o]);r.withCredentials="include"===e.credentials,e.responseType&&(r.responseType=e.responseType)}return r.send(null),r},post:function(t,e,n){var i;if(xc(t)){if(bc(e)){var r=n;n=e,e=r}i=(e=e||{}).postData}else i=e,t=(e=t).url;if(Cc&&Cd.post.node)return e.url=t,Cd.post.node(e,i,n);var o=Cd._getClient(n);if(o.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in o)for(var s in e.headers)e.headers.hasOwnProperty(s)&&o.setRequestHeader(s,e.headers[s]);return xc(i)||(i=JSON.stringify(i)),o.send(i),o},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=Cd._wrapCallback(e,t),e},getArrayBuffer:function(t,e,n){if(bc(e)){var i=n;n=e,e=i}return e||(e={}),e.responseType="arraybuffer",Cd.get(t,e,n)},getImage:function(t,e,n){return Cd.getArrayBuffer(e,n,(function(e,n){if(e)t.onerror&&t.onerror(e);else if(n){var i=window.URL||window.webkitURL,r=t.onload;t.onload=function(){r&&r(),i.revokeObjectURL(t.src)};var o=new Blob([new Uint8Array(n.data)],{type:n.contentType});t.cacheControl=n.cacheControl,t.expires=n.expires,t.src=n.data.byteLength?i.createObjectURL(o):Bu}}))},getJSON:function(t,e,n){if(bc(e)){var i=n;n=e,e=i}var r=function(t,e){var i=e?vu(e):null;n(t,i)};return e&&e.jsonp?Cd.jsonp(t,r):Cd.get(t,e,r)}},Sd=!1,Pd=null,Rd=Math.PI/180,Od={setHitTesting:function(t){Sd=t},createCanvas:function(t,e,n){var i;return Cc?i=new n(t,e):((i=id("canvas")).width=t,i.height=e),i},prepareCanvasFont:function(t,e){t.textBaseline="top",t.font=Bf(e);var n=e.textFill;n||(n="#000"),t.fillStyle=Od.getRgba(n,e.textOpacity)},prepareCanvas:function(t,e,n,i){if(e){var r=e.lineWidth;pc(r)||t.lineWidth===r||(t.lineWidth=r);var o=e.linePatternFile,s=e.lineColor||"#000";if(i)t.strokeStyle="#000";else if(o&&n){var a;(e.linePatternDx||e.linePatternDy)&&(a=[e.linePatternDx,e.linePatternDy]),Od._setStrokePattern(t,o,r,a,n),e.lineDasharray=[]}else zf(s)?t.strokeStyle=e.lineGradientExtent?Od._createGradient(t,s,e.lineGradientExtent):"#000":(Array.isArray(s)&&(s=Od.normalizeColorToRGBA(s)),t.strokeStyle=s);e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&Su(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var h=e.polygonPatternFile,l=e.polygonFill||"rgba(255,255,255,0)";if(i)t.fillStyle="#000";else if(h&&n){var c=Dd(h),u=n.getImage([c,null,null]);if(u||(u=n.getImage([c+"-texture",null,r])),du(c)&&u instanceof Image&&(su.edge||su.ie)){var f=u.width||20,d=u.height||20,m=Od.createCanvas(f,d);Od.image(m.getContext("2d"),u,0,0,f,d),u=m}u?(t.fillStyle=t.createPattern(u,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy])):"undefined"!=typeof console&&console.warn("img not found for",c)}else zf(l)?t.fillStyle=e.polygonGradientExtent?Od._createGradient(t,l,e.polygonGradientExtent):"rgba(255,255,255,0)":(Array.isArray(l)&&(l=Od.normalizeColorToRGBA(l)),t.fillStyle=l)}},_createGradient:function(t,e,n){var i=null,r=e.places,o=n.getMin(),s=n.getMax(),a=n.getWidth(),h=n.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(r){if(6!==r.length)throw new Error("A radial gradient's places should have 6 numbers.");r=[o.x+r[0]*a,o.y+r[1]*h,a*r[2],o.x+r[3]*a,o.y+r[4]*h,a*r[5]]}else{var l=n.getCenter()._round();r=[l.x,l.y,Math.abs(l.x-o.x),l.x,l.y,0]}i=t.createRadialGradient.apply(t,r)}}else{if(r){if(4!==r.length)throw new Error("A linear gradient's places should have 4 numbers.");r=[o.x+r[0]*a,o.y+r[1]*h,o.x+r[2]*a,o.y+r[3]*h]}else r=[o.x,o.y,s.x,o.y];i=t.createLinearGradient.apply(t,r)}return e.colorStops.forEach((function(t){i.addColorStop.apply(i,t)})),i},_setStrokePattern:function(t,e,n,i,r){var o,s=Dd(e);if(Cc)o=r.getImage([s,null,n]);else{var a=s+"-texture-"+n;if(!(o=r.getImage(a))){var h=r.getImage([s,null,null]);if(h){var l;l=h.width&&h.height?Math.round(h.width*n/h.height):n;var c=Od.createCanvas(l,n,t.canvas.constructor);Od.image(c.getContext("2d"),h,0,0,l,n),r.addResource([a,null,n],c),o=c}}}o?(t.strokeStyle=t.createPattern(o,"repeat"),t.strokeStyle.linePatternOffset=i):"undefined"!=typeof console&&console.warn("img not found for",s)},clearRect:function(t,e,n,i,r){t.canvas._drawn=!1,t.clearRect(e,n,i,r)},fillCanvas:function(t,e,n,i){if(Sd&&(e=1),t.canvas._drawn=!0,0!==e){var r,o=Od._isPattern(t.fillStyle),s=t.fillStyle&&t.fillStyle.polygonPatternOffset,a=s?s[0]:0,h=s?s[1]:0;pc(e)&&(e=1),e<1&&(r=t.globalAlpha,t.globalAlpha*=e),o&&t.translate((n=n||0)+a,(i=i||0)+h),t.fill(),o&&t.translate(-n-a,-i-h),e<1&&(t.globalAlpha=r)}},getRgba:function(t,e){return pc(e)&&(e=1),"#"!==t[0]?(Array.isArray(t)&&(t=Od.normalizeColorToRGBA(t,e)),t):(7===t.length?(n=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16)):(n=17*parseInt(t.substring(1,2),16),i=17*parseInt(t.substring(2,3),16),r=17*parseInt(t.substring(3,4),16)),"rgba("+n+","+i+","+r+","+e+")");var n,i,r},normalizeColorToRGBA:function(t,e){return void 0===e&&(e=1),"rgba("+255*t[0]+","+255*t[1]+","+255*t[2]+","+(4===t.length?t[3]:1)*e+")"},image:function(t,e,n,i,r,o){t.canvas._drawn=!0;try{_c(r)&&_c(o)?t.drawImage(e,n,i,r,o):t.drawImage(e,n,i)}catch(t){console&&(console.warn("error when drawing image on canvas:",t),console.warn(e))}},text:function(t,e,n,i,r){Od._textOnMultiRow(t,r.rows,i,n,r.size,r.rawSize)},_textOnMultiRow:function(t,e,n,i,r,o){for(var s,a,h=Nf(r,n.textHorizontalAlignment,n.textVerticalAlignment),l=o.height+n.textLineSpacing,c=i.add(0,h.y),u=n.textMaxHeight,f=0,d=0,m=e.length;d<m&&(s=e[d].text,a=Nf(e[d].size,n.textHorizontalAlignment,n.textVerticalAlignment),Od._textOnLine(t,s,c.add(a.x,d*l),n.textHaloRadius,n.textHaloFill,n.textHaloOpacity),!(u>0&&(f+=l)+o.height>=u));d++);},_textOnLine:function(t,e,n,i,r,o){Sd&&(o=1);var s,a,h=0!==o&&0!==i;t.textBaseline="top";var l=t.shadowBlur,c=t.shadowOffsetX,u=t.shadowOffsetY;if(h){var f=t.globalAlpha;t.globalAlpha*=o,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*i,Array.isArray(r)&&(r=Od.normalizeColorToRGBA(r)),t.strokeStyle=r,t.strokeText(e,n.x,n.y+1),t.miterLimit=10,t.globalAlpha=f,s=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",a=t.fillStyle,t.fillStyle="#000"}l&&h&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),Od.fillText(t,e,n),s&&(t.globalCompositeOperation=s,Od.fillText(t,e,n,a),l&&(t.shadowBlur=l,t.shadowOffsetX=c,t.shadowOffsetY=u))},fillText:function(t,e,n,i){t.canvas._drawn=!0,i&&(t.fillStyle=i),t.fillText(e,n.x,n.y+1)},_stroke:function(t,e,n,i){if(Sd&&(e=1),t.canvas._drawn=!0,0!==e){var r,o=t.strokeStyle&&t.strokeStyle.linePatternOffset,s=o?o[0]:0,a=o?o[1]:0,h=Od._isPattern(t.strokeStyle)&&(!pc(n)&&!pc(i)||!pc(s)&&!pc(a));pc(e)&&(e=1),e<1&&(r=t.globalAlpha,t.globalAlpha*=e),h&&t.translate((n=n||0)+s,(i=i||0)+a),t.stroke(),h&&t.translate(-n-s,-i-a),e<1&&(t.globalAlpha=r)}},_path:function(t,e,n,i,r){if(Su(e))for(var o,s=Su(n),a=!0!==r&&Od._isPattern(t.strokeStyle),h=0,l=e.length;h<l;h++)if(o=e[h],!s||t.setLineDash)t.lineTo(o.x,o.y),a&&h>0&&(c(e[h-1],o),t.beginPath(),t.moveTo(o.x,o.y));else if(s){if(h===l-1)break;Id(t,o,e[h+1],n)}function c(e,n){var r=Fu(e.x,e.y,n.x,n.y);t.save();var o=Math.cos(r);Math.abs(o)<1e-7?t.translate(e.x-t.lineWidth/2,e.y):t.translate(e.x,e.y-t.lineWidth/2/o),t.rotate(r),Od._stroke(t,i),t.restore()}},path:function(t,e,n,i,r){Su(e)&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),Od._path(t,e,r,n),Od._stroke(t,n))},_multiClip:function(t,e){if(e&&0!==e.length)for(var n=0,i=(e=e[0]).length;n<i;n++){var r=e[n],o=r.x,s=r.y;0===n?t.moveTo(o,s):t.lineTo(o,s),n===i-1&&t.lineTo(o=e[0].x,s=e[0].y)}},polygon:function(t,e,n,i,r,o){if(t.isMultiClip)Od._multiClip(t,e);else if(Su(e)){var s=Od._isPattern(t.strokeStyle),a=Su(r)&&!t.setLineDash||s&&!o;Su(e[0])||(e=[e]);var h,l,c,u=t;if(e.length>1&&!Cc&&(Pd||(Pd=Od.createCanvas(1,1)),t.canvas._drawn=!1,Pd.width=t.canvas.width,Pd.height=t.canvas.height,kd(t=Pd.getContext("2d"),u)),a){for(t.save(),l=0,c=e.length;l<c;l++)Su(e[l])&&(Od._ring(t,e[l],null,0,!0),h=i,l>0&&(t.globalCompositeOperation="destination-out",h=1),Od.fillCanvas(t,h,e[l][0].x,e[l][0].y),l>0?t.globalCompositeOperation="source-over":c>1&&(t.fillStyle="#fff"),Od._stroke(t,0));t.restore()}var f=t.fillStyle;for(l=0,c=e.length;l<c;l++)Su(e[l])&&(o?(Od.paintSmoothLine(t,e[l],n,o,!0),t.closePath()):Od._ring(t,e[l],r,n),a||(h=i,l>0&&(t.globalCompositeOperation="destination-out",h=1),Od.fillCanvas(t,h,e[l][0].x,e[l][0].y),l>0?t.globalCompositeOperation="source-over":c>1&&(t.fillStyle="#fff")),Od._stroke(t,n));t.fillStyle!==f&&(t.fillStyle=f),e.length>1&&!Cc&&(u.drawImage(Pd,0,0),u.canvas._drawn=t.canvas._drawn,kd(u,t))}},_ring:function(t,e,n,i,r){var o=Od._isPattern(t.strokeStyle);r||!o||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),Od._path(t,e,n,i,r),o||t.closePath()},paintSmoothLine:function(t,e,n,i,r,o,s){if(e)if(e.length<=2||!i)Od.path(t,e,n);else{var a,h=e.length,l=r?h:h-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==s&&(l-=Math.max(l-o-1,0));for(var c=0;c<l;c++){var u=void 0,f=void 0,d=void 0,m=void 0,g=void 0,p=void 0;c-1<0?r?(u=e[l-1].x,f=e[l-1].y):(u=e[c+1].x,f=e[c+1].y):(u=e[c-1].x,f=e[c-1].y),c+1<h?(d=e[c+1].x,m=e[c+1].y):(d=e[c+1-h].x,m=e[c+1-h].y),c+2<h?(g=e[c+2].x,p=e[c+2].y):r?(g=e[c+2-h].x,p=e[c+2-h].y):(g=e[c].x,p=e[c].y);var _=y(u,f,e[c].x,e[c].y,d,m,g,p,i,c===l-1?s:1);if(c===l-1&&s>=0&&s<1){t.bezierCurveTo(_[0],_[1],_[2],_[3],_[4],_[5]),e.splice(l-1,h-(l-1)-1);var v=new fu(_[4],_[5]);v.prevCtrlPoint=new fu(_[2],_[3]),e.push(v),h=e.length}else t.bezierCurveTo(_[0],_[1],_[2],_[3],d,m);e[c].nextCtrlPoint=_.slice(0,2),e[c].prevCtrlPoint=a?a.slice(2):null,a=_}!r&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[h-1].prevCtrlPoint||(e[h-1].prevCtrlPoint=e[h-2].nextCtrlPoint),Od._stroke(t,n)}function y(t,e,n,i,r,o,s,a,h,l){var c=(t+n)/2,u=(e+i)/2,f=(n+r)/2,d=(i+o)/2,m=(r+s)/2,g=(o+a)/2,p=Math.sqrt((n-t)*(n-t)+(i-e)*(i-e)),_=Math.sqrt((r-n)*(r-n)+(o-i)*(o-i)),v=p/(p+_),y=_/(_+Math.sqrt((s-r)*(s-r)+(a-o)*(a-o))),x=c+(f-c)*v,b=u+(d-u)*v,w=f+(m-f)*y,T=d+(g-d)*y,M=x+(f-x)*h+n-x,A=b+(d-b)*h+i-b,E=w+(f-w)*h+r-w,C=T+(d-T)*h+o-T,S=[M,A,E,C];return l<1?function(t,e,n,i,r,o,s,a,h,l){var c=1-t,u=1-e,f=n*u*u+2*r*e*u+s*e*e,d=r*u*u+2*s*e*u+h*e*e,m=i*u*u+2*o*e*u+a*e*e,g=o*u*u+2*a*e*u+l*e*e;return[(n*c*c+2*r*t*c+s*t*t)*u+(r*c*c+2*s*t*c+h*t*t)*e,(i*c*c+2*o*t*c+a*t*t)*u+(o*c*c+2*a*t*c+l*t*t)*e,f*c+d*t,m*c+g*t,f*u+d*e,m*u+g*e]}(0,l,n,i,M,A,E,C,r,o):S}},_arcBetween:function(t,e,n,i){var r=i,o=e.distanceTo(n),s=o/2/Math.sin(r/2),a=Math.asin((n.y-e.y)/o);e.x>n.x&&(a=Math.PI-a);var h=a-(90*Rd-r/2),l=Math.cos(h)*s,c=Math.sin(h)*s,u=e.x+l,f=e.y+c,d=Math.asin((n.y-f)/s);u>n.x&&(d=Math.PI-d);var m=d+r;return t.beginPath(),t.arc(u,f,s,d,m),[u,f]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,n,i){t.beginPath();var r=e[0];t.moveTo(r.x,r.y);var o=[t];o.push.apply(o,e.splice(1)),Od._bezierCurveTo.apply(Od,o),Od.fillCanvas(t,i),Od._stroke(t,n)},_bezierCurveTo:function(t,e,n,i){t.bezierCurveTo(e.x,e.y,n.x,n.y,i.x,i.y)},ellipse:function(t,e,n,i,r,o,s){var a,h,l,c,u,f,d,m,g;t.beginPath(),n===i&&n===r?t.arc(e.x,e.y,n,0,2*Math.PI):t.ellipse?i!==r?(t.ellipse(e.x,e.y,n,i,0,180*Rd,360*Rd,!1),t.ellipse(e.x,e.y,n,r,0,0,180*Rd,!1)):t.ellipse(e.x,e.y,n,i,0,0,360*Rd,!1):(d=(l=n)*(f=.5522848),m=(c=i)*f,g=(u=r)*f,t.moveTo((a=e.x)-l,h=e.y),t.bezierCurveTo(a-l,h-m,a-d,h-c,a,h-c),t.bezierCurveTo(a+d,h-c,a+l,h-m,a+l,h),t.bezierCurveTo(a+l,h+g,a+d,h+u,a,h+u),t.bezierCurveTo(a-d,h+u,a-l,h+g,a-l,h),t.closePath()),Od.fillCanvas(t,s,e.x-n,e.y-i),Od._stroke(t,o,e.x-n,e.y-i)},rectangle:function(t,e,n,i,r){var o=e.x,s=e.y;t.beginPath(),t.rect(o,s,n.width,n.height),Od.fillCanvas(t,r,o,s),Od._stroke(t,i,o,s)},sector:function(t,e,n,i,r,o){var s=Rd;function a(t,e,n,i,a,h){var l=s*-h,c=s*-a;t.beginPath(),t.moveTo(e,n),t.arc(e,n,i,l,c),t.lineTo(e,n),Od.fillCanvas(t,o,e-i,n-i),Od._stroke(t,r,e-i,n-i)}a(t,e.x,e.y,n,i[0],i[1])},_isPattern:function(t){return!xc(t)&&!("addColorStop"in t)},drawCross:function(t,e,n,i,r){t.canvas._drawn=!0,t.strokeStyle=r,t.lineWidth=i,t.beginPath(),t.moveTo(e-5,n),t.lineTo(e+5,n),t.moveTo(e,n-5),t.lineTo(e,n+5),t.stroke()},copy:function(t,e){var n=e||id("canvas");return n.width=t.width,n.height=t.height,n.getContext("2d").drawImage(t,0,0),n},pixelRect:function(t,e,n,i){var r=t.globalAlpha,o=!1;if(t.lineWidth>0&&n>0)o=!0,n<1&&(t.globalAlpha*=n);else{if(!(i>0))return;i<1&&(t.globalAlpha*=i)}t.canvas._drawn=!0,o?t.strokeRect(e[0],e[1],1,1):t.fillRect(e[0],e[1],1,1),t.globalAlpha!==r&&(t.globalAlpha=r)}};function Id(t,e,n,i){var r=e.x,o=e.y,s=n.x,a=n.y,h=i,l=function(t,e){return t<=e},c=function(t,e){return t>=e},u=function(t,e){return Math.min(t,e)},f=function(t,e){return Math.max(t,e)},d={thereYet:c,cap:u},m={thereYet:c,cap:u};o-a>0&&(m.thereYet=l,m.cap=f),r-s>0&&(d.thereYet=l,d.cap=f),t.moveTo(r,o);for(var g,p,_=r,v=o,y=0,x=!0;!d.thereYet(_,s)||!m.thereYet(v,a);)g=Math.atan2(a-o,s-r),p=h[y],_=d.cap(s,_+Math.cos(g)*p),v=m.cap(a,v+Math.sin(g)*p),x?t.lineTo(_,v):t.moveTo(_,v),y=(y+1)%h.length,x=!x}function Dd(t){return"data:image/"===t.substring(0,11)?t:Du(t)}function kd(t,e){t.filter=e.filter,t.fillStyle=e.fillStyle,t.globalAlpha=e.globalAlpha,t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=e.shadowOffsetY,t.strokeStyle=e.strokeStyle}var Ld="undefined"!=typeof Promise?Promise:Fl,Fd=function(t){return function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.on=function(t,e,n){if(!t)return this;if(!xc(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var i,r,o=t.toLowerCase().split(" ");n||(n=this);for(var s=0,a=o.length;s<a;s++){(r=this._eventMap[i=o[s]])||(this._eventMap[i]=r=[]);var h=r.length;if(h>0)for(var l=0;l<h;l++)if(e===r[l].handler&&r[l].context===n)return console.warn(this,"find '"+t+"' handler:",e," The old listener function will be removed"),this;r.push({handler:e,context:n})}return this},n.addEventListener=function(){return this.on.apply(this,arguments)},n.once=function(t,e,n){if(!xc(t)){var i={};for(var r in t)t.hasOwnProperty(r)&&(i[r]=this._wrapOnceHandler(r,t[r],n));return this._switch("on",i)}for(var o=t.split(" "),s=0,a=o.length;s<a;s++)this.on(o[s],this._wrapOnceHandler(o[s],e,n));return this},n.off=function(t,e,n){if(!this._eventMap||!t)return this;if(!xc(t))return this._switch("off",t,e);if(!e)return this;var i,r,o,s=t.split(" ");n||(n=this);for(var a=0,h=s.length;a<h;a++){if(o="Z__"+(i=s[a].toLowerCase()),!(r=this._eventMap[i]))return this;for(var l=r.length-1;l>=0;l--){var c=r[l];e!==c.handler&&e!==c.handler[o]||c.context!==n||(delete c.handler[o],r.splice(l,1))}r.length||delete this._eventMap[i]}return this},n.removeEventListener=function(){return this.off.apply(this,arguments)},n.listens=function(t,e,n){if(!this._eventMap||!xc(t))return 0;var i=this._eventMap[t.toLowerCase()];if(!i||!i.length)return 0;if(!e)return i.length;for(var r=0,o=i.length;r<o;r++)if(e===i[r].handler&&(pc(n)||i[r].context===n))return 1;return 0},n.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},n.copyEventListeners=function(t){var e,n=t._eventMap;if(!n)return this;for(var i in n)for(var r=0,o=(e=n[i]).length;r<o;r++)this.on(i,e[r].handler,e[r].context);return this},n.fire=function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},n._wrapOnceHandler=function(t,e,n){var i=this,r="Z__"+t,o=!1,s=function a(){o||(delete s[r],o=!0,e.apply(n||this,arguments),i.off(t,a,this))};return s[r]=e,s},n._switch=function(t,e,n){for(var i in e)e.hasOwnProperty(i)&&this[t](i,e[i],n);return this},n._clearListeners=function(t){this._eventMap&&xc(t)&&this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null)},n._clearAllListeners=function(){this._eventMap=null},n._setEventParent=function(t){return this._eventParent=t,this},n._setEventTarget=function(t){return this._eventTarget=t,this},n._fire=function(t,e){if(!this._eventMap)return this;var n=this._eventMap[t.toLowerCase()];if(!n)return this;e||(e={}),e.type=t,e.target=this._eventTarget||this;for(var i,r,o=n.slice(0),s=0,a=o.length;s<a;s++)o[s]&&(i=o[s].context,r=gc({},e),!1===(i?o[s].handler.call(i,r):o[s].handler(r))&&e.domEvent&&cd(e.domEvent));return this},e}(t)},Nd=Fd(function(){function t(t){this.target=t}var e=t.prototype;return e.enable=function(){return this._enabled||(this._enabled=!0,this.addHooks()),this},e.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},e.enabled=function(){return!!this._enabled},e.remove=function(){this.disable(),delete this.target,delete this.dom},t}()),Bd=function(){function t(t){if(!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(t),this.callInitHooks()}var e=t.prototype;return e.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},e.setOptions=function(t){if(this.hasOwnProperty("options")||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},e.config=function(t){if(!t){var e={};for(var n in this.options)this.options.hasOwnProperty(n)&&(e[n]=this.options[n]);return e}if(2===arguments.length){var i={};i[t]=arguments[1],t=i}for(var r in t)this.options[r]=t[r],this[r]&&this[r]instanceof Nd&&(t[r]?this[r].enable():this[r].disable());return this.onConfig(t),this},e.onConfig=function(){},e._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var n=t._initHooks;if(n&&n!==e._initHooks)for(var i=0;i<n.length;i++)n[i].call(this)}},t.addInitHook=function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];var r="function"==typeof t?t:function(){this[t].apply(this,n)},o=this.prototype,s=Object.getPrototypeOf(o);return o._initHooks&&o._initHooks!==s._initHooks||(o._initHooks=[]),o._initHooks.push(r),this},t.include=function(){for(var t=0;t<arguments.length;t++)gc(this.prototype,t<0||arguments.length<=t?void 0:arguments[t]);return this},t.mergeOptions=function(t){var e=this.prototype,n=Object.getPrototypeOf(e);return e.options&&e.options!==n.options||(e.options=e.options?Object.create(e.options):{}),gc(e.options,t),this},t}(),Hd={},jd=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return au(e,t),e.registerJSONType=function(t){return t?(Hd[t]=this,this):this},e.getJSONClass=function(t){return t?Hd[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in Hd)if(Hd[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered geometry class!");return this._jsonType},e}(t)},zd={},Gd=function(){function t(){this._tree=$l(9,["[0]","[1]","[2]","[3]"])}var e=t.prototype;return e.collides=function(t){return zd.minX=t[0],zd.minY=t[1],zd.maxX=t[2],zd.maxY=t[3],this._tree.collides(zd)},e.insertBox=function(t){return this._tree.insert(t),this},e.bulkInsertBox=function(t){return this._tree.load(t),this},e.clear=function(){return this._tree.clear(),this},t}();function Ud(t){return function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var n=this[t]=new e(this);return this._handlers.push(n),this.options[t]&&n.enable(),this},n.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var n=this._handlers.indexOf(e);n>=0&&this._handlers.splice(n,1),this[t].remove(),delete this[t]}return this},n._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)}var Vd={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},Wd={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},Xd=function(t){function e(e,n){var i;return void 0===n&&(n={}),(i=t.call(this,null)||this).dom=e,i.options=n,i}au(e,t);var n=e.prototype;return n.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},bd(this.dom,"touchstart mousedown",this._onMouseDown,this),this):this},n.disable=function(){return this.dom?(this._offEvents(),wd(this.dom,"touchstart mousedown",this._onMouseDown),delete this._onMouseDown,this):this},n.onMouseDown=function(t){if((this.options.rightclick||2!==t.button)&&!(t.touches&&t.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var e=this.dom;e.setCapture?e.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),e.ondragstart=function(){return!1},delete this.moved;var n=t.touches?t.touches[0]:t;this.startPos=new fu(n.clientX,n.clientY),wd(document,Vd[t.type],this.onMouseMove),wd(document,Wd[t.type],this.onMouseUp),bd(document,Vd[t.type],this.onMouseMove,this),bd(document,Wd[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||(wd(this.dom,"mouseleave",this.onMouseUp),bd(this.dom,"mouseleave",this.onMouseUp,this)),this.fire("mousedown",{domEvent:t,mousePos:new fu(n.clientX,n.clientY)})}},n.onMouseMove=function(t){if(t.touches&&t.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var e=t.touches?t.touches[0]:t,n=new fu(e.clientX,e.clientY).sub(this.startPos);(n.x||n.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new fu(e.clientX,e.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},n.onMouseUp=function(t){var e=t.changedTouches?t.changedTouches[0]:t;this._offEvents();var n={domEvent:t};_c(e.clientX)&&(n.mousePos=new fu(parseInt(e.clientX,0),parseInt(e.clientY,0))),this.moved&&(n.interupted=this.interupted,this.fire("dragend",n),delete this.interupted,delete this.moved),this.fire("mouseup",n)},n._offEvents=function(){var t=this.dom;if(wd(t,"mouseleave",this.onMouseUp),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in Vd)wd(document,Vd[e],this.onMouseMove),wd(document,Wd[e],this.onMouseUp);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP)}},e}(Nd),Zd=function(t){function e(){return t.apply(this,arguments)||this}return au(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?bu(t,(function(t){return[t.x,t.y]})):[t.x,t.y]},e.toCoordinates=function(t){if(_c(t[0])&&_c(t[1]))return new e(t);if(t instanceof e)return t;for(var n=[],i=0,r=t.length;i<r;i++){var o=t[i];Array.isArray(o)?_c(o[0])?n.push(new e(o)):n.push(e.toCoordinates(o)):n.push(o instanceof e?o:new e(o))}return n},e}(uu),qd=function(){function t(t,e){this.type=t,this.properties=e}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();qd.WGS84=qd.createProj4("+proj=longlat +datum=WGS84 +no_defs"),qd.EPSG4326=qd.WGS84,qd.EPSG3857=qd.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),qd.IDENTITY=qd.createProj4("+proj=identity +no_defs"),qd.CGCS2000=qd.createProj4("+proj=longlat +datum=CGCS2000"),qd.EPSG4490=qd.CGCS2000,qd.BD09LL=qd.createProj4("+proj=longlat +datum=BD09"),qd.GCJ02=qd.createProj4("+proj=longlat +datum=GCJ02");var Yd,Kd=new fu(0,0),Jd=new Zd(0,0),Qd=new Zd(0,0),$d=new Zd(0,0),tm=new Zd(0,0),em=new Zd(0,0),nm=new Zd(0,0),im=new Zd(0,0),rm=new Zd(0,0),om=[],sm=[],am=function(){function t(t,e,n,i){this._clazz=Zd;var r=arguments.length,o=r>0?arguments[r-1]:null;o&&o.unproject&&(this.projection=arguments[r-1]),this._dirty=!0,this._initialize(t,e,n,i)}var e=t.prototype;return e._initialize=function(t,e,n,i){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!pc(t)){var r=this.projection;_c(t)&&_c(e)&&_c(n)&&_c(i)?r?this.set(t,e,n,i):this.set(Math.min(t,n),Math.min(e,i),Math.max(t,n),Math.max(e,i)):Array.isArray(t)?r?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3])):_c(t.x)&&_c(e.x)&&_c(t.y)&&_c(e.y)?r?this.set(t.x,t.y,e.x,e.y):(t.x>e.x?(this.xmin=e.x,this.xmax=t.x):(this.xmin=t.x,this.xmax=e.x),t.y>e.y?(this.ymin=e.y,this.ymax=t.y):(this.ymin=t.y,this.ymax=e.y)):_c(t.xmin)&&_c(t.xmax)&&_c(t.ymin)&&_c(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},e._add=function(t){return this._dirty=!0,pc(t.x)?pc(t.xmin)?pc(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},e.add=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._add.apply(t,arguments)},e._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},e._sub=function(t){return this._dirty=!0,pc(t.x)?pc(t.xmin)?pc(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._sub.apply(t,arguments)},e.substract=function(){return this.sub.apply(this,arguments)},e.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},e._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},e.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},e.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},e.getCenter=function(t){var e=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2;return t?(t.set(e,n),t):new this._clazz(e,n)},e.isValid=function(){return!(pc(this.xmin)||pc(this.ymin)||pc(this.xmax)||pc(this.ymax))},e.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},e.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),n=Math.max(this.pymin,t.pymin),i=Math.min(this.pxmax,t.pxmax),r=Math.min(this.pymax,t.pymax);return!(e>i||n>r)},e.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},e.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e)if(void 0!==t.x){var n=Jd;Array.isArray(t)?(n.x=t[0],n.y=t[1]):(n.x=t.x,n.y=t.y),t=e.project(n,n)}else void 0!==t.xmin&&this._project(t);return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},e.getWidth=function(){return Math.abs(this.xmax-this.xmin)},e.getHeight=function(){return Math.abs(this.ymax-this.ymin)},e.getSize=function(){return new Af(this.getWidth(),this.getHeight())},e.set=function(t,e,n,i){return this.xmin=t,this.ymin=e,this.xmax=n,this.ymax=i,this._dirty=!0,this},e.__combine=function(t){var e,n,i,r;void 0!==t.x&&(Yd.xmin=Yd.xmax=t.x,Yd.ymin=Yd.ymax=t.y,t=Yd),this._project(t),this._project(this),_c(this.pxmin)?(e=Math.min(this.pxmin,t.pxmin),n=Math.min(this.pymin,t.pymin),i=Math.max(this.pxmax,t.pxmax),r=Math.max(this.pymax,t.pymax)):(e=t.pxmin,n=t.pymin,i=t.pxmax,r=t.pymax);var o=this.projection;if(o){Qd.set(e,n),$d.set(i,r);var s=o.unproject(Qd,Qd),a=o.unproject($d,$d);e=s.x,n=s.y,i=a.x,r=a.y}return sm[0]=e,sm[1]=n,sm[2]=i,sm[3]=r,sm},e._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},e.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},e.intersection=function(t){if(!this.intersects(t))return null;tm.x=Math.max(this.pxmin,t.pxmin),tm.y=Math.max(this.pymin,t.pymin),em.x=Math.min(this.pxmax,t.pxmax),em.y=Math.min(this.pymax,t.pymax);var e=tm,n=em,i=this.projection;return i&&(e=i.unproject(e,e),n=i.unproject(n,n)),new this.constructor(e,n,i)},e.expand=function(t){var e,n;return _c(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-n,this.xmax+e,this.ymax+n,this.projection)},e._expand=function(t){var e,n;return _c(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=n,this.xmax+=e,this.ymax+=n,this._dirty=!0,this},e.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},e.toArray=function(t){var e=this.xmin,n=this.ymin,i=this.xmax,r=this.ymax;return t?(t[0].x=e,t[0].y=r,t[1].x=i,t[1].y=r,t[2].x=i,t[2].y=n,t[3].x=e,t[3].y=n,t[4].x=e,t[4].y=r,t):[new this._clazz([e,r]),new this._clazz([i,r]),new this._clazz([i,n]),new this._clazz([e,n]),new this._clazz([e,r])]},e.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},e.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},e.convertTo=function(t,e){if(!this.isValid())return null;var n,i=e||new this.constructor;return e&&i.set(null,null,null,null),this._clazz===Zd?n=nm:this._clazz===fu&&(n=Kd),n.x=this.xmin,n.y=this.ymax,i._combine(t(n)),n.x=this.xmax,i._combine(t(n)),n.y=this.ymin,i._combine(t(n)),n.x=this.xmin,i._combine(t(n)),i},e._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){im.set(t.xmax,t.ymin),rm.set(t.xmin,t.ymax),om[0]=im,om[1]=rm;var n=e.projectCoords(om),i=n[0],r=n[1];t.pxmin=Math.min(i.x,r.x),t.pymin=Math.min(i.y,r.y),t.pxmax=Math.max(i.x,r.x),t.pymax=Math.max(i.y,r.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}else t&&(t.pxmin=t.pxmax=t.pymin=t.pymax=null)},t}();Yd=new am(0,0,0,0);var hm,lm=function(t){function e(e,n,i,r){var o;return(o=t.call(this,e,n,i,r)||this)._clazz=fu,o}return au(e,t),e}(am),cm=function(){function t(t){this.matrix=t}var e=t.prototype;return e.transform=function(t,e,n){var i=this.matrix[0]*(t.x-this.matrix[2])/e,r=-this.matrix[1]*(t.y-this.matrix[3])/e;return n?(n.x=i,n.y=r,n):new fu(i,r)},e.untransform=function(t,e,n){var i=t.x*e/this.matrix[0]+this.matrix[2],r=t.y*e/-this.matrix[1]+this.matrix[3];return n?(n.x=i,n.y=r,n):new Zd(i,r)},t}(),um={project:function(){},unproject:function(){},projectCoords:function(t,e){var n=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return bu(t,this.project,this);if(Array.isArray(t[0]))return t.map((function(t){return n.projectCoords(t,e)}));for(var i,r,o,s,a,h,l=!1!==e,c=this.getCircum(),u=this.getSphereExtent(),f=u.sx,d=u.sy,m=t[0],g=[this.project(m)],p=1,_=t.length;p<_;p++)s=(o=t[p]).x-m.x,a=o.y-m.y,h=this.project(o),Math.abs(s)>180&&l&&(void 0===i&&(i=o.x>m.x),i&&(h._add(-c.x*Tu(s)*f,0),o._add(-360*Tu(s),0))),Math.abs(a)>90&&l&&(void 0===r&&(r=o.y<m.y),r&&(h._add(0,-c.y*Tu(a)*d),o._add(0,-180*Tu(a)))),m=o,g.push(h);return g},unprojectCoords:function(t){return t?Array.isArray(t)?bu(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),n=new Zd(t);return e.contains(n)||(n.x=Eu(t.x,e.xmin,e.xmax),n.y=Eu(t.y,e.ymin,e.ymax)),n},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new Zd(180,90)),e=this.project(new Zd(-180,-90));this.extent=new am(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},fm={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var n=0,i=0,r=t.length;i<r-1;i++)n+=this.measureLenBetween(t[i],t[i+1]);return n}},dm=gc({measure:"IDENTITY",measureLenBetween:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(t){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,n=0,i=t.length;n<i;n++){var r=t[n],o=null;e+=r.x*(o=n===i-1?t[0]:t[n+1]).y-r.y*o.x}return Math.abs(e/2)},locate:function(t,e,n,i){return(i=i||new Zd(0,0)).set(t.x,t.y),this._locate(i,e,n)},_locate:function(t,e,n){return t?(e||(e=0),n||(n=0),e||n?(t.x=t.x+e,t.y=t.y+n,t):t):null},rotate:function(t,e,n){return t=new Zd(t.x,t.y),this._rotate(t,e,n)},_rotate:(hm=new fu(0,0),function(t,e,n){return hm.x=t.x-e.x,hm.y=t.y-e.y,hm._rotate(n*Math.PI/180),t.x=e.x+hm.x,t.y=e.y+hm.y,t})},fm),mm=function(){function t(t){this.radius=t}var e=t.prototype;return e.measureLenBetween=function(t,e){if(!t||!e)return 0;var n=Ac(t.y),i=Ac(e.y),r=n-i,o=Ac(t.x)-Ac(e.x);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(o/2),2))),n*=this.radius,Math.round(1e5*n)/1e5},e.measureArea=function(t){var e,n=Ac(this.radius),i=0,r=t,o=r.length;if(o<3)return 0;for(e=0;e<o-1;e++){var s=r[e],a=r[e+1];i+=s.x*n*Math.cos(Ac(s.y))*a.y*n-a.x*n*Math.cos(Ac(a.y))*s.y*n}return o=r[e],r=r[0],i+=o.x*n*Math.cos(Ac(o.y))*r.y*n-r.x*n*Math.cos(Ac(r.y))*o.y*n,.5*Math.abs(i)},e.locate=function(t,e,n,i){return(i=i||new Zd(0,0)).set(t.x,t.y),this._locate(i,e,n)},e._locate=function(t,e,n){if(!t)return null;if(e||(e=0),n||(n=0),!e&&!n)return t;var i,r,o=Ac(t.y);if(0!==n){var s=Math.abs(n);r=Eu(180*(o+=2*Math.sin(s/(2*this.radius))*(n>0?1:-1))/Math.PI,-90,90)}else r=t.y;if(0!==e){var a=Math.abs(e),h=Ac(t.x);i=Eu(180*(h+=2*Math.sqrt(Math.pow(Math.sin(a/(2*this.radius)),2)/Math.pow(Math.cos(o),2))*(e>0?1:-1))/Math.PI,-180,180)}else i=t.x;return t.x=i,t.y=r,t},e.rotate=function(t,e,n){return t=new Zd(t),this._rotate(t,e,n)},e._rotate=function(t,e,n){var i=function(t,e,n){var i;return void 0===n&&(n={}),(i=n.final?gm(e,t):gm(t,e))>180?-(360-i):i}(e,t)-n,r=this.measureLenBetween(e,t);return t.x=e.x,t.y=e.y,function(t,e,n,i){var r=e/i,o=t.x*Math.PI/180,s=Ac(t.y),a=Ac(n),h=r*Math.cos(a),l=s+h;Math.abs(l)>Math.PI/2&&(l=l>0?Math.PI-l:-Math.PI-l);var c=Math.log(Math.tan(l/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),u=Math.abs(c)>1e-11?h/c:Math.cos(s),f=r*Math.sin(a)/u;return t.x=(180*(o+f)/Math.PI+540)%360-180,t.y=180*l/Math.PI,t}(t,r,i,this.radius)},t}();function gm(t,e){var n=Ac(t.y),i=Ac(e.y),r=Ac(e.x-t.x);r>Math.PI&&(r-=2*Math.PI),r<-Math.PI&&(r+=2*Math.PI);var o=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(n/2+Math.PI/4));return(Ec(Math.atan2(r,o))+360)%360}var pm=gc({measure:"EPSG:4326",sphere:new mm(6378137),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},fm),_m=gc({measure:"BAIDU",sphere:new mm(6370996.81),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},fm),vm=pm,ym={};function xm(t){ym[t.measure]=t}xm(dm),xm(pm),xm(_m);var bm,wm={getInstance:function(t){if(!t)return vm;for(var e in ym)if(Tc(ym,e)){var n=ym[e].measure;if(!n)continue;if(t.toLowerCase()===n.toLowerCase())return ym[e]}return null}},Tm=gc({},um,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t,e){var n=this.rad,i=this.metersPerDegree,r=this.maxLatitude,o=t.x,s=Math.max(Math.min(r,t.y),-r),a=o*i,h=(0===s?0:Math.log(Math.tan((90+s)*n/2))/n)*i;return e?(e.x=a,e.y=h,e):new Zd(a,h)},unproject:function(t,e){var n,i=this.rad,r=this.metersPerDegree,o=t.x/r,s=t.y;0===s?n=0:(n=s/r,n=(2*Math.atan(Math.exp(n*i))-Math.PI/2)/i),Math.abs(Math.abs(o)-180)<1e-7&&(o=180*Tu(o)),Math.abs(Math.abs(n)-this.maxLatitude)<1e-7&&(n=Tu(n)*this.maxLatitude);var a=Eu(o,-180,180),h=Eu(n,-this.maxLatitude,this.maxLatitude);return e?(e.x=a,e.y=h,e):new Zd(a,h)}},pm),Mm=gc({},um,{code:"EPSG:4326",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new Zd(t)},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new Zd(t)}},pm),Am=gc({},Mm,{code:"EPSG:4490"}),Em=gc({},um,{code:"BAIDU",project:function(t,e){return this.convertLL2MC(t,e)},unproject:function(t,e){return this.convertMC2LL(t,e)}},_m,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t,e){for(var n,i=0,r=this.MCBAND.length;i<r;i++)if(Math.abs(t.y)>=this.MCBAND[i]){n=this.MC2LL[i];break}return this.convertor(t,n,e)},convertLL2MC:function(t,e){var n,i,r;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var o=new Zd(t.x,t.y);for(i=0,r=this.LLBAND.length;i<r;i++)if(o.y>=this.LLBAND[i]){n=this.LL2MC[i];break}if(!n)for(i=this.LLBAND.length-1;i>=0;i--)if(o.y<=-this.LLBAND[i]){n=this.LL2MC[i];break}return this.convertor(t,n,e)},convertor:function(t,e,n){if(!t||!e)return null;var i=e[0]+e[1]*Math.abs(t.x),r=Math.abs(t.y)/e[9],o=e[2]+e[3]*r+e[4]*r*r+e[5]*r*r*r+e[6]*r*r*r*r+e[7]*r*r*r*r*r+e[8]*r*r*r*r*r*r;return i*=t.x<0?-1:1,o*=t.y<0?-1:1,n?(n.x=i,n.y=o,n):new Zd(i,o)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,n){return null!=e&&(t=Math.max(t,e)),null!=n&&(t=Math.min(t,n)),t},getLoop:function(t,e,n){if(t===1/0)return n;if(t===-1/0)return e;for(;t>n;)t-=n-e;for(;t<e;)t+=n-e;return t}}),Cm=gc({},um,{code:"IDENTITY",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()}},dm),Sm=Tm,Pm=Object.freeze({EPSG3857:Tm,DEFAULT:Sm,EPSG4326:Mm,EPSG4490:Am,BAIDU:Em,IDENTITY:Cm,Common:um}),Rm=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return au(e,t),e.registerRenderer=function(t,e){var n=this.prototype,i=Object.getPrototypeOf(n);return n._rendererClasses&&n._rendererClasses!==i._rendererClasses||(n._rendererClasses=n._rendererClasses?Object.create(n._rendererClasses):{}),n._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)},Om={};function Im(){if("undefined"==typeof window)return null;if(!bm){var t=function(){var t="\n    var adapters = {};\n    onmessage = function (msg) {\n        msg = msg.data;\n        if (msg.messageType === 'batch') {\n            const messages = msg.messages;\n            if (messages) {\n                for (let i = 0; i < messages.length; i++) {\n                    dispatch(messages[i]);\n                }\n            }\n        } else {\n            dispatch(msg);\n        }\n    };\n\n    function dispatch(msg) {\n        var workerKey = msg.workerKey;\n        var adapter = adapters[workerKey];\n        if (!adapter) {\n            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);\n            return;\n        }\n        try {\n            adapter.onmessage(msg, wrap(msg.callback));\n        } catch (err) {\n            post(msg.callback, workerKey + ':' + err.message);\n            console.error(err);\n            throw err;\n        }\n    }\n\n    function post(callback, err, data, buffers) {\n        var msg = {\n            callback : callback\n        };\n        if (err) {\n            msg.error = err;\n        } else {\n            msg.data = data;\n        }\n        if (buffers && buffers.length > 0) {\n            postMessage(msg, buffers);\n        } else {\n            postMessage(msg);\n        }\n    }\n    function wrap(callback) {\n        return function (err, data, buffers) {\n            post(callback, err, data, buffers);\n        };\n    }\n    var workerExports;\n";for(var e in Om){var n=Om[e];bc(n)&&0===n.length&&(n=n()),t+="\n    workerExports = {};\n    ("+n+")(workerExports, self);\n    adapters['"+e+"'] = workerExports",t+="\n    workerExports.initialize && workerExports.initialize(self);\n        "}return t+"\n    workerExports = null;\n"}();bm=window.URL.createObjectURL(new Blob([t],{type:"text/javascript"})),Om=null}return bm}var Dm,km="undefined"!=typeof window?window.navigator.hardwareConcurrency||4:0,Lm=Math.max(Math.floor(km/2),1),Fm=function(){function t(t){void 0===t&&(t=50),this._limit=t,this._messages=[],this.buffers=[]}var e=t.prototype;return e.addMessage=function(t,e){if(this._messages.push(t),Array.isArray(e))for(var n=0;n<e.length;n++)this.buffers.indexOf(e[n])<0&&this.buffers.push(e[n])},e.isFull=function(){return this._messages.length>=this._limit},e.getMessage=function(){return{messageType:"batch",messages:this._messages}},t}(),Nm=function(){function t(){this.active={},this.workerCount="undefined"!=typeof window?window.MAPTALKS_WORKER_COUNT||Lm:0,this._messages=[],this._messageBuffers=[]}var e=t.prototype;return e.acquire=function(t){if(!this.workers){this.workers=[];for(var e=Im(),n=0;n<this.workerCount;n++){var i=new Worker(e);i.id=n,this.workers.push(i)}URL.revokeObjectURL(e)}return this.active[t]=!0,this.workers.slice()},e.release=function(t){delete this.active[t],0===Object.keys(this.active).length&&(this.workers.forEach((function(t){t.terminate()})),this.workers=null)},e.addMessage=function(t,e,n){var i=this._messages[t];i&&i.length||(i=this._messages[t]=[new Fm]);var r=i[i.length-1];r.isFull()&&(r=new Fm,this._messages[t].push(r)),r.addMessage(e,n)},e.commit=function(){if(this._messages.length)for(var t=0;t<this._messages.length;t++)if(this._messages[t]&&this._messages[t].length){var e=this._messages[t].shift();this.workers[t].postMessage(e.getMessage(),e.buffers)}},t}();function Bm(){return Dm||(Dm=new Nm),Dm}lu&&lu((function t(){Bm().commit(),lu(t)}));var Hm=0,jm=[],zm=function(){function t(t){var e=this;this.workerKey=t,this.workerPool=Bm(),this.currentActor=0,this.actorId=pu(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach((function(t){t.addEventListener("message",e.receiveFn,!1)}))}var e=t.prototype;return e.isActive=function(){return!!this.workers},e.broadcast=function(t,e,n){var i=this;return function(t,e,n){t.length||n(null,[]);var i=t.length,r=new Array(t.length),o=null;t.forEach((function(t,s){e(t,(function(t,e){t&&(o=t),r[s]=e,0==--i&&n(o,r)}))}))}(this.workers,(function(n,r){i.send(t,e,r,n.id)}),n=n||function(){}),this},e.send=function(t,e,n,i){var r=n?this.actorId+":"+this.callbackID++:null;return n&&(this.callbacks[r]=n),this.post({data:t,callback:String(r)},e,i),this},e.receive=function(t){var e=this,n=t.data,i=n.callback,r=this.callbacks[i];delete this.callbacks[i],"<request>"===n.type?this.actorId===n.actorId&&this[n.command](n.params,(function(t,i,r){var o={type:"<response>",callback:n.callback};t?o.error=t.message:o.data=i,e.post(o,r||jm,n.workerId)})):r&&n.error?r(n.error):r&&r(null,n.data)},e.remove=function(){var t=this;this.workers.forEach((function(e){e.removeEventListener("message",t.receiveFn,!1)})),this.workerPool.release(this.actorId),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},e.post=function(t,e,n){return("number"!=typeof n||isNaN(n))&&(n=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),t.workerId=n,t.workerKey=this.workerKey,t.actorId=this.actorId,this.workerPool.addMessage(n,t,e||jm),n},e.getDedicatedWorker=function(){return Hm=(Hm+1)%this.workerPool.workerCount},t}(),Gm=[],Um=function(t){function e(){return t.call(this,"core-fetch-image")||this}return au(e,t),e.prototype.fetchImage=function(t,e){this.send({url:t},Gm,e)},e}(zm),Vm=function(t){function e(e){var n;return(n=t.call(this)||this).layer=e,n._painted=!1,n._drawTime=0,!su.decodeImageInWorker||"gl"!==e.options.renderer&&su.safari||(n._resWorkerConn=new Um),n.setToRedraw(),n}au(e,t);var n=e.prototype;return n.render=function(t){this.prepareRender(),this.getMap()&&this.layer.isVisible()&&(this.resources||(this.resources=new Wm),this.checkAndDraw(this._tryToDraw,t))},n.checkAndDraw=function(t){var e=this;this._toRedraw=!1;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];if(this.checkResources){var o=this.checkResources();o.length>0?(this._loadingResource=!0,this.loadResources(o).then((function(){e._loadingResource=!1,e.layer&&(e.layer.fire("resourceload"),e.setToRedraw())}))):t.call.apply(t,[this].concat(i))}else t.call.apply(t,[this].concat(i))},n.testIfNeedRedraw=function(){var t=this.getMap();return!(this._loadingResource||!this._toRedraw&&(t.isInteracting()&&!this.drawOnInteracting||!this.needToRedraw()))},n.needToRedraw=function(){var t=this.getMap();return!(!t.isInteracting()&&!t.getRenderer().isViewChanged()||!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},n.onSkipDrawOnInteracting=function(){},n.isLoadingResource=function(){return this._loadingResource},n.isRenderComplete=function(){return!!this._renderComplete},n.mustRenderOnInteracting=function(){return!this._painted},n.setToRedraw=function(){return this._toRedraw=!0,this},n.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},n.isCanvasUpdated=function(){return!!this._canvasUpdated},n.remove=function(){this.onRemove(),delete this._loadingResource,delete this.southWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,this.resources&&this.resources.remove(),delete this.resources,delete this.layer},n.onRemove=function(){},n.onAdd=function(){},n.getMap=function(){return this.layer?this.layer.getMap():null},n.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.southWest)._add(0,-t.height);return{image:this.canvas,layer:this.layer,point:e}},n.clear=function(){this.clearCanvas()},n.isBlank=function(){return!this._painted},n.show=function(){this.setToRedraw()},n.hide=function(){this.clear(),this.setToRedraw()},n.setZIndex=function(){this.setToRedraw()},n.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown||this.layer.isVisible&&!this.layer.isVisible())return!1;var e=this.getMap(),n=e.getDevicePixelRatio(),i=e.getSize();if(t.x<0||t.x>i.width*n||t.y<0||t.y>i.height*n)return!1;var r=this.getImageData&&this.getImageData();if(r){var o=Math.round(n*t.x),s=Math.round(n*t.y);return r.data[s*r.width*4+4*o+3]>0}try{if(this.context.getImageData(n*t.x,n*t.y,1,1).data[3]>0)return!0}catch(t){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t),this._errorThrown=!0),!1}return!1},n.loadResources=function(t){this.resources||(this.resources=new Wm);var e=this.resources,n=[];if(Su(t))for(var i={},r=t.length-1;r>=0;r--){var o=t[r];o&&o.length&&!i[o.join("-")]&&(i[o.join("-")]=1,e.isResourceLoaded(o,!0)||n.push(new Ld(this._promiseResource(o))))}return Ld.all(n)},n.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t._get2DExtent(),this.southWest=t._containerPointToPoint(new fu(0,t.height))},n.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),n=t.getDevicePixelRatio(),i=Math.round(n*e.width),r=Math.round(n*e.height);if(this.layer._canvas){var o=this.layer._canvas;o.width=i,o.height=r,o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=Od.createCanvas(i,r,t.CanvasClass);this.onCanvasCreate()}},n.onCanvasCreate=function(){},n.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=this.canvas.getContext("2d"),this.context)){this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var t=this.getMap().getDevicePixelRatio();1!==t&&this.context.scale(t,t)}},n.resetCanvasTransform=function(){if(this.context){var t=this.getMap().getDevicePixelRatio();this.context.setTransform(t,0,0,t,0,0)}},n.resizeCanvas=function(t){var e=this.canvas;if(e){var n=t||this.getMap().getSize(),i=this.getMap().getDevicePixelRatio(),r=Zu(n,i),o=r.width,s=r.height,a=r.cssWidth,h=r.cssHeight;!this.layer._canvas||e.style.width===a&&e.style.height===h||(e.style.width=a,e.style.height=h),e.width===o&&e.height===s||(e.height=s,e.width=o,1!==i&&this.context&&this.context.scale(i,i))}},n.clearCanvas=function(){if(this.context&&this.getMap()){var t=1/this.getMap().getDevicePixelRatio(),e=this.canvas.height*t;Od.clearRect(this.context,0,0,Math.max(this.canvas.width*t,this.canvas.width),Math.max(e,this.canvas.height))}},n.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getMaskPainter().get2DExtent();return e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},n.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;var n=this.southWest,i=this.getMap();this.southWest=i._containerPointToPoint(new fu(0,i.height)),t.save();var r=i.getDevicePixelRatio();if(1!==r&&(t.save(),t.scale(r,r)),e.getGeometries){t.isMultiClip=!0;var o=e.getGeometries()||[];t.beginPath(),o.forEach((function(e){e._getMaskPainter().paint(null,t)})),t.stroke(),delete t.isMultiClip}else e._getMaskPainter().paint(null,t);return 1!==r&&t.restore(),t.clip(),this.southWest=n,!0},n.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,southWest:this.southWest}},n.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},n.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},n.onZoomStart=function(){},n.onZoomEnd=function(){this.setToRedraw()},n.onZooming=function(){},n.onMoveStart=function(){},n.onMoving=function(){},n.onMoveEnd=function(){this.setToRedraw()},n.onResize=function(){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},n.onDragRotateStart=function(){},n.onDragRotating=function(){},n.onDragRotateEnd=function(){this.setToRedraw()},n.onSpatialReferenceChange=function(){},n.getDrawTime=function(){return this._drawTime},n._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},n._drawAndRecord=function(t){if(this.getMap()){var e=this._painted;this._painted=!0;var n=mc();this.draw(t),n=mc()-n,this._drawTime=e?n:n/2,e&&this.layer&&this.layer.options.logDrawTime&&console.log(this.layer.getId(),"frameTimeStamp:",t,"drawTime:",this._drawTime)}},n._promiseResource=function(t){var e=this,n=this.resources,i=this.layer.options.crossOrigin,r=this.layer.options.renderer||"";return function(o){if(n.isResourceLoaded(t,!0))o(t);else if(!du(t[0])&&e._resWorkerConn){var s=Wu(t[0]);e._resWorkerConn.fetchImage(s,(function(n,i){if(n)return n&&"undefined"!=typeof console&&console.warn(n),void o(t);Vu(i,(function(n){e._cacheResource(t,n),o(t)}))}))}else{var a=new Image;pc(i)?"canvas"!==r&&(a.crossOrigin=""):a.crossOrigin=i,du(t[0])&&!Cc&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),a.onload=function(){e._cacheResource(t,a),o(t)},a.onabort=function(e){console&&console.warn("image loading aborted: "+t[0]),e&&console&&console.warn(e),o(t)},a.onerror=function(e){e&&"undefined"!=typeof console&&console.warn(e),n.markErrorResource(t),o(t)},mu(a,t)}}},n._cacheResource=function(t,e){if(this.layer&&this.resources){var n=t[1],i=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===du(t[0])&&(su.edge||su.ie)){pc(n)&&(n=e.width||this.layer.options.defaultIconSize[0]),pc(i)&&(i=e.height||this.layer.options.defaultIconSize[1]);var r=Od.createCanvas(n,i);Od.image(r.getContext("2d"),e,0,0,n,i),e=r}this.resources.addResource(t,e)}},e}(Bd),Wm=function(){function t(){this.resources={},this._errors={}}var e=t.prototype;return e.addResource=function(t,e){var n=this;if(this.resources[t[0]]={image:e,width:+t[1],height:+t[2],refCnt:0},e&&!e.close&&su.imageBitMap&&!su.safari){if(e.src&&du(e.src))return;createImageBitmap(e).then((function(e){n.resources[t[0]]&&(n.resources[t[0]].image=e)}))}},e.isResourceLoaded=function(t,e){if(!t)return!1;var n=this._getImgUrl(t);if(this._errors[n])return!0;var i=this.resources[n];return!(!i||e&&du(t[0])&&(+t[1]>i.width||+t[2]>i.height))},e.login=function(t){var e=this.resources[t];e&&e.refCnt++},e.logout=function(t){var e=this.resources[t];e&&e.refCnt--<=0&&delete this.resources[t]},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},e.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},e.merge=function(t){if(!t)return this;for(var e in t.resources){var n=t.resources[e];this.addResource([e,n.width,n.height],n.image)}return this},e.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)Tc(this.resources,e)&&t(e,this.resources[e]);return this},e._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},e.remove=function(){for(var t in this.resources){var e=this.resources[t];e&&e.image&&e.image.close&&e.image.close()}this.resources={}},t}(),Xm=10,Zm=10,qm=1,Ym=new fu(0,0);function Km(t,e,n,i,r,o,s){var a,h,l=Ym.set(e,n),c=t.set(l.x,l.y,l.x+o,l.y+s);return c._add(r),i&&(h=i,rg.set((a=c).xmin,a.ymin,a.xmax,a.ymax),rg.convertTo((function(t){return t._rotate(h)}),a)),c}var Jm=[];function Qm(t,e,n){var i=ng(e,(n=n||ig(Jm,e))[0],n[1]);return Km(t,e.markerDx||0,e.markerDy||0,og(e),i,n[0],n[1])}function $m(t){return"rectangle"===t?"right":"middle"}function tg(t){return"bar"===t||"pie"===t||"pin"===t?"top":"rectangle"===t?"bottom":"middle"}var eg=new Af(0,0);function ng(t,e,n){var i=2*(t.shadowBlur||0)+.5;eg.width=e,eg.height=n;var r=t.markerType,o=Nf(eg,t.markerHorizontalAlignment||$m(r),t.markerVerticalAlignment||tg(r));return o.x!==-e/2&&(o.x-=Tu(o.x+e/2)*i),o.y!==-n/2&&(o.y-=Tu(o.y+n/2)*i),o}function ig(t,e){var n=wu(e.markerWidth,Xm),i=wu(e.markerHeight,Zm),r=wu(e.markerLineWidth,qm),o=2*((e.shadowBlur||0)+Math.max(Math.abs(e.shadowOffsetX||0)+Math.abs(e.shadowOffsetY||0))),s=Math.round(n+r+o+1),a=Math.round(i+r+o+1);return t[0]=s,t[1]=a,t}var rg=new lm;function og(t,e){void 0===e&&(e="markerRotation");var n=t[e];return _c(n)?-n*Math.PI/180:0}function sg(t,e,n){var i=n?n.getImage(e.markerFile):null,r=e.markerWidth||(i?i.width:0),o=e.markerHeight||(i?i.height:0);eg.width=r,eg.height=o;var s=Nf(eg,e.markerHorizontalAlignment||"middle",e.markerVerticalAlignment||"top");return Km(t,e.markerDx||0,e.markerDy||0,og(e),s,r,o)}function ag(t,e,n){var i=n.size,r=Nf(i,e.textHorizontalAlignment,e.textVerticalAlignment);if(e.textHaloRadius){var o=e.textHaloRadius;i=i.add(2*o,2*o)}return Km(t,e.textDx||0,e.textDy||0,og(e,"textRotation"),r,i.width,i.height)}var hg=new lm;function lg(t,e,n,i){var r=t||new lm;if(Array.isArray(e)){for(var o=e,s=0;s<o.length;s++)lg(r,o[s],n,i[s]);return r}return cg(e)&&r._combine(ag(hg,e,i)),ug(e)&&r._combine(sg(hg,e,n)),fg(e)&&r._combine(Qm(hg,e)),dg(e)&&r._combine(sg(hg,e)),r}function cg(t){return!!t&&!pc(t.textName)}function ug(t){return!!t&&!pc(t.markerFile)}function fg(t){return!!t&&!(!pc(t.markerFile)||pc(t.markerType)||"path"===t.markerType)}function dg(t){return!!t&&!(!pc(t.markerFile)||"path"!==t.markerType)}var mg,gg=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation"],pg=["textName","markerType","markerFile","textHaloRadius","shadowBlur","shadowOffsetX","shadowOffsetY"];function _g(t,e,n,i){for(var r,o=[],s=0,a=0,h=t.length;a<h-1;a++)(r=vg(t[a],t[a+1],e,a,n,i))&&(o[s]=o[s]||[],o[s].push({point:r[0],index:a}),r[1]===t[a+1]&&a!==h-2||(o[s].push({point:r[1],index:a+1}),s++));return o}function vg(t,e,n,i,r,o){var s,a,h,l=i?mg:bg(t,n),c=bg(e,n);for(mg=c;;){if(!(l|c))return[t,e];if(l&c)return!1;if(o)return[t,e];h=bg(a=xg(t,e,s=l||c,n,r),n),s===l?(t=a,l=h):(e=a,c=h)}}function yg(t,e,n){var i,r,o,s,a,h,l,c,u,f=[1,4,2,8];for(r=0,l=t.length;r<l;r++)t[r]._code=bg(t[r],e);for(s=0;s<4;s++){for(c=f[s],i=[],r=0,o=(l=t.length)-1;r<l;o=r++)h=t[o],(a=t[r])._code&c?h._code&c||((u=xg(h,a,c,e,n))._code=bg(u,e),i.push(u)):(h._code&c&&((u=xg(h,a,c,e,n))._code=bg(u,e),i.push(u)),i.push(a));t=i}return t}function xg(t,e,n,i,r){var o,s,a=e.x-t.x,h=e.y-t.y,l=i.getMin(),c=i.getMax();8&n?(o=t.x+a*(c.y-t.y)/h,s=c.y):4&n?(o=t.x+a*(l.y-t.y)/h,s=l.y):2&n?(o=c.x,s=t.y+h*(c.x-t.x)/a):1&n&&(o=l.x,s=t.y+h*(l.x-t.x)/a);var u=new fu(o,s);return r&&u._round(),u}function bg(t,e){var n=0;return t.x<e.getMin().x?n|=1:t.x>e.getMax().x&&(n|=2),t.y<e.getMin().y?n|=4:t.y>e.getMax().y&&(n|=8),n}function wg(t,e,n,i){t=new fu(t);var r,o,s,a=Math.abs(n.x-e.x),h=Math.abs(n.y-e.y),l=Math.sqrt(Math.abs(a*a-h*h));return a>=h?(r=new fu(e.x-l,e.y),o=new fu(e.x+l,e.y),s=2*a):(r=new fu(e.x,e.y-l),o=new fu(e.x,e.y+l),s=2*h),t.distanceTo(r)+t.distanceTo(o)<=s+2*i}var Tg=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n._prepareContext=function(t){if($u(this.symbol.opacity)?this._opacityFn||(this._opacityFn=ef(this.symbol.opacity)):delete this._opacityFn,_c(this.symbol.opacity))t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var e=this.getMap();t.globalAlpha=this._opacityFn(e.getZoom())}else 1!==t.globalAlpha&&(t.globalAlpha=1)},n.prepareCanvas=function(t,e,n){t.setLineDash&&Su(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var i=this.getPainter().isHitTesting();Od.prepareCanvas(t,e,n,i)},n.remove=function(){},n.setZIndex=function(){},n.show=function(){},n.hide=function(){},n._defineStyle=function(t){return yf(t,this.geometry)},e}(function(){function t(){}var e=t.prototype;return e.getMap=function(){return this.geometry.getMap()},e.getPainter=function(){return this.painter},e.isDynamicSize=function(){return!1},t.testColor=function(t){return!(!t||!xc(t))&&dc.indexOf(t)>=0},t}());function Mg(t,e,n,i){var r,o=Ag(n),s=n,a=s.markerType.toLowerCase(),h=Eg(a,s.markerWidth,s.markerHeight),l=o.lineOpacity,c=o.polygonOpacity;zf(o.polygonFill)&&zf(o.polygonFill)&&(r||(r=function(t,e,n){var i=new lm;return i._combine(t),i.xmin+=-e/2,i.ymin+=-n/2,i.xmax+=e/2,i.ymax+=n/2,i}(e,s.markerWidth,s.markerHeight)),o.polygonGradientExtent=r),Od.prepareCanvas(t,o,i);var u=s.markerWidth,f=s.markerHeight,d=s.markerLineWidth/2;if("ellipse"===a)Od.ellipse(t,e,u/2,f/2,f/2,l,c);else if("cross"===a||"x"===a){for(var m=h.length-1;m>=0;m--)h[m]._add(e);Od.path(t,h.slice(0,2),l),Od.path(t,h.slice(2,4),l)}else if("diamond"===a||"bar"===a||"square"===a||"rectangle"===a||"triangle"===a){"bar"===a?e=e.add(0,-d):"rectangle"===a&&(e=e.add(d,d));for(var g=h.length-1;g>=0;g--)h[g]._add(e);Od.polygon(t,h,l,c)}else if("pin"===a){e=e.add(0,-d);for(var p=h.length-1;p>=0;p--)h[p]._add(e);var _=t.lineCap;t.lineCap="round",Od.bezierCurveAndFill(t,h,l,c),t.lineCap=_}else{if("pie"!==a)throw new Error("unsupported markerType: "+a);e=e.add(0,-d);var v=180*Math.atan(u/2/f)/Math.PI,y=t.lineCap;t.lineCap="round",Od.sector(t,e,f,[90-v,90+v],l,c),t.lineCap=y}return t.canvas}function Ag(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e}function Eg(t,e,n){var i,r,o,s,a=n/2,h=e/2;if("triangle"===t)return[i=new fu(0,0-a),r=new fu(0-h,0+a),o=new fu(0+h,0+a)];if("cross"===t)return[i=new fu(0-h,0),r=new fu(0+h,0),o=new fu(0,0-a),s=new fu(0,0+a)];if("diamond"===t)return[i=new fu(0-h,0),r=new fu(0,0-a),o=new fu(0+h,0),s=new fu(0,0+a)];if("square"===t)return[i=new fu(0-h,0+a),r=new fu(0+h,0+a),o=new fu(0+h,0-a),s=new fu(0-h,0-a)];if("rectangle"===t)return r=(i=new fu(0,0)).add(e,0),o=i.add(e,n),s=i.add(0,n),[i,r,o,s];if("x"===t)return[i=new fu(0-h,0+a),r=new fu(0+h,0-a),o=new fu(0+h,0+a),s=new fu(0-h,0-a)];if("bar"===t)return[i=new fu(0-h,0-n),r=new fu(0+h,0-n),o=new fu(0+h,0),s=new fu(0-h,0)];if("pin"===t||"pie"===t){var l=n*Math.atan(h/a);return[i=new fu(0,0),r=new fu(0-l,0-n),o=new fu(0+l,0-n),s=new fu(0,0)]}return[]}var Cg,Sg=new fu(0,0),Pg=new fu(0,0),Rg=new fu(0,0),Og=new fu(0,0),Ig=function(t){function e(e,n,i){var r;return(r=t.call(this)||this).symbol=e,r.geometry=n,r.painter=i,r}au(e,t);var n=e.prototype;return n.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLRes(),n=new lm,i=this._getRenderPoints()[0],r=i.length-1;r>=0;r--)i[r]&&n._combine(t._pointAtResToPoint(i[r],e));return n},n.isDynamicSize=function(){var t=this.symbol;return $u(t.markerWidth)||$u(t.markerHeight)||$u(t.textSize)},n._rotateExtent=function(t,e){return t.convertTo((function(t){return t._rotate(e)}))},n._getRenderPoints=function(){var t=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(t)},n._getRenderContainerPoints=function(t){var e=this.getPainter();if(e.isSpriting())return this._getRenderPoints()[0];var n,i=this.geometry,r=this.getDxDy();if(i._cPoint&&!t){var o=t?Rg:Og;o.set(i._cPoint.x,i._cPoint.y),o._sub(e.containerOffset);var s=r.x,a=r.y;(s||a)&&o._add(s||0,a||0),n=[o]}else{var h=this._getRenderPoints()[0];n=this.painter._pointContainerPoints(h,r.x,r.y,t,!0,this.getPlacement())}if(!n||!Array.isArray(n[0]))return n;for(var l=[],c=0,u=n.length;c<u;c++)for(var f=0,d=n[c].length;f<d;f++)l.push(n[c][f]);return l},n.getPlacement=function(){return this.symbol.markerPlacement},n.getRotation=function(){return og(this.style)},n.getDxDy=function(){var t=this.style;return new fu(t.markerDx,t.markerDy)},n._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var n=this._getRenderPoints()[1];if(!n||!n[t])return e;var i=this.getMap(),r=n[t][0],o=n[t][1];if(i.isTransforming()){var s=i.getGLRes();return r=i._pointAtResToContainerPoint(n[t][0],s,0,Sg),o=i._pointAtResToContainerPoint(n[t][1],s,0,Pg),e+Fu(r.x,r.y,o.x,o.y)}return e+-Fu(r.x,r.y,o.x,o.y)},n._rotate=function(t,e,n){if(n){var i=this.getDxDy(),r=e.sub(i);return t.save(),t.translate(r.x,r.y),t.rotate(n),i}return null},e}(Tg),Dg=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.getPlacement=function(){return"point"},n.getDxDy=function(){return new fu(0,0)},n.symbolize=function(t){var e=this.geometry,n=e.getLayer();if(e.options.debug||!n||n.options.debug){var i=this.getMap();if(i&&!i.isZooming()){var r=n.options.debugOutline;t.strokeStyle=r,t.fillStyle=r;var o=e.getContainerExtent().toArray();Od.polygon(t,[o],1,0);for(var s=this._getRenderContainerPoints(),a=this.geometry.getId(),h=Eg("cross",10,10),l=0;l<s.length;l++){var c=s[l];pc(a)||Od.fillText(t,a,c.add(8,-4),r);for(var u=[],f=0;f<h.length;f++)u.push(h[f].add(c));Od.path(t,u.slice(0,2),1),Od.path(t,u.slice(2,4),1)}}}},e}(Ig),kg=new Af(1,1),Lg=function(t){function e(e,n,i){var r;return(r=t.call(this,e,n,i)||this).style=r._defineStyle(r.translate()),r}au(e,t),e.test=function(t){return ug(t)};var n=e.prototype;return n.symbolize=function(t,e){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&0!==n.markerOpacity){var i=this._getRenderContainerPoints();if(Su(i)){var r=this._getImage(e);if(r){this._prepareContext(t);var o,s=n.markerWidth,a=n.markerHeight;if(!_c(s)||!_c(a)){a=r.height,n.markerWidth=s=r.width,n.markerHeight=a;var h=n.markerFile;e.isResourceLoaded(h)||e.addResource(h,r);var l=this.getPainter();l.isSpriting()||l.removeCache()}"path"!==this.symbol.markerType&&_c(n.markerOpacity)&&n.markerOpacity<1&&(o=t.globalAlpha,t.globalAlpha*=n.markerOpacity),kg.width=s,kg.height=a;for(var c=Nf(kg,n.markerHorizontalAlignment,n.markerVerticalAlignment),u=0,f=i.length;u<f;u++){var d=i[u],m=this.getRotation()?this._rotate(t,d,this._getRotationAt(u)):null;m&&(d=m),Od.image(t,r,d.x+c.x,d.y+c.y,s,a),m&&t.restore()}void 0!==o&&(t.globalAlpha=o)}else"undefined"!=typeof console&&console.warn("no img found for "+(this.style.markerFile||this._url[0]))}}},n._getImage=function(t){return function(t,e){return t&&t.getImage(e)||null}(t,this.style.markerFile)},n.getFixedExtent=function(t){return this._fixedExtent=this._fixedExtent||new lm,sg(this._fixedExtent,this.style,t)},n.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:wu(t.markerOpacity,1),markerWidth:wu(t.markerWidth,null),markerHeight:wu(t.markerHeight,null),markerRotation:wu(t.markerRotation,0),markerDx:wu(t.markerDx,0),markerDy:wu(t.markerDy,0),markerHorizontalAlignment:wu(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:wu(t.markerVerticalAlignment,"top")}},e}(Ig),Fg=new Zd(0,0),Ng=new Zd(0,0),Bg=function(t){function e(e,n,i){var r;return(r=t.call(this)||this).symbol=e,r.geometry=n,r.painter=i,"Point"===n.type?hu(r):(r.style=r._defineStyle(r.translate()),r)}au(e,t),e.test=function(t,e){if(!t)return!1;if(e&&"Point"===e.type)return!1;for(var n in t){var i=n.slice(0,4);if("line"===i||"poly"===i)return!0}return!1};var n=e.prototype;return n.symbolize=function(t,e){var n=this.style;if(0!==n.polygonOpacity||0!==n.lineOpacity||this.painter.isHitTesting()){var i=this._getPaintParams();if(i){this._prepareContext(t);var r=zf(n.lineColor),o="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!r||!n.lineColor.places&&o||(n.lineGradientExtent=this.geometry.getContainerExtent()._expand(n.lineWidth)),zf(n.polygonFill)&&(n.polygonGradientExtent=this.geometry.getContainerExtent());var s=i[0];if("Polygon"===this.geometry.getJSONType()&&s.length>0&&Array.isArray(s[0][0])||"LineString"===this.geometry.type&&s.length>0&&Array.isArray(s[0]))for(var a=0;a<s.length;a++){this.prepareCanvas(t,n,e),r&&o&&!n.lineColor.places&&this._createGradient(t,s[a],n.lineColor);var h=[t,s[a]];i.length>1&&h.push.apply(h,i.slice(1)),h.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),this.geometry._paintOn.apply(this.geometry,h)}else{this.prepareCanvas(t,n,e),r&&o&&!n.lineColor.places&&this._createGradient(t,s,n.lineColor);var l=[t];l.push.apply(l,i),l.push(n.lineOpacity,n.polygonOpacity,n.lineDasharray),this.geometry._paintOn.apply(this.geometry,l)}t.setLineDash&&Array.isArray(n.lineDasharray)&&t.setLineDash([])}}},n.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new Zd(0,0),this._extMax=new Zd(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var n=t._prjToPoint(this._extMin,void 0,Fg),i=t._prjToPoint(this._extMax,void 0,Ng);return this._pxExtent?this._pxExtent.set(Math.min(n.x,i.x),Math.min(n.y,i.y),Math.max(n.x,i.x),Math.max(n.y,i.y)):this._pxExtent=new lm(n,i),this._pxExtent},n.getFixedExtent=function(){var t=this.style.lineWidth/2;return new lm(-t,-t,t,t)},n._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},n.translate=function(){var t=this.symbol,e={lineColor:wu(t.lineColor,"#000"),lineWidth:wu(t.lineWidth,2),lineOpacity:wu(t.lineOpacity,1),lineDasharray:wu(t.lineDasharray,[]),lineCap:wu(t.lineCap,"butt"),lineJoin:wu(t.lineJoin,"miter"),linePatternFile:wu(t.linePatternFile,null),lineDx:wu(t.lineDx,0),lineDy:wu(t.lineDy,0),polygonFill:wu(t.polygonFill,null),polygonOpacity:wu(t.polygonOpacity,1),polygonPatternFile:wu(t.polygonPatternFile,null),polygonPatternDx:wu(t.polygonPatternDx,0),polygonPatternDy:wu(t.polygonPatternDy,0),linePatternDx:wu(t.linePatternDx,0),linePatternDy:wu(t.linePatternDy,0)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},n._createGradient=function(t,e,n){if(Array.isArray(e)&&e.length){var i=e.length,r=t.createLinearGradient(e[0].x,e[0].y,e[i-1].x,e[i-1].y);n.colorStops.forEach((function(t){r.addColorStop.apply(r,t)})),t.strokeStyle=r}},e}(Tg),Hg=function(t){function e(e,n,i){var r,o=(r=t.call(this,e,n,i)||this).translate();return r._dynamic=tf(o),r.style=r._defineStyle(o),0===r.style.textWrapWidth?hu(r):(r.strokeAndFill=r._defineStyle(r.translateLineAndFill(r.style)),r)}au(e,t),e.test=function(t){return cg(t)};var n=e.prototype;return n.symbolize=function(t,e){if(this.painter.isHitTesting()||0!==this.style.textSize&&(this.style.textOpacity||this.style.textHaloRadius&&this.style.textHaloOpacity)&&0!==this.style.textWrapWidth){var n=this._getRenderContainerPoints();if(Su(n)){var i=this.style,r=this.strokeAndFill,o=Lf(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var s=this._textDesc=this._textDesc||Ff(o,this.style);this._prepareContext(t),this.prepareCanvas(t,r,e),Od.prepareCanvasFont(t,i);for(var a=0,h=n.length;a<h;a++){var l=n[a],c=this.getRotation()?this._rotate(t,l,this._getRotationAt(a)):null;c&&(l=c),Od.text(t,o,l,i,s),c&&t.restore()}}}},n.getPlacement=function(){return this.symbol.textPlacement},n.getRotation=function(){var t=this.style.textRotation;return _c(t)?-t*Math.PI/180:null},n.getDxDy=function(){var t=this.style;return new fu(t.textDx,t.textDy)},n.getFixedExtent=function(){var t=this.geometry.getTextDesc();return Array.isArray(t)&&(t=t[this._index]),this._fixedExtent=this._fixedExtent||new lm,t?ag(this._fixedExtent,this.style,t):this._fixedExtent},n.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:wu(t.textFaceName,"monospace"),textWeight:wu(t.textWeight,"normal"),textStyle:wu(t.textStyle,"normal"),textSize:wu(t.textSize,14),textFont:wu(t.textFont,null),textFill:wu(t.textFill,"#000"),textOpacity:wu(t.textOpacity,1),textHaloFill:wu(t.textHaloFill,"#ffffff"),textHaloRadius:wu(t.textHaloRadius,0),textHaloOpacity:wu(t.textHaloOpacity,1),textWrapWidth:wu(t.textWrapWidth,null),textWrapCharacter:wu(t.textWrapCharacter,"\n"),textLineSpacing:wu(t.textLineSpacing,0),textDx:wu(t.textDx,0),textDy:wu(t.textDy,0),textHorizontalAlignment:wu(t.textHorizontalAlignment,"middle"),textVerticalAlignment:wu(t.textVerticalAlignment,"middle"),textAlign:wu(t.textAlign,"center"),textRotation:wu(t.textRotation,0),textMaxWidth:wu(t.textMaxWidth,0),textMaxHeight:wu(t.textMaxHeight,0)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},n.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},e}(Ig),jg=[],zg=function(t){function e(e,n,i){var r,o=(r=t.call(this,e,n,i)||this).translate();return r._dynamic=tf(o),r.style=r._defineStyle(o),r.strokeAndFill=r._defineStyle(Ag(r.style)),r.padding=0,r}au(e,t),e.test=function(t){return fg(t)};var n=e.prototype;return n.symbolize=function(t,e){var n=this.style;if(this.painter.isHitTesting()||0!==n.markerWidth&&0!==n.markerHeight&&(0!==n.polygonOpacity||0!==n.lineOpacity)){var i=this._getRenderContainerPoints();Su(i)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkers(t,i,e):this._drawMarkersWithCache(t,i,e))}},n._drawMarkers=function(t,e,n){for(var i=e.length-1;i>=0;i--){var r=e[i],o=this.getRotation()?this._rotate(t,r,this._getRotationAt(i)):null;o&&(r=o),this._drawVectorMarker(t,r,n),o&&t.restore()}},n._drawMarkersWithCache=function(t,e,n){var i=this._stampSymbol(),r=n.getImage(i);r||(r=this._createMarkerImage(t,n),n.addResource([i,r.width,r.height],r));for(var o=ng(this.style,r.width,r.height),s=e.length-1;s>=0;s--){var a=e[s],h=this.getRotation()?this._rotate(t,a,this._getRotationAt(s)):null;h&&(a=h),Od.image(t,r,a.x+o.x,a.y+o.y),h&&t.restore()}},n._createMarkerImage=function(t,e){var n=t.canvas.constructor,i=ig(jg,this.style),r=Od.createCanvas(i[0],i[1],n),o=this._getCacheImageAnchor(i[0],i[1]),s=r.getContext("2d");return this._drawVectorMarker(s,o,e),r},n._stampSymbol=function(){return this._stamp||(this._stamp=jf([this.style.markerType,zf(this.style.markerFill)?Gf(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,zf(this.style.markerLineColor)?Gf(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},n._getCacheImageAnchor=function(t,e){var n=2*(this.symbol.shadowBlur||0)+this.padding,i=this.style.markerType;return"bar"===i||"pie"===i||"pin"===i?new fu(t/2,e-n):"rectangle"===i?new fu(n,n):new fu(t/2,e/2)},n._getGraidentExtent=function(t){var e=new lm,n=this.getDxDy(),i=this.getFixedExtent();if(Array.isArray(t))for(var r=t.length-1;r>=0;r--)e._combine(t[r]);else e._combine(t);return e.xmin+=i.xmin-n.x,e.ymin+=i.ymin-n.y,e.xmax+=i.xmax-n.x,e.ymax+=i.ymax-n.y,e},n._drawVectorMarker=function(t,e,n){Mg(t,e,this.style,n)},n.getFixedExtent=function(){var t=this.isDynamicSize(),e=this.style.markerWidth,n=this.style.markerHeight;return this._fixedExtent=this._fixedExtent||new lm,Qm(this._fixedExtent,this.style,t?[128,128*n/e]:null)},n.translate=function(){var t=this.symbol,e={markerType:wu(t.markerType,"ellipse"),markerFill:wu(t.markerFill,"#00f"),markerFillOpacity:wu(t.markerFillOpacity,1),markerFillPatternFile:wu(t.markerFillPatternFile,null),markerLineColor:wu(t.markerLineColor,"#000"),markerLineWidth:wu(t.markerLineWidth,qm),markerLineOpacity:wu(t.markerLineOpacity,1),markerLineDasharray:wu(t.markerLineDasharray,[]),markerLinePatternFile:wu(t.markerLinePatternFile,null),markerDx:wu(t.markerDx,0),markerDy:wu(t.markerDy,0),markerWidth:wu(t.markerWidth,Xm),markerHeight:wu(t.markerHeight,Zm),markerRotation:wu(t.markerRotation,0),shadowBlur:wu(t.shadowBlur,0),shadowOffsetX:wu(t.shadowOffsetX,0),shadowOffsetY:wu(t.shadowOffsetY,0)},n=e.markerType,i=$m(n),r=tg(n);return e.markerHorizontalAlignment=wu(t.markerHorizontalAlignment,i),e.markerVerticalAlignment=wu(t.markerVerticalAlignment,r),_c(t.markerOpacity)&&(_c(t.markerFillOpacity)&&(e.markerFillOpacity*=t.markerOpacity),_c(t.markerLineOpacity)&&(e.markerLineOpacity*=t.markerOpacity)),e},e}(Ig),Gg=function(t){function e(e,n,i){var r;pc(e.markerWidth)&&(e.markerWidth=80),pc(e.markerHeight)&&(e.markerHeight=80),e=gc(e,(r=t.call(this,e,n,i)||this).translate());var o=r.style=r._defineStyle(e);return r._url=su.gecko?[bf(o,o.markerWidth,o.markerHeight),o.markerWidth,o.markerHeight]:[bf(o),o.markerWidth,o.markerHeight],r}au(e,t),e.test=function(t){return dg(t)};var n=e.prototype;return n._prepareContext=function(){},n._getImage=function(t){var e=this;if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var n=this.painter,i=new Image;return i.onload=function(){var t=n.getLayer()&&n.getLayer().getRenderer();t&&t.setToRedraw()},i.onerror=function(n){n&&"undefined"!=typeof console&&console.warn(n),t.markErrorResource(e._url)},i.src=this._url[0],t&&t.addResource(this._url,i),i},e}(Lg),Ug={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Vg=[function(t){function e(e,n,i){var r;return(r=t.call(this,e,n,i)||this).style=n.getLayer().options.drawAltitude,r.style&&yc(r.style)||(r.style={lineWidth:2}),r.style.lineWidth||(r.style.lineWidth=0),r.dxdy=r._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),r}au(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var n=e.getJSONType();return"Marker"===n||"LineString"===n};var n=e.prototype;return n.symbolize=function(t){var e=this.geometry.getLayer();if(e.options.drawAltitude){var n=this.geometry.getProperties();if(n&&n[e.options.altitudeProperty]){var i=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var r=this._getPaintParams(i.lineDx,i.lineDy,!1,!0);if(!r)return;var o=this.getPainter().getPaintParams(i.lineDx,i.lineDy,!0,!0,"_groundpt")[0];this._drawLineAltitude(t,r[0],o)}else{var s=this._getRenderContainerPoints(),a=this._getRenderContainerPoints(!0);if(!s||0===s.length)return;this._drawMarkerAltitude(t,s[0],a[0])}}}},n.getDxDy=function(){var t=this.dxdy;return new fu(t.dx||0,t.dy||0)},n.get2DExtent=function(){return"LineString"===this.geometry.type?Bg.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},n.getPlacement=function(){return"point"},n._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0,null,!0,"_altpt")},n._drawMarkerAltitude=function(t,e,n){var i=this._getStyle();this.prepareCanvas(t,i),Od.path(t,[e,n],i.lineOpacity,null,i.lineDasharray)},n._drawLineAltitude=function(t,e,n){var i=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var r=0;r<e.length;r++)this._drawLine(t,e[r],n[r]);else this._drawLine(t,e,n);t.setLineDash&&Array.isArray(i.lineDasharray)&&t.setLineDash([])},n._drawLine=function(t,e,n){var i=this._getStyle();this.prepareCanvas(t,i);for(var r=0,o=e.length-1;r<o;r++)Od.polygon(t,[e[r],e[r+1],n[r+1],n[r]],i.lineOpacity,i.polygonOpacity,i.lineDasharray)},n._getStyle=function(){var t=this.geometry.getLayer().options.drawAltitude;return yc(t)||(t=Ug),t.lineWidth||(t.lineWidth=0,t.lineOpacity=0),t},e}(Ig),Bg,Lg,Gg,zg,Hg],Wg=new fu(0,0),Xg=new lm,Zg=new lm,qg=new lm,Yg=new lm,Kg=new lm,Jg={},Qg={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},$g=function(t){function e(e){var n;return(n=t.call(this)||this).geometry=e,n.symbolizers=n._createSymbolizers(),n._altAtGL=n._getGeometryAltitude(),n}au(e,t);var n=e.prototype;return n.getMap=function(){return this.geometry.getMap()},n.getLayer=function(){return this.geometry.getLayer()},n._createSymbolizers=function(){var t=this.getSymbol(),e=[],n=Vg,i=t;Array.isArray(t)||(i=[t]);for(var r=i.length-1;r>=0;r--)for(var o=i[r],s=n.length-1;s>=0;s--)if(n[s].test(o,this.geometry)){var a=new n[s](o,this.geometry,this);a._index=r,e.push(a),a instanceof Ig&&(this._hasPoint=!0)}if(!e.length&&console){var h=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(h?":"+h:""):"")+") to draw : "+JSON.stringify(t))}return this._debugSymbolizer=new Dg(t,this.geometry,this),e},n.hasPoint=function(){return!!this._hasPoint},n.getRenderPoints=function(t){return this._verifyProjection(),this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},n.getPaintParams=function(t,e,n,i,r){void 0===r&&(r="_pt");var o,s,a,h,l,c=this.getLayer()._getRenderer().mapStateCache,u=this.getMap();c&&!this._hitPoint?(o=c.resolution,s=c.pitch,a=c.bearing,h=c.glScale,l=c.containerExtent):(o=u.getResolution(),s=u.getPitch(),a=u.getBearing(),h=u.getGLScale(),l=u.getContainerExtent());var f=this.geometry,d=o,m=0!==s,g=0!==a,p=this._cachedParams,_=f._paintAsPath&&f._paintAsPath();if(_&&this._unsimpledParams&&d<=this._unsimpledParams._res)p=this._unsimpledParams;else if(!p||p._res!==o||this._pitched!==m&&f._redrawWhenPitch()||this._rotated!==g&&f._redrawWhenRotate()){if(!(p=f._getPaintParams()))return null;p._res=d,!f._simplified&&_&&(this._unsimpledParams||(this._unsimpledParams=p),d>this._unsimpledParams._res&&(this._unsimpledParams._res=d)),this._cachedParams=p}if(!p)return null;this._pitched=m,this._rotated=g;var v=h,y=[],x=this._pointContainerPoints(p[0],t,e,n,i||this._hitPoint&&!l.contains(this._hitPoint),null,r);if(!x)return null;y.push(x);for(var b=1,w=p.length;b<w;b++)_c(p[b])||p[b]instanceof Af?_c(p[b])?y.push(p[b]/v):y.push(p[b].multi(1/v)):y.push(p[b]);return y},n._pointContainerPoints=function(t,e,n,i,r,o,s){if(void 0===s&&(s="_pt"),this._aboveCamera())return null;var a,h,l,c=this.getLayer()._getRenderer(),u=c.mapStateCache,f=this.getMap(),d=this.geometry,m=this.containerOffset;u?(a=u.glRes,h=u.containerExtent):(a=f.getGLRes(),h=f.getContainerExtent());var g=this.getLayer().options.roundPoint,p=1/0,_=1/0,v=-1/0,y=-1/0,x=!r,b=c.layer.options.clipBBoxBufferSize||3,w=this.symbolizers;function T(t,i){void 0===t&&(t=[]),void 0===i&&(i=[]);for(var r=Gu(t,s),o=0,l=(r=f._pointsAtResToContainerPoints(t,a,i,r)).length;o<l;o++){var c=r[o];c._sub(m),(e||n)&&c._add(e||0,n||0),g&&(c.x=Math.ceil(c.x),c.y=Math.ceil(c.y)),p=Math.min(c.x,p),_=Math.min(c.y,_),v=Math.max(c.x,v),y=Math.max(c.y,y)}if(x&&Jf(w)){if(Kg.ymin=h.ymin,Kg.ymin<b&&(Kg.ymin=h.ymin-b),Kg.xmin=h.xmin-b,Kg.xmax=h.xmax+b,Kg.ymax=h.ymax+b,d.getShell&&d.getHoles)return yg(r,Kg);var u=_g(r,Kg,!1);if(u.length){var T=[];return u.forEach((function(t){for(var e=0,n=t.length;e<n;e++)T.push(t[e].point)})),T}}return r}var M=this.getAltitude();if(Array.isArray(t)){var A;!r&&this.geometry.options.enableClip?(A=this._clip(t,M)).inView&&(x=!1):A={points:t,altitude:M};var E=A.points;M=A.altitude,i&&(M=0);var C=M;l=[];for(var S=[],P=_c(M),R=0,O=E.length;R<O;R++){var I=E[R];if(Array.isArray(I)){if(P){var D=T(I,M);l.push(D);continue}for(var k=[],L=0,F=I.length;L<F;L++)Array.isArray(M)&&(C=M[R]?M[R][L]:0),k.push(C);var N=T(I,k);l.push(N)}else Array.isArray(M)&&(C="vertex-last"===o?M[M.length-1-R]:"line"===o?(M[R]+M[R+1])/2:M[R]),S.push(C)}S.length&&(l=T(E,S))}else t instanceof fu&&(i&&(M=0),l=f._pointAtResToContainerPoint(t,a,M)._sub(m),(e||n)&&l._add(e,n));return Qg.minx=p,Qg.miny=_,Qg.maxx=v,Qg.maxy=y,this._containerBbox=Qg,l},n._clip=function(t,e){if(_c(e)&&0!==e)return{points:t,altitude:e};if(Array.isArray(e)){for(var n=!1,i=0,r=e.length;i<r;i++)if(0!==e[i]){n=!0;break}if(n)return{points:t,altitude:e}}var o=this.getMap(),s=this.geometry,a=this.getSymbol().lineWidth;_c(a)||(a=4);var h,l,c,u=this.getLayer()._getRenderer().mapStateCache;u?(h=u._2DExtent,l=u.glExtent,c=u.pitch):(h=o._get2DExtent(),l=o._get2DExtentAtRes(o.getGLRes()),c=o.getPitch());var f=h._expand(a);if(c>0&&e){var d=o.cameraLookAt,m=o.cameraPosition;Wg.set(m.x,m.y),f=f._combine(Wg._add(Tu(d[0]-m[0]),Tu(d[1]-m[1])))}var g=t;if(this.get2DExtent(null,Yg).within(f))return{points:g,altitude:e,inView:!0};var p=l._expand(a*o._glScale);qg.xmin=p.xmin,qg.xmax=p.xmax,qg.ymin=p.ymin,qg.ymax=p.ymax;var _=s.options.smoothness;if(s.getShell&&this.geometry.getHoles&&!_){var v=p.ymin,y=p.ymax,x=Math.abs(p.xmax-p.xmin),b=Math.abs(y-v),w=Math.sqrt(x*x+b*b),T=(w-x)/2,M=(w-b)/2;if(qg.xmin=p.xmin-T,qg.xmax=p.xmax+T,qg.ymin=p.ymin-M,qg.ymax=p.ymax+M,Array.isArray(t[0])){g=[];for(var A=0;A<t.length;A++){var E=yg(t[A],qg);E.length&&g.push(E)}}else g=yg(t,qg)}else if("LineString"===s.getJSONType()&&!_){if(Array.isArray(t[0])){g=[];for(var C=0;C<t.length;C++)yu(g,_g(t[C],qg,!1,!!_))}else g=_g(t,qg,!1,!!_);return this._interpolateSegAlt(g,t,e)}return{points:g,altitude:e}},n._interpolateSegAlt=function(t,e,n){if(!Array.isArray(n)){var i=function(t){return t.point};return{points:t.map((function(t){return Array.isArray(t)?t.map(i):t.point})),altitude:n}}var r=function t(e,n,i){if(!Array.isArray(i))return e;for(var r=[],o=0,s=e.length;o<s;o++)if(Array.isArray(e[o]))r.push(t(e[o],n,i));else{var a=e[o];if(a.point.equals(n[a.index]))a.altitude=i[a.index],r.push(a);else{var h=void 0,l=void 0;0===a.index?(h=a.index,l=a.index+1):(h=a.index-1,l=a.index);var c=a.point.distanceTo(n[l]),u=c/(c+n[h].distanceTo(a.point)),f=Au(i[h],i[l],1-u);a.altitude=f,r.push(a)}}return r}(t,e,n);return n=[],{points:r.map((function(t){if(Array.isArray(t)){var e=[],i=t.map((function(t){return e.push(t.altitude),t.point}));return n.push(e),i}return n.push(t.altitude),t.point})),altitude:n}},n.getSymbol=function(){return this.geometry._getInternalSymbol()},n.paint=function(t,e,n){if(this.symbolizers){var i=this.getLayer(),r=i._getRenderer();if(r&&(r.context||e)){var o=r.mapStateCache||{};if(this.geometry._isCheck||!t||t.intersects(this.get2DExtent(r.resources,Xg))){var s=this.getMap(),a=this.getMinAltitude(),h=s.getFrustumAltitude();if(!(a&&h&&h<a)){this.containerOffset=n||o.offset||s._pointToContainerPoint(r.southWest)._add(0,-s.height),this._beforePaint();for(var l=e||r.context,c=[l,r.resources],u=this.symbolizers.length-1;u>=0;u--)(l.shadowBlur||this.symbolizers[u].symbol.shadowBlur)&&this._prepareShadow(l,this.symbolizers[u].symbol),this.symbolizers[u].symbolize.apply(this.symbolizers[u],c);this._afterPaint(),this._painted=!0,(this.geometry.options.debug||i.options.debug)&&this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,c)}}}}},n.getSprite=function(t,e){if("Point"!==this.geometry.type)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var n=new lm;this.symbolizers.forEach((function(e){var i=e.getFixedExtent(t);n._combine(i)}));var i,r=n.getMin().multi(-1),o=e||(this.getMap()?this.getMap().CanvasClass:null),s=Od.createCanvas(n.getWidth(),n.getHeight(),o);this._renderPoints&&(i=this._renderPoints);for(var a=s.getContext("2d"),h=[a,t],l=this.symbolizers.length-1;l>=0;l--){var c=this.symbolizers[l].getDxDy();this._renderPoints={center:[[r.add(c)]]},this._prepareShadow(a,this.symbolizers[l].symbol),this.symbolizers[l].symbolize.apply(this.symbolizers[l],h)}i&&(this._renderPoints=i),this._sprite={canvas:s,offset:n.getCenter()}}return this._spriting=!1,this._sprite},n.isSpriting=function(){return!!this._spriting},n.hitTest=function(t,e){if((!e||e<.5)&&(e=.5),this._hitPoint=t.sub(e,e),!Cg){var n=this.getMap()?this.getMap().CanvasClass:null;Cg=Od.createCanvas(1,1,n)}Od.setHitTesting(!0),Cg.width=Cg.height=2*e;var i=Cg.getContext("2d");try{this.paint(null,i,this._hitPoint)}catch(t){throw t}finally{Od.setHitTesting(!1)}delete this._hitPoint;for(var r=i.getImageData(0,0,Cg.width,Cg.height).data,o=3,s=r.length;o<s;o+=4)if(r[o]>0)return!0;return!1},n.isHitTesting=function(){return!!this._hitPoint},n._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=this.isHitTesting()?0:e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},n._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var n=this.symbolizers.length-1;n>=0;n--)t.apply(e,[this.symbolizers[n]])}},n.get2DExtent=function(t,e){this._verifyProjection();var n=this.getMap();t=t||this.getLayer()._getRenderer().resources;var i=n.getZoom(),r=this._isDynamicSize();if(this._extent2D&&this._extent2D._zoom===i&&this._fixedExtent||(this._extent2D&&this._extent2D._zoom!==i&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new lm),this._extent2D._zoom=i),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(t,new lm)))),!this._extent2D)return r&&delete this._fixedExtent,null;var o=this._fixedExtent,s=o.xmin,a=o.ymin,h=o.xmax,l=o.ymax;return r&&delete this._fixedExtent,Zg.set(s,-l,h,-a),e?(e.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),e._add(Zg),e):this._extent2D.add(Zg)},n._computeExtent2D=function(t){for(var e=this.symbolizers.length-1;e>=0;e--)t._combine(this.symbolizers[e].get2DExtent());return t},n._computeFixedExtent=function(t,e){for(var n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n];i.getFixedExtent&&e._combine(i.getFixedExtent(t))}return e},n._isDynamicSize=function(){for(var t=this.symbolizers.length-1;t>=0;t--)if(this.symbolizers[t].isDynamicSize())return!0;return!1},n._aboveCamera=function(){var t=this.getMinAltitude(),e=this.getMap().getFrustumAltitude();return t&&e&&e<t},n.getFixedExtent=function(){var t=this.getMap().getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new lm):(this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(null,Zg),this._fixedExtent)},n.setZIndex=function(t){this._eachSymbolizer((function(e){e.setZIndex(t)}))},n.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer((function(t){t.show()}))):this.getLayer().isCanvasRender()||this.paint()},n.hide=function(){this._eachSymbolizer((function(t){t.hide()}))},n.repaint=function(){this._altAtGL=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},n.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},n.remove=function(){this.removeCache(),this._removeSymbolizers()},n._removeSymbolizers=function(){this._eachSymbolizer((function(t){delete t.painter,t.remove()})),delete this.symbolizers},n.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},n.getAltitude=function(){return this.geometry.getAltitude()!==this._propAlt&&(this._altAtGL=this._getGeometryAltitude()),this._altAtGL?this._altAtGL:0},n.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},n.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},n._getGeometryAltitude=function(){var t=this;if(!this.getMap())return 0;var e=this.geometry.getAltitude();if(this._propAlt=e,!e)return this.minAltitude=this.maxAltitude=0,0;var n=this.geometry.getCenter();return n?Array.isArray(e)?(this.minAltitude=Number.MAX_VALUE,this.maxAltitude=Number.MIN_VALUE,e.map((function(e){var i=t._meterToPoint(n,e);return i<t.minAltitude&&(t.minAltitude=i),i>t.maxAltitude&&(t.maxAltitude=i),i}))):(this.minAltitude=this.maxAltitude=this._meterToPoint(n,e),this.minAltitude):0},n._meterToPoint=function(t,e){var n=this.getMap(),i=n.getGLRes();return n.altitudeToPoint(e,i)*Tu(e)},n._verifyProjection=function(){var t=this.geometry._getProjection()||Jg;this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},n._beforePaint=function(){},n._afterPaint=function(){},e}(Bd),tp=new lm,ep=function(t){function e(e,n){var i;return(i=t.call(this)||this).geometry=e,i.isMask=n,i}au(e,t);var n=e.prototype;return n._eachPainter=function(t){for(var e,n=this.geometry.getGeometries(),i=0,r=n.length;i<r&&(!(e=this.isMask?n[i]._getMaskPainter():n[i]._getPainter())||!e||!1!==t.call(this,e));i++);},n.paint=function(t){this.geometry&&this._eachPainter((function(e){e.paint(t)}))},n.get2DExtent=function(t,e){e&&e.set(null,null,null,null);var n=e||new lm;return this._eachPainter((function(e){n=n._combine(e.get2DExtent(t,tp))})),n},n.remove=function(){var t=arguments;this._eachPainter((function(e){e.remove.apply(e,t)}))},n.setZIndex=function(){var t=arguments;this._eachPainter((function(e){e.setZIndex.apply(e,t)}))},n.show=function(){var t=arguments;this._eachPainter((function(e){e.show.apply(e,t)}))},n.hide=function(){var t=arguments;this._eachPainter((function(e){e.hide.apply(e,t)}))},n.repaint=function(){var t=arguments;this._eachPainter((function(e){e.repaint.apply(e,t)}))},n.refreshSymbol=function(){var t=arguments;this._eachPainter((function(e){e.refreshSymbol.apply(e,t)}))},n.hasPoint=function(){var t=!1;return this._eachPainter((function(e){return!e.hasPoint()||(t=!0,!1)})),t},n.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter((function(n){var i=n.getMinAltitude();(t||i<e)&&(t=!1,e=i)})),e},n.getMaxAltitude=function(){var t=0;return this._eachPainter((function(e){var n=e.getMaxAltitude();n>t&&(t=n)})),t},e}(Bd),np={"EPSG:3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],e=12756274*Math.PI,n=0;n<23;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<23;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{projection:"baidu",resolutions:function(){for(var t=Math.pow(2,18),e=[],n=0;n<23;n++)e[n]=t,t*=.5;return e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{projection:"identity",resolutions:function(){for(var t=Math.pow(2,8),e=[],n=0;n<23;n++)e[n]=t,t*=.5;return e}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}},"PRESET-VT-3857":{projection:"EPSG:3857",resolutions:function(){for(var t=[],e=6378137*Math.PI,n=0;n<23;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}}};np["EPSG:4490"]=np["EPSG:4326"];var ip=function(){function t(t){void 0===t&&(t={}),this.options=t,this._initSpatialRef()}t.getPreset=function(t){return np[t.toUpperCase()]},t.getAllPresets=function(){return Object.keys(np)},t.getProjectionInstance=function(t){if(!t)return null;if(yc(t))return t.locate||(t=gc({},t),gc(t,wm.getInstance("identity"===t.measure?"IDENTITY":"EPSG:4326"))),t;for(var e in t=(t+"").toLowerCase(),Pm)if(Tc(Pm,e)){var n=Pm[e].code;if(n&&n.toLowerCase()===t)return Pm[e]}return null},t.equals=function(t,e){if(xc(t)||xc(e))return t===e;if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var n=t.fullExtent,i=e.fullExtent;if(n&&!i||!n&&i)return!1;if(n&&i&&(n.top!==i.top||n.bottom!==i.bottom||n.left!==i.left||n.right!==i.right))return!1;var r=t.resolutions,o=e.resolutions;if(r&&o){if(r.length!==o.length)return!1;for(var s=0;s<r.length;s++)if(r[s]!==o[s])return!1}else if(r||o)return!1;return!0};var e=t.prototype;return e._initSpatialRef=function(){var e=this.options.projection;if(!(e=e?t.getProjectionInstance(e):Sm))throw new Error("must provide a valid projection in map's spatial reference.");(e=gc({},um,e)).measureLength||gc(e,wm.DEFAULT),this._projection=e;var n,i=this.options.resolutions;if(!i&&(e.code&&(n=np[e.code.toUpperCase()])&&(i=n.resolutions,this.isEPSG="IDENTITY"!==e.code),!i))throw new Error("must provide valid resolutions in map's spatial reference.");if(this._resolutions=i,this._pyramid=!0,this._pyramid)for(var r=0;r<i.length;r++)if(i[r]&&i[r-1]&&i[r-1]/i[r]!=2){this._pyramid=!1;break}var o=this.options.fullExtent;if(!o&&(e.code&&(n=np[e.code.toUpperCase()])&&(o=n.fullExtent),!o))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(pc(o.left)?(this._fullExtent=new am(o),o.left=o.xmin,o.right=o.xmax,o.top=o.ymax,o.bottom=o.ymin):this._fullExtent=new am(new Zd(o.left,o.top),new Zd(o.right,o.bottom)),pc(o.top)||pc(o.bottom)||pc(o.left)||pc(o.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");gc(this._fullExtent,o),this._projection.fullExtent=o,this._transformation=new cm([o.right>=o.left?1:-1,o.top>=o.bottom?-1:1,0,0])},e.getResolutions=function(){return this._resolutions||[]},e.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var n=this._resolutions[e];return e!==t&&t>0&&e<this._resolutions.length-1?n+(this._resolutions[e+1]-n)*(t-e):n},e.getProjection=function(){return this._projection},e.getFullExtent=function(){return this._fullExtent},e.getTransformation=function(){return this._transformation},e.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!pc(this._resolutions[t]))return t;return 0},e.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!pc(this._resolutions[t]))return t;return this._resolutions.length-1},e.getZoomDirection=function(){return Tu(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},e.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},e.isPyramid=function(){return this._pyramid},t}(),rp=new fu(0,0),op=new lm,sp=function(t){function e(e){var n,i=gc({},e),r=i.symbol,o=i.properties,s=i.id;return delete i.symbol,delete i.id,delete i.properties,n=t.call(this,i)||this,r?n.setSymbol(r):n._genSizeSymbol(),o&&n.setProperties(o),pc(s)||n.setId(s),n}au(e,t);var n=e.prototype;return n.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},n.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},n.addTo=function(t,e){return t.addGeometry(this,e),this},n.getLayer=function(){return this._layer?this._layer:null},n.getMap=function(){return this._layer?this._layer.getMap():null},n.getId=function(){return this._id},n.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},n.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},n.setProperties=function(t){var e=this.properties;return this.properties=yc(t)?gc({},t):t,this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},n.getType=function(){return this.type},n.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?Wf(t):gc({},t):null},n.setSymbol=function(t){return this._symbolUpdated=t,this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),delete this._compiledSymbol,delete this._symbolHash,this},n.getSymbolHash=function(){return this._symbolHash||(this._symbolHash=Uf(this._symbolUpdated)),this._symbolHash},n.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol();if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Parameter of updateSymbol is not an array.");for(var n=0;n<t.length;n++)cg(t[n])&&delete this._textDesc,e[n]&&t[n]&&(e[n]=Wf(e[n],t[n]))}else{if(Array.isArray(t))throw new Error("Geometry's symbol is not an array to update.");cg(e)&&delete this._textDesc,e=Wf(e||this._getInternalSymbol(),t)}return this._eventSymbolProperties=t,delete this._compiledSymbol,this.setSymbol(e)},n.getTextContent=function(){var t=this._getInternalSymbol();if(Array.isArray(t)){for(var e=[],n=!1,i=0;i<t.length;i++)e[i]=Lf(t[i]&&t[i].textName,this.getProperties()),pc(e[i])||(n=!0);return n?e:null}return Lf(t&&t.textName,this.getProperties())},n.getTextDesc=function(){if(!this._textDesc){var t=this.getTextContent(),e=this._sizeSymbol,n=Array.isArray(t);this._textDesc=Array.isArray(e)?e.map((function(e,i){return Ff(n?t[i]:"",e)})):Ff(t,e)}return this._textDesc},n.getCenter=function(){return this._computeCenter(this._getMeasurer())},n.getExtent=function(){var t=this._getPrjExtent(),e=this._getProjection();if(t&&e){var n=e.unproject(new Zd(t.xmin,t.ymin)),i=e.unproject(new Zd(t.xmax,t.ymax));return new am(n,i,e)}return this._computeExtent(this._getMeasurer())},n.getContainerExtent=function(t){var e=this.get2DExtent();if(!e||!e.isValid())return null;var n=this.getMap(),i=n.getGLRes(),r=this.getMinAltitude(),o=n.altitudeToPoint(r,i)*Tu(r),s=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,i,o,rp)}),t),a=this.getMaxAltitude();if(a!==r){a=n.altitudeToPoint(a,i)*Tu(a);var h=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,i,a,rp)}),op);s._combine(h)}var l=this.getLayer();if(l&&"LineString"===this.type&&a&&l.options.drawAltitude){var c=e.convertTo((function(t){return n._pointAtResToContainerPoint(t,i,0,rp)}),op);s._combine(c)}return s&&s._add(this._getFixedExtent()),this.options.smoothness&&s._expand(.15*s.getWidth()),s},n._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new lm);var t=this._sizeSymbol,e=(t&&t.lineWidth||1)/2;return this._fixedExtent.set(-e,-e,e,e),this._fixedExtent._add([t&&t.lineDx||0,0]),this._fixedExtent._add([0,t&&t.lineDy||0]),this._fixedExtent},n.get2DExtent=function(){var t=this.getMap();if(!t)return null;if(this._extent2d)return this._extent2d;var e=this._getPrjExtent();if(!e||!e.isValid())return null;var n=e.getMin(),i=e.getMax(),r=t.getGLRes();return t._prjToPointAtRes(n,r,n),t._prjToPointAtRes(i,r,i),this._extent2d=new lm(n,i),this._extent2d.z=t.getZoom(),this._extent2d},n.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},n.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof Zd&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},n._containsPoint=function(t,e){var n=this._getPainter();return!!n&&(e=e||0,this._hitTestTolerance&&(e+=this._hitTestTolerance()),n.hitTest(t,e))},n.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},n.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},n.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,n=t.length;e<n;e++)if(pc(t[e].opacity)||t[e].opacity>0)return!0;return!1}return pc(t.opacity)||yc(t.opacity)||_c(t.opacity)&&t.opacity>0},n.getZIndex=function(){return this.options.zIndex||0},n.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},n.setZIndexSilently=function(t){return this.options.zIndex=t,this},n.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},n.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},n.translate=function(t,e){if(pc(t))return this;var n=new Zd(t,e);if(0===n.x&&0===n.y)return this;var i=this.getCoordinates();if(this._silence=!0,i)if(Array.isArray(i)){var r=bu(i,(function(t){return t.add(n)}));this.setCoordinates(r)}else this.setCoordinates(i.add(n));return this._silence=!1,this._fireEvent("positionchange"),this},n.flash=function(t,e,n,i){return zu.call(this,t,e,n,i)},n.copy=function(){var t=this.toJSON(),n=e.fromJSON(t);return n.options.visible=!0,n},n.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},n.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},n.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(pc(t.geometry)||t.geometry){var n=this._exportGeoJSONGeometry();e.geometry=n}var i,r=this.getId();return pc(r)||(e.id=r),(pc(t.properties)||t.properties)&&(i=this._exportProperties()),e.properties=i,e},n.toJSON=function(t){t||(t={});var e=this._toJSON(t);return gc(e,this._exportGraphicOptions(t)),e},n.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},n.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},n.rotate=function(t,e){if("GeometryCollection"===this.type)return this.getGeometries().forEach((function(n){return n.rotate(t,e)})),this;e=e?new Zd(e):this.getCenter();var n=this._getMeasurer(),i=this.getCoordinates();if(!Array.isArray(i)){if(e.x!==i.x||e.y!==i.y){var r=n._rotate(i,e,t);this.setCoordinates(r)}return this}return bu(i,(function(i){return n._rotate(i,e,t)})),this.setCoordinates(i),this},n._getConnectPoints=function(){return[this.getCenter()]},n._initOptions=function(t){var e=gc({},t),n=e.symbol,i=e.properties,r=e.id;delete e.symbol,delete e.id,delete e.properties,this.setOptions(e),n&&this.setSymbol(n),i&&this.setProperties(i),pc(r)||this.setId(r)},n._bindLayer=function(t){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache(),this._bindInfoWindow(),this._bindMenu()},n._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],n=0;n<t.length;n++)e.push(Tf(this._checkAndCopySymbol(t[n])));return e}return t?Tf(t=this._checkAndCopySymbol(t)):null},n._checkAndCopySymbol=function(t){var e={};for(var n in t)e[n]=fc[n]&&xc(t[n])?+t[n]:t[n];return e},n._getSymbol=function(){return this._symbol},n._setExternSymbol=function(t){return this._eventSymbolProperties=t,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},n._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},n._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},n._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},n._getInternalId=function(){return this._internalId},n._setInternalId=function(t){this._internalId=t},n._getMeasurer=function(){return this._getProjection()?this._getProjection():ip.getProjectionInstance(this.options.defaultProjection)},n._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},n._verifyProjection=function(){var t=this._getProjection();this._projCode&&t&&this._projCode!==t.code&&this._clearProjection(),this._projCode=t?t.code:this._projCode},n._getExternalResources=function(){return wf(this._getInternalSymbol())},n._getPainter=function(){var t=this.getLayer();if(!this._painter&&t)if(-1!==hc.indexOf(this.type)){if(t.constructor.getCollectionPainterClass){var e=t.constructor.getCollectionPainterClass();e&&(this._painter=new e(this))}}else if(t.constructor.getPainterClass){var n=t.constructor.getPainterClass();n&&(this._painter=new n(this))}return this._painter},n._getMaskPainter=function(){return this._maskPainter||(this._maskPainter=this.getGeometries&&this.getGeometries()?new ep(this,!0):new $g(this)),this._maskPainter},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},n._paint=function(t){if(this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var e=this._getProjection();e&&(this._pcenter=e.project(this._coordinates),this._clearCache())}this._painter.paint(t)}},n._clearCache=function(){delete this._extent,delete this._extent2d},n._clearProjection=function(){delete this._extent,delete this._extent2d},n._repaint=function(){this._painter&&this._painter.repaint()},n.onHide=function(){this.closeMenu(),this.closeInfoWindow()},n.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},n.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},n.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var t={};this._eventSymbolProperties?(t.properties=gc({},this._eventSymbolProperties),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",t)},n._genSizeSymbol=function(){var t=this._getInternalSymbol();if(t)if(Array.isArray(t)){this._sizeSymbol=[];for(var e=!1,n=0;n<t.length;n++){var i=this._sizeSymbol[n]=this._getSizeSymbol(t[n]);!e&&i&&i._dynamic&&(e=!0)}this._sizeSymbol._dynamic=e}else this._sizeSymbol=this._getSizeSymbol(t);else delete this._sizeSymbol},n._getSizeSymbol=function(t){var e=yf({lineWidth:t.lineWidth,lineDx:t.lineDx,lineDy:t.lineDy},this);return($u(t.lineWidth)||$u(t.lineDx)||$u(t.lineDy))&&(e._dynamic=!0),e},n._getCompiledSymbol=function(){return this._compiledSymbol||(this._compiledSymbol=yf(this._getInternalSymbol(),this)),this._compiledSymbol},n.onConfig=function(t){var e;t.properties&&(e=t.properties,delete t.properties);var n=!1;for(var i in t)if(t.hasOwnProperty(i)){var r=i.slice(0,5);if("arrow"===r||"smoot"===r){n=!0;break}}e?(this.setProperties(e),this._repaint()):n&&this._repaint()},n._setParent=function(t){t&&(this._parent=t)},n._getParent=function(){return this._parent},n._fireEvent=function(t,e){this._silence||(this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e))},n._toJSON=function(t){return{feature:this.toGeoJSON(t)}},n._exportGraphicOptions=function(t){var e={};return(pc(t.options)||t.options)&&(e.options=this.config()),(pc(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(pc(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},n._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=Zd.toNumberArrays(t);return{type:this.getType(),coordinates:e}},n._exportProperties=function(){var t=null,e=this.getProperties();return pc(e)||(t=yc(e)?gc({},e):e),t},n._hitTestTolerance=function(){var t=this.getLayer();return t&&t.options.geometryEventTolerance||0},n.getAltitude=function(){var t=this.getLayer();if(!t)return 0;var e=t.options,n=this.getProperties(),i=e.enableAltitude&&n?n[e.altitudeProperty]:0,r=t.getAltitude?t.getAltitude():0;return Array.isArray(i)?i.map((function(t){return t+r})):i+r},n._genMinMaxAlt=function(){var t=this,e=this.getAltitude();Array.isArray(e)?(this._minAlt=Number.MAX_VALUE,this._maxAlt=Number.MIN_VALUE,e.forEach((function(e){var n=e;n<t._minAlt&&(t._minAlt=n),n>t._maxAlt&&(t._maxAlt=n)}))):this._minAlt=this._maxAlt=e},n.getMinAltitude=function(){return void 0===this._minAlt&&this._genMinMaxAlt(),this._minAlt?this._minAlt:0},n.getMaxAltitude=function(){return void 0===this._maxAlt&&this._genMinMaxAlt(),this._maxAlt?this._maxAlt:0},e}(jd(Fd(Ud(Bd))));sp.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,antiMeridian:!1,defaultProjection:"EPSG:4326"});var ap={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:!su.mobile},hp=function(t){function e(e,n){var i,r;return n&&(r=n.canvas,delete n.canvas),(i=t.call(this,n)||this)._canvas=r,i.setId(e),n&&(i.setZIndex(n.zIndex),n.mask&&i.setMask(sp.fromJSON(n.mask))),i}au(e,t);var n=e.prototype;return n.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();pc(t)||(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},n.getId=function(){return this._id},n.setId=function(t){var e=this._id;return pc(t)||(t+=""),this._id=t,this.fire("idchange",{old:e,new:t}),this},n.addTo=function(t){return t.addLayer(this),this},n.setZIndex=function(t){return this._zIndex=t,pc(t)?delete this.options.zIndex:this.options.zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this},n.getZIndex=function(){return this._zIndex||0},n.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},n.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),pc(e)?1/0:e):e},n.getOpacity=function(){return this.options.opacity},n.setOpacity=function(t){return this.config("opacity",t),this},n.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof Vm},n.getMap=function(){return this.map?this.map:null},n.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},n.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var n=e.getZIndex();return this.setZIndex(n+1),this},n.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var n=e.getZIndex();return this.setZIndex(n-1),this},n.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var n=this.getMap();e&&n?n.once("renderend",(function(){t.fire("show")})):this.fire("show")}return this},n.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var n=this.getMap();e&&n?n.once("renderend",(function(){t.fire("hide")})):this.fire("hide")}return this},n.isVisible=function(){if(_c(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var e=t.getZoom();if(!pc(this.options.maxZoom)&&this.options.maxZoom<e||!pc(this.options.minZoom)&&this.options.minZoom>e)return!1}return pc(this.options.visible)&&(this.options.visible=!0),this.options.visible},n.remove=function(){return this.map&&this.map.removeLayer(this),this},n.getMask=function(){return this._mask},n.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type||"MultiPolygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(t._bindLayer(this),"Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=t,this.options.mask=t.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},n.removeMask=function(){if(delete this._mask,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},n.onLoad=function(){return!0},n.onLoadEnd=function(){},n.isLoaded=function(){return!!this._loaded},n.getCollisionIndex=function(){if("layer"===this.options.collisionScope)return this._collisionIndex||(this._collisionIndex=new Gd),this._collisionIndex;var t=this.getMap();return t?t.getCollisionIndex():null},n.clearCollisionIndex=function(){return"layer"===this.options.collisionScope&&this._collisionIndex&&this._collisionIndex.clear(),this},n.getRenderer=function(){return this._getRenderer()},n.onConfig=function(t){if(_c(t.opacity)||t.cssFilter){var e=this.getRenderer();e&&e.setToRedraw()}},n.onAdd=function(){},n.onRendererCreate=function(){},n.onCanvasCreate=function(){},n.onRemove=function(){},n._bindMap=function(t,e){t&&(this.map=t,pc(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},n._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{renderer:this._renderer})}},n._doRemove=function(){this._loaded=!1,this._switchEvents("off",this),this.onRemove(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},n._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()&&this.getMap()[t](e.getEvents(),e)},n._getRenderer=function(){return this._renderer},n._getLayerList=function(){return this.map?this.map._layers:[]},n._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getMaskPainter();return t?t.get2DExtent():null},e}(jd(Fd(Rm(Bd))));hp.mergeOptions(ap);var lp=hp.prototype.fire;hp.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={}),e.type=t,e.target=this,this.map._onLayerEvent(e)),lp.apply(this,arguments)};var cp,up,fp,dp,mp,gp,pp,_p=new Zd(0,0),vp={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:!Cc,zoomAnimationDuration:330,panAnimation:!Cc,panAnimationDuration:600,rotateAnimation:!Cc,zoomable:!0,enableInfoWindow:!0,hitDetect:!su.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:"canvas",cascadePitches:[10,60],renderable:!0,clickTimeThreshold:280,stopRenderOnOffscreen:!0},yp=function(t){function e(n,i){var r;if(!i)throw new Error("Invalid options when creating map.");if(!i.center)throw new Error("Invalid center when creating map.");var o=gc({},i),s=o.zoom;delete o.zoom;var a=new Zd(o.center);delete o.center;var h=o.baseLayer;delete o.baseLayer;var l=o.layers;return delete o.layers,(r=t.call(this,o)||this).VERSION=e.VERSION,Object.defineProperty(hu(hu(r)),"id",{value:pu(),writable:!1}),r._loaded=!1,r._initContainer(n),r._panels={},r._baseLayer=null,r._layers=[],r._zoomLevel=s,r._center=a,r.setSpatialReference(o.spatialReference||o.view),r._mapViewPoint=new fu(0,0),r._initRenderer(),r._updateMapSize(r._getContainerDomSize()),h&&r.setBaseLayer(h),l&&r.addLayer(l),r.setMaxExtent(o.maxExtent),r._Load(),r}au(e,t),e.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),n="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(n),this};var n=e.prototype;return n.isLoaded=function(){return!!this._loaded},n.getContainer=function(){return this._containerDOM},n.getSpatialReference=function(){return this._spatialReference},n.setSpatialReference=function(t){var e=this.options.spatialReference;return this._loaded&&ip.equals(e,t)||this._updateSpatialReference(t,e),this},n._updateSpatialReference=function(t,e){if(xc(t)&&(t=ip.getPreset(t)),t=gc({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new ip(t),this.options.spatialReference&&bc(this.options.spatialReference.projection)){var n=this._spatialReference.getProjection();this.options.spatialReference.projection=n.code}return this._resetMapStatus(),this._fireEvent("spatialreferencechange",{old:e,new:gc({},this.options.spatialReference)}),this},n.onConfig=function(t){var e=t.spatialReference||t.view;return pc(e)||this._updateSpatialReference(e,null),this},n.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},n.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},n.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},n.resetCursor=function(){return this.setCursor(null)},n.getCenter=function(){return this._loaded&&this._prjCenter?this.getProjection().unproject(this._prjCenter):this._center},n.setCenter=function(t){if(!t)return this;t=new Zd(t);var e=this.getProjection().project(t);return this._verifyExtent(e)?this._loaded?(this.onMoveStart(),this._setPrjCenter(e),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=t,this):this},n.getSize=function(){return pc(this.width)||pc(this.height)?this._getContainerDomSize():new Af(this.width,this.height)},n.getContainerExtent=function(){var t=this.height,e=this.getPitch(),n=this.options.maxVisualPitch;return n&&e>n&&(t=this._getVisualHeight(n)),new lm(0,this.height-t,this.width,this.height)},n._getVisualHeight=function(t){t=t||.01;var e=(90-this.getPitch())*Math.PI/180,n=this.getFov()*Math.PI/180;t*=Math.PI/180;var i=this.cameraCenterDistance/this.getGLScale(),r=Math.tan(n/2),o=i*r/(1/Math.tan(t)-r)/Math.sin(t),s=i*(Math.sin(e)*o/(i+Math.cos(e)*o));return this.height/2+s},n.getExtent=function(){return this._pointToExtent(this._get2DExtent())},n.getProjExtent=function(){var t=this._get2DExtent();return new am(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},n.getPrjExtent=function(){return this.getProjExtent()},n.getMaxExtent=function(){return this.options.maxExtent?new am(this.options.maxExtent,this.getProjection()):null},n.setMaxExtent=function(t){if(t){var e=new am(t,this.getProjection());this.options.maxExtent=e;var n=this.getProjection();this._prjMaxExtent=e.convertTo((function(t){return n.project(t)})),this._verifyExtent(this._getPrjCenter())||(this._loaded?this._panTo(this._prjMaxExtent.getCenter()):this._center=n.unproject(this._prjMaxExtent.getCenter()))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},n.getZoom=function(){return this._zoomLevel},n.getZoomForScale=function(t,e,n){var i=this.getZoom();if(pc(e)&&(e=i),1===t&&e===i)return i;var r=this._getResolution(e),o=this.getZoomFromRes(r/t);return n?o:this.getSpatialReference().getZoomDirection()<0?Math.ceil(o-1e-6):Math.floor(o+1e-6)},n.getZoomFromRes=function(t){var e=this._getResolutions(),n=this._getResolution(this.getMinZoom()),i=this._getResolution(this.getMaxZoom());if(n<=i){if(t<=n)return this.getMinZoom();if(t>=i)return this.getMaxZoom()}else{if(t>=n)return this.getMinZoom();if(t<=i)return this.getMaxZoom()}for(var r=e.length,o=0;o<r-1;o++)if(e[o]){var s=e[o+1]-e[o],a=t-e[o];if(Tu(s)===Tu(a)&&Math.abs(s)>=Math.abs(a))return o+a/s}return r-1},n.setZoom=function(t,e){return void 0===e&&(e={animation:!0}),isNaN(t)||pc(t)||(t=+t,this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t)),this},n.getMaxZoom=function(){return pc(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},n.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&(this.setZoom(t),t=+t),this.options.maxZoom=t,this},n.getMinZoom=function(){return pc(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},n.setMinZoom=function(t){if(null!==t){t=+t;var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},n.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},n.getGLRes=function(){if(this._glRes)return this._glRes;var t=this.getSpatialReference().getFullExtent();return this._glRes=(t.right-t.left)/Math.pow(2,19),this._glRes},n.getGLScale=function(t){return pc(t)&&(t=this.getZoom()),this._getResolution(t)/this.getGLRes()},n.zoomIn=function(){return this.setZoom(this.getZoom()+1)},n.zoomOut=function(){return this.setZoom(this.getZoom()-1)},n.isZooming=function(){return!!this._zooming},n.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},n.setCenterAndZoom=function(t,e){return pc(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},n.getFitZoom=function(t,e){var n=this;if(!(t&&t instanceof am))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var i=this.getSize(),r=t.convertTo((function(t){return n.coordToPoint(t)})),o=r.getWidth(),s=r.getHeight(),a=i.width/o,h=i.height/s,l=this.getSpatialReference().getZoomDirection()<0?Math.max(a,h):Math.min(a,h);return this.getZoomForScale(l,null,e)},n.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},n.setView=function(t){return t?(t.center&&this.setCenter(t.center),null===t.zoom||isNaN(+t.zoom)||this.setZoom(+t.zoom,{animation:!1}),null===t.pitch||isNaN(+t.pitch)||this.setPitch(+t.pitch),null===t.pitch||isNaN(+t.bearing)||this.setBearing(+t.bearing),this):this},n.getResolution=function(t){return this._getResolution(t)},n.getScale=function(t){var e=pc(t)?this.getZoom():t,n=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/n},n.fitExtent=function(t,e,n,i){if(void 0===n&&(n={}),!t)return this;t=new am(t,this.getProjection());var r=this.getFitZoom(t)+(e||0),o=t.getCenter();return void 0===n.animation||n.animation?this._animateTo({center:o,zoom:r},{duration:n.duration||this.options.zoomAnimationDuration,easing:n.easing||"out"},i):this.setCenterAndZoom(o,r)},n.getBaseLayer=function(){return this._baseLayer},n.setBaseLayer=function(t){var e=!1;return this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),t?(this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",(function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))}),this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this):(delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this)},n.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},n.getLayers=function(t){return this._getLayers((function(e){return!(e===this._baseLayer||e.getId().indexOf("_maptalks__internal_layer_")>=0)&&(!t||t(e))}))},n.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var n=this.getBaseLayer();return n&&n.getId()===t?n:null},n.addLayer=function(t){if(!t)return this;if(!Array.isArray(t))return t=Array.prototype.slice.call(arguments,0),this.addLayer(t);this._layerCache||(this._layerCache={});for(var e=this._layers,n=0,i=t.length;n<i;n++){var r=t[n],o=r.getId();if(pc(o))throw new Error("Invalid id for the layer: "+o);if(r.getMap()!==this){if(this._layerCache[o])throw new Error("Duplicate layer id in the map: "+o);this._layerCache[o]=r,r._bindMap(this),e.push(r),this._loaded&&r.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},n.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],n=0,i=t.length;n<i;n++){var r=t[n];if(r instanceof hp||(r=this.getLayer(r)),r){var o=r.getMap();if(o&&o===this){e.push(r),this._removeLayer(r,this._layers),this._loaded&&r._doRemove();var s=r.getId();this._layerCache&&delete this._layerCache[s]}}}if(e.length>0){var a=this.getRenderer();a&&a.setLayerCanvasUpdated(),this.once("frameend",(function(){e.forEach((function(t){t.fire("remove")}))}))}return this._fireEvent("removelayer",{layers:t}),this},n.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],n=Number.MAX_VALUE,i=0,r=t.length;i<r;i++){var o=t[i];if(xc(t[i])&&(o=this.getLayer(o)),!(o instanceof hp&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<n&&(n=o.getZIndex()),e.push(o)}for(var s=0,a=e.length;s<a;s++)e[s].setZIndex(n+s);return this},n.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var n=t.save,i=this._getRenderer();if(i&&i.toDataURL){var r=t.fileName;r||(r="export");var o=i.toDataURL(e,t.quality||.92);if(n&&o){var s;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var a=Lu(o.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),e);s=URL.createObjectURL(a)}else s=o;var h=document.createElement("a");h.download=r,h.href=s,document.body.appendChild(h),h.click(),document.body.removeChild(h)}return o}return null},n.coordToPoint=function(t,e,n){return this.coordinateToPoint(t,e,n)},n.coordToPointAtRes=function(t,e,n){return this.coordinateToPointAtRes(t,e,n)},n.pointToCoord=function(t,e,n){return this.pointToCoordinate(t,e,n)},n.pointAtResToCoord=function(t,e,n){return this.pointAtResToCoordinate(t,e,n)},n.coordToViewPoint=function(t,e,n){return this.coordinateToViewPoint(t,e,n)},n.viewPointToCoord=function(t,e){return this.viewPointToCoordinate(t,e)},n.coordToContainerPoint=function(t,e,n){return this.coordinateToContainerPoint(t,e,n)},n.containerPointToCoord=function(t,e){return this.containerPointToCoordinate(t,e)},n.containerPointToViewPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._sub(this.getViewPoint())},n.viewPointToContainerPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._add(this.getViewPoint())},n.checkSize=function(t){var e=mc()-this._initTime<1500&&0===this.width||0===this.height,n=this._getContainerDomSize(),i=this.height,r=this.width;if(!t&&n.width===r&&n.height===i)return this;fd(this._containerDOM);var o=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(n);else{var s=this._getVisualHeight(this.getPitch()),a=new fu(0,this.height-s),h=this._containerPointToPrj(a);this._updateMapSize(n);var l=this._getVisualHeight(this.getPitch()),c=new fu(0,this.height-l);this._setPrjCoordAtContainerPoint(h,c),this._mapViewCoord=this._getPrjCenter()}return(e||0===n.width||0===n.height||0===r||0===i)&&(this._eventSilence=!0,this.setCenter(o),delete this._eventSilence),this._fireEvent("resize"),this},n.locate=function(t,e,n){return this.getProjection()._locate(new Zd(t),e,n)},n.getMainPanel=function(){return this._getRenderer().getMainPanel()},n.getPanels=function(){return this._panels},n.remove=function(){var t=this;if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var e=this.getLayers(),n=0;n<e.length;n++)e[n].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter((function(t){return"maptalks-wrapper"===t.className})).forEach((function(e){return t._containerDOM.removeChild(e)})),delete this._panels,delete this._containerDOM,delete this.renderer,this._fireEvent("removeend"),this._clearAllListeners(),su.removeDPRListening&&su.removeDPRListening(this),this},n.isRemoved=function(){return!this._containerDOM},n.isMoving=function(){return!!this._moving},n.onMoveStart=function(t){this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer);var e=this._getPrjCenter();this._originCenter&&!this._verifyExtent(e)||(this._originCenter=e),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},n.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving"))},n.onMoveEnd=function(t){this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),!this._verifyExtent(this._getPrjCenter())&&this._originCenter&&this._panTo(this._originCenter)},n.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},n.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},n.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},n.isDragRotating=function(){return!!this._dragRotating},n.isOffscreen=function(t,e){void 0===e&&(e=0);var n=this.width+e,i=this.height+e,r=t.xmin,o=t.ymin,s=t.xmax,a=t.ymax;return Array.isArray(t)&&(r=t[0],o=t[1],s=t[2],a=t[3]),s<e||r>=n||a<e||o>i},n.getRenderer=function(){return this._getRenderer()},n.getDevicePixelRatio=function(){return this.options.devicePixelRatio||su.devicePixelRatio||1},n.setDevicePixelRatio=function(t){return _c(t)&&t>0&&t!==this.options.devicePixelRatio&&(this.options.devicePixelRatio=t,this.checkSize(!0)),this},n._initContainer=function(t){if(xc(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,Cc&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},n._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},n._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},n._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},n._removeLayer=function(t,e){if(t&&e){var n=e.indexOf(t);n>-1&&e.splice(n,1)}},n._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++)this._layers[t]._order=t,this._layers[t].sortLayersByZIndex&&this._layers[t].sortLayersByZIndex();this._layers.sort((function(t,e){var n=t.getZIndex()-e.getZIndex();return 0===n?t._order-e._order:n}))}},n._fireEvent=function(t,e){this._eventSilence||(this.fire("_"+t,e),this.fire(t,e))},n._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),delete this._glRes,this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=mc()},n._initRenderer=function(){var t=e.getRendererClass(this.options.renderer);this._renderer=new t(this),this._renderer.load()},n._getRenderer=function(){return this._renderer},n._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer((function(t){t&&t.load()}),this.getLayers())},n._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,n=[],i=0;i<e.length;i++)t&&!t.call(this,e[i])||n.push(e[i]);return n},n._eachLayer=function(t){if(!(arguments.length<2)){var e=Array.prototype.slice.call(arguments,1);e&&!Array.isArray(e)&&(e=[e]);for(var n=[],i=0,r=e.length;i<r;i++)n=n.concat(e[i]);for(var o=0,s=n.length;o<s;o++)t.call(t,n[o])}},n._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},n._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),n=this._spatialReference.getMaxZoom(),i=this._spatialReference.getMinZoom();(pc(t)||-1===t||t>n)&&this.setMaxZoom(n),(pc(e)||-1===e||e<i)&&this.setMinZoom(i),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(pc(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var r=this.getProjection();this._prjCenter=r.project(this._center),this._calcMatrices();var o=this._getRenderer();o&&o.resetContainer()},n._getContainerDomSize=function(){if(!this._containerDOM)return null;var t,e,n=this._containerDOM;if(this._containerDomContentRect)return new Af(t=this._containerDomContentRect.width,e=this._containerDomContentRect.height);if(pc(n.width)||pc(n.height)){if(pc(n.clientWidth)||pc(n.clientHeight))throw new Error("can not get size of container");t=parseInt(n.clientWidth,0),e=parseInt(n.clientHeight,0)}else{t=n.width,e=n.height;var i=this.getDevicePixelRatio();1!==i&&n.layer&&(t/=i,e/=i)}return new Af(t,e)},n._updateMapSize=function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this._calcMatrices(),this},n._getPrjCenter=function(){return this._prjCenter},n._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},n._setPrjCoordAtContainerPoint=function(t,e){if(e.x===this.width/2&&e.y===this.height/2)return this;var n=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),i=this._pointToPrj(this._prjToPoint(t).sub(n));return this._setPrjCenter(i),this},n._verifyExtent=function(t){if(!t)return!1;var e=this._prjMaxExtent;return!e||e.contains(t)},n._offsetCenterByPixel=function(t){var e=new fu(this.width/2-t.x,this.height/2-t.y),n=this._containerPointToPrj(e);return this._setPrjCenter(n),n},n.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},n.getViewPoint=function(){var t=this._getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},n._resetMapViewPoint=function(){this._mapViewPoint=new fu(0,0),this._mapViewCoord=this._getPrjCenter()},n._getResolution=function(t){return void 0!==t&&t!==this._zoomLevel||void 0===this._mapRes?(pc(t)&&(t=this._zoomLevel),this._spatialReference.getResolution(t)):this._mapRes},n._getResolutions=function(){return this._spatialReference.getResolutions()},n._prjToPoint=function(t,e,n){e=pc(e)?this.getZoom():e;var i=this._getResolution(e);return this._prjToPointAtRes(t,i,n)},n._prjToPointAtRes=function(t,e,n){return this._spatialReference.getTransformation().transform(t,e,n)},n._prjsToPointsAtRes=function(t,e,n){void 0===n&&(n=[]);for(var i=this._spatialReference.getTransformation(),r=[],o=0,s=t.length;o<s;o++){var a=i.transform(t[o],e,n[o]);r.push(a)}return r},n._pointToPrj=function(t,e,n){e=pc(e)?this.getZoom():e;var i=this._getResolution(e);return this._pointToPrjAtRes(t,i,n)},n._pointToPrjAtRes=function(t,e,n){return this._spatialReference.getTransformation().untransform(t,e,n)},n._pointToPoint=function(t,e,n){return pc(e)?(n?(n.x=t.x,n.y=t.y):n=t.copy(),n):this._pointAtResToPoint(t,this._getResolution(e),n)},n._pointAtResToPoint=function(t,e,n){return n?(n.x=t.x,n.y=t.y):n=t.copy(),n._multi(e/this._getResolution())},n._pointToPointAtRes=function(t,e,n){return n?(n.x=t.x,n.y=t.y):n=t.copy(),n._multi(this._getResolution()/e)},n._containerPointToPrj=function(t,e){return this._pointToPrj(this._containerPointToPoint(t,void 0,e),void 0,e)},n._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var n=0,i=t._onLoadHooks.length;n<i;n++)t._onLoadHooks[n].call(this)},n._fixPrjOnWorldWide=function(t){var e=this.getProjection();if(e&&e.fullExtent&&t){var n=e.fullExtent||{},i=n.left,r=n.bottom,o=n.top,s=n.right;_c(i)&&(t.x=Math.max(i,t.x)),_c(s)&&(t.x=Math.min(s,t.x)),_c(r)&&(t.y=Math.max(r,t.y)),_c(o)&&(t.y=Math.min(o,t.y))}return this},e}(Ud(Fd(Rm(Bd))));yp.include({coordinateToPoint:function(t,e,n){var i=this._getResolution(e);return this.coordinateToPointAtRes(t,i,n)},coordinateToPointAtRes:(pp=new Zd(0,0),function(t,e,n){var i=this.getProjection().project(t,pp);return this._prjToPointAtRes(i,e,n)}),pointToCoordinate:function(){var t=new Zd(0,0);return function(e,n,i){var r=this._pointToPrj(e,n,t);return this.getProjection().unproject(r,i)}}(),pointAtResToCoordinate:function(){var t=new Zd(0,0);return function(e,n,i){var r=this._pointToPrjAtRes(e,n,t);return this.getProjection().unproject(r,i)}}(),coordinateToViewPoint:function(){var t=new Zd(0,0);return function(e,n,i){return this._prjToViewPoint(this.getProjection().project(e,t),n,i)}}(),viewPointToCoordinate:function(){var t=new Zd(0,0);return function(e,n){return this.getProjection().unproject(this._viewPointToPrj(e,t),n)}}(),coordinateToContainerPoint:function(t,e,n){var i=this._getResolution(e);return this.coordinateToContainerPointAtRes(t,i,n)},coordinateToContainerPointAtRes:function(){var t=new Zd(0,0);return function(e,n,i){var r=this.getProjection().project(e,t);return this._prjToContainerPointAtRes(r,n,i)}}(),coordinatesToContainerPoints:function(t,e){var n=this._getResolution(e);return this.coordinatesToContainerPointsAtRes(t,n)},coordinatesToContainerPointsAtRes:function(t,e){for(var n=[],i=this._spatialReference.getTransformation(),r=e/this._getResolution(),o=this.getProjection(),s=new Zd(0,0),a=this.isTransforming(),h=this._prjToPoint(this._getPrjCenter(),void 0,_p),l=0,c=t.length;l<c;l++){var u=o.project(t[l],s),f=i.transform(u,e);f=f._multi(r),this._toContainerPoint(f,a,r,0,h),n.push(f)}return n},containerPointToCoordinate:function(){var t=new Zd(0,0);return function(e,n){var i=this._containerPointToPrj(e,t);return this.getProjection().unproject(i,n)}}(),containerToExtent:(mp=new fu(0,0),gp=new fu(0,0),function(t){var e=new lm(this._containerPointToPoint(t.getMin(mp),void 0,mp),this._containerPointToPoint(t.getMax(gp),void 0,gp));return this._pointToExtent(e)}),distanceToPixel:function(){var t=new fu(0,0),e=new fu(0,0);return function(n,i,r){var o=this.getProjection();if(!o)return null;var s=this.getScale()/this.getScale(r),a=this.getCenter(),h=o.locate(a,n,i),l=this.coordToContainerPoint(a,void 0,t),c=this.coordToContainerPoint(h,void 0,e);return c._sub(l)._multi(s)._abs(),new Af(c.x,c.y)}}(),distanceToPoint:function(t,e,n,i){var r=this._getResolution(n);return this.distanceToPointAtRes(t,e,r,i)},distanceToPointAtRes:function(){var t=new fu(0,0),e=new Zd(0,0);return function(n,i,r,o,s){var a=this.getProjection();if(!a)return null;var h=o||this.getCenter(),l=a.locate(h,n,i,e),c=this.coordToPointAtRes(h,r,t),u=this.coordToPointAtRes(l,r,s);return u._sub(c)._abs(),u}}(),altitudeToPoint:(fp=new Zd(0,40),dp=new fu(0,0),function(t,e,n){void 0===t&&(t=0);var i=this.distanceToPointAtRes(t,t,e,n||fp,dp);t<0&&i.x>0&&(i.x=-i.x);var r=this.options.heightFactor;return r&&1!==r&&(i.x*=r,i.y*=r),i.x}),pointAtResToAltitude:function(){var t=new Zd(0,40);return function(e,n,i){return void 0===e&&(e=0),this.pointAtResToDistance(e,0,n,i||t)}}(),pixelToDistance:(cp=new Zd(0,0),up=new Zd(0,0),function(t,e){var n=this.getProjection();if(!n)return null;var i=this.getFullExtent(),r=cp.set(this.width/2+t,this.height/2+(i.top>i.bottom?-1:1)*e),o=this.containerPointToCoord(r,up);return n.measureLength(this.getCenter(),o)}),pointToDistance:function(t,e,n){var i=this.getResolution(n);return this.pointAtResToDistance(t,e,i)},pointAtResToDistance:function(){var t=new fu(0,0),e=new Zd(0,0),n=new Zd(0,0),i=new Zd(0,0);return function(r,o,s,a){var h=this.getProjection();if(!h)return null;var l=a?h.project(a,e):this._getPrjCenter(),c=this._prjToPointAtRes(l,s,t);c._add(r,o);var u=this.pointAtResToCoord(c,s,n),f=a||h.unproject(l,i);return h.measureLength(f,u)}}(),locateByPoint:function(){var t=new fu(0,0);return function(e,n,i){var r=this.coordToContainerPoint(e,void 0,t);return this.containerPointToCoord(r._add(n,i))}}(),_get2DExtent:function(t,e){var n;if(void 0!==t&&t!==this._zoomLevel||!this._mapExtent2D||(n=this._mapExtent2D),n)return e?(e.set(n.xmin,n.ymin,n.xmax,n.ymax),e):n.copy();var i=this._getResolution(t);return this._get2DExtentAtRes(i,e)},_get2DExtentAtRes:function(){var t=new fu(0,0);return function(e,n){var i=this;return e===this._mapGlRes&&this._mapGlExtent2D?this._mapGlExtent2D:this.getContainerExtent().convertTo((function(n){return i._containerPointToPointAtRes(n,e,t)}),n)}}(),_pointToExtent:function(){var t=new Zd(0,0),e=new Zd(0,0);return function(n){var i=n.getMin(),r=n.getMax(),o=this.getFullExtent(),s=!o||o.left<=o.right?[i.x,r.x]:[r.x,i.x],a=s[1],h=!o||o.top>o.bottom?[r.y,i.y]:[i.y,r.y],l=h[0],c=i.set(s[0],h[1]),u=r.set(a,l);return new am(this.pointToCoord(c,void 0,t),this.pointToCoord(u,void 0,e),this.getProjection())}}(),_getViewPointFrameOffset:function(){var t=new fu(0,0);return function(){if(this.isZooming())return null;var e=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(e)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(e,void 0,t)):null}}(),_viewPointToPrj:function(){var t=new fu(0,0);return function(e,n){return this._containerPointToPrj(this.viewPointToContainerPoint(e,t),n)}}(),_prjToContainerPoint:function(t,e,n,i){var r=this._getResolution(e);return this._prjToContainerPointAtRes(t,r,n,i)},_prjToContainerPointAtRes:function(){var t=new fu(0,0);return function(e,n,i,r){return this._pointAtResToContainerPoint(this._prjToPointAtRes(e,n,t),n,r||0,i)}}(),_prjToViewPoint:function(){var t=new fu(0,0);return function(e,n,i){var r=this._prjToContainerPoint(e,void 0,t,i);return this.containerPointToViewPoint(r,n)}}(),_viewPointToPoint:function(){var t=new fu(0,0);return function(e,n,i){return this._containerPointToPoint(this.viewPointToContainerPoint(e,t),n,i)}}(),_pointToViewPoint:function(){var t=new Zd(0,0);return function(e,n,i){return this._prjToViewPoint(this._pointToPrj(e,n,t),i)}}()}),yp.mergeOptions(vp);var xp=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},n.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},n._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var n=e.getZoom(),i=t.domEvent.shiftKey?Math.ceil(n)-1:Math.floor(n)+1;e._zoomAnimation(i,t.containerPoint)}},e}(Nd);yp.mergeOptions({doubleClickZoom:!0}),yp.addOnLoadHook("addHandler","doubleClickZoom",xp);var bp=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){var t=this.target;t&&(this._dragHandler=new Xd(t._panels.mapWrapper||t._containerDOM,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable())},n.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},n._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},n._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},n._onMouseDown=function(t){delete this.startDragTime,delete this._mode,2===t.domEvent.button||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),ld(t.domEvent)},n._onDragStart=function(t){this.startDragTime=mc(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},n._onDragging=function(t){this.target._isEventOutMap(t.domEvent)||("move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t))},n._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},n._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY,this._startPrjCenter=this.target._getPrjCenter().copy()},n._moveStart=function(t){this._start(t);var e=this.target;e.onMoveStart(t);var n=dd(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e._containerPointToPrj(n)},n._moving=function(t){if(this.startDragTime){var e=this.target,n=dd(e._getActualEvent(t.domEvent),e.getContainer());e._setPrjCoordAtContainerPoint(this.startPrjCoord,n),e.onMoving(t)}},n._moveEnd=function(t){if(this.startDragTime){var e="touchend"===t.domEvent.type,n=this.target,i=mc()-this.startDragTime,r=t.mousePos.x-this.startX,o=t.mousePos.y-this.startY,s=n._getPrjCenter(),a=s.sub(this._startPrjCenter);if(this._clear(),n.options.panAnimation&&!t.interupted&&n._verifyExtent(n._getPrjCenter())&&i<280&&Math.abs(o)+Math.abs(r)>5){i*=5;var h=s.add(a._multi(e?5:2.8));n._panTo(h,{duration:e?3*i:2*i,easing:"outExpo"})}else n.onMoveEnd(t)}},n._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},n._rotating=function(t){var e=this.target,n=t.mousePos.x,i=t.mousePos.y,r=e.getPitch(),o=e.getBearing(),s=Math.abs(n-this.preX),a=Math.abs(i-this.preY);if(this._rotateMode||(this._rotateMode=e.options.dragRotatePitch?"rotate_pitch":s>a?"rotate":s<a?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===r&&a<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var h=0;h=e.options.dragPitch||s>a?-.6*(this.preX-n):n>e.width/2?.6*(this.preY-i):-.6*(this.preY-i);var l=e.getBearing()+h;this._db=this._db||0,this._db+=h,e._setBearing(l)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e._setPitch(e.getPitch()+.4*(this.preY-i)),this.preX=n,this.preY=i,e.getBearing()===o&&e.getPitch()===r||e.onDragRotating(t)}},n._rotateEnd=function(t){var e=this.target,n=e.getBearing();this._clear();var i=mc()-this.startDragTime;if(e.onDragRotateEnd(t),e.options.rotateAnimation&&Math.abs(n-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&i<400){var r=e.getBearing();e._animateTo({bearing:r+this._db/1.5},{easing:"outQuint",duration:1600})}},n._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(Nd);yp.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),yp.addOnLoadHook("addHandler","draggable",bp);var wp="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",Tp=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){var t=this.target;bd(t._panels.allLayers||t._containerDOM,wp,this._identifyGeometryEvents,this)},n.removeHooks=function(){var t=this.target;wd(t._panels.allLayers||t._containerDOM,wp,this._identifyGeometryEvents)},n._identifyGeometryEvents=function(t,e){var n=this.target;if(!n.isInteracting()&&!n._ignoreEvent(t)){var i=null,r=e||t.type,o="mousedown"===r||"touchstart"===r&&t.touches&&1===t.touches.length;if(o)this._mouseDownTime=mc();else if(("click"===r||"touchend"===r)&&this._mouseDownTime){var s=this._mouseDownTime;if(delete this._mouseDownTime,mc()-s>300){if("click"===r)return}else"touchend"===r&&(i="click")}var a=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(a){var h=dd(a,n._containerDOM);"touchstart"===r&&ld(t);for(var l=null,c=this.target.getRenderer().getTopElements(),u=o&&2!==t.button,f=0;f<c.length;f++)if(c[f].hitTest(h)){var d=c[f].options.cursor;if(d&&(l=d),u||c[f].events&&c[f].events.indexOf(r)>=0){var m={target:n,type:r,domEvent:t,containerPoint:h};if(u)return n._setPriorityCursor(l),void c[f].mousedown(m);c[f].onEvent(m)}}var g=n._getLayers((function(t){return!(!t.identify||!t.options.geometryEvents)}));if(n._setPriorityCursor(l),g.length){var p={includeInternals:!0,filter:function(e){if(!(e instanceof sp))return!1;var n=e._getEventTypeToFire(t);if("mousemove"===r){if(!l&&e.options.cursor&&(l=e.options.cursor),!e.listens("mousemove")&&!e.listens("mouseover")&&!e.listens("mouseenter"))return!1}else if(!e.listens(n)&&!e.listens(i))return!1;return!0},count:1,containerPoint:h,onlyVisible:n.options.onlyVisibleGeometryEvents,layers:g},_=function(e){var o=!0;if("mousemove"===r){var s={};if(e.length>0)for(var a=e.length-1;a>=0;a--){var h=e[a];if(h instanceof sp){var c=h._getInternalId();s[c]=h,h._onEvent(t),this._prevOverGeos&&this._prevOverGeos.geomap[c]||h._onEvent(t,"mouseenter"),o=h._onEvent(t,"mouseover")}}n._setPriorityCursor(l);var u=this._prevOverGeos&&this._prevOverGeos.geos;if(this._prevOverGeos={geos:e,geomap:s},u&&u.length>0)for(var f=u.length-1;f>=0;f--){var d=u[f];d instanceof sp&&(s[u[f]._getInternalId()]||(o=d._onEvent(t,"mouseout")))}}else{if(!e||!e.length)return;for(var m=e.length-1;m>=0;m--)if(e[m]instanceof sp){o=e[m]._onEvent(t),i&&e[m]._onEvent(t,i);break}}!1===o&&cd(t)}.bind(this);"mousemove"===r||"touchmove"===r?this._queryIdentifyTimeout=n.getRenderer().callInNextFrame((function(){n.isInteracting()||n.identifyAtPoint(p,_)})):n.identifyAtPoint(p,_)}}}},e}(Nd);yp.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),yp.addOnLoadHook("addHandler","geometryEvents",Tp);var Mp=function(t){function e(e){var n;return(n=t.call(this,e)||this)._thisScrollZoom=n._scrollZoom.bind(hu(hu(n))),n._wheelZoomRate=1/450,n._defaultZoomRate=.01,n._delta=0,n}au(e,t);var n=e.prototype;return n.addHooks=function(){sd(this.target._containerDOM,"wheel",this._onWheelScroll,this)},n.removeHooks=function(){ad(this.target._containerDOM,"wheel",this._onWheelScroll)},n._onWheelScroll=function(t){ld(t),cd(t);var e=this.target;if(e._ignoreEvent(t)||!e.options.zoomable)return!1;var n=e._checkZoomOrigin(dd(t,e._containerDOM));return e.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(t,n)):this._interval(t,n)},n._seamless=function(t,e){var n=t.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*t.deltaY:t.deltaY;if(n%4.000244140625!=0&&(this._ensureTrackpad||(Math.abs(n)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(n*=14)),t.shiftKey&&n&&(n/=4),this._lastWheelEvent=t,this._delta-=n,!this._zooming&&this._delta){var i=this.target;this._zoomOrigin=e,i.onZoomStart(null,e)}this._start()},n._start=function(){this._delta&&(this._zooming=!0,this._active||(this.target.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0))},n._scrollZoom=function(){var t=this;if(this._active=!1,this._delta){var e=Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate,n=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==n&&(n=1/n);var i=this.target,r=i.getZoom(),o=i.getZoomForScale(n,r,!0);this._delta=0,i.onZooming(o,this._zoomOrigin),this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout((function(){t._zooming=!1,delete t._timeout,i.onZoomEnd(i.getZoom(),t._zoomOrigin)}),210)}},n._interval=function(t,e){var n=this,i=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var r=(t.deltaY?-1*t.deltaY:t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(r*=-1);var o=i.getZoom(),s=o+r;return(s=i._checkZoom(r>0?Math.ceil(s):Math.floor(s)))===o||(this._zooming=!0,this._delta||(i.onZoomStart(null,e),this._origin=e,this._delta=r,this._startZoom=i.getZoom()),i._animateTo({zoom:s-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},(function(e){"finished"===e.state.playState?n._requesting<1||Math.abs(s-n._startZoom)>2||s===i.getMaxZoom()||s===i.getMinZoom()?(i._animateTo({zoom:s,around:n._origin},{continueOnViewChanged:!0,duration:100},(function(t){"running"!==t.state.playState&&(delete n._zooming,delete n._requesting)})),delete n._startZoom,delete n._origin,delete n._delta,n._requesting=0):pc(n._requesting)||(delete n._zooming,n._onWheelScroll(t)):"running"!==e.state.playState&&(delete n._zooming,delete n._requesting)}))),!1},e}(Nd);yp.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),yp.addOnLoadHook("addHandler","scrollWheelZoom",Mp);var Ap=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){sd(this.target.getContainer(),"touchstart",this._onTouchStart,this)},n.removeHooks=function(){ad(this.target.getContainer(),"touchstart",this._onTouchStart)},n._onTouchStart=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var n=e.getContainer(),i=dd(t.touches[0],n),r=dd(t.touches[1],n);this.preY=i.y,this._startP1=i,this._startP2=r,this._startDist=i.distanceTo(r),this._startVector=i.sub(r),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),wd(document,"touchmove",this._onTouchMove),wd(document,"touchend",this._onTouchEnd),sd(document,"touchmove",this._onTouchMove,this),sd(document,"touchend",this._onTouchEnd,this),ld(t),e._fireEvent("touchactstart")}},n._onTouchMove=function(t){var e=this.target;if(t.touches&&!(t.touches.length<2)){var n=e.getContainer(),i=dd(t.touches[0],n),r=dd(t.touches[1],n),o=i.sub(this._startP1),s=r.sub(this._startP2),a=i.sub(r),h=i.distanceTo(r)/this._startDist,l=180*a.angleWith(this._startVector)/Math.PI,c=.4*((this.preY||i.y)-i.y);this.preY=i.y;var u={domEvent:t,mousePos:[i,r]};if(this.mode||(e.options.touchRotate&&Math.abs(l)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&o.y*s.y>0&&Math.abs(o.y)>10&&Math.abs(s.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-h)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(u)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=h;var f=e._getResolution(this._startZoom)/h,d=e.getZoomFromRes(f);e.onZooming(d,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e._setBearing(this._startBearing+l),e.onDragRotating(u)):"pitch"===this.mode&&(e._setPitch(e.getPitch()+c),e.onDragRotating(u)),e._fireEvent("touchactinging")}},n._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var n=e.getSize();this._Origin=new fu(n.width/2,n.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},n._onTouchEnd=function(t){delete this.preY;var e=this.target;if(wd(document,"touchmove",this._onTouchMove),wd(document,"touchend",this._onTouchEnd),"zoom"===this.mode||"rotate_zoom"===this.mode){var n=this._scale,i=e._getResolution(this._startZoom)/n,r=e.getZoomFromRes(i);e.onZoomEnd(r,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(Nd);yp.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),yp.addOnLoadHook("addHandler","touchGesture",Ap);var Ep="__anim_player",Cp={outExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},outQuint:function(t){return 1-Math.pow(1-t,5)},in:function(t){return Math.pow(t,2)},out:function(t){return 1-Cp.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?Cp.inAndOut(2*t):1-Cp.inAndOut(2*(t-.5))}},Sp=function(t,e){this.state=t,this.styles=e},Pp=function(t,e,n,i){this._animation=t,this.options=e,this._onFrame=n,this.playState="idle",this.ready=!0,this.finished=!1,this.target=i},Rp={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return Rp._resolveStyles(t);for(var e=[],n=[],i=[],r=0;r<t.length;r++){var o=Rp._resolveStyles(t[r]);o&&(e.push(o[0]),n.push(o[1]),i.push(o[2]))}return e.length?[e,n,i]:null}function n(t){var e,n=t;Array.isArray(t)||(n=_c(t)?[0,t]:t instanceof fu||t instanceof Zd?[new(e=t.constructor)(0,0),t]:[t,t]);var i=n[0],r=n[1];return _c(i)&&_c(r)?i===r?null:[i,r-i,r]:Array.isArray(i)&&_c(i[0])||i instanceof Zd||i instanceof fu?(Array.isArray(i)?(i=new Zd(i),r=new Zd(r)):(i=new(e=i.constructor)(i),r=new e(r)),i.equals(r)?null:[i,r.sub(i),r]):[i,r,r]}var i,r={},o={},s={};for(var a in t)if(t.hasOwnProperty(a)){var h=t[a];if(!h)continue;if(Array.isArray(h)&&(pc(h[0])||pc(h[1])))continue;var l=void 0;i=h,(l=!Array.isArray(i)&&i.constructor===Object||Array.isArray(i)&&i[0].constructor===Object?e(h):n(h))&&(o[a]=l[0],r[a]=l[1],s[a]=l[2])}return[o,r,s]},framing:function(t,e){e||(e={});var n,i,r,o=e.easing?Cp[e.easing]:Cp.linear;return o||(o=Cp.linear),(t=Rp._resolveStyles(t))&&(i=t[0],n=t[1],r=t[2]),function(t,e){var s,a;if(t<0)s={playState:"idle",delta:0},a=i;else if(t<e){var h=o(t/e);s={playState:"running",delta:h},a=function t(e,n,i){if(!n||!i)return null;var o={};for(var s in i)if(i.hasOwnProperty(s)){if(n[s]===r[s]){o[s]=n[s];continue}var a=n[s],h=i[s];if(_c(h))o[s]=a+e*h;else if(Array.isArray(h)){for(var l=[],c=0;c<h.length;c++)l.push(t(e,a[c],h[c]));o[s]=l}else o[s]=h.constructor===Object?t(e,a,h):a instanceof fu||a instanceof Zd?a.add(h.multi(e)):h}return o}(h,i,n)}else s={playState:"finished",delta:1},a=r;return s.startStyles=i,s.destStyles=r,s.progress=t,s.remainingMs=e-t,new Sp(s,a)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=lu(Rp._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,n=t.length;e<n;e++)t[e]();this._frameQueue.length?this._animationFrameId=lu(Rp._frameFn):delete this._animationFrameId}},animate:function(t,e,n,i){e||(e={});var r=Rp.framing(t,e);return new Pp(r,e,n,i)}};Rp._frameFn=Rp._run.bind(Rp),gc(Pp.prototype,{_prepare:function(){var t=this.options,e=t.speed||t.duration;xc(e)&&((e=Rp.speed[e])||(e=+e)),e||(e=Rp.speed.normal),this.duration=e,this._framer=t.framer||Rp._requestAnimFrame.bind(Rp)},play:function(){if("idle"!==this.playState&&"paused"!==this.playState||this.target&&this.target[Ep])return this;this.target&&(this.target[Ep]=1),"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=mc();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},pause:function(){return"paused"===this.playState||(this.playState="paused",this._run()),this},cancel:function(){return"idle"===this.playState||(this.playState="idle",this.finished=!1,this._run()),this},finish:function(){return"finished"===this.playState||(this.playState="finished",this.finished=!0,this._run()),this},reverse:function(){},_run:function(){var t=this,e=this._onFrame,n=mc(),i=n-this._playStartTime;if(this.options.repeat&&i>=this.duration&&(this._playStartTime=n,i=0),"running"===this.playState){var r=this._animation(i,this.duration);this.playState=r.state.playState,"running"!==this.playState&&this.target&&delete this.target[Ep],"idle"===this.playState?this.startTime>n&&setTimeout(this._run.bind(this),this.startTime-n):"running"===this.playState?this._framer((function(){"running"===t.playState&&(t.currentTime=i,e&&e(r),t._run())})):"finished"===this.playState&&(this.finished=!0,e&&e(r))}else if(this.target&&delete this.target[Ep],e){"finished"===this.playState?i=this.duration:"idle"===this.playState&&(i=0);var o=this._animation(i,this.duration);o.state.playState=this.playState,e(o)}}});var Op=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.animateShow=function(t,e){var n=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.finish(),bc(t)&&(e=t={});var i=this.getCoordinates();if(0===i.length)return this;this._animIdx=0,this._animLenSoFar=0,this.show();var r=this.getShell?this.getShell().concat(this.getShell()[0]):i,o=this._getProjection(),s=o.projectCoords(r,this.options.antiMeridian);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=o.unproject(this._prjAniShowCenter);var a=t.duration||1e3,h=t.easing||"out";this.setCoordinates([]);var l=0;s.length&&(s[0]._distance=0);for(var c=1;c<s.length;c++){var u=s[c].distanceTo(s[c-1]);s[c]._distance=u,l+=u}this._tempCoord=new Zd(0,0),this._tempPrjCoord=new fu(0,0);var f=this._showPlayer=Rp.animate({t:a},{duration:a,easing:h},(function(t){if(n.getMap()){var o=n._drawAnimShowFrame(t.styles.t,a,l,r,s);"finished"===t.state.playState&&(delete n._showPlayer,delete n._aniShowCenter,delete n._prjAniShowCenter,delete n._animIdx,delete n._animLenSoFar,delete n._animTailRatio,delete n._tempCoord,delete n._tempPrjCoord,n.setCoordinates(i)),e&&e(t,o)}else if("finished"!==f.playState&&(f.finish(),e)){var h=n.getCoordinates();e(t,h[h.length-1])}}),this);return f.play(),f},n._drawAnimShowFrame=function(t,e,n,i,r){if(0===t)return i[0];var o,s,a=t/e*n,h=0;for(o=this._animIdx+1,s=r.length;o<s&&!(this._animLenSoFar+(h=r[o]._distance)>a);o++)this._animLenSoFar+=h;if(this._animIdx=o-1,this._animIdx>=s-1)return this.setCoordinates(i),i[i.length-1];var l=this._animIdx,c=r[l],u=r[l+1],f=(a-this._animLenSoFar)/h;this._animTailRatio=f;var d=c.y+(u.y-c.y)*f;this._tempPrjCoord.x=c.x+(u.x-c.x)*f,this._tempPrjCoord.y=d;var m=this._tempPrjCoord,g=i[l],p=i[l+1],_=g.y+(p.y-g.y)*f;this._tempCoord.x=g.x+(p.x-g.x)*f,this._tempCoord.y=_;var v=this._tempCoord,y=!!this.getShell;if(!y&&this.options.smoothness>0){for(var x=[],b=[],w=0;w<=this._animIdx;w++)x.push(i[w]),b.push(r[w]);x.push(v,v),b.push(m,m),this.setCoordinates(x),this._setPrjCoordinates(b)}else{var T=i.slice(0,this._animIdx+1);T.push(v);var M=r.slice(0,this._animIdx+1);M.push(m),y?(this.setCoordinates([this._aniShowCenter].concat(T)),this._setPrjCoordinates([this._prjAniShowCenter].concat(M))):(this.setCoordinates(T),this._setPrjCoordinates(M))}return v},n._getCenterInExtent=function(t,e,n){var i=this.getExtent();if(!t.intersects(i))return null;var r=n(e,t);if(0===r.length)return null;var o=0,s=0,a=0;r.forEach((function(t){Array.isArray(t)?t.forEach((function(t){t.point&&(t=t.point),o+=t.x,s+=t.y,a++})):(t.point&&(t=t.point),o+=t.x,s+=t.y,a++)}));var h=new Zd(o,s)._multi(1/a);return h.count=a,h},n._getPath2DPoints=function(t,e,n){if(!Su(t))return[];var i=this.getMap(),r=!e&&this._shouldSimplify(),o=this.options.simplifyTolerance*i._getResolution(),s=Array.isArray(t[0]);if(delete this._simplified,r&&!s){var a=t.length;t=ec(t,o,!1),this._simplified=t.length<a}if(n||(n=i._getResolution()),Array.isArray(t)){var h=[];if(!Array.isArray(t[0]))return h=Gu(t,"_glPt"),i._prjsToPointsAtRes(t,n,h);for(var l=[],c=0,u=t.length;c<u;c++){var f=t[c];h=Gu(f,"_glPt");var d=i._prjsToPointsAtRes(f,n,h);l.push(d)}return l}return i._prjToPointAtRes(t,n)},n._shouldSimplify=function(){var t=this.getLayer(),e=this.getProperties(),n=e&&t.options.enableAltitude&&!pc(e[t.options.altitudeProperty])&&0!==e[t.options.altitudeProperty];return t&&t.options.enableSimplify&&!n&&this.options.enableSimplify&&!this._showPlayer},n._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},n._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},n._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},n._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},n._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t,this.options.antiMeridian):[]},n._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},n._computeCenter=function(){var t=this._coordinates;if(!Su(t))return null;for(var e=0,n=0,i=0,r=t.length,o=0;o<r;o++)t[o]&&_c(t[o].x)&&_c(t[o].y)&&(e+=t[o].x,n+=t[o].y,i++);return new Zd(e/i,n/i)},n._computeExtent=function(){var t=this._coordinates;if(!Su(t))return null;var e=[t];return this.hasHoles&&this.hasHoles()&&e.push.apply(e,this.getHoles()),this._coords2Extent(e,this._getProjection())},n._computePrjExtent=function(){var t=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&t.push.apply(t,this._getPrjHoles()),this._coords2Extent(t)},n._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,n=1,i=t.length;n<i;n++)e+=t[n].distanceTo(t[n-1]);return e},n._hitTestTolerance=function(){var e,n=this._getInternalSymbol();if(Array.isArray(n)){e=0;for(var i=0;i<n.length;i++)_c(n[i].lineWidth)&&n[i].lineWidth>e&&(e=n[i].lineWidth)}else e=n.lineWidth;return t.prototype._hitTestTolerance.call(this)+(_c(e)?e/2:1.5)},n._coords2Extent=function(t,e){if(!t||0===t.length||Array.isArray(t[0])&&0===t[0].length)return null;for(var n=new am(e),i=0,r=t.length;i<r;i++)for(var o=0,s=t[i].length;o<s;o++)n._combine(t[i][o]);return n},e}(sp);Op.mergeOptions({smoothness:0,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var Ip=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="Polygon",e&&i.setCoordinates(e),i}au(e,t);var n=e.prototype;return n.getOutline=function(){return this._getPainter()?new e(this.getExtent().toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}}):null},n.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=Zd.toCoordinates(t),n=e.length;if(Array.isArray(e[0])){if(this._coordinates=this._trimRing(e[0]),n>1){for(var i=[],r=1;r<n;r++)e[r]&&i.push(this._trimRing(e[r]));this._holes=i}}else this._coordinates=this._trimRing(e);return this._projectRings(),this},n.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],n=0,i=t.length;n<i;n++)e.push(this._copyAndCloseRing(t[n]));return e},n.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),yg)},n.getShell=function(){return this._coordinates||[]},n.getHoles=function(){return this._holes||[]},n.hasHoles=function(){return this.getHoles().length>0},n._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},n._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},n._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},n._checkRing=function(t){if(this._cleanRing(t),!t||!Su(t))return!1;var e=t[t.length-1],n=!0;return t[0].x===e.x&&t[0].y===e.y||(n=!1),n},n._trimRing=function(t){var e=this._checkRing(t);return Su(t)&&e&&t.splice(t.length-1,1),t},n._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return Su(t)&&!e?(t.push(t[0].copy()),t):t},n._getPrjShell=function(){return"Polygon"===this.getJSONType()?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this.getShell())),this._prjShell)},n._getPrjHoles=function(){var t=this._getProjection();return this._verifyProjection(),t&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},n._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!Su(e))return 0;for(var n=0,i=0,r=e.length;i<r;i++)n+=t.measureLength(e[i]);return n},n._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!Su(e))return 0;for(var n=t.measureArea(e[0]),i=1,r=e.length;i<r;i++)n-=t.measureArea(e[i]);return n},n._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},n._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},n._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(Op);function Dp(t){return function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(t){var e=t instanceof Zd?t:new Zd(t);if(e.equals(this._coordinates))return this;if(this._coordinates=e,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var n=this._getProjection();return this._setPrjCoordinates(n.project(this._coordinates)),this},n._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var n=this._getPrjCoordinates();return n?(t||(t=e._getResolution()),e._prjToPointAtRes(n,t)):null},n._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pcenter&&t&&this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter},n._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},n._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},n._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},n._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)}Ip.registerJSONType("Polygon");var kp=new lm,Lp=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="Point",e&&i.setCoordinates(e),i}au(e,t);var n=e.prototype;return n.getOutline=function(){var t=this.getCoordinates(),n=this.getContainerExtent(),i=this.getMap().coordToContainerPoint(t);return new e(t,{symbol:{markerType:"square",markerWidth:n.getWidth(),markerHeight:n.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:n.xmin-(i.x-n.getWidth()/2),markerDy:n.ymin-(i.y-n.getHeight()/2)}})},n.setSymbol=function(){var e;delete this._fixedExtent;for(var n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.prototype.setSymbol).call.apply(e,[this].concat(i))},n._getSizeSymbol=function(t){for(var e,n={},i=!1,r=!1,o=0;o<gg.length;o++){var s=t[gg[o]];pc(s)||(!i&&$u(s)&&(i=!0,r=!0),n[gg[o]]=s)}for(var a=0;a<pg.length;a++){var h=t[pg[a]];pc(h)||(!i&&$u(h)&&(i=!0),n[pg[a]]=h)}return i?(e=yf(n,this),r&&(e._dynamic=!0)):e=n,e},n._setExternSymbol=function(e){return this._symbol||delete this._fixedExtent,t.prototype._setExternSymbol.call(this,e)},n._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},n._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new lm,this._fixedExtent.set(null,null,null,null);var t=this._sizeSymbol;if(!t)return this._fixedExtent;var e=this.getLayer()&&this.getLayer().getRenderer(),n=e&&e.resources,i=this.getTextDesc();if(Array.isArray(t)){kp.set(1/0,1/0,-1/0,-1/0);for(var r=0;r<t.length;r++)t[r]&&this._fixedExtent._combine(lg(kp,t[r],n,i&&i[r]))}else this._fixedExtent=lg(this._fixedExtent,t,n,i);return this._fixedExtent},n._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&fg(t)},n._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(fg(t)||dg(t)||ug(t))},n._containsPoint=function(e,n){var i=this.getContainerExtent();return n&&(i=i.expand(n)),!!i.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,n))},n._computeExtent=function(){return Fp.call(this,"getCenter")},n._computePrjExtent=function(){return Fp.call(this,"_getPrjCoordinates")},n._computeGeodesicLength=function(){return 0},n._computeGeodesicArea=function(){return 0},n._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new $g(this).getSprite(t,e)},e}(Dp(sp));function Fp(t){var e=this[t]();return e?new am(e,e,this._getProjection()):null}Lp.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1}),Lp.registerJSONType("Marker");var Np=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="LineString",e&&i.setCoordinates(e),i}au(e,t);var n=e.prototype;return n.getOutline=function(){return Ip.prototype.getOutline.call(this)},n.setCoordinates=function(t){return t?(this._coordinates=Zd.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},n.getCoordinates=function(){return this._coordinates||[]},n.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),_g)},n._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},n._computeGeodesicArea=function(){return 0},e}(Op);Np.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),Np.registerJSONType("LineString");var Bp=new lm,Hp=function(t){function e(e,n){var i;return(i=t.call(this,n)||this).type="GeometryCollection",i.setGeometries(e),i}au(e,t);var n=e.prototype;return n.getContainerExtent=function(t){var e=t||new lm;return this.forEach((function(t){e._combine(t.getContainerExtent(Bp))})),e},n.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),n=this._getSymbol(),i=this.config(),r=e.length-1;r>=0;r--)e[r]._initOptions(i),e[r]._setParent(this),e[r]._setEventParent(this),n&&e[r].setSymbol(n);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},n.getGeometries=function(){return this._geometries||[]},n.forEach=function(t,e){for(var n=this.getGeometries(),i=0,r=n.length;i<r;i++)n[i]&&(e?t.call(e,n[i],i):t(n[i],i));return this},n.filter=function(t,n){if(!t)return new e;var i=[],r=bc(t),o=r?t:sf(t);return this.forEach((function(t){var e=r?t:gf(t);(n?o.call(n,e):o(e))&&i.push(t)}),this),new e(i)},n.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach((function(t){t&&t.translate&&t.translate.apply(t,e)})),this},n.isEmpty=function(){return!Su(this.getGeometries())},n.remove=function(){return this.forEach((function(t){t._unbind()})),sp.prototype.remove.apply(this,arguments)},n.show=function(){return this.options.visible=!0,this.forEach((function(t){t.show()})),this},n.hide=function(){return this.options.visible=!1,this.forEach((function(t){t.hide()})),this},n.onConfig=function(t){this.forEach((function(e){e.config(t)}))},n.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var n=[],i=!1;this.forEach((function(t){t.getSymbol()&&!i&&(i=!0),n.push(t.getSymbol())})),i&&(e={children:n})}return e},n.setSymbol=function(t){if(t&&t.children)this._symbol=null,this.forEach((function(e,n){e.setSymbol(t.children[n])}));else{var e=this._prepareSymbol(t);this._symbol=e,this.forEach((function(t){t.setSymbol(e)}))}return this.onSymbolChanged(),this},n._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach((function(e){e._setExternSymbol(t)})),this.onSymbolChanged(),this},n._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},n._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach((function(e){e._bindLayer(t)}))},n._checkGeometries=function(t){if(t&&!Array.isArray(t)){if(t instanceof sp)return[t];throw new Error("The geometry added to collection is invalid.")}for(var e=0,n=t.length;e<n;e++)if(!this._checkGeo(t[e]))throw new Error("The geometry added to collection is invalid. Index: "+e);return t},n._checkGeo=function(t){return t instanceof sp},n._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach((function(t){t&&t._updateCache&&t._updateCache()}))},n._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach((function(t){t._removePainter()}))},n._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,n=0,i=0,r=this.getGeometries(),o=0,s=r.length;o<s;o++)if(r[o]){var a=r[o]._computeCenter(t);a&&(e+=a.x,n+=a.y,i++)}return 0===i?null:new Zd(e/i,n/i)},n._containsPoint=function(t,e){if(this.isEmpty())return!1;delete this._pickGeometryIndex;for(var n=this.getGeometries(),i=0,r=n.length;i<r;i++)if(n[i]._containsPoint(t,e))return this._pickGeometryIndex=i,!0;return!1},n._computeExtent=function(t){return jp.call(this,t,"_computeExtent")},n._computePrjExtent=function(t){return jp.call(this,t,"_computePrjExtent")},n._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),n=0,i=0,r=e.length;i<r;i++)e[i]&&(n+=e[i]._computeGeodesicLength(t));return n},n._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),n=0,i=0,r=e.length;i<r;i++)e[i]&&(n+=e[i]._computeGeodesicArea(t));return n},n._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),n=0,i=e.length;n<i;n++)e[n]&&t.push(e[n]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},n._toJSON=function(t){var e,n={type:"Feature",geometry:{type:"GeometryCollection",geometries:this.getGeometries().filter((function(t){return t&&t._toJSON})).map((function(t){var e=t._toJSON();return e.subType?e:t._exportGeoJSONGeometry()}))}},i=this.getId();return pc(i)||(n.id=i),(pc(t.properties)||t.properties)&&(e=this._exportProperties()),n.properties=e,t.feature=n,t},n._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,n=t.length;e<n;e++)t[e]&&t[e]._clearProjection()},n._getConnectPoints=function(){var t=this.getExtent();return[new Zd(t.xmin,t.ymax),new Zd(t.xmax,t.ymin),new Zd(t.xmin,t.ymin),new Zd(t.xmax,t.ymax)]},n._getExternalResources=function(){if(this.isEmpty())return[];for(var t,e,n=this.getGeometries(),i=[],r={},o=0,s=n.length;o<s;o++)if(n[o])for(var a=0,h=(t=wf(n[o]._getInternalSymbol())).length;a<h;a++)r[e=t[a].join()]||(i.push(t[a]),r[e]=1);return i},n.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var n=this.getGeometries(),i=0,r=n.length;i<r;i++)n[i].startEdit(t);return this._editing=!0,this.hide(),setTimeout((function(){e.fire("editstart")}),1),this},n.endEdit=function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,n=t.length;e<n;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},n.isEditing=function(){return!!this._editing},e}(sp);function jp(t,e){if(this.isEmpty())return null;for(var n=new am,i=this.getGeometries(),r=0,o=i.length;r<o;r++)if(i[r]){var s=i[r][e](t);s&&n._combine(s)}return n}Hp.registerJSONType("GeometryCollection");var zp=function(t){function e(e,n,i,r){var o;return(o=t.call(this,null,r)||this).GeometryType=e,o.type=n,o._initData(i),o}au(e,t);var n=e.prototype;return n.getCoordinates=function(){for(var t=[],e=this.getGeometries(),n=0,i=e.length;n<i;n++){var r=e[n];t.push(r.getShell&&"Polygon"!==r.getJSONType()?[r.getShell()]:r.getCoordinates())}return t},n.setCoordinates=function(t){for(var e=[],n=0,i=(t=t||[]).length;n<i;n++){var r=new this.GeometryType(t[n],this.config());e.push(r)}return this.setGeometries(e),this},n._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},n._checkGeo=function(t){return t instanceof this.GeometryType},n._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=Zd.toNumberArrays(t);return{type:this.getType(),coordinates:e}},n._toJSON=function(t){return{feature:this.toGeoJSON(t)}},e}(Hp),Gp=function(t){function e(e,n){return t.call(this,Lp,"MultiPoint",e,n)||this}return au(e,t),e.prototype.findClosest=function(t){if(!t)return null;var e=this.getCoordinates(),n=null,i=1/0;return e.forEach((function(e){var r,o,s,a,h=(s=(o=t).x-(r=e).x,a=o.y-r.y,Math.sqrt(s*s+a*a));h<i&&(n=e,i=h)})),n},e}(zp);Gp.registerJSONType("MultiPoint");var Up=function(t){function e(){return t.apply(this,arguments)||this}return au(e,t),e.prototype.getCenterInExtent=function(t){var e=this.getGeometries(),n=0,i=0,r=0;return e.forEach((function(e){var o=e.getCenterInExtent(t);o&&(n+=o.x*o.count,i+=o.y*o.count,r+=o.count)})),0===r?null:new Zd(n,i)._multi(1/r)},e}(zp),Vp=function(t){function e(e,n){return t.call(this,Np,"MultiLineString",e,n)||this}return au(e,t),e}(Up);Vp.registerJSONType("MultiLineString");var Wp=function(t){function e(e,n){return t.call(this,Ip,"MultiPolygon",e,n)||this}return au(e,t),e}(Up);Wp.registerJSONType("MultiPolygon");var Xp={Marker:Lp,LineString:Np,Polygon:Ip,MultiPoint:Gp,MultiLineString:Vp,MultiPolygon:Wp},Zp={toGeometry:function(t,e){if(xc(t)&&(t=vu(t)),Array.isArray(t)){for(var n=[],i=0,r=t.length;i<r;i++){var o=Zp._convert(t[i],e);Array.isArray(o)?yu(n,o):n.push(o)}return n}return Zp._convert(t,e)},_convert:function(t,e){if(!t||pc(t.type))return null;var n=t.type;if("Feature"===n){var i=Zp._convert(t.geometry);return i?(i.setId(t.id),i.setProperties(t.properties),e&&e(i),i):null}if("FeatureCollection"===n){var r=t.features;return r?Zp.toGeometry(r,e):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(n)>=0){var o=new Xp["Point"===n?"Marker":n](t.coordinates);return e&&e(o),o}if("GeometryCollection"===n){var s=t.geometries;if(!Su(s)){var a=new Hp;return e&&e(a),a}for(var h=[],l=s.length,c=0;c<l;c++)h.push(s[c].subType?sp.getJSONClass(s[c].subType).fromJSON(s[c]):Zp._convert(s[c]));var u=new Hp(h);return e&&e(u),u}return null}},qp=function(t){function e(e,n,i){var r;return r=t.call(this,null,i)||this,e&&r.setCoordinates(e),r._radius=n,r}au(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.radius,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getRadius=function(){return this._radius},n.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},n.getShell=function(){for(var t,e,n,i=this._getMeasurer(),r=this.getCoordinates(),o=this.options.numberOfShellPoints,s=this.getRadius(),a=[],h=0,l=o-1;h<l;h++){t=360*h/l*Math.PI/180,e=s*Math.cos(t),n=s*Math.sin(t);var c=i.locate(r,e,n);a.push(c)}return a.push(a[0]),a},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(e,n){var i=this.getMap();if(i.getPitch())return t.prototype._containsPoint.call(this,e,n);var r=i._pointToContainerPoint(this._getCenter2DPoint()),o=this.getSize(),s=pc(n)?this._hitTestTolerance():n,a=r.add(o.width/2,o.height/2);return wg(e,r,a,s)},n._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var n=this._getPrjCoordinates(),i=e.map((function(e){return t.project(e)})),r=i[1].x-n.x,o=i[3].y-n.y;return new am(n.add(i[0].x-n.x,i[2].y-n.y),n.add(r,o))},n._computeExtent=function(t){var e=this._getMinMax(t);return e?new am(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},n._getMinMax=function(t){if(!t||!this._coordinates||pc(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},n._computeGeodesicLength=function(){return pc(this._radius)?0:2*Math.PI*this._radius},n._computeGeodesicArea=function(){return pc(this._radius)?0:Math.PI*Math.pow(this._radius,2)},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:Zd.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=this.getCenter(),n=gc({},t);n.geometry=!1;var i=this.toGeoJSON(n);return i.geometry={type:"Polygon"},{feature:i,subType:"Circle",coordinates:[e.x,e.y],radius:this.getRadius()}},e}(Dp(Ip));qp.mergeOptions({numberOfShellPoints:60}),qp.registerJSONType("Circle");var Yp=function(t){function e(e,n,i,r){var o;return o=t.call(this,null,r)||this,e&&o.setCoordinates(e),o.width=n,o.height=i,o}au(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.width,t.height,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getWidth=function(){return this.width},n.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},n.getHeight=function(){return this.height},n.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},n.getShell=function(){for(var t,e,n,i,r=this._getMeasurer(),o=this.getCoordinates(),s=this.options.numberOfShellPoints,a=this.getWidth(),h=this.getHeight(),l=[],c=Math.pow(a/2,2)*Math.pow(h/2,2),u=Math.pow(a/2,2),f=Math.pow(h/2,2),d=0;d<s;d++){e=(t=360*d/s)*Math.PI/180,n=Math.sqrt(c/(u*Math.pow(Math.tan(e),2)+f)),i=Math.sqrt(c/(f*Math.pow(1/Math.tan(e),2)+u)),t>90&&t<270&&(n*=-1),t>180&&t<360&&(i*=-1);var m=r.locate(o,n,i);l.push(m)}return l},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return t.prototype._containsPoint.call(this,e,n);var r=i.getProjection(),o=pc(n)?this._hitTestTolerance():n,s=r.projectCoords([this._coordinates,i.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)],this.options.antiMeridian);return wg(e,i._prjToContainerPoint(s[0]),i._prjToContainerPoint(s[1]),o)},n._computePrjExtent=function(){return qp.prototype._computePrjExtent.apply(this,arguments)},n._computeExtent=function(){return qp.prototype._computeExtent.apply(this,arguments)},n._getMinMax=function(t){if(!t||!this._coordinates||pc(this.width)||pc(this.height))return null;var e=this.getWidth(),n=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-n/2),t.locate(this._coordinates,0,n/2)]},n._computeGeodesicLength=function(){return pc(this.width)||pc(this.height)?0:2*Math.PI*(this.width>this.height?this.width:this.height)/2-4*Math.abs(this.width-this.height)},n._computeGeodesicArea=function(){return pc(this.width)||pc(this.height)?0:Math.PI*this.width*this.height/4},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:Zd.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=gc({},t),n=this.getCenter();e.geometry=!1;var i=this.toGeoJSON(e);return i.geometry={type:"Polygon"},{feature:i,subType:"Ellipse",coordinates:[n.x,n.y],width:this.getWidth(),height:this.getHeight()}},e}(Dp(Ip));Yp.mergeOptions({numberOfShellPoints:80}),Yp.registerJSONType("Ellipse");var Kp=function(t){function e(e,n,i,r){var o;return o=t.call(this,null,r)||this,e&&o.setCoordinates(e),o._width=n,o._height=i,o}au(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.width,t.height,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getCoordinates=function(){return this._coordinates},n.setCoordinates=function(t){if(this._coordinates=t instanceof Zd?t:new Zd(t),!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var e=this._getProjection();return this._setPrjCoordinates(e.project(this._coordinates)),this},n.getWidth=function(){return this._width},n.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},n.getHeight=function(){return this._height},n.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},n.getShell=function(){var t=this._getMeasurer(),e=this._coordinates,n=this.getMap(),i=1,r=-1;if(n){var o=n.getFullExtent();o.left>o.right&&(i=-1),o.bottom>o.top&&(r=1)}var s=[];return s.push(e),s.push(t.locate(e,i*this._width,0)),s.push(t.locate(e,i*this._width,r*this._height)),s.push(t.locate(e,0,r*this._height)),s.push(e),s},n.getHoles=function(){return[]},n.animateShow=function(){return this.show()},n._getPrjCoordinates=function(){var t=this._getProjection();return this._verifyProjection(),!this._pnw&&t&&this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw},n._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},n._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),n=this._getProjection();if(!n.isSphere())return e;for(var i=n.getSphereExtent(),r=i.sx,o=i.sy,s=this._getProjection().getCircum(),a=e[0],h=1,l=e.length;h<l;h++){var c=e[h],u=0,f=0;r*(a.x-c.x)>0&&(u=s.x*r),o*(a.y-c.y)<0&&(f=s.y*o),e[h]._add(u,f)}return e},n._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},n._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},n._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},n._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return t.prototype._containsPoint.call(this,e,n);var r=pc(n)?this._hitTestTolerance():n,o=i._getResolution()*r,s=this._getPrjExtent().expand(o),a=i._containerPointToPrj(e);return s.contains(a)},n._computePrjExtent=function(t){var e=this._getSouthEast(t);if(!e)return null;var n=t.projectCoords([new Zd(this._coordinates.x,e.y),new Zd(e.x,this._coordinates.y)],this.options.antiMeridian);return new am(n[0],n[1])},n._computeExtent=function(t){var e=this._getSouthEast(t);return e?new am(this._coordinates,e,this._getProjection()):null},n._getSouthEast=function(t){if(!t||!this._coordinates||pc(this._width)||pc(this._height))return null;var e=this.getWidth(),n=-this.getHeight();if(t.fullExtent){var i=t.fullExtent;e*=i.right>i.left?1:-1,n*=i.top>i.bottom?1:-1}var r=t.locate(this._coordinates,e,0),o=t.locate(this._coordinates,0,n);return r.y=o.y,r},n._computeGeodesicLength=function(){return pc(this._width)||pc(this._height)?0:2*(this._width+this._height)},n._computeGeodesicArea=function(){return pc(this._width)||pc(this._height)?0:this._width*this._height},n._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:Zd.toNumberArrays([this.getShell()])}},n._toJSON=function(t){var e=gc({},t),n=this.getCoordinates();e.geometry=!1;var i=this.toGeoJSON(e);return i.geometry={type:"Polygon"},{feature:i,subType:"Rectangle",coordinates:[n.x,n.y],width:this.getWidth(),height:this.getHeight()}},e}(Ip);Kp.registerJSONType("Rectangle");var Jp=function(t){function e(e,n,i,r,o){var s;return(s=t.call(this,e,n,o)||this).startAngle=i,s.endAngle=r,s}au(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n.getStartAngle=function(){return this.startAngle},n.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},n.getEndAngle=function(){return this.endAngle},n.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},n.getShell=function(){for(var t,e,n,i=this._getMeasurer(),r=this.getCoordinates(),o=this.options.numberOfShellPoints-2,s=this.getRadius(),a=[r.copy()],h=this.getStartAngle(),l=this.getEndAngle()-h,c=0;c<o;c++){t=(l*c/(o-1)+h)*Math.PI/180,e=s*Math.cos(t),n=s*Math.sin(t);var u=i.locate(r,e,n);a.push(u)}return a.push(r.copy()),a},n._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return t.prototype._containsPoint.call(this,e,n);var r=i._pointToContainerPoint(this._getCenter2DPoint()),o=pc(n)?this._hitTestTolerance():n,s=this.getSize(),a=r,h=e,l=Math.atan2(a.y-h.y,h.x-a.x),c=l<0?360*(l+2*Math.PI)/(2*Math.PI):360*l/(2*Math.PI),u=this.startAngle%360,f=this.endAngle%360,d=!1;return d=u>f?!(c>f&&c<u):c>=u&&c<=f,h.distanceTo(a)<=s.width/2+o&&d},n._computeGeodesicLength=function(){return pc(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},n._computeGeodesicArea=function(){return pc(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},n._toJSON=function(t){var e=gc({},t),n=this.getCenter();e.geometry=!1;var i=this.toGeoJSON(e);return i.geometry={type:"Polygon"},{feature:i,subType:"Sector",coordinates:[n.x,n.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(qp);Jp.mergeOptions({numberOfShellPoints:60}),Jp.registerJSONType("Sector");var Qp=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n._arc=function(t,e,n){for(var i=this.options.arcDegree*Math.PI/180,r=1,o=e.length;r<o;r++){var s=Od._arcBetween(t,e[r-1],e[r],i),a=[e[r-1].x+e[r].x-s[0],e[r-1].y+e[r].y-s[1]];e[r-1].nextCtrlPoint=a,e[r].prevCtrlPoint=a,Od._stroke(t,n)}},n._quadraticCurve=function(t,e){if(e.length<=2)Od._path(t,e);else{var n,i;for(n=2,i=e.length;n<i;n+=2)t.quadraticCurveTo(e[n-1].x,e[n-1].y,e[n].x,e[n].y);if((n-=1)<i)for(;n<i;n++)t.lineTo(e[n].x,e[n].y)}},n._bezierCurve=function(t,e){if(e.length<=3)Od._path(t,e);else{var n,i;for(n=1,i=e.length;n+2<i;n+=3)t.bezierCurveTo(e[n].x,e[n].y,e[n+1].x,e[n+1].y,e[n+2].x,e[n+2].y);if(n<i)for(;n<i;n++)t.lineTo(e[n].x,e[n].y)}},n._getCurveArrowPoints=function(t,e,n,i,r,o){var s,a=e.length;for(s=o;s<a;s+=o){var h=this._getArrowShape(e[s-1],e[s],n,i,r);h&&t.push(h)}if((s-=o)<a-1)for(s+=1;s<a;s++){var l=this._getArrowShape(e[s-1],e[s],n,i,r);l&&t.push(l)}},e}(Np);Qp.mergeOptions({enableSimplify:!1,enableClip:!1});var $p=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},n._paintOn=function(t,e,n){t.beginPath(),this._arc(t,e,n),Od._stroke(t,n),this._paintArrow(t,e,n)},e.fromJSON=function(t){var n=t.feature,i=new e(n.geometry.coordinates,t.options);return i.setProperties(n.properties),i},e}(Qp);$p.registerJSONType("ArcCurve"),$p.mergeOptions({arcDegree:90});var t_=function(t){function e(){return t.apply(this,arguments)||this}au(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(n.geometry.coordinates,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},n._paintOn=function(t,e,n){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),Od._stroke(t,n),this._paintArrow(t,e,n)},n._getArrowPoints=function(t,e,n,i,r){return this._getCurveArrowPoints(t,e,n,i,r,3)},e}(Qp);t_.registerJSONType("CubicBezierCurve");var e_=function(t){function e(){return t.apply(this,arguments)||this}au(e,t),e.fromJSON=function(t){var n=t.feature,i=new e(n.geometry.coordinates,t.options);return i.setProperties(n.properties),i};var n=e.prototype;return n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},n._paintOn=function(t,e,n){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,n),Od._stroke(t,n),this._paintArrow(t,e,n)},n._getArrowPoints=function(t,e,n,i,r){return this._getCurveArrowPoints(t,e,n,i,r,2)},e}(Qp);e_.registerJSONType("QuadBezierCurve");var n_={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},i_={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},r_=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.getContent=function(){return this._content},n.setContent=function(t){var e=this._content;return this._content=Sf(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},n.onAdd=function(){this._refresh()},n.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},n.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var n=this._parseSymbol(e);if(this.setTextStyle){var i=this.getTextStyle()||{};i.symbol=n[0],this.setTextStyle(i)}else this.setTextSymbol&&this.setTextSymbol(n[0]);if(this.setBoxStyle){var r=this.getBoxStyle()||{};r.symbol=n[1],this.setBoxStyle(r)}else this.setBoxSymbol&&this.setBoxSymbol(n[1]);return this},n._parseSymbol=function(t){var e={},n={};for(var i in t)Tc(t,i)&&(0===i.indexOf("text")?e[i]=t[i]:n[i]=t[i]);return[e,n]},n._getTextSize=function(t){return Hf(this._content,t).size},n._getInternalSymbol=function(){return this._symbol},n._getDefaultTextSymbol=function(){return gc({},n_)},n._getDefaultBoxSymbol=function(){return gc({},i_)},n._getDefaultPadding=function(){return[12,8]},e}(Lp),o_=function(t){function e(e,n,i,r,o){var s;return void 0===o&&(o={}),(s=t.call(this,n,o)||this)._content=Sf(e),s._width=pc(i)?100:i,s._height=pc(r)?40:r,o.boxSymbol&&s.setBoxSymbol(o.boxSymbol),o.textStyle&&s.setTextStyle(o.textStyle),s._refresh(),s}au(e,t);var n=e.prototype;return n.getWidth=function(){return this._width},n.setWidth=function(t){return this._width=t,this._refresh(),this},n.getHeight=function(){return this._height},n.setHeight=function(t){return this._height=t,this._refresh(),this},n.getBoxSymbol=function(){return gc({},this.options.boxSymbol)},n.setBoxSymbol=function(t){return this.options.boxSymbol=t?gc({},t):t,this.getSymbol()&&this._refresh(),this},n.getTextStyle=function(){return this.options.textStyle?gc({},this.options.textStyle):null},n.setTextStyle=function(t){return this.options.textStyle=t?gc({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var n=t.feature,i=new e(t.content,n.geometry.coordinates,t.width,t.height,t.options);return i.setProperties(n.properties),i.setId(n.id),t.symbol&&i.setSymbol(t.symbol),i},n._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},n._refresh=function(){var t=this.getTextStyle()||{},e=t.padding||[12,8],n=this._width-2*e[0],i=this._height-2*e[1],r=gc({},t.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:n,textMaxHeight:i});t.wrap&&!r.textWrapWidth&&(r.textWrapWidth=n);var o=t.horizontalAlignment;r.textDx=r.markerDx||0;var s=r.markerWidth/2-e[0];"left"===o?(r.textHorizontalAlignment="right",r.textDx=r.textDx-s):"right"===o&&(r.textHorizontalAlignment="left",r.textDx=r.textDx+s);var a=t.verticalAlignment;r.textDy=r.markerDy||0;var h=r.markerHeight/2-e[1];"top"===a?(r.textVerticalAlignment="bottom",r.textDy-=h):"bottom"===a&&(r.textVerticalAlignment="top",r.textDy+=h),this._refreshing=!0,this.updateSymbol(r),delete this._refreshing},e}(r_);o_.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),o_.registerJSONType("TextBox");var s_=function(t){function e(e,n,i){var r;return void 0===i&&(i={}),r=t.call(this,n,i)||this,i.textSymbol&&r.setTextSymbol(i.textSymbol),i.boxStyle&&r.setBoxStyle(i.boxStyle),r._content=Sf(e),r._refresh(),r}au(e,t);var n=e.prototype;return n.getBoxStyle=function(){return this.options.boxStyle?gc({},this.options.boxStyle):null},n.setBoxStyle=function(t){return this.options.boxStyle=t?gc({},t):t,this._refresh(),this},n.getTextSymbol=function(){return gc({},this._getDefaultTextSymbol(),this.options.textSymbol)},n.setTextSymbol=function(t){return this.options.textSymbol=t?gc({},t):t,this._refresh(),this},e.fromJSON=function(t){var n=t.feature,i=new e(t.content,n.geometry.coordinates,t.options);return i.setProperties(n.properties),i.setId(n.id),t.symbol&&i.setSymbol(t.symbol),i},n._canEdit=function(){return!1},n._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},n._refresh=function(){var t=gc({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){gc(t,e.symbol);var n=this._getBoxSize(t),i=n[1],r=e.padding||this._getDefaultPadding(),o=n[0];t.markerWidth=o.width,t.markerHeight=o.height;var s=t.textDx||0,a=t.textDy||0,h=Nf(i,t.textHorizontalAlignment,t.textVerticalAlignment)._add(s,a),l=e.horizontalAlignment||"middle";t.markerDx=h.x,"left"===l?t.markerDx+=t.markerWidth/2-r[0]:"right"===l?t.markerDx-=t.markerWidth/2-i.width-r[0]:t.markerDx+=i.width/2;var c=e.verticalAlignment||"middle";t.markerDy=h.y,"top"===c?t.markerDy+=t.markerHeight/2-r[1]:"bottom"===c?t.markerDy-=t.markerHeight/2-i.height-r[1]:t.markerDy+=i.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},n._getBoxSize=function(t){t.markerType||(t.markerType="square");var e,n,i=this.getBoxStyle(),r=this._getTextSize(t),o=i.padding||this._getDefaultPadding();return e=r.width+2*o[0],n=r.height+2*o[1],i.minWidth&&(!e||e<i.minWidth)&&(e=i.minWidth),i.minHeight&&(!n||n<i.minHeight)&&(n=i.minHeight),[new Af(e,n),r]},e}(r_);s_.mergeOptions({boxStyle:null,textSymbol:null}),s_.registerJSONType("Label");var a_=function(t){return function(t){function e(){return t.apply(this,arguments)||this}au(e,t),e._hasConnectors=function(t){return!pc(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors};var n=e.prototype;return n.getConnectSource=function(){return this._connSource},n.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},n.getConnectTarget=function(){return this._connTarget},n.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},n._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e,n,i=this._connSource._getConnectPoints(),r=this._connTarget._getConnectPoints(),o=0,s=this.getCoordinates(),a=0,h=i.length;a<h;a++)for(var l=i[a],c=0,u=r.length;c<u;c++){var f=r[c],d=t.computeLength(l,f);0===a&&0===c?(e=l,n=f,o=d):d<o&&(e=l,n=f)}Su(s)&&s[0].equals(e)&&s[1].equals(n)||this.setCoordinates([e,n])}},n.onAdd=function(){this._registerEvents(),this._updateCoordinates()},n.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&xu(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(xu(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof sp&&this._connTarget instanceof sp)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},n._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},n._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof sp&&this._connTarget instanceof sp)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},h_={showOn:"always"},l_=function(t){function e(e,n,i){var r;return r=t.call(this,null,i)||this,1===arguments.length&&(i=e,e=null,n=null),r._connSource=e,r._connTarget=n,r}return au(e,t),e}(a_(Np));l_.mergeOptions(h_),l_.registerJSONType("ConnectorLine");var c_=function(t){function e(e,n,i){var r;return r=t.call(this,null,i)||this,1===arguments.length&&(i=e,e=null,n=null),r._connSource=e,r._connTarget=n,r}return au(e,t),e}(a_($p));c_.mergeOptions(h_),c_.registerJSONType("ArcConnectorLine");var u_=function(t){function e(e,n,i){var r;n&&!(n instanceof sp)&&!Array.isArray(n)&&lc.indexOf(n.type)<0&&(i=n,n=null),(r=t.call(this,e,i)||this)._maxZIndex=0,r._minZIndex=0,r._initCache(),n&&r.addGeometry(n);var o=r.options.style;return o&&r.setStyle(o),r}au(e,t);var n=e.prototype;return n.getGeometryById=function(t){return pc(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},n.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var n,i=[],r=0,o=this._geoList.length;r<o;r++)n=this._geoList[r],(e?t.call(e,n):t(n))&&i.push(n);return i},n.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},n.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},n.getCount=function(){return this._geoList.length},n.getExtent=function(){if(0===this.getCount())return null;var t=new am(this.getProjection());return this.forEach((function(e){t._combine(e.getExtent())})),t},n.forEach=function(t,e){for(var n=this._geoList.slice(0),i=0,r=n.length;i<r;i++)e?t.call(e,n[i],i):t(n[i],i);return this},n.filter=function(t,e){var n=[],i=bc(t),r=i?t:sf(t);return this.forEach((function(t){var o=i?t:gf(t);(e?r.call(e,o):r(o))&&n.push(t)}),this),n},n.isEmpty=function(){return!this._geoList.length},n.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(Zp.toGeometry(t),e);if(!Array.isArray(t)){var n=arguments.length,i=arguments[n-1];return t=Array.prototype.slice.call(arguments,0,n-1),e=i,i&&yc(i)&&("type"in i||i instanceof sp)&&(t.push(i),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;var r;this._initCache(),e&&(r=new am),this._toSort=this._maxZIndex>0;for(var o=[],s=0,a=t.length;s<a;s++){var h=t[s];if(!h)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+s);if(!(h instanceof sp)&&(h=sp.fromJSON(h),Array.isArray(h)))for(var l=0,c=h.length;l<c;l++)this._add(h[l],r,s),o.push(h[l]);Array.isArray(h)||(this._add(h,r,s),o.push(h))}var u=this.getMap();if(u&&(this._getRenderer().onGeometryAdd(o),r&&!pc(r.xmin))){var f=r.getCenter(),d=u.getFitZoom(r);if(yc(e)){var m=bc(e.step)?e.step:function(){};u.animateTo({center:f,zoom:d},gc({duration:u.options.zoomAnimationDuration,easing:"out"},e),m)}else!0===e&&u.setCenterAndZoom(f,d)}return this.fire("addgeo",{geometries:t}),this},n.getGeoMinZIndex=function(){return this._minZIndex},n.getGeoMaxZIndex=function(){return this._maxZIndex},n._add=function(t,e,n){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var i=t.getId();if(!pc(i)){if(!pc(this._geoMap[i]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+i+", at index:"+n);this._geoMap[i]=t}var r=pu();t._setInternalId(r),this._geoList.push(t),this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(t)},n.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof sp||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this.fire("removegeo",{geometries:t}),this},n.clear=function(){this._clearing=!0,this.forEach((function(t){t.remove()})),this._geoMap={};var t=this._geoList;this._geoList=[];var e=this._getRenderer();return e&&(e.onGeometryRemove(t),e.clearImageData&&e.clearImageData()),this._clearing=!1,this.fire("clear"),this},n.onRemoveGeometry=function(t){if(t&&!this._clearing&&this===t.getLayer()&&!pc(t._getInternalId())){var e=t.getId();pc(e)||delete this._geoMap[e];var n=this._findInList(t);n>=0&&this._geoList.splice(n,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},n.getStyle=function(){return this.options.style?this.options.style:null},n.setStyle=function(t){return this.options.style=t,t=Xf(t),this._cookedStyles=function t(e){if(!Array.isArray(e))return t([e]);for(var n=[],i=0;i<e.length;i++){var r=void 0;r=!0===e[i].filter?function(){return!0}:sf(e[i].filter),n.push(pf({},e[i],{filter:r}))}return n}(t),this.forEach((function(t){this._styleGeometry(t)}),this),this.fire("setstyle",{style:t}),this},n._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=gf(t),n=0,i=this._cookedStyles.length;n<i;n++)if(!0===this._cookedStyles[n].filter(e))return t._setExternSymbol(this._cookedStyles[n].symbol),!0;return!1},n.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach((function(t){t._setExternSymbol(null)}),this),this.fire("removestyle"),this):this},n.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},n.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return hp.prototype.hide.call(this)},n._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},n._updateZIndex=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this._maxZIndex=Math.max(this._maxZIndex,Math.max.apply(Math,e)),this._minZIndex=Math.min(this._minZIndex,Math.min.apply(Math,e))},n._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort((function(e,n){return t._updateZIndex(e.getZIndex(),n.getZIndex()),t._compare(e,n)})),this._toSort=!1)},n._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},n._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;this._sortGeometries();for(var n,i=0,r=e-1;i<=r;){if(n=Math.floor((i+r)/2),this._geoList[n]===t)return n;this._compare(this._geoList[n],t)>0?r=n-1:i=n+1}return-1},n._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},n._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!pc(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}pc(t.old)||t.new===t.old||delete this._geoMap[t.old]}},n._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},n._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},n._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},n._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},n._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},n._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},n._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},e}(hp);u_.mergeOptions({drawImmediate:!1});var f_=new lm,d_={debug:!1,enableSimplify:!0,geometryEvents:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:su.gecko,enableAltitude:!1,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0,clipBBoxBufferSize:3,geometryEventTolerance:1},m_=function(t){function e(e,n,i){return t.call(this,e,n,i)||this}au(e,t);var n=e.prototype;return n.onConfig=function(e){if(t.prototype.onConfig.call(this,e),e.enableAltitude||e.drawAltitude||e.altitudeProperty){var n=this.getRenderer();n&&n.setToRedraw&&n.setToRedraw()}},n.identify=function(t,e){void 0===e&&(e={});var n=this.getRenderer();t instanceof Zd||(t=new Zd(t));var i=this.getMap().coordToContainerPoint(t);return e.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(i,e):this._hitGeos(this._geoList,i,e)},n.identifyAtPoint=function(t,e){void 0===e&&(e={});var n=this.getRenderer();return t instanceof fu||(t=new fu(t)),e.onlyVisible&&n&&n.identifyAtPoint?n.identifyAtPoint(t,e):this._hitGeos(this._geoList,t,e)},n._hitGeos=function(t,e,n){void 0===n&&(n={});var i=n.filter,r=[],o=n.tolerance,s=this.getMap(),a=this.getRenderer(),h=a&&a.getImageData&&a.getImageData();if(h){for(var l=0,c=t.length-1;c>=0;c--){var u=t[c]._hitTestTolerance()+(o||0);u>l&&(l=u)}var f=s.getDevicePixelRatio();h.r=f;for(var d=!1,m=e.x-l,g=e.y-l,p=-l;p<=l;p++){for(var _=-l;_<=l;_++){var v=Math.round((m+p)*f),y=Math.round((g+_)*f);if(h.data[y*h.width*4+4*v+3]>0){d=!0;break}}if(d)break}if(!d)return r}for(var x=t.length-1;x>=0;x--){var b=t[x];if(b&&b.isVisible()&&b._getPainter()&&b.options.interactive){if(!(b instanceof Np&&(b._getArrowStyle()||b instanceof Qp))){var w=b.getContainerExtent(f_);if(o&&(w=w._expand(o)),!w||!w.contains(e))continue}if(b._containsPoint(e,o)&&(!i||i(b))&&(r.push(b),n.count&&r.length>=n.count))break}}return r},n.getAltitude=function(){return this.options.altitude||0},n.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if(pc(t.geometries)||t.geometries){var n;if(t.clipExtent){var i=this.getMap(),r=i?i.getProjection():null;n=new am(t.clipExtent,r)}for(var o=[],s=this.getGeometries(),a=0,h=s.length;a<h;a++){var l=s[a],c=l.getExtent();if(c&&(!n||n.intersects(c))){var u=l.toJSON(t.geometries);o.push(u)}}e.geometries=o}return e},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var n=new e(t.id,t.options),i=t.geometries,r=[],o=0;o<i.length;o++){var s=sp.fromJSON(i[o]);s&&r.push(s)}return n.addGeometry(r),n},e.getPainterClass=function(){return $g},e.getCollectionPainterClass=function(){return ep},e}(u_);m_.mergeOptions(d_),m_.registerJSONType("VectorLayer");var g_="_map_tool",p_=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addTo=function(t){return t?(this._map=t,t[g_]&&t[g_].disable(),this.onAdd&&this.onAdd(),this.enable(),t[g_]=this,this._fireEvent("add"),this):this},n.getMap=function(){return this._map},n.enable=function(){return!this._map||this._enabled||(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable")),this},n.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},n.isEnabled=function(){return!!this._enabled},n.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[g_],delete this._map),this._fireEvent("remove"),this):this},n._registerEvents=function(){this._switchEvents("on")},n._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},n._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(Fd(Bd)),__={},v_=function(t){function e(e){var n;return(n=t.call(this,e)||this)._checkMode(),n._events={click:n._clickHandler,"mousemove touchmove":n._mouseMoveHandler,dblclick:n._doubleClickHandler,"mousedown touchstart":n._mouseDownHandler,"mouseup touchend":n._mouseUpHandler,mousemove:n._mouseMoveHandler,mousedown:n._mouseDownHandler,mouseup:n._mouseUpHandler},n}au(e,t),e.registerMode=function(t,e){__[t.toLowerCase()]=e},e.getRegisterMode=function(t){return __[t.toLowerCase()]};var n=e.prototype;return n.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},n.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},n.getSymbol=function(){return Wf(this.options.symbol||this.options.symbol)},n.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},n.getCurrentGeometry=function(){return this._geometry},n.onAdd=function(){this._checkMode()},n.onEnable=function(){this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources();var t=this.getMap();return this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge=t.options.autoPanAtEdge,this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!0})),this._geometryEvents=t.options.geometryEvents,this.options.blockGeometryEvents&&t.config("geometryEvents",!1),this},n.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw(),this._map&&(t.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!1}))),this.options.blockGeometryEvents&&t.config("geometryEvents",this._geometryEvents),this},n.undo=function(){var t=this._getRegisterMode();if(!this._shouldRecordHistory(t.action)||!this._historyPointer)return this;var e=this._clickCoords.slice(0,--this._historyPointer);return t.update(this.getMap().getProjection(),e,this._geometry),this},n.redo=function(){var t=this._getRegisterMode();if(!this._shouldRecordHistory(t.action)||pc(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var e=this._clickCoords.slice(0,++this._historyPointer);return t.update(this.getMap().getProjection(),e,this._geometry),this},n._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},n._checkMode=function(){this._getRegisterMode()},n._saveMapCfg=function(){var t=this.getMap();this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom});for(var e=this._getRegisterMode().action,n=!1,i=0;i<e.length;i++)if(e[i].indexOf("mousedown")>=0||e[i].indexOf("touchstart")>=0){n=!0;break}if(n){var r=this.getMap();this._mapDraggable=r.options.draggable,r.config({draggable:!1})}},n._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),pc(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},n._loadResources=function(){var t=wf(this.getSymbol());t.length>0&&this._drawToolLayer._getRenderer().loadResources(t)},n._getProjection=function(){return this._map.getProjection()},n._getRegisterMode=function(){var t=this.getMode(),n=e.getRegisterMode(t);if(!n)throw new Error(t+" is not a valid mode of DrawTool.");return n},n.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var n=0;n<t.length;n++)e[t[n]]=this._events[t[n]];return e}return null},n._mouseDownHandler=function(t){this._createGeometry(t)},n._mouseUpHandler=function(t){this.endDraw(t)},n._clickHandler=function(t){var e=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var n=this._clickCoords.length,i=this.getMap()._pointToPrj(t.point2d);if(this._clickCoords[n-1].equals(i))return}if(this._geometry){var r=this.getMap()._pointToPrj(t.point2d),o=this._geometry.snapTo;if(o&&bc(o)){var s=this._geometry.snapTo(t.containerPoint)||t.containerPoint;r=this.getMap()._containerPointToPrj(s)}if(pc(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer)),this._clickCoords.push(r),this._historyPointer=this._clickCoords.length,t.drawTool=this,e.update(this.getMap().getProjection(),this._clickCoords,this._geometry,t),"point"===this.getMode())return void this.endDraw(t);this._fireEvent(this._clickCoords.length<=1?"drawstart":"drawvertex",t),e.clickLimit&&e.clickLimit===this._historyPointer&&this.endDraw(t)}else this._createGeometry(t)},n._createGeometry=function(t){var e=this.getMode(),n=this._getRegisterMode(),i=this.getMap()._pointToPrj(t.point2d),r=this.getSymbol();this._geometry||(this._clickCoords=[i],t.drawTool=this,this._geometry=n.create(this.getMap().getProjection(),this._clickCoords,t),r&&"point"!==e?this._geometry.setSymbol(r):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t)),"point"===e&&"mousemove"!==t.type&&this.endDraw(t)},n._mouseMoveHandler=function(t){var e=this.getMap();if(e&&!e.isInteracting())if("point"!==this.getMode()||this._geometry){if(this._geometry){var n=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(n)){var i=this.getMap()._pointToPrj(t.point2d);this._geometry.snapTo&&(n=this._geometry.snapTo(n)||n,i=e._containerPointToPrj(n));var r=e.getProjection();t.drawTool=this;var o=this._getRegisterMode();if(this._shouldRecordHistory(o.action)){var s=this._clickCoords.slice(0,this._historyPointer);if(s&&s.length>0&&i.equals(s[s.length-1]))return;o.update(r,s.concat([i]),this._geometry,t)}else o.update(r,i,this._geometry,t);this._fireEvent("mousemove",t)}}}else this._createGeometry(t)},n._doubleClickHandler=function(t){if(this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var n=this._getRegisterMode(),i=this._clickCoords;if(!(i.length<2)){var r=this.getMode();if(!(r&&r.indexOf("polygon")>-1&&i.length<3)){for(var o=this.getMap().getProjection(),s=[i[0]],a=1,h=i.length;a<h;a++)i[a].x===i[a-1].x&&i[a].y===i[a-1].y||s.push(i[a]);s.length<2||this._geometry&&this._geometry instanceof Ip&&s.length<3||(t.drawTool=this,n.update(o,s,this._geometry,t),this.endDraw(t))}}}}},n._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},n.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this._vertexes&&(this._vertexes=[]),this},n._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},n._getMouseContainerPoint=function(t){var e=this._getRegisterMode().action;return(e[0].indexOf("mousedown")>=0||e[0].indexOf("touchstart")>=0)&&cd(t.domEvent),t.containerPoint},n._isValidContainerPoint=function(t){var e=this._map.getSize();return!(t.x<0||t.y<0||t.x>e.width||t.y>e.height)},n._getDrawLayer=function(){var t="_maptalks__internal_layer_drawtool",e=this._map.getLayer(t);return e||(e=new m_(t,{enableSimplify:!1,enableAltitude:this.options.enableAltitude}),this._map.addLayer(e)),e},n._fireEvent=function(t,e){e||(e={}),e=gc({},e),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}),e.tempGeometry=this._geometry),p_.prototype._fireEvent.call(this,t,e)},e}(p_);v_.mergeOptions({symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0,blockGeometryEvents:!1});var y_=function(t){function e(e){var n;return(n=t.call(this,e)||this).drawTool=new v_({mode:"boxZoom",ignoreMouseleave:!1}),n}au(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},n.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},n._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},n._boxZoom=function(t){var e=this.target;this.drawTool.remove();var n=t.geometry,i=n.getCenter(),r=n.getSymbol(),o=new am(i,e.locateByPoint(i,r.markerWidth,r.markerHeight),e.getProjection()),s=e.getFitZoom(o);e._animateTo({center:o.getCenter(),zoom:s})},e}(Nd);yp.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),yp.addOnLoadHook("addHandler","boxZoom",y_);var x_=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},n.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},n._onMouseMove=function(t){var e=this.target;if(e.options.autoPanAtEdge){var n=t.containerPoint,i=e.getContainerExtent();if(i){var r,o=n.x,s=n.y,a=i.xmax,h=i.ymax;o<30&&(r=[Math.abs(o-30),0]),s<30&&(r=[0,Math.abs(s-30)]),o+30>a&&(r=[-Math.abs(o+30-a),0]),s+30>h&&(r=[0,-Math.abs(s+30-h)]),r&&e.panBy(r,{duration:1})}}},e}(Nd);function b_(t,e,n){return t*(1-n)+e*n}yp.mergeOptions({autoPanAtEdge:!1}),yp.addOnLoadHook("addHandler","autoPanAtEdge",x_),yp.include({animateTo:function(t,e,n){var i=this;void 0===e&&(e={}),bc(e)&&(n=e,e={});var r=this.getProjection(),o=this.getView(),s={},a=!0;for(var h in t)if(Tc(t,h)&&!pc(t[h])&&("prjCenter"===h||!pc(o[h])))if(a=!1,"center"===h){var l=new Zd(o[h]),c=new Zd(t[h]);l.equals(c)||(s.center=[l,c])}else if("prjCenter"===h){var u=new Zd(this._getPrjCenter()),f=new Zd(t[h]);u.equals(f)||(s.prjCenter=[u,f])}else o[h]!==t[h]&&"around"!==h&&(s[h]=[o[h],t[h]]);if(a)return null;this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var d=t.around||new fu(this.width/2,this.height/2),m=this._getRenderer(),g=this._animPlayer=Rp.animate(s,{easing:e.easing||"out",duration:e.duration||this.options.zoomAnimationDuration,framer:function(t){m.callInNextFrame(t)},repeat:e.repeat},(function(t){i.isRemoved()?g.finish():("running"===g.playState?(t.styles.center?(i._setPrjCenter(r.project(t.styles.center)),i.onMoving(i._parseEventFromCoord(i.getCenter()))):t.styles.prjCenter&&(i._setPrjCenter(t.styles.prjCenter),i.onMoving(i._parseEventFromCoord(i.getCenter()))),pc(t.styles.zoom)||i.onZooming(t.styles.zoom,d),pc(t.styles.pitch)||i._setPitch(t.styles.pitch),pc(t.styles.bearing)||i._setBearing(t.styles.bearing),i._fireEvent("animating")):"paused"===g.playState&&g!==i._mapAnimPlayer||(g._interupted||(s.center?i._setPrjCenter(r.project(s.center[1])):s.prjCenter&&i._setPrjCenter(s.prjCenter[1]),pc(s.pitch)||i._setPitch(s.pitch[1]),pc(s.bearing)||i._setBearing(s.bearing[1])),i._endAnim(g,s,d,e)),n&&n(t))}),this);return this._startAnim(s,d),g},_animateTo:function(t,e,n){return void 0===e&&(e={}),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(t,e,n),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(t,e,n){var i=this;void 0===e&&(e={}),this._animPlayer&&(this._isInternalAnimation?"running"===this._animPlayer.playState&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),bc(e)&&(n=e,e={}),e=gc({curve:1.42},e);var r=this;function o(t,e){return r.getResolution(e)/r.getResolution(t)}var s=t.around||new fu(this.width/2,this.height/2),a=this.getMinZoom(),h=this.getMaxZoom(),l=this.getProjection(),c=this.getView(),u=c.zoom,f=c.bearing,d=c.pitch,m="zoom"in t?Cu(+t.zoom,a,h):u,g="bearing"in t?+t.bearing:f,p="pitch"in t?+t.pitch:d,_=l.project(t.center&&new Zd(t.center)||this.getCenter()),v=o(m,u),y=l.project(this.getCenter()),x=_.sub(y),b=e.curve,w=Math.max(this.width,this.height),T=w/v,M=x.mag();if("minZoom"in e){var A=Cu(Math.min(e.minZoom,u,m),a,h),E=w/o(A,u);b=Math.sqrt(E/M*2)}var C=b*b;function S(t){var e=(T*T-w*w+(t?-1:1)*C*C*M*M)/(2*(t?T:w)*C*M);return Math.log(Math.sqrt(e*e+1)-e)}function P(t){return(Math.exp(t)-Math.exp(-t))/2}function R(t){return(Math.exp(t)+Math.exp(-t))/2}var O=S(0),I=function(t){return R(O)/R(O+b*t)},D=function(t){return w*((R(O)*(P(e=O+b*t)/R(e))-P(O))/C)/M;var e},k=(S(1)-O)/b;if(Math.abs(M)<1e-6||!isFinite(k)){if(Math.abs(w-T)<1e-6)return this.animateTo(t,e,n);var L=T<w?-1:1;k=Math.abs(Math.log(T/w))/b,D=function(){return 0},I=function(t){return Math.exp(L*b*t)}}var F=this._getRenderer(),N=this._animPlayer=Rp.animate({k:[0,1]},{easing:e.easing||"out",duration:e.duration||8,framer:function(t){F.callInNextFrame(t)}},(function(r){if(i.isRemoved())N.finish();else{var o=r.styles.k,a=o*k,h=1/I(a),l={};if(t.center){var c=1===o?_:y.add(x.multi(D(a)));l.prjCenter=[_,c]}if(u!==m){var v=1===o?m:i.getZoomForScale(h,u,!0);l.zoom=[u,v]}if(d!==p){var b=b_(d,p,o);l.pitch=[p,b]}if(f!==g){var w=b_(f,g,o);l.bearing=[g,w]}"running"===N.playState?(l.prjCenter&&(i._setPrjCenter(l.prjCenter[1]),i.onMoving(i._parseEventFromCoord(i.getCenter()))),l.zoom&&i.onZooming(l.zoom[1],s),l.pitch&&i._setPitch(l.pitch[1]),l.bearing&&i._setBearing(l.bearing[1]),i._fireEvent("animating")):"paused"===N.playState&&N!==i._mapAnimPlayer||(N._interupted||(l.prjCenter&&i._setPrjCenter(l.prjCenter[1]),l.pitch&&i._setPitch(l.pitch[1]),l.bearing&&i._setBearing(l.bearing[1])),i._endAnim(N,l,s,e)),n&&n(r)}}));return this._startAnim({center:t.center,zoom:t.zoom!==u,pitch:p!==d,bearing:g!==f},s),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,n,i){delete this._animRotating;var r,o=t._interupted?"animateinterrupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer,e.center)r=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(r));else if(e.prjCenter){var s;s=t._interupted?this._getPrjCenter():e.prjCenter[1];var a=this._parseEventFromCoord(this.getProjection().unproject(s));a.point2d=this._prjToPoint(s),this.onMoveEnd(a)}pc(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom(),n):i.wheelZoom?this.onZooming(e.zoom[1],n):this.onZoomEnd(e.zoom[1],n)),o&&this._fireEvent(o),pc(e.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),i.wheelZoom||this._resumePrev(t)},_startAnim:function(t,e){this._animPlayer&&(t.center&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&(delete this._animRotating,"finished"!==t.playState&&(t._interupted=!0,t.cancel()),t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(t){if(this._prevAnimPlayer){var e=this._prevAnimPlayer;"paused"!==e.playState&&delete this._prevAnimPlayer,t!==e&&(this._animPlayer=e,e.play())}}});var w_="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend ";function T_(t,e,n,i,r){var o=1/Math.tan(e/2),s=1/(i-r);return t[0]=o/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+i)*s,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*i*s,t[15]=0,t}function M_(t,e,n){var i,r,o,s,a,h,l,c,u,f,d,m,g=n[0],p=n[1],_=n[2];return e===t?(t[12]=e[0]*g+e[4]*p+e[8]*_+e[12],t[13]=e[1]*g+e[5]*p+e[9]*_+e[13],t[14]=e[2]*g+e[6]*p+e[10]*_+e[14],t[15]=e[3]*g+e[7]*p+e[11]*_+e[15]):(r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],f=e[9],d=e[10],m=e[11],t[0]=i=e[0],t[1]=r,t[2]=o,t[3]=s,t[4]=a,t[5]=h,t[6]=l,t[7]=c,t[8]=u,t[9]=f,t[10]=d,t[11]=m,t[12]=i*g+a*p+u*_+e[12],t[13]=r*g+h*p+f*_+e[13],t[14]=o*g+l*p+d*_+e[14],t[15]=s*g+c*p+m*_+e[15]),t}function A_(t,e,n){var i=n[0],r=n[1],o=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function E_(t,e,n){var i=e[0],r=e[1],o=e[2],s=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],f=e[9],d=e[10],m=e[11],g=e[12],p=e[13],_=e[14],v=e[15],y=n[0],x=n[1],b=n[2],w=n[3];return t[0]=y*i+x*a+b*u+w*g,t[1]=y*r+x*h+b*f+w*p,t[2]=y*o+x*l+b*d+w*_,t[3]=y*s+x*c+b*m+w*v,t[4]=(y=n[4])*i+(x=n[5])*a+(b=n[6])*u+(w=n[7])*g,t[5]=y*r+x*h+b*f+w*p,t[6]=y*o+x*l+b*d+w*_,t[7]=y*s+x*c+b*m+w*v,t[8]=(y=n[8])*i+(x=n[9])*a+(b=n[10])*u+(w=n[11])*g,t[9]=y*r+x*h+b*f+w*p,t[10]=y*o+x*l+b*d+w*_,t[11]=y*s+x*c+b*m+w*v,t[12]=(y=n[12])*i+(x=n[13])*a+(b=n[14])*u+(w=n[15])*g,t[13]=y*r+x*h+b*f+w*p,t[14]=y*o+x*l+b*d+w*_,t[15]=y*s+x*c+b*m+w*v,t}function C_(t,e){var n=e[0],i=e[1],r=e[2],o=e[3],s=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],f=e[10],d=e[11],m=e[12],g=e[13],p=e[14],_=e[15],v=n*a-i*s,y=n*h-r*s,x=n*l-o*s,b=i*h-r*a,w=i*l-o*a,T=r*l-o*h,M=c*g-u*m,A=c*p-f*m,E=c*_-d*m,C=u*p-f*g,S=u*_-d*g,P=f*_-d*p,R=v*P-y*S+x*C+b*E-w*A+T*M;return R?(t[0]=(a*P-h*S+l*C)*(R=1/R),t[1]=(r*S-i*P-o*C)*R,t[2]=(g*T-p*w+_*b)*R,t[3]=(f*w-u*T-d*b)*R,t[4]=(h*E-s*P-l*A)*R,t[5]=(n*P-r*E+o*A)*R,t[6]=(p*x-m*T-_*y)*R,t[7]=(c*T-f*x+d*y)*R,t[8]=(s*S-a*E+l*M)*R,t[9]=(i*E-n*S-o*M)*R,t[10]=(m*w-g*x+_*v)*R,t[11]=(u*x-c*w-d*v)*R,t[12]=(a*A-s*C-h*M)*R,t[13]=(n*C-i*A+r*M)*R,t[14]=(g*y-m*b-p*v)*R,t[15]=(c*b-u*y+f*v)*R,t):null}function S_(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function P_(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function R_(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function O_(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function I_(t){var e=t[0],n=t[1],i=t[2];return Math.sqrt(e*e+n*n+i*i)}function D_(t,e){var n=e[0],i=e[1],r=e[2],o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function k_(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],h=n[2];return t[0]=r*h-o*a,t[1]=o*s-i*h,t[2]=i*a-r*s,t}function L_(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.hypot?Math.hypot(n,i,r):function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}(n,i,r)}function F_(t,e,n){var i=e[0],r=e[1],o=e[2],s=1/(n[3]*i+n[7]*r+n[11]*o+n[15]);return t[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])*s,t[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])*s,t[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])*s,t}yp.include({_registerDomEvents:function(){sd(this._panels.mapWrapper||this._containerDOM,w_,this._handleDOMEvent,this)},_removeDomEvents:function(){ad(this._panels.mapWrapper||this._containerDOM,w_,this._handleDOMEvent)},_handleDOMEvent:function(t){var e=this.options.clickTimeThreshold,n=t.type,i="mousedown"===n||"touchstart"===n&&(!t.touches||1===t.touches.length);i&&(this._domMouseDownTime=mc(),this._domMouseDownView=this.getView());var r="contextmenu"===n&&function(t){if(!t._domMouseDownView)return!0;var e=t.getView(),n=t._domMouseDownView;return e.bearing!==n.bearing||e.pitch!==n.pitch}(this);if("contextmenu"===n){ld(t);var o=this._domMouseDownTime;mc()-o<=e&&!r&&this._fireDOMEvent(this,t,"dom:"+t.type)}else this._fireDOMEvent(this,t,"dom:"+t.type);if(!this._ignoreEvent(t)){var s,a=!1;if(i)this._mouseDownTime=mc();else if("click"===n||"touchend"===n||"contextmenu"===n){if(!this._mouseDownTime)return;var h=this._mouseDownTime;if(delete this._mouseDownTime,mc()-h>e){if("click"===n||"contextmenu"===n)return}else if("contextmenu"===n){if(r)return}else"touchend"===n&&(a=!0)}a&&(this._clickTime&&mc()-this._clickTime<=e?(delete this._clickTime,s="dblclick",this._fireDOMEvent(this,t,"dom:dblclick")):(this._clickTime=mc(),s="click",this._fireDOMEvent(this,t,"dom:click"))),this._ignoreEvent(t)||(this._fireDOMEvent(this,t,n),s&&this._fireDOMEvent(this,t,s))}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;if(this._isEventOutMap(t))return!0;var e,n=t.srcElement||t.target;if(n)for(;n&&n!==this._containerDOM;){if(n.className&&n.className.indexOf&&(n.className.indexOf("maptalks-control")>=0||n.className.indexOf("maptalks-ui")>=0&&e&&!e.eventsPropagation))return!0;e=n,n=n.parentNode}return!1},_isEventOutMap:function(t){if(this.getPitch()>this.options.maxVisualPitch){var e=dd(this._getActualEvent(t),this._containerDOM);if(!this.getContainerExtent().contains(e))return!0}return!1},_parseEvent:function(t,e){if(!t)return null;var n={domEvent:t};if("keypress"!==e){var i=this._getActualEvent(t);if(i&&void 0!==i.clientX){var r=dd(i,this._containerDOM);n=gc(n,{containerPoint:r,viewPoint:this.containerPointToViewPoint(r)});var o=this.options.maxVisualPitch;(this.getPitch()<=o||r.y>=this.height-this._getVisualHeight(o))&&(n=gc(n,{coordinate:this.containerPointToCoord(r),point2d:this._containerPointToPoint(r)}))}}return n},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,n){if(!this.isRemoved()){var i=this._parseEvent(e,n);this._fireEvent(n,i)}},_getEventParams:function(t){var e={domEvent:t},n=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(n){var i=dd(n,this._containerDOM);e.coordinate=this.containerPointToCoordinate(i),e.containerPoint=i,e.viewPoint=this.containerPointToViewPoint(i),e.pont2d=this._containerPointToPoint(i)}return e}}),yp.addOnLoadHook("_registerDomEvents"),yp.include({isFullScreen:function(){return!!(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullscreen)t.requestFullscreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}),yp.include({panTo:function(t,e,n){if(void 0===e&&(e={}),!t)return this;if(bc(e)&&(n=e,e={}),t=new Zd(t),void 0===e.animation||e.animation){var i=this.getProjection().project(t);return this._panAnimation(i,e.duration,n)}return this.setCenter(t),this},_panTo:function(t,e){return void 0===e&&(e={}),void 0===e.animation||e.animation?this._panAnimation(t,e.duration):(this.onMoveStart(),this._setPrjCenter(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(t,e,n){if(void 0===e&&(e={}),!t)return this;if(bc(e)&&(n=e,e={}),t=new fu(t),this.getContainerExtent().ymin>0&&t.y>30){var i=t.y;t.y=30,t.x=30*t.x/i,console.warn("offset is limited to panBy when pitch is above maxPitch")}if(this.onMoveStart(),void 0===e.animation||e.animation){t=t.multi(-1);var r=this._containerPointToPrj(new fu(this.width/2+t.x,this.height/2+t.y));this._panAnimation(r,e.duration,n)}else this._offsetCenterByPixel(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter()));return this},_panAnimation:function(t,e,n){return this._animateTo({prjCenter:t},{duration:e||this.options.panAnimationDuration},n)}}),sp.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],n=0,i=t.length;n<i;n++){var r=sp.fromJSON(t[n]);Array.isArray(t)?e=e.concat(r):e.push(r)}return e}return t&&!t.feature?Zp.toGeometry(t):(t.subType?(o=sp.getJSONClass(t.subType).fromJSON(t),pc(t.feature.id)||o.setId(t.feature.id)):(o=Zp.toGeometry(t.feature),t.options&&o.config(t.options)),t.symbol&&o.setSymbol(t.symbol),t.infoWindow&&o.setInfoWindow(t.infoWindow),o);var o},hp.fromJSON=function(t){if(!t)return null;var e=t.type,n=hp.getJSONClass(e);if(!n||!n.fromJSON)throw new Error("unsupported layer type:"+e);return n.fromJSON(t)},yp.include({JSON_VERSION:"1.0",toJSON:function(t){t||(t={});var e={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom(),e.options.bearing=this.getBearing(),e.options.pitch=this.getPitch();var n=this.getBaseLayer();(pc(t.baseLayer)||t.baseLayer)&&n&&(e.baseLayer=n.toJSON(t.baseLayer));var i={};t.clipExtent&&(i.clipExtent=!0===t.clipExtent?this.getExtent():t.clipExtent);var r=[];if(pc(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var o=this.getLayers(),s=0,a=o.length;s<a;s++)if(o[s].toJSON){var h=gc({},yc(t.layers)?t.layers:{},i);r.push(o[s].toJSON(h))}e.layers=r}else if(Su(t.layers)){for(var l=t.layers,c=0;c<l.length;c++){var u=l[c],f=this.getLayer(u.id);if(f.toJSON){var d=gc({},u.options,i);r.push(f.toJSON(d))}}e.layers=r}else e.layers=[];return e}}),yp.fromJSON=function(t,e,n){if(!t||!e)return null;n||(n={});var i=new yp(t,e.options);if(pc(n.baseLayer)||n.baseLayer){var r=hp.fromJSON(e.baseLayer);r&&i.setBaseLayer(r)}if(pc(n.layers)||n.layers){for(var o=[],s=e.layers,a=0;a<s.length;a++){var h=hp.fromJSON(s[a]);o.push(h)}i.addLayer(o)}return i},yp.include({computeLength:function(t,e){if(!this.getProjection())return null;var n=new Zd(t),i=new Zd(e);return n.equals(i)?0:this.getProjection().measureLength(n,i)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){var n=new Zd((t=t||{}).coordinate);return this._identify(t,e,(function(e){return e.identify(n,t)}))},identifyAtPoint:function(t,e){var n=new fu((t=t||{}).containerPoint),i=this.containerPointToCoord(n);return this._identify(t,e,(function(e){return e.identifyAtPoint?e.identifyAtPoint(n,t):i?e.identify(i,t):[]}))},_identify:function(t,e,n){var i=t.layers;if(!Su(i))return this;for(var r=[],o=0,s=i.length;o<s;o++)xc(i[o])?r.push(this.getLayer(i[o])):r.push(i[o]);for(var a=[],h=r.length-1;h>=0&&!(t.count&&a.length>=t.count);h--){var l=r[h];if(l&&l.getMap()&&(t.includeInvisible||l.isVisible())&&(t.includeInternals||!(l.getId().indexOf("_maptalks__internal_layer_")>=0))){var c=n(l);c&&(Array.isArray(c)?yu(a,c):a.push(c))}}return e.call(this,a),this}}),yp.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,n){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,n)))},_checkZoomOrigin:function(t){return t&&!this.options.zoomInCenter||(t=new fu(this.width/2,this.height/2)),this.options.zoomOrigin&&(t=new fu(this.options.zoomOrigin)),t},_startZoomAnim:function(t,e,n){pc(n)&&(n=1);var i=this._getResolution(this._startZoomVal)/this._getResolution(t),r=this.options.zoomAnimationDuration*Math.abs(i-n)/Math.abs(i-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:r})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,n){if(this.options.zoomable&&this._frameZoom!==t){pc(n)&&(n=1),this._zoomTo(t,e);var i=this.getResolution(t),r=this.getResolution(this._startZoomVal)/i/n,o=this._prjToContainerPoint(this._startZoomCoord,this._startZoomVal),s=this.getViewPoint();if(!this.isRotating()&&!o.equals(e)&&1!==r){var a=this.getPitch(),h=o._sub(e)._multi(1/(1-r));a&&(h.y/=Math.cos(a*Math.PI/180)),e=e.add(h)}var l={view:[r,0,0,r,(e.x-s.x)*(1-r),(e.y-s.y)*(1-r)]},c=this.getDevicePixelRatio();1!==c&&(e=e.multi(c)),l.container=[r,0,0,r,e.x*(1-r),e.y*(1-r)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:e,matrix:l}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var n=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._fireEvent("zoomend",{from:n,to:t}),this._verifyExtent(this._getPrjCenter())||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(t,e){this._zoomLevel=t,this._calcMatrices(),e&&this._setPrjCoordAtContainerPoint(this._startZoomCoord,e)},_checkZoom:function(t){var e=this.getMaxZoom(),n=this.getMinZoom();return t<n&&(t=n),t>e&&(t=e),t}});var N_,B_,H_,j_,z_,G_,U_,V_,W_,X_=Math.PI/180,Z_=new Zd(0,0);function q_(){return S_(new Array(16))}yp.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/X_},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*X_,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/X_:0},setBearing:function(t){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setBearing(t)},_setBearing:function(t){if(su.ie9)throw new Error("map can't rotate in IE9.");var e=-Eu(t,-180,180)*X_;if(this._angle===e)return this;var n=this.getBearing();return this._fireEvent("rotatestart",{from:n,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:n,to:e}),this._fireEvent("rotateend",{from:n,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){return this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setPitch(t)},_setPitch:function(t){if(su.ie9)throw new Error("map can't tilt in IE9.");var e=Cu(t,0,this.options.maxPitch)*X_;if(this._pitch===e)return this;var n=this.getPitch();return this._fireEvent("pitchstart",{from:n,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:n,to:e}),this._fireEvent("pitchend",{from:n,to:e}),this},isTransforming:function(){return!(!this._pitch&&!this._angle)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,n=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return n;e=Math.PI*e/180;var i=new fu(this.cameraPosition).distanceTo(new fu(this.cameraLookAt)),r=n*Math.tan(2*e);return n+Math.tan(e)*(i+r)},_pointToContainerPoint:function(t,e,n,i){void 0===n&&(n=0);var r=this._getResolution(e);return this._pointAtResToContainerPoint(t,r,n,i)},_pointAtResToContainerPoint:function(t,e,n,i){void 0===n&&(n=0),i||(i=new fu(0,0)),t=this._pointAtResToPoint(t,e,i);var r,o=this.isTransforming(),s=e/this._getResolution();return o||n||(r=this._prjToPoint(this._getPrjCenter(),void 0,Z_)),this._toContainerPoint(i,o,s,n,r),i},_pointsAtResToContainerPoints:function(t,e,n,i){void 0===n&&(n=[]),void 0===i&&(i=[]);var r=this.getPitch(),o=this.getBearing();if(0===r&&0===o){var s=this._get2DExtent(),a=s.xmin,h=s.ymin,l=s.xmax,c=s.ymax;if(l>a&&c>h){for(var u=e/this._getResolution(),f=this.getSize(),d=f.height,m=(l-a)/f.width,g=(c-h)/d,p=0,_=t.length;p<_;p++)if(t[p]){var v=i[p];v.x=t[p].x,v.y=t[p].y,v._multi(u),v.x=(v.x-a)*m,v.y=d-(v.y-h)*g}else i[p]=null;return i}}for(var y=Array.isArray(n),x=this.isTransforming(),b=e/this._getResolution(),w=this._prjToPoint(this._getPrjCenter(),void 0,Z_),T=0,M=t.length;T<M;T++)if(t[T]){var A=i[T];A.x=t[T].x,A.y=t[T].y,A._multi(b),this._toContainerPoint(A,x,b,y?n[T]||0:n,w)}else i[T]=null;return i},_toContainerPoint:(W_=[0,0,0],function(t,e,n,i,r){var o=this.width/2,s=this.height/2;if(e||i){var a=this._glScale;R_(W_,t.x*a,t.y*a,(i*=n)*a);var h=this._projIfBehindCamera(W_,this.cameraPosition,this.cameraForward);F_(h,h,this.projViewMatrix),t.x=h[0]*o+o,t.y=-h[1]*s+s}else t._sub(r.x,r.y),t.set(t.x,-t.y),t._add(o,s)}),_projIfBehindCamera:(G_=new Array(3),U_=new Array(3),V_=new Array(3),function(t,e,n){O_(G_,t,e);var i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(n,G_);return i<=0&&(function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(U_,n,1.01*i),function(t,e,n){t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2]}(t,e,O_(V_,G_,U_))),t}),_containerPointToPoint:function(t,e,n){var i=this._getResolution(e);return this._containerPointToPointAtRes(t,i,n)},_containerPointToPointAtRes:(H_=[0,0,0],j_=[0,0,0,1],z_=[0,0,0,1],function(t,e,n){if(this.isTransforming()){var i=this.width/2||1,r=this.height/2||1;R_(H_,(t.x-i)/i,(r-t.y)/r,0),R_(j_,H_[0],H_[1],0),R_(z_,H_[0],H_[1],1),j_[3]=z_[3]=1,F_(j_,j_,this.projViewMatrixInverse),F_(z_,z_,this.projViewMatrixInverse);var o=j_[1],s=z_[1],a=j_[2],h=z_[2],l=a===h?0:(0-a)/(h-a),c=Au(j_[0],z_[0],l),u=Au(o,s,l);return n?(n.x=c,n.y=u):n=new fu(c,u),n._multi(1/this._glScale),this._getResolution()===e?n:this._pointToPointAtRes(n,e,n)}var f=this._prjToPointAtRes(this._getPrjCenter(),e,n),d=this._getResolution()/e;return f._add(d*(t.x-this.width/2),-d*(t.y-this.height/2))}),_calcMatrices:(B_=q_(),function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,n=t.height||1;this._glScale=this.getGLScale();var i=this._getCameraWorldMatrix(),r=this.getFov()*Math.PI/180,o=this._getCameraFar(r,this.getPitch());this.cameraFar=o,this.cameraNear=this.cameraCenterDistance/20;var s=this.projMatrix||q_();T_(s,r,e/n,this.cameraNear,o),this.projMatrix=s,this.viewMatrix=C_(this.viewMatrix||q_(),i),this.projViewMatrix=E_(this.projViewMatrix||q_(),s,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=E_(this.projViewMatrixInverse||q_(),i,C_(B_,s)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this.getGLRes(),this._mapExtent2D=this._get2DExtent(),this._mapGlExtent2D=this._get2DExtentAtRes(this._mapGlRes)}),_getCameraFar:function(t,e){var n=this.cameraCenterDistance=L_(this.cameraPosition,this.cameraLookAt),i=n,r=(this.options.cameraInfiniteFar?10:4)*n;if(e>0&&(e=e*Math.PI/180,2/Math.PI-e>t/2)){var o=Math.tan(t/2),s=Math.tan(e);r=Math.max(n*o/(1/s-o),r)}return(i+=r)+1},_calcCascadeMatrixes:function(){var t=q_();function e(e,n,i){var r=this.width,o=this.height,s=this.getFov()*Math.PI/180,a=this._getCameraFar(s,n),h=this.cameraCenterDistance;return a=h+(a-h)/Math.cos((90-n)*Math.PI/180)*Math.cos((90-e)*Math.PI/180),T_(t,s,r/o,.1,a),E_(i,t,this.viewMatrix)}return function(){var t=this.getPitch(),n=this.options.cascadePitches[0],i=this.options.cascadePitches[1],r=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||q_(),o=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||q_();t>n?e.call(this,t,n,r):P_(this.cascadeFrustumMatrix0,this.projViewMatrix),t>i?e.call(this,t,i,o):P_(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var t=q_(),e=q_(),n=[1,-1,1],i=[0,0,0];return function(){var r=this.width||1,o=this.height||1,s=.5/Math.tan(this._fov/2)*o;return A_(t,this.projMatrix,n),M_(t,t,R_(i,0,0,-s)),this._pitch&&function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e[4],s=e[5],a=e[6],h=e[7],l=e[8],c=e[9],u=e[10],f=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*r+l*i,t[5]=s*r+c*i,t[6]=a*r+u*i,t[7]=h*r+f*i,t[8]=l*r-o*i,t[9]=c*r-s*i,t[10]=u*r-a*i,t[11]=f*r-h*i}(t,t,this._pitch),this._angle&&function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e[0],s=e[1],a=e[2],h=e[3],l=e[4],c=e[5],u=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r+l*i,t[1]=s*r+c*i,t[2]=a*r+u*i,t[3]=h*r+f*i,t[4]=l*r-o*i,t[5]=c*r-s*i,t[6]=u*r-a*i,t[7]=f*r-h*i}(t,t,this._angle),S_(e),A_(e,e,R_(i,r/2,-o/2,1)),E_(this.domCssMatrix||q_(),e,t)}}(),_getFovZ:function(t){var e=this.getGLScale(t),n=this._getFovRatio();return e*(this.height||1)/2/n},_getCameraWorldMatrix:(N_={},function(){var t=this.getGLRes(),e=this._prjToPointAtRes(this._prjCenter,t);this.cameraLookAt=R_(this.cameraLookAt||[0,0,0],e.x,e.y,0);var n=this.getPitch()*X_,i=this.getBearing()*X_,r=this._getFovZ(),o=r*Math.cos(n),s=Math.sin(n)*r,a=e.x-s*Math.sin(i),h=e.y-s*Math.cos(i);this.cameraPosition=R_(this.cameraPosition||[0,0,0],a,h,o),this.cameraToCenterDistance=L_(this.cameraPosition,this.cameraLookAt);var l=s||1,c=this.cameraUp=R_(this.cameraUp||[0,0,0],Math.sin(i)*l,Math.cos(i)*l,0),u=this.cameraWorldMatrix=this.cameraWorldMatrix||q_();!function(t,e,n,i){var r=[0,0,0],o=[0,0,0],s=[0,0,0];O_(s,e,n),0===I_(s)&&(s[2]=1),D_(s,s),k_(r,i,s),0===I_(s)&&(1===Math.abs(i[2])?s[0]+=1e-4:s[2]+=1e-4,D_(s,s),k_(r,i,s)),D_(r,r),k_(o,s,r),t[0]=r[0],t[4]=o[0],t[8]=s[0],t[1]=r[1],t[5]=o[1],t[9]=s[1],t[2]=r[2],t[6]=o[2],t[10]=s[2]}(u,this.cameraPosition,this.cameraLookAt,c);var f,d,m=this.cameraForward||[0,0,0];return O_(m,this.cameraLookAt,this.cameraPosition),this.cameraForward=D_(m,m),function(t,e){var n,i=e[0],r=e[4],o=e[8],s=e[1],a=e[5],h=e[9],l=e[2],c=e[6],u=e[10],f=i+a+u;f>0?(n=.5/Math.sqrt(f+1),t.w=.25/n,t.x=(c-h)*n,t.y=(o-l)*n,t.z=(s-r)*n):i>a&&i>u?(n=2*Math.sqrt(1+i-a-u),t.w=(c-h)/n,t.x=.25*n,t.y=(r+s)/n,t.z=(o+l)/n):a>u?(n=2*Math.sqrt(1+a-i-u),t.w=(o-l)/n,t.x=(r+s)/n,t.y=.25*n,t.z=(h+c)/n):(n=2*Math.sqrt(1+u-i-a),t.w=(s-r)/n,t.x=(o+l)/n,t.y=(h+c)/n,t.z=.25*n)}(N_,u),function(t,e){var n=t,i=e.x,r=e.y,o=e.z,s=e.w,a=i+i,h=r+r,l=o+o,c=i*a,u=i*h,f=i*l,d=r*h,m=r*l,g=o*l,p=s*a,_=s*h,v=s*l;n[0]=1-(d+g),n[4]=u-v,n[8]=f+_,n[1]=u+v,n[5]=1-(c+g),n[9]=m-p,n[2]=f-_,n[6]=m+p,n[10]=1-(c+d),n[3]=0,n[7]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}(u,N_),(d=u)[12]=(f=this.cameraPosition)[0],d[13]=f[1],d[14]=f[2],u}),_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*X_)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach((function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}}))}}),yp.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),n=this._viewHistory.length-1;n>=0;n--)if(Hu(t,this._viewHistory[n]))return this._viewHistoryPointer=n,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var i=this.options.viewHistoryCount;i>0&&this._viewHistory.length>i&&this._viewHistory.splice(0,this._viewHistory.length-i),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(t){if(void 0===t&&(t={}),!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(t){if(void 0===t&&(t={}),!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var n=this,i=this.getView();e.animation?this._animateTo(t,{duration:e.duration},(function(e){"finished"===e.state.playState&&n._fireViewChange(i,t)})):(this.setView(t),this._fireViewChange(i,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e})},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),yp.mergeOptions({viewHistory:!0,viewHistoryCount:10}),yp.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new Gd,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this}});var Y_=function(t){function e(e){var n;return(n=t.call(this,e)||this).on("enable",n._afterEnable,hu(hu(n))).on("disable",n._afterDisable,hu(hu(n))),n._measureLayers=[],n}au(e,t);var n=e.prototype;return n.clear=function(){if(Su(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},n.getMeasureLayers=function(){return this._measureLayers},n.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},n.undo=function(){t.prototype.undo.call(this);var e=this._historyPointer;if(e!==this._vertexes.length)for(var n=e;n<this._vertexes.length;n++)this._vertexes[n].label&&this._vertexes[n].label.remove(),this._vertexes[n].marker.remove();return this},n.redo=function(){t.prototype.redo.call(this);var e=this._historyPointer-1;return this._vertexes[e]&&(this._vertexes[e].marker.getLayer()||(this._vertexes[e].label&&this._vertexes[e].label.addTo(this._measureMarkerLayer),this._vertexes[e].marker.addTo(this._measureMarkerLayer))),this},n._measure=function(t){var e,n,i=this.getMap();t instanceof sp?e=i.computeGeometryLength(t):Array.isArray(t)&&(e=i.getProjection().measureLength(t)),this._lastMeasure=e,n="zh-CN"===this.options.language?[" \u7c73"," \u516c\u91cc"," \u82f1\u5c3a"," \u82f1\u91cc"]:[" m"," km"," feet"," mile"];var r="";return this.options.metric&&(r+=e<1e3?e.toFixed(0)+n[0]:(e/1e3).toFixed(2)+n[1]),this.options.imperial&&(r.length>0&&(r+="\n"),r+=(e*=3.2808399)<5280?e.toFixed(0)+n[2]:(e/5280).toFixed(2)+n[3]),r},n._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},n._afterEnable=function(){this._registerMeasureEvents()},n._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},n._msOnDrawStart=function(t){var e=this.getMap(),n=e._pointToPrj(t.point2d),i=pu(),r="distancetool_"+i,o="distancetool_markers_"+i;e.getLayer(r)?(this._measureLineLayer=e.getLayer(r),this._measureMarkerLayer=e.getLayer(o)):(this._measureLineLayer=new m_(r).addTo(e),this._measureMarkerLayer=new m_(o).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer);var s=new Lp(t.coordinate,{symbol:this.options.vertexSymbol});s._setPrjCoordinates(n);var a=new s_("zh-CN"===this.options.language?"\u8d77\u70b9":"start",t.coordinate,this.options.labelOptions);a._setPrjCoordinates(n),this._lastVertex=a,this._addVertexMarker(s,a)},n._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var n=Wf(this.options.vertexSymbol);n.markerWidth/=2,n.markerHeight/=2,this._tailMarker=new Lp(t.coordinate,{symbol:n}).addTo(this._measureMarkerLayer),this._tailLabel=new s_(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var i=this._geometry._getPrjCoordinates(),r=i[i.length-1];this._tailMarker.setCoordinates(t.coordinate),this._tailMarker._setPrjCoordinates(r),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(t.coordinate),this._tailLabel._setPrjCoordinates(r)},n._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},n._msOnDrawVertex=function(t){var e=this._geometry._getPrjCoordinates(),n=e[e.length-1],i=t.geometry,r=new Lp(t.coordinate,{symbol:this.options.vertexSymbol}),o=this._measure(i),s=new s_(o,t.coordinate,this.options.labelOptions);this._addVertexMarker(r,s),s._setPrjCoordinates(n),r._setPrjCoordinates(n),this._lastVertex=s},n._addVertexMarker=function(t,e){this._vertexes||(this._vertexes=[]),void 0!==this._historyPointer&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:e,marker:t}),this._measureMarkerLayer.addGeometry(t),e&&this._measureMarkerLayer.addGeometry(e)},n._msOnDrawEnd=function(t){if(this._clearTailMarker(),t.geometry._getPrjCoordinates().length<2)return this._lastMeasure=0,void this._clearMeasureLayers();var e=this._lastVertex.getSize();e||(e=new Af(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),e.width);var n=t.geometry.copy();n._setPrjCoordinates(t.geometry._getPrjCoordinates()),n.addTo(this._measureLineLayer),this._lastMeasure=n.getLength()},n._addClearMarker=function(t,e,n){var i=this.options.clearButtonSymbol,r={markerDx:(i.markerDx||0)+n,textDx:(i.textDx||0)+n};Array.isArray(i)&&(r=i.map((function(t){return t?{markerDx:(t.markerDx||0)+n,textDx:(t.textDx||0)+n}:null}))),i=Wf(i,r);var o=new Lp(t,{symbol:i}),s=this._measureLineLayer,a=this._measureMarkerLayer;o.on("click",(function(){return s.remove(),a.remove(),!1}),this),o.addTo(this._measureMarkerLayer),o._setPrjCoordinates(e)},n._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},n._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},e}(v_);Y_.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]}),function(t){function e(e){var n;return(n=t.call(this,e)||this)._measureLayers=[],n}au(e,t);var n=e.prototype;return n._measure=function(t){var e,n,i=this.getMap();t instanceof sp?e=i.computeGeometryArea(t):Array.isArray(t)&&(e=i.getProjection().measureArea(t)),this._lastMeasure=e,n="zh-CN"===this.options.language?[" \u5e73\u65b9\u7c73"," \u5e73\u65b9\u516c\u91cc"," \u5e73\u65b9\u82f1\u5c3a"," \u5e73\u65b9\u82f1\u91cc"]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var r="";return this.options.metric&&(r+=e<1e6?e.toFixed(0)+n[0]:(e/1e6).toFixed(2)+n[1]),this.options.imperial&&(r.length>0&&(r+="\n"),r+=(e*=3.2808399)<27878400?e.toFixed(0)+n[2]:(e/27878400).toFixed(2)+n[3]),r},n._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},n._msOnDrawVertex=function(t){var e=this.getMap()._pointToPrj(t.point2d),n=new Lp(t.coordinate,{symbol:this.options.vertexSymbol});n._setPrjCoordinates(e),this._measure(t.geometry),this._lastVertex=n,this._addVertexMarker(n)},n._msOnDrawEnd=function(t){var e;if(this._clearTailMarker(),t.point2d)e=this.getMap()._pointToPrj(t.point2d);else{var n=t.geometry._getPrjCoordinates();n=n.slice(0,n.length-1),t.geometry._setPrjCoordinates(n),e=n[n.length-1]}if(t.geometry._getPrjCoordinates().length<3)return this._lastMeasure=0,void this._clearMeasureLayers();var i=this._measure(t.geometry),r=this.getMap().getProjection().unproject(e),o=new s_(i,r,this.options.labelOptions).addTo(this._measureMarkerLayer);o._setPrjCoordinates(e);var s=o.getSize();s||(s=new Af(10,10)),this._addClearMarker(r,e,s.width);var a=t.geometry.copy();a._setPrjCoordinates(t.geometry._getPrjCoordinates()),a.addTo(this._measureLineLayer),this._lastMeasure=a.getArea()},e}(Y_).mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}});var K_={create:function(t,e){var n=t.unproject(e[0]),i=new qp(n,0);return i._setPrjCoordinates(e[0]),i},update:function(t,e,n){var i=n.getMap(),r=Array.isArray(e)?e[e.length-1]:e,o=t.unproject(r),s=i.computeLength(n.getCenter(),o);n.setRadius(s)},generate:function(t){return t}};v_.registerMode("circle",gc({clickLimit:2,action:["click","mousemove","click"]},K_)),v_.registerMode("freeHandCircle",gc({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},K_));var J_={create:function(t,e){var n=t.unproject(e[0]),i=new Yp(n,0,0);return i._setPrjCoordinates(e[0]),i},update:function(t,e,n){var i=n.getMap(),r=n.getCenter(),o=Array.isArray(e)?e[e.length-1]:e,s=t.unproject(o),a=i.computeLength(r,new Zd({x:s.x,y:r.y})),h=i.computeLength(r,new Zd({x:r.x,y:s.y}));n.setWidth(2*a),n.setHeight(2*h)},generate:function(t){return t}};v_.registerMode("ellipse",gc({clickLimit:2,action:["click","mousemove","click"]},J_)),v_.registerMode("freeHandEllipse",gc({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},J_));var Q_={create:function(t,e){var n=new Ip([]);return n._firstClick=e[0],n},update:function(t,e,n,i){var r=n.getMap(),o=i.containerPoint,s=r._prjToContainerPoint(n._firstClick),a=[[s.x,s.y],[o.x,s.y],[o.x,o.y],[s.x,o.y]];n.setCoordinates(a.map((function(t){return r.containerPointToCoord(new fu(t))}))),n._setPrjCoordinates(a.map((function(t){return r._containerPointToPrj(new fu(t))})))},generate:function(t){return t}};v_.registerMode("rectangle",gc({clickLimit:2,action:["click","mousemove","click"]},Q_)),v_.registerMode("freeHandRectangle",gc({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Q_)),v_.registerMode("point",{clickLimit:1,action:["click","mousemove"],create:function(t,e){var n=t.unproject(e[0]),i=new Lp(n);return i._setPrjCoordinates(e[0]),i},generate:function(t){return t},update:function(t,e,n){if(Array.isArray(e)&&(e=e[e.length-1]),!e)return n;var i=t.unproject(e);return n.setCoordinates(i),n}});var $_={create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new Np(n);return i._setPrjCoordinates(e),i},update:function(t,e,n){var i,r=n.getSymbol();Array.isArray(e)?i=e:(i=n._getPrjCoordinates()).push(e);var o=i.map((function(e){return t.unproject(e)}));n.setCoordinates(o),n._setPrjCoordinates(i);var s=n.getLayer();if(s){var a=s.getGeometryById("polygon");if(!a&&i.length>=3){if(a=new Ip([o],{id:"polygon"}),r){var h=Wf(r,{lineOpacity:0});a.setSymbol(h)}a.addTo(s)}a&&a._setPrjCoordinates(i)}},generate:function(t){var e=new Ip(t.getCoordinates(),{symbol:t.getSymbol()});return e._setPrjCoordinates(t._getPrjCoordinates()),e._projCode=t._projCode,e}};v_.registerMode("polygon",gc({action:["click","mousemove","dblclick"]},$_)),v_.registerMode("freeHandPolygon",gc({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},$_));var tv={create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new Np(n);return i._setPrjCoordinates(e),i},update:function(t,e,n){var i;Array.isArray(e)?i=e:(i=n._getPrjCoordinates()).push(e);var r=i.map((function(e){return t.unproject(e)}));n.setCoordinates(r),n._setPrjCoordinates(i)},generate:function(t){return t}};function ev(t){for(var e=t.tileInfo,n=[e.cols,e.rows],i=[],r=e.lods,o=0,s=r.length;o<s;o++)i.push(r[o].resolution);var a=t.fullExtent,h=e.origin,l=[1,-1,h.x,h.y];return delete a.spatialReference,{spatialReference:{resolutions:i,fullExtent:a},tileSystem:l,tileSize:n}}function nv(t,e){return void 0===e&&(e=[]),e.forEach((function(e){t=t.replace(e[0],e[1])})),t}function iv(t){var e=t.projection,n=t.isArcgis,i=t.isGeoServer,r=t.isSuperMap,o=.0002645833333333333;return(n||i||r)&&(o=28e-5),e&&e.indexOf("4326")>-1&&(o=2.3767925226029154e-9,(n||r)&&(o=2.518101729011901e-9),i&&(o=2.51528279553466e-9)),o}function rv(t,e){var n=t.getElementsByTagName(e);return n&&n.length?n:t.getElementsByTagName("wmts:"+e)}function ov(t,e){for(var n=0;n<t.length;n++){var i=t[n];if((i=i.getElementsByTagName("ows:Identifier")[0])&&i.textContent===e)return t[n]}return null}function sv(t,e){void 0===e&&(e={});var n,i,r,o=rv(t,"TileMatrix"),s=[],a=[],h=[],l=!1;if(!n){var c=t.getElementsByTagName("ows:SupportedCRS")[0];c&&(n=function(t){var e=t.indexOf("EPSG")>-1?t:"EPSG:"+t;return nv(e,[["4490","4326"],["102100","3857"],["900913","3857"]])}(n=function(t){for(var e="",n=t.split(""),i=n.length-1;i>=0&&!isNaN(n[i]);i--)e=n[i]+e;return e}(n=(n=c.textContent).split("EPSG")[1])))}i||(i=t.getElementsByTagName("ows:Identifier")[0])&&(i=i.textContent),e.projection=n;for(var u=1/0,f=0;f<o.length;f++){var d=o[f],m=d.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(m))?(r=m.substr(0,m.lastIndexOf(":")),m=(m=m.split(":"))[m.length-1],m=parseInt(m),l=!0,e.isGeoServer=!0):m=parseInt(m),u=Math.min(u,m);var g=rv(d,"ScaleDenominator")[0].textContent,p=rv(d,"TopLeftCorner")[0].textContent,_=rv(d,"TileWidth")[0].textContent,v=rv(d,"TileHeight")[0].textContent;if(0===h.length&&h.push(parseInt(_),parseInt(v)),0===a.length){var y=p.split(" ").filter((function(t){return""!==t})).map((function(t){return parseFloat(t)})),x=y[0],b=y[1];x>0?a.push(1,-1,b,x):a.push(1,-1,x,b)}var w=iv(e),T=parseFloat(g)*w;s.push(T)}if(u>0)for(var M=s[0],A=u-1;A>=0;A--)s.splice(0,0,M*=2);return{resolutions:s,tileSize:h,tileSystem:a,projection:n,TileMatrixSet:i,isGeoServer:l,levelStr:r}}v_.registerMode("linestring",gc({action:["click","mousemove","dblclick"]},tv)),v_.registerMode("freeHandLinestring",gc({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},tv)),v_.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new $p(n);return i._setPrjCoordinates(e),i},update:tv.update,generate:function(t){return t}}),v_.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new e_(n);return i._setPrjCoordinates(e),i},update:tv.update,generate:function(t){return t}}),v_.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t,e){var n=e.map((function(e){return t.unproject(e)})),i=new t_(n);return i._setPrjCoordinates(e),i},update:tv.update,generate:function(t){return t}}),v_.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t,e){var n=t.unproject(e=e[0]),i=new Lp(n);return i._firstClick=e,i},update:function(t,e,n,i){var r=n.getMap(),o=r._prjToContainerPoint(n._firstClick),s=i.containerPoint;e=r._containerPointToPrj(new Zd(Math.min(o.x,s.x),Math.min(o.y,s.y)));var a=t.unproject(e);n.setCoordinates(a)._setPrjCoordinates(e),n.updateSymbol({markerWidth:Math.abs(o.x-s.x),markerHeight:Math.abs(o.y-s.y)})},generate:function(t){return t}}),ip.loadArcgis=function(t,e,n){if(void 0===n&&(n={jsonp:!0}),xc(t)&&"{"!==t.substring(0,1))Cd.getJSON(t,(function(t,n){if(t)e(t);else{var i=ev(n);e(null,i)}}),n);else{xc(t)&&(t=vu(t));var i=ev(t);e(null,i)}return this},ip.loadWMTS=function(t,e,n){return void 0===n&&(n={jsonp:!0}),xc(t)&&Cd.get(t,(function(i,r){if(i)e(i);else{var o=function(t,e,n){null==n.isArcgis&&(n.isArcgis=t.indexOf("arcgis")>-1),null==n.isSuperMap&&(n.isSuperMap=t.indexOf("supermap")>-1);var i=(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("Contents")[0];if(!i)return[];var r=rv(i,"Layer");if(!r.length)return[];for(var o=[],s=0,a=i.childNodes.length;s<a;s++)"TileMatrixSet"===i.childNodes[s].localName&&o.push(i.childNodes[s]);if(!o.length)return[];for(var h=[],l=0,c=r.length;l<c;l++){var u=r[l],f=u.querySelectorAll("Style")[0];f&&(f=f.getElementsByTagName("ows:Identifier")[0])&&(f=f.textContent);var d=u.getElementsByTagName("ows:Identifier")[0];d&&(d=d.textContent);var m=rv(u,"TileMatrixSetLink");if(0!==m.length)for(var g=0,p=m.length;g<p;g++){var _=m[g];(_=rv(_,"TileMatrixSet")[0])&&(_=_.textContent);var v=ov(o,_);if(v){var y=u.querySelectorAll("ResourceURL")[0],x="";y&&(x=y.attributes.template.value);var b=sv(v,n),w=b.resolutions,T=b.tileSize,M=b.tileSystem,A=b.projection,E=b.TileMatrixSet,C=b.isGeoServer,S=b.levelStr;x.length||(x=e.substr(0,e.lastIndexOf("?")),x+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var P=nv(x,[["{LAYER}",d],["{Layer}",d],["{layer}",d],["{STYLE}",f],["{Style}",f],["{style}",f],["{TileMatrixSet}",E],["{TileMatrix}",C?S+":{z}":"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",C?"image/png":"tiles"]]);h.push({tileSize:T,tileSystem:M,spatialReference:{resolutions:w,projection:A},urlTemplate:P,info:{layerName:d,TileMatrixSet:E,style:f,tileSize:T,tileSystem:M,resolutions:w,projection:A,urlTemplate:P}})}}}return h}(r,t,n);e(null,o)}}),n),this};var av=function(t){function e(e){return t.call(this,e)||this}au(e,t);var n=e.prototype;return n.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},n.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},n.show=function(t){var e=this.getMap();if(!e)return this;this.options.visible=!0,t=t||this._coordinate||this._owner.getCenter();var n=this.isVisible();this._showBySymbolChange||this.fire("showstart");var i=this._getUIContainer();this._coordinate=t,this._removePrevDOM(),this._mapEventsOn||this._switchMapEvents("on");var r=this.__uiDOM=this.buildOn(e);if(r.eventsPropagation=this.options.eventsPropagation,this._observerDomSize(r),!r)return this._showBySymbolChange||this.fire("showend"),this;this._measureSize(r),this._singleton()&&(r._uiComponent=this,e[this._uiDomKey()]=r),this._setPosition(),r.style[nd]=null,i.appendChild(r);var o=this._getAnimation();if(n&&(o.ok=!1),o.ok&&(o.fade&&(r.style.opacity=0),o.scale)){if(this.getTransformOrigin){var s=this.getTransformOrigin();r.style[ed]=s}r.style[td]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(r.style.display=""),this.options.eventsToStop&&bd(r,this.options.eventsToStop,cd),this.options.autoPan&&this._autoPan();var a=o.transition;return o.ok&&a&&(a&&(r.style[nd]=a),o.fade&&(r.style.opacity=1),o.scale&&(r.style[td]=this._toCSSTranslate(this._pos)+" scale(1)")),this._showBySymbolChange||this.fire("showend"),this},n.hide=function(){var t=this;if(!this.getDOM())return this;this.options.visible=!1;var e=this._getAnimation(),n=this.getDOM();return this.options.animationOnHide||(e.ok=!1),e.ok?(n.style[nd]=e.transition,setTimeout((function(){n.style.display="none",t.fire("hide")}),this.options.animationDuration)):(n.style.display="none",this.fire("hide")),e.fade&&(n.style.opacity=0),e.scale&&(n.style[td]=this._toCSSTranslate(this._pos)+" scale(0)"),this._switchMapEvents("off"),this},n.isVisible=function(){if(!this.options.visible)return!1;var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},n.remove=function(){return delete this._mapEventsOn,this._owner?(this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this):this},n.getSize=function(){return this._domContentRect&&this._size&&(this._size.width=this._domContentRect.width,this._size.height=this._domContentRect.height),this._size?this._size.copy():null},n.getOwner=function(){return this._owner},n.getDOM=function(){return this.__uiDOM},n._roundPoint=function(t){return this.options.roundPoint&&(t=t._round()),t},n.getPosition=function(){if(!this.getMap())return null;var t=this._roundPoint(this._getViewPoint());if(this.getOffset){var e=this._roundPoint(this.getOffset());e&&t._add(e)}return t},n._getAnimation=function(){for(var t={fade:!1,scale:!1},e=this.options.animation?this.options.animation.split(","):[],n=0;n<e.length;n++){var i=Ef(e[n]);"fade"===i?t.fade=!0:"scale"===i&&(t.scale=!0)}var r=null;return t.fade&&(r="opacity "+this.options.animationDuration+"ms"),t.scale&&(r=r?r+",":"",r+=td+" "+this.options.animationDuration+"ms"),t.transition=r,t.ok=null!==r,t},n._getViewPoint=function(){var t=0,e=this._coordinate||{};_c(e.z)?t=e.z:this._owner&&this._owner.getAltitude&&(t=this._owner.getAltitude()||0);var n=this._meterToPoint(this._coordinate,t);return this.getMap().coordToViewPoint(this._coordinate,void 0,n)._add(this.options.dx,this.options.dy)},n._meterToPoint=function(t,e){var n=this.getMap();return n.altitudeToPoint(e,n._getResolution())*Tu(e)},n._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(!t.isMoving()){var n=this._getViewPoint()._round(),i=t.width,r=t.height,o=t.viewPointToContainerPoint(n),s=this.getOffset(),a=o.add(s),h=t._viewPointToPrj(n),l=parseInt(e.clientWidth),c=parseInt(e.clientHeight),u=0,f=0;if(a.x<0?u=50-a.x:a.x+l>i&&(u=-(a.x+l-i)-50),a.y-c<0?f=Math.abs(a.y-c)+50:a.y+c>r&&(f=r-(a.y+c)-50),l>=i&&(u=i/2-o.x),0!==f||0!==u){var d=o.add(u,f),m=t._containerPointToPoint(d)._sub(t._prjToPoint(t._getPrjCenter())),g=t._pointToPrj(t._prjToPoint(h).sub(m));t._panAnimation(g)}}},n._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute";var n=t.style.bottom?"bottom":"top";if(t.style.display="",e.appendChild(t),t.getBoundingClientRect){var i=t.getBoundingClientRect();this._size=new Af(i.width,i.height)}else this._size=new Af(t.clientWidth,t.clientHeight);return t.style.display="none",t.style.left="0px",t.style[n]="0px",this._size},n._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),n=this._uiDomKey();if(e[n]){t&&wd(e[n],t,cd);var i=e[n]._uiComponent;i&&i!==this&&i.isVisible()&&i.fire("hide"),od(e[n]),i&&!this.hideDom&&i._switchMapEvents("off"),delete e[n]}delete this.__uiDOM}else this.__uiDOM&&(t&&wd(this.__uiDOM,t,cd),od(this.__uiDOM),delete this.__uiDOM);this._resizeObserver&&(this._resizeObserver.disconnect(),delete this._resizeObserver,delete this._domContentRect)},n._uiDomKey=function(){return"__ui_"+this._getClassName()},n._singleton=function(){return this.options.single},n._getUIContainer=function(){return this.getMap()._panels.ui},n._getClassName=function(){return"UIComponent"},n._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var n=this._getDefaultEvents();if(this.getEvents&&gc(n,this.getEvents()),n)for(var i in n)n.hasOwnProperty(i)&&e[t](i,n[i],this)}},n._switchEvents=function(t){var e=this._getOwnerEvents();if(this._owner)for(var n in e)e.hasOwnProperty(n)&&this._owner[t](n,e[n],this)},n._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,moveend:this.onMoving,resize:this.onResize}},n._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof sp&&(t.positionchange=this.onGeometryPositionChange,t.symbolchange=this._updatePosition),this.getOwnerEvents&&gc(t,this.getOwnerEvents()),t},n.onGeometryPositionChange=function(t){this._owner&&this.isVisible()&&(this._showBySymbolChange=!0,this.show(t.target.getCenter()),delete this._showBySymbolChange)},n.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},n.onEvent=function(){this.isVisible()&&this._updatePosition()},n.onZoomEnd=function(){this.isVisible()&&this._setPosition()},n.onResize=function(){this.isVisible()&&this._setPosition()},n.onDomSizeChange=function(){this.isVisible()&&this._setPosition()},n._updatePosition=function(){return this.getMap()?(this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this)),this):this},n._setPosition=function(){var t=this.getDOM();if(t){t.style[nd]=null;var e=this.getPosition();this._pos=e,t.style[td]=this._toCSSTranslate(e)+" scale(1)"}},n._toCSSTranslate=function(t){if(!t)return"";if(su.any3d){var e=this.getMap(),n=e?e.getBearing():0,i=e?e.getPitch():0,r="";return this.options.pitchWithMap&&i&&(r+=" rotateX("+Math.round(i)+"deg)"),this.options.rotateWithMap&&n&&(r+=" rotateZ("+Math.round(-n)+"deg)"),"translate3d("+t.x+"px,"+t.y+"px, 0px)"+r}return"translate("+t.x+"px,"+t.y+"px)"},n._observerDomSize=function(t){var e=this;return t&&su.resizeObserver&&!this._resizeObserver?(this._resizeObserver=new ResizeObserver((function(t){t.length?e._domContentRect=t[0].contentRect:delete e._domContentRect,e.onDomSizeChange&&e.onDomSizeChange()})),this._resizeObserver.observe(t),this):this},n.isSupportZoomFilter=function(){return!1},e.isSupport=function(t){return!!(t&&bc(t.on)&&bc(t.off)&&bc(t.getCenter))},e}(Fd(Bd));av.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!1,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0,roundPoint:!1});var hv="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",lv=function(t){function e(e,n){var i;return(i=t.call(this,n)||this)._markerCoord=new Zd(e),i}au(e,t);var n=e.prototype;return n._getClassName=function(){return"UIMarker"},n.setCoordinates=function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition()),this},n.getCoordinates=function(){return this._markerCoord},n.getCenter=function(){return this.getCoordinates()},n.getAltitude=function(){var t=this.getCoordinates()||{};return _c(t.z)?t.z:this.options.altitude||0},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},n.getContent=function(){return this.options.content},n.onAdd=function(){this.show()},n.show=function(){return t.prototype.show.call(this,this._markerCoord)},n.flash=function(t,e,n,i){return zu.call(this,t,e,n,i)},n.buildOn=function(){var t,e=this.options.content,n=xc(e);return n||bc(e)?(t=id("div"),n?t.innerHTML=this.options.content:e.bind(this)(t)):t=this.options.content,this.options.containerClass&&(t.className=this.options.containerClass),this._registerDOMEvents(t),t},n.getOffset=function(){var t=this.getSize();return new fu(-t.width/2,-t.height/2)},n.getTransformOrigin=function(){return"center center"},n.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},n.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},n._registerDOMEvents=function(t){bd(t,hv,this._onDomEvents,this)},n._onDomEvents=function(t){var e=this.getMap()._parseEvent(t,t.type),n=t.type;if("mousedown"===n&&(this._mousedownEvent=t),"mouseup"===n&&(this._mouseupEvent=t),("click"!==n||!this._mouseClickPositionIsChange())&&("touchstart"===n&&(this._touchstartTime=mc()),this.fire(t.type,e),"touchend"===n&&su.touch)){var i=this.getMap().options.clickTimeThreshold||280;mc()-this._touchstartTime<i&&this._onDomEvents(gc({},t,{type:"click"}))}},n._removeDOMEvents=function(t){wd(t,hv,this._onDomEvents)},n._mouseClickPositionIsChange=function(){var t=this._mousedownEvent||{},e=this._mouseupEvent||{};return t.x!==e.x||t.y!==e.y},n._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),n=this.getSize(),i=n.width,r=n.height;return[t.containerPointToCoordinate(e.add(-i/2,0)),t.containerPointToCoordinate(e.add(i/2,0)),t.containerPointToCoordinate(e.add(0,r/2)),t.containerPointToCoordinate(e.add(0,-r/2))]},n._getViewPoint=function(){var t=0;if(this._owner){var e=this.getAltitude();e>0&&(t=this._meterToPoint(this._coordinate,e))}return this.getMap().coordToViewPoint(this._coordinate,void 0,t)._add(this.options.dx,this.options.dy)},n._getDefaultEvents=function(){return gc({},t.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},n._setPosition=function(){this.onZoomFilter(),t.prototype._setPosition.call(this)},n.onZoomFilter=function(){var t=this.getDOM();t&&(this.isVisible()||"none"===t.style.display?this.isVisible()&&"none"===t.style.display&&(t.style.display=""):t.style.display="none")},n.isVisible=function(){var t=this.getMap();if(!t)return!1;if(!this.options.visible)return!1;var e=t.getZoom(),n=this.options,i=n.minZoom,r=n.maxZoom;return!(!pc(i)&&e<i||!pc(r)&&e>r)&&this.getDOM()&&!0},n.isSupportZoomFilter=function(){return!0},e}(Ud(av));lv.mergeOptions({containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null});var cv=su.touch?"touchstart mousedown":"mousedown",uv=function(t){function e(e){return t.call(this,e)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on(cv,this._startDrag,this)},n.removeHooks=function(){this.target.off(cv,this._startDrag,this)},n._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},n._prepareDragHandler=function(){this._dragHandler=new Xd(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},n._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},n._onMouseDown=function(t){cd(t.domEvent)},n._dragging=function(t){var e=this.target,n=e.getMap()._parseEvent(t.domEvent),i=n.domEvent;if(!(i.touches&&i.touches.length>1))if(this._isDragging){var r=n.coordinate,o=n.containerPoint;this._lastCoord||(this._lastCoord=r),this._lastPoint||(this._lastPoint=o);var s=r.sub(this._lastCoord),a=o.sub(this._lastPoint);this._lastCoord=r,this._lastPoint=o,this.target.setCoordinates(this.target.getCoordinates().add(s)),n.coordOffset=s,n.pointOffset=a,e.fire("dragging",n)}else this._isDragging=!0},n._endDrag=function(t){var e=this.target,n=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,n){var i=n._parseEvent(t.domEvent);e&&e._mouseClickPositionIsChange&&e._mouseClickPositionIsChange()&&e.fire("dragend",i)}},n.isDragging=function(){return!!this._isDragging},e}(Nd);lv.addInitHook("addHandler","draggable",uv);var fv=/\{ *([\w_]+) *\}/g,dv={containerClass:"maptalks-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:"auto",minHeight:120,custom:!1,title:null,content:null,enableTemplate:!1},mv=new Af(0,0),gv=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n._getClassName=function(){return"InfoWindow"},n.addTo=function(e){return e instanceof sp&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},n.getContent=function(){return this.options.content},n.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},n.getTitle=function(){return this.options.title},n.buildOn=function(){var t=bc(this.options.content),e=xc(this.options.content);if(this.options.custom){if(e||t){var n=id("div");return e?(n.innerHTML=this.options.content,this._replaceTemplate(n)):this.options.content.bind(this)(n),n}return this._replaceTemplate(this.options.content),this.options.content}var i=id("div");this.options.containerClass&&(i.className=this.options.containerClass);var r=this._getWindowWidth();i.style.width=_c(r)?r+"px":"auto",i.style.bottom="0px";var o='<em class="maptalks-ico"></em>';this.options.title&&(o+="<h2>"+this.options.title+"</h2>"),i.innerHTML=o+='<a href="javascript:void(0);" class="maptalks-close"></a><div class="maptalks-msgContent"></div>',this._replaceTemplate(i);var s=i.querySelector(".maptalks-msgContent");return e||t?e?s.innerHTML=this.options.content:this.options.content.bind(this)(s):s.appendChild(this.options.content),this._onCloseBtnClick=this.hide.bind(this),sd(i.querySelector(".maptalks-close"),"click touchend",this._onCloseBtnClick),t||this._replaceTemplate(s),i},n._replaceTemplate=function(t){if(this.options.enableTemplate&&this._owner&&this._owner.getProperties&&t&&t.innerHTML){var e=this._owner.getProperties()||{};yc(e)&&(t.innerHTML=t.innerHTML.replace(fv,(function(t,n){return e[n]})))}return this},n.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},n.getOffset=function(){var t=this.getSize(),e=new fu(-t.width/2,0);this.options.custom?e._sub(0,t.height):e._sub(4,12);var n=this.getOwner();if(n instanceof Lp||n instanceof Gp){var i,r;if(n instanceof Lp)i=n._getPainter(),r=n.getSize();else{var o=n.getGeometries();if(!o||!o.length)return e;i=o[0]._getPainter(),r=o[0].getSize()}if(r||(r=mv),i){var s=i.getFixedExtent();e._add(s.xmax-r.width/2,s.ymin)}else e._add(0,-r.height)}return e},n.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},n.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},n.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},n.onRemove=function(){this.onDomRemove()},n.onDomRemove=function(){this._onCloseBtnClick&&(ad(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},n._onAutoOpen=function(t){var e=this,n=this.getOwner();setTimeout((function(){n instanceof Lp||n instanceof av?e.show(n.getCoordinates()):n instanceof Gp?e.show(n.findClosest(t.coordinate)):n instanceof Np||n instanceof Vp?(e.getMap().getScale()>=8&&(t.coordinate=e._rectifyMouseCoordinte(n,t.coordinate)),e.show(t.coordinate)):e.show(t.coordinate)}),1)},n._rectifyMouseCoordinte=function(t,e){var n=this;return t instanceof Np?this._rectifyLineStringMouseCoordinate(t,e).coordinate:t instanceof Vp?t.getGeometries().map((function(t){return n._rectifyLineStringMouseCoordinate(t,e)})).sort((function(t,e){return t.dis-e.dis}))[0].coordinate:e},n._rectifyLineStringMouseCoordinate=function(t,e){for(var n=this,i=t.getCoordinates().map((function(t){return n.getMap().coordToContainerPoint(t)})),r=this.getMap().coordToContainerPoint(e),o=1/0,s=-1,a=0,h=i.length;a<h;a++){var l=r.distanceTo(i[a]);l<o&&(o=l,s=a)}var c=[];0===s?c.push(i[0],i[1]):s===i.length-1?c.push(i[s-1],i[s]):c.push(i[s-1],i[s],i[s+1]);for(var u=[],f=this.getMap().getSize(),d=f.width,m=f.height,g=0,p=c.length-1;g<p;g++){var _=c[g],v=c[g+1];if(_.x===v.x)for(var y=Math.max(0,Math.min(_.y,v.y)),x=Math.min(m,Math.max(_.y,v.y)),b=y;b<=x;b++)u.push(new fu(_.x,b));else for(var w=(v.y-_.y)/(v.x-_.x),T=Math.max(0,Math.min(_.x,v.x)),M=Math.min(d,Math.max(_.x,v.x)),A=T;A<=M;A++)u.push(new fu(A,w*(A-_.x)+_.y))}for(var E=1/0,C=-1,S=0,P=u.length;S<P;S++){var R=r.distanceTo(u[S]);R<E&&(E=R,C=S)}return{dis:E,coordinate:C<0?e:this.getMap().containerPointToCoord(u[C])}},n._getWindowWidth=function(){var t=this.options.width;return t||(t=dv.width),t},e}(av);gv.mergeOptions(dv);var pv="remove hide shapechange positionchange dragend animatestart";(function(t){au(n,t);var e=n.prototype;function n(e,n){var i;return void 0===n&&(n={}),(i=t.call(this,n)||this)._content=e,i}return e._getClassName=function(){return"ToolTip"},e.addTo=function(e){if(n.isSupport(e))return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),e.on(pv,this.hideDom,this),t.prototype.addTo.call(this,e);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},e.setStyle=function(t){return this.options.containerClass=t,this},e.getStyle=function(){return this.options.containerClass},e.getContent=function(){return this._content},e.buildOn=function(){var t=id("div"),e=this.options||{};e.height&&(t.style.height=e.height+"px"),e.width&&(t.style.width=e.width+"px");var n=e.containerClass||e.cssName;return!n&&e.height&&(t.style.lineHeight=e.height+"px"),bc(this._content)?this._content.bind(this)(t):t.innerHTML='<div class="'+n+'">'+this._content+"</div>",t},e.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM(),this._switchMapEvents("off")},e.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var n=this.getMap();if(n){var i=n.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(i):this._timeout=setTimeout((function(){n&&e.show(i)}),this.options.showTimeout)}},e.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mouseover",this.onMouseOver,this),this._owner.off("mouseout",this.onMouseOut,this),this._owner.off(pv,this.hideDom,this))},e.hideDom=function(){return this.hide()},e.onEvent=function(){return t.prototype.onEvent.call(this),this.hideDom(),this},e._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},n})(av).mergeOptions({width:0,height:0,animation:"fade",containerClass:"maptalks-tooltip",showTimeout:400});var _v=function(t){function e(e){return t.call(this,e)||this}au(e,t);var n=e.prototype;return n._getClassName=function(){return"Menu"},n.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,this._owner=t,av.prototype.addTo.apply(this,arguments)},n.setItems=function(t){return this.options.items=t,this},n.getItems=function(){return this.options.items||[]},n.buildOn=function(){if(this.options.custom){if(xc(this.options.items)){var t=id("div");return t.innerHTML=this.options.items,t}return this.options.items}var e=id("div");this.options.containerClass&&pd(e,this.options.containerClass),e.style.width=this._getMenuWidth()+"px";var n=this._createMenuItemDom();return e.appendChild(n),bd(e,"contextmenu",ld),e},n.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),n=this.getSize(),i=0,r=0;return e.x+n.width>t.width&&(i=-n.width),e.y+n.height>t.height&&(r=-n.height),new fu(i,r)},n.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},n.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},n._createMenuItemDom=function(){var t=this,e=this.getMap(),n=id("ul");pd(n,"maptalks-menu-items");var i,r,o=this.getItems();function s(n){return function(i){var r=e._parseEvent(i,"click");r.target=t,r.owner=t._owner,r.index=n,!1!==this._callback(r)&&(t.hide(),t._owner&&t._owner.fire("closemenu"))}}for(var a=0,h=o.length;a<h;a++){if("-"===(i=o[a])||"_"===i)pd(r=id("li"),"maptalks-menu-splitter");else{r=id("li");var l=i.item;bc(l)&&(l=l({owner:this._owner,index:a})),r.innerHTML=l,r._callback=i.click,bd(r,"click",s(a))}n.appendChild(r)}var c=this.options.maxHeight||0;return c>0&&md(n,"max-height: "+c+"px; overflow-y: auto;"),n},n._getMenuWidth=function(){return this.options.width||160},e}(av);_v.mergeOptions({containerClass:"maptalks-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var vv={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu.setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},getMenu:function(){return this._menu},openMenu:function(t){var e=this instanceof yp?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(),this._menu.show(t)),this.fire("openmenu",{coordinate:t}),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this.fire("closemenu",{}),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this.fire("removemenu",{}),this},_bindMenu:function(){return this._menuOptions?(this._menu=new _v(this._menuOptions),this._menu.addTo(this),this):this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.openMenu(t.coordinate),!1}};yp.include(vv),sp.include(vv);var yv=function(t){function e(e){return e&&e.position&&!xc(e.position)&&(e.position=gc({},e.position)),t.call(this,e)||this}au(e,t);var n=e.prototype;return n.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t._panels.control;return this.__ctrlContainer=id("div"),md(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},n.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},n.getMap=function(){return this._map},n.getPosition=function(){return gc({},this._parse(this.options.position))},n.setPosition=function(t){return this.options.position=xc(t)?t:gc({},t),this._updatePosition(),this},n.getContainerPoint=function(){var t,e,n=this.getPosition(),i=this.getMap().getSize();return pc(n.left)?pc(n.right)||(t=i.width-parseInt(n.right)):t=parseInt(n.left),pc(n.top)?pc(n.bottom)||(e=i.height-parseInt(n.bottom)):e=parseInt(n.top),new fu(t,e)},n.getContainer=function(){return this.__ctrlContainer},n.getDOM=function(){return this._controlDom},n.show=function(){return this.__ctrlContainer.style.display="",this},n.hide=function(){return this.__ctrlContainer.style.display="none",this},n.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},n.remove=function(){return this._map?(od(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},n._parse=function(t){var n=t;return xc(t)&&(n=e.positions[n]),n},n._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),t)t.hasOwnProperty(e)&&(t[e]=parseInt(t[e]),this.__ctrlContainer.style[e]=t[e]+"px");this.fire("positionchange",{position:gc({},t)})},e}(Fd(Bd));yv.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},yp.mergeOptions({control:!0}),yp.include({addControl:function(t){return this._containerDOM.getContext||t.addTo(this),this},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var xv="addlayer removelayer setbaselayer baselayerremove",bv=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(){return this._attributionContainer=id("div"),this._attributionContainer.className="maptalks-attribution",this._update(),this._attributionContainer},n.onAdd=function(){this.getMap().on(xv,this._update,this)},n.onRemove=function(){this.getMap().off(xv,this._update,this)},n._update=function(){var t=this.getMap();if(t){var e=t._getLayers((function(t){return t.options.attribution})).reverse().map((function(t){return t.options.attribution})),n=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+n+"</span>"}},e}(yv);bv.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>'}),yp.mergeOptions({attribution:!0}),yp.addOnLoadHook((function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new bv(t),this.addControl(this.attributionControl))}));var wv=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(){var t=this.container=id("div",this.options.containerClass),e=this.panel=id("div","panel"),n=this.button=id("button");return t.appendChild(n),t.appendChild(e),t},n.onAdd=function(){bd(this.button,"mouseover",this._show,this),bd(this.panel,"mouseleave",this._hide,this),bd(this.getMap(),"click",this._hide,this)},n.onRemove=function(){this.panel&&(wd(this.button,"mouseover",this._show),wd(this.panel,"mouseleave",this._hide),wd(this.getMap(),"click",this._hide),od(this.panel),od(this.button),delete this.panel,delete this.button,delete this.container)},n._show=function(){gd(this.container,"shown")||(pd(this.container,"shown"),this._createPanel())},n._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||_d(this.container,this.options.containerClass)},n._createPanel=function(){this.panel.innerHTML="";var t=id("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},n._renderLayers=function(t,e){var n=this,i=t.getBaseLayer(),r=t.getLayers(),o=r.length;if(i){var s=i.layers||[i],a=id("li","group"),h=id("ul"),l=id("label");l.innerHTML=this.options.baseTitle,a.appendChild(l);for(var c=0,u=s.length;c<u;c++)this._isExcluded(s[c])&&(h.appendChild(this._renderLayer(s[c],!0)),a.appendChild(h),e.appendChild(a))}if(o){var f=id("li","group"),d=id("ul"),m=id("label"),g=id("input");g.type="checkbox",g.checked=!0,m.innerHTML=this.options.overlayTitle,f.appendChild(g),f.appendChild(m);for(var p=function(t){var e=t.target.checked,n=t.target.parentNode;if(n){var i=n.getElementsByTagName("ul")[0];if(i){var r=function(t){var n=t._layer;n&&n[e?"show":"hide"]()},o=function(t){var n=t._layer,i=t.childNodes[0];i&&(i.checked=e),n&&n[e?"show":"hide"]()};r(n),i.childNodes.forEach((function(t){o(t);var e=t.getElementsByTagName("ul")[0];e&&(r(t),e.childNodes.forEach((function(t){o(t)})))}))}}},_=0;_<o;_++){var v=r[_];this._isExcluded(v)&&(v.getLayers?function(){var t=id("li","group"),e=id("ul"),i=id("label"),r=id("input");i.innerHTML=v.getId(),r.type="checkbox",r.checked=v.isVisible(),r.onchange=p,t.appendChild(r),t.appendChild(i),t.appendChild(e),t._layer=v,d.appendChild(t),(v.getLayers()||[]).forEach((function(t){e.appendChild(n._renderLayer(t,!1,r.checked))}))}():d.appendChild(this._renderLayer(v)),v&&!v.isVisible()&&(g.checked=!1))}f.appendChild(d),e.appendChild(f),g.onchange=p}},n._isExcluded=function(t){var e=t.getId(),n=this.options.excludeLayers;return!(n.length&&n.indexOf(e)>=0)},n._renderLayer=function(t,e,n){var i=this;void 0===n&&(n=!0);var r=id("li","layer"),o=id("label"),s=id("input"),a=this.getMap(),h=t.options.visible;t.options.visible=!0;var l=t.isVisible();return t.options.visible=h,r.className="layer",e?(s.type="radio",s.name="base"):s.type="checkbox",s.checked=h&&l,n||(s.checked=!1),l||s.setAttribute("disabled","disabled"),s.onchange=function(e){if("radio"===e.target.type){var n=a.getBaseLayer(),r=n.layers;if(r)for(var o=0,s=r.length;o<s;o++){var h=r[o];h[h===t?"show":"hide"]()}else n.isVisible()||n.show();a._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();i.fire("layerchange",{target:t})},r.appendChild(s),o.innerHTML=t.getId(),r.appendChild(o),r._layer=t,r},e}(yv);wv.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),yp.mergeOptions({layerSwitcherControl:!1}),yp.addOnLoadHook((function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new wv(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))}));var Tv=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=id("div"),n=this.mapContainer=id("div");n.style.width=t[0]+"px",n.style.height=t[1]+"px",n.className=this.options.containerClass;var i=this.button=id("div");return i.className=this.options.buttonClass,e.appendChild(n),e.appendChild(i),e},n.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),bd(this.button,"click",this._onButtonClick,this),this._updateButtonText()},n.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),wd(this.button,"click",this._onButtonClick)},n.maxmize=function(){var t=this.options.size,e=this.mapContainer;return e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview(),this},n.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;return t.style.width="0px",t.style.height="0px",this},n.getOverviewMap=function(){return this._overview},n._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},n._updateButtonText=function(){this.button.innerHTML=this._overview?"-":"+"},n._createOverview=function(){var t=this.getMap(),e=this.mapContainer,n=t.config();gc(n,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new yp(e,n),this._updateBaseLayer(),this._perspective=new Ip(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new m_("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},n._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),n=t.getMinZoom(),i=this.options.level;if(i>0){for(var r=i;r>0;r--)if(e-r>=n)return e-r}else for(var o=i;o<0;o++)if(e-o>=n)return e-o;return e},n._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},n._getPerspectiveCoords=function(){var t=this.getMap(),e=t.getProjection();return t.getContainerExtent().toArray().map((function(n){if(e){var i=t._containerPointToPrj(n);return t._fixPrjOnWorldWide(i),e.unproject(i)}return t.containerPointToCoordinate(n)}))},n._update=function(){if(this._overview){fd(this._overview._containerDOM);var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},n._updateSpatialReference=function(){if(this._overview){var t=this.getMap();this._overview.setSpatialReference(t.options.spatialReference)}},n._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,n=0;if(e)for(var i=0,r=e.length;i<r;i++)if(e[i].isVisible()){n=i;break}var o=t.toJSON(),s=null;e?(s=o.layers[n].options).visible=!0:s=o.options,this._overview.setMinZoom(s.minZoom||null).setMaxZoom(s.maxZoom||null),delete s.minZoom,delete s.maxZoom,delete o.options.canvas,o.options.visible=!0,o.options.renderer="canvas";var a=hp.fromJSON(o);for(var h in t)bc(t[h])&&t.hasOwnProperty(h)&&t[h]!==t.constructor.prototype[h]&&(a[h]=t[h]);this._overview.setBaseLayer(a)}else this._overview.setBaseLayer(null)}},e}(yv);Tv.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),yp.mergeOptions({overviewControl:!1}),yp.addOnLoadHook((function(){this.options.overviewControl&&(this.overviewControl=new Tv(this.options.overviewControl),this.addControl(this.overviewControl))})),function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(){var t;if(this.options.custom)xc(this.options.content)?(t=id("div")).innerHTML=this.options.content:t=this.options.content;else{if(t=id("div","maptalks-panel"),this.options.closeButton){var e=id("a","maptalks-close");e.href="javascript:;",e.onclick=function(){t.style.display="none"},t.appendChild(e)}var n=id("div","maptalks-panel-content");n.innerHTML=this.options.content,t.appendChild(n)}return this.draggable=new Xd(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},n.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),yv.prototype.update.call(this)},n.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},n.getContent=function(){return this.options.content},n._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},n._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=gc({},this.getPosition()),this.fire("dragstart",t)},n._onDragging=function(t){var e=t.mousePos.sub(this._startPos),n=this._startPosition,i=this.getPosition();pc(i.top)||(i.top=parseInt(n.top)+e.y),pc(i.bottom)||(i.bottom=parseInt(n.bottom)-e.y),pc(i.left)||(i.left=parseInt(n.left)+e.x),pc(i.right)||(i.right=parseInt(n.right)-e.x),this.setPosition(i),this.fire("dragging",t)},n._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},n._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),n=this.getDOM(),i=parseInt(n.clientWidth),r=parseInt(n.clientHeight);return[t.containerPointToCoordinate(e.add(i/2,0)),t.containerPointToCoordinate(e.add(i,r/2)),t.containerPointToCoordinate(e.add(i/2,r)),t.containerPointToCoordinate(e.add(0,r/2))]},e}(yv).mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var Mv=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(t){return this._map=t,this._scaleContainer=id("div",this.options.containerClass),this._addScales(),t.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},n.onRemove=function(){this.getMap().off("zoomend",this._update,this)},n._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=rd("div",this.options.containerClass?null:t,this._scaleContainer)),this.options.imperial&&(this._iScale=rd("div",this.options.containerClass?null:t,this._scaleContainer))},n._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},n._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},n._updateMetric=function(t){var e=this._getRoundNum(t);this._updateScale(this._mScale,e<1e3?e+" m":e/1e3+" km",e/t)},n._updateImperial=function(t){var e,n,i,r=3.2808399*t;r>5280?(n=this._getRoundNum(e=r/5280),this._updateScale(this._iScale,n+" mile",n/e)):(i=this._getRoundNum(r),this._updateScale(this._iScale,i+" feet",i/r))},n._updateScale=function(t,e,n){t.style.width=Math.round(this.options.maxWidth*n)+"px",t.innerHTML=e},n._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),n=t/e;return e*(n>=10?10:n>=5?5:n>=3?3:n>=2?2:1)},e}(yv);Mv.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),yp.mergeOptions({scaleControl:!1}),yp.addOnLoadHook((function(){this.options.scaleControl&&(this.scaleControl=new Mv(this.options.scaleControl),this.addControl(this.scaleControl))})),function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(t){this._map=t;var e=id("div"),n=id("ul","maptalks-toolbar-hx");e.appendChild(n),pd(e,this.options.vertical?"maptalks-toolbar-vertical":"maptalks-toolbar-horizonal");var i=this;function r(t,e,n,r){var o=i._getItems()[e];return function(i){return cd(i),t({target:o,index:e,childIndex:n,dom:r})}}var o=this.options.items;if(Su(o))for(var s=0,a=o.length;s<a;s++){var h=o[s],l=id("li");if(28!==this.options.height&&(l.style.lineHeight=this.options.height+"px"),l.style.height=this.options.height+"px",l.style.cursor="pointer",/<[a-z\][\s\S]*>/i.test(h.item)){l.style.textAlign="center";var c=yd("div",h.item);l.innerHTML='<div style="margin-top:'+(this.options.height-c.height)/2+'px;">'+h.item+"</div>"}else l.innerHTML=h.item;if(h.click&&bd(l,"click",r(h.click,s,null,l)),Su(h.children)){var u=this._createDropMenu(s);l.appendChild(u),l._menu=u,bd(l,"mouseover",(function(){this._menu.style.display=""})),bd(l,"mouseout",(function(){this._menu.style.display="none"}))}n.appendChild(l)}return e},n._createDropMenu=function(t){var e=this;function n(t,n,i){var r=e._getItems()[n].children[i];return function(e){return cd(e),t({target:r,index:n,childIndex:i})}}var i=id("div","maptalks-dropMenu"),r=this._getItems(),o=r.length,s=id("ul"),a=r[t].children;t===o-1&&a&&(i.style.cssText="right: 0px;",s.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(s.style.bottom=0)),i.appendChild(id("em","maptalks-ico"));for(var h=0,l=0,c=a.length;l<c;l++){var u=If(a[l].item,"12px");u.width>h&&(h=u.width)}for(var f=0,d=a.length;f<d;f++){var m=a[f],g=id("li");g.innerHTML='<a href="javascript:;">'+m.item+"</a>",g.style.cursor="pointer",g.style.width=h+24+"px",bd(g.childNodes[0],"click",n(m.click,t,f)),s.appendChild(g)}if(this.options.vertical){var p=h<95?95:h;this.options.reverseMenu?i.style.right=-(p+20)+"px":i.style.left=-(p+20)+"px"}else this.options.reverseMenu?i.style.bottom="28px":i.style.top="28px";return i.appendChild(s),i.style.display="none",i},n._getItems=function(){return this.options.items||[]},e}(yv).mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:{}});var Av=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.buildOn=function(t){var e=this.options,n=id("div","maptalks-zoom");if(e.zoomLevel){var i=id("span","maptalks-zoom-zoomlevel");n.appendChild(i),this._levelDOM=i}var r=id("div","maptalks-zoom-slider"),o=id("a","maptalks-zoom-zoomin");if(o.href="javascript:;",o.innerHTML="+",r.appendChild(o),this._zoomInButton=o,e.slider){var s=id("div","maptalks-zoom-slider-box"),a=id("div","maptalks-zoom-slider-ruler"),h=id("span","maptalks-zoom-slider-reading"),l=id("span","maptalks-zoom-slider-dot");a.appendChild(h),s.appendChild(a),s.appendChild(l),r.appendChild(s),this._sliderBox=s,this._sliderRuler=a,this._sliderReading=h,this._sliderDot=l}var c=id("a","maptalks-zoom-zoomout");return c.href="javascript:;",c.innerHTML="-",r.appendChild(c),this._zoomOutButton=c,n.appendChild(r),t.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),n},n.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._zoomInButton&&wd(this._zoomInButton,"click",this._onZoomInClick),this._zoomOutButton&&wd(this._zoomOutButton,"click",this._onZoomOutClick),this._sliderRuler&&(wd(this._sliderRuler,"click",this._onClickRuler),this.dotDragger.disable(),delete this.dotDragger)},n._update=function(){var t=this.getMap();if(this._sliderBox){var e=10*(t.getMaxZoom()-t.getMinZoom());this._sliderBox.style.height=e+16+"px",this._sliderRuler.style.height=e+8+"px",this._sliderRuler.style.cursor="pointer";var n=10*(t.getMaxZoom()-t.getZoom());this._sliderReading.style.height=10*(t.getZoom()-t.getMinZoom()+1)+"px",this._sliderDot.style.top=n+"px"}this._updateText()},n._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();vc(t)||(t=Math.floor(10*t)/10),this._levelDOM.innerHTML=t}},n._registerDomEvents=function(){this._zoomInButton&&bd(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&bd(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(bd(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger=new Xd(this._sliderDot,{ignoreMouseleave:!0}),this.dotDragger.on("dragstart",this._onDotDragstart,this).on("dragging dragend",this._onDotDrag,this).enable())},n._onZoomInClick=function(t){ld(t),this.getMap().zoomIn()},n._onZoomOutClick=function(t){ld(t),this.getMap().zoomOut()},n._onClickRuler=function(t){ld(t);var e=this.getMap(),n=dd(t,this._sliderRuler).y,i=e.getMaxZoom(),r=Math.floor(i-n/10);e.setZoom(r)},n._onDotDragstart=function(t){ld(t.domEvent);var e=this.getMap(),n=e.getSize().toPoint()._multi(.5);e.onZoomStart(e.getZoom(),n)},n._onDotDrag=function(t){ld(t.domEvent);var e=this.getMap(),n=e.getSize().toPoint()._multi(.5),i=dd(t.domEvent,this._sliderRuler),r=e.getMaxZoom(),o=e.getMinZoom(),s=i.y,a=r-s/10;r<a?(a=r,s=0):o>a&&(a=o,s=10*(r-o)),"dragging"===t.type?e.onZooming(a,n,1):"dragend"===t.type&&e.onZoomEnd(this.options.seamless?a:Math.round(a),n),this._sliderDot.style.top=s+"px",this._sliderReading.style.height=10*(e.getZoom()-o+1)+"px",this._updateText()},e}(yv);Av.mergeOptions({position:"top-left",slider:!0,zoomLevel:!0,seamless:!1}),yp.mergeOptions({zoomControl:!1}),yp.addOnLoadHook((function(){this.options.zoomControl&&(this.zoomControl=new Av(this.options.zoomControl),this.addControl(this.zoomControl))}));var Ev=function(){function t(t,e,n,i){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:n,y:i})}return t.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"identity"===t.code.toLowerCase()?[1,-1,0,0]:"web-mercator"},t}(),Cv=6378137*Math.PI;gc(Ev,{"web-mercator":new Ev([1,-1,-Cv,Cv]),"tms-global-mercator":new Ev([1,1,-Cv,-Cv]),"tms-global-geodetic":new Ev([1,1,-180,-90]),baidu:new Ev([1,1,0,0])});var Sv=function(){function t(t,e,n,i){this.map=t,this.tileSize=i,this.fullExtent=n,this.prepareTileInfo(e,n),this._xScale=n.right>=n.left?1:-1,this._yScale=n.top>=n.bottom?1:-1;var r=t.getGLRes();this._pointOrigin=t._prjToPointAtRes(new fu(this.tileSystem.origin),r),this._glRes=r}var e=t.prototype;return e.prepareTileInfo=function(t,e){if(xc(t)?t=Ev[t.toLowerCase()]:Array.isArray(t)&&(t=new Ev(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t,this.transformation=new cm([e.right>e.left?1:-1,e.top>e.bottom?-1:1,t.origin.x,t.origin.y])},e._getTileNum=function(t,e){var n=this.tileSystem,i=this.tileSize,r=Math.floor(1e-7*n.scale.x+t.x/(i.width*e)),o=Math.ceil(1e-7*n.scale.y+t.y/(i.height*e));return{x:n.scale.x*r,y:n.scale.y*o}},e.getTileIndex=function(t,e,n){var i=this.tileSystem,r=this.transformation.transform(t,1),o=this._getTileNum(r,e);return i.scale.x<0&&(o.x-=1),i.scale.y>0&&(o.y-=1),this.getNeighorTileIndex(o.x,o.y,0,0,e,n)},e.getNeighorTileIndex=function(t,e,n,i,r,o){var s=this.tileSystem,a=t+s.scale.x*n,h=e-s.scale.y*i,l=!1,c=a,u=h,f=this._getTileFullIndex(r);return o&&(!0!==o&&"x"!==o||(f.xmax===f.xmin?a=f.xmin:a<f.xmin?(a=f.xmax-(f.xmin-a)%(f.xmax-f.xmin))===f.xmax&&(a=f.xmin):a>=f.xmax&&(a=f.xmin+(a-f.xmin)%(f.xmax-f.xmin))),!0!==o&&"y"!==o||(f.ymax===f.ymin?h=f.ymin:h>=f.ymax?h=f.ymin+(h-f.ymin)%(f.ymax-f.ymin):h<f.ymin&&(h=f.ymax-(f.ymin-h)%(f.ymax-f.ymin))===f.ymax&&(h=f.ymin))),(a<f.xmin||a>f.xmax||h>f.ymax||h<f.ymin)&&(l=!0),{x:a,y:h,idx:c,idy:u,out:l}},e._getTileFullIndex=function(t){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[t])return this._tileFullIndex[t];var e=this.fullExtent,n=this.transformation,i=this._getTileNum(n.transform(new Zd(e.left,e.top),1),t),r=this._getTileNum(n.transform(new Zd(e.right,e.bottom),1),t),o=this.tileSystem;return o.scale.x<0&&(i.x-=1,r.x-=1),o.scale.y>0&&(i.y-=1,r.y-=1),this._tileFullIndex[t]=new am(i,r),this._tileFullIndex[t]},e.getTilePrjNW=function(t,e,n){var i=this.tileSystem,r=this.tileSize;return new Zd(i.origin.x+this._xScale*i.scale.x*(t+(1===i.scale.x?0:1))*n*r.width,i.origin.y+this._yScale*i.scale.y*(e+(1===i.scale.y?1:0))*n*r.height)},e.getTilePointNW=function(t,e,n){var i=this._glRes/n,r=this.tileSystem,o=this.tileSize;return new fu(this._pointOrigin.x*i+this._xScale*r.scale.x*(t+(1===r.scale.x?0:1))*o.width,this._pointOrigin.y*i+this._yScale*r.scale.y*(e+(1===r.scale.y?1:0))*o.height)},e.getTilePrjSE=function(t,e,n){var i=this.tileSystem,r=this.tileSize;return new Zd(i.origin.x+this._xScale*i.scale.x*(t+(1===i.scale.x?1:0))*n*r.width,i.origin.y+this._yScale*i.scale.y*(e+(1===i.scale.y?0:1))*n*r.height)},e.getTilePointSE=function(t,e,n){var i=this._glRes/n,r=this.tileSystem,o=this.tileSize;return new fu(this._pointOrigin.x*i+this._xScale*r.scale.x*(t+(1===r.scale.x?1:0))*o.width,this._pointOrigin.y*i+this._yScale*r.scale.y*(e+(1===r.scale.y?0:1))*o.height)},e.getTilePrjExtent=function(t,e,n){var i=this.getTilePrjNW(t,e,n),r=this.getTilePrjSE(t,e,n);return new am(i,r)},t}(),Pv=new fu(0,0),Rv="undefined"!=typeof Set,Ov=function(){function t(){this._table=Rv?new Set:{}}var e=t.prototype;return e.add=function(t){Rv?this._table.add(t):this._table[t]=!0},e.has=function(t){return Rv?this._table.has(t):this._table[t]},e.reset=function(){Rv?this._table.clear():this._table={}},t}(),Iv={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,backgroundZoomDiff:6,loadingLimitOnInteracting:3,tileRetryCount:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!Cc,debug:!1,spatialReference:null,maxCacheSize:256,renderer:su.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1,decodeImageInWorker:!1,tileLimitPerFrame:0,backZoomOffset:0},Dv=/\{ *([\w_]+) *\}/g,kv=new fu(0,0),Lv=new fu(0,0),Fv=new fu(0,0),Nv=new fu(0,0),Bv=new fu(0,0),Hv=new fu(0,0),jv=[[0,0,0],[0,0,0]],zv=[0,0,0],Gv=[0,0,0],Uv=[],Vv=function(t){function e(){return t.apply(this,arguments)||this}au(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null};var n=e.prototype;return n.getTileSize=function(){if(this._tileSize)return this._tileSize;var t=this.options.tileSize;return _c(t)&&(t=[t,t]),this._tileSize=new Af(t),this._tileSize},n.getTiles=function(t,e){return this._coordCache={},this._isPyramidMode()?this._getPyramidTiles(t,e):this._getCascadeTiles(t,e)},n._isPyramidMode=function(){var t=this.getSpatialReference();return!this._disablePyramid&&!this._hasOwnSR&&this.options.pyramidMode&&t&&t.isPyramid()},n._getTileFullExtent=function(){if(this._tileFullExtent)return this._tileFullExtent;var t=this.getSpatialReference(),e=t.getFullExtent(),n=t.getResolution(0),i=this.getMap();return this._tileFullExtent=e.convertTo((function(t){return i._prjToPointAtRes(t,n,Pv)})),this._tileFullExtent},n._getRootNodes=function(t){var e=this.getMap();if(this._rootNodes){var n=this._rootNodes,i=n.tiles;if(e.width!==n.mapWidth||e.height!==n.mapHeight){for(var r=this._getRootError(),o=0;o<i.length;o++)i[o].error=r;this._rootNodes.mapWidth=e.width,this._rootNodes.mapHeight=e.height}for(var s=0;s<i.length;s++)i[s].offset[0]=t[0],i[s].offset[1]=t[1];return this._rootNodes}var a=this.getSpatialReference(),h=a.getResolution(0),l=this._getTileConfig(),c=a.getFullExtent(),u=l.tileSystem,f=u.origin,d=u.scale,m=l.getTilePrjExtent(0,0,h),g=m.getWidth(),p=m.getHeight(),_=Math.abs((f.x-c.left)/g);_=Math.ceil(_-1e-5);var v=Math.abs((c.right-f.x)/g);v=Math.ceil(v-1e-5);var y=Math.ceil(Math.abs(c.top-f.y)/p);y=Math.ceil(y-1e-5);var x=Math.ceil(Math.abs(c.bottom-f.y)/p);if((v+_)*((x=Math.ceil(x-1e-5))+y)>32)return{status:0,error:"Too many root nodes"};for(var b=this._getRootError(),w=[],T=-_;T<v;T++)for(var M=-y;M<x;M++){var A=d.y<0?M:-(M+1);w.push({x:T,y:A,z:0,idx:T,idy:A,res:h,extent2d:l.getTilePrjExtent(T,A,h).convertTo((function(t){return e._prjToPointAtRes(t,h,Pv)})),id:this._getTileId(T,A,0),url:this.getTileUrl(T,A,0+this.options.zoomOffset),offset:[0,0],error:b,children:[]})}return this._rootNodes={status:1,tiles:w,mapWidth:e.width,mapHeight:e.height},this._getRootNodes(t)},n._getRootError=function(){var t=this.getMap(),e=Ac(t.getFov()),n=t.width/t.height,i=t.cameraPosition[2],r=i*Math.tan(.5*e),o=r*n,s=Math.sqrt(i*i+r*r+o*o);return t._getFovZ(0)*(s/i)*this.getSpatialReference().getResolution(0)/t.getResolution(0)},n._getPyramidTiles=function(t,e){var n=this.getMap();isNaN(+t)&&(t=this._getTileZoom(n.getZoom()));var i,r=this.getSpatialReference(),o=Math.min(t,this.getMaxZoom()),s=n.projViewMatrix,a=this._getTileFullExtent(),h=this._getTileOffset(0);if(this.options.repeatWorld){var l=n.getContainerExtent(),c=this._convertToExtent2d(l),u=r.getResolution(0)/n.getResolution();if(c.within(a.copy()._scale(u))){var f=this._getRootNodes(h);if(1!==f.status)return console.warn(f.error),this._disablePyramid=!0,this.getTiles(t,e);i=f.tiles.concat()}else{var d=n.getPitch(),m=n.options.cascadePitches[1],g=Math.floor(n._getVisualHeight(m)),p=d<=m?l:new lm(0,n.height-g,n.width,n.height);this._visitedTiles=new Ov;var _=this._getTiles(0,p,2,e&&e.getRenderer(),!0),v=this._getRootError();_.tiles.forEach((function(t){t.error=v})),i=_.tiles}}else{var y=this._getRootNodes(h);if(1!==y.status)return console.warn(y.error),this._disablePyramid=!0,this.getTiles(t,e);i=y.tiles.concat()}for(var x=n.getGLRes(),b={0:h},w=this.options.backZoomOffset+t,T=new lm,M=[];i.length>0;){var A=i.pop();A.z!==o?(b[A.z+1]||(b[A.z+1]=this._getTileOffset(A.z+1)),this._splitNode(A,s,i,M,T,o,b[A.z+1],e&&e.getRenderer(),x),w<t&&M[M.length-1]!==A&&w===A.z&&M.push(A)):(T._combine(A.extent2d),M.push(A))}return{tileGrids:[{extent:T,count:M.length,tiles:M,offset:[0,0],zoom:t}],count:M.length}},n._splitNode=function(t,e,n,i,r,o,s,a,h){for(var l=this._getTileConfig().tileSystem.scale.y,c=t.z+1,u=this.getSpatialReference(),f=t.x,d=t.y,m=t.extent2d,g=t.idx,p=t.idy,_=m.getWidth()/2*2,v=m.getHeight()/2*2,y=2*m.xmin,x=2*m.ymax,b=2*m.ymin,w=a||this.getRenderer(),T=!1,M=[],A=u.getResolution(c),E=A/h,C=0;C<4;C++){var S=C%2,P=C>>1,R=(f<<1)+S,O=(d<<1)+P,I=(g<<1)+S,D=(p<<1)+P;t.children||(t.children=[]);var k=t.children[C];k||(k=this._getTileId(I,D,c),t.children[C]=k);var L=w.isTileCachedOrLoading(k),F=void 0,N=L&&L.info;if(!N){if(this.tileInfoCache||(this.tileInfoCache=new Ed(4*this.options.maxCacheSize)),!(N=this.tileInfoCache.get(k))){if(l<0){var B=y+S*_,H=x-P*v;F=new lm(B,H-v,B+_,H)}else{var j=y+S*_,z=b+P*v;F=new lm(j,z,j+_,z+v)}N={x:R,y:O,idx:I,idy:D,z:c,extent2d:F,error:t.error/2,res:A,id:k,parentNodeId:t.id,children:[],url:this.getTileUrl(R,O,c+this.options.zoomOffset),offset:s},this.tileInfoCache.add(k,N)}a&&(N.layer=this.getId())}N.error=t.error/2,N.offset[0]=s[0],N.offset[1]=s[1];var G=this._isTileVisible(N,e,E,o,s);if(1===G)T=!0;else{if(-1===G)continue;if(0===G&&c!==o)return i.push(t),void r._combine(t.extent2d)}M.push(N)}c===o?T?n.push.apply(n,M):(i.push(t),r._combine(t.extent2d)):n.push.apply(n,M)},n._isTileVisible=function(t,e,n,i,r){if(0===t.z)return 1;if(!this._isTileInFrustum(t,e,n,r))return-1;var o=this.options.maxError;return pc(o)&&(o=1),this._getScreenSpaceError(t,n,i,r)>=o?1:0},n._isTileInFrustum=function(t,e,n,i){if(!this._zScale){var r=this.getMap(),o=r.getGLRes();this._zScale=r.altitudeToPoint(100,o)/100}var s=t.extent2d,a=s.ymin,h=s.xmax,l=s.ymax;return jv[0][0]=(s.xmin-i[0])*n,jv[0][1]=(a-i[1])*n,jv[0][2]=(t.minAltitude||0)*this._zScale,jv[1][0]=(h-i[0])*n,jv[1][1]=(l-i[1])*n,jv[1][2]=(t.maxAltitude||0)*this._zScale,oc(e,jv)},n._getScreenSpaceError=function(t,e,n,i){var r=t.error,o=this.getMap(),s=t.extent2d,a=s.ymin,h=s.xmax,l=s.ymax;zv[0]=(s.xmin-i[0])*e,zv[1]=(a-i[1])*e,Gv[0]=(h-i[0])*e,Gv[1]=(l-i[1])*e;var c,u,f,d,m,g,p=(c=zv,u=Gv,f=o.cameraPosition,d=Math.max(c[0]-f[0],0,f[0]-u[0]),m=Math.max(c[1]-f[1],0,f[1]-u[1]),g=Math.max(c[2]-f[2],0,f[2]-u[2]),Math.sqrt(d*d+m*m+g*g)),_=Math.max(Math.abs(p),1e-7),v=Math.abs(t.z-n);return r*(o.height<1e3||v<=1?1:v<=2?.7:.605)/_},n._getCascadeTiles=function(t,e){var n=this.getMap(),i=n.getPitch(),r=e&&e.getRenderer(),o=n.getContainerExtent(),s=[],a=0,h=this.getMinZoom(),l=n.options.cascadePitches[0],c=n.options.cascadePitches[1],u=Math.floor(n._getVisualHeight(c)),f=pc(t)?this._getTileZoom(n.getZoom()):t;if(this._visitedTiles=new Ov,!pc(t)||!this.options.cascadeTiles||i<=l||!pc(h)&&f<=h){var d=i<=c?o:new lm(0,n.height-u,n.width,n.height),m=this._getTiles(f,d,2,r);return m&&(a+=m.tiles.length,s.push(m)),{tileGrids:s,count:a}}var g=Math.floor(n._getVisualHeight(l)),p=new lm(0,n.height-g,n.width,n.height),_=this._getTiles(f,p,0,r);a+=_?_.tiles.length:0,s.push(_);var v,y,x=p.ymin,b=n.getSpatialReference().getZoomDirection(),w=b;if(i>c){f-w<=h&&(w=0);var T=new lm(0,n.height-u,n.width,x);a+=(v=this._getTiles(f-w,T,1,r))?v.tiles.length:0,x=T.ymin,w+=4*b,s.push(v)}if(f-w>=h){var M=new lm(0,o.ymin,n.width,x);a+=(y=this._getTiles(f-w,M,2,r))?y.tiles.length:0,s.push(y)}return v&&y&&(s[1]=y,s[2]=v),{tileGrids:s,count:a}},n.getTileUrl=function(t,e,n){var i=this.options.urlTemplate,r="";if(this.options.subdomains){var o=this.options.subdomains;if(Su(o)){var s=(t+e)%o.length;s<0&&(s=0),r=o[s]}}if(bc(i))return i(t,e,n,r);var a={x:t,y:e,z:n,s:r};return this.options.token&&(a.token=this.options.token),this.options.customTags&&gc(a,this.options.customTags),i.replace(Dv,(function(t,e){var n=a[e];if(void 0===n)throw new Error("No value provided for variable "+t);return"function"==typeof n&&(n=n(a)),n}))},n.clear=function(){return this._renderer&&this._renderer.clear(),this.tileInfoCache&&this.tileInfoCache.reset(),this.fire("clear"),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},n.getSpatialReference=function(){var t=this.getMap();if(t&&(!this.options.spatialReference||ip.equals(this.options.spatialReference,t.options.spatialReference)))return t.getSpatialReference();if(this._sr)return this._sr;var e=this.options.spatialReference;if(xc(e)&&!(e=ip.getPreset(e)))throw new Error("Unsupported spatial reference: "+this.options.spatialReference+", possible values: "+ip.getAllPresets().join());return this._sr=new ip(e),this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom(),this._hasOwnSR=this._sr.toJSON().projection!==t.getSpatialReference().toJSON().projection,this._sr},n.getMinZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.max(t.prototype.getMinZoom.call(this),this._srMinZoom):t.prototype.getMinZoom.call(this)},n.getMaxZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.min(t.prototype.getMaxZoom.call(this),this._srMaxZoom):t.prototype.getMaxZoom.call(this)},n._getTileZoom=function(t){if(!this._hasOwnSR){var e=this.getMap().getResolution(t),n=this.getSpatialReference().getResolution(t);t+=Math.log(n/e)*Math.LOG2E}var i=this.options.maxAvailableZoom;return!pc(i)&&t>i&&(t=i),vc(t)||(t=Math.round(t)),Math.max(0,t)},n._getTiles=function(t,e,n,i,r){var o=this.getMap(),s=t,a=o.projViewMatrix,h=o.getResolution(t)/o.getResolution(t-1)==.5;n<2&&(0===n&&h&&(s-=1),a=0===n?o.cascadeFrustumMatrix0:1===n?o.cascadeFrustumMatrix1:o.projViewMatrix);var l=s+this.options.zoomOffset,c=this._getTileOffset(l),u=c[0]||c[1],f={zoom:s,extent:null,offset:c,tiles:[]};if(l<0)return f;if(!(o&&this.isVisible()&&o.width&&o.height))return f;if(!r){var d=this.getMinZoom(),m=this.getMaxZoom();if(!pc(d)&&s<d||!pc(m)&&s>m)return f}var g=this._getTileConfig();if(!g)return f;var p,_={zoom:c},v=this.getSpatialReference().getResolution(l);p=this._hasOwnSR?o.getGLScale(s):v/o.getGLRes();var y=!this._hasOwnSR&&this.options.repeatWorld,x=this._convertToExtent2d(e),b=this._getMask2DExtent();if(b){var w=b.intersection(x);if(!w)return f;e=w.convertTo((function(t){return o._pointToContainerPoint(t,void 0,0,Pv)}))}var T,M=o._containerPointToPrj(e.getCenter(),kv),A=o._prjToPoint(M,l,Lv);T=this._project(u?o._pointToPrj(A._add(c),l,Lv):M,Lv);var E=o.getGLScale()/o.getGLScale(l);Fv.x=x.xmin*E,Fv.y=x.ymax*E,Nv.x=x.xmax*E,Nv.y=x.ymin*E;for(var C=this._project(o._pointToPrj(Fv._add(c),l,Fv),Fv),S=this._project(o._pointToPrj(Nv._add(c),l,Nv),Nv),P=g.getTileIndex(T,v,y),R=g.getTileIndex(C,v,y),O=g.getTileIndex(S,v,y),I=Math.ceil(Math.abs(P.idy-R.idy)),D=Math.ceil(Math.abs(P.idx-R.idx)),k=Math.ceil(Math.abs(P.idy-O.idy)),L=Math.ceil(Math.abs(P.idx-O.idx)),F=(I+k+1)*(D+L+1),N=this.getTileSize(),B=this.getRenderer()||i,H=this._getTileConfig().tileSystem.scale,j=[],z=new lm,G=new fu(0,0),U=-I;U<=k;U++)for(var V=-D,W=-1/0,X=!1;V>=W&&V<=L;){var Z=g.getNeighorTileIndex(P.idx,P.idy,V,U,v,y);W===-1/0?V++:V--;var q=this._getTileId(Z.idx,Z.idy,s);if(!(Z.out||this._visitedTiles&&this._visitedTiles.has(q))){var Y=B&&B.isTileCachedOrLoading(q);Y&&(Y=Y.info);var K=void 0;if(Y){var J=Y.extent2d;G.set(J.xmin,J.ymax),K=G}else if(this._hasOwnSR){var Q=g.getTilePrjNW(Z.x,Z.y,v);K=o._prjToPoint(this._unproject(Q,Nv),s)}else K=g.getTilePointNW(Z.x,Z.y,v);var $=void 0,tt=void 0;if(this._hasOwnSR){var et=void 0;if(this._hasOwnSR){var nt=g.getTilePrjSE(Z.x,Z.y,v);et=o._prjToPoint(this._unproject(nt,Nv),s,Nv)}else et=g.getTilePointSE(Z.x,Z.y,v);$=Math.ceil(Math.abs(et.x-K.x)),tt=Math.ceil(Math.abs(et.y-K.y))}else $=N.width,tt=N.height;var it=H.x*(Z.idx-Z.x)*$,rt=H.y*(Z.idy-Z.y)*tt;Y||!it&&!rt||K._add(it,rt);var ot=Y&&Y.extent2d||new lm(K.x,K.y-tt,K.x+$,K.y);if(F<=4||X||this._isTileInExtent(a,ot,c,p)){var st=this._hasOwnSR?o._getResolution(s):v;this._visitedTiles&&0===n&&this._visitedTiles.add(q),h&&0===n?(this._splitTiles(a,j,B,Z,s+1,st,ot,it,rt,_,i),z._combine(ot)):(Y?(Y.offset[0]=c[0],Y.offset[1]=c[1]):(Y={z:s,x:Z.x,y:Z.y,idx:Z.idx,idy:Z.idy,extent2d:ot,offset:c,id:q,res:st,url:this.getTileUrl(Z.x,Z.y,s)},i&&(Y.layer=this.getId())),j.push(Y),z._combine(ot)),W===-1/0?(W=V,V=L):X||(X=!0)}}}if(j.length){var at=o._containerPointToPoint(e.getCenter(),s,Pv)._add(c),ht=new fu(0,0),lt=new fu(0,0);j.sort((function(t,e){return ht.set((t.extent2d.xmin+t.extent2d.xmax)/2,(t.extent2d.ymin+t.extent2d.ymax)/2),lt.set((e.extent2d.xmin+e.extent2d.xmax)/2,(e.extent2d.ymin+e.extent2d.ymax)/2),ht.distanceTo(at)-lt.distanceTo(at)}))}return{offset:c,zoom:t,extent:z,tiles:j}},n._convertToExtent2d=function(t){var e=this,n=this.getMap();return t.convertTo((function(t){if(t.y>0&&t.y<n.height){var i=(0===t.x?0:1)+t.y;e._coordCache[i]||(e._coordCache[i]=n._containerPointToPoint(t)),e._coordCache[i]}return n._containerPointToPoint(t,void 0,Pv)}))},n._splitTiles=function(t,e,n,i,r,o,s,a,h,l,c){var u=this._getTileConfig().tileSystem.scale.y,f=this.getMap().getGLScale(r),d=Bv.set(2*s.xmin,u<0?2*s.ymax:2*s.ymin),m=s.getWidth(),g=s.getHeight(),p=2*i.idx,_=2*i.idy,v=2*i.x,y=2*i.y,x=this._checkAndAddTile(t,n,p,_,v,y,r,o,0,0,m,g,d,f,l,c);x&&e.push(x),(x=this._checkAndAddTile(t,n,p,_,v,y,r,o,0,1,m,g,d,f,l,c))&&e.push(x),(x=this._checkAndAddTile(t,n,p,_,v,y,r,o,1,0,m,g,d,f,l,c))&&e.push(x),(x=this._checkAndAddTile(t,n,p,_,v,y,r,o,1,1,m,g,d,f,l,c))&&e.push(x)},n._checkAndAddTile=function(t,e,n,i,r,o,s,a,h,l,c,u,f,d,m,g){var p=this._getTileId(n+h,i+l,s);if(this._visitedTiles&&this._visitedTiles.has(p))return null;var _=m[s];_||(_=m[s]=this._getTileOffset(s));var v=this._getTileConfig().tileSystem.scale.y,y=new lm(f.x+h*c,f.y+v*l*u,f.x+(h+1)*c,f.y+v*(l+1)*u);if(!this._isSplittedTileInExtent(t,y,_,d))return null;var x=a/2,b=e&&e.isTileCachedOrLoading(p);return b?b=b.info:(b={z:s,x:r+h,y:o+l,extent2d:y,id:p,offset:_,res:x,url:this.getTileUrl(r+h,o+l,s+this.options.zoomOffset)},g&&(b.layer=this.getId())),b},n._getTileOffset=function(t){var e=this.options.offset;return bc(e)&&(e=e.call(this,t)),_c(e)?[e,e]:e||[0,0]},n._getTileId=function(t,e,n,i){return(i||this.getId())+"_"+e+"_"+t+"_"+n},n._project=function(t,e){if(this._hasOwnSR){var n=this.getMap().getProjection();return this.getSpatialReference().getProjection().project(n.unproject(t,e),e)}return t},n._unproject=function(t,e){if(this._hasOwnSR){var n=this.getMap(),i=this.getSpatialReference(),r=n.getProjection(),o=i.getProjection();return r.project(o.unproject(t,e),e)}return t},n._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),n=this.getSpatialReference(),i=n.getProjection(),r=n.getFullExtent();this._defaultTileConfig=new Sv(t,Ev.getDefault(i),r,e),this.options.hasOwnProperty("tileSystem")&&(this._tileConfig=new Sv(t,this.options.tileSystem,r,e)),delete this._rootNodes,delete this._tileFullExtent,delete this._disablePyramid},n._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},n._bindMap=function(e){var n=e.getBaseLayer();return n===this&&(n.options.hasOwnProperty("forceRenderOnMoving")||this.config({forceRenderOnMoving:!0})),this._onSpatialReferenceChange(),t.prototype._bindMap.apply(this,arguments)},n._isTileInExtent=function(t,e,n,i){var r,o=this.getMap();if(t!==o.projViewMatrix){var s=e.getCenter(Hv)._sub(n[0],n[1])._multi(i);R_(Uv,s.x,s.y,0),r=function(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[3]*i+n[7]*r+n[11]*o+n[15];return t[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])/(s=s||1),t[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])/s,t[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])/s,t}(Uv,Uv,o.projViewMatrix)[1]<0?o.projViewMatrix:t}else r=o.projViewMatrix;return jv[0][0]=(e.xmin-n[0])*i,jv[0][1]=(e.ymin-n[1])*i,jv[1][0]=(e.xmax-n[0])*i,jv[1][1]=(e.ymax-n[1])*i,oc(r,jv)},n._isSplittedTileInExtent=function(t,e,n,i){var r=this.getMap();return jv[0][0]=(e.xmin-n[0])*i,jv[0][1]=(e.ymin-n[1])*i,jv[1][0]=(e.xmax-n[0])*i,jv[1][1]=(e.ymax-n[1])*i,oc(r.projViewMatrix,jv)},n.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},n._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr,delete this._srMinZoom,delete this._hasOwnSR,delete this._rootNodes,this.tileInfoCache&&this.tileInfoCache.reset();var t=this.getRenderer();t&&t.clear()},e}(hp);Vv.registerJSONType("TileLayer"),Vv.mergeOptions(Iv),su.decodeImageInWorker&&(Om["core-fetch-image"]=function(){return"\nfunction (exports) {\n    exports.onmessage = function (msg, postResponse) {\n        var url = msg.data.url;\n        var fetchOptions = msg.data.fetchOptions;\n        requestImageOffscreen(url, function (err, data) {\n            var buffers = [];\n            if (data && data.data && data.data.buffer) {\n                buffers.push(data.data.buffer);\n            }\n            postResponse(err, data, buffers);\n        }, fetchOptions);\n    };\n\n    var offCanvas, offCtx;\n    function requestImageOffscreen(url, cb, fetchOptions) {\n        if (!offCanvas) {\n            offCanvas = new OffscreenCanvas(2, 2);\n            offCtx = offCanvas.getContext('2d');\n        }\n        fetch(url, fetchOptions ? fetchOptions : {})\n            .then(response => response.blob())\n            .then(blob => createImageBitmap(blob))\n            .then(bitmap => {\n                var { width, height } = bitmap;\n                offCanvas.width = width;\n                offCanvas.height = height;\n                offCtx.drawImage(bitmap, 0, 0);\n                bitmap.close();\n                var imgData = offCtx.getImageData(0, 0, width, height);\n                // debugger\n                cb(null, { width, height, data: new Uint8Array(imgData.data) });\n            }).catch(err => {\n                console.warn('error when loading tile:', url);\n                console.warn(err);\n                cb(err);\n            });\n    }\n}"});var Wv=new Af(256,256),Xv="show hide remove";function Zv(t){return Array.isArray(t)||(t=[t]),t}var qv=function(t){function e(e,n,i){var r;return(r=t.call(this,e,i)||this).layers=n||[],r._checkChildren(),r.layerMap={},r._groupChildren=[],r}au(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var n=t.layers.map((function(t){return hp.fromJSON(t)}));return new e(t.id,n,t.options)};var n=e.prototype;return n.getLayers=function(){return this.layers},n.addLayer=function(t){var e=this;void 0===t&&(t=[]),t=Zv(t);var n=this.layers.length;return t.forEach((function(t){t instanceof Vv&&(-1!==e.layers.indexOf(t)||e.layerMap[t.getId()]||e.layers.push(t))})),n!==this.layers.length&&(this._sortLayers(),this._refresh(),this._renderLayers()),this},n.removeLayer=function(t){var e=this;void 0===t&&(t=[]),t=Zv(t);var n=this.layers.length;return t.forEach((function(t){if(t instanceof Vv||(t=e.layerMap[t]),t instanceof Vv){var n=e.layers.indexOf(t);n>=0&&(e.layers.splice(n,1),t._doRemove(),t.off(Xv,e._onLayerShowHide,e))}})),n!==this.layers.length&&(this._refresh(),this._renderLayers()),this},n.clearLayers=function(){var t=this;return this.layers.forEach((function(e){e._doRemove(),e.off(Xv,t._onLayerShowHide,t)})),this.layers=[],this._refresh(),this._renderLayers(),this},n.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map((function(t){return t.toJSON()})),options:this.config()}},n.getTileSize=function(t){var e=this.getLayer(t);return e?e.getTileSize():Wv},n.getTiles=function(t,e){for(var n=this.layers,i=[],r=0,o=0,s=n.length;o<s;o++){var a=n[o];if(a&&a.options.visible&&a.isVisible()&&a.getMap()){var h=a.getTiles(t,e||this);h&&0!==h.count&&(r+=h.count,yu(i,h.tileGrids))}}return{count:r,tileGrids:i}},n.onAdd=function(){this._sortLayers(),this._refresh(),t.prototype.onAdd.call(this)},n.onRemove=function(){var e=this;this.layers.forEach((function(t){t._doRemove(),t.off(Xv,e._onLayerShowHide,e)})),this.layerMap={},this._groupChildren=[],t.prototype.onRemove.call(this)},n.getLayer=function(t){return this.getChildLayer(t)},n.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var n=0;n<this._groupChildren.length;n++){var i=this._groupChildren[n].getChildLayer(t);if(i)return i}return null},n._onLayerShowHide=function(t){var e=t||{},n=e.target;return"remove"===e.type&&n&&(this.layers.splice(this.layers.indexOf(n),1),n._doRemove(),n.off(Xv,this._onLayerShowHide,this),this._refresh()),this._renderLayers(),this},n._renderLayers=function(){var t=this.getRenderer();return t&&t.setToRedraw(),this},n._refresh=function(){var t=this,e=this.getMap();return this._groupChildren=[],this.layerMap={},this.layers.forEach((function(n){t.layerMap[n.getId()]=n,n.getChildLayer&&t._groupChildren.push(n),n.getMap()||n._bindMap(e),n.on(Xv,t._onLayerShowHide,t)})),this},n.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,n=0,i=e.length;n<i;n++)if(e[n].isVisible())return!0;return!1},n._checkChildren=function(){var t=this,e={};this.layers.forEach((function(n){var i=n.getId();if(e[i])throw new Error("Duplicate child layer id ("+i+") in the GroupTileLayer ("+t.getId()+")");e[i]=1}))},n._sortLayers=function(){this.layers.sort((function(t,e){return t.options.zIndex-e.options.zIndex}))},e}(Vv);qv.registerJSONType("GroupTileLayer"),qv.mergeOptions({maxCacheSize:1024});var Yv={crs:null,uppercase:!1,detectRetina:!1},Kv={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Jv=function(t){function e(e,n){var i;i=t.call(this,e)||this;var r=gc({},Kv);for(var o in n)o in i.options||(r[o]=n[o]);i.setOptions(n),i.setZIndex(n.zIndex);var s=i.getTileSize();return r.width=s.width,r.height=s.height,i.wmsParams=r,i._wmsVersion=parseFloat(r.version),i}au(e,t);var n=e.prototype;return n.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),n=Yv.detectRetina?e:1;this.wmsParams.width*=n,this.wmsParams.height*=n;var i=this.options.crs||this.getMap().getProjection().code;this.wmsParams[this._wmsVersion>=1.3?"crs":"srs"]=i,t.prototype.onAdd.call(this)},n.getTileUrl=function(e,n,i){var r=this.getSpatialReference().getResolution(i),o=this._getTileConfig().getTilePrjExtent(e,n,r),s=o.getMax(),a=o.getMin(),h=(this._wmsVersion>=1.3&&"EPSG:4326"===this.wmsParams.crs?[a.y,a.x,s.y,s.x]:[a.x,a.y,s.x,s.y]).join(","),l=t.prototype.getTileUrl.call(this,e,n,i);return l+function(t,e,n){var i=[];for(var r in t)i.push(encodeURIComponent(n?r.toUpperCase():r)+"="+encodeURIComponent(t[r]));return(e&&-1!==e.indexOf("?")?"&":"?")+i.join("&")}(this.wmsParams,l,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},n.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(Vv);Jv.registerJSONType("WMSTileLayer"),Jv.mergeOptions(Yv);var Qv=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).options.hasOwnProperty("forceRenderOnMoving")||(i.options.forceRenderOnMoving=!1),i}au(e,t);var n=e.prototype;return n.drawTile=function(){},n.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(Vv);function $v(t,e,n){var i=t.createShader(e);if(t.shaderSource(i,n),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){var r=t.getShaderInfoLog(i);throw t.deleteShader(i),new Error("Failed to compile shader: "+r)}return i}function ty(t,e,n){var i=$v(t,t.VERTEX_SHADER,e),r=$v(t,t.FRAGMENT_SHADER,n);if(!i||!r)return null;var o=t.createProgram();return o?(t.attachShader(o,i),t.attachShader(o,r),t.linkProgram(o),{program:o,vertexShader:i,fragmentShader:r}):null}function ey(t,e,n){if(Array.isArray(n[0])){for(var i=Float32Array.BYTES_PER_ELEMENT,r=0,o=0;o<n.length;o++)r+=n[o][1]||0;for(var s=0,a=0;a<n.length;a++){var h=t.getAttribLocation(e,n[a][0]);if(h<0)throw new Error("Failed to get the storage location of "+n[a][0]);t.vertexAttribPointer(h,n[a][1],t[n[a][2]||"FLOAT"],!1,i*r,i*s),s+=n[a][1]||0,t.enableVertexAttribArray(h)}}else{var l=t.getAttribLocation(e,n[0]);t.vertexAttribPointer(l,n[1],t[n[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(l)}}Qv.registerJSONType("CanvasTileLayer");var ny="\n        attribute vec2 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 0., 1.);\n\n            v_texCoord = a_texCoord;\n        }\n    ",iy="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n        uniform float u_debug_line;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            if (u_debug_line == 1.) {\n                gl_FragColor = vec4(0., 1., 0., 1.);\n            } else {\n                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n            }\n        }\n    ",ry=[0,0],oy=[0,0,0],sy=new Array(16),ay=new fu(20,20),hy=function(t){var e,n=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.drawGLImage=function(t,e,n,i,r,o,s,a){this.gl.program!==this.program&&this.useProgram(this.program);var h=this.gl;if(this.loadTexture(t),this.canvas.gl&&this.canvas.gl.wrap){var l=this.layer&&this.layer.options.opacity;pc(l)&&(l=1),s*=l}oy[0]=e||0,oy[1]=n||0;var c=S_(sy);M_(c,c,oy),A_(c,c,[o,o,1]),E_(c,this.getMap().projViewMatrix,c),h.uniformMatrix4fv(this.program.u_matrix,!1,c),h.uniform1f(this.program.u_opacity,s),h.uniform1f(this.program.u_debug_line,0);var u=t.glBuffer;!u||u.width===i&&u.height===r||(this.saveImageBuffer(u),delete t.glBuffer),t.glBuffer?h.bindBuffer(h.ARRAY_BUFFER,u):t.glBuffer=this.bufferTileData(0,0,i,r),ry[0]="a_position",ry[1]=2,ry[2]=t.glBuffer.type,this.enableVertexAttrib(ry),h.drawArrays(h.TRIANGLE_STRIP,0,4),a&&this.drawDebug(c,0,0,i,r,a)},n.drawDebug=function(t,e,n,i,r,o){var s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),s.bufferData(s.ARRAY_BUFFER,new Float32Array([e,n,e+i,n,e+i,n-r,e,n-r,e,n]),s.DYNAMIC_DRAW),s.uniformMatrix4fv(this.program.u_matrix,!1,t),s.uniform1f(this.program.u_opacity,1),s.uniform1f(this.program.u_debug_line,1),s.drawArrays(s.LINE_STRIP,0,5);var a=this._debugInfoCanvas;if(!a){var h=this.getMap().getDevicePixelRatio()>1?2:1;(a=this._debugInfoCanvas=document.createElement("canvas")).width=256*h,a.height=32*h;var l=a.getContext("2d");l.font="20px monospace",l.scale(h,h)}var c=a.getContext("2d");c.clearRect(0,0,a.width,a.height),Od.fillText(c,o,ay,this.layer.options.debugOutline),this.loadTexture(a),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,a);var u=e+(i=256),f=n-r+32,d=n-r;s.bufferData(s.ARRAY_BUFFER,this.set8(e,f,e,d,u,f,u,d),s.DYNAMIC_DRAW),s.uniform1f(this.program.u_debug_line,0),s.drawArrays(s.TRIANGLE_STRIP,0,4)},n.bufferTileData=function(t,e,n,i,r){var o,s=t,a=t+n,h=e,l=e-i;o=vc(s)&&vc(a)&&vc(h)&&vc(l)?this.set8Int(s,h,s,l,a,h,a,l):this.set8(s,h,s,l,a,h,a,l);var c=this.loadImageBuffer(o,r);return c.width=n,c.height=i,c.type=o instanceof Int16Array?"SHORT":"FLOAT",c},n.drawTinImage=function(t,e,n,i,r){var o=this.gl;this.loadTexture(t),o.uniformMatrix4fv(this.program.u_matrix,!1,this.getMap().projViewMatrix),o.uniform1f(this.program.u_opacity,r),o.bindBuffer(o.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(e),o.DYNAMIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.DYNAMIC_DRAW),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),o.DYNAMIC_DRAW),o.drawElements(o.TRIANGLES,i.length,o.UNSIGNED_SHORT,0)},n.createCanvas2=function(){this.canvas2=Od.createCanvas(this.canvas.width,this.canvas.height)},n.createGLContext=function(){this.gl=this.canvas.gl&&this.canvas.gl.wrap?this.canvas.gl.wrap():function(t,e){for(var n={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},i=["webgl","experimental-webgl"],r=null,o=0;o<i.length;++o){try{r=t.getContext(i[o],e||n)}catch(t){}if(r)break}return r}(this.canvas2||this.canvas,this.layer.options.glOptions);var t=this.gl;t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(ny,this.layer.options.fragmentShader||iy),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),t.bufferData(t.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},n.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},n.clearGLCanvas=function(){this.gl&&(this.gl.clearStencil(255),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT))},n.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},n._createTexture=function(t){var e=this.gl,n=this.getTexture()||e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),vc(Mu(t.width))&&vc(Mu(t.width))&&e.generateMipmap(e.TEXTURE_2D),n},n.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},n.saveTexture=function(t){this._textures.push(t)},n.loadTexture=function(t){var e=this.gl,n=t.texture;return n||(n=this._createTexture(t),t.texture=n),e.bindTexture(e.TEXTURE_2D,n),n},n.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},n.saveImageBuffer=function(t){this._imageBuffers||(this._imageBuffers=[]),this._imageBuffers.push(t)},n.loadImageBuffer=function(t,e){var n=this.gl,i=e||this.createImageBuffer();return n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW),i},n.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},n.removeGLCanvas=function(){var t=this.gl;if(t){if(this._debugBuffer&&(t.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach((function(e){t.deleteBuffer(e)})),delete this._buffers),this._textures&&(this._textures.forEach((function(e){return t.deleteTexture(e)})),delete this._textures),this._debugInfoCanvas){var e=this._debugInfoCanvas.texture;e&&t.deleteTexture(e),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var n=t.program;t.deleteShader(n.fragmentShader),t.deleteShader(n.vertexShader),t.deleteProgram(n),delete this.gl,delete this.canvas2}},n.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},n.enableVertexAttrib=function(t){ey(this.gl,this.gl.program,t)},n.createProgram=function(t,e){for(var n=this.gl,i=ty(n,t,e),r=i.program,o=i.vertexShader,s=i.fragmentShader,a=n.getProgramParameter(r,35718),h=[],l=0;l<a;++l){var c=n.getActiveUniform(r,l);h.push(c.name)}return r.vertexShader=o,r.fragmentShader=s,this._initUniforms(r,h),r},n.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},n.enableSampler=function(t,e){var n=this.gl,i=this._getUniform(n.program,t);return e||(e=0),n.uniform1i(i,e),i},n._initUniforms=function(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=e[n],o=i.indexOf("[");o>=0&&(i=i.substring(0,o),Cc||(r=r.substring(0,o))),t[i]=this._getUniform(t,r)}},n._getUniform=function(t,e){var n=this.gl.getUniformLocation(t,e);if(!n)throw new Error("Failed to get the storage location of "+e);return n},e}(t);return gc(n.prototype,{set8:(e=su.ie9?null:new Float32Array(8),function(t,n,i,r,o,s,a,h){return e[0]=t,e[1]=n,e[2]=i,e[3]=r,e[4]=o,e[5]=s,e[6]=a,e[7]=h,e}),set8Int:function(){var t=su.ie9?null:new Int16Array(8);return function(e,n,i,r,o,s,a,h){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=o,t[5]=s,t[6]=a,t[7]=h,t}}()}),n},ly={renderer:su.webgl?"gl":"canvas",crossOrigin:null},cy=new fu(0,0),uy=function(t){function e(e,n,i){var r;return!n||Array.isArray(n)||n.url||(i=n,n=null),(r=t.call(this,e,i)||this)._images=n,r}au(e,t);var n=e.prototype;return n.onAdd=function(){this._prepareImages(this._images)},n.setImages=function(t){return this._images=t,this._prepareImages(t),this},n.getImages=function(){return this._images},n._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]);var e=this.getMap(),n=e.getGLRes();this._imageData=t.map((function(t){var i=new am(t.extent);return gc({},t,{extent:i,extent2d:i.convertTo((function(t){return e.coordToPointAtRes(t,n)}))})})),this._images=t;var i=this.getRenderer();i&&i.refreshImages()},e}(hp);uy.mergeOptions(ly);var fy=[],dy=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1)},n.checkResources=function(){var t=this;if(this._imageLoaded)return fy;var e=this.layer._imageData.map((function(t){return[t.url,null,null]}));if(this.resources){var n=[],i=new Wm;e.forEach((function(e){if(t.resources.isResourceLoaded(e)){var r=t.resources.getImage(e);i.addResource(e,r)}else n.push(e)})),this.resources.forEach((function(e,n){i.isResourceLoaded(e)||t.retireImage(n.image)})),this.resources=i,e=n}return this._imageLoaded=!0,e},n.retireImage=function(t){t.close&&t.close()},n.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},n.draw=function(){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(),this.completeRender())},n._drawImages=function(){var t=this.layer._imageData,e=this.getMap(),n=e._get2DExtentAtRes(e.getGLRes());if(t&&t.length)for(var i=0;i<t.length;i++){var r=t[i].extent2d,o=this.resources&&this.resources.getImage(t[i].url);o&&n.intersects(r)&&(this._painted=!0,this._drawImage(o,r,t[i].opacity||1))}},n._drawImage=function(t,e,n){var i=0,r=this.context;n<1&&(i=r.globalAlpha,r.globalAlpha=n);var o=this.getMap(),s=cy.set(e.xmin,e.ymax),a=o._pointAtResToContainerPoint(s,o.getGLRes()),h=a.x,l=a.y,c=o.getBearing();c&&(r.save(),r.translate(h,l),c&&r.rotate(-c*Math.PI/180),h=l=0);var u=o.getGLScale();r.drawImage(t,h,l,e.getWidth()/u,e.getHeight()/u),c&&r.restore(),i&&(r.globalAlpha=i)},n.drawOnInteracting=function(){this.draw()},e}(Vm),my=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.isDrawable=function(){return!0},n._drawImage=function(t,e,n){this.drawGLImage(t,e.xmin,e.ymax,e.getWidth(),e.getHeight(),1,n)},n.createContext=function(){this.createGLContext()},n.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.retireImage=function(t){t.close&&t.close(),this.disposeImage(t)},n.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(hy(dy));uy.registerRenderer("canvas",dy),uy.registerRenderer("gl",my);var gy=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[]},n.getDrawParams=function(){return[]},n.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=Od.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},n.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},n.draw=function(){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer.apply(this,arguments)},n.drawOnInteracting=function(){this._drawLayerOnInteracting.apply(this,arguments)},n.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var n=e.image;this.buffer.width===n.width&&this.buffer.height===n.height||(this.buffer.width=n.width,this.buffer.height=n.height);var i=this.buffer.getContext("2d"),r=this.layer.doubleBuffer(i,this.context);(void 0===r||r)&&(Od.image(i,n,0,0),e.image=this.buffer)}return e},n.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},n.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},n.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},n.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},n.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},n.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},n.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},n.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},n.prepareDrawContext=function(){if(!this._predrawed){var t=py(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw.apply(this.layer,[this.context].concat(t)),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},n._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();if(t.maskExtent&&!t.extent.intersects(t.maskExtent))return this.completeRender(),null;var e=[this.context,t],n=py(this.getDrawParams());return e.push.apply(e,n),e.push.apply(e,this._drawContext),e},n._drawLayer=function(){var t=this._prepareDrawParams();if(t){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.layer.draw.apply(this.layer,t.concat(n)),this.completeRender()}},n._drawLayerOnInteracting=function(){if(this.layer.drawOnInteracting){var t=this._prepareDrawParams();if(t){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.layer.drawOnInteracting.apply(this.layer,t.concat(n)),this.completeRender()}}},e}(Vm);function py(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var _y=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.isCanvasRender=function(){return!0},n.prepareToDraw=function(){},n.draw=function(){},n.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},n.play=function(){return this.config("animation",!0),this},n.pause=function(){return this.config("animation",!1),this},n.isPlaying=function(){return this.options.animation},n.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},n.requestMapToRender=function(){return this._getRenderer()&&this._getRenderer().requestMapToRender(),this},n.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},n.onCanvasCreate=function(){return this},n.onZoomStart=function(){},n.onZooming=function(){},n.onZoomEnd=function(){},n.onMoveStart=function(){},n.onMoving=function(){},n.onMoveEnd=function(){},n.onResize=function(){},n.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},e}(hp);_y.mergeOptions({doubleBuffer:!1,animation:!1}),_y.registerRenderer("canvas",gy);var vy=new fu(0,0),yy=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.getParticles=function(){},n.draw=function(t,e){var n=this.getParticles(mc());if(n&&0!==n.length){var i=this.getMap(),r=e.extent;e.maskExtent&&(r=e.extent.intersection(e.maskExtent)),r=r.convertTo((function(t){return i._pointToContainerPoint(t,void 0,0,vy)}));for(var o=2*Math.PI,s=0,a=n.length;s<a;s++){var h=n[s].point;if(r.contains(h)){var l=n[s].color||this.options.lineColor||"#fff",c=n[s].r;t.fillStyle!==l&&(t.fillStyle=l),c<=2?t.fillRect(h.x-c/2,h.y-c/2,c,c):(t.beginPath(),t.arc(h.x,h.y,c/2,0,o),t.fill())}}this._fillCanvas(t)}else this._getRenderer()&&(this._getRenderer()._shouldClear=!0)},n._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.fillStyle="rgba(0, 0, 0, "+1/(this.options.trail||30)+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}(_y);yy.mergeOptions({animation:!0}),yy.registerRenderer("canvas",function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},n.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},n.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(gy));var xy,by,wy=new Wm,Ty=function(t){function e(e,n,i){var r;(r=t.call(this,i)||this).target=e,e.once("remove",r.delete,hu(hu(r)));var o=r.options.symbol,s=o.markerLineWidth||1;return r.w=o.markerWidth+s,r.h=o.markerHeight+s,r.opacity=pc(o.opacity)?1:o.opacity,r.map=n,r.events=i.events,r._fetchImage(),r.addTo(n),r}au(e,t);var n=e.prototype;return n.getCursor=function(){return this.options.cursor||"default"},n._fetchImage=function(){var t=this.map,e=this.options.symbol,n=e.markerFile;this.url=n||Uf(e);var i=wy.getImage(this.url);if(!i){var r=this.w,o=this.h;if(n)(i=new Image).onload=function(){var e=t.getRenderer();e&&e.setToRedraw()},i.src=this.url;else{var s=document.createElement("canvas");s.width=r,s.height=o,i=Mg(s.getContext("2d"),{x:r/2,y:o/2},e,wy)}wy.addResource([this.url,r,o],i)}wy.login(this.url),this._img=i},n.setContainerPoint=function(t){this._point=t,this._point._sub(this.w/2,this.h/2)},n.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},n.offset=function(t){this._point._add(t)},n.render=function(t){if(!this._img)return!1;var e=this.options.symbol,n=e.markerDx||0,i=e.markerDy||0,r=this.map,o=this._point,s=o.x,a=o.y,h=this.w,l=this.h;if(s+h>0&&s<r.width&&a+l>0&&a<r.height){var c=r.getDevicePixelRatio();return t.globalAlpha=this.opacity,t.drawImage(this._img,Math.round((s+n)*c),Math.round((a+i)*c),Math.round(h*c),Math.round(l*c)),!0}return!1},n.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}wy.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},n.hitTest=function(t){var e=this.options.symbol,n=this._point.x+(e.markerDx||0),i=this._point.y+(e.markerDy||0);return t.x>=n&&t.x<=n+this.w&&t.y>=i&&t.y<=i+this.h},n.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},n.onEvent=function(t){this.fire(t.type,t)},n.mousedown=function(t){var e=this.options.cursor;e&&t.target.setCursor(e),this.onDragstart(t)},n.onDragstart=function(t){var e=t.containerPoint,n=t.target,i=this._dragger=new Xd(n._panels.mapWrapper||n._containerDOM);i.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),i.type="handle",i.onMouseDown(t.domEvent),xy=e.x,by=e.y,this.fire("dragstart",{containerPoint:e})},n.onDragging=function(t){if(this._dragger){var e=this.map,n=dd(t.domEvent,e._containerDOM),i={x:n.x-xy,y:n.y-by},r=e.containerPointToCoord(new fu(xy,by)),o=e.containerPointToCoord(n);xy=n.x,by=n.y,this.offset(i),this.fire("dragging",{containerPoint:n,coordOffset:o._sub(r)})}},n.onDragend=function(t){if(this._dragger){var e=this.map;e.resetCursor();var n=dd(t.domEvent,e._containerDOM);this.offset({x:n.x-xy,y:n.y-by}),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:n})}},e}(Fd(Bd)),My=function(){function t(t,e){this.target=t,t.once("remove",this.delete,this),this.map=e,this.addTo(e)}var e=t.prototype;return e.setPoints=function(t){this.points=t;var e=t.map((function(t){return t.x})),n=t.map((function(t){return t.y}));this.xmin=Math.min.apply(Math,e),this.xmax=Math.max.apply(Math,e),this.ymin=Math.min.apply(Math,n),this.ymax=Math.max.apply(Math,n)},e.hitTest=function(){return!1},e.render=function(t){var e=this.map;if(!(this.xmax<=0||this.xmin>=e.width||this.ymax<=0||this.ymin>=e.height)){var n=e.getDevicePixelRatio();t.lineWidth=1,t.strokeStyle="#000",t.globalAlpha=1,t.beginPath();var i=this.points;t.moveTo(o(i[0].x),o(i[0].y));for(var r=1;r<this.points.length;r++)t.lineTo(o(i[r].x),o(i[r].y));t.closePath(),t.stroke()}function o(t){return Math.round(t)*n+.5}},e.addTo=function(t){this.map=t,t.getRenderer().addTopElement(this)},e.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}},t}();function Ay(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}var Ey={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:Ay("ellipse",1),vertexHandleSymbol:Ay("square",1),newVertexHandleSymbol:Ay("square",.4)},Cy=function(t){function e(e,n){var i;return(i=t.call(this,n)||this)._geometry=e,i._geometry?i:hu(i)}au(e,t);var n=e.prototype;return n.getMap=function(){return this._geometry.getMap()},n.prepare=function(){var t=this.getMap();t&&(t.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},n._prepareEditStageLayer=function(){var t=this._geometry.getLayer();if("canvas"===t.options.renderer){var e=this.getMap(),n="_maptalks__internal_layer__edit_stage_"+pu()+"_shadow";this._shadowLayer=e.getLayer(n),this._shadowLayer||(this._shadowLayer=new t.constructor(n),e.addLayer(this._shadowLayer))}},n.start=function(){if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){this.editing=!0,this.prepare();var t,e=this._geometry,n="canvas"===this._geometry.getLayer().options.renderer;this._geometryDraggble=e.options.draggable,n?(e.config("draggable",!1),(t=e.copy()).setSymbol(e._getInternalSymbol()),t.copyEventListeners(e),e._getParent()&&t.copyEventListeners(e._getParent()),t._setEventTarget(e),t.setId(null).config({draggable:!1}),this._shadow=t,e.hide()):e instanceof Lp&&e.config("draggable",!0),this._switchGeometryEvents("on"),(e instanceof Lp||e instanceof qp||e instanceof Kp||e instanceof Yp)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(t),e instanceof Lp?t&&(t.config("draggable",!0),t.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),e instanceof Lp&&!1!==this.options.resize?this.createMarkerEditor():e instanceof qp?this.createCircleEditor():e instanceof Kp||e instanceof Yp?this.createEllipseOrRectEditor():e instanceof Jp||(e instanceof Ip||e instanceof Np)&&this.createPolygonEditor()}},n.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()?(this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")):this.fire("remove")},n.isEditing=function(){return!pc(this.editing)&&this.editing},n._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},n._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var n in e)this._geometry[t](n,e[n],this)}},n._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},n._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},n._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;e||(this._editOutline=new My(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var n=this._editOutline.points;if(t instanceof Lp)this._editOutline.setPoints(t.getContainerExtent().toArray(n));else{var i=this.getMap();(n=t._getPrjExtent().toArray(n)).forEach((function(t){return i._prjToContainerPoint(t,null,t)})),this._editOutline.setPoints(n)}return e},n._createCenterHandle=function(){var t,e=this,n=this.getMap(),i=this.options.centerHandleSymbol,r=n.coordToContainerPoint(this._geometry.getCenter()),o=this.createHandle(r,{symbol:i,cursor:"move",onDown:function(){if(e._shadow){var n=Vf((t=e._shadow.copy())._getInternalSymbol(),.5);t.setSymbol(n).addTo(e._geometry.getLayer())}},onMove:function(n){var i=n.coordOffset;t?t.translate(i):e._geometry.translate(i)},onUp:function(){e._update("setCoordinates",Zd.toNumberArrays((t||e._geometry).getCoordinates())),t&&t.remove()}});this._addRefreshHook((function(){var t=e._geometry.getCenter();o.setContainerPoint(n.coordToContainerPoint(t))}))},n._createHandleInstance=function(t,e){var n=this.getMap(),i=nf(e.symbol,(function(){return[n.getZoom(),{"{bearing}":n.getBearing(),"{pitch}":n.getPitch(),"{zoom}":n.getZoom()}]})),r=new Ty(this,n,{symbol:i,cursor:e.cursor,events:this.options.removeVertexOn});return r.setContainerPoint(t),r},n.createHandle=function(t,e){e||(e={});var n=this._createHandleInstance(t,e),i=this;return n.on("dragstart",(function(t){return this._updating=!0,e.onDown&&(this._geometry.fire("handledragstart"),e.onDown.call(i,t.containerPoint,t)),!1}),this),n.on("dragging",(function(t){return i._hideContext(),e.onMove&&(this._geometry.fire("handledragging"),e.onMove.call(i,t)),!1}),this),n.on("dragend",(function(t){return e.onUp&&(this._geometry.fire("handledragend"),e.onUp.call(i,t)),this._updating=!1,!1}),this),e.onRefresh&&(n.refresh=e.onRefresh),n},n._createResizeHandles=function(t,e,n){var i=this,r=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],s=this._geometry,a=s instanceof Lp;t||(t=[]);var h=this,l=[],c={},u=this.getMap(),f=this.options.vertexHandleSymbol,d=function(){for(var d=function(){if(a){var t=s.getContainerExtent();return[new fu(t.xmin,t.ymin),new fu((t.xmax+t.xmin)/2,t.ymin),new fu(t.xmax,t.ymin),new fu(t.xmin,(t.ymin+t.ymax)/2),new fu(t.xmax,(t.ymin+t.ymax)/2),new fu(t.xmin,t.ymax),new fu((t.xmax+t.xmin)/2,t.ymax),new fu(t.xmax,t.ymax)]}var e=s._getPrjExtent();return[new fu(e.xmin,e.ymax),new fu((e.xmax+e.xmin)/2,e.ymax),new fu(e.xmax,e.ymax),new fu(e.xmin,(e.ymax+e.ymin)/2),new fu(e.xmax,(e.ymax+e.ymin)/2),new fu(e.xmin,e.ymin),new fu((e.xmax+e.xmin)/2,e.ymin),new fu(e.xmax,e.ymin)]}(),m=function(m){if(Array.isArray(t)&&t.some((function(t){return t===m})))return"continue";var g,p=d[m],_=a?p:u._prjToContainerPoint(p);if(l.length<d.length-t.length){var v=i.createHandle(_,{symbol:f,cursor:r[m],axis:o[m],onMove:(g=m,function(t){h._updating=!0,e(t.containerPoint,g),s.fire("resizing")}),onUp:function(){h._updating=!1,n()}});c[m]=l.length,l.push(v)}else l[c[m]].setContainerPoint(_)},g=0;g<d.length;g++)m(g)};return d(),this._addRefreshHook(d),l},n.createMarkerEditor=function(){var t=this,e=this._shadow||this._geometry,n=this.getMap();if(e._canEdit()){this._history||this._recordHistory(d());var i=e._getInternalSymbol(),r=new fu(0,0);_c(i.markerDx)&&(r.x=i.markerDx),_c(i.markerDy)&&(r.y=i.markerDy);var o=null,s="middle",a="middle";if(zg.test(i)){var h=i.markerType;"pin"===h||"pie"===h||"bar"===h?(o=[5,6,7],s="bottom"):"rectangle"===h&&(o=[0,1,2,3,5],s="top",a="left")}else(Lg.test(i)||Gg.test(i))&&(s="bottom",o=[5,6,7]);var l,c=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var u=e.getSize();l=u.width/u.height}var f=this._createResizeHandles(o,(function(i,h){if(o&&o.indexOf(h)>=0){var u=n.containerPointToCoordinate(i.sub(r)),d=e.getCoordinates();u.x=d.x,e.setCoordinates(u),t._updateCoordFromShadow(!0),i=f[f.length-1-h].getContainerPoint()}var m=n.coordToContainerPoint(e.getCoordinates()).add(r),g=e._getInternalSymbol(),p=i.sub(m);"bottom"===s&&i.y>m.y&&(p.y=0);var _="middle"===s?2:1,v="left"===a?1:2,y=Math.abs(p.x)*v,x=Math.abs(p.y)*_;l&&(x=(y=Math.max(y,x*l))/l);var b=c[h];e instanceof o_?((l||0===b||2===b)&&(e.setWidth(y),e!==t._geometry&&t._geometry.setWidth(y)),(l||1===b||2===b)&&(e.setHeight(x),e!==t._geometry&&t._geometry.setHeight(x))):((l||0===b||2===b)&&(g.markerWidth=Math.min(y,t._geometry.options.maxMarkerWidth||1/0)),(l||1===b||2===b)&&(g.markerHeight=Math.min(x,t._geometry.options.maxMarkerHeight||1/0)),e.setSymbol(g),e!==t._geometry&&t._geometry.setSymbol(g))}),(function(){t._update(d())}))}else console&&console.warn("A marker can't be resized with symbol:",e.getSymbol());function d(){var t=[["setCoordinates",e.getCoordinates().toArray()]];return e instanceof o_?(t.push(["setWidth",e.getWidth()]),t.push(["setHeight",e.getHeight()])):t.push(["setSymbol",e.getSymbol()]),t}},n.createCircleEditor=function(){var t=this,e=this._shadow||this._geometry,n=this.getMap();this._history||this._recordHistory([["setCoordinates",e.getCoordinates().toArray()],["setRadius",e.getRadius()]]),this._createResizeHandles(null,(function(i){var r=e.getCenter(),o=n.containerPointToCoord(i),s=new Np([[r.x,r.y],[o.x,r.y]]),a=new Np([[r.x,r.y],[r.x,o.y]]),h=Math.max(n.computeGeometryLength(s),n.computeGeometryLength(a));e.setRadius(h),e!==t._geometry&&t._geometry.setRadius(h)}),(function(){t._update("setRadius",e.getRadius())}))},n.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],n=this._shadow||this._geometry;this._history||this._recordHistory(a());var i,r=this.getMap(),o=this._geometry instanceof Kp;this.options.fixAspectRatio&&(i=n.getWidth()/n.getHeight());var s=this._createResizeHandles(null,(function(a,h){var l,c,u,f=o?1:2,d=s[h].getContainerPoint(),m=e[h];if(o){var g=s[7-h].getContainerPoint(),p=(l=d.sub(g)).abs();c=r.pixelToDistance(p.x,0),u=r.pixelToDistance(0,p.y);var _=n.getSize(),v=n.getCoordinates(),y=n.getWidth(),x=n.getHeight(),b=r.containerPointToCoord(a),w=r.containerPointToCoord(g),T=new Np([[w.x,w.y],[b.x,w.y]]),M=new Np([[w.x,w.y],[w.x,b.y]]);if(c=r.computeGeometryLength(T),u=r.computeGeometryLength(M),0===m)if(i&&(p.y=p.x/i,_.height=Math.abs(p.y),u=c/i),d.y=g.y-_.height/2,b.y=v.y,4===h)b.x=Math.min(b.x,v.x);else{var A=r.locate(v,y,0);b.x=r.locate(new Zd(A.x,b.y),-c,0).x}else if(1===m)i&&(p.x=p.y*i,_.width=Math.abs(p.x),c=u*i),d.x=g.x-_.width/2,b.x=v.x,b.y=Math.max(b.y,w.y);else{if(i&&(c>u*i?(u=c/i,d.y=g.y+p.x*Tu(l.y)/i):(c=u*i,d.x=g.x+p.y*Tu(l.x)*i)),0===h||5===h){var E=r.locate(v,y,0===h?0:-x);b.x=r.locate(new Zd(E.x,b.y),-c,0).x}else b.x=Math.min(b.x,w.x);b.y=Math.max(b.y,w.y)}n.setCoordinates(b),t._updateCoordFromShadow(!0)}else{var C=n.getCenter(),S=r.containerPointToCoord(d),P=new Np([[C.x,C.y],[S.x,C.y]]),R=new Np([[C.x,C.y],[C.x,S.y]]);c=r.computeGeometryLength(P),u=r.computeGeometryLength(R),i&&(u=(c=Math.max(c,u*i))/i)}(i||0===m||2===m)&&(n.setWidth(c*f),n!==t._geometry&&t._geometry.setWidth(c*f)),(i||1===m||2===m)&&(n.setHeight(u*f),n!==t._geometry&&t._geometry.setHeight(u*f))}),(function(){t._update(a())}));function a(){return[["setCoordinates",n.getCoordinates().toArray()],["setWidth",n.getWidth()],["setHeight",n.getHeight()]]}},n.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow||this._geometry,n=this;this._history||this._recordHistory("setCoordinates",Zd.toNumberArrays(e.getCoordinates()));var i=e instanceof Ip?3:2,r="maptalks--editor-vertex-index",o={0:[]},s={0:[]};function a(t){if(void 0===t&&(t=0),e instanceof Ip){var n=e.getCoordinates()[t]||[];return n.slice(0,n.length-1)}return e.getCoordinates()}function h(t){return void 0===t&&(t=0),0===t?e._getPrjCoordinates():e._getPrjHoles()[t-1]}function l(){for(var t in o){for(var e=o[t].length-1;e>=0;e--)o[t][e][r]=e;for(var i=s[t].length-1;i>=0;i--)s[t][i][r]=i}n._updateCoordFromShadow()}function c(t){n._updating=!0;var a=t.target,c=a[r],u=_c(a._ringIndex)?a._ringIndex:0,f=h(u);if(!(f.length<=i)){var d,m=e instanceof Np&&(0===c||c===f.length-1);f.splice(c,1),u>0?e._prjHoles[u-1]=f:e._setPrjCoordinates(f),e._updateCache(),o[u].splice(c,1)[0].delete(),c<s[u].length&&s[u].splice(c,1)[0].delete(),s[u].splice(d=0===c?s[u].length-1:c-1,1)[0].delete(),m||s[u].splice(d,0,p.call(n,d,u)),l(),n._updating=!1}}function u(i,r,o){void 0===o&&(o=0);var a=n._geometry.snapTo;a&&bc(a)&&(i=n._geometry.snapTo(i)||i);var l,c=h(o),u=t._containerPointToPrj(i.sub(d())),f=c[r];f.x=u.x,f.y=u.y,e._updateCache(),e.onShapeChanged(),n._updateCoordFromShadow(!0),l=0===r?s[o].length-1:r-1,s[o][r]&&s[o][r].refresh(),s[o][l]&&s[o][l].refresh()}var f=new fu(0,0);function d(){var t=e._getCompiledSymbol();return f.x=t.lineDx||0,f.y=t.lineDy||0,f}function m(e,i,o){void 0===i&&(i=0);var s=(o||a(i))[e],h=n.createHandle(t.coordToContainerPoint(s)._add(d()),{symbol:n.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){u(h.getContainerPoint(),h[r],i)},onRefresh:function(e,n){s=(n||a(i))[h[r]];var o=t.coordToContainerPoint(s);h.setContainerPoint(o._add(d()))},onUp:function(){n._updateCoordFromShadow()},onDown:function(t,e){}});return h[r]=e,h._ringIndex=i,h.on(n.options.removeVertexOn,c),h}var g=!1;function p(i,c,f){void 0===c&&(c=0);var _=f||a(c),v=_[i].add(i+1>=_.length?_[0]:_[i+1]).multi(.5),y=n.createHandle(v,{symbol:n.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(i,o){if(!o||!o.domEvent||2!==o.domEvent.button){var a=h(c),l=y[r],u=y.getContainerPoint(),f=t._containerPointToPrj(u);a.splice(l+1,0,f),c>0?e._prjHoles[c-1]=a:e._setPrjCoordinates(a),e._updateCache(),y.opacity=1,s[c].splice(l,0,p.call(n,l,c),p.call(n,l+1,c)),g=!0}},onMove:function(){u(y.getContainerPoint(),y[r]+1,c)},onUp:function(t){if(t&&t.domEvent&&2===t.domEvent.button)g=!1;else{var e=y[r];xu(y,s[c]),y.delete(),o[c].splice(e+1,0,m.call(n,e+1,c)),l(),n._updateCoordFromShadow(),g=!1}},onRefresh:function(e,n){_=n||a(e);var i=y[r],o=_[i].add(_[i===_.length-1?0:i+1]).multi(.5),s=t.coordToContainerPoint(o);y.setContainerPoint(s._add(d()))}});return y[r]=i,y}if(e instanceof Ip)for(var _=e.getHoles().length+1,v=0;v<_;v++){o[v]=[],s[v]=[];for(var y=a(v),x=0,b=y.length;x<b;x++)o[v].push(m.call(this,x,v,y)),x<b-1&&s[v].push(p.call(this,x,v,y));s[v].push(p.call(this,y.length-1,v,y))}else{for(var w=a(0),T=0,M=w.length;T<M;T++)o[0].push(m.call(this,T,0,w)),T<M-1&&s[0].push(p.call(this,T,0,w));s[0].length&&2===e.getCoordinates().length&&(s[0][0].options.symbol.markerDx=12)}this._addRefreshHook((function(){if(!g){for(var t in s)for(var n=a(t),i=s[t].length-1;i>=0;i--)s[t][i].refresh(t,n);for(var r in s[0].length&&e instanceof Np&&(2===e.getCoordinates().length?s[0][0].options.symbol.markerDx=12:e.getCoordinates().length>2&&(s[0][0].options.symbol.markerDx=0)),o)for(var h=a(r),l=o[r].length-1;l>=0;l--)o[r][l].refresh(r,h)}}))},n._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},n._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},n._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},n._update=function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this._exeHistory([t,n]),this._recordHistory.apply(this,[t].concat(n))},n._updateCoordFromShadow=function(t){var e=(this._shadow||this._geometry).getCoordinates(),n=this._geometry,i=this._updating;this._updating=!0,n.setCoordinates(e),t||this._recordHistory("setCoordinates",Zd.toNumberArrays(n.getCoordinates())),this._updating=i},n._recordHistory=function(t){this._history||(this._history=[],this._historyPointer=0);for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(this._history.length){var r=this._history[this._history.length-1];if(r[0]===t&&JSON.stringify(r[1])===JSON.stringify(n))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([t,n]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},n.cancel=function(){return this._history&&0!==this._historyPointer?(this._historyPointer=0,this._exeAndReset(this._history[0]),this):this},n.undo=function(){if(!this._history||0===this._historyPointer)return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},n.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return this;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},n._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,n=this._historyPointer;this.stop(),this._history=e,this._historyPointer=n,this.start()}},n._onDragStart=function(){this._updating=!0},n._onDragEnd=function(){this._updating=!1},n._exeHistory=function(t){if(Array.isArray(t)){var e=this._updating;this._updating=!0;var n=this._shadow||this._geometry,i=this._geometry;Array.isArray(t[0])?t[0].forEach((function(t){var e=t[0],r=t.slice(1);n[e].apply(n,r),n!==i&&i[e].apply(i,r)})):(n[t[0]].apply(n,t[1]),n!==i&&i[t[0]].apply(i,t[1])),this._updating=e}},e}(Fd(Bd));Cy.mergeOptions(Ey),r_.include({startEditText:function(){return this.getMap()?(this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),wd(this._textEditor,"mousedown dblclick",cd),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var n=this._getEditorOffset();this._editUIMarker=new lv(this.getCoordinates(),{animation:null,content:e,dx:n.dx,dy:n.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,n=0,i=t.textHorizontalAlignment;return"middle"===i||pc(i)?(e=(t.textDx||0)-2,n=(t.textDy||0)-2):(e=(t.markerDx||0)-2,n=(t.markerDy||0)-2),{dx:e,dy:n}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),n=this._getInternalSymbol()||{},i=e.width,r=n.textFill||"#000000",o=n.textSize||12,s=e.height,a=n.markerLineColor||"#000",h=n.markerFill||"#3398CC",l=n.textLineSpacing||0,c=id("div");return c.contentEditable=!0,c.style.cssText="background:"+h+"; border:1px solid "+a+";\n            color:"+r+";font-size:"+o+"px;width:"+(i-2)+"px;height:"+(s-2)+"px;margin: auto;\n            line-height:"+(o+l)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",c.innerText=t,bd(c,"mousedown dblclick",cd),c.onkeyup=function(t){13===t.keyCode&&(c.style.height=parseInt(c.style.height||0)+o/2+"px")},c},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}}),sp.include({animate:function(t,e,n){var i=this;this._animPlayer&&this._animPlayer.finish(),bc(e)&&(n=e),e||(e={});var r,o=this.getMap(),s=this._getProjection(),a=this._prepareAnimationStyles(t),h=e.focus;if(delete this._animationStarted,o){var l=o._getRenderer();e.framer=function(t){l.callInNextFrame(t)}}var c=Rp.animate(a,e,(function(t){if(o&&o.isRemoved())c.finish();else{o&&!i._animationStarted&&h&&o.onMoveStart();var e=t.styles;for(var a in e)if("symbol"!==a&&"translate"!==a&&e.hasOwnProperty(a)){var l="set"+a[0].toUpperCase()+a.slice(1);i[l](e[a])}var u=e.translate;if(u){var f=u;r&&(f=u.sub(r)),r=u,i.translate(f)}var d=e.symbol;if(d){var m=i.getSymbol()||{};i.setSymbol(Wf(m,d))}if(o&&h){var g=s.project(i.getCenter());o._setPrjCenter(g);var p=o._parseEventFromCoord(s.unproject(g));"running"!==c.playState?o.onMoveEnd(p):o.onMoving(p)}i._fireAnimateEvent(c.playState),n&&n(t)}}),this);return this._animPlayer=c,this._animPlayer.play()},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),n={};for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];if("translate"!==i&&"symbol"!==i){var o=this["get"+i[0].toUpperCase()+i.substring(1)]();n[i]=[o,r]}else if("symbol"===i){var s=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");s=[];for(var a=t.symbol,h=0;h<a.length;h++)if(a[h]){var l={};for(var c in a[h])a[h].hasOwnProperty(c)&&(l[c]=[e[h][c],a[h][c]]);s.push(l)}else s.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var u in s={},r)r.hasOwnProperty(u)&&(s[u]=[e[u],r[u]])}n.symbol=s}else"translate"===i&&(n.translate=new Zd(r))}return n},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var Sy=su.touch?"touchstart mousedown":"mousedown",Py=function(t){function e(e){return t.call(this,e)||this}au(e,t);var n=e.prototype;return n.addHooks=function(){this.target.on(Sy,this._startDrag,this)},n.removeHooks=function(){this._endDrag(),this.target.off(Sy,this._startDrag,this),delete this.container},n._prepareDragHandler=function(){this._dragHandler=new Xd(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},n._prepareShadow=function(){var t=this,e=this.target;if("canvas"===e.getLayer().options.renderer){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var n=this._shadow=e.copy();if(n.getGeometries){var i=n.getGeometries(),r=e.getGeometries();i.forEach((function(e,n){t._updateShadowSymbol(e,r[n])}))}else this._updateShadowSymbol(n,e);n.setId(null),this._prepareShadowConnectors()}},n._updateShadowSymbol=function(t,e){if(t.setSymbol(e._getInternalSymbol()),e.options.dragShadow){var n=Vf(t._getInternalSymbol(),.5);t.setSymbol(n)}},n._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,n=this._dragStageLayer._getRenderer().resources,i=[];if(l_._hasConnectors(t))for(var r=l_._getConnectors(t),o=0,s=r.length;o<s;o++){var a=r[o],h=a.config(),l=a._getInternalSymbol();h.symbol=Vf(l,.5);var c=void 0;c=a.getConnectSource()===t?new a.constructor(e,a.getConnectTarget(),h):new a.constructor(a.getConnectSource(),e,h),i.push(c),a.getLayer()&&a.getLayer()._getRenderer()&&n.merge(a.getLayer()._getRenderer().resources)}this._shadowConnectors=i,i.push(e),this._dragStageLayer.bringToFront().addGeometry(i)},n._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},n._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer("_maptalks__internal_layer__drag_stage"),this._dragStageLayer||(this._dragStageLayer=new m_("_maptalks__internal_layer__drag_stage",{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer));var n=new Wm;n.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=n},n._startDrag=function(t){var e=this.target.getMap();if(e&&!this.target._getParent()&&!this.isDragging()){var n=t.domEvent;n.touches&&n.touches.length>1||2===n.button||(this.container=e._panels.mapWrapper||e._containerDOM,this.target.on("click",this._endDrag,this),this._lastCoord=this._correctCoord(t.coordinate),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),bd(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1)}},n._dragging=function(t){var e=this.target,n=e.getMap(),i=n._parseEvent(t.domEvent),r=i.domEvent;if(!(r.touches&&r.touches.length>1)){var o=n._getVisualHeight(n.options.maxVisualPitch);if(!(i.containerPoint.y<n.height-o)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",i)),this.target._fireEvent("dragstart",this._startParam||i),void delete this._startParam;var s=this._shadow||e,a=s.options.dragOnAxis,h=s.options.dragOnScreenAxis,l=i.containerPoint,c=i.coordinate;this._lastPoint=this._lastPoint||l,this._lastCoord=this._lastCoord||c,h?("x"===a?l.y=this._lastPoint.y:"y"===a&&(l.x=this._lastPoint.x),c=n.containerPointToCoord(l)):c=this._correctCoord(c);var u=l.sub(this._lastPoint),f=c.sub(this._lastCoord);h||("x"===a?u.y=f.y=0:"y"===a&&(u.x=f.x=0)),this._lastPoint=l,this._lastCoord=c,s.translate(f),s===e||e.options.dragShadow||e.translate(f),i.coordOffset=f,i.pointOffset=u,s._fireEvent("dragging",i),s!==e&&e._fireEvent("dragging",i)}}},n._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&wd(this.container,"mouseleave",this._endDrag),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var n=e.getMap();if(this.enabled()&&n){var i=n._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(i),this._moved&&e._fireEvent("dragend",i)}}},n.isDragging=function(){return!!this._isDragging},n._updateTargetAndRemoveShadow=function(t){if(this._shadow){var e=this.target,n=e.getMap();e.options.dragShadow||e.show();var i=this._shadow;if(i){if(e.options.dragShadow)if(e.getGeometries){var r=i.getGeometries(),o=e.getGeometries();r.forEach((function(t,e){o[e].setCoordinates(r[e].getCoordinates())}))}else e.setCoordinates(i.getCoordinates());i._fireEvent("dragend",t),i.remove(),delete this._shadow}this._shadowConnectors&&(n.getLayer("_maptalks__internal_layer__drag_stage").removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&(this._dragStageLayer._getRenderer().resources=new Wm,this._dragStageLayer.remove())}},n._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var n=this.target;if(!n.getMinAltitude())return t;var i=(n.getMinAltitude()+n.getMaxAltitude())/2;return e.locateByPoint(t,0,-i)},e}(Nd);sp.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null,dragOnScreenAxis:!1}),sp.addInitHook("addHandler","draggable",Py),sp.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),sp.include({startEdit:function(t){return this.getMap()&&this.options.editable?(this.endEdit(),this._editor=new Cy(this,t),this._editor.start(),this._getParent()||this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this._getParent()||this.fire("editend")),this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this._getParent()||this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this._getParent()||this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._editor.cancel(),this._getParent()||this.fire("canceledit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),sp.include({_onEvent:function(t,e){var n=this.getMap();if(n){var i=e||this._getEventTypeToFire(t);"contextmenu"===i&&this.listens("contextmenu")&&(cd(t),ld(t));var r=n._getEventParams(t);_c(this._pickGeometryIndex)&&(r.pickGeometryIndex=this._pickGeometryIndex),this._fireEvent(i,r)}},_getEventTypeToFire:function(t){return t.type}}),sp.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof gv?(this._infoWindow=t,this._infoWinOptions=gc({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=gc({},t),this._infoWindow?this._infoWindow.setOptions(t):this.getMap()&&this._bindInfoWindow(),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(){var t=this._infoWinOptions;return t?(this._infoWindow=new gv(t),this._infoWindow.addTo(this),this):this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}});var Ry=new fu(0,0),Oy=new fu(0,0),Iy=new fu(0,0),Dy=new fu(0,0),ky=[],Ly=function(t){function e(){return t.call(this,"core-fetch-image")||this}au(e,t);var n=e.prototype;return n.checkUrl=function(t){return t&&xc(t)?Wu(t):t},n.fetchImage=function(t,e,n,i){t=this.checkUrl(t),this.send({url:t,fetchOptions:i},ky,n,e)},e}(zm),Fy=new Image,Ny=function(t){function e(e){var n;return(n=t.call(this,e)||this).tilesInView={},n.tilesLoading={},n._parentTiles=[],n._childTiles=[],n._tileQueue=[],n.tileCache=new Ed(e.options.maxCacheSize,n.deleteTile.bind(hu(hu(n)))),!su.decodeImageInWorker||!n.layer.options.decodeImageInWorker||"gl"!==e.options.renderer&&su.safari||(n._tileImageWorkerConn=new Ly),n._compareTiles=Hy.bind(hu(hu(n))),n}au(e,t);var n=e.prototype;return n.getCurrentTileZoom=function(){return this._tileZoom},n.draw=function(t,e){var n=this.getMap();if(this.isDrawable()){var i=this.prepareCanvas();if(!i||i.intersects(this.canvasExtent2D)){var r;this._renderTimestamp!==t&&(this._consumeTileQueue(),this._renderTimestamp=t);var o=!1,s=this._frameTiles;if(s&&t===s.timestamp){if(s.empty)return;r=s}else{if(!(r=this._getTilesInCurrentFrame()))return this._frameTiles={empty:!0,timestamp:t},void this.completeRender();o=!0,this._frameTiles=r,this._frameTiles.timestamp=t,r.loadingCount&&this.loadTileQueue(r.tileQueue)}var a=r.loading,h=r.loadingCount;this._drawTiles(r.tiles,r.parentTiles,r.childTiles,r.placeholders,e),h||a||(n.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),o&&this._retireTiles()}else this.completeRender()}},n.getTileGridsInCurrentFrame=function(){return this._frameTileGrids},n._getTilesInCurrentFrame=function(){var t=this.getMap(),e=this.layer.getTiles();if(this._frameTileGrids=e,!(e=e.tileGrids)||!e.length)return null;var n=e.reduce((function(t,e){return t+(e&&e.tiles&&e.tiles.length||0)}),0);n>=this.tileCache.max/2&&this.tileCache.setMaxSize(2*n+1);var i=0,r=!1,o={},s=[],a=[],h={},l=[],c={},u=[],f={},d={},m=this._markTiles(),g=this._getLoadLimit(),p=e.length;this._tileZoom=e[0].zoom;for(var _=0;_<p;_++){var v=e[_].tiles,y=void 0;v.length&&(y=this._generatePlaceHolder(v[0].res));for(var x=0,b=v.length;x<b;x++){var w=v[x],T=w.id,M=!1;if(this._isLoadingTile(T))M=r=!0,this.tilesLoading[T].current=!0;else{var A=this._getCachedTile(T);A?(A.image&&this.getTileOpacity(A.image)<1&&(M=r=!0,this.setToRedraw()),s.push(A)):(M=r=!0,g&&i+m[0]>g||t.isInteracting()&&!t.isMoving()&&!t.isRotating()||(i++,d[T]=w))}if(M&&!o[T]){o[T]=1,y&&!f[T]&&(w.cache=!1,u.push({image:y,info:w}),f[T]=1);var E=this._findParentTile(w);if(E){var C=E.info.id;void 0===h[C]&&(h[C]=a.length,a.push(E))}else if(!a.length){var S=this._findChildTiles(w);S.length&&S.forEach((function(t){c[t.info.id]||(l.push(t),c[t.info.id]=1)}))}}}}return a.length&&(l.length=0,this._childTiles.length=0),{childTiles:l,parentTiles:a,tiles:s,placeholders:u,loading:r,loadingCount:i,tileQueue:d}},n.isTileCachedOrLoading=function(t){return this.tileCache.get(t)||this.tilesInView[t]||this.tilesLoading[t]},n._drawTiles=function(t,e,n,i,r){var o=this;e.length&&(e.sort((function(t,e){return Math.abs(e.info.z-o._tileZoom)-Math.abs(t.info.z-o._tileZoom)})),this._parentTiles=e),n.length&&(this._childTiles=n);var s={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:r};this.onDrawTileStart(s,r),1===this.layer.options.opacity&&(this._childTiles.forEach((function(t){return o._drawTile(t.info,t.image,r)})),this._parentTiles.forEach((function(t){return o._drawTile(t.info,t.image,r)}))),t.sort(this._compareTiles);for(var a=0,h=t.length;a<h;a++)this._drawTileAndCache(t[a],r);this.layer.options.opacity<1&&(this._childTiles.forEach((function(t){return o._drawTile(t.info,t.image,r)})),this._parentTiles.forEach((function(t){return o._drawTile(t.info,t.image,r)}))),i.forEach((function(t){return o._drawTile(t.info,t.image,r)})),this.onDrawTileEnd(s,r)},n.onDrawTileStart=function(){},n.onDrawTileEnd=function(){},n._drawTile=function(t,e,n){e&&this.drawTile(t,e,n)},n._drawTileAndCache=function(t,e){t.current=!0,this.tilesInView[t.info.id]=t,this._drawTile(t.info,t.image,e),this.tileCache.add(t.info.id,t)},n.drawOnInteracting=function(t,e,n){this.draw(e,n)},n.needToRedraw=function(){var e=this.getMap();return!!this._tileQueue.length||(e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this)))},n.hitDetect=function(){return!1},n._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:0},n.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1)},n.clear=function(){this._retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],t.prototype.clear.call(this)},n._isLoadingTile=function(t){return!!this.tilesLoading[t]},n.clipCanvas=function(e){return t.prototype.clipCanvas.call(this,e)},n._clipByPitch=function(t){var e=this.getMap();if(e.getPitch()<=e.options.maxVisualPitch)return!1;if(!this.layer.options.clipByPitch)return!1;var n=e.getContainerExtent(),i=e.getDevicePixelRatio();return t.save(),t.strokeStyle="rgba(0, 0, 0, 0)",t.beginPath(),t.rect(0,Math.ceil(n.ymin)*i,Math.ceil(n.getWidth())*i,Math.ceil(n.getHeight())*i),t.stroke(),t.clip(),!0},n.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var n=t[e],i=this.loadTile(n);void 0===i.loadTime&&(this.tilesLoading[n.id]={image:i,current:!0,info:n})}},n.loadTile=function(t){var e;if(this._tileImageWorkerConn&&this.loadTileImage===this.constructor.prototype.loadTileImage)this._fetchImage(e={},t);else{var n=this.layer.getTileSize(t.layer);(e=new Image).width=n.width,e.height=n.height,e.onload=this.onTileLoad.bind(this,e,t),e.onerror=this.onTileError.bind(this,e,t),this.loadTileImage(e,t.url)}return e},n._fetchImage=function(t,e){var n=this;if(t instanceof Image)t.src=e.url;else{var i=Math.abs(e.x+e.y)%this._tileImageWorkerConn.workers.length;this._tileImageWorkerConn.fetchImage(e.url,i,(function(i,r){i?n.onTileError(t,e,i):Vu(r,(function(t){n.onTileLoad(t,e)}))}),this.layer.options.fetchOptions||{referrer:document.location.href,headers:{accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}})}},n.loadTileImage=function(t,e){var n=this.layer.options.crossOrigin;return pc(n)||(t.crossOrigin=n),mu(t,[e])},n.abortTileLoading=function(t){t&&(t.onload=By,t.onerror=By,t.src=Bu)},n.onTileLoad=function(t,e){this._tileQueue.push({tileInfo:e,tileData:t})},n._consumeTileQueue=function(){for(var t=0,e=this.layer.options.tileLimitPerFrame,n=this._tileQueue;n.length&&(e<=0||t<e);){var i=n.shift(),r=i.tileData,o=i.tileInfo;this.checkTileInQueue(r,o)&&(this.consumeTile(r,o),t++)}},n.checkTileInQueue=function(){return!0},n.consumeTile=function(t,e){if(this.layer){var n=e.id;if(this.tilesInView){var i={tile:e,tileImage:t};this.layer.fire("tileload",i),(t=i.tileImage).loadTime=mc(),delete this.tilesLoading[n],this._addTileToCache(e,t),this.setToRedraw()}}},n.onTileError=function(t,e){if(this.layer){if(t.onerrorTick=t.onerrorTick||0,this.layer.options.tileRetryCount>t.onerrorTick)return t.onerrorTick++,void this._fetchImage(t,e);var n=this.layer.options.errorUrl;if(n){if(t instanceof Image&&t.src!==n)return void(t.src=n);(t=new Image).src=n}t=t instanceof Image?t:Fy,this.abortTileLoading(t,e),t.loadTime=0,delete this.tilesLoading[e.id],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e})}},n.drawTile=function(t,e){if(e&&this.getMap()){var n=t.extent2d,i=t.offset,r=Ry.set(n.xmin-i[0],n.ymax-i[1]),o=t.z,s=t.id,a=this.getMap(),h=a.getZoom(),l=this.context,c=a._pointAtResToContainerPoint(r,t.res,0,Oy),u=a.getBearing(),f=u||h!==o,d=this.getTileOpacity(e),m=l.globalAlpha;d<1&&(l.globalAlpha=d,this.setToRedraw()),f||c._round();var g=c.x,p=c.y,_=t.extent2d.xmax-t.extent2d.xmin,v=t.extent2d.ymax-t.extent2d.ymin;if(f){l.save(),l.translate(g,p),u&&(l.rotate(-u*Math.PI/180),_+=.1,v+=.1);var y=a._getResolution();if(y!==t.res){var x=t.res/y;l.scale(x,x)}g=p=0}if(Od.image(l,e,g,p,_,v),this.layer.options.debug){var b=this.layer.options.debugOutline;l.save(),l.strokeStyle=b,l.fillStyle=b,l.strokeWidth=10,l.font="20px monospace";var w=new fu(g,p);Od.rectangle(l,w,{width:_,height:v},1,0),Od.fillText(l,this.getDebugInfo(s),w._add(32,v-14),b),Od.drawCross(l,g+_/2,p+v/2,2,b),l.restore()}f&&l.restore(),l.globalAlpha!==m&&(l.globalAlpha=m),this.setCanvasUpdated()}},n.getDebugInfo=function(t){var e=t.split("_"),n=e.length;return"x:"+e[n-2]+", y:"+e[n-3]+", z:"+e[n-1]},n._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer);if(!e||!e.options.background)return[];for(var n=this.getMap(),i=[],r=t.res,o=t.extent2d.getMin(),s=t.extent2d.getMax(),a=e._project(n._pointToPrjAtRes(o,r,Iy),Iy),h=e._project(n._pointToPrjAtRes(s,r,Dy),Dy),l=1;l<3;l++)this._findChildTilesAt(i,a,h,e,t.z+l);return i},n._findChildTilesAt=function(t,e,n,i,r){var o=i.options.zoomOffset,s=i.getId(),a=i.getSpatialReference().getResolution(r+o);if(a)for(var h,l,c=i._getTileConfig().getTileIndex(e,a),u=i._getTileConfig().getTileIndex(n,a),f=Math.min(c.idx,u.idx),d=Math.max(c.idx,u.idx),m=Math.min(c.idy,u.idy),g=Math.max(c.idy,u.idy),p=f;p<d;p++)for(var _=m;_<g;_++)h=i._getTileId(p,_,r+o,s),this.tileCache.has(h)&&(l=this.tileCache.getAndRemove(h),t.push(l),this.tileCache.add(h,l))},n._findParentTile=function(t){var e=this.getMap(),n=this._getLayerOfTile(t.layer);if(!n||!n.options.background)return null;for(var i=n.getSpatialReference(),r=i.getZoomDirection(),o=n.options.zoomOffset,s=n.options.backgroundZoomDiff,a=t.res,h=t.extent2d.getCenter(),l=n._project(e._pointToPrjAtRes(h,a)),c=1;c<=s;c++){var u=t.z-r*c,f=i.getResolution(u+o);if(f){var d=n._getTileConfig().getTileIndex(l,f),m=n._getTileId(d.x,d.y,u+o,t.layer);if(this.tileCache.has(m)){var g=this.tileCache.getAndRemove(m);return this.tileCache.add(m,g),g}}}return null},n._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},n._getCachedTile=function(t){var e=this.tilesInView,n=this.tileCache.getAndRemove(t);if(n){e[t]=n;var i=this.tilesLoading;if(i&&i[t]){i[t].current=!1;var r=i[t];this.abortTileLoading(r.image,r.info),delete i[t]}}else n=e[t];return n},n._addTileToCache=function(t,e){this.tilesInView[t.id]={image:e,current:!0,info:t}},n.getTileOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(mc()-t.loadTime)/(1e3/60*10)):1},n.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,t.prototype.onRemove.call(this)},n._markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var n in this.tilesLoading)this.tilesLoading[n].current=!1,t++;if(this.tilesInView)for(var i in this.tilesInView)this.tilesInView[i].current=!1,e++;return[t,e]},n._retireTiles=function(t){for(var e in this.tilesLoading){var n=this.tilesLoading[e];!t&&n.current||(n.image&&this.abortTileLoading(n.image,n.info),this.deleteTile(n),delete this.tilesLoading[e])}for(var i in this.tilesInView){var r=this.tilesInView[i];r.current||(delete this.tilesInView[i],this.tileCache.has(i)||this.deleteTile(r))}},n.deleteTile=function(t){t&&t.image&&(t.image.close&&t.image.close(),t.image.onload=null,t.image.onerror=null)},n._generatePlaceHolder=function(t){var e=this.getMap(),n=this.layer.options.placeholder;if(!n||e.getPitch())return null;var i=this.layer.getTileSize(),r=t/e._getResolution(),o=this._tilePlaceHolder=this._tilePlaceHolder||Od.createCanvas(1,1,e.CanvasClass);return o.width=i.width*r,o.height=i.height*r,bc(n)?n(o):function(t){var e=t.getContext("2d"),n=t.width,i=t.height,r=n/16,o=i/16;e.beginPath();for(var s=0;s<16;s++)e.moveTo(0,s*o),e.lineTo(n,s*o),e.moveTo(s*r,0),e.lineTo(s*r,i);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var a=[[0,0],[n,0],[0,i],[n,i],[0,0],[0,i],[n,0],[n,i],[0,i/2],[n,i/2],[n/2,0],[n/2,i]],h=1;h<a.length;h+=2)e.moveTo(a[h-1][0],a[h-1][1]),e.lineTo(a[h][0],a[h][1]);e.lineWidth=4,e.stroke()}(o),o},e}(Vm);function By(){return!1}function Hy(t,e){return Math.abs(this._tileZoom-t.info.z)-Math.abs(this._tileZoom-e.info.z)}Vv.registerRenderer("canvas",Ny);var jy=new fu(0,0),zy={properties:{}},Gy=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.isDrawable=function(){return!0},n.needToRedraw=function(){var e=this.getMap();return!(!this._gl()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},n.onDrawTileStart=function(t,e){var n=this.gl;if(n.stencilOp(n.KEEP,n.KEEP,n.REPLACE),e&&e.renderTarget){var i=e.renderTarget.fbo;if(i){var r=e.renderTarget.getFramebuffer(i);n.bindFramebuffer(n.FRAMEBUFFER,r)}}},n.onDrawTileEnd=function(t,e){var n=this.gl;e&&e.renderTarget&&e.renderTarget.fbo&&n.bindFramebuffer(n.FRAMEBUFFER,null)},n.drawTile=function(e,n,i){if(!i||!i.sceneFilter||i.sceneFilter(zy)){var r=this.getMap();if(e&&r&&n){var o=e._glScale=e._glScale||e.res/r.getGLRes(),s=e.extent2d.xmax-e.extent2d.xmin,a=e.extent2d.ymax-e.extent2d.ymin;if(!1!==e.cache&&this._bindGLBuffer(n,s,a),this._gl()){var h=e.offset,l=jy.set(e.extent2d.xmin-h[0],e.extent2d.ymax-h[1]),c=l.x*o,u=l.y*o,f=this.getTileOpacity(n),d=null;this.layer.options.debug&&(d=this.getDebugInfo(e.id));var m=this.gl;m.stencilFunc(m.LEQUAL,Math.abs(this.getCurrentTileZoom()-e.z),255),this.drawGLImage(n,c,u,s,a,o,f,d),f<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,n)}}},n._bindGLBuffer=function(t,e,n){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,n))},n.loadTileImage=function(t,e){var n=this.layer.options.crossOrigin;t.crossOrigin=null!==n?n:"",t.src=e},n.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},n.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},n.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},n.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},n.getCanvasImage=function(){if(!this._gl()||!this.canvas2)return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},n._gl=function(){if(this.canvas.gl&&this.canvas.gl.wrap)return!0;var t=this.getMap();return t&&(t.getPitch()||t.getBearing())||this.layer&&!!this.layer.options.fragmentShader},n.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image),delete e.image},n.onRemove=function(){t.prototype.onRemove.call(this),this.removeGLCanvas()},e}(hy(Ny));function Uy(t){var e=this.layer.getTileSize(),n=this.canvas.constructor,i=this.getMap(),r=i.getDevicePixelRatio(),o=Od.createCanvas(e.width*r,e.height*r,n);o.layer=this.layer;var s=this,a=new fu(t.extent2d.xmin,t.extent2d.ymax),h=new am(i.pointToCoordinate(a),i.pointToCoordinate(a.add(e.width,e.height)),i.getProjection());return this.layer.drawTile(o,{url:t.url,point:a,center:i.pointToCoordinate(a.add(e.width/2,e.height/2)),extent:h,z:t.z,x:t.x,y:t.y},(function(e){e?s.onTileError(o,t):s.onTileLoad(o,t)})),o}Vv.registerRenderer("gl",Gy);var Vy=function(t){function e(){return t.apply(this,arguments)||this}return au(e,t),e.prototype.loadTile=function(){return Uy.apply(this,arguments)},e}(Ny),Wy=function(t){function e(){return t.apply(this,arguments)||this}return au(e,t),e.prototype.loadTile=function(){return Uy.apply(this,arguments)},e}(Gy);Qv.registerRenderer("canvas",Vy),Qv.registerRenderer("gl",Wy);var Xy=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.checkResources=function(){var t=this._geosToCheck;if(this._resourceChecked||t||(t=this.layer._geoList),!Su(t))return[];for(var e=[],n={},i=t.length-1;i>=0;i--){var r=t[i]._getExternalResources();if(r.length)if(this.resources)for(var o=0;o<r.length;o++){var s=r[o][0];this.resources.isResourceLoaded(r[o])||n[s]||(e.push(r[o]),n[s]=1)}else e.push.apply(e,r)}return this._resourceChecked=!0,delete this._geosToCheck,e},n.render=function(){return this.layer._sortGeometries(),t.prototype.render.apply(this,arguments)},n._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),yu(this._geosToCheck,t))},n.onGeometryAdd=function(t){this._addGeoToCheckRes(t),Zy(this)},n.onGeometryRemove=function(){Zy(this)},n.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),Zy(this)},n.onGeometryShapeChange=function(){Zy(this)},n.onGeometryPositionChange=function(){Zy(this)},n.onGeometryZIndexChange=function(){Zy(this)},n.onGeometryShow=function(){Zy(this)},n.onGeometryHide=function(){Zy(this)},n.onGeometryPropertiesChange=function(){Zy(this)},e}(Vm);function Zy(t){t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var qy=new lm,Yy=[],Ky=new lm,Jy=function(t){function e(){return t.apply(this,arguments)||this}au(e,t);var n=e.prototype;return n.getImageData=function(){if(!this.layer.options.geometryEvents||!this._lastRenderTime||mc()-this._lastRenderTime<32)return null;if(!this.context||!this.context.canvas)return null;if(!this._imageData){var t=this.context.canvas,e=t.width,n=t.height;try{this._imageData=this.context.getImageData(0,0,e,n)}catch(t){console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t)}}return this._imageData},n.clearImageData=function(){this._imageData=null,delete this._imageData,this._lastRenderTime=mc()},n.checkResources=function(){var e=this,n=t.prototype.checkResources.apply(this,arguments),i=this.layer.getStyle();return i&&(Array.isArray(i)||(i=[i]),i.forEach((function(t){for(var i=wf(t.symbol,!0),r=0,o=i.length;r<o;r++)e.resources.isResourceLoaded(i[r])||n.push(i[r])}))),n},n.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===m_)&&t.prototype.needToRedraw.call(this)},n.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},n.isBlank=function(){return!!this.context&&!this.context.canvas._drawn},n.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var t=this.getMap(),e=this.layer.getCount(),n=this.mapStateCache.resolution;(t.isZooming()&&t.options.seamlessZoom&&void 0!==this._drawnRes&&n>1.5*this._drawnRes&&this._geosToDraw.length<e||t.isMoving()||t.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this.forEachGeo(this.checkGeo,this),this._drawnRes=n),this._sortByDistanceToCamera(t.cameraPosition);for(var i=0,r=this._geosToDraw.length;i<r;i++){var o=this._geosToDraw[i];o._isCheck||o.isVisible()?(o._paint(this._displayExtent),this._geosToDraw[i]._cPoint=void 0,this._geosToDraw[i]._inCurrentView=void 0):(delete o._cPoint,delete o._inCurrentView)}this.clearImageData()}},n.show=function(){this.layer.forEach((function(t){t._repaint()})),t.prototype.show.apply(this,arguments)},n.forEachGeo=function(t,e){this.layer.forEach(t,e)},n.drawGeos=function(){this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this.forEachGeo(this.checkGeo,this),this._sortByDistanceToCamera(this.getMap().cameraPosition);for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint(),this._geosToDraw[t]._cPoint=void 0,this._geosToDraw[t]._inCurrentView=void 0;this.clearImageData()},n.prepareToDraw=function(){this._hasPoint=!1,this._geosToDraw=[]},n.checkGeo=function(t){if("Point"!==t.type||void 0===this._onlyHasPoint){if(t._isCheck=!1,t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),n=!0;if(t._inCurrentView)n=!0;else if(!1===t._inCurrentView)n=!1;else{var i=e.get2DExtent(this.resources,qy);i&&i.intersects(this._displayExtent)||(n=!1)}n&&(e.hasPoint()&&(this._hasPoint=!0),t._isCheck=!0,this._geosToDraw.push(t))}}else t._inCurrentView&&(this._hasPoint=!0,t._isCheck=!0,this._geosToDraw.push(t))},n.onZoomEnd=function(){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,arguments)},n.onRemove=function(){this.forEachGeo((function(t){t.onHide()})),delete this._geosToDraw},n.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},n._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},n.identifyAtPoint=function(t,e){void 0===e&&(e={});var n=this._geosToDraw;return n?this.layer._hitGeos(n,t,e):[]},n._updateMapStateCache=function(){var t=this.getMap(),e=t._pointToContainerPoint(this.southWest)._add(0,-t.height),n=t.getResolution(),i=t.getPitch(),r=t.getBearing(),o=t.getGLScale(),s=t.getGLRes(),a=t.getContainerExtent(),h=t._get2DExtent(),l=t._get2DExtentAtRes(s);return this.mapStateCache={resolution:n,pitch:i,bearing:r,glScale:o,glRes:s,_2DExtent:h,glExtent:l,containerExtent:a,offset:e},this},n._batchConversionMarkers=function(t){if(this._onlyHasPoint=void 0,!this._constructorIsThis())return[];var e=[],n=[],i=[],r={},o=this.layer,s=o.options,a=o.getAltitude?o.getAltitude():0,h=o.isCanvasRender();this._onlyHasPoint=!0;for(var l=0,c=0,u=this.layer._geoList.length;c<u;c++){var f=this.layer._geoList[c];if("Point"===f.getType()){var d=f._painter;d||(d=f._getPainter());var m=d.getRenderPoints("center")[0][0],g=s.enableAltitude?f.getAltitude():a;void 0===r[g]&&(r[g]=d.getAltitude()),e[l]=m,i[l]=r[g],n[l]=f,l++}else this._onlyHasPoint=!1}if(0===l)return[];var p=this.getMap(),_=Gu(e,"_pt");_=p._pointsAtResToContainerPoints(e,t,i,_);for(var v=p.getContainerExtent(),y=v.xmax,x=v.ymax,b=v.xmin,w=v.ymin,T={},M=0,A=n.length;M<A;M++){var E=n[M];if(E._cPoint=_[M],E._cPoint){var C=_[M],S=C.x,P=C.y;if(E._inCurrentView=S>=b&&P>=w&&S<=y&&P<=x,!E._inCurrentView){var R=E.getSymbolHash(),O=void 0;O=R?T[R]=T[R]||E._painter.getFixedExtent():E._painter.getFixedExtent(),Ky.set(O.xmin,O.ymin,O.xmax,O.ymax),Ky._add(_[M]),E._inCurrentView=Ky.intersects(v)}E._inCurrentView&&(E.isVisible()&&h||(E._inCurrentView=!1),this._onlyHasPoint&&E._inCurrentView&&(this._hasPoint=!0,E._isCheck=!0,this._geosToDraw.push(E)))}else E._inCurrentView=!1}return _},n._sortByDistanceToCamera=function(t){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var e=this.getMap(),n=e.distanceToPoint(1e3,0,e.getGLScale()).x/1e3;this._geosToDraw.sort((function(e,i){var r=e.getType(),o=i.getType();if("Point"!==r||"Point"!==o)return 0;var s=e._painter,a=i._painter;if(!s||!a)return 0;var h=s.getRenderPoints("center")[0][0],l=a.getRenderPoints("center")[0][0],c=s.getAltitude()*n,u=a.getAltitude()*n;R_(Yy,h.x,h.y,c);var f=L_(Yy,t);return R_(Yy,l.x,l.y,u),L_(Yy,t)-f}))}},n._constructorIsThis=function(){return this.constructor===e},e}(Xy);m_.registerRenderer("canvas",Jy);var Qy=function(t){function e(e){var n;return(n=t.call(this,e)||this)._containerIsCanvas=!!e._containerDOM.getContext,n._thisVisibilitychange=n._onVisibilitychange.bind(hu(hu(n))),n._registerEvents(),n._loopTime=0,n}au(e,t);var n=e.prototype;return n.load=function(){this.initContainer()},n.renderFrame=function(t){var e=this.map;if(!e||!e.options.renderable)return!1;if(e.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!0;this._updateDomPosition(t),delete this._isViewChanged,e._fireEvent("framestart"),this.updateMapDOM(),e.clearCollisionIndex();var n=this._getAllLayerToRender();return this.drawLayers(n,t),this.drawLayerCanvas(n)&&(this.drawTops(),this._drawCenterCross()),e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,!0},n.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t._getViewPointFrameOffset();e?t.offsetPlatform(e):this.domChanged()&&this.offsetPlatform(null,!0)}},n.drawLayers=function(t,e){for(var n=this.map,i=n.isInteracting(),r=[],o=[],s=n.options.fpsOnInteracting||0,a=0===s?0:1e3/s,h=this.map.options.layerCanvasLimitOnInteracting,l=t.length,c=n.getBaseLayer(),u=0,f=0;f<l;f++){var d=t[f];if(d.isVisible()){var m=d.isCanvasRender();m&&r.push(d.getId());var g=d._getRenderer();if(g){var p=this._checkLayerRedraw(d);m&&g.isCanvasUpdated()&&(p||o.push(d.getId()),this.setLayerCanvasUpdated());var _=g.__zoomTransformMatrix;if(delete g.__zoomTransformMatrix,p){if(i&&m){if(h>0&&l-1-f>h&&d!==c){d._getRenderer().clearCanvas();continue}u+=this._drawCanvasLayerOnInteracting(d,u,a,e)}else i&&g.drawOnInteracting?(g.prepareRender&&g.prepareRender(),g.checkAndDraw?g.checkAndDraw(g.drawOnInteracting,this._eventParam,e):g.drawOnInteracting(this._eventParam,e)):(g.render(e),m&&_&&g.isLoadingResource()&&(g.__zoomTransformMatrix=_));m&&(o.push(d.getId()),this.setLayerCanvasUpdated())}else m&&i&&(n.isZooming()&&!n.getPitch()?(g.prepareRender(),g.__zoomTransformMatrix=this._zoomMatrix):(n.getPitch()||n.isRotating())&&g.clearCanvas())}}}var v=this._canvasIds||[],y=this._updatedIds||[];this._canvasIds=r,this._updatedIds=o,this.isLayerCanvasUpdated()||v.join("---")===r.join("---")&&y.join("---")===o.join("---")||this.setLayerCanvasUpdated()},n._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,n=t._getRenderer();return t.isCanvasRender()?n.testIfNeedRedraw():!(!n.needToRedraw||!n.needToRedraw())||e.isInteracting()||this.isViewChanged()},n._drawCanvasLayerOnInteracting=function(t,e,n,i){var r=this.map,o=t._getRenderer(),s=o.getDrawTime(),a=0===n||n>0&&e+s<=n;if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(i);else{if(o.drawOnInteracting&&(t===r.getBaseLayer()||a||r.isZooming()&&t.options.forceRenderOnZooming||r.isMoving()&&t.options.forceRenderOnMoving||r.isRotating()&&t.options.forceRenderOnRotating))return o.prepareRender(),o.prepareCanvas(),o.checkAndDraw?o.checkAndDraw(o.drawOnInteracting,this._eventParam,i):o.drawOnInteracting(this._eventParam,i),s;!r.isZooming()||r.getPitch()||r.isRotating()?(r.getPitch()||r.isRotating())&&o.clearCanvas():(o.prepareRender(),o.__zoomTransformMatrix=this._zoomMatrix)}return o.drawOnInteracting&&!a&&o.onSkipDrawOnInteracting(this._eventParam,i),0},n._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach((function(e){var n=t.getLayer(e);if(n){var i=n._getRenderer();i&&i.isRenderComplete()&&n.fire("layerload")}}))}},n.isLayerCanvasUpdated=function(){return this._canvasUpdated},n.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},n.drawLayerCanvas=function(t){var e=this.map;if(!e)return!1;if(!this.isLayerCanvasUpdated()&&!this.isViewChanged())return!1;this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var n,i=e.isInteracting(),r=e.options.layerCanvasLimitOnInteracting,o=t.length,s=[],a=0;a<o;a++)if(t[a].isVisible()&&t[a].isCanvasRender()&&t[a]._getRenderer()){var h=this._getLayerImage(t[a]);h&&h.image&&(t[a]===e.getBaseLayer()?n=[t[a],h]:s.push([t[a],h]))}var l=this.canvas.width,c=this.canvas.height;n&&(this._drawLayerCanvasImage(n[0],n[1],l,c),this._drawFog()),o=s.length;for(var u=i&&r>=0&&o>r?o-r:0;u<o;u++)this._drawLayerCanvasImage(s[u][0],s[u][1],l,c);return e._fireEvent("renderend",{context:this.context}),!0},n.setToRedraw=function(){for(var t=this._getAllLayerToRender(),e=0,n=t.length;e<n;e++){var i=t[e].getRenderer();i&&i.canvas&&i.setToRedraw&&i.setToRedraw()}},n.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.height+"px",n=this.map._panels;n.mapWrapper.style.width=t.width+"px",n.mapWrapper.style.height=e,this._updateCanvasSize()}},n.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map._containerDOM:this.map._panels?this.map._panels.mapWrapper:null:null},n.toDataURL=function(t,e){return this.canvas?this.canvas.toDataURL(t,e):null},n.remove=function(){su.webgl&&"undefined"!=typeof document&&ad(document,"visibilitychange",this._thisVisibilitychange),this._resizeInterval&&clearInterval(this._resizeInterval),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},n.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){var n=e._getLayers(),i="default",r=e.options.hitDetectLimit||0,o=0;t&&t._round&&t._round();for(var s=n.length-1;s>=0;s--){var a=n[s];if(!(!a.options.hitDetect||a.isEmpty&&a.isEmpty())){var h=a._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==a.options.cursor&&h.hitDetect(t)){i=a.options.cursor||"pointer";break}if(o++,r>0&&o>r)break}}}e._trySetCursor(i)}},n._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},n.initContainer=function(){var t=this.map._panels;function e(e,n,i,r){var o,s=id("div",n);return i&&(s.style.cssText=i),t[e]=s,r||((o=s).onselectstart=function(){return!1},o.ondragstart=function(){return!1},o.setAttribute("unselectable","on")),s}var n=this.map._containerDOM;if(!this._containerIsCanvas){n.innerHTML="";var i="position:absolute;top:0px;left:0px;",r=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),o=e("allLayers","maptalks-all-layers",i+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),s=e("backStatic","maptalks-back-static",i+"z-index:0;",!0),a=e("back","maptalks-back",i+"z-index:1;"),h=e("backLayer","maptalks-back-layer",i),l=e("canvasContainer","maptalks-canvas-layer",i+"border:none;z-index:2;"),c=e("frontStatic","maptalks-front-static",i+"z-index:3;",!0),u=e("front","maptalks-front",i+"z-index:4;",!0),f=e("frontLayer","maptalks-front-layer",i+"z-index:0;"),d=e("ui","maptalks-ui",i+"border:none;z-index:1;",!0),m=e("control","maptalks-control","z-index:1",!0);n.appendChild(r),o.appendChild(s),a.appendChild(h),a.layerDOM=h,o.appendChild(a),o.appendChild(l),u.appendChild(f),u.layerDOM=f,u.uiDOM=d,o.appendChild(c),o.appendChild(u),u.appendChild(d),r.appendChild(o),r.appendChild(m),this.createCanvas(),this.resetContainer();var g=this.map._getContainerDomSize();this.updateMapSize(g)}},n.isViewChanged=function(){if(void 0!==this._isViewChanged)return this._isViewChanged;var t=this._mapview,e=this._getMapView();return this._isViewChanged=!t||!Hu(t,e),this._isViewChanged},n._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||Hu(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},n.isSpatialReferenceChanged=function(){return this._spatialRefChanged},n._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},n._frameLoop=function(t){var e=this;this.map?(this._frameTimestamp=t=t||0,this._resizeCount=0,this.renderFrame(t),this._animationFrame=lu((function(t){e._frameLoop(t)}))):this._cancelFrameLoop()},n._cancelFrameLoop=function(){this._animationFrame&&cu(this._animationFrame)},n._drawLayerCanvasImage=function(t,e,n,i){var r=this.context,o=e.point.round(),s=this.map.getDevicePixelRatio();1!==s&&o._multi(s);var a=e.image,h=a.width,l=a.height;if(!(o.x+h<=0||o.y+l<=0)){var c=t.options.opacity;if(_c(c)||(c=1),!(c<=0)){var u=e.opacity;if(_c(u)||(u=1),!(u<=0)){var f=r.globalAlpha;c<1&&(r.globalAlpha*=c),u<1&&(r.globalAlpha*=u),t.options.cssFilter&&(r.filter=t.options.cssFilter);var d=t.getRenderer(),m=d.__zoomTransformMatrix,g=d.clipCanvas(this.context);m&&(r.save(),r.setTransform.apply(r,m)),r.drawImage(a,0,0,h,l,o.x,o.y,n,i),m&&r.restore(),g&&r.restore(),"none"!==r.filter&&(r.filter="none"),r.globalAlpha=f}}}},n._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,n=new fu(this.canvas.width/2,this.canvas.height/2);bc(t)?t(e,n):Od.drawCross(this.context,n.x,n.y,2,"#f00")}},n._drawContainerExtent=function(){var t=this.map.options.cascadePitches,e=this.map.height-this.map._getVisualHeight(t[0]),n=this.map.height-this.map._getVisualHeight(t[1]),i=this.map.getContainerExtent(),r=this.context;r.beginPath(),r.moveTo(0,i.ymin),r.lineTo(i.xmax,i.ymin),r.stroke(),r.beginPath(),r.moveTo(0,e),r.lineTo(i.xmax,e),r.stroke(),r.beginPath(),r.moveTo(0,n),r.lineTo(i.xmax,n),r.stroke()},n._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=t.getDevicePixelRatio(),n=this.context,i=t.getContainerExtent(),r=(t.height-t._getVisualHeight(75))*e;r<0&&(r=0);var o=i.ymin*e,s=Math.ceil(o-r),a=t.options.fogColor.join(),h=n.createLinearGradient(0,r,0,o+30),l=1-30/(s+30);h.addColorStop(0,"rgba("+a+", 0)"),h.addColorStop(.3,"rgba("+a+", 0.3)"),h.addColorStop(l,"rgba("+a+", 1)"),h.addColorStop(1,"rgba("+a+", 0)"),n.beginPath(),n.fillStyle=h,n.fillRect(0,r,Math.ceil(i.getWidth())*e,Math.ceil(s+30))}},n._getAllLayerToRender=function(){return this.map._getLayers()},n.clearCanvas=function(){this.canvas&&Od.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},n._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map,e=t.getSize(),n=this.canvas,i=Zu(e,t.getDevicePixelRatio()),r=i.width,o=i.height,s=i.cssWidth,a=i.cssHeight;return!n.style||n.style.width===s&&n.style.height===a||(n.style.width=s,n.style.height=a),(r!==n.width||o!==n.height)&&(n.height=o,n.width=r,this.topLayer.width=n.width,this.topLayer.height=n.height,!0)},n.createCanvas=function(){this.topLayer=id("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map._containerDOM:(this.canvas=id("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},n._updateDomPosition=function(t){return void 0===this._checkPositionTime&&(this._checkPositionTime=-1/0),Math.abs(t-this._checkPositionTime)>=500&&(fd(this.map._containerDOM),this._checkPositionTime=Math.min(t,this._checkPositionTime)),this},n._checkSize=function(){this.map&&this.map.checkSize()},n._setCheckSizeInterval=function(t){var e=this;su.resizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver((function(t){!e.map||e.map.isRemoved()?e._resizeObserver.disconnect():t.length&&(e.map._containerDomContentRect=t[0].contentRect,e._checkSize(t[0].contentRect),e._resizeCount=e._resizeCount||0,e.renderFrame((e._frameTimestamp||0)+ ++e._resizeCount/100))})),this._resizeObserver.observe(this.map._containerDOM))):(clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval((function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()}),this._checkSizeInterval))},n._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!Cc&&"undefined"!=typeof window&&this._setCheckSizeInterval(e.options.checkSizeInterval),su.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",(function(e){t._eventParam=e})),e.on("_zooming",(function(n){e.getPitch()||(t._zoomMatrix=n.matrix.container),t._eventParam=n})),e.on("_zoomend",(function(e){t._eventParam=e,delete t._zoomMatrix})),e.on("_spatialreferencechange",(function(){t._spatialRefChanged=!0})),su.webgl&&"undefined"!=typeof document&&sd(document,"visibilitychange",this._thisVisibilitychange,this),su.addDPRListening&&su.addDPRListening(this.map)},n._onMapMouseMove=function(t){var e=this,n=this.map;!n.isInteracting()&&n.options.hitDetect&&(this._hitDetectFrame&&cu(this._hitDetectFrame),this._hitDetectFrame=lu((function(){e.hitDetect(t.containerPoint)})))},n._getCanvasLayers=function(){return this.map._getLayers((function(t){return t.isCanvasRender()}))},n._onVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},n.addTopElement=function(t){this._tops||(this._tops=[]),this._tops.push(t)},n.removeTopElement=function(t){if(this._tops){var e=this._tops.indexOf(t);e>=0&&this._tops.splice(e,1)}},n.getTopElements=function(){return this._tops||[]},n.drawTops=function(){this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var t=this.getTopElements(),e=!1,n=0;n<t.length;n++)t[n].render(this.topCtx)&&(e=!0);e&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},n._containerIsOffscreen=function(){var t=this.map.getContainer();return!t||!t.style||"none"===t.style.display||Math.min(t.clientWidth,t.clientHeight)<=0},e}(function(t){function e(e){var n;return(n=t.call(this)||this).map=e,n._handlerQueue=[],n}au(e,t);var n=e.prototype;return n.callInNextFrame=function(t){this._handlerQueue.push(t)},n.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,n=t.length;e<n;e++)t[e]()},n.offsetPlatform=function(t,e){if(!this.map._panels.front)return this;if(!e&&0===t.x&&0===t.y)return this;var n=this.map._panels,i=this._frontCount=n.back.layerDOM.childElementCount,r=this._backCount=n.front.layerDOM.childElementCount,o=this._uiCount=n.front.uiDOM.childElementCount;if(i||r||o){var s=this.map.offsetPlatform();s=t?s.add(t)._round():s.round(),r&&ud(n.back,s),(i||o)&&ud(n.front,s)}return this},n.domChanged=function(){var t=this.map._panels;return!!t.front&&(void 0===this._frontCount||this._frontCount!==t.back.layerDOM.childElementCount||void 0===this._backCount||this._backCount!==t.front.layerDOM.childElementCount||void 0===this._uiCount||this._uiCount!==t.front.uiDOM.childElementCount)},n.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map._panels.front)){var t=new fu(0,0);ud(this.map._panels.back,t),ud(this.map._panels.front,t)}},n.onZoomEnd=function(){this.resetContainer()},n.onLoad=function(){this._frameLoop()},e}(Bd));yp.registerRenderer("canvas",Qy),yp.mergeOptions({fog:!1,fogColor:[233,233,233]});var $y={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLRes())],null]}};Lp.include($y),Yp.include($y),qp.include($y),Jp.include($y),Kp.include({_getRenderPoints:function(t){var e=this.getMap(),n=e.getGLRes();if("vertex"===t){for(var i=this._trimRing(this.getShell()),r=[],o=0,s=i.length;o<s;o++)r.push(e.coordToPointAtRes(i[o],n));return[r,null]}return[[e.coordToPointAtRes(this.getCenter(),n)],null]}});var tx={_getRenderPoints:function(t){var e,n=this.getMap(),i=n.getGLRes(),r=null;if("point"===t)(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,i))&&e.length>0&&Array.isArray(e[0])&&(e=e[0].concat(e[1]));else if("vertex"===t)if(r=[],(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,i))&&e.length>0&&Array.isArray(e[0])){for(var o=0,s=e.length;o<s;o++)for(var a=0,h=e[o].length;a<h;a++)r.push(0===a?[e[o][a],e[o][a+1]]:[e[o][a-1],e[o][a]]);e=e[0].concat(e[1])}else for(var l=0,c=e.length;l<c;l++)r.push(0===l?[e[l],e[l+1]]:[e[l-1],e[l]]);else if("line"===t){e=[],r=[];var u=this._getPath2DPoints(this._getPrjCoordinates(),!1,i);if(u.length>0&&Array.isArray(u[0]))for(var f,d=1,m=u.length;d<m;d++){f=u[d],this instanceof Ip&&f.length>0&&!f[0].equals(f[f.length-1])&&f.push(f[0]);for(var g=1,p=f.length;g<p;g++)e.push(f[g].add(f[g-1])._multi(.5)),r.push([f[g-1],f[g]])}else{this instanceof Ip&&u.length>0&&!u[0].equals(u[u.length-1])&&u.push(u[0]);for(var _=1,v=u.length;_<v;_++)e.push(u[_].add(u[_-1])._multi(.5)),r.push([u[_-1],u[_]])}}else if("vertex-first"===t){var y=this._getPrjCoordinates(),x=y.length,b=x?n._prjToPointAtRes(y[0],i):null;e=x?[b]:[],r=x?[[b,y[1]?n._prjToPointAtRes(y[1],i):b]]:[]}else if("vertex-last"===t){var w=this._getPrjCoordinates(),T=w.length,M=T?n._prjToPointAtRes(w[T-1],i):null;e=T?[M]:[];var A=T>1?T-2:T-1;r=T?[[w[A]?n._prjToPointAtRes(w[A],i):M,M]]:[]}else{var E=this.getCenter();if(E){var C=this._getProjection().project(E);e=[n._prjToPointAtRes(C,i)]}else e=[]}return[e,r]}};Np.include(tx),Ip.include(tx);var ex={within:!1,center:[0,0]};function nx(t){if(t&&t._containerBbox){ex.within=!1;var e=t._containerBbox,n=e.minx,i=e.miny,r=e.maxx,o=e.maxy,s=Math.abs(r-n),a=Math.abs(o-i);s<=1&&a<=1&&(ex.within=!0,ex.center[0]=(n+r)/2,ex.center[1]=(i+o)/2),delete t._containerBbox}else ex.within=!1;return ex}sp.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1}});var ix={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof Yp||this instanceof Jp},_paintAsPath:function(){var t=this.getMap();return this.getAltitude()>0||t.getPitch()||this instanceof Yp&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return Ip.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),n=t._prjToPointAtRes(e,t.getGLRes()),i=this._getRenderSize(n);return[n].concat(i)},_paintOn:function(){return this._paintAsPath()?Od.polygon.apply(Od,arguments):Od.ellipse.apply(Od,arguments)},_getRenderSize:function(t){var e=this.getMap(),n=e.getGLRes(),i=this._getPrjExtent(),r=e._prjToPointAtRes(i.getMin(),n),o=e._prjToPointAtRes(i.getMax(),n);return[Math.abs(o.x-r.x)/2,Math.abs(o.y-t.y),Math.abs(t.y-r.y)]}};Yp.include(ix),qp.include(ix),Kp.include({_getPaintParams:function(){var t=this.getMap(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t.getGLRes())]},_paintOn:Od.polygon}),Jp.include(ix,{_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return Ip.prototype._getPaintParams.call(this,!0);var t=this.getMap(),e=t._prjToPointAtRes(this._getPrjCoordinates(),t.getGLRes());return[e,this._getRenderSize(e)[0],[this.getStartAngle(),this.getEndAngle()]]},_paintOn:function(){if(this._paintAsPath())return Od.polygon.apply(Od,arguments);var t=this.getMap().getBearing(),e=arguments;return t&&(e[3]=e[3].slice(0),e[3][0]+=t,e[3][1]+=t),Od.sector.apply(Od,e)}}),Op.include({_paintAsPath:function(){return!0}}),Np.include({arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,n,i,r){if(!t||!e||t.equals(e))return null;r||(r=0);var o,s=n*i[1]+r,a=n*i[0]/2+r;(o=e.sub(e.nextCtrlPoint||e.prevCtrlPoint?new fu(e.prevCtrlPoint?e.prevCtrlPoint:e.nextCtrlPoint):t))._unit();var h=e.sub(o.multi(s));o._perp();var l=h.add(o.multi(a));return o._multi(-1),[l,e,h.add(o.multi(a)),l]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLRes())]},_paintOn:function(t,e,n,i,r){var o=nx(this._painter);o.within?Od.pixelRect(t,o.center,n,i):this.options.smoothness?Od.paintSmoothLine(t,e,n,this.options.smoothness,!1,this._animIdx,this._animTailRatio):Od.path(t,e,n,null,r),this._paintArrow(t,e,n)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,n){var i=this._getArrowStyle();if(!i||t.length<2)return[];for(var r=t.length>0&&Array.isArray(t[0])?t:[t],o=this._getArrowPlacement(),s=[],a=this.getMap(),h=a.coordToContainerPoint(this.getFirstCoordinate()),l=a.coordToContainerPoint(this.getLastCoordinate()),c=r.length-1;c>=0;c--){if("vertex-first"===o||"vertex-firstlast"===o&&r[c][0].closeTo(h,.01)){var u=this._getArrowShape(r[c][1],r[c][0],e,i,n);u&&s.push(u)}if("vertex-last"===o||"vertex-firstlast"===o&&r[c][r[c].length-1].closeTo(l,.01)){var f=this._getArrowShape(r[c][r[c].length-2],r[c][r[c].length-1],e,i,n);f&&s.push(f)}else"point"===o&&this._getArrowPoints(s,r[c],e,i,n)}return s},_getArrowPoints:function(t,e,n,i,r){for(var o=0,s=e.length-1;o<s;o++){var a=this._getArrowShape(e[o],e[o+1],n,i,r);a&&t.push(a)}},_paintArrow:function(t,e,n){var i=this._getInternalSymbol().lineWidth;(!_c(i)||i<3)&&(i=3);var r=this._getArrows(e,i);if(r.length){t.setLineDash&&t.setLineDash([]);for(var o=r.length-1;o>=0;o--)t.fillStyle=t.strokeStyle,Od.polygon(t,r[o],n,n)}}}),Ip.include({_getPaintParams:function(t){var e=this.getMap().getGLRes(),n=this._getPrjShell(),i=this._getPath2DPoints(n,t,e),r=i.length>0&&Array.isArray(i[0]);r&&(i=[[i[0]],[i[1]]]);var o=this._getPrjHoles(),s=[];if(o&&o.length>0){for(var a=this._simplified,h=0;h<o.length;h++){var l=this._getPath2DPoints(o[h],t,e);Array.isArray(l)&&r?Array.isArray(l[0])?(i[0].push(l[0]),i[1].push(l[1])):i[0].push(l):s.push(l)}a&&(this._simplified=a)}return r||yu(i=[i],s),[i]},_paintOn:function(t,e,n,i,r){var o=nx(this._painter);o.within?Od.pixelRect(t,o.center,n,i):Od.polygon(t,e,n,i,r,this.options.smoothness)}}),yp.VERSION="1.0.0-rc.14";var rx="attribute vec3 aPosition;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = c * getPosition(aPosition);\n  gl_Position = projViewModelMatrix * d;\n}",ox={exports:{}};function sx(t,e,n){n=n||2;var i,r,o,s,a,h,l,c=e&&e.length,u=c?e[0]*n:t.length,f=ax(t,0,u,n,!0),d=[];if(!f||f.next===f.prev)return d;if(c&&(f=function(t,e,n,i){var r,o,s,a=[];for(r=0,o=e.length;r<o;r++)(s=ax(t,e[r]*i,r<o-1?e[r+1]*i:t.length,i,!1))===s.next&&(s.steiner=!0),a.push(vx(s));for(a.sort(mx),r=0;r<a.length;r++)n=gx(a[r],n);return n}(t,e,f,n)),t.length>80*n){i=o=t[0],r=s=t[1];for(var m=n;m<u;m+=n)(a=t[m])<i&&(i=a),(h=t[m+1])<r&&(r=h),a>o&&(o=a),h>s&&(s=h);l=0!==(l=Math.max(o-i,s-r))?32767/l:0}return lx(f,d,n,i,r,l,0),d}function ax(t,e,n,i,r){var o,s;if(r===Ox(t,e,n,i)>0)for(o=e;o<n;o+=i)s=Sx(o,t[o],t[o+1],s);else for(o=n-i;o>=e;o-=i)s=Sx(o,t[o],t[o+1],s);return s&&wx(s,s.next)&&(Px(s),s=s.next),s}function hx(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!wx(i,i.next)&&0!==bx(i.prev,i,i.next))i=i.next;else{if(Px(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function lx(t,e,n,i,r,o,s){if(t){!s&&o&&function(t,e,n,i){var r=t;do{0===r.z&&(r.z=_x(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,o,s,a,h,l=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,i=n,a=0,e=0;e<l&&(a++,i=i.nextZ);e++);for(h=l;a>0||h>0&&i;)0!==a&&(0===h||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,h--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(s>1)}(r)}(t,i,r,o);for(var a,h,l=t;t.prev!==t.next;)if(a=t.prev,h=t.next,o?ux(t,i,r,o):cx(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(h.i/n|0),Px(t),t=h.next,l=h.next;else if((t=h)===l){s?1===s?lx(t=fx(hx(t),e,n),e,n,i,r,o,2):2===s&&dx(t,e,n,i,r,o):lx(hx(t),e,n,i,r,o,1);break}}}function cx(t){var e=t.prev,n=t,i=t.next;if(bx(e,n,i)>=0)return!1;for(var r=e.x,o=n.x,s=i.x,a=e.y,h=n.y,l=i.y,c=r<o?r<s?r:s:o<s?o:s,u=a<h?a<l?a:l:h<l?h:l,f=r>o?r>s?r:s:o>s?o:s,d=a>h?a>l?a:l:h>l?h:l,m=i.next;m!==e;){if(m.x>=c&&m.x<=f&&m.y>=u&&m.y<=d&&yx(r,a,o,h,s,l,m.x,m.y)&&bx(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function ux(t,e,n,i){var r=t.prev,o=t,s=t.next;if(bx(r,o,s)>=0)return!1;for(var a=r.x,h=o.x,l=s.x,c=r.y,u=o.y,f=s.y,d=a<h?a<l?a:l:h<l?h:l,m=c<u?c<f?c:f:u<f?u:f,g=a>h?a>l?a:l:h>l?h:l,p=c>u?c>f?c:f:u>f?u:f,_=_x(d,m,e,n,i),v=_x(g,p,e,n,i),y=t.prevZ,x=t.nextZ;y&&y.z>=_&&x&&x.z<=v;){if(y.x>=d&&y.x<=g&&y.y>=m&&y.y<=p&&y!==r&&y!==s&&yx(a,c,h,u,l,f,y.x,y.y)&&bx(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,x.x>=d&&x.x<=g&&x.y>=m&&x.y<=p&&x!==r&&x!==s&&yx(a,c,h,u,l,f,x.x,x.y)&&bx(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;y&&y.z>=_;){if(y.x>=d&&y.x<=g&&y.y>=m&&y.y<=p&&y!==r&&y!==s&&yx(a,c,h,u,l,f,y.x,y.y)&&bx(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;x&&x.z<=v;){if(x.x>=d&&x.x<=g&&x.y>=m&&x.y<=p&&x!==r&&x!==s&&yx(a,c,h,u,l,f,x.x,x.y)&&bx(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function fx(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!wx(r,o)&&Tx(r,i,i.next,o)&&Ex(r,o)&&Ex(o,r)&&(e.push(r.i/n|0),e.push(i.i/n|0),e.push(o.i/n|0),Px(i),Px(i.next),i=t=o),i=i.next}while(i!==t);return hx(i)}function dx(t,e,n,i,r,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&xx(s,a)){var h=Cx(s,a);return s=hx(s,s.next),h=hx(h,h.next),lx(s,e,n,i,r,o,0),void lx(h,e,n,i,r,o,0)}a=a.next}s=s.next}while(s!==t)}function mx(t,e){return t.x-e.x}function gx(t,e){var n=function(t,e){var n,i=e,r=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>s&&(s=a,n=i.x<i.next.x?i:i.next,a===r))return n}i=i.next}while(i!==e);if(!n)return null;var h,l=n,c=n.x,u=n.y,f=1/0;i=n;do{r>=i.x&&i.x>=c&&r!==i.x&&yx(o<u?r:s,o,c,u,o<u?s:r,o,i.x,i.y)&&(h=Math.abs(o-i.y)/(r-i.x),Ex(i,t)&&(h<f||h===f&&(i.x>n.x||i.x===n.x&&px(n,i)))&&(n=i,f=h)),i=i.next}while(i!==l);return n}(t,e);if(!n)return e;var i=Cx(n,t);return hx(i,i.next),hx(n,n.next)}function px(t,e){return bx(t.prev,t,e.prev)<0&&bx(e.next,t,t.next)<0}function _x(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function vx(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function yx(t,e,n,i,r,o,s,a){return(r-s)*(e-a)>=(t-s)*(o-a)&&(t-s)*(i-a)>=(n-s)*(e-a)&&(n-s)*(o-a)>=(r-s)*(i-a)}function xx(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Tx(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Ex(t,e)&&Ex(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(bx(t.prev,t,e.prev)||bx(t,e.prev,e))||wx(t,e)&&bx(t.prev,t,t.next)>0&&bx(e.prev,e,e.next)>0)}function bx(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function wx(t,e){return t.x===e.x&&t.y===e.y}function Tx(t,e,n,i){var r=Ax(bx(t,e,n)),o=Ax(bx(t,e,i)),s=Ax(bx(n,i,t)),a=Ax(bx(n,i,e));return r!==o&&s!==a||!(0!==r||!Mx(t,n,e))||!(0!==o||!Mx(t,i,e))||!(0!==s||!Mx(n,t,i))||!(0!==a||!Mx(n,e,i))}function Mx(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Ax(t){return t>0?1:t<0?-1:0}function Ex(t,e){return bx(t.prev,t,t.next)<0?bx(t,e,t.next)>=0&&bx(t,t.prev,e)>=0:bx(t,e,t.prev)<0||bx(t,t.next,e)<0}function Cx(t,e){var n=new Rx(t.i,t.x,t.y),i=new Rx(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Sx(t,e,n,i){var r=new Rx(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Px(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Rx(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Ox(t,e,n,i){for(var r=0,o=e,s=n-i;o<n;o+=i)r+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return r}ox.exports=sx,ox.exports.default=sx,sx.deviation=function(t,e,n,i){var r=e&&e.length,o=Math.abs(Ox(t,0,r?e[0]*n:t.length,n));if(r)for(var s=0,a=e.length;s<a;s++)o-=Math.abs(Ox(t,e[s]*n,s<a-1?e[s+1]*n:t.length,n));var h=0;for(s=0;s<i.length;s+=3){var l=i[s]*n,c=i[s+1]*n,u=i[s+2]*n;h+=Math.abs((t[l]-t[u])*(t[c+1]-t[l+1])-(t[l]-t[c])*(t[u+1]-t[l+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)},sx.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[r][o][s]);r>0&&n.holes.push(i+=t[r-1].length)}return n};var Ix=ox.exports;const Dx=[],kx=[],Lx=[1,1,1],Fx=[0,0,0,1];class Nx{constructor(t,e){this.regl=t,this._viewport=e,this.renderer=new Ta(t),this._init()}_init(){this._maskColorFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._maskModeFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0});const t=[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>re([],e.projViewMatrix,e.modelMatrix)}];this._maskColorShader=new jh({vert:rx,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec4 maskColor;\nvoid main() {\n  gl_FragColor = maskColor;\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._maskModeShader=new jh({vert:rx,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float maskMode;\nuniform float flatHeight;\nuniform vec2 heightRange;\nvoid main() {\n  gl_FragColor = vec4(maskMode, flatHeight, heightRange.x, heightRange.y);\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._scene=new nh}setExtentPositions(t){this._disposeMeshes();const e=this._calExtent(t),n=[(e[0]+e[2])/2,(e[1]+e[3])/2,0],i=[];for(let r=0;r<t.length;r++){const e=this._createMesh(t[r],n);i.push(e)}this._meshes=i}_createMesh(t,e){const n=[],{position:i,maskColor:r,maskMode:o,flatHeight:s,heightRange:a}=t;for(let f=0;f<i.length;f++){const t=i[f];n.push(t[0]-e[0]),n.push(t[1]-e[1]),n.push(t[2])}const h=Ix(n,null,3),l=new La({POSITION:n},h,0,{positionAttribute:"POSITION"});l.generateBuffers(this.regl);const c=new Ya(l);c.setUniform("maskColor",r),c.setUniform("maskMode",o),c.setUniform("flatHeight",s),c.setUniform("heightRange",a);const u=we(Dx,Ai(kx),e,Lx);return c.localTransform=u,c}render(t){this._resize(),this.renderer.clear({color:Fx,depth:1,framebuffer:this._maskColorFbo}),this.renderer.clear({color:Fx,depth:1,framebuffer:this._maskModeFbo}),this._scene.setMeshes(this._meshes);const e={projViewMatrix:t};return this.renderer.render(this._maskColorShader,e,this._scene,this._maskColorFbo),this.renderer.render(this._maskModeShader,e,this._scene,this._maskModeFbo),{colorExtent:this._maskColorFbo,modeExtent:this._maskModeFbo}}_calExtent(t){let e=1/0,n=1/0,i=-1/0,r=-1/0;for(let o=0;o<t.length;o++){const{position:s}=t[o];for(let t=0;t<s.length;t++)s[t][0]<e&&(e=s[t][0]),s[t][1]<n&&(n=s[t][1]),s[t][0]>i&&(i=s[t][0]),s[t][1]>r&&(r=s[t][1])}return[e,n,i,r]}_resize(){const t=Qf.isFunction(this._viewport.width)?this._viewport.width():this._viewport.width.data(),e=Qf.isFunction(this._viewport.height)?this._viewport.height():this._viewport.height.data();!this._maskColorFbo||this._maskColorFbo.width===t&&this._maskColorFbo.height===e||(this._maskColorFbo.resize(t,e),this._maskModeFbo.resize(t,e))}_disposeMeshes(){this._meshes&&(this._meshes.forEach((t=>{t.geometry.dispose(),t.dispose()})),delete this._meshes)}dispose(){this._maskColorFbo&&(this._maskColorFbo.destroy(),delete this._maskColorFbo),this._maskModeFbo&&(this._maskModeFbo.destroy(),delete this._maskModeFbo),this._maskColorShader&&(this._maskColorShader.dispose(),delete this._maskColorShader),this._maskModeShader&&(this._maskModeShader.dispose(),delete this._maskModeShader),this._disposeMeshes()}}const Bx=[];class Hx{constructor(t,e,n){this._regl=t,this.joints=e,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*e.length);for(let i=0;i<e.length;++i)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*i,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*i,16));this.jointTexture=t.texture(),this.jointTextureSize=[4,6]}updateJointTexture(t){this.jointTexture||this.jointTexture.texture({width:4,height:t})}setJointTexture(t){this.jointTexture=t}update(t){ee(Bx,t);for(let e=0;e<this.joints.length;++e){const t=this.jointMatrices[e];re(t,Bx,this.joints[e].nodeMatrix),re(t,t,this.inverseBindMatrices[e])}this.jointTexture({width:4,type:"float",height:this.joints.length,data:this.jointData})}dispose(){this.jointTexture.destroy()}}const jx=[0,0,0],zx=[0,0,0,1],Gx=[1,1,1],Ux=[];class Vx{constructor(t=[0,0,0],e=[0,0,0,1],n=[1,1,1]){this.translation=t,this.rotation=e,this.scale=n}getMatrix(){return we(Ux,this.rotation,this.translation,this.scale)}decompose(t){ye(this.translation,t),be(this.rotation,t),xe(this.scale,t)}update(t){t&&(t.translation&&!Cn(t.translation,jx)&&Xe(this.translation,t.translation),t.rotation&&!ar(t.rotation,zx)&&qi(this.rotation,t.rotation),t.scale&&!Cn(t.scale,Gx)&&Xe(this.scale,t.scale))}}class Wx{constructor(t){this._init(t)}_init(t){this.geometry=t.geometry,this.nodeMatrix=t.nodeMatrix,this.materialInfo=t.materialInfo,this.extraInfo=t.extraInfo,this.animationMatrix=t.animationMatrix,this.morphWeights=t.morphWeights,this.skin=t.skin}copy(){this.copyGeometry||(this.copyGeometry=this._copyGeometry(this.geometry))}createCopyBarycentric(){this.copyGeometry&&!this.copyGeometry.data.aBarycentric&&(this.copyGeometry.buildUniqueVertex(),this.copyGeometry.createBarycentric("aBarycentric"))}_copyGeometry(t){const e=t.data,n=t.elements,i={};for(const h in e)if(na(e[h]))i[h]=e[h].slice();else if(e[h].buffer&&e[h].buffer.destroy)i[h]={buffer:e[h].buffer},na(e[h].array)&&(i[h].array=e[h].array.slice());else{const e=t._getAttributeData(h);i[h]=h!==t.desc.positionAttribute?e:e.slice()}const r=void 0!==n.length?n.slice():n,o=t.count,s=JSON.parse(JSON.stringify(t.desc)),a=new La(i,r,o,s);return a.properties=t.properties,a}}let Xx=0;class Zx{constructor(t,e){this.gltf=t,this.regl=e,this.geometries=[],e&&(this._emptyTexture=e.texture({width:2,height:2}))}getMeshesInfo(){return this.gltf?(this.geometries.length||(this._createTextures(this.gltf.textures),this._createSkins(this.gltf.skins),this.gltf.scenes[0].nodes.forEach((t=>{this._parserNode(t,this.geometries)}))),this.geometries):null}_createSkins(t){if(t){this._skinMap={};for(let e=0;e<t.length;e++){const n=t[e];n.joints=n.joints.map((t=>this.gltf.nodes[t])),this._skinMap[e]=new Hx(this.regl,n.joints,n.inverseBindMatrices.array),delete n.inverseBindMatrices}}}_createTextures(t){if(t){this._textureMap={};for(let e=0;e<t.length;e++){const n=t[e];this._textureMap[e]||(this._textureMap[e]=this._toTexture(n),delete n.image)}}}dispose(){this._emptyTexture&&this._emptyTexture.destroy();const t=this.getMeshesInfo();if(t){t.forEach((t=>{t.geometry.dispose();for(const e in t.materialInfo){const n=t.materialInfo[e];n.destroy&&!n[va]&&n.destroy()}}));for(const t in this._textureMap){const e=this._textureMap[t];e.destroy&&!e[va]&&e.destroy()}for(const t in this._skinMap){const e=this._skinMap[t];e.jointTexture&&!e.jointTexture[va]&&e.jointTexture.destroy()}for(const t in this.gltf.nodes){const e=this.gltf.nodes[t];e.skin&&e.skin.jointTexture&&!e.skin.jointTexture[va]&&e.skin.jointTexture.destroy()}delete this.gltf}}updateAnimation(t,e,n,i){const r=this.gltf;if(!r)return;if(Xx=r.animations?Es.getAnimationTimeSpan(r,i):null,!Xx)return;const o=e?t*n*.001%(Xx.max-Xx.min)+Xx.min:t*n*.001+Xx.min;this._startTime||(this._startTime=t),r.scenes[0].nodes.forEach((t=>{this._updateNodeMatrix(i,o,t)}));for(const s in this.gltf.nodes){const t=this.gltf.nodes[s];t.skin&&t.skin.update(t.nodeMatrix)}}isFirstLoop(t,e,n){const i=this.gltf;return!this._startTime||!i||(Xx=i.animations?Es.getAnimationTimeSpan(i,n):null,(t-this._startTime)*e*.001/(Xx.max-Xx.min)<1)}hasSkinAnimation(){return!!this._isAnimation}_updateNodeMatrix(t,e,n,i){if(n.trs){const i=Es.getAnimationClip(this.gltf,Number(n.nodeIndex),e,t);i.weights&&this._updateMorph(n,i.weights),n.trs.update(i)}i?re(n.nodeMatrix,i,n.matrix||n.trs.getMatrix()):Kt(n.nodeMatrix,n.matrix||n.trs.getMatrix());const r=n.nodeMatrix;n.children&&n.children.forEach((n=>{this._updateNodeMatrix(t,e,n,r)})),this._updateSkinTexture(n)}_updateMorph(t,e){const n=e.length;if(!t.influencesList){t.influencesList=[];for(let e=0;e<n;e++)t.influencesList[e]=[e,0]}const i=t.influencesList;for(let o=0;o<i.length;o++){const t=i[o];t[0]=o,t[1]=e[o]}i.sort(Yx);const r=[];for(let o=0;o<8;o++)r[o]=[o,0];for(let o=0;o<8;o++)o<n&&i[o][1]?(r[o][0]=i[o][0],r[o][1]=i[o][1]):(r[o][0]=Number.MAX_SAFE_INTEGER,r[o][1]=0);r.sort(qx),t.geometries.forEach((t=>{const e=t.properties.morphTargets;for(let n=0;n<8;n++){const i=r[n],o=i[0],s=i[1];o!==Number.MAX_SAFE_INTEGER&&s?(t.updateData("POSITION"+n,e["POSITION_"+o].array),t.properties.morphWeights[n]=s):t.properties.morphWeights[n]=0}}))}_updateSkinTexture(t){if(!this.gltf.joints)return;const e=this.gltf.animations;if(!e)return;const n=this.gltf.joints.length;e.forEach((e=>{const i=e.channels;for(let r=0;r<i.length;r++)i[r].target.node===t.nodeIndex&&t.skin.updateJointTexture(n)}))}_parserNode(t,e,n){if(t.isParsed)return;t.nodeMatrix=t.nodeMatrix||$t([]),t.localMatrix=t.localMatrix||$t([]),t.matrix?(t.trs=new Vx,t.trs.decompose(t.matrix)):t.trs=new Vx(t.translation,t.rotation,t.scale),t.localMatrix=t.trs.getMatrix(),n?re(t.nodeMatrix,n,t.matrix||t.localMatrix):Kt(t.nodeMatrix,t.matrix||t.localMatrix);const i=t.nodeMatrix;if(t.children)for(let r=0;r<t.children.length;r++)this._parserNode(t.children[r],e,i);if(Ys(t.skin)){this._isAnimation=!0;const e=t.skin;t.trs=new Vx,t.skin=this._skinMap[e]}Ys(t.mesh)&&(t.mesh=this.gltf.meshes[t.mesh],t.mesh.node=t,t.geometries=t.geometries||[],t.mesh.primitives.forEach((n=>{const r=function(t,e){const n=t.attributes,i=n.COLOR_0;if(i&&i.array instanceof Float32Array){const t=new Uint8Array(i.array.length);for(let e=0;e<t.length;e++)t[e]=Math.round(255*i.array[e]);i.array=t}else if(i&&i.array instanceof Uint16Array){const t=new Uint8Array(i.array);i.array=t}const r={};for(const a in n)r[a]=Qs({},n[a]),e&&(r[a].buffer=Th(e,n[a],{dimension:n[a].itemSize}));if(t.morphTargets){const t=fa(r.POSITION)?r.POSITION.itemSize*r.POSITION.count:r.POSITION.array.length;for(let e=0;e<8;e++)r["POSITION"+e]||(r["POSITION"+e]=new Float32Array(t).fill(0));for(let e=0;e<4;e++){const t=r.NORMAL.array?r.NORMAL.array.length:r.NORMAL.length;r["NORMAL"+e]||(r["NORMAL"+e]=new Float32Array(t).fill(0))}}let o=t.indices;o&&void 0===o.bufferView&&o.array&&(o=o.array);const s=new La(r,o,0,{primitive:ta(t.mode)?ch(t.mode):t.mode,positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",color0Attribute:"COLOR_0"});return t.morphTargets&&(s.properties.morphWeights=[]),t.mode>3&&!s.data.NORMAL&&s.createNormal("NORMAL"),s}(n,this.regl);r.properties.morphTargets=n.morphTargets,t.geometries.push(r);const o=this._createMaterialInfo(n.material),s={geometry:r,nodeMatrix:i,materialInfo:o,extraInfo:this._createExtralInfo(n.material),animationMatrix:t.trs.getMatrix(),morphWeights:t.weights};t.skin&&(s.skin={jointTextureSize:[4,6],numJoints:t.skin.joints.length,jointTexture:t.skin.jointTexture});const a=new Wx(s);e.push(a)}))),t.isParsed=!0}_createMaterialInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t],i=n.pbrMetallicRoughness;if(i){const t=i.metallicRoughnessTexture,n=i.baseColorTexture;n&&(e.baseColorTexture=this._getTexture(n),n.KHR_texture_transform&&(e.khr_offset=n.KHR_texture_transform.offset||[0,0],e.khr_rotation=n.KHR_texture_transform.rotation||0,e.khr_scale=n.KHR_texture_transform.scale||[1,1])),i.baseColorFactor&&(e.baseColorFactor=i.baseColorFactor),t?e.metallicRoughnessTexture=this._getTexture(t):(Ys(i.metallicFactor)&&(e.metallicFactor=i.metallicFactor),Ys(i.roughnessFactor)&&(e.roughnessFactor=i.roughnessFactor))}const r=n.extensions;if(r&&r.KHR_materials_pbrSpecularGlossiness){const t=r.KHR_materials_pbrSpecularGlossiness;e.name="pbrSpecularGlossiness";for(const n in t)e[n]=Ys(t[n].index)?this._getTexture(t[n]):t[n]}n.normalTexture&&(e.normalTexture=this._getTexture(n.normalTexture)),n.occlusionTexture&&(e.occlusionTexture=this._getTexture(n.occlusionTexture)),n.emissiveTexture&&(e.emissiveTexture=this._getTexture(n.emissiveTexture)),n.emissiveFactor&&(e.emissiveFactor=n.emissiveFactor),e.alphaCutoff=n.alphaCutoff||.5}return e}_createExtralInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t];e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_getTexture(t){const e=t.extensions,n=t.index;if(!Ys(n))return null;e&&e.KHR_texture_transform&&(t.KHR_texture_transform=e.KHR_texture_transform);const i=this._textureMap[n];return i.texInfo=t,i}_toTexture(t){if(!t)return this._emptyTexture;const e=t.sampler||{};return new Eh({width:t.image.width,height:t.image.height,data:t.image.array,mag:ph(e.magFilter)||"linear",min:vh(e.minFilter)||"linear",wrapS:xh(e.wrapS)||"repeat",wrapT:xh(e.wrapT)||"repeat"})}}function qx(t,e){return t[0]-e[0]}function Yx(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Kx(t){const e=t.lastIndexOf("/"),n=t.slice(0,e),i=t.slice(t.lastIndexOf(".")).toLowerCase();return".gltf"===i?function(t,e){return ss.getJSON(t,e)}(t,{}).then((t=>Qx(n,t))):".glb"===i?function(t,e){return ss.getArrayBuffer(t,e)}(t,{}).then((t=>Qx(n,{buffer:t.data,byteOffset:0}))):null}function Jx(t,e){return new Zx(t,e)}function Qx(t,e){return new Es(t,e).load()}var $x=Object.freeze({__proto__:null,load:Kx,exportGLTFPack:Jx,loadGLTF:Qx});const tb=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],eb=[0,1,0,0,1,0,0,1,0,0,1,0],nb=[3,1,0,0,2,3],ib=[0,0,1,0,0,1,1,1],rb={vertices:[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],normals:[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],indices:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},ob={cube:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]},plane:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(tb)},NORMAL:{array:new Int8Array(eb)},TEXCOORD_0:{array:new Int8Array(ib)}},indices:new Uint16Array(nb),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]},pyramid:{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(rb.vertices)},NORMAL:{array:new Float32Array(rb.normals)},TEXCOORD_0:{array:new Float32Array(rb.uv)}},indices:new Uint16Array(rb.indices),mode:4}]}],scenes:[{nodes:[{mesh:0}]}]}};class sb{constructor(t,e){this.regl=t,this.resourceMap={},this._requestor=e}getGLTF(t){return this.resourceMap[t]}loginGLTF(t){if(this.resourceMap[t])this.resourceMap[t].refCount+=1;else{if(ob[t]){const e=function(t){let e=null;return ob[t]&&(e={meshes:ob[t].meshes},e.scenes=JSON.parse(JSON.stringify(ob[t].scenes))),e}(t);this.resourceMap[t]=this._exportGLTFResource(e,t,!1)}else this.resourceMap[t]=this._requestor?this._requestor(t).then((e=>{const n=this._exportGLTFResource(e,t);return this.resourceMap[t]=n,n})):this._loadGLTFModel(t).catch((t=>t));this.resourceMap[t].refCount=1}}logoutGLTF(t){if(this.resourceMap[t]&&(this.resourceMap[t].refCount-=1,this.resourceMap[t].refCount<1)){const e=this.resourceMap[t].resources;if(e)for(let t=0;t<e.length;t++)e[t].geometry.dispose(),e[t].copyGeometry&&e[t].copyGeometry.dispose(),e[t].material&&e[t].material.dispose();this.resourceMap[t].gltfPack&&this.resourceMap[t].gltfPack.dispose(),delete this.resourceMap[t]}}isSimpleModel(t){return ob[t]}_exportGLTFResource(t,e,n=!0){const i=Jx(t,n?this.regl:null),r=i.getMeshesInfo();return{gltfPack:i,resources:r,json:{asset:t.asset,animations:t.animations?t.animations.map((t=>({name:t.name}))):null},refCount:this.resourceMap[e]?this.resourceMap[e].refCount:0}}_loadData(t){return Kx(t).then((t=>t))}_loadGLTFModel(t){return this._loadData(t).then((e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t])))}}const ab=function(){const t=[0,0,0],e=[Pe([],t,[1,0,0],[0,-1,0]),Pe([],t,[-1,0,0],[0,-1,0]),Pe([],t,[0,1,0],[0,0,1]),Pe([],t,[0,-1,0],[0,0,-1]),Pe([],t,[0,0,1],[0,-1,0]),Pe([],t,[0,0,-1],[0,-1,0])],n=90*Math.PI/180,i=[0,0,0,0],r=new Array(16);return function(t,o,s,a,h){const l={context:{viewMatrix:function(t,n,i){return e[i]},projMatrix:Ee(r,n,1,.5,1.1)}};return o&&(l.framebuffer=o.faces?function(t,e,n){return o.faces[n]}:o),t(l)(6,((e,n,r)=>{const l={color:i,depth:1};o&&(l.framebuffer=o.faces?o.faces[r]:o),t.clear(l),s(a),h&&h()})),o}}();var hb={vertices:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],textures:[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},lb="attribute vec3 aPosition;\nvarying vec3 vWorldPos;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nvoid main() {\n  vWorldPos = aPosition;\n  gl_Position = projMatrix * viewMatrix * vec4(vWorldPos, 1.);\n}",cb="precision highp float;\n#define PI 3.1415926\nvarying vec3 vWorldPos;\nuniform sampler2D equirectangularMap;\nconst vec2 c = vec2(.1591, .3183);\nvec2 d(vec3 e) {\n  vec2 f = vec2(atan(e.y, e.x), asin(e.z));\n  f *= c;\n  f += .5;\n  return f;\n}\nvec3 h(const in vec4 i, const in float j) {\n  return j * i.rgb * i.a;\n}\nvec4 k(const in vec3 i, const in float j) {\n  vec4 l;\n  vec3 m = i / j;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvoid main() {\n  vec2 f = d(normalize(vWorldPos));\n  vec4 i = texture2D(equirectangularMap, f);\n#ifdef INPUT_RGBM\ngl_FragColor = i;\n#else\ngl_FragColor = vec4(h(i, 7.), 1.);\n#endif\n}";function ub(t,e){var n=t[0],i=t[1],r=t[2];return 0===e?1:1===e?n:2===e?i:3===e?r:4===e?n*r:5===e?i*r:6===e?n*i:7===e?3*r*r-1:n*n-i*i}var fb={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]},db=["px","nx","py","ny","pz","nz"];const mb=Rh.compile(vl);function gb(t,e,n){const i=t({frag:mb,vert:lb,attributes:{aPosition:hb.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,environmentExposure:1,bias:0,size:n,hsv:[0,0,0]},elements:hb.indices}),r=[],o=t.framebuffer(n);return ab(t,o,i,{size:n},(function(){const e=t.read();r.push(new e.constructor(e))})),i.destroy(),o.destroy(),r}const pb=new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),_b=new Int8Array([0,1,0,0,1,1,1,0]);function vb(t,e,n,i){e=e||256;const r=yb(n=n||1024,i=i||256),o=t.texture({data:r,width:i,height:n,min:"nearest",mag:"nearest"}),s=t.buffer(pb),a=t.buffer(_b),h=t.framebuffer({radius:e,colorType:"uint8",colorFormat:"rgba",min:"linear",mag:"linear"}),l=t({frag:"precision mediump float;\nvarying vec2 vTexCoords;\nuniform sampler2D distributionMap;\nconst float c = 3.14159265359;\nvec4 d(float a, float b) {\n  a *= 65535.;\n  b *= 65535.;\n  vec4 rgba;\n  rgba[0] = mod(a, 255.);\n  rgba[1] = (a - rgba[0]) / 65280.0;\n  rgba[2] = mod(b, 255.);\n  rgba[3] = (b - rgba[2]) / 65280.0;\n  return rgba;\n}\nvec3 e(float f, vec3 h, float i) {\n  vec4 j = texture2D(distributionMap, vec2(i, f));\n  vec3 k = j.xyz;\n  float l = sign(j.w - .5);\n  float m = sign(j.w - clamp(l, .0, 1.) * 200.0 / 255. - .15);\n  k.x *= l;\n  k.y *= m;\n  vec3 n = abs(h.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 o = normalize(cross(n, h));\n  vec3 u = cross(h, o);\n  vec3 v = o * k.x + u * k.y + h * k.z;\n  return normalize(v);\n}\nfloat A(float B, float i) {\n  float a = i;\n  float C = (a * a) / 2.;\n  float D = B;\n  float E = B * (1. - C) + C;\n  return D / E;\n}\nfloat F(float B, float G, float i) {\n  float I = A(B, i);\n  float J = A(G, i);\n  return J * I;\n}\nvec2 K(float B, float i) {\n  vec3 L;\n  L.x = sqrt(1. - B * B);\n  L.y = .0;\n  L.z = B;\n  float M = .0;\n  float O = .0;\n  vec3 h = vec3(.0, .0, 1.);\n  const int P = 1024;\n  for(int Q = 0; Q < P; ++Q) {\n    vec3 k = e(float(Q) / float(P), h, i);\n    vec3 R = normalize(2. * dot(L, k) * k - L);\n    float G = max(R.z, .0);\n    float S = max(k.z, .0);\n    float T = max(dot(L, k), .0);\n    float B = max(dot(h, L), .0);\n    if(G > .0) {\n      float U = F(B, G, i);\n      float W = (U * T) / (S * B);\n      float X = pow(1. - T, 5.);\n      M += (1. - X) * W;\n      O += X * W;\n    }\n  }\n  M /= float(P);\n  O /= float(P);\n  return vec2(M, O);\n}\nvoid main() {\n  vec2 Y = K(vTexCoords.x, vTexCoords.y);\n  gl_FragColor = d(Y.x, Y.y);\n}",vert:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoords;\nvoid main() {\n  vTexCoords = aTexCoord;\n  gl_Position = vec4(aPosition, 1.);\n}",attributes:{aPosition:{buffer:s},aTexCoord:{buffer:a}},uniforms:{distributionMap:o},framebuffer:h,viewport:{x:0,y:0,width:e,height:e},count:pb.length/3,primitive:"triangle strip"});return l(),l.destroy(),s.destroy(),a.destroy(),o.destroy(),h}function yb(t,e){const n=new Array(t*e*4);for(let i=0;i<t;i++){const{x:r,y:o}=xb(i,t);for(let t=0;t<e;t++){const s=t/e,a=s*s,h=2*Math.PI*r,l=Math.sqrt((1-o)/(1+(a*a-1)*o)),c=Math.sqrt(1-l*l),u=4*(i*e+t),f=c*Math.cos(h),d=c*Math.sin(h);n[u]=Math.abs(255*f),n[u+1]=Math.abs(255*d),n[u+2]=255*l,n[u+3]=(f>0?200:0)+(d>0?55:0)}}return n}function xb(t,e){let n=(t<<16|t>>>16)>>>0;return n=((1431655765&n)<<1|(2863311530&n)>>>1)>>>0,n=((858993459&n)<<2|(3435973836&n)>>>2)>>>0,n=((252645135&n)<<4|(4042322160&n)>>>4)>>>0,n=(((16711935&n)<<8|(4278255360&n)>>>8)>>>0)/4294967296,{x:t/e,y:n}}var bb=Object.freeze({__proto__:null,createIBLMaps:function(t,e={}){const n=e.envTexture,i=e.envCubeSize||512,r=e.sampleSize||1024,o=e.roughnessLevels||256,s=e.prefilterCubeSize||256;let a;if(Array.isArray(n)){const e=t.cube(...n);a=function(t,e,n,i){const r=t({frag:"#define ENC_RGBM 1\n"+mb,vert:lb,attributes:{aPosition:hb.vertices},uniforms:{hsv:[0,0,0],projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,bias:0,size:t.prop("size"),environmentExposure:1},elements:hb.indices}),o=[],s=t.framebufferCube({radius:n});ab(t,s,r,{size:n},(function(){const e=t.read();o.push(e)}));const a=t.cube({radius:n,min:"linear mipmap linear",mag:"linear",faces:o});return s.destroy(),r.destroy(),a}(t,e,i),e.destroy()}else a=function(t,e,n,i){n=n||512;const r=t({frag:"#define INPUT_RGBM 1\n"+cb,vert:lb,attributes:{aPosition:hb.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),equirectangularMap:e},elements:hb.indices}),o=t.cube({width:n,height:n,min:"linear",mag:"linear",format:"rgba"}),s=t.framebufferCube({radius:n,color:o});return ab(t,s,r),r.destroy(),s}(t,n,i);const{prefilterMap:h,prefilterMipmap:l}=function(t,e,n,i,r,o){const s=function(t,e,n,i,r,o){const s=yb(r=r||1024,o=o||256),a=t.texture({data:s,width:o,height:r,min:"nearest",mag:"nearest"}),h=t({frag:"#define SHADER_NAME PBR_prefilter\nprecision highp float;\nvarying vec3 vWorldPos;\nuniform samplerCube environmentMap;\nuniform sampler2D distributionMap;\nuniform float roughness;\nuniform float resolution;\nuniform float rgbmRange;\nconst float c = 3.14159265359;\nfloat d(vec3 e, vec3 f, float h) {\n  float a = h * h;\n  float i = a * a;\n  float j = max(dot(e, f), .0);\n  float k = j * j;\n  float l = i;\n  float m = (k * (i - 1.) + 1.);\n  m = c * m * m;\n  return l / m;\n}\nvec3 n(float o, vec3 e, float h) {\n  vec4 u = texture2D(distributionMap, vec2(h, o));\n  vec3 f = u.xyz;\n  float v = sign(u.w - .5);\n  float A = sign(u.w - 200.0 / 255. * clamp(v, .0, 1.) - .15);\n  f.x *= v;\n  f.y *= A;\n  vec3 B = abs(e.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 C = normalize(cross(B, e));\n  vec3 D = cross(e, C);\n  vec3 E = C * f.x + D * f.y + e * f.z;\n  return normalize(E);\n}\nvec4 F(const in vec3 G, const in float I) {\n  if(I <= .0)\n    return vec4(G, 1.);\n  vec4 J;\n  vec3 K = G / I;\n  J.a = clamp(max(max(K.r, K.g), max(K.b, 1e-6)), .0, 1.);\n  J.a = ceil(J.a * 255.) / 255.;\n  J.rgb = K / J.a;\n  return J;\n}\nvec3 L(const in vec4 G, const in float I) {\n  if(I <= .0)\n    return G.rgb;\n  return I * G.rgb * G.a;\n}\nvoid main() {\n  vec3 e = normalize(vWorldPos);\n  vec3 M = e;\n  vec3 O = M;\n  const int P = 1024;\n  vec3 Q = vec3(.0);\n  float S = .0;\n  for(int T = 0; T < P; ++T) {\n    vec3 f = n(float(T) / float(P), e, roughness);\n    vec3 U = normalize(2. * dot(O, f) * f - O);\n    float W = max(dot(e, U), .0);\n    if(W > .0) {\n      Q += L(textureCube(environmentMap, U), rgbmRange).rgb * W;\n      S += W;\n    }\n  }\n  Q = Q / S;\n  gl_FragColor = F(Q, rgbmRange);\n}",vert:lb,attributes:{aPosition:hb.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),environmentMap:e,distributionMap:a,roughness:t.prop("roughness"),resolution:i,rgbmRange:n||7},elements:hb.indices,viewport:{x:0,y:0,width:t.prop("size"),height:t.prop("size")}});let l=i;const c=t.texture({radius:i,min:"linear",mag:"linear"}),u=t.framebuffer({radius:i,color:c}),f=Math.log(l)/Math.log(2),d=[];for(let m=0;m<=f;m++){let e=0;ab(t,u,h,{roughness:m/(f-1),size:l},(function(){const n=t.read({framebuffer:u});d[e]||(d[e]={mipmap:[]}),d[e].mipmap.push(n),e++})),l/=2,u.resize(l)}return a.destroy(),u.destroy(),h.destroy(),d}(t,e,n,i,r,o);return{prefilterMap:t.cube({radius:i,min:"linear mipmap linear",mag:"linear",faces:s}),prefilterMipmap:s}}(t,a,e.rgbmRange,s,r,o);let c;if(!e.ignoreSH){const e=s;c=function(t,e,n){for(var i=new Array(9),r=[],o=[],s=[],a=0;a<9;a++){for(var h=[0,0,0],l=0;l<db.length;l++){for(var c=t[l],u=[0,0,0],f=0,d=0,m=fb[db[l]],g=0;g<n;g++)for(var p=0;p<e;p++){r[0]=p/(e-1)*2-1,r[1]=g/(n-1)*2-1,r[2]=-1,un(r,r),s[0]=r[m[0]]*m[3],s[1]=r[m[1]]*m[4],s[2]=r[m[2]]*m[5],o[0]=c[d++]/255,o[1]=c[d++]/255,o[2]=c[d++]/255;var _=c[d++]/255*7;o[0]*=_,o[1]*=_,o[2]*=_,on(u,u,o,ub(s,a)*-r[2]),f+=-r[2]}on(h,h,u,1/f)}i[a]=rn(h,h,1/6)}return i}(gb(t,h,e),e,e);const n=[];for(let t=0;t<c.length;t++)n.push(...c[t]);c=n}const u={rgbmRange:e.rgbmRange,envMap:a,prefilterMap:h};return c&&(u.sh=c),"array"===e.format&&(u.envMap={width:a.width,height:a.height,faces:gb(t,a,i)},u.prefilterMap={width:h.width,height:h.height,faces:l},a.destroy(),h.destroy()),u},generateDFGLUT:vb});const wb={uvScale:[1,1],uvOffset:[0,0],uvRotation:0,baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,anisotropyDirection:0,anisotropyFactor:0,clearCoatFactor:0,clearCoatIor:1.4,clearCoatRoughnessFactor:.04,clearCoatThickness:5,emitColorFactor:1,occlusionFactor:1,roughnessFactor:.4,metallicFactor:0,normalMapFactor:1,specularF0:.5,emitMultiplicative:1,normalMapFlipY:0,outputSRGB:1,baseColorTexture:null,normalTexture:null,occlusionTexture:null,metallicRoughnessTexture:null,emissiveTexture:null,uvOrigin:[0,0],noiseTexture:null,clearCoatTint:[.006,.006,.006],specularAAVariance:20,specularAAThreshold:20,hsv:[0,0,0],contrast:1,bumpTexture:null,bumpScale:.05,bumpMinLayers:5,bumpMaxLayers:20};class Tb extends Na{constructor(t){const e=Qs({},wb);(t.metallicRoughnessTexture||t.metallicRoughnessTexture)&&(e.roughnessFactor=1,e.metallicFactor=1),super(t,e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.GAMMA_CORRECT_INPUT&&(t.GAMMA_CORRECT_INPUT=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_ALBEDO_MAP=1),n.metallicRoughnessTexture&&(t.HAS_METALLICROUGHNESS_MAP=1),n.occlusionTexture&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),n.bumpTexture&&(t.HAS_BUMP_MAP=1),(t.HAS_ALBEDO_MAP||t.HAS_METALLICROUGHNESS_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP||t.HAS_BUMP_MAP)&&(t.HAS_MAP=1),n.noiseTexture&&(t.HAS_RANDOM_TEX=1),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),t):t}}class Mb extends(Wa(Tb)){}function Ab(t,e,n){if(n.ambientUpdate){const{iblTexes:i}=t;if(i){const r=n.target;Sb(i),t.iblTexes=Cb(e,r)}else t.iblTexes=Cb(e,n.target)}}const Eb=[0,0];function Cb(t,e){const n=e.getLightManager().getAmbientResource();return n?{prefilterMap:t.cube({width:n.prefilterMap.width,height:n.prefilterMap.height,faces:n.prefilterMap.faces,min:"linear mipmap linear",mag:"linear",format:"rgba"}),sh:n.sh,rgbmRange:n.rgbmRange}:null}function Sb(t){for(const e in t)t[e].destroy&&t[e].destroy(),delete t[e]}var Pb=Object.freeze({__proto__:null,loginIBLResOnCanvas:function(t,e,n){if(!t.dfgLUT&&(t.dfgLUT=vb(e),t.dfgLUT.mtkRefCount=0,n)){const i=Ab.bind(this,t,e);n.on("updatelights",i),t._iblResListener=i}t.dfgLUT.mtkRefCount++;const i=n.getLightManager();return i&&i.getAmbientResource()?(t.iblTexes||(t.iblTexes=Cb(e,n)),{dfgLUT:t.dfgLUT,iblTexes:t.iblTexes}):{dfgLUT:t.dfgLUT,iblTexes:null}},getIBLResOnCanvas:function(t){const{dfgLUT:e,iblTexes:n}=t;return{dfgLUT:e,iblTexes:n}},logoutIBLResOnCanvas:function(t,e){let n=!1;t.dfgLUT&&(t.dfgLUT.mtkRefCount--,t.dfgLUT.mtkRefCount<=0)&&(n=!0,e&&e.off("updatelights",t._iblResListener),t.dfgLUT.destroy(),delete t.dfgLUT),t.iblTexes&&n&&(Sb(t.iblTexes),delete t.iblTexes)},getPBRUniforms:function(t,e,n,i,r){const o=t.viewMatrix,s=t.projMatrix,a=t.cameraPosition,h=t.getRenderer().canvas,l=function(t,e){const n=t.getLightManager(),i=n&&n.getAmbientResource(),r=n&&n.getAmbientLight()||{},o=n&&n.getDirectionalLight()||{};let s;if(i){const t=e.prefilterMap.width,n=Math.log(t)/Math.log(2);s={prefilterMap:e.prefilterMap,diffuseSPH:e.sh,prefilterMiplevel:[n,n],prefilterSize:[t,t],hdrHSV:r.hsv||[0,0,0]}}else s={ambientColor:r.color||[.2,.2,.2]};return s.rgbmRange=i?e.rgbmRange:7,s.environmentExposure=ta(r.exposure)?r.exposure:1,s.environmentOrientation=r.orientation||0,s.light0_diffuse=[...o.color||[1,1,1],1],s.light0_viewDirection=o.direction||[1,1,-1],s}(t,e),c=Qs({viewMatrix:o,projMatrix:s,projViewMatrix:t.projViewMatrix,cameraPosition:a,outSize:[h.width,h.height],cameraNearFar:[t.cameraNear,t.cameraFar]},l);return c.brdfLUT=n,i&&i.renderUniforms&&Qs(c,i.renderUniforms),c.halton=r||Eb,c},createIBLTextures:Cb,disposeIBLTextures:Sb,isSupported:function(t){return t.hasExtension("EXT_shader_texture_lod")}});class Rb extends jh{constructor(t){super({vert:"attribute vec3 aPosition;\nuniform mat4 lightProjViewModelMatrix;\nuniform mat4 positionMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vPosition;\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 d = getLineExtrudePosition(aPosition);\n  vec4 e = getPosition(d);\n#else\nvec4 e = getPosition(aPosition);\n#endif\ngl_Position = lightProjViewModelMatrix * c * e;\n  vPosition = gl_Position;\n}",frag:"#define SHADER_NAME vsm_mapping\n#ifdef USE_VSM\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\nvarying vec4 vPosition;\n#ifdef PACK_FLOAT\n#include <common_pack_float>\n#endif\nvoid main() {\n  \n#if defined(USE_VSM)\nfloat c = vPosition.z / vPosition.w;\n  c = c * .5 + .5;\n  float d = c;\n  float e = c * c;\n  float f = dFdx(c);\n  float h = dFdy(c);\n  e += .25 * (f * f + h * h);\n  gl_FragColor = vec4(d, e, c, .0);\n#endif\n#if defined(USE_ESM)\n#ifdef PACK_FLOAT\ngl_FragColor = common_encodeDepth(gl_FragCoord.z);\n#else\ngl_FragColor = vec4(gl_FragCoord.z, .0, .0, 1.);\n#endif\n#endif\n}",uniforms:[{name:"lightProjViewModelMatrix",type:"function",fn:function(t,e){return re([],e.lightProjViewMatrix,e.modelMatrix)}}],extraCommandProps:{},defines:t})}filter(t){return t.castShadow}}class Ob extends Kh{constructor({blurOffset:t}){super({vert:Zh,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\n#include <common_pack_float>\nvoid main() {\n  float c = .0;\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      float f = common_decodeDepth(texture2D(textureSource, e));\n      float s = max(.0, sign(1. - f));\n      d += sign(f) * s;\n      c += f;\n    }\n  float h = c / max(1., d);\n  gl_FragColor = common_encodeDepth(h);\n}",defines:{BOXBLUR_OFFSET:t||2}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_shadow_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}}let Ib,Db;class kb{constructor(t,{width:e,height:n,blurOffset:i,defines:r}){this.renderer=t,this.width=e||512,this.height=n||512,this.blurOffset=qs(i)?2:i,this._init(r)}render(t,{cameraProjViewMatrix:e,lightDir:n,farPlane:i,cameraLookAt:r}){return{lightProjViewMatrix:this._renderShadow(t,e,n,i,r),shadowMap:this.blurTex||this.depthTex,depthFBO:this.depthFBO,blurFBO:this.blurFBO}}resize(t,e){return this.depthTex&&(this.depthTex.resize(t,e),this.depthFBO.resize(t,e)),this.blurFBO&&(this.blurTex.resize(t,e),this.blurFBO.resize(t,e)),this}_renderShadow(t,e,n,i,r){const o=this.renderer,s=Ib(e);if(i)for(let h=4;h<8;h++)s[h]=i[h-4];const a=Db(r,s,n);return o.clear({color:[1,0,0,1],depth:1,framebuffer:this.depthFBO}),o.render(this.shadowMapShader,{lightProjViewMatrix:a},t,this.depthFBO),this.blurFBO&&(this.boxBlurShader||(this.boxBlurShader=new Ob({blurOffset:this.blurOffset})),o.clear({color:[1,0,0,1],depth:1,framebuffer:this.blurFBO}),o.render(this.boxBlurShader,{resolution:[this.depthTex.width,this.depthTex.height],textureSource:this.depthTex},null,this.blurFBO)),a}_init(t){const e=this.renderer.regl,n=this.width,i=this.height;this.depthTex=e.texture({width:n,height:i,format:"rgb",type:"uint8",min:"nearest",mag:"nearest"}),this.shadowMapShader=new Rb(t),this.shadowMapShader.filter=t=>t.castShadow,this.depthFBO=e.framebuffer({color:this.depthTex}),this.blurOffset<=0||(this.blurTex=e.texture({width:n,height:i,format:"rgb",type:"uint8",min:"linear",mag:"linear"}),this.blurFBO=e.framebuffer({color:this.blurTex}))}dispose(){this.depthTex&&(this.depthTex.destroy(),this.depthFBO.destroy(),delete this.depthTex,delete this.depthFBO),this.blurTex&&(this.blurTex.destroy(),this.blurFBO.destroy(),delete this.blurTex,delete this.blurFBO),this.shadowMapShader&&(this.shadowMapShader.dispose(),delete this.shadowMapShader),this.boxBlurShader&&(this.boxBlurShader.dispose(),delete this.boxBlurShader)}}Ib=function(){const t=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],e=new Array(16);return function(n){ee(e,n);const i=[];for(let r=0;r<t.length;r++){const n=ci([],t[r],e);Qn(n,n,1/n[3]),i.push(n)}return i}}(),Db=function(){let t=new Array(4);const e=new Array(3),n=[0,0,0,0],i=[0,1,0],r=new Array(3);let o=new Array(16),s=new Array(16),a=new Array(16);const h=[1,1,1],l=[0,0,0];return function(c,u,f){Gn(n,...c,1),rn(e,f,-1),o=Pe(o,qe(r,n,un(r,e)),n,i),ci(t,u[0],o);let d=t[2],m=t[2],g=t[0],p=t[0],_=t[1],v=t[1];for(let e=1;e<8;e++)t=ci(t,u[e],o),t[2]>m&&(m=t[2]),t[2]<d&&(d=t[2]),t[0]>p&&(p=t[0]),t[0]<g&&(g=t[0]),t[1]>v&&(v=t[1]),t[1]<_&&(_=t[1]);s=Se(s,-1,1,-1,1,-m,-d);const y=h[0]=2/(p-g),x=h[1]=-2/(v-_);l[0]=-.5*(g+p)*y,l[1]=-.5*(_+v)*x,$t(a),oe(a,a,l),se(a,a,h);const b=re(s,a,s);return re(new Array(16),b,o)}}();class Lb extends jh{constructor(t){super({vert:"#define SHADER_NAME SHADOW_DISPLAY\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelViewMatrix;\nuniform vec2 halton;\nuniform vec2 globalTexSize;\nvarying vec4 vPosition;\n#include <vsm_shadow_vert>\nvoid main() {\n  vec4 c = vec4(aPosition, 1.);\n  vec4 d = modelViewMatrix * c;\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / globalTexSize.xy;\n  gl_Position = e * d;\n  vPosition = gl_Position;\n  shadow_computeShadowPars(c);\n}",frag:"#define SHADER_NAME SHADOW_DISPLAY\nprecision mediump float;\nuniform vec3 color;\n#include <vsm_shadow_frag>\nvoid main() {\n  float c = shadow_computeShadow();\n  float d = 1. - c;\n  gl_FragColor = vec4(color * d, d);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){const n=[];return re(n,e.viewMatrix,e.modelMatrix),n}}],defines:t||{USE_ESM:1},extraCommandProps:{depth:{enable:!0,mask:!1},viewport:{x:0,y:0,width:(t,e)=>e.globalTexSize[0],height:(t,e)=>e.globalTexSize[1]}}})}getMeshCommand(t,e){return this.commands.shadow_display||(this.commands.shadow_display=this.createREGLCommand(t,null,e.getElements())),this.commands.shadow_display}}function Fb(t){return 256*t[2]*256+256*t[1]+t[0]}const Nb=new Uint8Array(4),Bb=new Float32Array(Nb.buffer);let Hb,jb;const zb="\n    vec3 unpack(highp float f) {\n        highp vec3 color;\n        color.b = floor(f / 65536.0);\n        color.g = floor((f - color.b * 65536.0) / 256.0);\n        color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);\n        // now we have a vec3 with the 3 components in range [0..255]. Let's normalize it!\n        return color / 255.0;\n    }\n",Gb=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    uniform float fbo_picking_meshId;\n\n    ${zb}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), fbo_picking_meshId / 255.0);\n    }\n`,Ub=`\n    precision highp float;\n\n    uniform int fbo_picking_meshId;\n    varying float vFbo_picking_visible;\n\n    ${zb}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(float(fbo_picking_meshId)), 1.0);\n        // gl_FragColor = vec4(unpack(float(35)), 1.0);\n    }\n`,Vb=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    ${zb}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), 1.0);\n    }\n`;class Wb{constructor(t,{vert:e,uniforms:n,defines:i,extraCommandProps:r},o,s){this._renderer=t,this._fbo=o,this._map=s,this._clearFbo(o),this._vert=e,this._uniforms=n,this._defines=i,this._extraCommandProps=Qs({},r),delete this._extraCommandProps.blend,delete this._extraCommandProps.stencil,this._currentMeshes=[],this._init()}_init(){const t=[];this._uniforms&&t.push(...this._uniforms);const e={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const o in this._defines)e[o]=this._defines[o];const n=this._vert,i=this._extraCommandProps;this._shader0=new jh({vert:n,frag:Gb,uniforms:t,defines:e,extraCommandProps:i}),this._shader2=new jh({vert:n,frag:Vb,uniforms:t,defines:e,extraCommandProps:i});const r={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const o in this._defines)r[o]=this._defines[o];this._shader1=new jh({vert:n,frag:Ub,uniforms:t,defines:r,extraCommandProps:i}),this._depthShader=new jh({vert:n,frag:"\n    #ifdef GL_ES\n        precision highp float;\n    #endif\n    #if __VERSION__ == 100\n        #extension GL_EXT_frag_depth : enable\n    #endif\n    #include <gl2_frag>\n    #include <common_pack_float>\n    varying float vFbo_picking_viewZ;\n    uniform float logDepthBufFC;\n    varying float vFbo_picking_fragDepth;\n\n    const float PackUpscale = 256. / 255.;\n    const float UnpackDownscale = 255. / 256.;\n    const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n    const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n    const float ShiftRight8 = 1. / 256.;\n    vec4 packDepthToRGBA(const in float v ) {\n        vec4 r = vec4(fract(v * PackFactors), v);\n        r.yzw -= r.xyz * ShiftRight8;\n        return r * PackUpscale;\n    }\n\n    void main() {\n        float fragDepth = vFbo_picking_fragDepth > 1.0 ? vFbo_picking_fragDepth : vFbo_picking_viewZ + 1.0;\n        #if __VERSION__ == 300\n            gl_FragDepthEXT = log2(fragDepth) * logDepthBufFC * 0.5;\n        #endif\n        vec4 depthColor = packDepthToRGBA(fragDepth - 1.0);\n        glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));\n        #if __VERSION__ == 100\n            gl_FragColor = glFragColor;\n        #endif\n    }\n",uniforms:t,defines:r,extraCommandProps:i}),this._depthShader.version=300,this._scene=new nh,this._scene1=new nh}filter(){return!0}render(t,e,n=!1){if(!t||!t.length)return this;const i=this._fbo;n&&this.clear(),t=t.filter((t=>t&&t.isValid())),this._scene.setMeshes(t);const r=this._getShader(t,n);r.filter=this.filter,this._currentShader&&r!==this._currentShader&&this.clear(),this._currentShader=r,t.forEach(((t,e)=>{t.setUniform("fbo_picking_meshId",e+this._currentMeshes.length)}));for(let o=0;o<t.length;o++)this._currentMeshes.push(t[o]);return this._renderer.render(r,e,this._scene,i),this}pick(t,e,n,i,r={}){const o=this._currentShader,s=this._currentMeshes;if(!o||!s||!s.length)return{pickingId:null,meshId:null,point:null};t=Math.round(t),e=Math.round(e);const a=this._fbo;if(t<=2||t>=a.width-2||e<=2||e>=a.height-2)return{pickingId:null,meshId:null,point:null};const{px:h,py:l,width:c,height:u}=this._getParams(t,e,n,a),f=new Uint8Array(4*c*u),d=this._renderer.regl.read({data:f,x:h,y:l,framebuffer:a,width:c,height:u}),m=[];let g=[];for(let T=0;T<d.length;T+=4){const{pickingId:t,meshId:e}=this._packData(d.subarray(T,T+4),o);m.push(e),g.push(t)}const p={},_=m.filter((t=>null!=t&&!p[t]&&(p[t]=1,!0))).map((t=>s[t]));let v;for(let T=0;T<_.length;T++)if(_[T]&&_[T].geometry){v=_[T];break}if(!v)return{pickingId:null,meshId:null,point:null};const y=v.geometry.desc.pickingIdAttribute;m.length&&o===this._shader1&&(void 0!==v.getUniform("uPickingId")||v.geometry.data[y])&&(g=this._getPickingId(h,l,c,u,f,_,i));const x=[],b=[];if(m.length&&r.returnPoint){const{viewMatrix:n,projMatrix:o}=r,s=this._pickDepth(h,l,c,u,f,_,i);for(let i=0;i<s.length;i++)if(s[i]&&null!=m[i]&&null!=g[i]){const r=this._getWorldPos(t,e,s[i],n,o),a=this._convertPickPoint(r);x.push(r),b.push(a)}else x.push(null)}const w=[];for(let T=0;T<=n;T++)w.push(T),T>0&&w.push(-T);for(let T=0;T<w.length;T++)for(let t=0;t<w.length;t++){const e=(w[t]+n)*c+(w[T]+n);if(null!=m[e]&&null!=g[e])return{meshId:m[e],pickingId:g[e],point:x[e]||null,coordinate:b[e]||null}}return{pickingId:null,meshId:null,point:null}}_convertPickPoint(t){const e=this._map;if(!e)return null;const n=e.getGLRes();if(!Hb){const t=e.getCenter();jb=new t.constructor(0,0,0);const n=e.coordToPoint(t);Hb=new n.constructor(0,0)}Hb.set(t[0],t[1]);const i=e.pointAtResToCoord(Hb,n,jb),r=e.pointAtResToAltitude(t[2],n);return[i.x,i.y,r]}clear(){return this._fbo&&this._clearFbo(this._fbo),this._currentMeshes=[],delete this._currentShader,this}getMeshAt(t){return this._currentMeshes?this._currentMeshes[t]:null}getRenderedMeshes(){return this._currentMeshes}dispose(){this.clear(),this._shader0&&this._shader0.dispose(),this._shader1&&this._shader1.dispose(),this._shader2&&this._shader2.dispose(),this._scene&&this._scene.clear(),this._scene1&&this._scene1.clear()}_getWorldPos(t,e,n,i,r){const o=this._fbo,s=[],a=o.width/2||1,h=o.height/2||1,l=[(t-a)/a,(h-e)/h,0,1],c=[(t-a)/a,(h-e)/h,1,1],u=ee(s,r),f=[],d=[];Xb(f,l,u),Xb(d,c,u);const m=-f[2],g=(n-m)/(-d[2]-m),p=ee(s,re(s,r,i)),_=Xb(l,l,p),v=Xb(c,c,p);return[ea(_[0],v[0],g),ea(_[1],v[1],g),ea(_[2],v[2],g)]}_getPickingId(t,e,n,i,r,o,s){const a=this._renderer.regl,h=this._getFBO1();this._clearFbo(h),this._scene1.setMeshes(o),this._renderer.render(this._shader2,s,this._scene1,h);const l=a.read({data:r,x:t,y:e,framebuffer:h,width:n,height:i}),c=[];for(let u=0;u<l.length;u+=4)c.push(Fb(l.subarray(u,u+4)));return c}_pickDepth(t,e,n,i,r,o,s){const a=this._renderer.regl,h=this._getFBO1();this._scene1.setMeshes(o),this._clearFbo(h),s.logDepthBufFC=2/(Math.log(this._map.cameraFar+1)/Math.LN2),this._renderer.render(this._depthShader,s,this._scene1,h);const l=a.read({data:r,x:t,y:e,framebuffer:h,width:n,height:i}),c=[];for(let f=0;f<l.length;f+=4)c.push((u=l.subarray(f,f+4),Nb[0]=u[3],Nb[1]=u[2],Nb[2]=u[1],Nb[3]=u[0],Bb[0]));var u;return c}_packData(t,e){if(255===t[0]&&255===t[1]&&255===t[2]&&255===t[3])return{meshId:null,pickingId:null};let n=null,i=null;return e===this._shader1?i=Fb(t):e===this._shader0?(i=t[3],n=Fb(t)):(i=null,n=Fb(t)),{meshId:i,pickingId:n}}_clearFbo(t){this._renderer.regl.clear({color:[1,1,1,1],depth:1,stencil:0,framebuffer:t})}_getShader(t,e){return e&&t.length<256?this._shader0:this._shader1}_getFBO1(){const t=this._renderer.regl,e=this._fbo;return this._fbo1?this._fbo1.width===e.width&&this._fbo1.height===e.height||this._fbo1.resize(e.width,e.height):this._fbo1=t.framebuffer(e.width,e.height),this._fbo1}_getParams(t,e,n,i){e=i.height-e;let r=2*n+1,o=2*n+1;const s=(t-=n)+r,a=(e-=n)+o;return s>i.width&&(r-=s-i.width),a>i.height&&(o-=a-i.height),{px:t=t<0?0:t,py:e=e<0?0:e,width:r,height:o}}getPickingVert(){return this._vert}getUniformDeclares(){return this._uniforms}}function Xb(t,e,n){const i=e[0],r=e[1],o=e[2],s=1/(n[3]*i+n[7]*r+n[11]*o+n[15]);return t[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])*s,t[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])*s,t[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])*s,t}const Zb=t=>t&&t.geometry&&void 0===t.geometry.properties.shaderHash,qb=[],Yb=[],Kb=[{name:"modelViewMatrix",type:"function",fn:(t,e)=>re(qb,e.viewMatrix,e.modelMatrix)},{name:"modelViewProjMatrix",type:"function",fn:(t,e)=>{const n=re(qb,e.viewMatrix,e.modelMatrix);return re(qb,e.projMatrix,n)}},{name:"modelMatrixInverse",type:"function",fn:(t,e)=>ee(qb,e.modelMatrix)},{name:"projMatrixInverse",type:"function",fn:(t,e)=>ee(qb,e.projMatrix)},{name:"modelViewMatrixInverse",type:"function",fn:(t,e)=>(re(qb,e.viewMatrix,e.modelMatrix),ee(qb,qb))},{name:"modelViewProjMatrixInverse",type:"function",fn:(t,e)=>{const n=re(qb,e.viewMatrix,e.modelMatrix);return re(qb,e.projMatrix,n),ee(qb,qb)}},{name:"modelInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=pt(Yb,e.modelMatrix),i=wt(n,n);return Tt(i,i)}},{name:"modelViewInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=re(qb,e.viewMatrix,e.modelMatrix),i=pt(Yb,n),r=wt(i,i);return Tt(r,r)}}],Jb={LOCAL:"positionMatrix",MODEL:"modelMatrix",VIEW:"viewMatrix",PROJECTION:"projMatrix",MODELVIEW:"modelViewMatrix",MODELVIEWPROJECTION:"modelViewProjMatrix",MODELINVERSE:"modelMatrixInverse",VIEWINVERSE:"viewMatrixInverse",PROJECTIONINVERSE:"projMatrixInverse",MODELVIEWINVERSE:"modelViewMatrixInverse",MODELVIEWPROJECTIONINVERSE:"modelViewProjMatrixInverse",MODELINVERSETRANSPOSE:"modelInverseTransposeMatrix",MODELVIEWINVERSETRANSPOSE:"modelViewInverseTransposeMatrix",VIEWPORT:"viewport",JOINTMATRIX:"jointMatrix",ALPHACUTOFF:"alphaCutoff"};class Qb{constructor(t,e,n){this._regl=t,this._khrShaders={},this._commandProps=e,this._resLoader=n}getExcludeFilter(){return Zb}forEachShader(t){for(const e in this._khrShaders){const n=this._khrShaders[e];t(n.shader,n.filter,n.uniformSemantics)}}createMesh(t,e,n,i){const r=e.extensions.KHR_techniques_webgl,o=e.materials[t.material].extensions.KHR_techniques_webgl,{technique:s,values:a}=o,h=r.techniques[s],l=r.programs[h.program],c=r.shaders[l.vertexShader],u=r.shaders[l.fragmentShader];u.content=function(t){return t&&t.indexOf("precision")<0?"precision mediump float;\n"+t:t}(u.content);const f=da(c.content)+"-"+da(u.content);this._khrShaders[f]||(this._khrShaders[f]=this._createTechniqueShader(f,r,s,this._commandProps,i));const{attributeSemantics:d}=this._khrShaders[f],m=this._createGeometry(t,d,n,f),g=Qs({},a);for(const p in a)h.uniforms[p]&&35678===h.uniforms[p].type&&(g[p]=this._getTexture(e.textures[a[p].index]));return{geometry:m,material:new Na(g)}}_createGeometry(t,e,n,i){const r=t.attributes;if(r.COLOR_0){const t=r.COLOR_0.array||r.COLOR_0;if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);r.COLOR_0.array?(r.COLOR_0.array=e,r.COLOR_0.componentType=5121):r.COLOR_0=e}}const o={};for(const h in r){const t=Th(this._regl,r[h],{dimension:r[h].itemSize}),n=e[h]||h;o[n]={buffer:t},r[h].quantization&&(o[n].quantization=r[h].quantization),n===e.POSITION&&(o[n].array=r[h].array)}const s=new La(o,t.indices.array?t.indices.array:t.indices,0,{positionAttribute:e.POSITION,normalAttribute:e.NORMAL,uv0Attribute:e.TEXCOORD_0,uv1Attribute:e.TEXCOORD_1,color0Attribute:e.COLOR_0,tangentAttribute:e.TANGENT,primitive:void 0===t.mode?"triangles":ch(t.mode)});s.generateBuffers(this._regl,{excludeElementsInVAO:n}),s.properties.shaderHash=i;const a=s.data[s.desc.positionAttribute];return a&&a.array&&delete a.array,s}_getTexture(t){const e={type:t.type?fh(t.type):"uint8",format:t.format?mh(t.format):"rgba",flipY:!!t.flipY},n=t.image;n.array?e.data=n.array:n.mipmap&&(e.mipmap=n.mipmap),e.width=n.width,e.height=n.height;const i=t.sampler||t.texture.sampler;return i&&(i.magFilter&&(e.mag=ph(i.magFilter)),i.minFilter&&(e.min=vh(i.minFilter)),i.wrapS&&(e.wrapS=xh(i.wrapS)),i.wrapT&&(e.wrapT=xh(i.wrapT))),new Eh(e,this._resLoader)}_createTechniqueShader(t,e,n,i,r){const{techniques:o,programs:s,shaders:a}=e,h=o[n],l=s[h.program],c=a[l.vertexShader].content,u=a[l.fragmentShader].content,f={};for(const p in h.uniforms){const t=h.uniforms[p];t.semantic&&(f[t.semantic]=p)}const d=Kb.slice();for(const p in f)d.push({name:f[p],type:"function",fn:(t,e)=>e[Jb[p]]});const m=new jh({vert:c,frag:u,uniforms:d,extraCommandProps:i});r&&(m.version=300);const g={};for(const p in h.attributes)g[h.attributes[p].semantic]=p;return{shader:m,filter:e=>e&&e.geometry&&e.geometry.properties.shaderHash===t,uniformSemantics:f,attributeSemantics:g}}dispose(){for(const t in this._khrShaders){const{shader:e}=this._khrShaders[t];e.dispose()}this._khrShaders={}}}const $b={parseHDR:hh},tw={PBRHelper:bb,StandardMaterial:Tb,StandardSpecularGlossinessMaterial:Mb,StandardShader:class extends jh{constructor(t={}){let e=t.extraCommandProps||{};const n=t.uniforms;e=Qs({},e);const i=t.defines||{},r=[],o=[],s=[],a=[],h=[],l=[{name:"modelNormalMatrix",type:"function",fn:(t,e)=>pt(r,e.modelMatrix)},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=re(o,e.viewMatrix,e.modelMatrix),i=ee(n,n),r=te(i,i);return pt(s,r)}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>re(a,e.viewMatrix,e.modelMatrix)},{name:"uEnvironmentTransform",type:"function",fn:(t,e)=>Ot(h,Math.PI*(e.environmentOrientation||0)/180)}];n&&l.push(...n),super({vert:t.vert||"#include <gl2_vert>\n#define SHADER_NAME PBR\nprecision highp float;\nattribute vec3 aPosition;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nuniform float uvRotation;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#endif\nvec3 c;\nvec3 d;\nvec4 e;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform vec2 outSize;\nuniform vec2 halton;\nuniform mediump vec3 cameraPosition;\nuniform mat3 modelNormalMatrix;\n#ifdef HAS_SSR\nuniform mat3 modelViewNormalMatrix;\nvarying vec3 vViewNormal;\n#ifdef HAS_TANGENT\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\nvarying vec3 vModelVertex;\n#if defined(HAS_MAP)\nvarying vec2 vTexCoord;\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#include <highlight_vert>\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\nvarying vec3 vColor0;\n#else\nattribute vec4 aColor0;\nvarying vec4 vColor0;\n#endif\n#endif\n#include <line_extrusion_vert>\n#include <get_output>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <heatmap_render_vert>\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#if __VERSION__ == 100\nmat3 f(in mat3 h) {\n  vec3 i = h[0];\n  vec3 j = h[1];\n  vec3 k = h[2];\n  return mat3(vec3(i.x, j.x, k.x), vec3(i.y, j.y, k.y), vec3(i.z, j.z, k.z));\n}\n#else\nmat3 f(in mat3 h) {\n  return transpose(h);\n}\n#endif\n#endif\nvoid l(const highp vec4 q, out highp vec3 m) {\n  m = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid l(const highp vec4 q, out highp vec3 m, out highp vec3 t) {\n  l(q, m);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nconst float o = .5;\nvec2 u(vec2 v, float A) {\n  return vec2(cos(A) * (v.x - o) + sin(A) * (v.y - o) + o, cos(A) * (v.y - o) - sin(A) * (v.x - o) + o);\n}\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\nvoid main() {\n  mat4 B = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 C = getLineExtrudePosition(aPosition);\n  vec4 D = getPosition(C);\n#else\nvec4 D = getPosition(aPosition);\n#endif\nvModelVertex = (modelMatrix * D).xyz;\n  vec4 E = B * D;\n  vec4 F = modelViewMatrix * E;\n  vViewVertex = F;\n  mat4 G = projMatrix;\n  G[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = G * getMaskPosition(E, modelMatrix);\n#else\ngl_Position = G * F;\n#endif\n#ifdef PICKING_MODE\nfloat H = 1.;\n#if defined(HAS_COLOR)\nH *= aColor.a;\n#endif\n#if defined(HAS_COLOR0)\nH *= aColor0.a;\n#endif\nfbo_picking_setData(gl_Position.w, H != .0);\n#else\n#if defined(HAS_MAP)\nvec2 I = getTexcoord(aTexCoord);\n#ifdef HAS_RANDOM_TEX\nvec2 J = uvOrigin;\n  vec2 K = I * uvScale + uvOffset;\n  if(uvRotation != .0) {\n    J = u(J, uvRotation);\n    K = u(K, uvRotation);\n  }\n  vTexCoord = mod(J, 1.) + K;\n#else\nvec2 J = uvOrigin;\n  vec2 K = I * uvScale;\n  if(uvRotation != .0) {\n    J = u(J, uvRotation);\n    K = u(K, uvRotation);\n  }\n  vTexCoord = mod(J, 1.) + K + uvOffset;\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\n#endif\n#if defined(HAS_TANGENT) || defined(HAS_NORMAL)\nmat3 L = mat3(B);\n  mat3 M = modelNormalMatrix * L;\n#if defined(HAS_TANGENT)\nvec3 t;\n  l(aTangent, d, t);\n  vModelTangent = vec4(M * t, aTangent.w);\n#else\n#ifdef HAS_DECODE_NORMAL\nd = getNormal(aNormal);\n#else\nd = aNormal;\n#endif\n#endif\nvec3 N = d;\n  vModelNormal = M * N;\n#else\nd = vec3(.0);\n  vModelNormal = vec3(.0);\n#endif\n#if defined(HAS_TANGENT)\nvModelBiTangent = cross(vModelNormal, vModelTangent.xyz) * sign(aTangent.w);\n#endif\n#ifdef HAS_SSR\nmat3 O = modelViewNormalMatrix * L;\n  vViewNormal = O * d;\n#if defined(HAS_TANGENT)\nvec4 P = vec4(t, aTangent.w);\n  vViewTangent = vec4(O * P.xyz, P.w);\n#endif\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\nhighlight_setVarying();\n#if defined(HAS_COLOR0)\nvColor0 = aColor0 / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(E);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * B, D);\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nmat3 Q = f(mat3(vModelTangent.xyz, vModelBiTangent, vModelNormal));\n  vTangentViewPos = Q * cameraPosition;\n  vTangentFragPos = Q * vModelVertex;\n#endif\n#endif\n}",frag:t.frag||"#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nuniform float contrast;\nconst float c = .04;\nstruct MaterialUniforms {\n  vec2 roughnessMetalness;\n  vec3 albedo;\n  float alpha;\n  vec3 normal;\n  vec3 emit;\n  float ao;\n  vec3 specularColor;\n  float glossiness;\n} d;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform vec3 cameraPosition;\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\nuniform float glossinessFactor;\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\nuniform vec3 emissiveFactor;\nuniform vec4 baseColorFactor;\nuniform float baseColorIntensity;\nuniform float anisotropyDirection;\nuniform float anisotropyFactor;\nuniform float clearCoatFactor;\nuniform float clearCoatIor;\nuniform float clearCoatRoughnessFactor;\nuniform float clearCoatThickness;\nuniform float emitColorFactor;\nuniform float occlusionFactor;\nuniform float environmentExposure;\nuniform float roughnessFactor;\nuniform float metallicFactor;\nuniform float normalMapFactor;\nuniform float rgbmRange;\nuniform float specularF0;\nuniform int emitMultiplicative;\nuniform int normalMapFlipY;\nuniform int outputSRGB;\nuniform mat3 uEnvironmentTransform;\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#if defined(HAS_EMISSIVE_MAP)\nuniform sampler2D emissiveTexture;\n#endif\n#if defined(HAS_AO_MAP)\nuniform sampler2D occlusionTexture;\n#endif\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nuniform sampler2D normalTexture;\n#endif\n#if defined(HAS_ALPHAMODE)\nuniform float alphaCutoff;\n#endif\n#ifdef HAS_RANDOM_TEX\nuniform highp vec2 uvOrigin;\nuniform highp float uvRotation;\nuniform sampler2D noiseTexture;\n#endif\nuniform sampler2D brdfLUT;\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\nuniform vec2 cameraNearFar;\nuniform vec3 clearCoatTint;\nuniform vec3 light0_viewDirection;\nuniform vec4 light0_diffuse;\n#ifdef HAS_SSR\nvarying vec3 vViewNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelVertex;\nvarying vec4 vViewVertex;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vModelNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvarying vec3 vColor0;\n#else\nvarying vec4 vColor0;\n#endif\n#endif\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\nuniform float currentTime;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatternGapColor;\nuniform vec2 uvScale;\nvarying float vPatternHeight;\nvarying float vLinesofar;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvec2 e(vec2 f) {\n  vec2 h = mod(f, 1.);\n  vec2 i = vTexInfo.xy;\n  vec2 j = vTexInfo.zw;\n  return (i + h * j) / atlasSize;\n}\n#endif\n#include <heatmap_render_frag>\n#include <snow_frag>\n#include <mask_frag>\n#ifdef HAS_RANDOM_TEX\nconst float k = .5;\nvec2 l(vec2 h, float m) {\n  return vec2(cos(m) * (h.x - k) + sin(m) * (h.y - k) + k, cos(m) * (h.y - k) - sin(m) * (h.x - k) + k);\n}\nfloat n(vec3 o) {\n  return o.x + o.y + o.z;\n}\n#endif\nvec4 u(sampler2D A, in vec2 h) {\n  \n#ifdef HAS_RANDOM_TEX\nhighp vec2 B = uvOrigin;\n  if(uvRotation != .0) {\n    B = l(B, uvRotation);\n  }\n  highp vec2 C = h + B - mod(B, 1.);\n  float D = texture2D(noiseTexture, .005 * C).x;\n  vec2 E = dFdx(C);\n  vec2 F = dFdx(C);\n  float G = D * 8.;\n  float H = fract(G);\n#if 1\nfloat I = floor(G);\n  float J = I + 1.;\n#else\nfloat I = floor(G + .5);\n  float J = floor(G);\n  H = min(H, 1. - H) * 2.;\n#endif\nvec2 K = sin(vec2(3., 7.) * I);\n  vec2 L = sin(vec2(3., 7.) * J);\n  float M = .5;\n  vec4 N = texture2DGradEXT(A, h + M * K, E, F);\n  vec4 O = texture2DGradEXT(A, h + M * L, E, F);\n  return mix(N, O, smoothstep(.2, .8, H - .1 * n(N.xyz - O.xyz)));\n#else\nreturn texture2D(A, h);\n#endif\n}\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nuniform sampler2D bumpTexture;\nuniform float bumpScale;\nuniform float bumpMaxLayers;\nuniform float bumpMinLayers;\nvec2 P(vec2 h, vec3 Q) {\n  float R = mix(bumpMaxLayers, bumpMinLayers, abs(dot(vec3(.0, .0, 1.), Q)));\n  float S = 1. / R;\n  float T = .0;\n  vec2 U = Q.xy * bumpScale / (Q.z * R);\n  vec2 V = h;\n  float W = u(bumpTexture, V).r;\n  for(int X = 0; X < 30; X++) {\n    T += S;\n    V -= U;\n    W = u(bumpTexture, V).r;\n    if(W < T) {\n      break;\n    }\n  }\n  vec2 Y = V + U;\n  float Z = W - T;\n  float ba = u(bumpTexture, Y).r - T + S;\n  return mix(V, Y, Z / (Z - ba));\n}\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#endif\n#define SHADER_NAME PBR\nvec3 bb(const in vec3 bc) {\n  return vec3(bc.r < .0031308 ? bc.r * 12.92 : 1.055 * pow(bc.r, 1. / 2.4) - .055, bc.g < .0031308 ? bc.g * 12.92 : 1.055 * pow(bc.g, 1. / 2.4) - .055, bc.b < .0031308 ? bc.b * 12.92 : 1.055 * pow(bc.b, 1. / 2.4) - .055);\n}\nvec3 bd(const in vec3 bc) {\n  return vec3(bc.r < .04045 ? bc.r * (1. / 12.92) : pow((bc.r + .055) * (1. / 1.055), 2.4), bc.g < .04045 ? bc.g * (1. / 12.92) : pow((bc.g + .055) * (1. / 1.055), 2.4), bc.b < .04045 ? bc.b * (1. / 12.92) : pow((bc.b + .055) * (1. / 1.055), 2.4));\n}\nvec3 be(const in vec4 bc, const in float bf) {\n  if(bf <= .0)\n    return bc.rgb;\n  return bf * bc.rgb * bc.a;\n}\nvec3 bg() {\n  return d.albedo;\n}\nfloat bh() {\n  \n#if defined(HAS_ALPHAMODE)\nif(d.alpha >= alphaCutoff) {\n    return 1.;\n  } else {\n    return .0;\n  }\n#else\nreturn d.alpha;\n#endif\n}\nfloat bi() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 bc = d.specularColor;\n  return max(max(bc.r, bc.g), bc.b);\n#else\nreturn d.roughnessMetalness.y;\n#endif\n}\nfloat bj() {\n  return specularF0;\n}\nfloat bk() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn 1. - d.glossiness;\n#else\nreturn d.roughnessMetalness.x;\n#endif\n}\nvec3 bl() {\n  return d.emit;\n}\nvec3 bm() {\n  return d.normal;\n}\nfloat bn() {\n  return clearCoatFactor;\n}\nfloat bo() {\n  return clearCoatRoughnessFactor;\n}\nfloat bp() {\n  return d.ao;\n}\nfloat bq(const in vec4 br) {\n  return br.r + br.g / 255.;\n}\nfloat bs(const in vec2 bt, const in float bu) {\n  vec3 bv = vec3(.06711056, .00583715, 52.9829189);\n  return fract(bv.z * fract(dot(bt.xy + bu * vec2(47., 17.) * .695, bv.xy))) * .5;\n}\nvec3 bw(const in float bx, in vec3 by, const in vec3 t, const in vec3 b, in vec3 bz) {\n  by.xy = bx * by.xy;\n  mat3 bA = mat3(t, b, bz);\n  return normalize(bA * by);\n}\nvoid bB(const in vec3 bC, const in vec3 by, const in vec3 bD, out float bE, out vec3 bF, out float bG) {\n  bE = 1.;\n  bF = -bD;\n  bG = dot(bF, by);\n}\nvec4 bH(const in vec3 by, const in vec3 bC, const in float bI) {\n  float bJ = clamp(dot(by, bC), 0., 1.);\n  float bK = bI * bI;\n  return vec4(bK, bK * bK, bJ, bJ * (1. - bK));\n}\nfloat bL(const vec4 bH, const float bM) {\n  float bN = bH.y;\n  float bO = (bM * bN - bM) * bM + 1.;\n  return bN / (3.141593 * bO * bO);\n}\nvec3 bP(const vec3 bQ, const float bR, const in float bS) {\n  float bT = pow(1. - bS, 5.);\n  return bR * bT + (1. - bT) * bQ;\n}\nfloat bP(const float bQ, const float bR, const in float bS) {\n  return bQ + (bR - bQ) * pow(1. - bS, 5.);\n}\nfloat bU(const vec4 bH, const float bV) {\n  float a = bH.x;\n  float bW = bV * (bH.w + a);\n  float bX = bH.z * (bV * (1. - a) + a);\n  return .5 / (bW + bX);\n}\nvec3 bY(const vec4 bH, const vec3 by, const vec3 bC, const vec3 bF, const vec3 bZ, const float bV, const float bR) {\n  vec3 ca = normalize(bC + bF);\n  float bM = clamp(dot(by, ca), 0., 1.);\n  float bS = clamp(dot(bF, ca), 0., 1.);\n  float cb = bL(bH, bM);\n  float cc = bU(bH, bV);\n  vec3 cd = bP(bZ, bR, bS);\n  return (cb * cc * 3.141593) * cd;\n}\nvoid ce(const in vec3 by, const in vec3 bC, const in float bV, const in vec4 bH, const in vec3 cf, const in vec3 bZ, const in float bE, const in vec3 cg, const in vec3 bF, const in float bR, out vec3 ch, out vec3 ci, out bool cj) {\n  cj = bV > .0;\n  if(cj == false) {\n    ci = ch = vec3(.0);\n    return;\n  }\n  vec3 ck = bE * bV * cg;\n  ci = ck * bY(bH, by, bC, bF, bZ, bV, bR);\n  ch = ck * cf;\n}\nfloat cl(float at, float ab, float cm, float cn, float co, float cp, float bJ, float bV) {\n  float cq = bV * length(vec3(at * cm, ab * cn, bJ));\n  float cr = bJ * length(vec3(at * co, ab * cp, bV));\n  return .5 / (cq + cr);\n}\nfloat cs(const float at, const float ab, const float ct, const float cu, const float bM) {\n  float bN = at * ab;\n  vec3 bO = vec3(ab * ct, at * cu, bN * bM);\n  float x = bN / dot(bO, bO);\n  return bN * (x * x) / 3.141593;\n}\nvec3 cv(const vec4 bH, const vec3 by, const vec3 bC, const vec3 bF, const vec3 bZ, const float bV, const float bR, const in vec3 cw, const in vec3 cx, const in float cy) {\n  vec3 ca = normalize(bC + bF);\n  float bM = clamp(dot(by, ca), 0., 1.);\n  float bJ = clamp(dot(by, bC), 0., 1.);\n  float bS = clamp(dot(bF, ca), 0., 1.);\n  float cm = dot(cw, bC);\n  float cn = dot(cx, bC);\n  float co = dot(cw, bF);\n  float cp = dot(cx, bF);\n  float ct = dot(cw, ca);\n  float cu = dot(cx, ca);\n  float cz = sqrt(1. - abs(cy) * .9);\n  if(cy > .0)\n    cz = 1. / cz;\n  float at = bH.x * cz;\n  float ab = bH.x / cz;\n  float cb = cs(at, ab, ct, cu, bM);\n  float cc = cl(at, ab, cm, cn, co, cp, bJ, bV);\n  vec3 cd = bP(bZ, bR, bS);\n  return (cb * cc * 3.141593) * cd;\n}\nvoid cA(const in vec3 by, const in vec3 bC, const in float bV, const in vec4 bH, const in vec3 cf, const in vec3 bZ, const in float bE, const in vec3 cg, const in vec3 bF, const in float bR, const in vec3 cw, const in vec3 cx, const in float cy, out vec3 ch, out vec3 ci, out bool cj) {\n  cj = bV > .0;\n  if(cj == false) {\n    ci = ch = vec3(.0);\n    return;\n  }\n  vec3 ck = bE * bV * cg;\n  ci = ck * cv(bH, by, bC, bF, bZ, bV, bR, cw, cx, cy);\n  ch = ck * cf;\n}\n#if defined(HAS_IBL_LIGHTING)\nvec3 cB(const in vec3 by) {\n  vec3 bz = uEnvironmentTransform * by;\n  float x = bz.x;\n  float y = bz.y;\n  float z = bz.z;\n  vec3 cC = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    cC = hsv_apply(cC, hdrHSV);\n  }\n  return max(cC, vec3(.0));\n}\nfloat cD(const in float cE) {\n  return cE;\n}\nvec3 cF(const in float cG, const in vec3 cH) {\n  vec3 cI = cH;\n  float cJ = prefilterMiplevel.x;\n  float cK = min(cJ, cD(cG) * prefilterMiplevel.y);\n  vec3 cL = be(textureCubeLod(prefilterMap, cI, cK), rgbmRange);\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(cL, hdrHSV);\n  } else {\n    return cL;\n  }\n}\nvec3 cM(const in vec3 cN, const in vec3 cH, const in float cO) {\n  float cP = 1. - cO;\n  float cQ = cP * (sqrt(cP) + cO);\n  return mix(cN, cH, cQ);\n}\nvec3 cR(const in vec3 by, const in vec3 bC, const in float bI, const in vec3 cS) {\n  vec3 cH = reflect(-bC, by);\n  cH = cM(by, cH, bI);\n  vec3 cT = cF(bI, uEnvironmentTransform * cH);\n  float bx = clamp(1. + dot(cH, cS), .0, 1.);\n  cT *= bx * bx;\n  return cT;\n}\n#else\nvec3 cR(const in vec3 by, const in vec3 bC, const in float bI, const in vec3 cS) {\n  return ambientColor;\n}\n#endif\nvec3 cU(const in vec3 bZ, const in float bI, const in float bJ, const in float bR) {\n  vec4 rgba = texture2D(brdfLUT, vec2(bJ, bI));\n  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);\n  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);\n  const float cV = 1. / 65535.;\n  return (bZ * a + b * bR) * cV;\n}\nvec3 cW(const in vec3 by, const in vec3 bC, const in float bI, const in vec3 bZ, const in vec3 cS, const in float bR) {\n  float bJ = dot(by, bC);\n  return cR(by, bC, bI, cS) * cU(bZ, bI, bJ, bR);\n}\nvec3 cX(const float bJ, const float bV, const vec3 cY, const float bO) {\n  return exp(cY * -bO * ((bV + bJ) / max(bV * bJ, 1e-3)));\n}\nvec3 cZ(const in float bJ, const in float bV, const in float da) {\n  return mix(vec3(1.), cX(bJ, bV, clearCoatTint, clearCoatThickness), da);\n}\nvoid db(const in float dc, const in vec3 by, const in vec3 bC, const in float bG, const in vec4 bH, const in float bE, const in vec3 cg, const in vec3 bF, const in float da, out vec3 dd, out vec3 de) {\n  if(bG <= .0) {\n    dd = vec3(.0);\n    de = vec3(.0);\n    return;\n  }\n  float df = clamp(dot(by, -refract(bF, by, 1. / clearCoatIor)), 0., 1.);\n  vec3 dg = cZ(dc, df, da);\n  vec3 ca = normalize(bC + bF);\n  float bM = clamp(dot(by, ca), 0., 1.);\n  float bS = clamp(dot(bF, ca), 0., 1.);\n  float cb = bL(bH, bM);\n  float cc = bU(bH, df);\n  float cd = bP(c, 1., bS);\n  dd = (bE * bG * da * cb * cc * 3.141593 * cd) * cg;\n  de = (1. - cd * da) * dg;\n}\nfloat dh(const in int di, const in float dj, const in vec3 by, const in vec3 bC) {\n  if(di == 0)\n    return 1.;\n  float bO = dot(by, bC) + dj;\n  return clamp(bO * bO - 1. + dj, .0, 1.);\n}\nvec3 dk(const in vec3 by, const in vec3 bC, const in float bI, const in vec3 cw, const in vec3 cx, const in float cy) {\n  vec3 dl = cy >= .0 ? cx : cw;\n  vec3 dm = cross(dl, bC);\n  vec3 dn = cross(dm, dl);\n  float dp = abs(cy) * clamp(5. * bI, .0, 1.);\n  return normalize(mix(by, dn, dp));\n}\nvoid dq() {\n  \n#ifdef HAS_MAP\nvec2 h = computeTexCoord();\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nh = P(h, normalize(vTangentViewPos - vTangentFragPos));\n#endif\nd.albedo = baseColorIntensity * baseColorFactor.rgb;\n  d.alpha = baseColorFactor.a;\n#if defined(HAS_PATTERN)\nfloat dr = vLinesofar;\n  vec2 j = vTexInfo.zw;\n#ifdef HAS_PATTERN_GAP\nfloat ds = vLinePatternGap;\n#else\nfloat ds = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat dt = vLinePatternAnimSpeed;\n#else\nfloat dt = linePatternAnimSpeed;\n#endif\nfloat du = ceil(j.x * vPatternHeight / j.y);\n  float dv = du * (1. + ds);\n  dr += mod(currentTime * -dt * .2, dv);\n  float dw = mod(dr / dv, 1.);\n  float dx = mod(flipY * vNormalY, 1.);\n  vec2 h = e(vec2(dw * (1. + ds) * uvScale[0], dx * uvScale[1]));\n  vec4 dy = texture2D(linePatternFile, h);\n  float dz = clamp(sign(1. / (1. + ds) - dw) + .000001, .0, 1.);\n  dy = mix(linePatternGapColor, dy, dz);\n#ifdef IS_SQUARE_TUBE\nfloat o = clamp(sign(abs(vNormalY) - .999999), .0, 1.);\n  dy = mix(dy, vec4(1.), o);\n#endif\nd.albedo *= dy.rgb;\n  d.alpha *= dy.a;\n#endif\n#if defined(HAS_ALBEDO_MAP)\nvec4 dA = u(baseColorTexture, h);\n  d.albedo *= bd(dA.rgb);\n  d.alpha *= dA.a;\n#endif\n#if defined(HAS_COLOR0)\nd.albedo *= vColor0.rgb;\n#if COLOR0_SIZE == 4\nd.alpha *= vColor0.a;\n#endif\n#endif\n#if defined(HAS_COLOR)\nd.albedo *= vColor.rgb;\n  d.alpha *= vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nd.albedo *= lineColor.rgb;\n  d.alpha *= lineColor.a;\n#else\nd.albedo *= polygonFill.rgb;\n  d.alpha *= polygonFill.a;\n#endif\n#if defined(HAS_INSTANCE_COLOR)\nd.albedo *= vInstanceColor.rgb;\n  d.alpha *= vInstanceColor.a;\n#endif\n#if defined(IS_LINE_EXTRUSION)\nd.alpha *= lineOpacity;\n#else\nd.alpha *= polygonOpacity;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nd.roughnessMetalness = u(metallicRoughnessTexture, h).gb * vec2(roughnessFactor, metallicFactor);\n#else\nd.roughnessMetalness = vec2(roughnessFactor, metallicFactor);\n#endif\nd.emit = emissiveFactor;\n#if defined(HAS_EMISSIVE_MAP)\nif(emitMultiplicative == 1) {\n    d.emit *= bd(u(emissiveTexture, h).rgb);\n  } else {\n    d.emit += bd(u(emissiveTexture, h).rgb);\n  }\n#endif\nd.emit *= emitColorFactor;\n#if defined(HAS_AO_MAP)\nd.ao = u(occlusionTexture, h).r;\n#else\nd.ao = 1.;\n#endif\nd.ao *= occlusionFactor;\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nvec3 dB = u(normalTexture, h).xyz * 2. - 1.;\n  dB.y = normalMapFlipY == 1 ? -dB.y : dB.y;\n  d.normal = dB;\n#else\nd.normal = normalize(vModelNormal);\n#endif\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nd.albedo *= diffuseFactor.rgb;\n  d.alpha *= diffuseFactor.a;\n#if defined(HAS_DIFFUSE_MAP)\nvec4 cf = u(diffuseTexture, h);\n  d.albedo *= bd(cf.rgb);\n  d.alpha *= cf.a;\n#endif\nd.specularColor = specularFactor;\n  d.glossiness = glossinessFactor;\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nvec4 dC = u(specularGlossinessTexture, h);\n  d.specularColor *= bd(dC.rgb);\n  d.glossiness *= dC.a;\n#endif\n#endif\n}\nvec3 dD(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float dE = 2.43;\n  const float bO = .59;\n  const float dF = .14;\n  return (x * (a * x + b)) / (x * (dE * x + bO) + dF);\n}\nvec3 dG(vec3 bc) {\n  bc = dD(bc);\n  return bc = pow(bc, vec3(1. / 2.2));\n}\nuniform float specularAAVariance;\nuniform float specularAAThreshold;\nfloat dH(float bI, const vec3 dI) {\n  \n#if defined(GL_OES_standard_derivatives) || __VERSION__ == 300\nvec3 dJ = dFdx(dI);\n  vec3 dK = dFdy(dI);\n  float dL = specularAAVariance * (dot(dJ, dJ) + dot(dK, dK));\n  float dM = min(2. * dL, specularAAThreshold);\n  float dN = saturate(bI * bI + dM);\n  return sqrt(dN);\n#else\nreturn bI;\n#endif\n}\n#ifdef HAS_SSR\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nvec3 dO(const in mat4 dP, const in vec3 dQ) {\n  vec4 dR = dP * vec4(dQ, 1.);\n  return vec3(.5 + .5 * dR.xy / dR.w, dR.w);\n}\nvec3 dS(const in float dT, const in vec2 h) {\n  return texture2D(TextureReflected, h).rgb;\n}\nfloat dU(float dV) {\n  highp mat4 dP = projMatrix;\n  highp float z = dV * 2. - 1.;\n  return -dP[3].z / (z + dP[2].z);\n}\nfloat dW(const vec2 h) {\n  float dV = bq(texture2D(TextureDepth, h));\n  return dV;\n}\nvec3 dX(const in float bu, const in vec3 dY, const in vec3 dZ, const in vec3 ea, const in vec3 bC, const in float eb) {\n  vec2 ec;\n  ec.x = bs(gl_FragCoord.yx, bu);\n  ec.y = fract(ec.x * 52.9829189);\n  ec.y = mix(ec.y, 1., .7);\n  float ed = 2. * 3.14159 * ec.x;\n  float ee = pow(max(ec.y, .000001), eb / (2. - eb));\n  float ef = sqrt(1. - ee * ee);\n  vec3 eg = vec3(ef * cos(ed), ef * sin(ed), ee);\n  eg = eg.x * dY + eg.y * dZ + eg.z * ea;\n  return normalize((2. * dot(bC, eg)) * eg - bC);\n}\nfloat eh(const in float bu) {\n  return (bs(gl_FragCoord.xy, bu) - .5);\n}\nvec3 ei(const in vec3 ej, const in float ek, const in vec3 el) {\n  vec3 em = dO(projMatrix, vViewVertex.xyz + el * ek);\n  em.z = 1. / em.z;\n  em -= ej;\n  float en = min(1., .99 * (1. - ej.x) / max(1e-5, em.x));\n  float eo = min(1., .99 * (1. - ej.y) / max(1e-5, em.y));\n  float ep = min(1., .99 * ej.x / max(1e-5, -em.x));\n  float eq = min(1., .99 * ej.y / max(1e-5, -em.y));\n  return em * min(en, eo) * min(ep, eq);\n}\nfloat er(const in vec3 ej, const in vec3 em, inout float es, inout float et) {\n  float eu = (et + es) * .5;\n  vec3 ev = ej + em * eu;\n  float z = dW(ev.xy);\n  float dV = dU(z);\n  float ew = -1. / ev.z;\n  es = dV > ew ? es : eu;\n  et = dV > ew ? eu : et;\n  return eu;\n}\nvec4 ex(const in vec3 ej, const in float ek, in float ey, const in vec3 el, const in float bI, const in float bu) {\n  int ez = 20;\n  float eA = 1. / float(ez);\n  ey *= eA;\n  vec3 em = ei(ej, ek, el);\n  float eB = eA;\n  vec3 eC = vec3(.0, eB, 1.);\n  vec3 ev;\n  float z, dV, ew, eD, eE, eF;\n  bool eG;\n  float eH = 1.;\n  float eu;\n  for(int X = 0; X < ez; X++) {\n    ev = ej + em * eC.y;\n    z = dW(ev.xy);\n    dV = dU(z);\n    ew = -1. / ev.z;\n    float eI = clamp(sign(.999 - z), .0, 1.);\n    eD = eI * (ew - dV);\n    eD *= clamp(sign(abs(eD) - ek * eA * eA), .0, 1.);\n    eG = abs(eD + ey) < ey;\n    eE = clamp(eC.x / (eC.x - eD), .0, 1.);\n    eF = eG ? eC.y + eE * eA - eA : 1.;\n    eC.z = min(eC.z, eF);\n    eC.x = eD;\n    if(eG) {\n      float es = eC.y - eA;\n      float et = eC.y;\n      eu = er(ej, em, es, et);\n      eu = er(ej, em, es, et);\n      eu = er(ej, em, es, et);\n      eH = eu;\n      break;\n    }\n    eC.y += eA;\n  }\n  return vec4(ej + em * eH, 1. - eH);\n}\nvec4 eJ(in vec4 eK, const in float eL, const in vec3 eM, const in vec3 eN, const in float bI) {\n  vec4 eO = mix(outputFovInfo[0], outputFovInfo[1], eK.x);\n  eK.xyz = vec3(mix(eO.xy, eO.zw, eK.y), 1.) * -1. / eK.z;\n  eK.xyz = (reprojViewProjMatrix * vec4(eK.xyz, 1.)).xyw;\n  eK.xy /= eK.z;\n  float eP = clamp(6. - 6. * max(abs(eK.x), abs(eK.y)), .0, 1.);\n  eK.xy = .5 + .5 * eK.xy;\n  vec3 eQ = eN * dS(bI * (1. - eK.w), eK.xy);\n  return vec4(mix(eM, eQ, eL * eP), 1.);\n}\nvec3 ssr(const in vec3 eM, const in vec3 eN, const in float bI, const in vec3 by, const in vec3 bC) {\n  float eR = .0;\n  vec4 cC = vec4(.0);\n  float eb = bI * bI;\n  eb = eb * eb;\n  vec3 eS = abs(by.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 dY = normalize(cross(eS, by));\n  vec3 dZ = cross(by, dY);\n  float eL = ssrFactor * clamp(-4. * dot(bC, by) + 3.8, .0, 1.);\n  eL *= clamp(4.7 - bI * 5., .0, 1.);\n  vec3 ej = dO(projMatrix, vViewVertex.xyz);\n  ej.z = 1. / ej.z;\n  vec3 el = dX(eR, dY, dZ, by, bC, eb);\n  float ek = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, el.z * .5 + .5);\n  float ey = .5 * ek;\n  vec4 eK;\n  if(dot(el, by) > .001 && eL > .0) {\n    eK = ex(ej, ek, ey, el, bI, eR);\n    if(eK.w > .0)\n      cC += eJ(eK, eL, eM, eN, bI);\n    \n  }\n  return cC.w > .0 ? cC.rgb / cC.w : eM;\n}\n#endif\n#include <highlight_frag>\nvoid main() {\n  dq();\n  vec3 bC = normalize(cameraPosition - vModelVertex.xyz);\n#if defined(HAS_DOUBLE_SIDE)\nvec3 cS = gl_FrontFacing ? normalize(vModelNormal) : -normalize(vModelNormal);\n#else\nvec3 cS = normalize(vModelNormal);\n#endif\n#if defined(HAS_TANGENT)\nvec4 eT;\n  eT = vModelTangent;\n#if defined(HAS_DOUBLE_SIDE)\neT.xyz = gl_FrontFacing ? normalize(eT.xyz) : -normalize(eT.xyz);\n#else\neT.xyz = normalize(eT.xyz);\n#endif\nvec3 eU = normalize(vModelBiTangent);\n#endif\nfloat bQ = .08 * bj();\n  float eV = bi();\n  vec3 eW = bg();\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 eX = d.specularColor;\n#else\nvec3 eX = mix(vec3(bQ), eW, eV);\n#endif\neW *= 1. - eV;\n  float eY = clamp(50.0 * eX.g, .0, 1.);\n  float eZ = bk();\n  if(specularAAVariance > .0) {\n    eZ = dH(eZ, cS);\n  }\n  vec3 fa = bl();\n  vec3 fb = bm();\n  vec3 fc = vec3(fb);\n#if defined(HAS_TANGENT) && defined(HAS_NORMAL_MAP)\nfc = bw(normalMapFactor, fc, eT.xyz, eU, cS);\n#endif\nfloat fd = bn();\n  float fe = bo();\n  if(specularAAVariance > .0) {\n    fe = dH(fe, cS);\n  }\n  vec3 ff = cS;\n#if defined(HAS_TANGENT)\nfloat cy;\n  vec3 cw;\n  vec3 cx;\n  if(anisotropyFactor > .0) {\n    cy = anisotropyFactor;\n    eT.xyz = normalize(eT.xyz - fc * dot(eT.xyz, fc));\n    eU = normalize(cross(fc, eT.xyz)) * eT.w;\n    cw = normalize(mix(eT.xyz, eU, anisotropyDirection));\n    cx = normalize(mix(eU, -eT.xyz, anisotropyDirection));\n  }\n#endif\nvec3 cf = vec3(.0);\n  vec3 bZ = vec3(.0);\n  vec3 fg;\n#if defined(HAS_TANGENT)\nif(anisotropyFactor > .0) {\n    fg = dk(fc, bC, eZ, cw, cx, cy);\n  } else {\n    fg = fc;\n  }\n#else\nfg = fc;\n#endif\n#if defined(HAS_IBL_LIGHTING)\ncf = eW * cB(fc) * .5;\n#else\ncf = eW * ambientColor;\n#endif\nbZ = cW(fg, bC, eZ, eX, cS, eY);\n  float dc;\n  if(clearCoatFactor > .0) {\n    dc = clamp(dot(ff, -refract(bC, ff, 1. / clearCoatIor)), 0., 1.);\n    float fh = fd * bP(c, 1., dc);\n    vec3 fi = cZ(dc, dc, fd);\n    bZ = mix(bZ * fi, cR(ff, bC, fe, cS), fh);\n    cf *= fi * (1. - fh);\n  }\n  float fj = 1.;\n  float fk = bp();\n  cf *= environmentExposure * fk;\n#ifdef HAS_IBL_LIGHTING\nfj = dh(1, fk, fc, bC);\n#endif\n#ifdef HAS_SSR\nvec3 fl = normalize(gl_FrontFacing ? vViewNormal : -vViewNormal);\n  vec3 fm = fl;\n#if defined(HAS_TANGENT) && defined(HAS_NORMAL_MAP)\nvec4 fn;\n  fn = vViewTangent;\n  fn = gl_FrontFacing ? fn : -fn;\n  fn.xyz = normalize(fn.xyz);\n  vec3 fo = normalize(cross(fl, fn.xyz)) * fn.w;\n  fm = bw(normalMapFactor, fb, fn.xyz, fo, fl);\n#endif\nbZ = ssr(bZ, eX * fj, eZ, fm, -normalize(vViewVertex.xyz));\n#endif\nbZ *= environmentExposure * fj;\n  float bE, bG;\n  vec3 bF;\n  bool cj;\n  vec3 fp;\n  vec3 fq;\n  vec4 fr = bH(fc, bC, max(.045, eZ));\n  vec3 fs = vModelNormal;\n  bB(bC, fc, light0_viewDirection, bE, bF, bG);\n#if defined(HAS_TANGENT)\nif(anisotropyFactor > .0) {\n    cA(fc, bC, bG, fr, eW, eX, bE, light0_diffuse.rgb, bF, eY, cw, cx, cy, fq, fp, cj);\n  } else {\n    ce(fc, bC, bG, fr, eW, eX, bE, light0_diffuse.rgb, bF, eY, fq, fp, cj);\n  }\n#else\nce(fc, bC, bG, fr, eW, eX, bE, light0_diffuse.rgb, bF, eY, fq, fp, cj);\n#endif\nif(clearCoatFactor > .0) {\n    vec3 ft;\n    vec3 fu;\n    vec4 fv = bH(ff, bC, fe);\n    db(dc, ff, bC, dot(ff, bF), fv, bE, light0_diffuse.rgb, bF, fd, ft, fu);\n    fq *= fu;\n    fp = ft + fp * fu;\n  }\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat fw = shadow_computeShadow();\n  fq = shadow_blend(fq, fw).rgb;\n  fp = shadow_blend(fp, fw).rgb;\n#endif\nvec3 fx = vec3(bZ);\n  vec3 fy = vec3(cf);\n  cf += fq;\n  bZ += fp;\n  cf += fa;\n  vec3 fz = bZ + cf;\n  if(outputSRGB == 1)\n    fz = bb(fz);\n  glFragColor = vec4(fz, bh());\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_SNOW\nglFragColor.rgb = snow(glFragColor, bm(), 1.);\n#endif\nif(contrast != 1.) {\n    glFragColor = contrastMatrix(contrast) * glFragColor;\n  }\n  if(length(hsv) > .0) {\n    glFragColor = hsv_apply(glFragColor, hsv);\n  }\n#ifdef OUTPUT_NORMAL\nglFragColor = vec4(cS, 1.);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:l,extraCommandProps:e,defines:i}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1),t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),e}},StandardDepthShader:class extends jh{constructor(t={}){const e=[];super({vert:"#define SHADER_NAME depth_vert\nprecision highp float;\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform vec2 outSize;\nuniform vec2 halton;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec4 d = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 d = getPosition(aPosition);\n#endif\nvec4 e = modelViewMatrix * c * d;\n  mat4 f = projMatrix;\n  f[2].xy += halton.xy / outSize.xy;\n  gl_Position = f * e;\n}",frag:"#define SHADER_NAME depth_frag\nprecision highp float;\nvoid main() {\n  gl_FragColor = vec4(1., .0, .0, 1.);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,n)=>re(e,n.viewMatrix,n.modelMatrix)}],extraCommandProps:t.extraCommandProps,defines:t.defines})}},PBRUtils:Pb};var ew=Object.freeze({__proto__:null,AbstractTexture:xa,BloomPass:dl,BoundingBox:Sa,BoxBlurShader:Qh,Constants:ya,CopyShader:wl,DeferredRenderer:Ma,ExtentPass:Nx,FBORayPicking:Wb,FogPass:Ml,FogShader:Al,FxaaShader:Jh,GLTFHelper:$x,GLTFManager:sb,Geometry:La,HDR:$b,HeatmapDisplayShader:xl,HeatmapShader:pl,InstancedMesh:Ka,Jitter:ul,KHRTechniquesWebglManager:Qb,Material:Na,Mesh:Ya,MeshShader:jh,PhongMaterial:za,PhongShader:Vh,PhongSpecularGlossinessMaterial:Xa,Plane:Sh,PointLineShader:Wh,PostProcessShader:rl,QuadShader:Kh,REGLHelper:Ah,RainRipplesPass:Il,Renderer:Ta,ResourceLoader:Qa,Scene:nh,Shader:Bh,ShaderLib:Rh,ShadowDisplayShader:Lb,ShadowMapShader:Rb,ShadowPass:kb,SkyboxShader:yl,SsaoPass:il,SsrPass:gl,TaaPass:al,Texture2D:Eh,TextureCube:Ch,ToonMaterial:Ua,ToonShader:Xh,Util:pa,WaterShader:bl,WireFrameMaterial:Ha,WireframeShader:zh,earcut:Ix,pbr:tw}),nw=Array.isArray,iw=Object.keys,rw=Object.prototype.hasOwnProperty,ow=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){var i,r,o,s=nw(e),a=nw(n);if(s&&a){if((r=e.length)!=n.length)return!1;for(i=r;0!=i--;)if(!t(e[i],n[i]))return!1;return!0}if(s!=a)return!1;var h=e instanceof Date,l=n instanceof Date;if(h!=l)return!1;if(h&&l)return e.getTime()==n.getTime();var c=e instanceof RegExp,u=n instanceof RegExp;if(c!=u)return!1;if(c&&u)return e.toString()==n.toString();var f=iw(e);if((r=f.length)!==iw(n).length)return!1;for(i=r;0!=i--;)if(!rw.call(n,f[i]))return!1;for(i=r;0!=i--;)if(!t(e[o=f[i]],n[o]))return!1;return!0}return e!=e&&n!=n};function sw(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function aw(t,...e){for(let n=0;n<e.length;n++)sw(t,e[n])}class hw{constructor(t){this.context=t,this.COLOR_ATTACHMENT0_WEBGL=36064,this.COLOR_ATTACHMENT1_WEBGL=36065,this.COLOR_ATTACHMENT2_WEBGL=36066,this.COLOR_ATTACHMENT3_WEBGL=36067,this.COLOR_ATTACHMENT4_WEBGL=36068,this.COLOR_ATTACHMENT5_WEBGL=36069,this.COLOR_ATTACHMENT6_WEBGL=36070,this.COLOR_ATTACHMENT7_WEBGL=36071,this.COLOR_ATTACHMENT8_WEBGL=36072,this.COLOR_ATTACHMENT9_WEBGL=36073,this.COLOR_ATTACHMENT10_WEBGL=577040,this.COLOR_ATTACHMENT11_WEBGL=577041,this.COLOR_ATTACHMENT12_WEBGL=577042,this.COLOR_ATTACHMENT13_WEBGL=577043,this.COLOR_ATTACHMENT14_WEBGL=577044,this.COLOR_ATTACHMENT15_WEBGL=577045,this.DRAW_BUFFER0_WEBGL=34853,this.DRAW_BUFFER1_WEBGL=34854,this.DRAW_BUFFER2_WEBGL=34855,this.DRAW_BUFFER3_WEBGL=34856,this.DRAW_BUFFER4_WEBGL=34857,this.DRAW_BUFFER5_WEBGL=34858,this.DRAW_BUFFER6_WEBGL=34859,this.DRAW_BUFFER7_WEBGL=34860,this.DRAW_BUFFER8_WEBGL=34861,this.DRAW_BUFFER9_WEBGL=34862,this.DRAW_BUFFER10_WEBGL=34863,this.DRAW_BUFFER11_WEBGL=34864,this.DRAW_BUFFER12_WEBGL=34865,this.DRAW_BUFFER13_WEBGL=34866,this.DRAW_BUFFER14_WEBGL=34867,this.DRAW_BUFFER15_WEBGL=34868,this.MAX_COLOR_ATTACHMENTS_WEBGL=36063,this.MAX_DRAW_BUFFERS_WEBGL=2178}drawBuffersWEBGL(){return this.context.drawBuffers.apply(this.context,arguments)}}class lw{constructor(t){this.context=t,this.VERTEX_ARRAY_BINDING_OES=34229}createVertexArrayOES(){return this.context.createVertexArray()}deleteVertexArrayOES(){return this.context.deleteVertexArray.apply(this.context,arguments)}isVertexArrayOES(){return this.context.isVertexArray.apply(this.context,arguments)}bindVertexArrayOES(){return this.context.bindVertexArray.apply(this.context,arguments)}}class cw{constructor(t){this.context=t,this.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070}drawArraysInstancedANGLE(){return this.context.drawArraysInstanced.apply(this.context,arguments)}drawElementsInstancedANGLE(){return this.context.drawElementsInstanced.apply(this.context,arguments)}vertexAttribDivisorANGLE(){return this.context.vertexAttribDivisor.apply(this.context,arguments)}}const uw={webgl_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},oes_element_index_uint:{},oes_texture_float:{},oes_texture_half_float:{HALF_FLOAT_OES:36193},ext_color_buffer_float:{},oes_standard_derivatives:{},ext_frag_depth:{},ext_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},ext_shader_texture_lod:{}},fw={has(t,e){const n=t._,i=t.t;return!(!n&&!i.getExtension(e))&&(e=e.toLowerCase(),n&&uw[e]||"webgl_draw_buffers"===e||"oes_vertex_array_object"===e||"angle_instanced_arrays"===e)},mock(t,e){return e=e.toLowerCase(),uw[e]?t._?("oes_texture_float"!==e&&"oes_texture_half_float"!==e||t.t.getExtension("EXT_color_buffer_float"),uw[e]):this.t.getExtension(e):"webgl_draw_buffers"===e?new hw(t):"oes_vertex_array_object"===e?new lw(t):"angle_instanced_arrays"===e?new cw(t):null},getInternalFormat:(t,e,n)=>6402===e?33190:34041===e?35056:36193===n&&e===t.RGBA?34842:36193===n&&e===t.RGB?34843:n===t.FLOAT&&e===t.RGBA?34836:n===t.FLOAT&&e===t.RGB?34837:e,getTextureType:(t,e)=>36193===e?t.HALF_FLOAT:e};let dw=1;class mw{constructor(t){this.uid=dw++,this.states=function(t){return{scissor:[0,0,t.canvas.width,t.canvas.height],viewport:[0,0,t.canvas.width,t.canvas.height],blendColor:[0,0,0,0],blendEquationSeparate:[t.FUNC_ADD,t.FUNC_ADD],blendFuncSeparate:[t.ONE,t.ZERO,t.ONE,t.ZERO],clearColor:[0,0,0,0],clearDepth:[1],clearStencil:[0],colorMask:[!0,!0,!0,!0],cullFace:[t.BACK],depthFunc:[t.LESS],depthMask:[!0],depthRange:[0,1],capabilities:{3042:!1,2884:!1,2929:!1,3024:!1,32823:!1,32926:!1,32928:!1,3089:!1,2960:!1},frontFace:[t.CCW],hint:{33170:[t.DONT_CARE],35723:[t.DONT_CARE]},lineWidth:[1],pixelStorei:{3333:[4],3317:[4],37440:[!1],37441:[!1],37443:[t.BROWSER_DEFAULT_WEBGL]},polygonOffset:[0,0],sampleCoverage:[1,!1],stencilFuncSeparate:{1028:[t.ALWAYS,0,4294967295],1029:[t.ALWAYS,0,4294967295]},stencilMaskSeparate:{1028:[4294967295],1029:[4294967295]},stencilOpSeparate:{1028:[t.KEEP,t.KEEP,t.KEEP],1029:[t.KEEP,t.KEEP,t.KEEP]},program:null,framebuffer:{36160:null,36008:null,36009:null},renderbuffer:{36161:null},textures:{active:-1,units:function(){const e=[],n=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let t=0;t<n;t++)e.push({3553:null,34067:null});return e[-1]={3553:null,34067:null},e}()},attributes:{},arrayBuffer:null,elementArrayBuffer:null}}(t),this.t=t,this.t._fusiongl_drawCalls=0,this._="undefined"!=typeof WebGL2RenderingContext&&this.t instanceof WebGL2RenderingContext,this.R=t.getParameter(t.MAX_VERTEX_ATTRIBS)}get canvas(){return this.t.canvas}get drawingBufferWidth(){return this.t.drawingBufferWidth}get drawingBufferHeight(){return this.t.drawingBufferHeight}get gl(){return this.t}get buffersOES(){return this.T||(this.T=this.t.getExtension("WEBGL_draw_buffers")),this.T}get vaoOES(){return this.A||(this.A=this.t.getExtension("OES_vertex_array_object")),this.A}get angleOES(){return this.s||(this.s=this.t.getExtension("ANGLE_instanced_arrays")),this.s}attachShader(t,e){return this.t.attachShader(t,e)}shaderSource(t,e){return this.t.shaderSource(t,e)}compileShader(t){return this.t.compileShader(t)}createShader(t){return this.t.createShader(t)}createProgram(){return this.t.createProgram()}deleteProgram(t){return this.states.program===t&&(this.states.program=null),this.t.deleteProgram(t)}deleteShader(t){return this.t.deleteShader(t)}detachShader(t,e){return this.t.detachShader(t,e)}getAttachedShaders(t){return this.t.getAttachedShaders(t)}linkProgram(t){return this.t.linkProgram(t)}getShaderParameter(t,e){return this.t.getShaderParameter(t,e)}getShaderPrecisionFormat(t,e){return this.t.getShaderPrecisionFormat(t,e)}getShaderInfoLog(t){return this.t.getShaderInfoLog(t)}getShaderSource(t){return this.t.getShaderSource(t)}getProgramInfoLog(t){return this.t.getProgramInfoLog(t)}getProgramParameter(t,e){return this.t.getProgramParameter(t,e)}getError(){return this.t.getError()}getContextAttributes(){return this.t.getContextAttributes()}getExtension(t){return fw.has(this,t)?fw.mock(this,t):this.t.getExtension(t)}getSupportedExtensions(){return this.t.getSupportedExtensions()}getParameter(t){return this.t.getParameter(t)}isEnabled(t){return this.t.isEnabled(t)}isProgram(t){return this.t.isProgram(t)}isShader(t){return this.t.isShader(t)}validateProgram(t){return this.t.validateProgram(t)}clear(t){return this.i(),this.t.clear(t)}drawArrays(t,e,n){return this.i(),this.N(),this.t.drawArrays(t,e,n)}drawElements(t,e,n,i){return this.i(),this.N(),this.t.drawElements(t,e,n,i)}drawBuffers(t){return this.i(),this.N(),this._?this.t.drawBuffers(t):this.buffersOES.drawBuffersWEBGL(t)}N(){this.t._fusiongl_drawCalls++}resetDrawCalls(){this.t._fusiongl_drawCalls=0}getDrawCalls(){return this.t._fusiongl_drawCalls}I(){const t=this.t,e=t.getParameter(t.CURRENT_PROGRAM),n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),i=[];for(let r=0;r<n;r++)i.push(t.getVertexAttrib(r,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING));this.h={buffers:i,elements:t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING),framebuffer:t.getParameter(t.FRAMEBUFFER_BINDING)},window.DEBUGGING&&(console.log(this.uid,this.h),console.log(this.uid,this.states.attributes),console.log(this.states.attributes[0].buffer===this.h.buffers[0]),console.log(this.states.attributes[1].buffer===this.h.buffers[1]),console.log(this.states.attributes[2].buffer===this.h.buffers[2]))}finish(){return this.t.finish()}flush(){return this.i(),this.t.flush()}commit(){return this.i(),this.t.commit()}isContextLost(){return this.t.isContextLost()}}aw(mw.prototype,{DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBSTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795}),aw(mw.prototype,{bufferData(...t){return this.i(),this.t.bufferData(...t)},bufferSubData(...t){return this.i(),this.t.bufferSubData(...t)},createBuffer(){return this.t.createBuffer()},deleteBuffer(t){const e=this.states;e.arrayBuffer===t?e.arrayBuffer=null:e.elementArrayBuffer===t&&(e.elementArrayBuffer=null);const n=e.attributes;for(const i in n)n[i].buffer===t&&(n[i].buffer=null,n[i].enable=!1,this.t.disableVertexAttribArray(+i));return this.t.deleteBuffer(t)},getBufferParameter(t,e){return this.i(),this.t.getBufferParameter(t,e)},isBuffer(t){return this.t.isBuffer(t)}}),aw(mw.prototype,{checkFramebufferStatus(t){return this.t.checkFramebufferStatus(t)},createFramebuffer(){return this.t.createFramebuffer()},deleteFramebuffer(t){const e=this.states.framebuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.t.deleteFramebuffer(t)},framebufferRenderbuffer(t,e,n,i){return this.i(),this.t.framebufferRenderbuffer(t,e,n,i)},framebufferTexture2D(t,e,n,i,r){return this.i(),this.t.framebufferTexture2D(t,e,n,i,r)},getFramebufferAttachmentParameter(t,e,n){return this.i(),this.t.getFramebufferAttachmentParameter(t,e,n)},isFramebuffer(t){return this.t.isFramebuffer(t)},readPixels(t,e,n,i,r,o,s){return this.i(),this.t.readPixels(t,e,n,i,r,o,s)},blitFramebuffer(t,e,n,i,r,o,s,a,h,l){return this.i(),this.t.blitFramebuffer(t,e,n,i,r,o,s,a,h,l)}}),aw(mw.prototype,{createRenderbuffer(){return this.t.createRenderbuffer()},deleteRenderbuffer(t){const e=this.states.renderbuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.t.deleteRenderbuffer(t)},getRenderbufferParameter(t,e){return this.i(),this.t.getRenderbufferParameter(t,e)},isRenderbuffer(t){return this.t.isRenderbuffer(t)},renderbufferStorage(t,e,n,i){return this.i(),this.t.renderbufferStorage(t,e,n,i)},renderbufferStorageMultisample(t,e,n,i,r){return this.i(),this.t.renderbufferStorageMultisample(t,e,n,i,r)}}),aw(mw.prototype,{scissor(t,e,n,i){this.i();const r=this.states.scissor;r[0]===t&&r[1]===e&&r[2]===n&&r[3]===i||(r[0]=t,r[1]=e,r[2]=n,r[3]=i,this.t.scissor(t,e,n,i))},viewport(t,e,n,i){this.i();const r=this.states.viewport;r[0]===t&&r[1]===e&&r[2]===n&&r[3]===i||(r[0]=t,r[1]=e,r[2]=n,r[3]=i,this.t.viewport(t,e,n,i))},blendColor(t,e,n,i){this.i();const r=this.states.blendColor;r[0]===t&&r[1]===e&&r[2]===n&&r[3]===i||(r[0]=t,r[1]=e,r[2]=n,r[3]=i,this.t.blendColor(t,e,n,i))},blendEquation(t){this.i();const e=this.states.blendEquationSeparate;e[0]===t&&e[1]===t||(e[0]=t,e[1]=t,this.t.blendEquation(t))},blendEquationSeparate(t,e){this.i();const n=this.states.blendEquationSeparate;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.t.blendEquationSeparate(t,e))},blendFunc(t,e){this.i();const n=this.states.blendFuncSeparate;n[0]===t&&n[2]===t&&n[1]===e&&n[3]===e||(n[0]=t,n[1]=e,n[2]=t,n[3]=e,this.t.blendFunc(t,e))},blendFuncSeparate(t,e,n,i){this.i();const r=this.states.blendFuncSeparate;r[0]===t&&r[1]===e&&r[2]===n&&r[3]===i||(r[0]=t,r[1]=e,r[2]=n,r[3]=i,this.t.blendFuncSeparate(t,e,n,i))},clearColor(t,e,n,i){this.i();const r=this.states.clearColor;r[0]===t&&r[1]===e&&r[2]===n&&r[3]===i||(r[0]=t,r[1]=e,r[2]=n,r[3]=i,this.t.clearColor(t,e,n,i))},clearDepth(t){this.i();const e=this.states.clearDepth;e[0]!==t&&(e[0]=t,this.t.clearDepth(t))},clearStencil(t){this.i();const e=this.states.clearStencil;e[0]!==t&&(e[0]=t,this.t.clearStencil(t))},colorMask(t,e,n,i){this.i();const r=this.states.colorMask;r[0]===t&&r[1]===e&&r[2]===n&&r[3]===i||(r[0]=t,r[1]=e,r[2]=n,r[3]=i,this.t.colorMask(t,e,n,i))},cullFace(t){this.i();const e=this.states.cullFace;e[0]!==t&&(e[0]=t,this.t.cullFace(t))},depthFunc(t){this.i();const e=this.states.depthFunc;e[0]!==t&&(e[0]=t,this.t.depthFunc(t))},depthMask(t){this.i();const e=this.states.depthMask;e[0]!==t&&(e[0]=t,this.t.depthMask(t))},depthRange(t,e){this.i();const n=this.states.depthRange;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.t.depthRange(t,e))},disable(t){this.i();const e=this.states.capabilities;e[t]&&(e[t]=!1,this.t.disable(t))},enable(t){this.i();const e=this.states.capabilities;e[t]||(e[t]=!0,this.t.enable(t))},frontFace(t){this.i();const e=this.states.frontFace;e[0]!==t&&(e[0]=t,this.t.frontFace(t))},hint(t,e){this.i();const n=this.states.hint;n[t][0]!==e&&(n[t][0]=e,this.t.hint(t,e))},lineWidth(t){this.i();const e=this.states.lineWidth;e[0]!==t&&(e[0]=t,this.t.lineWidth(t))},pixelStorei(t,e){this.i();const n=this.states.pixelStorei;n[t]!==e&&(n[t]&&(n[t][0]=e),this.t.pixelStorei(t,e))},polygonOffset(t,e){this.i();const n=this.states.polygonOffset;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.t.polygonOffset(t,e))},sampleCoverage(t,e){this.i();const n=this.states.sampleCoverage;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.t.sampleCoverage(t,e))},stencilFunc(t,e,n){this.i();const i=this.states.stencilFuncSeparate,r=this.t;i[r.FRONT][0]===t&&i[r.FRONT][1]===e&&i[r.FRONT][2]===n&&i[r.BACK][0]===t&&i[r.BACK][1]===e&&i[r.BACK][2]===n||(i[r.FRONT][0]=i[r.BACK][0]=t,i[r.FRONT][1]=i[r.BACK][1]=e,i[r.FRONT][2]=i[r.BACK][2]=n,this.t.stencilFunc(t,e,n))},stencilFuncSeparate(t,e,n,i){if(this.i(),t===this.t.FRONT_AND_BACK)return void this.stencilFunc(e,n,i);const r=this.states.stencilFuncSeparate;r[t][0]===e&&r[t][1]===n&&r[t][2]===i||(r[t][0]=e,r[t][1]=n,r[t][2]=i,this.t.stencilFuncSeparate(t,e,n,i))},stencilMask(t){this.i();const e=this.t,n=this.states.stencilMaskSeparate;n[e.FRONT][0]===t&&n[e.BACK][0]===t||(n[e.FRONT][0]=t,n[e.BACK][0]=t,this.t.stencilMask(t))},stencilMaskSeparate(t,e){if(this.i(),t===this.t.FRONT_AND_BACK)return void this.stencilMask(e);const n=this.states.stencilMaskSeparate;n[t][0]!==e&&(n[t][0]=e,this.t.stencilMaskSeparate(t,e))},stencilOp(t,e,n){this.i();const i=this.states.stencilOpSeparate,r=this.t;i[r.FRONT][0]===t&&i[r.FRONT][1]===e&&i[r.FRONT][2]===n&&i[r.BACK][0]===t&&i[r.BACK][1]===e&&i[r.BACK][2]===n||(i[r.FRONT][0]=i[r.BACK][0]=t,i[r.FRONT][1]=i[r.BACK][1]=e,i[r.FRONT][2]=i[r.BACK][2]=n,this.t.stencilOp(t,e,n))},stencilOpSeparate(t,e,n,i){if(this.i(),t===this.t.FRONT_AND_BACK)return void this.stencilOp(e,n,i);const r=this.states.stencilOpSeparate;r[t][0]===e&&r[t][1]===n&&r[t][2]===i||(r[t][0]=e,r[t][1]=n,r[t][2]=i,this.t.stencilOpSeparate(t,e,n,i))},bindFramebuffer(t,e){this.i();const n=this.states.framebuffer;n[t]!==e&&(n[t]=e,this.t.bindFramebuffer(t,e))},bindRenderbuffer(t,e){this.i();const n=this.states.renderbuffer;n[t]!==e&&(n[t]=e,this.t.bindRenderbuffer(t,e))},bindTexture(t,e){this.i();const n=this.states.textures,i=-1!==n.active?n.active-33984:-1;n.units[i][t]=e,this.t.bindTexture(t,e)},activeTexture(t){this.i();const e=this.t,n=this.states.textures,i=n.active;n.active=t,this.activeUnit!==t&&(e.activeTexture(t),this.activeUnit=t),-1===i&&(n.units[t-33984][e.TEXTURE_2D]=n.units[-1][e.TEXTURE_2D],n.units[t-33984][e.TEXTURE_CUBE_MAP]=n.units[-1][e.TEXTURE_CUBE_MAP],n.units[-1][e.TEXTURE_2D]=null,n.units[-1][e.TEXTURE_CUBE_MAP]=null)},useProgram(t){this.i();const e=this.states;e.program!==t&&(e.program=t,this.t.useProgram(t))},bindBuffer(t,e){this.i();const n=this.t,i=this.states;t===n.ELEMENT_ARRAY_BUFFER?i.elementArrayBuffer=e:i.arrayBuffer=e,n.bindBuffer(t,e)},bindVertexArray(t){this.i();const e=this.t,n=this.states;n.vao!==t&&(n.vao=t,this._?e.bindVertexArray(t):this.vaoOES.bindVertexArrayOES(t))},vertexAttribPointer(t,e,n,i,r,o){this.i(),this.states.attributes[t]||(this.states.attributes[t]={enable:!0});const s=this.states.attributes[t];return s.buffer=this.states.arrayBuffer,s.args?(s.args[0]=t,s.args[1]=e,s.args[2]=n,s.args[3]=i,s.args[4]=r,s.args[5]=o):s.args=[t,e,n,i,r,o],this.t.vertexAttribPointer(t,e,n,i,r,o)},vertexAttribDivisor(t,e){return this.i(),this.states.attributes[t].divisor=e,this._?this.t.vertexAttribDivisor(t,e):this.angleOES.vertexAttribDivisorANGLE(t,e)}},{i(){const t=this.t;if(t.S&&t.S!==this){const e=t.S;this.O(e.states),t.S=this}t.S=this},O(t){if(!t)return;delete this.activeUnit;const e=this.states,n=this.t;for(const u in e)if("capabilities"!==u&&"textures"!==u&&"attributes"!==u&&"arrayBuffer"!==u&&"elementArrayBuffer"!==u&&"vao"!==u)if("program"===u)e.program!==t.program&&n.useProgram(e.program);else if("framebuffer"===u)for(const i in e[u])e[u][i]!==t[u][i]&&n.bindFramebuffer(+i,e[u][i]);else if("renderbuffer"===u)for(const i in e[u])e[u][i]!==t[u][i]&&n.bindRenderbuffer(+i,e[u][i]);else if(!ow(e[u],t[u]))if(Array.isArray(t[u]))n[u](...e[u]);else if(t[u])for(const i in e[u])ow(e[u][i],t[u][i])||n[u](+i,...e[u][i]);for(const u in e.capabilities)e.capabilities[u]!==t.capabilities[u]&&n[e.capabilities[u]?"enable":"disable"](+u);const i=e.textures,r=t.textures,o=i.units,s=r.units,a=i.active-n.TEXTURE0;for(let u=0;u<o.length;u++)u===a||o[u][n.TEXTURE_2D]===s[u][n.TEXTURE_2D]&&o[u][n.TEXTURE_CUBE_MAP]===s[u][n.TEXTURE_CUBE_MAP]||(n.activeTexture(n.TEXTURE0+u),n.bindTexture(n.TEXTURE_2D,o[u][n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,o[u][n.TEXTURE_CUBE_MAP]));if(i.active>-1){const t=o[a];t[n.TEXTURE_2D]===s[a][n.TEXTURE_2D]&&t[n.TEXTURE_CUBE_MAP]===s[a][n.TEXTURE_CUBE_MAP]||(n.activeTexture(i.active),n.bindTexture(n.TEXTURE_2D,t[n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,t[n.TEXTURE_CUBE_MAP]))}this._?n.bindVertexArray(null):this.A&&this.A.bindVertexArrayOES(null);const h=this.R,l=e.attributes;for(let u=0;u<h;u++){const t=l[u];t?(t.buffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.buffer),n.vertexAttribPointer(...t.args),void 0!==t.divisor&&(this._?n.vertexAttribDivisor(u,t.divisor):this.angleOES.vertexAttribDivisorANGLE(u,t.divisor))),t.enable?n.enableVertexAttribArray(u):n.disableVertexAttribArray(u)):n.disableVertexAttribArray(u)}n.bindBuffer(n.ARRAY_BUFFER,e.arrayBuffer),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.elementArrayBuffer);const c=e.vao;c&&(this._?n.bindVertexArray(c||null):this.A&&this.A.bindVertexArrayOES(c||null))}}),aw(mw.prototype,{compressedTexImage2D(t,e,n,i,r,o,s){return this.i(),this.t.compressedTexImage2D(t,e,n,i,r,o,s)},copyTexImage2D(t,e,n,i,r,o,s,a){return this.i(),this.t.copyTexImage2D(t,e,n,i,r,o,s,a)},copyTexSubImage2D(t,e,n,i,r,o,s,a){return this.i(),this.t.copyTexSubImage2D(t,e,n,i,r,o,s,a)},createTexture(){return this.t.createTexture()},deleteTexture(t){const e=this.states.textures.units;for(let n=0;n<e.length;n++)for(const i in e[n])e[n][i]===t&&(e[n][i]=null);return this.t.deleteTexture(t)},generateMipmap(t){return this.i(),this.t.generateMipmap(t)},getTexParameter(t,e){return this.i(),this.t.getTexParameter(t,e)},isTexture(t){return this.t.isTexture(t)},texImage2D(...t){if(this.i(),this._){const e=t[t.length-2],n=fw.getInternalFormat(this.t,t[2],e);n!==t[2]&&(t[2]=n);const i=fw.getTextureType(this.t,e);i!==e&&(t[t.length-2]=i)}return this.t.texImage2D(...t)},texSubImage2D(t){if(this.i(),this._){const e=t[t.length-2],n=fw.getTextureType(this.t,e);n!==e&&(t[t.length-2]=n)}return this.t.texSubImage2D(...t)},texParameterf(t,e,n){return this.i(),this.t.texParameterf(t,e,n)},texParameteri(t,e,n){return this.i(),this.t.texParameteri(t,e,n)}}),aw(mw.prototype,{bindAttribLocation(t,e,n){return this.t.bindAttribLocation(t,e,n)},enableVertexAttribArray(t){return this.i(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!0,this.t.enableVertexAttribArray(t)},disableVertexAttribArray(t){return this.i(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!1,this.t.disableVertexAttribArray(t)},getActiveAttrib(t,e){return this.t.getActiveAttrib(t,e)},getActiveUniform(t,e){return this.t.getActiveUniform(t,e)},getAttribLocation(t,e){return this.t.getAttribLocation(t,e)},getUniformLocation(t,e){return this.t.getUniformLocation(t,e)},getVertexAttrib(t,e){return this.i(),this.t.getVertexAttrib(t,e)},getVertexAttribOffset(t,e){return this.i(),this.t.getVertexAttribOffset(t,e)},uniformMatrix2fv(t,e,n){return this.i(),this.t.uniformMatrix2fv(t,e,n)},uniformMatrix3fv(t,e,n){return this.i(),this.t.uniformMatrix3fv(t,e,n)},uniformMatrix4fv(t,e,n){return this.i(),this.t.uniformMatrix4fv(t,e,n)},uniform1f(t,e){return this.i(),this.t.uniform1f(t,e)},uniform1fv(t,e){return this.i(),this.t.uniform1fv(t,e)},uniform1i(t,e){return this.i(),this.t.uniform1i(t,e)},uniform1iv(t,e){return this.i(),this.t.uniform1iv(t,e)},uniform2f(t,e,n){return this.i(),this.t.uniform2f(t,e,n)},uniform2fv(t,e){return this.i(),this.t.uniform2fv(t,e)},uniform2i(t,e,n){return this.i(),this.t.uniform2i(t,e,n)},uniform2iv(t,e){return this.i(),this.t.uniform2iv(t,e)},uniform3f(t,e,n,i){return this.i(),this.t.uniform3f(t,e,n,i)},uniform3fv(t,e){return this.i(),this.t.uniform3fv(t,e)},uniform3i(t,e,n,i){return this.i(),this.t.uniform3i(t,e,n,i)},uniform3iv(t,e){return this.i(),this.t.uniform3iv(t,e)},uniform4f(t,e,n,i,r){return this.i(),this.t.uniform4f(t,e,n,i,r)},uniform4fv(t,e){return this.i(),this.t.uniform4fv(t,e)},uniform4i(t,e,n,i,r){return this.i(),this.t.uniform4i(t,e,n,i,r)},uniform4iv(t,e){return this.i(),this.t.uniform4iv(t,e)},vertexAttrib1f(t,e){return this.i(),this.t.vertexAttrib1f(t,e)},vertexAttrib2f(t,e,n){return this.i(),this.t.vertexAttrib2f(t,e,n)},vertexAttrib3f(t,e,n,i){return this.i(),this.t.vertexAttrib3f(t,e,n,i)},vertexAttrib4f(t,e,n,i,r){return this.i(),this.t.vertexAttrib4f(t,e,n,i,r)},vertexAttrib1fv(t,e){return this.i(),this.t.vertexAttrib1fv(t,e)},vertexAttrib2fv(t,e){return this.i(),this.t.vertexAttrib2fv(t,e)},vertexAttrib3fv(t,e){return this.i(),this.t.vertexAttrib3fv(t,e)},vertexAttrib4fv(t,e){return this.i(),this.t.vertexAttrib4fv(t,e)}}),aw(mw.prototype,{createVertexArray(){return this._?this.t.createVertexArray():this.vaoOES.createVertexArrayOES()},deleteVertexArray(t){const e=this.states;return e.vao===t&&(e.vao=null),this._?this.t.deleteVertexArray(t):this.vaoOES.deleteVertexArrayOES(t)},isVertexArray(t){return this._?this.t.isVertexArray(t):this.vaoOES.isVertexArrayOES(t)}}),aw(mw.prototype,{drawArraysInstanced(t,e,n,i){return this.i(),this.N(),this._?this.t.drawArraysInstanced(t,e,n,i):this.angleOES.drawArraysInstancedANGLE(t,e,n,i)},drawElementsInstanced(t,e,n,i,r){return this.i(),this.N(),this._?this.t.drawElementsInstanced(t,e,n,i,r):this.angleOES.drawElementsInstancedANGLE(t,e,n,i,r)}});var gw={exports:{}},pw={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},_w={exports:{}},vw=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},yw=Array.prototype.concat,xw=Array.prototype.slice,bw=_w.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++){var r=t[n];vw(r)?e=yw.call(e,xw.call(r)):e.push(r)}return e};bw.wrap=function(t){return function(){return t(bw(arguments))}};var ww=pw,Tw=_w.exports,Mw=Object.hasOwnProperty,Aw=Object.create(null);for(var Ew in ww)Mw.call(ww,Ew)&&(Aw[ww[Ew]]=Ew);var Cw=gw.exports={to:{},get:{}};function Sw(t,e,n){return Math.min(Math.max(e,t),n)}function Pw(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}Cw.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=Cw.get.hsl(t),n="hsl";break;case"hwb":e=Cw.get.hwb(t),n="hwb";break;default:e=Cw.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},Cw.get.rgb=function(t){if(!t)return null;var e,n,i,r=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(i=e[2],e=e[1],n=0;n<3;n++){var o=2*n;r[n]=parseInt(e.slice(o,o+2),16)}i&&(r[3]=parseInt(i,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(i=(e=e[1])[3],n=0;n<3;n++)r[n]=parseInt(e[n]+e[n],16);i&&(r[3]=parseInt(i+i,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)r[n]=parseInt(e[n+1],0);e[4]&&(e[5]?r[3]=.01*parseFloat(e[4]):r[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:Mw.call(ww,e[1])?((r=ww[e[1]])[3]=1,r):null:null;for(n=0;n<3;n++)r[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?r[3]=.01*parseFloat(e[4]):r[3]=parseFloat(e[4]))}for(n=0;n<3;n++)r[n]=Sw(r[n],0,255);return r[3]=Sw(r[3],0,1),r},Cw.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,Sw(parseFloat(e[2]),0,100),Sw(parseFloat(e[3]),0,100),Sw(isNaN(n)?1:n,0,1)]}return null},Cw.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,Sw(parseFloat(e[2]),0,100),Sw(parseFloat(e[3]),0,100),Sw(isNaN(n)?1:n,0,1)]}return null},Cw.to.hex=function(){var t=Tw(arguments);return"#"+Pw(t[0])+Pw(t[1])+Pw(t[2])+(t[3]<1?Pw(Math.round(255*t[3])):"")},Cw.to.rgb=function(){var t=Tw(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},Cw.to.rgb.percent=function(){var t=Tw(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),i=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+i+"%)":"rgba("+e+"%, "+n+"%, "+i+"%, "+t[3]+")"},Cw.to.hsl=function(){var t=Tw(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},Cw.to.hwb=function(){var t=Tw(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},Cw.to.keyword=function(t){return Aw[t.slice(0,3)]};var Rw={exports:{}},Ow=pw,Iw={};for(var Dw in Ow)Ow.hasOwnProperty(Dw)&&(Iw[Ow[Dw]]=Dw);var kw=Rw.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var Lw in kw)if(kw.hasOwnProperty(Lw)){if(!("channels"in kw[Lw]))throw new Error("missing channels property: "+Lw);if(!("labels"in kw[Lw]))throw new Error("missing channel labels property: "+Lw);if(kw[Lw].labels.length!==kw[Lw].channels)throw new Error("channel and label counts mismatch: "+Lw);var Fw=kw[Lw].channels,Nw=kw[Lw].labels;delete kw[Lw].channels,delete kw[Lw].labels,Object.defineProperty(kw[Lw],"channels",{value:Fw}),Object.defineProperty(kw[Lw],"labels",{value:Nw})}kw.rgb.hsl=function(t){var e,n,i=t[0]/255,r=t[1]/255,o=t[2]/255,s=Math.min(i,r,o),a=Math.max(i,r,o),h=a-s;return a===s?e=0:i===a?e=(r-o)/h:r===a?e=2+(o-i)/h:o===a&&(e=4+(i-r)/h),(e=Math.min(60*e,360))<0&&(e+=360),n=(s+a)/2,[e,100*(a===s?0:n<=.5?h/(a+s):h/(2-a-s)),100*n]},kw.rgb.hsv=function(t){var e,n,i,r,o,s=t[0]/255,a=t[1]/255,h=t[2]/255,l=Math.max(s,a,h),c=l-Math.min(s,a,h),u=function(t){return(l-t)/6/c+.5};return 0===c?r=o=0:(o=c/l,e=u(s),n=u(a),i=u(h),s===l?r=i-n:a===l?r=1/3+e-i:h===l&&(r=2/3+n-e),r<0?r+=1:r>1&&(r-=1)),[360*r,100*o,100*l]},kw.rgb.hwb=function(t){var e=t[0],n=t[1],i=t[2];return[kw.rgb.hsl(t)[0],1/255*Math.min(e,Math.min(n,i))*100,100*(i=1-1/255*Math.max(e,Math.max(n,i)))]},kw.rgb.cmyk=function(t){var e,n=t[0]/255,i=t[1]/255,r=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-i,1-r)))/(1-e)||0),100*((1-i-e)/(1-e)||0),100*((1-r-e)/(1-e)||0),100*e]},kw.rgb.keyword=function(t){var e=Iw[t];if(e)return e;var n,i,r,o=1/0;for(var s in Ow)if(Ow.hasOwnProperty(s)){var a=(i=t,r=Ow[s],Math.pow(i[0]-r[0],2)+Math.pow(i[1]-r[1],2)+Math.pow(i[2]-r[2],2));a<o&&(o=a,n=s)}return n},kw.keyword.rgb=function(t){return Ow[t]},kw.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,i=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)),100*(.2126*e+.7152*n+.0722*i),100*(.0193*e+.1192*n+.9505*i)]},kw.rgb.lab=function(t){var e=kw.rgb.xyz(t),n=e[0],i=e[1],r=e[2];return i/=100,r/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(n-i),200*(i-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},kw.hsl.rgb=function(t){var e,n,i,r,o,s=t[0]/360,a=t[1]/100,h=t[2]/100;if(0===a)return[o=255*h,o,o];e=2*h-(n=h<.5?h*(1+a):h+a-h*a),r=[0,0,0];for(var l=0;l<3;l++)(i=s+1/3*-(l-1))<0&&i++,i>1&&i--,o=6*i<1?e+6*(n-e)*i:2*i<1?n:3*i<2?e+(n-e)*(2/3-i)*6:e,r[l]=255*o;return r},kw.hsl.hsv=function(t){var e=t[0],n=t[1]/100,i=t[2]/100,r=n,o=Math.max(i,.01);return n*=(i*=2)<=1?i:2-i,r*=o<=1?o:2-o,[e,100*(0===i?2*r/(o+r):2*n/(i+n)),(i+n)/2*100]},kw.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,i=t[2]/100,r=Math.floor(e)%6,o=e-Math.floor(e),s=255*i*(1-n),a=255*i*(1-n*o),h=255*i*(1-n*(1-o));switch(i*=255,r){case 0:return[i,h,s];case 1:return[a,i,s];case 2:return[s,i,h];case 3:return[s,a,i];case 4:return[h,s,i];case 5:return[i,s,a]}},kw.hsv.hsl=function(t){var e,n,i,r=t[0],o=t[1]/100,s=t[2]/100,a=Math.max(s,.01);return i=(2-o)*s,n=o*a,[r,100*(n=(n/=(e=(2-o)*a)<=1?e:2-e)||0),100*(i/=2)]},kw.hwb.rgb=function(t){var e,n,i,r,o,s,a,h=t[0]/360,l=t[1]/100,c=t[2]/100,u=l+c;switch(u>1&&(l/=u,c/=u),i=6*h-(e=Math.floor(6*h)),0!=(1&e)&&(i=1-i),r=l+i*((n=1-c)-l),e){default:case 6:case 0:o=n,s=r,a=l;break;case 1:o=r,s=n,a=l;break;case 2:o=l,s=n,a=r;break;case 3:o=l,s=r,a=n;break;case 4:o=r,s=l,a=n;break;case 5:o=n,s=l,a=r}return[255*o,255*s,255*a]},kw.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,i=t[2]/100,r=t[3]/100;return[255*(1-Math.min(1,e*(1-r)+r)),255*(1-Math.min(1,n*(1-r)+r)),255*(1-Math.min(1,i*(1-r)+r))]},kw.xyz.rgb=function(t){var e,n,i,r=t[0]/100,o=t[1]/100,s=t[2]/100;return n=-.9689*r+1.8758*o+.0415*s,i=.0557*r+-.204*o+1.057*s,e=(e=3.2406*r+-1.5372*o+-.4986*s)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(i=Math.min(Math.max(0,i),1))]},kw.xyz.lab=function(t){var e=t[0],n=t[1],i=t[2];return n/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},kw.lab.xyz=function(t){var e,n,i,r=t[0];e=t[1]/500+(n=(r+16)/116),i=n-t[2]/200;var o=Math.pow(n,3),s=Math.pow(e,3),a=Math.pow(i,3);return n=o>.008856?o:(n-16/116)/7.787,e=s>.008856?s:(e-16/116)/7.787,i=a>.008856?a:(i-16/116)/7.787,[e*=95.047,n*=100,i*=108.883]},kw.lab.lch=function(t){var e,n=t[0],i=t[1],r=t[2];return(e=360*Math.atan2(r,i)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(i*i+r*r),e]},kw.lch.lab=function(t){var e,n=t[0],i=t[1];return e=t[2]/360*2*Math.PI,[n,i*Math.cos(e),i*Math.sin(e)]},kw.rgb.ansi16=function(t){var e=t[0],n=t[1],i=t[2],r=1 in arguments?arguments[1]:kw.rgb.hsv(t)[2];if(0===(r=Math.round(r/50)))return 30;var o=30+(Math.round(i/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===r&&(o+=60),o},kw.hsv.ansi16=function(t){return kw.rgb.ansi16(kw.hsv.rgb(t),t[2])},kw.rgb.ansi256=function(t){var e=t[0],n=t[1],i=t[2];return e===n&&n===i?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5)},kw.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},kw.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},kw.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},kw.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var i=parseInt(n,16);return[i>>16&255,i>>8&255,255&i]},kw.rgb.hcg=function(t){var e,n=t[0]/255,i=t[1]/255,r=t[2]/255,o=Math.max(Math.max(n,i),r),s=Math.min(Math.min(n,i),r),a=o-s;return e=a<=0?0:o===n?(i-r)/a%6:o===i?2+(r-n)/a:4+(n-i)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?s/(1-a):0)]},kw.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,i=1,r=0;return(i=n<.5?2*e*n:2*e*(1-n))<1&&(r=(n-.5*i)/(1-i)),[t[0],100*i,100*r]},kw.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,i=e*n,r=0;return i<1&&(r=(n-i)/(1-i)),[t[0],100*i,100*r]},kw.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,i=t[2]/100;if(0===n)return[255*i,255*i,255*i];var r,o=[0,0,0],s=e%1*6,a=s%1,h=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=h,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=h,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=h}return r=(1-n)*i,[255*(n*o[0]+r),255*(n*o[1]+r),255*(n*o[2]+r)]},kw.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),i=0;return n>0&&(i=e/n),[t[0],100*i,100*n]},kw.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,i=0;return n>0&&n<.5?i=e/(2*n):n>=.5&&n<1&&(i=e/(2*(1-n))),[t[0],100*i,100*n]},kw.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},kw.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,i=n-e,r=0;return i<1&&(r=(n-i)/(1-i)),[t[0],100*i,100*r]},kw.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},kw.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},kw.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},kw.gray.hsl=kw.gray.hsv=function(t){return[0,0,t[0]]},kw.gray.hwb=function(t){return[0,100,t[0]]},kw.gray.cmyk=function(t){return[0,0,0,t[0]]},kw.gray.lab=function(t){return[t[0],0,0]},kw.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},kw.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var Bw=Rw.exports;function Hw(t){var e=function(){for(var t={},e=Object.keys(Bw),n=e.length,i=0;i<n;i++)t[e[i]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var i=n.pop(),r=Object.keys(Bw[i]),o=r.length,s=0;s<o;s++){var a=r[s],h=e[a];-1===h.distance&&(h.distance=e[i].distance+1,h.parent=i,n.unshift(a))}return e}function jw(t,e){return function(n){return e(t(n))}}function zw(t,e){for(var n=[e[t].parent,t],i=Bw[e[t].parent][t],r=e[t].parent;e[r].parent;)n.unshift(e[r].parent),i=jw(Bw[e[r].parent][r],i),r=e[r].parent;return i.conversion=n,i}var Gw=Rw.exports,Uw=function(t){for(var e=Hw(t),n={},i=Object.keys(e),r=i.length,o=0;o<r;o++){var s=i[o];null!==e[s].parent&&(n[s]=zw(s,e))}return n},Vw={};Object.keys(Gw).forEach((function(t){Vw[t]={},Object.defineProperty(Vw[t],"channels",{value:Gw[t].channels}),Object.defineProperty(Vw[t],"labels",{value:Gw[t].labels});var e=Uw(t);Object.keys(e).forEach((function(n){var i=e[n];Vw[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var i=n.length,r=0;r<i;r++)n[r]=Math.round(n[r]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(i),Vw[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(i)}))}));var Ww=Vw,Xw=gw.exports,Zw=Ww,qw=[].slice,Yw=["keyword","gray","hex"],Kw={};Object.keys(Zw).forEach((function(t){Kw[qw.call(Zw[t].labels).sort().join("")]=t}));var Jw={};function Qw(t,e){if(!(this instanceof Qw))return new Qw(t,e);if(e&&e in Yw&&(e=null),e&&!(e in Zw))throw new Error("Unknown model: "+e);var n,i;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof Qw)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var r=Xw.get(t);if(null===r)throw new Error("Unable to parse color from string: "+t);this.model=r.model,i=Zw[this.model].channels,this.color=r.value.slice(0,i),this.valpha="number"==typeof r.value[i]?r.value[i]:1}else if(t.length){this.model=e||"rgb",i=Zw[this.model].channels;var o=qw.call(t,0,i);this.color=nT(o,i),this.valpha="number"==typeof t[i]?t[i]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var s=Object.keys(t);"alpha"in t&&(s.splice(s.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=s.sort().join("");if(!(a in Kw))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=Kw[a];var h=Zw[this.model].labels,l=[];for(n=0;n<h.length;n++)l.push(t[h[n]]);this.color=nT(l)}if(Jw[this.model])for(i=Zw[this.model].channels,n=0;n<i;n++){var c=Jw[this.model][n];c&&(this.color[n]=c(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function $w(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(Jw[t]||(Jw[t]=[]))[e]=n})),t=t[0],function(i){var r;return arguments.length?(n&&(i=n(i)),(r=this[t]()).color[e]=i,r):(r=this[t]().color[e],n&&(r=n(r)),r)}}function tT(t){return function(e){return Math.max(0,Math.min(t,e))}}function eT(t){return Array.isArray(t)?t:[t]}function nT(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}Qw.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in Xw.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return Xw.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return Xw.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=Zw[this.model].channels,n=Zw[this.model].labels,i=0;i<e;i++)t[n[i]]=this.color[i];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new Qw(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new Qw(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:$w("rgb",0,tT(255)),green:$w("rgb",1,tT(255)),blue:$w("rgb",2,tT(255)),hue:$w(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:$w("hsl",1,tT(100)),lightness:$w("hsl",2,tT(100)),saturationv:$w("hsv",1,tT(100)),value:$w("hsv",2,tT(100)),chroma:$w("hcg",1,tT(100)),gray:$w("hcg",2,tT(100)),white:$w("hwb",1,tT(100)),wblack:$w("hwb",2,tT(100)),cyan:$w("cmyk",0,tT(100)),magenta:$w("cmyk",1,tT(100)),yellow:$w("cmyk",2,tT(100)),black:$w("cmyk",3,tT(100)),x:$w("xyz",0,tT(100)),y:$w("xyz",1,tT(100)),z:$w("xyz",2,tT(100)),l:$w("lab",0,tT(100)),a:$w("lab",1),b:$w("lab",2),keyword:function(t){return arguments.length?new Qw(t):Zw[this.model].keyword(this.color)},hex:function(t){return arguments.length?new Qw(t):Xw.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var i=t[n]/255;e[n]=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return Qw.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),i=this.rgb(),r=void 0===e?.5:e,o=2*r-1,s=n.alpha()-i.alpha(),a=((o*s==-1?o:(o+s)/(1+o*s))+1)/2,h=1-a;return Qw.rgb(a*n.red()+h*i.red(),a*n.green()+h*i.green(),a*n.blue()+h*i.blue(),n.alpha()*r+i.alpha()*(1-r))}},Object.keys(Zw).forEach((function(t){if(-1===Yw.indexOf(t)){var e=Zw[t].channels;Qw.prototype[t]=function(){if(this.model===t)return new Qw(this);if(arguments.length)return new Qw(arguments,t);var n="number"==typeof arguments[e]?e:this.valpha;return new Qw(eT(Zw[this.model][t].raw(this.color)).concat(n),t)},Qw[t]=function(n){return"number"==typeof n&&(n=nT(qw.call(arguments),e)),new Qw(n,t)}}}));var iT=Qw;const rT="function"==typeof Object.assign;function oT(t){if(rT)Object.assign.apply(Object,arguments);else for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function sT(t){return null==t}const aT=[];function hT(t,e){const n=e._get2DExtentAtRes(e.getGLRes()),i=n.getWidth(),r=n.getHeight(),o=t;return $t(o),oe(o,o,e.cameraLookAt),se(o,o,Ze(aT,i,r,1)),o}const lT={};function cT(t,e){if(!Array.isArray(e)){const t=e;e=lT[t]=lT[t]||iT(e).array()}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}function uT(t,e){if(Array.isArray(e))for(let n=0;n<e.length;n++)t[n]=255*e[n];else{const n=e;e=lT[n]=lT[n]||iT(e).array();for(let i=0;i<e.length;i++)t[i]=e[i]}return 3===t.length&&t.push(255),t}const fT=[0,0],dT=[0,0,0];let mT;class gT{static getUniformDeclares(){const t=[],e=[];return e.push({name:"shadow_lightProjViewModelMatrix",type:"function",fn:function(e,n){const i=n.shadow_lightProjViewMatrix,r=n.modelMatrix;return re(t,i,r)}}),e.push("shadow_shadowMap","shadow_opacity","esm_shadow_threshold","shadow_color","shadow_nearFar"),e}constructor(t,e,n){this.renderer=new Ta(t),this.sceneConfig=e,this.t=.3,this.i=n,this.s()}resize(){const t=this.canvas;t.width=this.i.getRenderer().canvas.width,t.height=this.i.getRenderer().canvas.height}s(){const t=this.sceneConfig.shadow||{};let e=512;const n=t.quality;"high"===n?e=2048:"medium"===n&&(e=1024);const i=this.getDefines();this.h=new kb(this.renderer,{width:e,height:e,blurOffset:t.blurOffset,defines:i}),this.o=new Lb(i),this.u()}getDefines(){return{HAS_SHADOWING:1,PACK_FLOAT:1,USE_ESM:1}}render(t,e,n,i,r,o,s,a,h,l){this.p();const c=this.i.getMap();let u,f;if(l||this.m(c,s,!!t)){this.v=this.v||[],this._=this._||[];const i=re(this.v,e,n),r=un(this._,o);mT||(mT=c.getContainerExtent());let a=c.height;c.getPitch()>62&&(a=c._getVisualHeight(62));const h=mT.set(0,c.height-a,c.width,c.height).convertTo((t=>c._containerPointToPointAtRes(t,c.getGLRes()))).toArray();t&&s.addMesh(this.M);const l=h.map((t=>[t.x,t.y,0,1])),{lightProjViewMatrix:d,shadowMap:m,blurFBO:g}=this.h.render(s,{cameraProjViewMatrix:i,lightDir:r,farPlane:l,cameraLookAt:c.cameraLookAt});u=this.C=d,f=this.S=m,this.T=g,this.O=s.getMeshes().reduce(((t,e)=>(e.castShadow&&(t[e.uuid]={v0:e.version,v1:e.geometry.version}),t)),{}),this.k={count:s.getMeshes().length-+!!t,displayShadow:!!t},this.A=!0}else u=this.C,f=this.S,this.A=!1;return this.L=e,this.F=n,t&&s.getMeshes().length&&this.displayShadow(i,r,a,h),{shadow_lightProjViewMatrix:u,shadow_shadowMap:f,shadow_opacity:r,shadow_color:i,esm_shadow_threshold:this.t}}displayShadow(t,e,n,i){const r=this.C,o=this.M,s=this.I||[],a=this.i.getRenderer().canvas,h=this.P=this.P||[];h[0]=a.width,h[1]=a.height,this.renderer.render(this.o,{halton:n||fT,globalTexSize:h,projMatrix:this.L,viewMatrix:this.F,shadow_lightProjViewModelMatrix:re(s,r,o.localTransform),shadow_shadowMap:this.S,esm_shadow_threshold:this.t,shadow_opacity:e,color:t||dT},this.R,i)}dispose(){this.h.dispose(),this.o.dispose(),this.M&&(this.M.geometry.dispose(),this.M.dispose()),delete this.renderer}isUpdated(){return!1!==this.A}m(t,e,n){if(!this.O)return!0;const i=this.k;if(e.getMeshes().length!==i.count||n!==i.displayShadow)return!0;const r=e.getMeshes();for(let o=0;o<r.length;o++){const t=this.O[r[o].uuid];if(r[o].castShadow&&(r[o].hasSkinAnimation()||!t||t.v0!==r[o].version||t.v1!==r[o].geometry.version))return!0}return!1}u(){const t=new Sh;t.generateBuffers(this.renderer.regl),this.M=new Ya(t),this.R=new nh([this.M])}p(){const t=this.i.getMap(),e=hT(this.M.localTransform,t);this.M.setLocalTransform(e)}}const{createIBLTextures:pT,disposeIBLTextures:_T,getPBRUniforms:vT}=tw.PBRUtils,yT=[0,0],xT=[1,1];class bT{static getGroundTransform(t,e){return hT(t,e)}constructor(t,e){this.H=t,this.renderer=new Ta(t),this.i=e,this.D=new Qa,this.j=this.N.bind(this),this.s()}needToRedraw(){const t=this.G();return t&&(t[0]||t[1])}getMap(){return this.i&&this.i.getMap()}getSymbol(){const t=this.i.getGroundConfig();return t&&t.symbol}isEnable(){const t=this.i.getGroundConfig();return t&&t.enable}paint(t){if(!this.isEnable())return!1;const e=this.B();if(this.V(t)&&e===this.U)return!1;const n=this.W(t);n&&this.M.setDefines(n),this.M.material!==this.material&&this.M.setMaterial(this.material);const i=this.i.getGroundConfig();(i&&i.symbol).ssr?this.M.ssr=1:this.M.ssr=0,this.p();const r=this.q(t);r.offsetFactor=t.offsetFactor,r.offsetUnits=t.offsetUnits;const o=t&&t.renderTarget&&t.renderTarget.fbo;return e===this.U?(this.renderer.render(e,r,this.R,o),this.i.getRenderer().setCanvasUpdated(),!0):(e.filter=t.sceneFilter,this.renderer.render(e,r,this.R,o),this.i.getRenderer().setCanvasUpdated(),!0)}V(t){return!!(this.i.getRenderer().isEnableSSR&&this.i.getRenderer().isEnableSSR()&&t&&t.ssr)}update(){const t=this.i.getGroundConfig();if(!t)return;const e=t&&t.symbol;if(e){this.$=this.X(e.polygonFill||[1,1,1,1]),this.J=void 0===e.polygonOpacity?1:e.polygonOpacity;const t=e.polygonPatternFile;if(t){if(!this.Y||this.Y._pattern_src!==t){const e=new Image;e.onload=()=>{this.Y&&this.Y.destroy(),this.Y=this.K(e),this.Y._pattern_src=t},e.src=t}}else this.Y&&(this.Y.destroy(),delete this.Y)}else this.$=[1,1,1,1],this.J=1,this.Y&&(this.Y.destroy(),delete this.Y);this.Z()}setToRedraw(){const t=this.i.getRenderer();t&&t.setToRedraw()}dispose(){this.material&&(this.material.dispose(),delete this.material),this.M&&(this.M.geometry.dispose(),this.M.material&&this.M.material.dispose(),this.M.dispose(),delete this.M),this.Y&&(this.Y.destroy(),delete this.Y),this.U&&(this.U.dispose(),delete this.U),this.tt&&(this.tt.dispose(),delete this.tt),this.it(),this.et&&(this.et.destroy(),delete this.et);const t=this.getMap();t&&t.off("updatelights",this.st,this)}B(){const t=this.i.getGroundConfig();if(!t||!t.renderPlugin)return this.U;const e=t.renderPlugin.type;if("lit"===e)return this.tt;if("fill"===e)return this.U;throw new Error("unsupported render plugin of "+e+" for layer ground")}q(t){const e=this.nt(t);return e.polygonFill=this.$,e.polygonOpacity=this.J,this.B()===this.U&&this.Y&&(e.polygonPatternFile=this.Y),e}nt(t){let e;return"lit"===this.i.getGroundConfig().renderPlugin.type?(this.rt||(this.rt=pT(this.H,this.getMap())),e=vT(this.getMap(),this.rt,this.et,t&&t.ssr,t&&t.jitter)):e={projViewMatrix:this.getMap().projViewMatrix},this.ht(e,t),e}ht(t,e){const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&oT(t,e[i].renderUniforms)}it(){this.rt&&(_T(this.rt),delete this.rt)}s(){this.getMap().on("updatelights",this.st,this);const t=this.ot(),e=gT.getUniformDeclares(),n=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return re(n,e.projViewMatrix,e.modelMatrix)}}),this.U=new jh({vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\n#ifdef HAS_PATTERN\n    attribute vec2 aTexCoord;\n    uniform vec2 uvScale;\n    uniform vec2 uvOffset;\n    varying vec2 vTexCoord;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_vert>\n#endif\nvoid main () {\n    #ifdef HAS_PATTERN\n        vTexCoord = aTexCoord * uvScale + uvOffset;\n    #endif\n    vec3 position = vec3(aPosition);\n    gl_Position = projViewModelMatrix * vec4(position, 1.0);\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        shadow_computeShadowPars(vec4(position, 1.0));\n    #endif\n}",frag:"precision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n    uniform sampler2D polygonPatternFile;\n    varying vec2 vTexCoord;\n#endif\nuniform vec4 polygonFill;\nuniform float polygonOpacity;\nvoid main() {\n    #ifdef HAS_PATTERN\n        vec4 color = texture2D(polygonPatternFile, vTexCoord);\n    #else\n        vec4 color = polygonFill;\n    #endif\n    gl_FragColor = color * polygonOpacity;\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        float shadowCoeff = shadow_computeShadow();\n        gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, shadowCoeff);\n    #endif\n}",uniforms:e,extraCommandProps:t});const i=gT.getUniformDeclares();i.push(...gl.getUniformDeclares()),this.tt=new tw.StandardShader({uniforms:i,extraCommandProps:t}),this.u(),this.et=tw.PBRHelper.generateDFGLUT(this.H),this.update()}ot(){const t=[0,1],e=this.i.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},depth:{enable:!0,mask:()=>{const t=this.i.getGroundConfig();return t.depth||void 0===t.depth},range:()=>{const e=this.i.getGroundConfig(),n=e&&e.renderPlugin.sceneConfig;return n&&n.depthRange||t},func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:{factor:(t,e)=>e.offsetFactor,units:(t,e)=>e.offsetUnits}}}}lt(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}u(){const t=new Sh;t.data.aTexCoord=new Uint8Array([0,1,1,1,0,0,1,0]),t.createTangent(),t.generateBuffers(this.renderer.regl),this.M=new Ya(t,null,{castShadow:!1});const e=this.tt.getGeometryDefines(t);this.M.setDefines(e),this.R=new nh([this.M])}p(){const t=this.getMap(),e=bT.getGroundTransform(this.M.localTransform,t);this.M.setLocalTransform(e);const n=t._get2DExtentAtRes(t.getGLRes()),i=n.getWidth(),r=n.getHeight(),o=t.cameraLookAt,s=o[0]-i,a=o[1]+r;let h=this.material&&this.material.get("uvOffset")||yT;h[0]=h[0]||0,h[1]=h[1]||0;const l=this.G(),c=this.material&&this.material.get("noiseTexture"),u=l&&(l[0]||l[1]);if(u){h=[h[0],h[1]];const t=performance.now(),e=c?5e4:1e3,n=c?256:1;l[0]&&(h[0]=t*l[0]%e/e*n),l[1]&&(h[1]=t*l[1]%e/e*n)}const f=this.material&&this.material.get("uvScale")||xT,d=.5/f[0],m=.5/f[1],g=n.getWidth()/d*2,p=n.getHeight()/m*2;if(this.M.setUniform("uvScale",[g,-p]),u&&c){const t=[s-(l[0]?h[0]:0),a+(l[1]?h[1]:0)],e=t[0]/d%1,n=t[1]/m%1,i=[t[0]/d-e,t[1]/m-n];this.M.setUniform("uvOffset",[e+(l[0]?0:h[0]),n+(l[1]?0:h[1])]),this.M.setUniform("uvOrigin",i)}else{const t=s/d%1,e=a/m%1,n=[s/d-t,a/m-e];this.M.setUniform("uvOffset",[t+h[0],e+h[1]]),this.M.setUniform("uvOrigin",n)}}W(t){let e=!1;const n=this.M.defines,i=this.i.ct&&this.i.ct(),r=this.i.getGroundConfig();function o(t,i){t?n[i]||(n[i]=1,e=!0):n[i]&&(delete n[i],e=!0)}o(this.lt(),"HAS_IBL_LIGHTING"),o(t&&t.ssr&&r&&r.symbol&&r.symbol.ssr,"HAS_SSR");const s=t&&i&&i.shadow&&i.shadow.enable;return o(s,"HAS_SHADOWING"),o(s,"USE_ESM"),o(!!this.Y,"HAS_PATTERN"),o(t&&t.ssao,"HAS_SSAO"),e?n:null}Z(){const t=this.getSymbol()&&this.getSymbol().material;if(!t)return;const e={};let n=!1;for(const o in t)if(i=t,r=o,Object.prototype.hasOwnProperty.call(i,r))if(o.indexOf("Texture")>0){let i=t[o];if(!i)continue;i="string"==typeof i?{url:i,wrap:"repeat"}:i,i.flipY=!0,i.min="linear",i.mag="linear",i.flipY=!0,e[o]=new Eh(i,this.D),n=!0}else e[o]=t[o];var i,r;this.material?(this.ut=new tw.StandardMaterial(e),this.ut.isReady()?this.N():this.ut.once("complete",this.j)):(this.material=new tw.StandardMaterial(e),this.material.once("complete",this.j,this)),n||this.N()}N(){this.ut&&(this.material.dispose(),this.material=this.ut,delete this.ut),this.setToRedraw(!0)}K(t){const e=this.H,n={width:t.width,height:t.height,data:t,mag:"linear",min:"linear",flipY:!1,wrap:"repeat"};return e.texture(n)}st(t){if(t.ambientUpdate){this.it();const t=this.getMap();t&&(this.rt=pT(this.H,t))}this.setToRedraw()}X(t){return cT([],t)}G(){return this.material&&this.material.get("uvOffsetAnim")}getRenderMeshes(){return this.R.getMeshes()}}const{createIBLTextures:wT,disposeIBLTextures:TT}=tw.PBRUtils,MT=[0,0,0],AT=[],ET=[];class CT{constructor(t,e){this.ft=4,this.H=t,this.renderer=new Ta(t),this.i=e,this.s(),this.dt()}paint(t){if(!this.isEnable()||!this.gt)return;const e=this.q(t),n=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.pt,e,null,n)}update(){const t=this.getMap();if(!t||!this.isEnable())return;const e=t.getLightManager(),n=e&&e.getAmbientResource();n!==this.gt&&this.rt&&(TT(this.rt),delete this.rt),this.gt=n,this.dt()}dispose(){this.pt.dispose(),TT(this.rt),delete this.pt,delete this.rt,delete this.gt}getMap(){return this.i.getMap()}dt(){if(!this.gt)return;const t=this.i.ct();this.pt.setMode(1,0,t.environment&&t.environment.mode?1:0)}isEnable(){const t=this.i.ct();return this.lt()&&t&&t.environment&&t.environment.enable}lt(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}q(){const t=this.getMap(),e=this.getMap().getLightManager().getAmbientLight();let n=this.rt;n||(n=this.rt=wT(this.H,t));const i=this.i.getRenderer().canvas,r=this.i.ct().environment||{},o=r.level||0,s=n.prefilterMap.width,a=this.vt=this.vt||[],h=e&&e.hsv||MT,l=r.brightness||0;return Xe(AT,h),l&&(AT[2]+=l),ET[0]=i.width,ET[1]=i.height,{rgbmRange:n.rgbmRange,cubeMap:n.prefilterMap,bias:o,size:s/Math.pow(2,Math.max(0,o-1)),environmentExposure:(c=e.exposure,"number"!=typeof c||isNaN(c)?1:e.exposure),diffuseSPH:n.sh,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,resolution:ET,hsv:AT,transformMatrix:Ot(a,Math.PI/180*-e.orientation||0)};var c}s(){const t=this.getMap();if(t.on("updatelights",this.update,this),this.pt=new yl,t.options.lights){const t=this.getMap().getLightManager().getAmbientResource();this.gt=t}}}const ST=[],PT=[.03,.03,.03],RT=[],OT=[],IT=[],DT=[1,1,1],kT=[-1200,-1200,0],LT=[1200,1200,1e3],FT={min:[],max:[]},NT=_e([],Bi([],90,0,0),[0,0,0]);class BT{constructor(t,e){this.H=t,this.renderer=new Ta(t),this.i=e,this.wt=new HT,this.s()}getMap(){return this.i&&this.i.getMap()}s(){const t=this.i.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this.pt=new jh({vert:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform vec3 cameraPosition;\nuniform float top;\nuniform float bottom;\nuniform float time;\nvarying vec2 vTexCoord;\n#include <get_output>\nfloat angle(float x, float y){\n    return atan(y, x);\n}\nvec2 getFoot(vec2 camera, vec2 normal, vec2 pos) {\n    vec2 position = vec2(0.0, 0.0);\n    float distanceLen = distance(pos, normal);\n    float a = angle(camera.x - normal.x, camera.y - normal.y);\n    pos.x > normal.x ? a -= 0.785 : a += 0.785;\n    position.x = cos(a) * distanceLen;\n    position.y = sin(a) * distanceLen;\n    return position + normal;\n    return position;\n}\nvoid main()\n{\n    vec4 localPosition = getPosition(aPosition);\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.z), vec2(aNormal.x, aNormal.z), vec2(localPosition.x, localPosition.z));\n    float height = top - bottom;\n    float y = aNormal.y - bottom - height * time;\n    y = y + (y < 0.0 ? height : 0.0);\n    float ratio = (1.0 - y / height) * (1.0 - y / height);\n    y = height * (1.0 - ratio);\n    y += bottom;\n    y += aPosition.y - aNormal.y;\n    localPosition = vec4( foot.x, y, foot.y , 1.0);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D rainMap;\nvoid main() {\n    vec4 rainColor = texture2D(rainMap, vTexCoord);\n    vec4 diffuseColor = vec4(diffuse, opacity);\n    diffuseColor *= rainColor;\n    gl_FragColor = diffuseColor;\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return re(ST,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e,depth:{enable:!0,mask:!1,func:"less",range:[0,1]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this.bt()}bt(){const t=this.H.texture({width:2,height:2});if(this._t=this.Mt(),!this._t)return;this.xt=new nh(this._t);const e=this.yt();e.rainTexture?this.Ct(e.rainTexture).then((t=>{this._t.material.set("rainMap",t)})):(this._t.material.set("rainMap",t),console.warn("should set rain texture."))}Mt(){const t=this.getMap(),e=this.yt();if(!e)return;this.St=t.getZoom();const n=this.Tt(),i=this.Ot=e.density,r=this.kt=e.rainWidth||1,o=this.At=e.rainHeight||1,s=[],a=[],h=[],l=[];for(let m=0;m<i;m++){const t={};t.x=Math.random()*(n.max[0]-n.min[0])+n.min[0],t.y=Math.random()*(n.max[2]-n.min[2])+n.min[2],t.z=Math.random()*(n.max[1]-n.min[1])+n.min[1];const e=(n.max[2]-n.min[2])/37.5*o,i=e/3*r;s.push(t.x+i,t.y+e,t.z,t.x-i,t.y+e,t.z,t.x-i,t.y,t.z,t.x+i,t.y,t.z),a.push(t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z),h.push(1,1,0,1,0,0,1,0),l.push(4*m+0,4*m+1,4*m+2,4*m+0,4*m+2,4*m+3)}const c={};c.POSITION=s,c.NORMAL=a,c.TEXCOORD_0=h;const u=new La(c,l,0,{primitive:"triangles",positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});u.generateBuffers(this.renderer.regl);const f=new Na({rainMap:this.H.texture({width:2,height:2}),diffuse:e.color||[1,1,1],opacity:e.opacity||1}),d=new Ya(u,f);return d.setUniform("top",n.max[2]),d.setUniform("bottom",n.min[2]),this.Lt(d),d.transparent=!0,d}Ct(t){const e=new Image;return e.src=this.Et=t,new Promise(((t,n)=>{e.onload=()=>{const n=this.H.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"clamp",wrapT:"clamp",data:e});t(n)},e.onerror=t=>{n(t)}}))}paint(t){if(!this.xt)return;const e=this.yt(),n={},i=this.getMap();n.projMatrix=i.projMatrix,n.viewMatrix=i.viewMatrix,n.cameraPosition=i.cameraPosition;const r=e.speed||1,o=this.wt.getElapsedTime()/(2/r)%1;n.time=o,this._t.material.set("diffuse",e.color||DT),this._t.material.set("opacity",e.opacity||1),this.Lt(this._t);const s=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.pt,n,this.xt,s),this.i.getRenderer().setCanvasUpdated()}Lt(t){const e=this.getMap(),n=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes());let i=e.getGLScale()/e.getGLScale(this.St);const r=Ze(OT,i,i,i),o=Ke(r,PT,r),s=$t(IT),a=this.yt(),h=e.getBearing();we(s,Bi(RT,a.windDirectionX||0,a.windDirectionY||0,90-h),[n.x,n.y,0],o),re(s,s,NT),t.setLocalTransform(s)}setToRedraw(){const t=this.i.getRenderer();t&&t.setToRedraw()}update(){const t=this.yt();if(t){if(this._t||this.bt(),t.density!==this.Ot||t.rainWidth!==this.kt||t.rainHeight!==this.At){const t=this._t.material.get("rainMap");this._t.geometry.dispose(),this._t.dispose(),this.xt.clear(),this._t=this.Mt(),this._t.material.set("rainMap",t),this.xt.setMeshes(this._t)}t.rainTexture!==this.Et&&this.Ct().then((t=>{this._t.material.set("rainMap",t)}))}}dispose(){this._t&&(this._t.geometry.dispose(),this._t.material&&this._t.material.dispose(),this._t.dispose(),delete this._t),this.pt&&(this.pt.dispose(),delete this.pt)}isEnable(){const t=this.yt();return t&&t.enable}yt(){const t=this.i.getWeatherConfig();return t&&t.rain}Tt(){const t=16.685648411389433-this.getMap().getZoom();return rn(FT.min,kT,Math.pow(2,t)),rn(FT.max,LT,Math.pow(2,t)),FT}}class HT{constructor(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){let e=("undefined"==typeof performance?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}}}const jT=[],zT=[.03,.03,.03],GT=[],UT=[],VT=[],WT=_e([],Bi([],90,0,0),[0,0,0]);class XT{constructor(t,e){this.H=t,this.i=e,this.s()}s(){const t=this.i.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this.pt=new jh({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <get_output>\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 localPosition = getPosition(aPosition);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nprecision mediump float;\nuniform sampler2D perlinTexture;\nvarying vec2 vTexCoord;\nfloat lerp(float a, float b, float w) {\n    return a + w * (b - a);\n}\nvoid main() {\n    float snowIntense = texture2D(perlinTexture, vTexCoord).r;\n    vec3 fixedC = vec3(1.0, 1.0, 1.0);\n    float r = lerp(0.5, fixedC.x, snowIntense);\n    float g = lerp(0.5, fixedC.y, snowIntense);\n    float b = lerp(0.5, fixedC.z, snowIntense);\n    glFragColor = vec4(r, g, b, 1.0);\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return re(jT,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e}}),this.pt.version=300,this.xt=new nh,this.Ft=this.It(),this.xt.setMeshes(this.Ft),this.renderer=new Ta(this.H);const n=this.Pt();n&&(n.snowGroundTexture?this.Rt(n.snowGroundTexture):(this.Ht=this.H.texture({width:2,height:2}),console.warn("should set snow ground texture.")))}render(t){this.Ht&&this.Ft.material.set("perlinTexture",this.Ht);const e=this.i.getMap();this.Dt(e);const n={projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition},i=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.pt,n,this.xt,i),this.i.getRenderer().setCanvasUpdated()}Dt(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes());let n=t.getGLScale()/t.getGLScale(this.St);const i=Ze(UT,n,n,n),r=Ke(i,zT,i),o=$t(VT);we(o,Bi(GT,0,0,0),[e.x,e.y,.005],r),re(o,o,WT),this.Ft.setLocalTransform(o)}Rt(t){const e=new Image;e.onload=()=>{this.Ht=this.H.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"repeat",wrapT:"repeat",data:e})},e.onerror=t=>{console.log(t)},e.src=this.jt=t}It(){const t=this.i.getMap();this.St=t.getZoom();const e=16e3*Math.pow(2,16.685648411389433-this.St),n=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],i={};i.POSITION=n,i.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],i.TEXCOORD_0=[0,0,1,0,0,1,1,1];const r=new La(i,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});r.generateBuffers(this.H);const o=new Na({perlinTexture:this.H.texture({with:2,height:2})});return new Ya(r,o)}getMeshes(){return this.Ft}dispose(){this.Ft&&(this.Ft.geometry.dispose(),this.Ft.material&&this.Ft.material.dispose(),this.Ft.dispose(),delete this.Ft),this.pt&&(this.pt.dispose(),delete this.pt)}update(){const t=this.Pt();t&&t.snowGroundTexture===!this.jt&&this.Rt(t.snowGroundTexture)}isEnable(){const t=this.yt();return t&&t.enable}Pt(){const t=this.i.getWeatherConfig();return t&&t.snow}}const ZT=[];class qT{constructor(t,e,n){this.H=t,this.i=e,this.Nt=n,this.s()}s(){this.renderer=new Ta(this.H);const t=this.i.getRenderer(),e=this.Gt={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this.Bt=e.width,this.Vt=e.height,this.Ut=this.H.framebuffer({color:this.H.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this.H.texture({with:2,height:2}),this.zt=new BT(this.H,this.i),this.Wt=new Il(this.H,e),this.qt=new XT(this.H,this.i),this.$t=new Ml(this.H,e),this.Xt=new Al,this.Xt.version=300}getMap(){return this.i&&this.i.getMap()}renderScene(t){this.renderSnowMask(t),this.renderRain(t)}renderRain(t){this.isEnableRain()&&this.zt.paint(t)}renderSnowMask(t){if(!this.isEnableSnow())return;const e=this.getMap();this.qt.render(t,e)}paint(t,e){if(!e||!e.length)return t;this.Jt();const n=this.i.getWeatherConfig(),i={};if(this.isEnableRain()?(i.ripplesMap=this.Yt(),this.Xt.shaderDefines.HAS_RAIN=1):delete this.Xt.shaderDefines.HAS_RAIN,this.isEnableSnow()?(this.Xt.shaderDefines.HAS_SNOW=1,e.forEach((t=>{t.defines.HAS_SNOW=1}))):(delete this.Xt.shaderDefines.HAS_SNOW,e.forEach((t=>{delete t.defines.HAS_SNOW}))),this.isEnableFog()){const t=n.fog;i.fogColor=t.color||[.9,.9,.9],this.Xt.shaderDefines.HAS_FOG=1}else delete this.Xt.shaderDefines.HAS_FOG;return this.Xt.setDefines(this.Xt.shaderDefines),i.mixFactorMap=this.Kt(e)||this.EMPTY_TEXTURE,i.sceneMap=t,i.time=this.Zt()/1e3,i.resolution=no(ZT,this.Ut.width,this.Ut.height),this.renderer.render(this.Xt,i,null,this.Ut),this.Ut}Kt(t){const e={},n=this.getMap(),i=n.getZoom(),r=Math.pow(2,16.685648411389433-i),o=this.i.getWeatherConfig().fog;if(!o)return;const s=o.start||.1,a=o.end||100;return e.projMatrix=n.projMatrix,e.viewMatrix=n.viewMatrix,e.cameraPosition=n.cameraPosition,e.fogDist=[s*r,a*r],this.$t.render(t,e)}Yt(){const t=this.getMap(),e=this.i.getWeatherConfig(),n=e.rain.rippleRadius||24,i={};return i.projMatrix=t.projMatrix,i.viewMatrix=t.viewMatrix,i.time=this.Zt()/1e3,i.rippleRadius=n,i.density=e.rain.density||2e3,this.Wt.render(t,i)}Zt(){return this.i?this.i.getRenderer().getFrameTime():0}isEnable(){const t=this.i.getWeatherConfig();return t&&t.enable}isEnableRain(){const t=this.i.getWeatherConfig();return t&&t.enable&&t.rain&&t.rain.enable}isEnableFog(){const t=this.i.getWeatherConfig();return t&&t.enable&&t.fog&&t.fog.enable}isEnableSnow(){const t=this.i.getWeatherConfig();return t&&t.enable&&t.snow&&t.snow.enable}Qt(){return this.isEnableRain()||this.isEnableFog()||this.isEnableSnow()}update(){this.isEnableRain()&&(this.zt=this.zt||new BT(this.H,this.i),this.zt.update()),this.isEnableSnow()&&(this.qt=this.qt||new XT(this.H,this.i),this.qt.update())}getShadowMeshes(){return this.qt.getMeshes()}Jt(){const t=this.Bt(),e=this.Vt();!this.Ut||this.Ut.width===t&&this.Ut.height===e||this.Ut.resize(t,e)}dispose(){this.Ut&&this.Ut.destroy(),this.Xt&&(this.Xt.dispose(),delete this.Xt),this.zt&&(this.zt.dispose(),delete this.zt),this.qt&&(this.qt.dispose(),delete this.qt)}}const YT=[],KT=t=>!!t.bloom,JT=t=>!!t.ssr;class QT{constructor(t,e,n){this.H=t,this.i=e,this.ti=new Ta(t),this.ii=new Jh,this.ei=new al(this.ti,n),this.si=new wl,this.ni=new gl(this.H)}setContextIncludes(){}bloom(t,e,n,i,r,o,s){this.ri||(this.ri=new dl(this.H));const a=this.i.getRenderer().hi(this.oi);return this.ri.render(t,a,i,r,o,e,n,s)}drawBloom(t){const e=this.i.getRenderer(),n=this.H,i=this.oi;if(i){const{width:e,height:r}=t;i.width===e&&i.height===r||i.resize(e,r),n.clear({color:[0,0,0,0],framebuffer:i})}else{const e=this.ai(t);this.oi=n.framebuffer(e)}const r=e.getFrameTime(),o=e.getFrameEvent(),s=e.getFrameContext(),a=s.renderMode,h=s.sceneFilter,l=s.renderTarget;s.renderMode="default",s.sceneFilter=KT,s.renderTarget={fbo:this.oi,getFramebuffer:$T,getDepthTexture:tM};const c=e.glCtx;return c.resetDrawCalls(),o?e.forEachRenderer((t=>{e.clearStencil(t,i),t.drawOnInteracting(o,r,s)})):e.forEachRenderer((t=>{e.clearStencil(t,i),t.draw(r,s)})),s.renderMode=a,s.sceneFilter=h,s.renderTarget=l,c.getDrawCalls()}genSsrMipmap(t,e){const n=this.i.getMap().projViewMatrix;this.ni.genMipMap(t,e,n)}getPrevSsrProjViewMatrix(){return this.ni&&this.ni.getPrevProjViewMatrix()}drawSSR(t,e,n){n&&this.ni.copyDepthTex(t);const i=this.i.getRenderer(),r=i.getFrameTime(),o=i.getFrameEvent(),s=i.getFrameContext();s.ssr=this.getSSRContext();const a=s.renderMode,h=s.sceneFilter;s.renderMode="default",s.sceneFilter=JT,s.renderTarget.fbo=e;const l=i.glCtx;let c=!1;o?i.forEachRenderer((t=>{i.clearStencil(t,e),c||(l.resetDrawCalls(),c=!0),t.drawOnInteracting(o,r,s)})):i.forEachRenderer((t=>{i.clearStencil(t,e),c||(l.resetDrawCalls(),c=!0),t.draw(r,s)}));const u=i.drawGround();return delete s.ssr,s.renderMode=a,s.sceneFilter=h,this.li=l.getDrawCalls()>0,u}getSSRUniforms(){const t=this.i.ct(),e=t&&t.postProcess,n=this.i.getMap();return this.ni.getSSRUniforms(n,e.ssr.factor,e.ssr.quality)}getSSRContext(){const t=this.i.ct(),e=t&&t.postProcess,n=this.i.getMap(),i=this.ni.getSSRUniforms(n,e.ssr.factor,e.ssr.quality);return i?{renderUniforms:i,defines:{HAS_SSR:1}}:null}taa(t,e,{projMatrix:n,needClear:i}){const r=this.ei;return{outputTex:r.render(t,e,n,i),redraw:r.needToRedraw()}}isTaaNeedRedraw(){return this.ei.needToRedraw()}ssao(t,e,n){return this.ci||(this.ci=new il(this.ti),this.i.getRenderer().setToRedraw()),this.ci.render({projMatrix:n.projMatrix,cameraNear:n.cameraNear,cameraFar:n.cameraFar,bias:n.ssaoBias,radius:n.ssaoRadius,intensity:n.ssaoIntensity,quality:.6},t,e)}fxaa(t,e,n,i,r,o,s,a,h,l,c,u,f,d,m,g){!t||t.width===e.fbo&&t.height===e.height||t.resize(e.width,e.height);const p={};r?p.HAS_TAA_TEX=1:delete p.HAS_TAA_TEX,o?p.HAS_FXAA_TEX=1:delete p.HAS_FXAA_TEX,u?p.HAS_OUTLINE_TEX=1:delete p.HAS_OUTLINE_TEX,n?p.HAS_NOAA_TEX=1:delete p.HAS_NOAA_TEX,i?p.HAS_POINT_TEX=1:delete p.HAS_POINT_TEX,this.ii.setDefines(p),this.ti.render(this.ii,{textureSource:e,noAaTextureSource:n,pointTextureSource:i,taaTextureSource:r,fxaaTextureSource:o,resolution:no(YT,e.width,e.height),enableFXAA:s,enableToneMapping:a,enableSharpen:h,pixelRatio:l,sharpFactor:c,textureOutline:u,highlightFactor:f,outlineFactor:d,outlineWidth:m,outlineColor:g},null,t)}renderFBOToScreen(t,e,n,i){this.ui||(this.ui=[]),this.ui[0]=t.width,this.ui[1]=t.height;const r=this.i.getRenderer();this.ti.render(this.si,{texture:t.color&&r.hi(t)||t,size:this.ui,enableSharpen:+!!e,sharpFactor:n,pixelRatio:i})}postprocess(t,e,n){this.fi||(this.fi=new rl);const i=this.i.getRenderer(),r=n||i.hi(t);return e.resolution=no(YT,r.width,r.height),e.textureSource=r,e.timeGrain=performance.now(),this.ti.render(this.fi,e),this.di}dispose(){this.oi&&(this.oi.destroy(),delete this.oi),this.ei&&(this.ei.dispose(),delete this.ei),this.ci&&(this.ci.dispose(),delete this.ci),this.ri&&(this.ri.dispose(),delete this.ri),this.fi&&(this.fi.dispose(),delete this.fi),this.ii&&(this.ii.dispose(),delete this.ii),this.si&&(this.si.dispose(),delete this.si)}ai(t,e){const{width:n,height:i}=this.i.getRenderer().canvas,r=this.H;let o;o=this.i.getRenderer().gi()?r.renderbuffer({width:n,height:i,samples:this.i.options.multiSamples,format:"rgba8"}):r.texture({min:"nearest",mag:"nearest",format:e||"rgba",width:n,height:i});const s={width:n,height:i,colors:[o]};return t&&(s.depthStencil=t),s}}function $T(t){return t._framebuffer.framebuffer}function tM(t){return t.depthStencil._texture.texture}class eM extends Kh{constructor(t){super({vert:"#if __VERSION__ == 300\n\t#define attribute in\n\t#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main()\n{\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_FLOODANALYSE\n    uniform vec3 flood_waterColor;\n    uniform float flood_waterOpacity;\n    uniform sampler2D floodMap;\n#endif\n#ifdef HAS_SKYLINE\n    uniform sampler2D skylineMap;\n#endif\n#ifdef HAS_VIEWSHED\n    uniform vec4 viewshed_visibleColor;\n    uniform vec4 viewshed_invisibleColor;\n    uniform sampler2D viewshedMap;\n#endif\n#ifdef HAS_INSIGHT\n    uniform vec4 insight_visibleColor;\n    uniform vec4 insight_invisibleColor;\n    uniform sampler2D insightMap;\n#endif\n#ifdef HAS_CUT\n    uniform sampler2D meshesMap;\n    uniform sampler2D invisibleMap;\n#endif\n#ifdef HAS_EXCAVATE\n    uniform sampler2D excavateMap;\n#endif\n#ifdef HAS_CROSSCUT\n    uniform sampler2D crosscutMap;\n    uniform vec4 cutLineColor;\n#endif\n#ifdef HAS_HEIGHTLIMIT\n    uniform vec3 limitColor;\n    uniform sampler2D heightLimitMap;\n#endif\nuniform sampler2D sceneMap;\nvoid main() {\n    vec4 sceneColor = texture2D(sceneMap, vTexCoord);\n    glFragColor = sceneColor;\n    #ifdef HAS_VIEWSHED\n        vec4 viewshedColor = texture2D(viewshedMap, vTexCoord);\n        if (viewshedColor.r > 0.99) {\n            glFragColor = vec4(mix(viewshed_invisibleColor.rgb, sceneColor.rgb, viewshed_invisibleColor.a), sceneColor.a);\n        } else if (viewshedColor.g > 0.99) {\n            glFragColor = vec4(mix(viewshed_visibleColor.rgb, sceneColor.rgb, viewshed_visibleColor.a), sceneColor.a);\n        } else if (viewshedColor.a < 0.01) {\n            glFragColor = vec4(viewshedColor.rgb, 1.0);\n        }\n    #endif\n    #ifdef HAS_FLOODANALYSE\n        vec4 floodColor = texture2D(floodMap, vTexCoord);\n        if (floodColor.r > 0.0) {\n            glFragColor = vec4(mix(flood_waterColor, glFragColor.rgb, flood_waterOpacity), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_SKYLINE\n        vec4 skylineColor = texture2D(skylineMap, vTexCoord);\n        if (skylineColor.r > 0.0 || skylineColor.g > 0.0 || skylineColor.b > 0.0) {\n            glFragColor = skylineColor;\n        }\n    #endif\n    #ifdef HAS_INSIGHT\n        vec4 insightColor = texture2D(insightMap, vTexCoord);\n        if (insightColor.g > 0.0) {\n            glFragColor = insight_visibleColor;\n        } else if (insightColor.r > 0.0) {\n            glFragColor = insight_invisibleColor;\n        }\n    #endif\n    #ifdef HAS_CUT\n        vec4 cutColor = texture2D(invisibleMap, vTexCoord);\n        vec4 meshesMapColor = texture2D(meshesMap, vTexCoord);\n        if (cutColor.r == 1.0 && cutColor.g == 0.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 1.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 0.0 && cutColor.b == 1.0) {\n          glFragColor = sceneColor;\n        }\n    #endif\n    #ifdef HAS_EXCAVATE\n        vec4 excavateColor = texture2D(excavateMap, vTexCoord);\n        if (excavateColor.r == 1.0 && excavateColor.g == 0.0 && excavateColor.b == 0.0) {\n          glFragColor = sceneColor;\n        }  else {\n          glFragColor = excavateColor;\n        }\n    #endif\n    #ifdef HAS_CROSSCUT\n        vec4 crosscutColor = texture2D(crosscutMap, vTexCoord);\n        if (crosscutColor.r > 0.0) {\n            glFragColor = vec4(mix(cutLineColor.rgb, glFragColor.rgb, 0.99), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_HEIGHTLIMIT\n        vec4 heightLimitColor = texture2D(heightLimitMap, vTexCoord);\n        if (heightLimitColor.r > 0.0) {\n            glFragColor = vec4(mix(limitColor, glFragColor.rgb, 0.6), glFragColor.a);\n        }\n    #endif\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",extraCommandProps:{viewport:t,cull:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}})}}class nM{constructor(t,e,n){this.H=t,this.i=e,this.Nt=n,this.s()}s(){this.renderer=new Ta(this.H);const t=this.i.getRenderer(),e=this.Gt={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this.Ut=this.H.framebuffer({color:this.H.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.pt=new eM(e)}getMap(){return this.i&&this.i.getMap()}paint(t,e){if(!e&&e.length)return t;this.Jt();const n={},i=this.i.pi;if(!this.mi())return t;delete this.pt.shaderDefines.HAS_FLOODANALYSE,delete this.pt.shaderDefines.HAS_VIEWSHED,delete this.pt.shaderDefines.HAS_SKYLINE,delete this.pt.shaderDefines.HAS_INSIGHT,delete this.pt.shaderDefines.HAS_CUT,delete this.pt.shaderDefines.HAS_EXCAVATE,delete this.pt.shaderDefines.HAS_CROSSCUT,delete this.pt.shaderDefines.HAS_HEIGHTLIMIT;for(let r=0;r<i.length;r++){const t=i[r];if(!t.isEnable())continue;const o=t.getDefines();oT(this.pt.shaderDefines,o);const s=this.getMap(),a=s.width,h=s.height,l=this.vi(e,t.getExcludeLayers()),c=t.renderAnalysis(l,a,h);c&&oT(n,c)}return n.sceneMap=t,this.pt.setDefines(this.pt.shaderDefines),this.renderer.render(this.pt,n,null,this.Ut),this.Ut}vi(t,e){let n=[];for(let i=0;i<t.length;i++){const r=t[i].getRenderer();if(r&&r.getAnalysisMeshes){const o=r.getAnalysisMeshes();o.forEach((n=>{n.setUniform("useAnalysis",1),e.indexOf(t[i].getId())>-1&&n.setUniform("useAnalysis",0)})),n=n.concat(o)}}return n}Jt(){const t=e.Util.isFunction(this.Gt.width.data)?this.Gt.width.data():this.Gt.width,n=e.Util.isFunction(this.Gt.height.data)?this.Gt.height.data():this.Gt.height;!this.Ut||this.Ut.width===t&&this.Ut.height===n||this.Ut.resize(t,n)}mi(){const t=this.i&&this.i.pi;if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e].isEnable())return!0;return!1}}const iM=[0,0,0,0],rM=[0,0],oM=t=>!t.bloom&&!t.ssr,sM=t=>!t.bloom,aM=t=>!t.ssr;class hM extends o.renderer.CanvasRenderer{setToRedraw(){this.setRetireFrames(),super.setToRedraw()}onAdd(){super.onAdd(),this.prepareCanvas()}updateSceneConfig(){this.wi&&this.wi.update(),this.bi&&this.bi.update(),this._i&&this._i.update(),this.setToRedraw()}render(...t){this.getMap()&&this.layer.isVisible()&&(this.forEachRenderer((t=>{t._replacedDrawFn||(t.draw=this.Mi(t.draw),t.drawOnInteracting=this.xi(t.drawOnInteracting),t.setToRedraw=this.yi(t.setToRedraw),t._replacedDrawFn=!0)})),this.prepareRender(),this.prepareCanvas(),this.layer.Ci(),this._toRedraw=!1,this.Si("render",t),this.Ti(),this.Oi())}prepareCanvas(){super.prepareCanvas(),this.forEachRenderer((t=>{t.prepareCanvas()}))}drawOnInteracting(...t){this.getMap()&&this.layer.isVisible()&&(this.layer.Ci(),this._toRedraw=!1,this.Si("drawOnInteracting",t),this.Ti(),this.Oi())}Si(t,e){this.ki="default";const n=this.hasRenderTarget(),i=this.Ai(e);if(n&&(this.Li.renderTarget=this.Ei()),this.bi.paint(i),this.drawGround(!0),!n)return void this.Fi("default",null,t,e,!0);const r=this.glCtx,o=this.layer.ct(),s=o&&o.postProcess,a=this.isSSROn(),h=this.isEnableTAA(),l=i.jitter;if(i.jitter=rM,r.resetDrawCalls(),this.Fi(h?"fxaaBeforeTaa":"fxaa",this.Ii,t,e),this.Pi=r.getDrawCalls(),a&&this.Ri.drawSSR(this.Hi(),this.Ii),h){const n=this.getMap(),o=this.Ri.isTaaNeedRedraw()||this.Di||n.getRenderer().isViewChanged();i.jitter=o?l:this.ji.getAverage(),i.onlyUpdateDepthInTaa=!o;let a=this.Ni;if(a)a.width===this.Ii.width&&a.height===this.Ii.height||a.resize(this.Ii.width,this.Ii.height);else{const t=this.regl,e=this.ai(s,this.Gi);a=this.Ni=t.framebuffer(e)}r.resetDrawCalls(),this.Fi("taa",a,t,e),this.Bi=r.getDrawCalls(),delete i.onlyUpdateDepthInTaa,i.jitter=rM;let h=this.Vi;if(h)h.width===this.Ii.width&&h.height===this.Ii.height||h.resize(this.Ii.width,this.Ii.height);else{const t=this.regl,e=this.ai(s,this.Gi);h=this.Vi=t.framebuffer(e)}r.resetDrawCalls(),this.Fi("fxaaAfterTaa",this.Vi,t,e),this.Ui=r.getDrawCalls()}else this.Ni&&(this.Ni.destroy(),this.Vi.destroy(),delete this.Ni,delete this.Vi,delete this.Ui);s.bloom&&s.bloom.enable&&(this.zi=this.Ri.drawBloom(this.Gi)),2===a&&this.Ri.drawSSR(this.Hi(),this.Ii,!0),r.resetDrawCalls(),this.Fi("noAa",this.Wi,t,e),this.qi=r.getDrawCalls(),r.resetDrawCalls(),this.Fi("point",this.$i,t,e,!0),this._i.renderScene(i),this.Xi=r.getDrawCalls()}Fi(t,e,n,i,r){this.ki=t;const o=this.Ai(i);o.renderMode=this.ki,o.renderTarget&&(o.renderTarget.fbo=e),r&&(o.isFinalRender=!0),this.forEachRenderer(((r,o)=>{o.isVisible()&&("default"===t||!r.supportRenderMode&&("fxaa"===t||"fxaaAfterTaa"===t)||r.supportRenderMode&&r.supportRenderMode(t))&&(this.clearStencil(r,e),r[n].apply(r,i))}))}Ai(t){let e=t[0];return lM(e)||(e=t[1]),e!==this.Ji&&(this.forEachRenderer(((t,e)=>{e.isVisible()&&t.needRetireFrames&&t.needRetireFrames()&&this.setRetireFrames()})),this.Li=this.Yi(e),this.Ji=e,this.Ki=lM(t[0])?null:t[0]),this.Li}Ti(){if(!this.isEnableOutline())return;const t=this.Zi(),e=this.glCtx;e.resetDrawCalls(),this.forEachRenderer(((e,n)=>{n.isVisible()&&e.drawOutline&&e.drawOutline(t)})),this.Qi=e.getDrawCalls()}Zi(){const{width:t,height:e}=this.canvas;let n=this.te;if(n)t===n.width&&e===n.height||n.resize(t,e);else{const i=this.regl.texture({width:t,height:e,format:"rgba4"});n=this.te=this.regl.framebuffer({width:t,height:e,colors:[i],depth:!1,stencil:!1})}return n}hi(t){if(this.gi()){const e=this.ie(t);return e.width!==t.width||e.height!==t.height?e.resize(t.width,t.height):this.regl.clear({color:[0,0,0,0],fbo:e}),e.blit(t),e.color[0]}return t.color[0]}Hi(){if(this.Gi.subimage)return this.Gi;const{width:t,height:e}=this.Gi;if(!this.ee){const n=this.regl,i={depthStencil:n.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:t,height:e,format:"depth stencil"}),colors:[n.renderbuffer({width:t,height:e,format:"rgba4"})],colorFormat:"rgba4",width:t,height:e};this.ee=n.framebuffer(i)}return this.ee.width===t&&this.ee.height===e||this.ee.resize(t,e),this.regl.clear({color:[0,0,0,0],depth:1,fbo:this.ee}),this.ee.blit(this.Ii,256,"nearest"),this.ee.depthStencil}ie(t){if(this.se||(this.se=[]),!t.ne){const e=this.re(!0,t.width,t.height),n=this.regl.framebuffer(e);this.se.push(n),t.ne=n}return t.ne}gi(){return 0===this.regl.limits.version.indexOf("WebGL 2.0")&&this.layer.options.antialias}hasRenderTarget(){const t=this.layer.ct(),e=t&&t.postProcess;return!(!e||!e.enable)}testIfNeedRedraw(){if(this._toRedraw)return this._toRedraw=!1,!0;if(this.getMap().isInteracting()&&(this.wi&&this.wi.isEnable()||this.bi&&this.bi.isEnable()))return!0;if(this._i&&this._i.isEnable())return!0;const t=this.layer.he;if(t){const e=t.getRenderer();if(e&&e.testIfNeedRedraw())return this.oe=!0,!0}const e=this.ae();for(const n of e){const t=n.getRenderer();if(t&&t.testIfNeedRedraw())return this.oe=!0,!0}return!1}isRenderComplete(){const t=this.ae();for(const e of t){const t=e.getRenderer();if(t&&!t.isRenderComplete())return!1}return!0}mustRenderOnInteracting(){const t=this.ae();for(const e of t){const t=e.getRenderer();if(t&&t.mustRenderOnInteracting())return!0}return!1}isCanvasUpdated(){if(super.isCanvasUpdated())return!0;const t=this.ae();for(const e of t){const t=e.getRenderer();if(t&&t.isCanvasUpdated())return!0}return!1}isBlank(){if(this.wi&&this.wi.isEnable())return!1;if(this.bi&&this.bi.isEnable())return!1;const t=this.ae();for(const e of t){const t=e.getRenderer();if(t&&!t.isBlank())return!1}return!0}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0};e.preserveDrawingBuffer=!0,e.antialias=t.options.antialias,this.glOptions=e;const n=this.gl=this.le(this.canvas,e);this.ce(n),n.wrap=()=>new mw(this.gl),this.glCtx=n.wrap(),this.canvas.gl=this.gl,this.reglGL=n.wrap(),this.regl=a({gl:this.reglGL,attributes:e,extensions:t.options.extensions,optionalExtensions:t.options.optionalExtensions}),this.gl.regl=this.regl,this.ue=[0,0],this.wi=new bT(this.regl,this.layer),this.bi=new CT(this.regl,this.layer);const i=this.layer.getWeatherConfig();this._i=new qT(this.regl,t,i),this.fe=new nM(this.regl,t);const r=this.layer.ct()||{},o=r&&r.postProcess,s=o&&o.antialias&&o.antialias.jitterRatio||.2;this.ji=new ul(s),this.Ri=new QT(this.regl,this.layer,this.ji),this.h=new gT(this.regl,r,this.layer)}ce(){const t=this.layer,e=this.gl,n=t.options.extensions;n&&n.forEach((t=>{e.getExtension(t)}));const i=t.options.optionalExtensions;i&&i.forEach((t=>{e.getExtension(t)})),this.gl.clearColor(0,0,0,0)}clearCanvas(){super.clearCanvas(),this.de()}de(){const t=this.regl;this.Ii&&(t.clear({color:iM,depth:1,stencil:255,framebuffer:this.Ii}),t.clear({color:iM,framebuffer:this.Wi}),t.clear({color:iM,framebuffer:this.$i}),this.Ni&&this.Bi&&t.clear({color:iM,framebuffer:this.Ni}),this.Vi&&this.Ui&&t.clear({color:iM,framebuffer:this.Vi})),this.te&&t.clear({color:iM,framebuffer:this.te}),t.clear({color:iM,depth:1,stencil:255})}resizeCanvas(){super.resizeCanvas();const t=this.canvas.width,e=this.canvas.height;!this.Ii||this.Ii.width===t&&this.Ii.height===e||(this.Ii.resize(t,e),this.Wi.resize(t,e),this.$i.resize(t,e),this.Ni&&this.Ni.resize(t,e),this.Vi&&this.Vi.resize(t,e)),this.de(),this.forEachRenderer((t=>{t.canvas&&t.resizeCanvas()}))}getCanvasImage(){return this.forEachRenderer((t=>{t.getCanvasImage()})),super.getCanvasImage()}ae(){return this.layer.getLayers()}forEachRenderer(t){const e=this.ae();for(const i of e){if(!i.isVisible()||!i.options.beneathTerrain)continue;const e=i.getRenderer();e&&t(e,i)}const n=this.layer.he;if(n){const e=n.getRenderer();e&&t(e,n)}for(const i of e){if(!i.isVisible()||i.options.beneathTerrain)continue;const e=i.getRenderer();e&&t(e,i)}}le(t,e){const n=this.layer.options.onlyWebGL1?["webgl","experimental-webgl"]:["webgl2","webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}clearStencil(t,e){const n={stencil:t.getStencilValue?t.getStencilValue():255};e&&(n.framebuffer=e),this.regl.clear(n)}onRemove(){this.canvas.pickingFBO&&this.canvas.pickingFBO.destroy&&this.canvas.pickingFBO.destroy(),this.ge(),this.wi&&(this.wi.dispose(),delete this.wi),this.bi&&(this.bi.dispose(),delete this.bi),this.h&&(this.h.dispose(),delete this.h),this.Ri&&(this.Ri.dispose(),delete this.Ri),this.te&&(this.te.destroy(),delete this.te),this._i&&(this._i.dispose(),delete this._i),super.onRemove()}ge(){if(this.Ii&&(this.Ii.destroy(),this.Wi.destroy(),this.$i.destroy(),this.Ni&&(this.Ni.destroy(),delete this.Ni),this.Vi&&(this.Vi.destroy(),delete this.Vi),delete this.Ii,delete this.Wi,delete this.$i,this.pe&&(this.pe.destroy(),delete this.pe),this.ee&&(this.ee.destroy(),delete this.ee),this.se)){for(let t=0;t<this.se.length;t++)this.se[t]&&this.se[t].destroy();delete this.se}}setRetireFrames(){this.Di=!0}getFrameTime(){return this.Ji}getFrameEvent(){return this.Ki}getFrameContext(){return this.Li}drawGround(t){const e=this.layer.getGroundConfig();if(!e||!e.enable)return!1;if(!this.wi)return!1;const n=this.getFrameContext(),i=n.jitter;let r;n.jitter=rM,n.offsetFactor=2,n.offsetUnits=2,t&&(r=n.sceneFilter,delete n.sceneFilter);const o=this.wi.paint(n);return this.wi.needToRedraw()&&this.setToRedraw(),r&&(n.sceneFilter=r),n.jitter=i,o}Mi(t){const e=this;return function(n,i){return(i=i||e.Li)&&i.renderTarget&&(i.renderTarget.getFramebuffer=cM,i.renderTarget.getDepthTexture=uM),t.call(this,n,i)}}xi(t){const e=this;return function(n,i,r){return(r=r||e.Li)&&r.renderTarget&&(r.renderTarget.getFramebuffer=cM,r.renderTarget.getDepthTexture=uM),t.call(this,n,i,r)}}yi(t){return function(...e){return t.apply(this,e)}}isEnableSSR(){const t=this.layer.ct(),e=t&&t.postProcess;return e&&e.enable&&e.ssr&&e.ssr.enable}isSSROn(){const t=this.isEnableSSR(),e=this.getMap();if(!t||e.getPitch()<=-.001)return 0;const n=e.projViewMatrix,i=this.Ri.getPrevSsrProjViewMatrix();return i&&Ne(i,n)?1:2}isEnableTAA(){return!1}isEnableSSAO(){const t=this.layer.ct(),e=t&&t.postProcess;return e&&e.enable&&e.ssao&&e.ssao.enable}isEnableOutline(){const t=this.layer.ct(),e=t&&t.postProcess;return e&&e.enable&&e.outline&&e.outline.enable}isEnableWeather(){const t=this.layer.ct(),e=t&&t.weather;return e&&e.enable}me(){const t=this.layer.getMap();if(!this.k){this.k={center:t.getCenter(),bearing:t.getBearing(),pitch:t.getPitch(),res:t.getResolution()};let e=!1;if(t.options.lights){const n=t.getLightManager().getDirectionalLight().direction;this.k.lightDirection=Xe([],n),e=!0}return{viewChanged:!0,lightDirectionChanged:e}}const e=t.getResolution()/this.k.res,n=t.coordToContainerPoint(this.k.center),i=this.layer.options.viewMoveThreshold,r=n._sub(t.width/2,t.height/2).mag()>i||e<.95||e>1.05;let o=!1;if(t.options.lights){const e=t.getLightManager().getDirectionalLight().direction;o=!Cn(this.k.lightDirection,e),o&&(this.k.lightDirection=Xe([],e))}return r&&(this.k.center=t.getCenter(),this.k.bearing=t.getBearing(),this.k.pitch=t.getPitch(),this.k.res=t.getResolution()),{viewChanged:r,lightDirectionChanged:o}}Yi(t){const e=this.layer.ct(),n=e&&e.postProcess,i=e&&e.weather,r={timestamp:t,renderMode:this.ki||"default",includes:{},states:this.me(),testSceneFilter:t=>!r.sceneFilter||r.sceneFilter(t),isFinalRender:!1,weather:{fog:i&&i.fog}},o=n&&n.antialias&&n.antialias.jitterRatio||.2,s=this.ji;s.setRatio(o);const a=this.isSSROn();let h;if(n&&n.enable){this.isEnableTAA()?((this.getMap().isInteracting()||this.Di)&&s.reset(),s.getJitter(this.ue),s.frame()):no(this.ue,0,0),r.jitter=this.ue;const t=n.bloom&&n.bloom.enable;t&&a?(r.bloom=1,r.sceneFilter=oM):t?(r.bloom=1,r.sceneFilter=sM):a&&(r.sceneFilter=aM),h=this.Ei(),h&&(r.renderTarget=h)}else this.ge();return"noAa"!==this.ki&&(this.ve=this.we(r),this.ve&&(r.includes.shadow=1),this.be=this._e(r)),this.ve&&(r.shadow=this.ve,r.includes.shadow=1),r.states.includesChanged=this.be,n&&n.enable&&this.Ri&&this.Ri.setContextIncludes(r),r}Me(t){const e=this.ae().filter((t=>t.isVisible()));return this.fe.paint(t,e)}_e(t){let e=!1;const n=Object.keys(t.includes),i=this.xe;if(i){const t=n.filter((t=>-1===i.indexOf(t))).concat(i.filter((t=>-1===n.indexOf(t))));t.length&&(e=t.reduce(((t,e)=>(t[e]=1,t)),{}))}return this.xe=n,e}we(t){const e=this.layer.ct();if(!e||!e.shadow||!e.shadow.enable)return this.h&&(this.h.dispose(),delete this.h),null;this.h||(this.h=new gT(this.regl,this.layer.ct()||{},this.layer));const n={config:e.shadow,defines:this.h.getDefines(),uniformDeclares:gT.getUniformDeclares()};return n.renderUniforms=this.ye(t),n}ye(t){const e=t.renderTarget&&t.renderTarget.fbo,n=this.layer.ct(),i=[];let r=t.states.lightDirectionChanged||t.states.viewChanged;this.forEachRenderer(((t,e)=>{if(!t.getShadowMeshes||!e.isVisible())return;const n=t.getShadowMeshes();if(Array.isArray(n))for(let o=0;o<n.length;o++)n[o].needUpdateShadow&&(r=!0),n[o].needUpdateShadow=!1,i.push(n[o])})),this.Ce||(this.Ce=new nh),this.Ce.setMeshes(i);const o=this.getMap(),s=n.shadow,a=o.getLightManager().getDirectionalLight().direction,h=!n.ground||!n.ground.enable;return this.h.render(h,o.projMatrix,o.viewMatrix,s.color,s.opacity,a,this.Ce,this.ue,e,r)}Se(t){let e=[];if(this.forEachRenderer(((t,n)=>{if(!t.getShadowMeshes||!n.isVisible())return;const i=t.getShadowMeshes();e=e.concat(i)})),this.wi){const t=this.wi.getRenderMeshes();e=e.concat(t)}const n=this.layer.getWeatherConfig();return this._i.paint(t,e,n)}Ei(){const t=this.layer.ct(),e=t&&t.postProcess;if(!this.Ii){const t=this.regl;let n=this.Gi;(!n||!n._texture||n._texture.refCount<=0)&&(n=null);const i=this.ai(e,n);this.Gi=i.depth||i.depthStencil,this.Ii=t.framebuffer(i);const r=this.ai(e,this.Gi);this.Wi=t.framebuffer(r);const o=this.ai(e,this.Gi);this.$i=t.framebuffer(o),this.de()}return{fbo:this.Ii}}re(t,e,n){e=e||this.canvas.width,n=n||this.canvas.height;const i=this.regl,r=this.gi();let o;if(!t&&r)o=i.renderbuffer({width:e,height:n,samples:this.layer.options.multiSamples,format:"rgba8"});else{const t="uint8";o=i.texture({min:"nearest",mag:"nearest",type:t,width:e,height:n})}return{width:e,height:n,colors:[o],colorFormat:r?"rgba8":"rgba"}}ai(t,e){const{width:n,height:i}=this.canvas,r=this.regl,o=this.re(),s=this.gi(),a=r.hasExtension("WEBGL_depth_texture");if(s){const t=e||r.renderbuffer({width:n,height:i,format:"depth24 stencil8",samples:this.layer.options.multiSamples});o.depthStencil=t}else if(a){const t=e||r.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:n,height:i,format:"depth stencil"});o.depthStencil=t}else{const t=e||r.renderbuffer({width:n,height:i,format:"depth stencil"});o.depthStencil=t}return o}Oi(){if(!this.Ii)return void(this.Di=!1);const t=this.layer.ct(),e=t&&t.postProcess;if(!e||!e.enable)return;this.layer.fire("postprocessstart");const n=this.layer.getMap();let i;if(this.isEnableTAA()){const t=this.Di||n.getRenderer().isViewChanged();t&&this.layer.fire("taastart");const{outputTex:e,redraw:r}=this.Ri.taa(this.hi(this.Ni),this.Hi(),{projMatrix:n.projMatrix,needClear:t});i=e,r?this.setToRedraw():this.layer.fire("taaend"),this.Di=!1}let r=e.sharpen&&e.sharpen.factor;r||0===r||(r=.2);let o=0,s=.2,a=.3,h=1,l=[1,1,0];e.outline&&(o=+!!e.outline.enable,s=fM(e.outline,"highlightFactor",s),a=fM(e.outline,"outlineFactor",a),h=fM(e.outline,"outlineWidth",h),l=fM(e.outline,"outlineColor",l));const c=this.isEnableSSAO(),u=e.ssr&&e.ssr.enable,f=e.bloom&&e.bloom.enable,d=f&&this.zi,m=+!(!e.antialias||!e.antialias.enable),g=this.fe.mi(),p=this._i.Qt(),_=c||f||u||g||p;let v=this.pe;if(_){if(!v){const t=this.re();this.gi()&&(t.depthStencil=this.regl.renderbuffer({width:this.canvas.width,height:this.canvas.height,samples:this.layer.options.multiSamples,format:"depth24 stencil8"})),v=this.pe=this.regl.framebuffer(t)}const{width:t,height:e}=this.canvas;v.width===t&&v.height===e||v.resize(t,e)}else v=null,this.pe&&(this.pe.destroy(),delete this.pe);let y=this.hi(this.Ii);const x=this.qi&&this.hi(this.Wi),b=this.Xi&&this.hi(this.$i);if(this.Ri.fxaa(v,y,!d&&x,!d&&b,i,this.Ui&&this.Vi&&this.hi(this.Vi),m,+!(!e.toneMapping||!e.toneMapping.enable),+!(_||!e.sharpen||!e.sharpen.enable),n.getDevicePixelRatio(),r,o&&this.Qi>0&&this.Zi(),s,a,h,l),v&&(y=this.hi(v)),c&&(this.Ui||this.Bi||this.Pi)&&(y=this.Ri.ssao(y,this.Hi(),{projMatrix:n.projMatrix,cameraNear:n.cameraNear,cameraFar:n.cameraFar,ssaoBias:e.ssao&&e.ssao.bias||10,ssaoRadius:e.ssao&&e.ssao.radius||100,ssaoIntensity:e.ssao&&e.ssao.intensity||.5})),f&&this.zi){const t=e.bloom,n=+t.threshold||0,i=fM(t,"factor",1),r=fM(t,"radius",1);y=this.Ri.bloom(y,x,b,n,i,r,m)}if(u&&(this.Ri.genSsrMipmap(y,this.Hi()),this.oe)){const t=this.Di;this.setToRedraw(),this.Di=t,this.oe=!1}this.fe&&(y=this.Me(y)),this.isEnableWeather()&&(y=this.Se(y)),_&&this.Ri.renderFBOToScreen(y,+!(!e.sharpen||!e.sharpen.enable),r,n.getDevicePixelRatio()),this.layer.fire("postprocessend")}}function lM(t){return"number"==typeof t&&!isNaN(t)}function cM(t){return t._framebuffer.framebuffer}function uM(t){return t.depthStencil._texture.texture}function fM(t,e,n){return null==t[e]?n:t[e]}class dM extends o.worker.Actor{constructor(t){super("@maptalks/terrain"),this.mapId=t}checkUrl(t){return t&&o.Util.isString(t)?o.Util.getAbsoluteURL(t):t}fetchTerrain(t,e,n){t=this.checkUrl(t);const i={actorId:this.actorId,mapId:this.mapId,command:"fetchTerrain",params:{url:t,origin:location.origin,terrainWidth:e.terrainWidth,type:e.type,accessToken:e.accessToken,error:e.error,maxAvailable:e.maxAvailable}};this.send(i,null,((t,e)=>{t?n(t):n(t,e)}))}abortTerrain(t,e){const n={actorId:this.actorId,mapId:this.mapId,command:"abortTerrain",params:{url:t}};this.broadcast(n,null,e)}addLayer(t,e,n){const i={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{}};this.broadcast(i,null,n)}createTerrainMesh(t,e){const n={actorId:this.actorId,command:"createTerrainMesh",params:t};this.send(n,[t.terrainHeights.data.buffer],((t,n)=>{t?e(t):e(t,n)}))}removeLayer(t,e,n){const i={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(i,null,n)}}const mM=[];function gM(t,e,n,i,r,o,s){if((i-=s)<=0)return mM;let a=t.options.tileSize;Array.isArray(a)&&(a=a[0]);const h=t._getTileOffset(i),l=r[0]-h[0],c=h[1]-r[1];let u,f;if(l||c){const e=t._getTileConfig();u=e.tileSystem.scale.x,f=e.tileSystem.scale.x}let d=0,m=0,g=o/=Math.pow(2,s),p=o;if(l<0?g+=u*Math.ceil(-l/a-1e-7):l>0&&(d-=u*Math.ceil(l/a-1e-7)),c>0?m-=f*Math.ceil(c/a-1e-7):c<0&&(p+=f*Math.ceil(-c/a-1e-7)),0===d&&0===m&&g<=1&&p<=1){const r=Math.floor(e*o),s=Math.floor(n*o);return[{x:r,y:s,z:i,offset:h,id:t._getTileId(r,s,i)}]}let _=[];for(let v=d;v<g;v++)for(let r=m;r<p;r++){const s=e*o+v,a=n*o+r;_.push({x:s,y:a,z:i,offset:h,id:t._getTileId(s,a,i)})}return _}function pM(t,e,n,i,r){const o=t.getRenderer().tileCache,s=Math.floor(e/2),a=Math.floor(n/2),h=i-1,l=t._getTileId(s,a,h),c=o.get(l);return!c&&r<=0?pM(t,s,a,h,r+1):c}function _M(t,e,n,i){let r=t/n*i/e;return r<1?(r=1/r,r=1/Math.round(r)):r=Math.round(r),r}function vM(t,e,n){const i=t.getResolution(e),r=e-Math.log(n/i)*Math.LOG2E;return{zoom:r,res:t.getResolution(r)}}const yM=[],xM=new o.Point(0,0),bM=new o.Point(0,0),wM=new o.PointExtent(0,0,0,0),TM=new o.Point(0,0),MM=[],AM=new o.Point(20,20);class EM extends o.renderer.TileLayerCanvasRenderer{constructor(...t){super(...t),this.xt=new nh}isDrawable(){return!0}consumeTile(t,e){if(t&&t.mesh&&!t.terrainMesh){t.terrainMesh=this.Te(e,t.mesh),e.minAltitude=t.data.min,e.maxAltitude=t.data.max;const n=this.layer.tileInfoCache;if(n&&e.parentNodeId){const t=n.get(e.parentNodeId);t&&(void 0===t.minAltitude&&(t.minAltitude=e.minAltitude),void 0===t.maxAltitude&&(t.maxAltitude=e.maxAltitude))}}super.consumeTile(t,e);const n=this.getMap();if(n.updateCenterAltitude&&void 0===n.centerAltitude&&e.z===this.getCurrentTileZoom()){const t=n.Oe(),i=n._prjToPointAtRes(t,e.res,TM);e.extent2d.contains(i)&&n.updateCenterAltitude()}}draw(t,e){this.xt.clear(),super.draw(t,e),this.ke(e)}drawOnInteracting(t,e,n){this.draw(e,n)}drawTile(t,e){const n=this.getMap();if(!t||!n||!e)return;let i=this.getTileOpacity(e);i*=this.layer.options.opacity||1;const r=e.terrainMesh;if(r){r.setUniform("opacity",i);const e=this.layer.getSkinCount();if(r.properties.skinCount!==e){const t=r.defines();t.SKIN_COUNT=e,r.properties.skinCount=e,r.defines=t}const n=this.getCurrentTileZoom(),o=n+this.layer.options.backZoomOffset,s=!0===this.drawingTiles&&t.z>o&&t.z<=n;r.setUniform("depthMask",s),this.xt.addMesh(r)}}_drawTiles(t,e,n){const i=this.layer.getSkinCount();for(let r=0;r<i;r++){for(let e=0;e<t.length;e++)this.Ae(r,t[e].info,t[e].image);for(let t=0;t<e.length;t++)this.Ae(r,e[t].info,e[t].image);for(let t=0;t<n.length;t++)this.Ae(r,n[t].info,n[t].image)}return super._drawTiles(...arguments)}Ae(t,e,n){const i=this.getMap();if(!e||!i||!n)return;const r=n.terrainMesh;if(r){const i=this.layer.getSkinLayer(t);this.renderSkin(i,e,n,t);const o=this.Le(),s=r.getUniform("skins"),a=n.skins;for(let t=0;t<a.length;t++)s[t]=a[t]||o}}renderSkin(t,e,n,i){if(n.skinImages||(n.skinImages=[]),n.skins||(n.skins=[]),n.skinStatus||(n.skinStatus=[]),n.skinTileIds||(n.skinTileIds=[]),n.skinStatus[i])return;const r=t.getRenderer();if(!r)return;const o=t.getSpatialReference(),{x:s,y:a,z:h,res:l,offset:c}=e,u=this.layer.getTileSize().width;let f=u,d=u;const{res:m,zoom:g}=vM(o,h,l),p=_M(m,t.getTileSize().width,l,f);let _=n.skinTileIds[i];_||(_=n.skinTileIds[i]=function(t,e,n,i,r,o,s){const a={};for(let h=0;h<s;h++)a[h+""]=gM(t,e,n,i,r,o,h);return a}(t,s,a,g,c,p,CM));const v=_[0];let y=!0;const x=[];let b;for(let E=0;E<v.length;E++){const e=v[E].id,n=r.tileCache.get(e);n?x.push(n):(y=!1,b||(b=pM(t,v[E].x,v[E].y,v[E].z,this.layer.options.backZoomOffset)))}let w=n.skinImages[i];w||(w=document.createElement("canvas"),pa.isPowerOfTwo(f)||(f=pa.floorPowerOfTwo(f)),pa.isPowerOfTwo(d)||(f=pa.floorPowerOfTwo(d)),w.width=f,w.height=d),r.renderTerrainSkin(this.regl,this.layer,e,w,x,b);const T=document.getElementById("terrain_skin_debug");T&&(T.width=f,T.height=d,T.getContext("2d").drawImage(w,0,0));const M={data:w,width:f,height:d};let A=n.skins[i];A?A(M):A=this.regl.texture(M),n.skins[i]=A,y&&(n.skinStatus[i]=1,n.skinTileIds=[],n.skinImages[i]=null)}ke(t){const e=this.q(),n=this.xt.getMeshes().sort(RM);this.xt.setMeshes(n),this.renderer.render(this.pt,e,this.xt,this.getRenderFBO(t)),n.length&&!Object.keys(this.tilesLoading).length&&this.layer.fire("terrainreadyandrender")}Te(t,e){const{positions:n,texcoords:i,triangles:r}=e,o=this.Ee(100)/100;for(let x=2;x<n.length;x+=3)n[x]*=o;const s=new La({POSITION:n,TEXCOORD_0:i},r,0,{primitive:"triangles",positionAttribute:"POSITION",uv0Attribute:"TEXCOORD_0"});s.generateBuffers(this.regl);const a=this.layer.getSkinCount(),h=new Ya(s);h.setDefines({SKIN_COUNT:a});const l=this.layer.getSpatialReference().getMaxZoom();h.setUniform("level",l-t.z),h.properties.skinCount=a,h.properties.z=t.z;const c=[],u=this.Le();for(let x=0;x<a;x++)c[x]=u;h.setUniform("skins",c);const f=this.getMap(),d=this.layer.options.tileSize,m=d+1,g=t.res/f.getGLRes();let p=(d+2)/m;const{extent2d:_,offset:v}=t;Ze(yM,(_.xmin-v[0])*g,(t.extent2d.ymax-v[1])*g,0);const y=$t([]);return oe(y,y,yM),Ze(MM,g*p,g*p,1),se(y,y,MM),h.localTransform=y,h}Fe(t){const e=this.layer.options.maxAvailableZoom;let n,i=t.z;for(;i>e&&t;)n=this._findParentTile(t),i=(t=n&&n.info)&&t.z;return n}Ie(t,e){const{image:n,info:i}=t,r=n.data,o=r.width,{extent2d:s,res:a}=i,{extent2d:h,res:l}=e,c=s.getWidth(),u=s.getHeight();let f=(h.xmin*l/a-s.xmin)/c*o,d=(s.ymax-h.ymax*l/a)/u*o;const m=(h.xmax*l/a-s.xmin)/c*o,g=Math.ceil(m-f);f=Math.floor(f),d=Math.floor(d);const p=new Float32Array(g*g);let _=1/0,v=-1/0;for(let y=0;y<g;y++)for(let t=0;t<g;t++){const e=r.data[y+f+(d+t)*o];p[y+t*g]=e,e<_&&(_=e),e>v&&(v=e)}return{width:g,height:g,data:p,min:_,max:v}}loadTile(t){const e=this.layer.options.maxAvailableZoom,n=this.layer.getSpatialReference().getResolution(t.z);if(e&&t.z>e){const e=this.Fe(t);if(e){const i=this.Ie(e,t),r={};return this.workerConn.createTerrainMesh({terrainHeights:i,terrainWidth:this.layer.options.tileSize+1,error:n},((e,n)=>{if(e){if(e.canceled)return;return console.warn(e),void this.onTileError(r,t)}o.Util.extend(r,n),this.consumeTile(r,t),this.setToRedraw()})),r}}const i=t.url,r={},s={terrainWidth:this.layer.options.tileSize+1,type:this.layer.options.type,accessToken:this.layer.options.accessToken,error:n,maxAvailable:e===t.z};return this.workerConn.fetchTerrain(i,s,((e,n)=>{if(e){if(e.canceled)return;return console.warn(e),void this.onTileError(r,t)}o.Util.extend(r,n),this.consumeTile(r,t),this.setToRedraw()})),r}deleteTile(t){if(!t||!t.image)return;const{image:e}=t,n=e.skins;if(n&&n.length)for(let i=0;i<n.length;i++)n[i]&&n[i].destroy&&n[i].destroy();e.terrainMesh&&(e.terrainMesh.geometry.dispose(),e.terrainMesh.dispose()),delete e.skins,delete e.skinStatus,delete e.skinImages,delete e.skinTileIds,delete e.terrainMesh,delete e.mesh}abortTileLoading(t,e){e&&e.url&&this.workerConn&&this.workerConn.abortTerrain(e.url),super.abortTileLoading(t,e)}Pe(t,e,n,i){const r=this.Re(t.x,t.y,i,this.layer.options.backZoomOffset);if(r&&r.image){const t=r.info.extent2d,i=r.info.res/n,o=e.x-t.xmin*i,s=e.y-t.ymin*i;return this.He(r.image.data,o/(t.getWidth()*i),s/(t.getHeight()*i))}return 0}Re(t,e,n,i){const r=this.layer._getTileId(t,e,n);let o=this.tilesInView[r]||this.tileCache.get(r);return!o&&i<=0?this.Re(Math.floor(t/2),Math.floor(e/2),n-1,i+1):o}He(t,e,n){const{width:i,height:r,data:o}=t;return o[Math.floor(i*e)*i+Math.floor(r*n)]}Ee(t){const e=this.layer.getMap();return e?e.altitudeToPoint(t,e.getGLRes()):null}De(t,e,n){t||(t={tiles:{},dirty:!0,complete:!1});const i=this.layer,r=this.getCurrentTileZoom(),o=i.getSpatialReference().getResolution(r),{xmin:s,ymin:a,xmax:h,ymax:l}=e,c=i._getTileConfig();xM.set(s,a).je(n);const u=c._getTileNum(xM,n,!0);bM.set(h,l).je(n);const f=c._getTileNum(bM,n,!0),d=Math.min(u.x,f.x),m=Math.max(u.x,f.x),g=Math.min(u.y,f.y),p=Math.max(u.y,f.y),_=n/o;xM.set(s,a).je(_),bM.set(h,l).je(_);const v=wM.set(xM.x,xM.y,bM.x,bM.y),y=(i.options.tileSize||256)+1;v.Ne(v.getWidth()/y),t.array=t.array||new Float32Array(y*y);const x=t.tiles;t.complete=!0,t.array.fill(0);for(let b=d;b<=m;b++)for(let e=g;e<=p;e++){const n=this.layer._getTileId(b,e,r);if(x[n])continue;const i=this.tileCache.get(n);i?(this.Ge(t.array,i,v,y),t.dirty=!0,x[n]=1):(t.dirty=t.dirty||void 0!==t.tiles[n],t.tiles[n]&&delete t.tiles[n],t.complete=!1)}return t}Ge(t,e,n,i){const r=e.info.extent2d,o=r.intersection(n),{xmin:s,ymin:a,xmax:h,ymax:l}=o,{data:c}=e.image,u=c.width,f=n.getWidth()/i,d=Math.floor((s-n.xmin)/f),m=Math.floor((a-n.ymin)/f),g=Math.floor((h-n.xmin)/f)-d,p=Math.floor((l-n.ymin)/f)-m,_=r.getWidth()/u,v=Math.floor((s-r.xmin)/_),y=Math.floor((a-r.ymin)/_),x=Math.floor(f/_);for(let b=0;b<=g;b++)for(let e=0;e<=p;e++){const n=b+d+(m+e)*i;let r=0;for(let t=0;t<x;t++)for(let n=0;n<x;n++){const i=(v+Math.floor(b*x))*u+t+y+Math.floor(e*x)+n;r+=c.data[i]}t[n]=r/Math.max(x,1)}return t}onAdd(){super.onAdd(),this.prepareWorker()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),(t=>{if(t)throw t})),this.workerConn.remove(),delete this.workerConn),this.pt&&(this.pt.dispose(),delete this.pt),this.Be&&this.Be.destroy(),super.onRemove()}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new dM(t.id));const e=this.workerConn;if(!e.isActive())return;const n=this.layer.options||{},i=this.layer.getId();e.addLayer(i,n,(t=>{if(t)throw t;this.layer&&(this.ready=!0,this.setToRedraw(),this.layer.fire("workerready"))}))}createContext(){this.canvas.gl&&this.canvas.gl.wrap?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this.Ve(),this.Be=this.regl.texture(2,2),this.Ue=new Qa(this.Be),this.renderer=new Ta(this.regl),this.ze()}Ve(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};e.preserveDrawingBuffer=!0,e.stencil=!0,this.glOptions=e,this.gl=this.gl||this.le(this.canvas,e),this.regl=s.exports.createREGL({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.glExtensions})}le(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}resizeCanvas(t){this.canvas&&super.resizeCanvas(t)}clearCanvas(){this.canvas&&super.clearCanvas()}Le(){return this.Be}ze(){const t=this.layer.getMap();this.We={projViewMatrix:t.projViewMatrix};const e=this.layer.getSkinCount(),n=[],i={viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},stencil:{enable:!1,func:{cmp:()=>"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},cull:{enable:!0,face:"back"},depth:{enable:!0,mask:(t,e)=>this.layer.options.depthMask&&e.depthMask,func:this.layer.options.depthFunc||"<="},blend:{enable:!0,func:{src:this.layer.options.blendSrc,dst:this.layer.options.blendDst},equation:"add"}};this.pt=new jh({vert:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 projViewModelMatrix;\nvarying vec2 vUv;\nvoid main() {\n    gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n    vUv = aTexCoord;\n}",frag:"precision mediump float;\nuniform sampler2D skins[SKIN_COUNT];\nuniform float opacity;\nvarying vec2 vUv;\nvec4 blend(vec4 src, vec4 dst) {\n    return vec4(src.rgb * src.a + dst.rgb * (1.0 - src.a), src.a + (1.0 - src.a) * dst.a);\n}\nvoid main() {\n    vec4 color = vec4(0.0);\n    for (int i = 0; i < SKIN_COUNT; i++) {\n        color = blend(texture2D(skins[i], vUv), color);\n    }\n    gl_FragColor = color * opacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return re(n,e.projViewMatrix,e.modelMatrix)}},{name:"skins",type:"array",length:e,fn:(t,e)=>e.skinTextures}],extraCommandProps:i})}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}q(){return{projViewMatrix:this.getMap().projViewMatrix}}}const CM=4;function SM(t,e,n,i,r,o){const s=i.info.res/r,{info:a,image:h}=i,l=a.offset,c=h.width*s,u=h.height*s,f=a.extent2d.xmin*s,d=a.extent2d.ymax*s,m=f-e.xmin,g=e.ymax-d,p=n[0]-l[0],_=l[1]-n[1];if(t.drawImage(h,m+p,g+_,c,u),o){const{x:e,y:n,z:r}=i.info;PM(t,`${e}/${n}/${r}`,"yellow",1,m+p,g+_,c,u,-18)}}function PM(t,e,n,i,r,o,s,a,h=0){t.font="20px monospace",t.fillStyle=n,AM.y=a-30,t.globalAlpha=1,t.fillText(e,AM.x+r,AM.y+o+h),t.globalAlpha=.6,t.strokeStyle=n,t.lineWidth=i,t.beginPath(),t.moveTo(r,o),t.lineTo(r+s,o),t.lineTo(r+s,o+a),t.lineTo(r,o+a),t.lineTo(r,o),t.stroke(),t.globalAlpha=1}function RM(t,e){const n=+t.getUniform("depthMask"),i=+e.getUniform("depthMask");return n!==i?n-i:t.getUniform("level")-e.getUniform("level")}o.renderer.TileLayerCanvasRenderer.include({renderTerrainSkin(t,e,n,i,r,o){const{res:s,extent2d:a,offset:h}=n,l=e.options.debug,c=e.options.debugOutline,u=i.getContext("2d");o&&SM(u,a,h,o,s,l);for(let f=0;f<r.length;f++)SM(u,a,h,r[f],s,l);if(l){const t=n.x+"/"+n.y+"/"+n.z,{width:e,height:i}=u.canvas;PM(u,t,c,6,0,0,e,i)}this.layer.fire("renderterrainskin",{tile:n,skinTiles:r})}});const OM=new o.Coordinate(0,0),IM=new o.Point(0,0),DM=[],kM={tileGrids:[],count:0},LM="01",FM="1";class NM extends o.TileLayer{getTileUrl(t,e,n){let i=super.getTileUrl(t,e,n);const r=this.options.type;return"cesium"===r&&(e=(1<<(n-=1))-e-1),"mapbox"===r?this.options.requireSkuToken&&(this.qe||(this.qe=this.$e()),i.indexOf("?")>-1?i+="&sku="+this.qe:i+="?sku="+this.qe):"cesium"===r&&(i+="?extensions=octvertexnormals-watermask-metadata&v=1.2.0"),i}_getTileZoom(t){const e=this.options.maxAvailableZoom;this.options.maxAvailableZoom=null;const n=super._getTileZoom(t);return this.options.maxAvailableZoom=e,n}$e(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return[FM,LM,t].join("")}setSkinLayers(t){this.Xe=t;const e=this.getRenderer();e&&e.setToRedraw()}getSkinTiles(t){const e=this.getRenderer();if(!e)return kM;const n=e.getTileGridsInCurrentFrame().tileGrids[0];if(!n)return kM;const i=t.getId(),r=this._getTileConfig().tileSystem.scale,s=t.getTileSize().width,a=n.tiles;if(!a.length)return kM;const h=t.getSpatialReference(),l=a[0].extent2d.getWidth(),c=r.x,u=r.y,f=[],d=new Set;for(let m=0;m<a.length;m++){const e=a[m],{res:n}=e,{res:r,zoom:g}=vM(h,e.z,n),p=r/n,_=_M(r,s,n,l),{extent2d:v,offset:y}=e,x=_*e.x,b=_*e.y;if(e.skinTileIds||(e.skinTileIds={}),!e.skinTileIds[i]){const n=new Set,a=[],h=gM(t,e.x,e.y,g,y,_,0);for(let e=0;e<h.length;e++){let i=h[e];if(n.has(i.id))continue;i.idx=i.x,i.idy=i.y,i.res=r,i.url=t.getTileUrl(i.x,i.y,i.z+t.options.zoomOffset);const l=c*(i.x-x)*s,f=u*(i.y-b)*s,d=v.xmin*p+l,m=v.ymax*p+f;i.extent2d=new o.PointExtent(d,m-s,d+s,m),n.add(i.id),a.push(i)}e.skinTileIds[i]=a}const w=e.skinTileIds[i];for(let t=0;t<w.length;t++)d.has(w[t].id)||(f.push(w[t]),d.add(w[t].id))}return{tileGrids:[{extent:n.extent,tiles:f,count:f.length}],count:f.length}}getSkinLayer(t){return this.getSkinLayers()[t]}getSkinLayers(){return this.Xe||DM}getSkinCount(){return this.Xe&&this.Xe.length||0}queryTerrainByProjCoord(t){const e=this.getRenderer();if(!e)return 0;const n=this.getMap(),i=this.getSpatialReference(),r=e.getCurrentTileZoom(),o=i.getResolution(r),s=this.options.repeatWorld,a=this._getTileConfig().getTileIndex(t,o,s),h=n._prjToPointAtRes(t,o,IM);return e.Pe(a,h,o,r)}queryTerrain(t){if(!this.getRenderer())return 0;const e=this.getMap().getProjection().project(t,OM);return this.queryTerrainByProjCoord(e)}queryTileAltitude(t,e,n){const i=this.getRenderer();return i?i.De(t,e,n):null}queryTileMesh(t,e){const n=this.getRenderer();n&&n.Je(t,e)}}NM.include({_getTileId:(t,e,n)=>{const i=Math.sqrt(Math.pow(4,n));return""+((0===n?0:Math.pow(4,n-1))+t*i+e)}}),NM.mergeOptions({forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0,opacity:1,renderer:"gl",pyramidMode:1,tileSize:512,terrainWidth:65,backZoomOffset:-5,depthMask:!0,blendSrc:"one",blendDst:"one minus src alpha",requireSkuToken:!0}),NM.registerJSONType("TerrainLayer"),NM.registerRenderer("gl",EM);const BM=()=>{};class HM extends o.Layer{static fromJSON(t){if(!t||"GroupGLLayer"!==t.type)return null;const e=t.layers.map((t=>o.Layer.fromJSON(t)));return new HM(t.id,e,t.options)}constructor(t,e,n){super(t,n),this.layers=e||[],this.layers.forEach((t=>{if(t.getMap())throw new Error(`layer(${t.getId()} is already added on map`)})),this.Ye(),this.sortLayersByZIndex(),this.Ke={}}sortLayersByZIndex(){if(this.layers&&this.layers.length){for(let t=0,e=this.layers.length;t<e;t++)this.layers[t].__group_gl_order=t;this.layers.sort(zM)}}setSceneConfig(t){this.options.sceneConfig=t;const e=this.getRenderer();return e&&e.updateSceneConfig(),this}getSceneConfig(){return JSON.parse(JSON.stringify(this.options.sceneConfig||{}))}ct(){return this.options.sceneConfig}getGroundConfig(){const t=this.ct();return t?t.ground:null}getWeatherConfig(){const t=this.ct();return t&&t.weather}addLayer(t,e){if(t.getMap())throw new Error(`layer(${t.getId()} is already added on map`);void 0===e?this.layers.push(t):this.layers.splice(e,0,t),this.Ye(),this.sortLayersByZIndex();const n=this.getRenderer();return n?(this.Ze(t),n.setToRedraw(),this):this}removeLayer(t){o.Util.isString(t)&&(t=this.getChildLayer(t));const e=this.layers.indexOf(t);if(e<0)return this;t._doRemove(),this.Qe(t),delete this.Ke[t.getId()],this.layers.splice(e,1);const n=this.getRenderer();return n?(n.setToRedraw(),this):this}Ci(){let t=0;for(let n=0;n<this.layers.length;n++)this.layers[n].setPolygonOffset&&this.layers[n].getPolygonOffsetCount&&(t+=this.layers[n].getPolygonOffsetCount());let e=0;for(let n=0;n<this.layers.length;n++)this.layers[n].setPolygonOffset&&this.layers[n].getPolygonOffsetCount&&(this.layers[n].setPolygonOffset(e,t),e+=this.layers[n].getPolygonOffsetCount())}getLayers(){return this.layers}toJSON(){const t=[];if(this.layers)for(let e=0;e<this.layers.length;e++){const n=this.layers[e];n&&n&&n.toJSON&&t.push(n.toJSON())}return{type:this.getJSONType(),id:this.getId(),layers:t,options:this.config()}}onLoadEnd(){this.layers.forEach((t=>{this.Ze(t)})),this.options.terrain&&this.ts(),super.onLoadEnd()}Ze(t){const e=this.getMap();this.Ke[t.getId()]=t,t._canvas=this.getRenderer().canvas,t._bindMap(e),t.once("renderercreate",this.es,this),t.once("remove",(t=>{this.removeLayer(t.target)})),t.load(),this.ss(t)}onRemove(){this.ns(),this.layers.forEach((t=>{this.rs(t),t._doRemove(),this.Qe(t)})),this.Ke={},this.clearAnalysis(),super.onRemove()}getChildLayer(t){return this.Ke[t]||null}getLayer(t){return this.getChildLayer(t)}ss(t){t.on("show hide",this.hs,this),t.on("idchange",this.os,this)}Qe(t){t.off("show hide",this.hs,this),t.off("idchange",this.os,this)}hs(){const t=this.getRenderer();t&&t.setToRedraw()}os(t){const e=t.new,n=t.old,i=this.getLayer(n);delete this.Ke[n],this.Ke[e]=i}es(t){t.renderer.clearCanvas=jM}Ye(){const t={};this.layers.forEach((e=>{const n=e.getId();if(t[n])throw new Error(`Duplicate child layer id (${n}) in the GroupGLLayer (${this.getId()})`);t[n]=1}))}addAnalysis(t){this.pi=this.pi||[],this.pi.push(t);const e=this.getRenderer();e&&e.setToRedraw()}removeAnalysis(t){if(this.pi){const e=this.pi.indexOf(t);e>-1&&(this.pi.splice(e,1),t.remove())}const e=this.getRenderer();e&&e.setToRedraw()}clearAnalysis(){this.pi&&(this.pi.forEach((t=>{t.remove()})),this.pi=[]);const t=this.getRenderer();t&&t.setToRedraw()}identify(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const r=n.coordToContainerPoint(new o.Coordinate(t));return this.identifyAtPoint(r,e)}identifyAtPoint(t,e={}){const n=e.includeInternals,i=this.getLayers(),r=e&&e.childLayers||i,o=this.getMap();if(!o)return[];const s=sT(e.count)?1:e.count;let a=[];for(let h=r.length-1;h>=0;h--){const o=r[h];if(i.indexOf(o)<0||!o.identifyAtPoint)continue;const s=o.options.geometryEvents;if(n&&(void 0===s||!1===s||0===s))continue;let l=o.identifyAtPoint(t,e);l&&l.length&&(e.filter&&(l=l.filter((t=>e.filter(t)))),l.length&&a.push(...l))}if(e.orderByCamera){const t=o.cameraPosition;a.sort(((e,n)=>n.point?e.point?In(e.point,t)-In(n.point,t):1:-1))}return s&&(a=a.slice(0,s)),a}getTerrain(){return this.options.terrain}setTerrain(t){return t===this.options.terrain?this:(this.options.terrain=t,this.getRenderer()?(this.ts(),this):this)}ts(){const t=this.getRenderer();t&&t.setToRedraw();const e=this.options.terrain;if(this.he){const t=this.he.options;if(e&&t.urlTemplate===e.urlTemplate&&t.spatialReference===e.spatialReference){for(const t in e)"urlTemplate"!==t&&"spatialReference"!==t&&this.he.config(t,e[t]);return this}this.as(),this.ns()}if(!e)return this;this.he=new NM("__terrain_in_group",e),this.ls(),this.he.on("tileload",this.cs,this),this.Ze(this.he),this.fire("terrainlayercreated")}queryTerrain(t){return this.he?this.he.queryTerrain(t):0}queryTerrainByProjCoord(t){return this.he?this.he.queryTerrainByProjCoord(t):0}ls(){this.us||(this.us={});const t=this.layers,e=[];for(let n=0;n<t.length;n++){if(!t[n])continue;const i=t[n],r=i.getRenderer();r.renderTerrainSkin&&(this.us[i.getId()]=i.options.background,i.options.background=!1,i.getTiles=()=>this.he.getSkinTiles(i),i.isTerrainSkin=1,r.drawTileOnTerrain?r.drawTile=(...t)=>r.drawTileOnTerrain(...t):r.drawTile=BM,e.push(t[n])),r.setTerrainHelper&&r.setTerrainHelper(this.he)}this.he.setSkinLayers(e)}rs(t){if(!t.isTerrainSkin)return;const e=t.getRenderer();if(e&&delete e.drawTile,delete t.getTiles,delete t.isTerrainSkin,this.us){const e=this.us[t.getId()];void 0!==e?t.options.background=e:delete t.options.background,delete this.us[t.getId()]}}as(){const t=this.layers;for(let e=0;e<t.length;e++)t[e]&&this.rs(t[e]);delete this.us}cs(){const t=this.getRenderer();t&&t.setToRedraw()}ns(){if(this.he){const t=this.he;t.off("tileload",this.cs,this),this.Qe(t),this.he._doRemove(),delete this.he,this.fire("terrainlayerremoved")}}getTerrainLayer(){return this.he}_bindMap(...t){if(this.options.single){const e=t[0].getLayers();for(let t=0;t<e.length;t++)if(e[t]instanceof HM)throw new Error("Only one GroupGLLayer is allowed in a map instance. Set options.single to false if you want to add two or more GroupGLLayers.")}return super._bindMap(...t)}}function jM(){}function zM(t,e){const n=t.getZIndex()-e.getZIndex();return 0===n?t.__group_gl_order-e.__group_gl_order:n}HM.mergeOptions({renderer:"gl",antialias:!0,extensions:[],single:!0,onlyWebGL1:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,viewMoveThreshold:100,geometryEvents:!0,multiSamples:4}),HM.registerJSONType("GroupGLLayer"),HM.registerRenderer("gl",hM),HM.registerRenderer("canvas",null);class GM{constructor(t){this.fs=t,this.D=new Qa,this.onHDRLoaded=this.ds.bind(this),this.onHDRError=this.gs.bind(this)}getDirectionalLight(){return this.Nt&&this.Nt.directional||{}}getAmbientLight(){return this.Nt&&this.Nt.ambient||{}}getAmbientResource(){return this.ps}setConfig(t){const e=this.Nt;this.Nt=JSON.parse(JSON.stringify(t));let n=!1;if(t&&t.ambient&&t.ambient.resource){if(!(e&&e.ambient&&function(t,e){return!!t.resource&&t.resource.url===e.resource.url}(e.ambient,t.ambient)))return void this.ms();this.ps&&(t.ambient.prefilterCubeSize!==e.ambient&&e.ambient.prefilterCubeSize&&this.ds(),n=!0,t.ambient.resource.sh&&(this.ps.sh=t.ambient.resource.sh))}else this.vs(),n=e&&e.ambient&&e.ambient.resource;this.fs.fire("updatelights",{ambientUpdate:n})}ws(t){const e=t.getLayers();for(let r=0;r<e.length;r++){const t=e[r]&&e[r].getRenderer();if(t&&t.regl)return t.regl}const n=document.createElement("canvas"),i=a({canvas:n,attributes:{depth:!1,stencil:!1,alpha:!1}});return i.bs=!0,i}ms(){const t={url:this.Nt.ambient.resource.url,arrayBuffer:!0,hdr:!0,flipY:!0};this._s=new Eh(t,this.D),this._s.once("complete",this.onHDRLoaded),this._s.once("error",this.onHDRError)}dispose(){this.vs()}ds(){this._s&&(this.ps=this.Ms(this._s),this.fs.fire("updatelights",{ambientUpdate:!0}))}gs(){this.fs.fire("hdrerror")}Ms(t){const e=this.Nt.ambient.resource,n=this.Nt.ambient.prefilterCubeSize||256,i=this.ws(this.fs),r=tw.PBRHelper.createIBLMaps(i,{envTexture:t.getREGLTexture(i),rgbmRange:t.rgbmRange,ignoreSH:!!e.sh,envCubeSize:n,prefilterCubeSize:n,format:"array"});if(e.sh&&(r.sh=e.sh,Array.isArray(r.sh[0]))){const t=r.sh,e=[];for(let n=0;n<t.length;n++)e.push(...t[n]);r.sh=e}return i.bs&&(delete this._s,i.destroy()),r}vs(){this._s&&(this._s.dispose(),delete this._s),delete this.ps}}let UM,VM,WM,XM;e.Map.include({setLights(t){return this.options.lights=t,this.xs(),this},getLights(){return this.options.lights},xs(){this.ys||(this.ys=new GM(this)),this.ys.setConfig(this.getLights())},getLightManager(){return this.ys?this.ys:(this.Cs||(this.Cs=!0,console.warn("map's light config is not set, use map.setLights(config) to set lights.")),null)}}),e.Map.addOnLoadHook((function(){this.options.lights&&this.xs()}));const ZM={color:[0,0,0,0]},qM={enable:!0};e.Map.include({setPostProcessConfig(t){return this.options.postProcessConfig=t,this},getPostProcessConfig(){return this.options.postProcessConfig}});const YM=e.renderer.MapCanvasRenderer.prototype.drawLayerCanvas;e.renderer.MapCanvasRenderer.prototype.drawLayerCanvas=function(){const t=YM.apply(this,arguments);return t&&JM(this,this.canvas),t};const KM=e.renderer.MapCanvasRenderer.prototype.renderFrame;function JM(t,e){const n=t.map.getPostProcessConfig();if(!n||!n.enable)return;var i,r;UM||(i=e.width,r=e.height,UM=document.createElement("canvas",i,r),VM=a({canvas:UM,attributes:{depth:!1,stencil:!1,alpha:!0,antialias:!1,premultipliedAlpha:!1}}),WM=VM.texture({mag:"linear",min:"linear",mipmap:!1,flipY:!0,width:i,height:r}),XM=VM.texture()),UM.width===e.width&&UM.height===e.height||(UM.width=e.width,UM.height=e.height),VM.clear(ZM);const o=n.filmicGrain||qM;void 0===o.enable&&(o.enable=!0);const s=n.vignette||qM;void 0===s.enable&&(s.enable=!0);const h=n.colorLUT||qM;void 0===h.enable&&(h.enable=!0),t.Ss||(t.Ss={});const l=t.Ss;if(h.enable){const e=h.lut;if(!l.lutTexture||l.lutTexture.url!==e){const n=new Image;n.onload=function(){const i={data:n,min:"linear",mag:"linear"},r=l.lutTexture?l.lutTexture.texture(i):VM.texture(i);l.lutTexture={url:e,texture:r},t.setLayerCanvasUpdated()},n.src=e}}const c={enableGrain:+!!o.enable,grainFactor:void 0===o.factor?.15:o.factor,timeGrain:performance.now(),enableVignette:+!!s.enable,lensRadius:s.lensRadius||[.8,.25],frameMod:1,enableLut:+!!h.enable,lookupTable:l.lutTexture?l.lutTexture.texture:XM};(void 0).postprocess(c,WM({width:UM.width,height:UM.height,data:e,flipY:!0,mag:"linear",min:"linear",mipmap:!1})),o.enable&&t.setLayerCanvasUpdated(),t.context.drawImage(UM,0,0,UM.width,UM.height)}e.renderer.MapCanvasRenderer.prototype.renderFrame=function(){const t=KM.apply(this,arguments),e=this.map.getPostProcessConfig(),n=e&&e.filmicGrain;return!n||void 0!==n.enable&&!0!==n.enable||this.setLayerCanvasUpdated(),t};const QM=[];function $M(t){const e=t.defines;delete e.HAS_HIGHLIGHT_COLOR,delete e.HAS_HIGHLIGHT_OPACITY,t.setDefines(e),delete t.properties.highlightTimestamp,t.properties.oldElementsBeforeHighlight&&(t.geometry.elements.destroy(),t.geometry.setElements(t.properties.oldElementsBeforeHighlight),delete t.properties.oldElementsBeforeHighlight,delete t.properties.hasInvisible),tA(t)}function tA(t){if(!t)return;const{hlBloomMesh:e}=t.properties;if(e){const n=e.geometry;n.elements&&n.elements.destroy&&n.elements.destroy(),e.dispose(),delete t.properties.hlBloomMesh}}var eA=Object.freeze({__proto__:null,clearHighlight:$M,highlightMesh:function(t,e,n,i,r){const{highlightTimestamp:o}=e.properties;if(!n)return void(o&&$M(e));if(i===o)return;const s=e.geometry.getVertexCount();let{aHighlightColor:a,aHighlightOpacity:h}=e.geometry.properties;a&&a.fill(0),h&&h.fill(255);let l=!1,c=!1;const u=n.keys();let f=null,d=null;for(const p of u)if(r.has(p)){let t,{color:e,opacity:i,bloom:o,visible:u}=n.get(p);e&&(l||(a||(a=new Uint8Array(4*s)),l=!0),t=uT(QM,e)),i=sT(i)?1:i,i<1&&(c||(h||(h=new Uint8Array(s),h.fill(255)),c=!0)),!1===u&&(d||(d=new Set),d.add(p));const m=r.get(p);if(m)for(let n=0;n<m.length;n++){const e=m[n];t&&Gn(a.subarray(4*e,4*e+4),...t),i<1&&(h[e]=255*i),o&&(f||(f=[]),f.push(e))}}const m=e.defines;if(l?(e.geometry.data.aHighlightColor?e.geometry.updateData("aHighlightColor",a):(e.geometry.data.aHighlightColor=a,e.geometry.generateBuffers(t)),e.geometry.properties.aHighlightColor=a,m.HAS_HIGHLIGHT_COLOR=1):m.HAS_HIGHLIGHT_COLOR&&(e.geometry.updateData("aHighlightColor",a),delete m.HAS_HIGHLIGHT_COLOR),c?(e.geometry.data.aHighlightOpacity?e.geometry.updateData("aHighlightOpacity",h):(e.geometry.data.aHighlightOpacity=h,e.geometry.generateBuffers(t)),e.geometry.properties.aHighlightOpacity=h,m.HAS_HIGHLIGHT_OPACITY=1):m.HAS_HIGHLIGHT_OPACITY&&(e.geometry.updateData("aHighlightOpacity",h),delete m.HAS_HIGHLIGHT_OPACITY),d&&d.size>0){let n=[];r.forEach(((t,e)=>{d.has(e)||function(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,i=n.length;e<i;e++)t.push(n[e])}t.length}(n,t)})),e.properties.hasInvisible=!0,e.properties.oldElementsBeforeHighlight||(e.properties.oldElementsBeforeHighlight=e.geometry.elements);const i={data:n,primitive:e.geometry.getPrimitive()};e.geometry.elements!==e.properties.oldElementsBeforeHighlight&&e.geometry.elements.destroy&&e.geometry.elements.destroy(),n=t.elements(i),e.geometry.setElements(n),e.geometry.generateBuffers(t)}else e.properties.hasInvisible&&(e.geometry.elements&&e.geometry.elements.destroy&&e.geometry.elements.destroy(),e.geometry.setElements(e.properties.oldElementsBeforeHighlight),delete e.properties.hasInvisible,delete e.properties.oldElementsBeforeHighlight);e.setDefines(m),e.properties.highlightTimestamp=i;let g=e.properties.hlBloomMesh;if(f&&f.length){if(g){const t=Kt(g.localTransform,e.localTransform),n=Kt(g.positionMatrix,e.positionMatrix);g.setLocalTransform(t),g.setPositionMatrix(n),e.properties.hlBloomMesh.geometry.setElements(f)}else{const n=new La(e.geometry.data,f,0,e.geometry.desc);n.generateBuffers(t);const i=e.material;g=new Ya(n,i,e.config);const r=e.uniforms;for(const t in r)Object.defineProperty(g.uniforms,t,{enumerable:!0,get:function(){return e.getUniform(t)}});const o=oT({},e.defines);o.HAS_BLOOM=1;const s=Kt([],e.localTransform),a=Kt([],e.positionMatrix);g.setLocalTransform(s),g.setPositionMatrix(a),oT(g.properties,e.properties),oT(n.properties,e.geometry.properties),g.setDefines(o),g.bloom=1}e.properties.hlBloomMesh=g}else g&&tA(e)},deleteHighlightBloomMesh:tA});const nA=[0,0,0,0];class iA{constructor(t,e,n,i,r,o){this.renderer=new Ta(t),this.sceneConfig=e,this.i=n,this.Ts=i,this.Os=r,this.ks=o||{factor:0,units:0},this.s(),this.As=[]}render(t,e,n){this.Ls();const i=this.i.getMap();this.renderer.regl.clear({color:nA,depth:1,stencil:255,framebuffer:this.Es}),this.renderer.render(this.Fs,e,t,this.Es);const r=this.i.getRenderer().canvas;this.As[0]=r.width,this.As[1]=r.height;const o=oT({colorRamp:this.Is,inputTexture:this.Es,projViewMatrix:i.projViewMatrix,textureOutputSize:this.As},e);this.p(),this.renderer.render(this.Ps,o,this.R,n)}dispose(){this.Fs&&(this.Fs.dispose(),delete this.Fs),this.Ps&&(this.Ps.dispose(),delete this.Ps),this.M&&(this.M.geometry.dispose(),this.M.dispose(),delete this.M,delete this.R),this.Es&&(this.Es.destroy(),delete this.Es)}Rs(){const t=this.Ts;let e=this.Hs,n=this.Ds;n?n.clearRect(0,0,256,1):(e=this.Hs=document.createElement("canvas"),e.width=256,e.height=1,n=this.Ds=e.getContext("2d"));const i=n.createLinearGradient(0,0,256,1);for(let o=0;o<t.length;o++)i.addColorStop(t[o][0],t[o][1]);n.fillStyle=i,n.fillRect(0,0,256,1),this.Is&&this.Is.destroy();const r=this.renderer.regl;this.Is=r.texture({width:256,height:1,data:e,min:"linear",mag:"linear",premultiplyAlpha:!0})}Ls(){const t=this.i.getRenderer().canvas,e=Math.ceil(t.width/4),n=Math.ceil(t.height/4),i=this.Es;i.width===e&&i.height===n||i.resize(e,n)}s(){this.Rs(),this.js(),this.Ns(),this.u()}u(){const t=new Sh;t.generateBuffers(this.renderer.regl),this.M=new Ya(t),this.R=new nh([this.M])}p(){const t=this.i.getMap(),e=bT.getGroundTransform(this.M.localTransform,t);this.M.setLocalTransform(e)}Ns(){const t=this.i.getRenderer().canvas,e=this.renderer.regl,n=e.hasExtension("OES_texture_half_float")?"half float":"float",i=Math.ceil(t.width/4),r=Math.ceil(t.height/4),o=e.texture({width:i,height:r,type:n,min:"linear",mag:"linear",format:"rgba"});this.Es=e.framebuffer({width:i,height:r,color:[o]})}js(){const t=this.i.getRenderer().canvas,e=this.sceneConfig.depthRange,n={viewport:{x:0,y:0,width:()=>t?Math.ceil(t.width/4):1,height:()=>t?Math.ceil(t.height/4):1},depth:{enable:!0,func:"always"}};this.Os&&(n.stencil=this.Os),this.Fs=new pl({extraCommandProps:n}),this.Ps=new xl({x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},{extraCommandProps:{stencil:{enable:!1},depth:{enable:!0,range:e||[0,1],func:"<="},polygonOffset:{enable:!0,offset:this.ks},scissor:{enable:!1}}})}}const rA={"clip-inside":.1,"clip-outside":.2,"flat-inside":.3,"flat-outside":.4,color:.5};function oA(t){return class extends t{setMask(t){if(!t)return void this.Gs();const n=this.getRenderer(),i=this.getMap(),r=[];let o=1/0,s=1/0,a=-1/0,h=-1/0,l=-1/0,c=1/0;for(let e=0;e<t.length;e++){const n=t[e],u=n.polygons;for(let t=0;t<u.length;t++){const e=u[t],f=e.getCoordinates()[0].map((t=>sA(i,t))),d=e.getSymbol(),{polygonFill:m,polygonOpacity:g}=d,p=cT([],m);p[3]=g||.6;const _={maskColor:p,position:f,maskMode:this.Bs(n.mode),flatHeight:this.Vs(n.flatHeight)||0,heightRange:n.heightRange?[this.Vs(n.heightRange[0]),this.Vs(n.heightRange[1])]:[0,0]};r.push(_);const v=e.getExtent();v.xmin<o&&(o=v.xmin),v.ymin<s&&(s=v.ymin),v.xmax>a&&(a=v.xmax),v.ymax>h&&(h=v.ymax),_.heightRange[0]<c&&(c=_.heightRange[0]),_.heightRange[1]>l&&(l=_.heightRange[1]),_.flatHeight<c&&(c=_.flatHeight),_.flatHeight>l&&(l=_.flatHeight)}}const{ratio:u,minHeight:f}=this.Us(r,c,l),d=new e.Extent(o,s,a,h),{projViewMatrix:m,mapExtent:g}=this.zs(d),p=sA(i,new e.Coordinate(g.xmin,g.ymin)),_=sA(i,new e.Coordinate(g.xmax,g.ymax)),v=[p[0],p[1],_[0],_[1]];n?n.setMask(r,v,m,u,f):this.once("renderercreate",(t=>{t.renderer.setMask(r,v,m,u,f)}))}Gs(){const t=this.getRenderer();t?t.clearMask():this.once("renderercreate",(t=>{t.renderer.clearMask()}))}Us(t,e,n){const i=e,r=n,o=Math.abs(r-i);if(0===o)return{ratio:1,minHeight:0};const s=Math.pow(o,-1);for(let a=0;a<t.length;a++)t[a].flatHeight=(t[a].flatHeight-i)*s,t[a].heightRange[0]=(t[a].heightRange[0]-i)*s,t[a].heightRange[1]=(t[a].heightRange[1]-i)*s;return{ratio:s,minHeight:i}}zs(t){const e=this.getMap(),n=e.getView(),i=e.getFitZoom(t),r=t.getCenter();e.setView({center:r,zoom:i,pitch:0,bearing:0});const o=e.getExtent(),s=Kt([],e.projViewMatrix);return e.setView(n),{mapExtent:o,projViewMatrix:s}}Bs(t){if(!rA[t])throw new Error("invalid mask mode type!");return rA[t]}Vs(t=0){const e=this.getMap(),n=e.getGLRes();return e.altitudeToPoint(t,n)}}}function sA(t,n,i=0){if(!(t&&n instanceof e.Coordinate))return null;const r=t.coordinateToPointAtRes(n,t.getGLRes());return[r.x,r.y,i]}function aA(t){return class extends t{clearMask(){delete this.Ws.mask_colorExtent,delete this.Ws.mask_extent,delete this.Ws.mask_modeExtent,delete this.Ws.mask_hasFlatOut,delete this.Ws.mask_hasClipOut,delete this.Ws.mask_heightRatio,delete this.Ws.mask_heightOffset,this.qs&&(this.qs.dispose(),delete this.qs),this.setToRedraw()}setMask(t,e,n,i,r){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),this.qs?this.$s(t,e,n,i,r):this.regl?(this.qs=new Nx(this.regl,this.viewport),this.$s(t,e,n,i,r)):this.layer.once("contextcreate",(()=>{this.qs=new Nx(this.regl,this.viewport),this.$s(t,e,n,i,r)}),this)}$s(t,e,n,i,r){this.qs.setExtentPositions(t);const{colorExtent:o,modeExtent:s}=this.qs.render(n);this.Ws=this.Ws||{},this.Ws.mask_colorExtent=o,this.Ws.mask_extent=e,this.Ws.mask_modeExtent=s,this.Ws.mask_hasFlatOut=this.Xs(t,.4),this.Ws.mask_hasClipOut=this.Xs(t,.2),this.Ws.mask_heightRatio=i,this.Ws.mask_heightOffset=r,this.setToRedraw()}Xs(t,e){for(let n=0;n<t.length;n++)if(t[n].maskMode===e)return 1;return 0}getMaskUniforms(){return this.Ws}getMaskDefines(){return this.Js||(this.Js={}),this.Ws&&this.Ws.mask_colorExtent?this.Js.HAS_MASK_EXTENT=1:delete this.Js.HAS_MASK_EXTENT,this.Js}}}"undefined"!=typeof window&&window.maptalks&&(window.maptalks.GroupGLLayer=HM);const hA=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("unable to locate global object")},lA=hA(),cA=lA.gl_trans__coders=lA.gl_trans__coders||{};function uA(t){const e=t.toString(),n=e.indexOf("{")+1,i=e.substring(0,n),r=lA.gl_trans__coders=lA.gl_trans__coders||{};let o=`${i}\n    const _____getGlobal = ${hA.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const s in r)"inject"!==s&&"getTranscoder"!==s&&"registerTranscoder"!==s&&(o+='tran_____scoders["'+s+'"] ='+r[s].toString()+"\n;");return o+="\n"+e.substring(i.length),o}function fA(t){return cA[t]}function dA(t,e){cA[t]=e}cA.inject=uA,cA.registerTranscoder=dA,cA.getTranscoder=fA;const mA="${",gA=`function(r){var t="undefined"!=typeof Float32Array?Float32Array:Array;function e(){var r=new t(3);return t!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function i(r,e,i){var n=new t(3);return n[0]=r,n[1]=e,n[2]=i,n}function n(){var r=new t(4);return t!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}e(),function(){var r,e=(r=new t(4),t!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r)}();var s;e(),i(1,0,0),i(0,1,0),n(),n(),s=new t(9),t!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1;\n/*!\n   * @maptalks/gltf-loader v0.27.2\n   * LICENSE : UNLICENSED\n   * (c) 2016-2022 maptalks.org\n   */\nlet a=0;!function(r){r[0]=0,r[1]=0,r[2]=0,r[3]=1}([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const o={get:function(r,t={}){t||(t={});const e=new AbortController,i=e.signal,n=function(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const t in e)r[t]=e[t]}return r}({},t);n.signal=i,n.method||(n.method="GET");const s=fetch(r,n).then(r=>{const e=this.U(r,t.responseType);return e.message?e:e.then(e=>"arraybuffer"===t.responseType?{data:e,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}:e).catch(r=>{if(!r.code||r.code!==DOMException.ABORT_ERR)throw r})}).catch(r=>{if(!r.code||r.code!==DOMException.ABORT_ERR)throw r});return s.xhr=e,s},U:(r,t)=>200!==r.status?{status:r.status,statusText:r.statusText,message:\`incorrect http request with status code(${mA}r.status}): ${mA}r.statusText}\`}:"arraybuffer"===t?r.arrayBuffer():"json"===t?r.json():r.text(),getArrayBuffer:(r,t={})=>(t||(t={}),t.responseType="arraybuffer",o.get(r,t)),getJSON:function(r,t={}){return t&&t.jsonp?o.jsonp(r):((t=t||{}).responseType="json",o.get(r,t))},jsonp:function(r){const t="_maptalks_jsonp_"+a++;r.match(/\\?/)?r+="&callback="+t:r+="?callback="+t;let e=document.createElement("script");return e.type="text/javascript",e.src=r,new Promise(r=>{window[t]=function(i){document.getElementsByTagName("head")[0].removeChild(e),e=null,delete window[t],r(i)},document.getElementsByTagName("head")[0].appendChild(e)})}};if("undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let r;try{r=new OffscreenCanvas(2,2).getContext("2d")}catch(r){}}"undefined"!=typeof document&&document.createElement("canvas"),function(){function r(r){throw r}var t=void 0,e=!0,i=this;function n(r,e){var n,s=r.split("."),a=i;!(s[0]in a)&&a.execScript&&a.execScript("var "+s[0]);for(;s.length&&(n=s.shift());)s.length||e===t?a=a[n]?a[n]:a[n]={}:a[n]=e}var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function a(t,e){this.index="number"==typeof e?e:0,this.i=0,this.buffer=t instanceof(s?Uint8Array:Array)?t:new(s?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&r(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var r,t=this.buffer,e=t.length,i=new(s?Uint8Array:Array)(e<<1);if(s)i.set(t);else for(r=0;r<e;++r)i[r]=t[r];return this.buffer=i},a.prototype.d=function(r,t,e){var i,n=this.buffer,s=this.index,a=this.i,o=n[s];if(e&&1<t&&(r=8<t?(l[255&r]<<24|l[r>>>8&255]<<16|l[r>>>16&255]<<8|l[r>>>24&255])>>32-t:l[r]>>8-t),8>t+a)o=o<<t|r,a+=t;else for(i=0;i<t;++i)o=o<<1|r>>t-i-1&1,8==++a&&(a=0,n[s++]=l[o],o=0,s===n.length&&(n=this.f()));n[s]=o,this.buffer=n,this.i=a,this.index=s},a.prototype.finish=function(){var r,t=this.buffer,e=this.index;return 0<this.i&&(t[e]<<=8-this.i,t[e]=l[t[e]],e++),s?r=t.subarray(0,e):(t.length=e,r=t),r};var o,c=new(s?Uint8Array:Array)(256);for(o=0;256>o;++o){for(var h=u=o,f=7,u=u>>>1;u;u>>>=1)h<<=1,h|=1&u,--f;c[o]=(h<<f&255)>>>0}var l=c;function y(r){this.buffer=new(s?Uint16Array:Array)(2*r),this.length=0}function d(r){var t,e,i,n,a,o,c,h,f,u,l=r.length,y=0,d=Number.POSITIVE_INFINITY;for(h=0;h<l;++h)r[h]>y&&(y=r[h]),r[h]<d&&(d=r[h]);for(t=1<<y,e=new(s?Uint32Array:Array)(t),i=1,n=0,a=2;i<=y;){for(h=0;h<l;++h)if(r[h]===i){for(o=0,c=n,f=0;f<i;++f)o=o<<1|1&c,c>>=1;for(u=i<<16|h,f=o;f<t;f+=a)e[f]=u;++n}++i,n<<=1,a<<=1}return[e,y,d]}function A(r,t){this.h=p,this.w=0,this.input=s&&r instanceof Array?new Uint8Array(r):r,this.b=0,t&&(t.lazy&&(this.w=t.lazy),"number"==typeof t.compressionType&&(this.h=t.compressionType),t.outputBuffer&&(this.a=s&&t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.b=t.outputIndex)),this.a||(this.a=new(s?Uint8Array:Array)(32768))}y.prototype.getParent=function(r){return 2*((r-2)/4|0)},y.prototype.push=function(r,t){var e,i,n,s=this.buffer;for(e=this.length,s[this.length++]=t,s[this.length++]=r;0<e&&(i=this.getParent(e),s[e]>s[i]);)n=s[e],s[e]=s[i],s[i]=n,n=s[e+1],s[e+1]=s[i+1],s[i+1]=n,e=i;return this.length},y.prototype.pop=function(){var r,t,e,i,n,s=this.buffer;for(t=s[0],r=s[1],this.length-=2,s[0]=s[this.length],s[1]=s[this.length+1],n=0;!((i=2*n+2)>=this.length)&&(i+2<this.length&&s[i+2]>s[i]&&(i+=2),s[i]>s[n]);)e=s[n],s[n]=s[i],s[i]=e,e=s[n+1],s[n+1]=s[i+1],s[i+1]=e,n=i;return{index:r,value:t,length:this.length}};var w,p=2,b={NONE:0,r:1,k:p,N:3},v=[];for(w=0;288>w;w++)switch(!0){case 143>=w:v.push([w+48,8]);break;case 255>=w:v.push([w-144+400,9]);break;case 279>=w:v.push([w-256+0,7]);break;case 287>=w:v.push([w-280+192,8]);break;default:r("invalid literal: "+w)}function k(r,t){this.length=r,this.G=t}A.prototype.j=function(){var i,n,o,c,h=this.input;switch(this.h){case 0:for(o=0,c=h.length;o<c;){var f,u,l,y=n=s?h.subarray(o,o+65535):h.slice(o,o+65535),d=(o+=n.length)===c,A=t,w=t,b=this.a,k=this.b;if(s){for(b=new Uint8Array(this.a.buffer);b.length<=k+y.length+5;)b=new Uint8Array(b.length<<1);b.set(this.a)}if(f=d?1:0,b[k++]=0|f,l=65536+~(u=y.length)&65535,b[k++]=255&u,b[k++]=u>>>8&255,b[k++]=255&l,b[k++]=l>>>8&255,s)b.set(y,k),k+=y.length,b=b.subarray(0,k);else{for(A=0,w=y.length;A<w;++A)b[k++]=y[A];b.length=k}this.b=k,this.a=b}break;case 1:var m=new a(s?new Uint8Array(this.a.buffer):this.a,this.b);m.d(1,1,e),m.d(1,2,e);var U,E,T,F=g(this,h);for(U=0,E=F.length;U<E;U++)if(T=F[U],a.prototype.d.apply(m,v[T]),256<T)m.d(F[++U],F[++U],e),m.d(F[++U],5),m.d(F[++U],F[++U],e);else if(256===T)break;this.a=m.finish(),this.b=this.a.length;break;case p:var D,z,q,C,N,O,j,I,Z,S,$,_,V,B,L,P=new a(s?new Uint8Array(this.a.buffer):this.a,this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],G=Array(19);for(D=p,P.d(1,1,e),P.d(D,2,e),z=g(this,h),j=M(O=x(this.L,15)),Z=M(I=x(this.K,7)),q=286;257<q&&0===O[q-1];q--);for(C=30;1<C&&0===I[C-1];C--);var H,R,Y,J,K,X,Q=q,rr=C,tr=new(s?Uint32Array:Array)(Q+rr),er=new(s?Uint32Array:Array)(316),ir=new(s?Uint8Array:Array)(19);for(H=R=0;H<Q;H++)tr[R++]=O[H];for(H=0;H<rr;H++)tr[R++]=I[H];if(!s)for(H=0,J=ir.length;H<J;++H)ir[H]=0;for(H=K=0,J=tr.length;H<J;H+=R){for(R=1;H+R<J&&tr[H+R]===tr[H];++R);if(Y=R,0===tr[H])if(3>Y)for(;0<Y--;)er[K++]=0,ir[0]++;else for(;0<Y;)(X=138>Y?Y:138)>Y-3&&X<Y&&(X=Y-3),10>=X?(er[K++]=17,er[K++]=X-3,ir[17]++):(er[K++]=18,er[K++]=X-11,ir[18]++),Y-=X;else if(er[K++]=tr[H],ir[tr[H]]++,3>--Y)for(;0<Y--;)er[K++]=tr[H],ir[tr[H]]++;else for(;0<Y;)(X=6>Y?Y:6)>Y-3&&X<Y&&(X=Y-3),er[K++]=16,er[K++]=X-3,ir[16]++,Y-=X}for(i=s?er.subarray(0,K):er.slice(0,K),S=x(ir,7),B=0;19>B;B++)G[B]=S[W[B]];for(N=19;4<N&&0===G[N-1];N--);for($=M(S),P.d(q-257,5,e),P.d(C-1,5,e),P.d(N-4,4,e),B=0;B<N;B++)P.d(G[B],3,e);for(B=0,L=i.length;B<L;B++)if(_=i[B],P.d($[_],S[_],e),16<=_){switch(B++,_){case 16:V=2;break;case 17:V=3;break;case 18:V=7;break;default:r("invalid code: "+_)}P.d(i[B],V,e)}var nr,sr,ar,or,cr,hr,fr,ur,lr=[j,O],yr=[Z,I];for(cr=lr[0],hr=lr[1],fr=yr[0],ur=yr[1],nr=0,sr=z.length;nr<sr;++nr)if(ar=z[nr],P.d(cr[ar],hr[ar],e),256<ar)P.d(z[++nr],z[++nr],e),or=z[++nr],P.d(fr[or],ur[or],e),P.d(z[++nr],z[++nr],e);else if(256===ar)break;this.a=P.finish(),this.b=this.a.length;break;default:r("invalid compression type")}return this.a};var m=function(){function t(t){switch(!0){case 3===t:return[257,t-3,0];case 4===t:return[258,t-4,0];case 5===t:return[259,t-5,0];case 6===t:return[260,t-6,0];case 7===t:return[261,t-7,0];case 8===t:return[262,t-8,0];case 9===t:return[263,t-9,0];case 10===t:return[264,t-10,0];case 12>=t:return[265,t-11,1];case 14>=t:return[266,t-13,1];case 16>=t:return[267,t-15,1];case 18>=t:return[268,t-17,1];case 22>=t:return[269,t-19,2];case 26>=t:return[270,t-23,2];case 30>=t:return[271,t-27,2];case 34>=t:return[272,t-31,2];case 42>=t:return[273,t-35,3];case 50>=t:return[274,t-43,3];case 58>=t:return[275,t-51,3];case 66>=t:return[276,t-59,3];case 82>=t:return[277,t-67,4];case 98>=t:return[278,t-83,4];case 114>=t:return[279,t-99,4];case 130>=t:return[280,t-115,4];case 162>=t:return[281,t-131,5];case 194>=t:return[282,t-163,5];case 226>=t:return[283,t-195,5];case 257>=t:return[284,t-227,5];case 258===t:return[285,t-258,0];default:r("invalid length: "+t)}}var e,i,n=[];for(e=3;258>=e;e++)i=t(e),n[e]=i[2]<<24|i[1]<<16|i[0];return n}(),U=s?new Uint32Array(m):m;function g(e,i){function n(t,e){var i,n,s,a,o=t.G,c=[],h=0;switch(i=U[t.length],c[h++]=65535&i,c[h++]=i>>16&255,c[h++]=i>>24,!0){case 1===o:n=[0,o-1,0];break;case 2===o:n=[1,o-2,0];break;case 3===o:n=[2,o-3,0];break;case 4===o:n=[3,o-4,0];break;case 6>=o:n=[4,o-5,1];break;case 8>=o:n=[5,o-7,1];break;case 12>=o:n=[6,o-9,2];break;case 16>=o:n=[7,o-13,2];break;case 24>=o:n=[8,o-17,3];break;case 32>=o:n=[9,o-25,3];break;case 48>=o:n=[10,o-33,4];break;case 64>=o:n=[11,o-49,4];break;case 96>=o:n=[12,o-65,5];break;case 128>=o:n=[13,o-97,5];break;case 192>=o:n=[14,o-129,6];break;case 256>=o:n=[15,o-193,6];break;case 384>=o:n=[16,o-257,7];break;case 512>=o:n=[17,o-385,7];break;case 768>=o:n=[18,o-513,8];break;case 1024>=o:n=[19,o-769,8];break;case 1536>=o:n=[20,o-1025,9];break;case 2048>=o:n=[21,o-1537,9];break;case 3072>=o:n=[22,o-2049,10];break;case 4096>=o:n=[23,o-3073,10];break;case 6144>=o:n=[24,o-4097,11];break;case 8192>=o:n=[25,o-6145,11];break;case 12288>=o:n=[26,o-8193,12];break;case 16384>=o:n=[27,o-12289,12];break;case 24576>=o:n=[28,o-16385,13];break;case 32768>=o:n=[29,o-24577,13];break;default:r("invalid distance")}for(i=n,c[h++]=i[0],c[h++]=i[1],c[h++]=i[2],s=0,a=c.length;s<a;++s)w[p++]=c[s];v[c[0]]++,k[c[3]]++,b=t.length+e-1,y=null}var a,o,c,h,f,u,l,y,d,A={},w=s?new Uint16Array(2*i.length):[],p=0,b=0,v=new(s?Uint32Array:Array)(286),k=new(s?Uint32Array:Array)(30),m=e.w;if(!s){for(c=0;285>=c;)v[c++]=0;for(c=0;29>=c;)k[c++]=0}for(v[256]=1,a=0,o=i.length;a<o;++a){for(c=f=0,h=3;c<h&&a+c!==o;++c)f=f<<8|i[a+c];if(A[f]===t&&(A[f]=[]),u=A[f],!(0<b--)){for(;0<u.length&&32768<a-u[0];)u.shift();if(a+3>=o){for(y&&n(y,-1),c=0,h=o-a;c<h;++c)d=i[a+c],w[p++]=d,++v[d];break}0<u.length?(l=E(i,a,u),y?y.length<l.length?(d=i[a-1],w[p++]=d,++v[d],n(l,0)):n(y,-1):l.length<m?y=l:n(l,0)):y?n(y,-1):(d=i[a],w[p++]=d,++v[d])}u.push(a)}return w[p++]=256,v[256]++,e.L=v,e.K=k,s?w.subarray(0,p):w}function E(r,t,e){var i,n,s,a,o,c,h=0,f=r.length;a=0,c=e.length;r:for(;a<c;a++){if(i=e[c-a-1],s=3,3<h){for(o=h;3<o;o--)if(r[i+o-1]!==r[t+o-1])continue r;s=h}for(;258>s&&t+s<f&&r[i+s]===r[t+s];)++s;if(s>h&&(n=i,h=s),258===s)break}return new k(h,t-n)}function x(r,t){var e,i,n,a,o,c=r.length,h=new y(572),f=new(s?Uint8Array:Array)(c);if(!s)for(a=0;a<c;a++)f[a]=0;for(a=0;a<c;++a)0<r[a]&&h.push(a,r[a]);if(e=Array(h.length/2),i=new(s?Uint32Array:Array)(h.length/2),1===e.length)return f[h.pop().index]=1,f;for(a=0,o=h.length/2;a<o;++a)e[a]=h.pop(),i[a]=e[a].value;for(n=function(r,t,e){function i(r){var e=d[r][A[r]];e===t?(i(r+1),i(r+1)):--l[e],++A[r]}var n,a,o,c,h,f=new(s?Uint16Array:Array)(e),u=new(s?Uint8Array:Array)(e),l=new(s?Uint8Array:Array)(t),y=Array(e),d=Array(e),A=Array(e),w=(1<<e)-t,p=1<<e-1;for(f[e-1]=t,a=0;a<e;++a)w<p?u[a]=0:(u[a]=1,w-=p),w<<=1,f[e-2-a]=(f[e-1-a]/2|0)+t;for(f[0]=u[0],y[0]=Array(f[0]),d[0]=Array(f[0]),a=1;a<e;++a)f[a]>2*f[a-1]+u[a]&&(f[a]=2*f[a-1]+u[a]),y[a]=Array(f[a]),d[a]=Array(f[a]);for(n=0;n<t;++n)l[n]=e;for(o=0;o<f[e-1];++o)y[e-1][o]=r[o],d[e-1][o]=o;for(n=0;n<e;++n)A[n]=0;for(1===u[e-1]&&(--l[0],++A[e-1]),a=e-2;0<=a;--a){for(c=n=0,h=A[a+1],o=0;o<f[a];o++)(c=y[a+1][h]+y[a+1][h+1])>r[n]?(y[a][o]=c,d[a][o]=t,h+=2):(y[a][o]=r[n],d[a][o]=n,++n);A[a]=0,1===u[a]&&i(a)}return l}(i,i.length,t),a=0,o=e.length;a<o;++a)f[e[a].index]=n[a];return f}function M(r){var t,e,i,n,a=new(s?Uint16Array:Array)(r.length),o=[],c=[],h=0;for(t=0,e=r.length;t<e;t++)o[r[t]]=1+(0|o[r[t]]);for(t=1,e=16;t<=e;t++)c[t]=h,h+=0|o[t],h<<=1;for(t=0,e=r.length;t<e;t++)for(h=c[r[t]],c[r[t]]+=1,i=a[t]=0,n=r[t];i<n;i++)a[t]=a[t]<<1|1&h,h>>>=1;return a}function T(t,e){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=s?new Uint8Array(t):t,this.s=!1,this.n=D,this.B=!1,!e&&(e={})||(e.index&&(this.c=e.index),e.bufferSize&&(this.m=e.bufferSize),e.bufferType&&(this.n=e.bufferType),e.resize&&(this.B=e.resize)),this.n){case F:this.b=32768,this.a=new(s?Uint8Array:Array)(32768+this.m+258);break;case D:this.b=0,this.a=new(s?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:r(Error("invalid inflate mode"))}}var F=0,D=1,z={D:F,C:D};T.prototype.p=function(){for(;!this.s;){var i=Y(this,3);switch(1&i&&(this.s=e),i>>>=1){case 0:var n=this.input,a=this.c,o=this.a,c=this.b,h=n.length,f=t,u=o.length,l=t;switch(this.e=this.g=0,a+1>=h&&r(Error("invalid uncompressed block header: LEN")),f=n[a++]|n[a++]<<8,a+1>=h&&r(Error("invalid uncompressed block header: NLEN")),f===~(n[a++]|n[a++]<<8)&&r(Error("invalid uncompressed block header: length verify")),a+f>n.length&&r(Error("input buffer is broken")),this.n){case F:for(;c+f>o.length;){if(f-=l=u-c,s)o.set(n.subarray(a,a+l),c),c+=l,a+=l;else for(;l--;)o[c++]=n[a++];this.b=c,o=this.f(),c=this.b}break;case D:for(;c+f>o.length;)o=this.f({v:2});break;default:r(Error("invalid inflate mode"))}if(s)o.set(n.subarray(a,a+f),c),c+=f,a+=f;else for(;f--;)o[c++]=n[a++];this.c=a,this.b=c,this.a=o;break;case 1:this.o(G,R);break;case 2:var y,A,w,p,b=Y(this,5)+257,v=Y(this,5)+1,k=Y(this,4)+4,m=new(s?Uint8Array:Array)(O.length),U=t,g=t,E=t,x=t,M=t;for(M=0;M<k;++M)m[O[M]]=Y(this,3);if(!s)for(M=k,k=m.length;M<k;++M)m[O[M]]=0;for(y=d(m),U=new(s?Uint8Array:Array)(b+v),M=0,p=b+v;M<p;)switch(g=J(this,y),g){case 16:for(x=3+Y(this,2);x--;)U[M++]=E;break;case 17:for(x=3+Y(this,3);x--;)U[M++]=0;E=0;break;case 18:for(x=11+Y(this,7);x--;)U[M++]=0;E=0;break;default:E=U[M++]=g}A=d(s?U.subarray(0,b):U.slice(0,b)),w=d(s?U.subarray(b):U.slice(b)),this.o(A,w);break;default:r(Error("unknown BTYPE: "+i))}}return this.t()};var q,C,N=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],O=s?new Uint16Array(N):N,j=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],I=s?new Uint16Array(j):j,Z=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],S=s?new Uint8Array(Z):Z,$=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],_=s?new Uint16Array($):$,V=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],B=s?new Uint8Array(V):V,L=new(s?Uint8Array:Array)(288);for(q=0,C=L.length;q<C;++q)L[q]=143>=q?8:255>=q?9:279>=q?7:8;var P,W,G=d(L),H=new(s?Uint8Array:Array)(30);for(P=0,W=H.length;P<W;++P)H[P]=5;var R=d(H);function Y(t,e){for(var i,n=t.g,s=t.e,a=t.input,o=t.c,c=a.length;s<e;)o>=c&&r(Error("input buffer is broken")),n|=a[o++]<<s,s+=8;return i=n&(1<<e)-1,t.g=n>>>e,t.e=s-e,t.c=o,i}function J(t,e){for(var i,n,s=t.g,a=t.e,o=t.input,c=t.c,h=o.length,f=e[0],u=e[1];a<u&&!(c>=h);)s|=o[c++]<<a,a+=8;return(n=(i=f[s&(1<<u)-1])>>>16)>a&&r(Error("invalid code length: "+n)),t.g=s>>n,t.e=a-n,t.c=c,65535&i}function K(r){if("string"==typeof r){var t,e,i=r.split("");for(t=0,e=i.length;t<e;t++)i[t]=(255&i[t].charCodeAt(0))>>>0;r=i}for(var n,s=1,a=0,o=r.length,c=0;0<o;){o-=n=1024<o?1024:o;do{a+=s+=r[c++]}while(--n);s%=65521,a%=65521}return(a<<16|s)>>>0}function X(t,e){var i,n;switch(this.input=t,this.c=0,!e&&(e={})||(e.index&&(this.c=e.index),e.verify&&(this.M=e.verify)),i=t[this.c++],n=t[this.c++],15&i){case Q:this.method=Q;break;default:r(Error("unsupported compression method"))}0!=((i<<8)+n)%31&&r(Error("invalid fcheck flag:"+((i<<8)+n)%31)),32&n&&r(Error("fdict flag is not supported")),this.A=new T(t,{index:this.c,bufferSize:e.bufferSize,bufferType:e.bufferType,resize:e.resize})}T.prototype.o=function(r,t){var e=this.a,i=this.b;this.u=r;for(var n,s,a,o,c=e.length-258;256!==(n=J(this,r));)if(256>n)i>=c&&(this.b=i,e=this.f(),i=this.b),e[i++]=n;else for(o=I[s=n-257],0<S[s]&&(o+=Y(this,S[s])),n=J(this,t),a=_[n],0<B[n]&&(a+=Y(this,B[n])),i>=c&&(this.b=i,e=this.f(),i=this.b);o--;)e[i]=e[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},T.prototype.I=function(r,t){var e=this.a,i=this.b;this.u=r;for(var n,s,a,o,c=e.length;256!==(n=J(this,r));)if(256>n)i>=c&&(c=(e=this.f()).length),e[i++]=n;else for(o=I[s=n-257],0<S[s]&&(o+=Y(this,S[s])),n=J(this,t),a=_[n],0<B[n]&&(a+=Y(this,B[n])),i+o>c&&(c=(e=this.f()).length);o--;)e[i]=e[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},T.prototype.f=function(){var r,t,e=new(s?Uint8Array:Array)(this.b-32768),i=this.b-32768,n=this.a;if(s)e.set(n.subarray(32768,e.length));else for(r=0,t=e.length;r<t;++r)e[r]=n[r+32768];if(this.l.push(e),this.q+=e.length,s)n.set(n.subarray(i,i+32768));else for(r=0;32768>r;++r)n[r]=n[i+r];return this.b=32768,n},T.prototype.J=function(r){var t,e,i,n=this.input.length/this.c+1|0,a=this.input,o=this.a;return r&&("number"==typeof r.v&&(n=r.v),"number"==typeof r.F&&(n+=r.F)),2>n?e=(i=(a.length-this.c)/this.u[2]/2*258|0)<o.length?o.length+i:o.length<<1:e=o.length*n,s?(t=new Uint8Array(e)).set(o):t=o,this.a=t},T.prototype.t=function(){var r,t,e,i,n,a=0,o=this.a,c=this.l,h=new(s?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return s?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(t=0,e=c.length;t<e;++t)for(i=0,n=(r=c[t]).length;i<n;++i)h[a++]=r[i];for(t=32768,e=this.b;t<e;++t)h[a++]=o[t];return this.l=[],this.buffer=h},T.prototype.H=function(){var r,t=this.b;return s?this.B?(r=new Uint8Array(t)).set(this.a.subarray(0,t)):r=this.a.subarray(0,t):(this.a.length>t&&(this.a.length=t),r=this.a),this.buffer=r},X.prototype.p=function(){var t,e=this.input;return t=this.A.p(),this.c=this.A.c,this.M&&((e[this.c++]<<24|e[this.c++]<<16|e[this.c++]<<8|e[this.c++])>>>0!==K(t)&&r(Error("invalid adler-32 checksum"))),t};var Q=8;function rr(r,t){this.input=r,this.a=new(s?Uint8Array:Array)(32768),this.h=tr.k;var e,i={};for(e in!t&&(t={})||"number"!=typeof t.compressionType||(this.h=t.compressionType),t)i[e]=t[e];i.outputBuffer=this.a,this.z=new A(this.input,i)}var tr=b;function er(r,t){var e,i,s,a;if(Object.keys)e=Object.keys(t);else for(i in e=[],s=0,t)e[s++]=i;for(s=0,a=e.length;s<a;++s)n(r+"."+(i=e[s]),t[i])}rr.prototype.j=function(){var t,e,i,n,a,o,c,h=0;switch(c=this.a,t=Q){case Q:e=Math.LOG2E*Math.log(32768)-8;break;default:r(Error("invalid compression method"))}switch(i=e<<4|t,c[h++]=i,t){case Q:switch(this.h){case tr.NONE:a=0;break;case tr.r:a=1;break;case tr.k:a=2;break;default:r(Error("unsupported compression type"))}break;default:r(Error("invalid compression method"))}return n=a<<6|0,c[h++]=n|31-(256*i+n)%31,o=K(this.input),this.z.b=h,h=(c=this.z.j()).length,s&&((c=new Uint8Array(c.buffer)).length<=h+4&&(this.a=new Uint8Array(c.length+4),this.a.set(c),c=this.a),c=c.subarray(0,h+4)),c[h++]=o>>24&255,c[h++]=o>>16&255,c[h++]=o>>8&255,c[h++]=255&o,c},n("Zlib.Inflate",X),n("Zlib.Inflate.prototype.decompress",X.prototype.p),er("Zlib.Inflate.BufferType",{ADAPTIVE:z.C,BLOCK:z.D}),n("Zlib.Deflate",rr),n("Zlib.Deflate.compress",(function(r,t){return new rr(r,t).j()})),n("Zlib.Deflate.prototype.compress",rr.prototype.j),er("Zlib.Deflate.CompressionType",{NONE:tr.NONE,FIXED:tr.r,DYNAMIC:tr.k})}.call(self);class c{constructor(r=257){this.gridSize=r;const t=r-1;if(t&t-1)throw new Error(\`Expected grid size to be 2^n+1, got ${mA}r}.\`);this.numTriangles=t*t*2-2,this.numParentTriangles=this.numTriangles-t*t,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let r=0;r<this.numTriangles;r++){let e=r+2,i=0,n=0,s=0,a=0,o=0,c=0;for(1&e?s=a=o=t:i=n=c=t;(e>>=1)>1;){const r=i+s>>1,t=n+a>>1;1&e?(s=i,a=n,i=o,n=c):(i=s,n=a,s=o,a=c),o=r,c=t}const h=4*r;this.coords[h+0]=i,this.coords[h+1]=n,this.coords[h+2]=s,this.coords[h+3]=a}}createTile(r){return new h(r,this)}}class h{constructor(r,t){const e=t.gridSize;if(r.length!==e*e)throw new Error(\`Expected terrain data of length ${mA}e*e} (${mA}e} x ${mA}e}), got ${mA}r.length}.\`);this.terrain=r,this.martini=t,this.errors=new Float32Array(r.length),this.update()}update(){const{numTriangles:r,numParentTriangles:t,coords:e,gridSize:i}=this.martini,{terrain:n,errors:s}=this;for(let a=r-1;a>=0;a--){const r=4*a,o=e[r+0],c=e[r+1],h=e[r+2],f=e[r+3],u=o+h>>1,l=c+f>>1,y=u+l-c,d=l+o-u,A=(n[c*i+o]+n[f*i+h])/2,w=l*i+u,p=Math.abs(A-n[w]);if(s[w]=Math.max(s[w],p),a<t){const r=(c+d>>1)*i+(o+y>>1),t=(f+d>>1)*i+(h+y>>1);s[w]=Math.max(s[w],s[r],s[t])}}}getMesh(r=0){const{gridSize:t,indices:e}=this.martini,{errors:i}=this;let n=0,s=0;const a=t-1;function o(a,c,h,f,u,l){const y=a+h>>1,d=c+f>>1;Math.abs(a-u)+Math.abs(c-l)>1&&i[d*t+y]>r?(o(u,l,a,c,y,d),o(h,f,u,l,y,d)):(e[c*t+a]=e[c*t+a]||++n,e[f*t+h]=e[f*t+h]||++n,e[l*t+u]=e[l*t+u]||++n,s++)}e.fill(0),o(0,0,a,a,a,0),o(a,a,0,0,0,a);const c=new Uint16Array(2*n),h=new Uint32Array(3*s);let f=0;function u(n,s,a,o,l,y){const d=n+a>>1,A=s+o>>1;if(Math.abs(n-l)+Math.abs(s-y)>1&&i[A*t+d]>r)u(l,y,n,s,d,A),u(a,o,l,y,d,A);else{const r=e[s*t+n]-1,i=e[o*t+a]-1,u=e[y*t+l]-1;c[2*r]=n,c[2*r+1]=s,c[2*i]=a,c[2*i+1]=o,c[2*u]=l,c[2*u+1]=y,h[f++]=r,h[f++]=i,h[f++]=u}}return u(0,0,a,a,a,0),u(a,a,0,0,0,a),{vertices:c,triangles:h}}getMeshWithSkirts(r=0){const{gridSize:t,indices:e}=this.martini,{errors:i}=this;let n=0,s=0;const a=t-1;let o,c,h=0;const f=[],u=[],l=[],y=[];function d(A,w,p,b,v,k){const m=A+p>>1,U=w+b>>1;Math.abs(A-v)+Math.abs(w-k)>1&&i[U*t+m]>r?(d(v,k,A,w,m,U),d(p,b,v,k,m,U)):(o=w*t+A,c=b*t+p,h=k*t+v,0===e[o]&&(0===A?f.push(n):A===a&&u.push(n),0===w?l.push(n):w===a&&y.push(n),e[o]=++n),0===e[c]&&(0===p?f.push(n):p===a&&u.push(n),0===b?l.push(n):b===a&&y.push(n),e[c]=++n),0===e[h]&&(0===v?f.push(n):v===a&&u.push(n),0===k?l.push(n):k===a&&y.push(n),e[h]=++n),s++)}e.fill(0),d(0,0,a,a,a,0),d(a,a,0,0,0,a);const A=2*(n+f.length+u.length+l.length+y.length),w=3*(s+2*(f.length-1)+2*(u.length-1)+2*(l.length-1)+2*(y.length-1)),p=new Uint16Array(A),b=new Uint32Array(w);let v=0;function k(n,s,a,o,c,h){const f=n+a>>1,u=s+o>>1;if(Math.abs(n-c)+Math.abs(s-h)>1&&i[u*t+f]>r)k(c,h,n,s,f,u),k(a,o,c,h,f,u);else{const r=e[s*t+n]-1,i=e[o*t+a]-1,f=e[h*t+c]-1;p[2*r]=n,p[2*r+1]=s,p[2*i]=a,p[2*i+1]=o,p[2*f]=c,p[2*f+1]=h,b[v++]=r,b[v++]=i,b[v++]=f}}k(0,0,a,a,a,0),k(a,a,0,0,0,a),f.sort((r,t)=>p[2*r+1]-p[2*t+1]),u.sort((r,t)=>p[2*t+1]-p[2*r+1]),l.sort((r,t)=>p[2*t]-p[2*r]),y.sort((r,t)=>p[2*r]-p[2*t]);let m,U,g,E,x=2*n,M=0;function T(r){M=r.length;for(let t=0;t<M-1;t++)m=r[t],U=r[t+1],g=x/2,E=(x+2)/2,p[x++]=p[2*m],p[x++]=p[2*m+1],b[v++]=m,b[v++]=g,b[v++]=U,b[v++]=g,b[v++]=E,b[v++]=U;p[x++]=p[2*r[M-1]],p[x++]=p[2*r[M-1]+1]}return T(f),T(u),T(l),T(y),{vertices:p,triangles:b,numVerticesWithoutSkirts:n,numTriangles:s}}}let f;const u=new OffscreenCanvas(514,514),l=u.getContext("2d",{willReadFrequently:!0}),y={},d=64,A=64,w=3,p=-1e3,b=.001,v=256,k=4,m=.002,U={cesium_request_token:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"},tianditu:{"Accept-Encoding":"gzip, deflate, br"},cesium:{"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"},mapbox:{Accept:"image/webp,*/*"}};let g=null;function E(r){const t=new DataView(r),e=new Uint8Array(t.byteLength);let i=0;for(;i<t.byteLength;)e[i]=t.getUint8(i,!0),i++;return function(r){const t=d,e=A,i=t+1,n=e+1,s=w,a=p,o=b,c=v,h=m,f=new Float32Array(i*n);let u=0;for(let l=0;l<i;l++){const i=l>=e?e-1:l;for(let e=0;e<n;e++){let n=0;const l=i*(4*t)+4*(e>=t?t-1:e);for(let t=0;t<s;t++)n=n*c+r[l+t];n=1*(n*o+a),n-=h,f[u]=n,u++}}return f}(function(r){const t=r,e=d,i=A,n=new Uint8Array(e*i*k);let s,a,o,c,h;for(let r=0;r<i;r++)for(let f=0;f<e;f++){c=parseInt(149*r/(i-1)),h=parseInt(149*f/(e-1)),a=2*(150*c+h),s=t[a]+256*t[a+1],(s>1e4||s<-2e3)&&(s=0),o=4*(r*e+f);const u=(s+1e3)/b,l=v;n[o]=u/(l*l),n[o+1]=(u-n[o]*l*l)/l,n[o+2]=u-n[o]*l*l-n[o+1]*l,n[o+3]=255}return n}(function(r){if(r.length<1e3)return;const t=new Zlib.Inflate(r);return t?t.decompress():void 0}(e)))}function x(r){return r>>1^-(1&r)}function M(r){let t=0;const e=3*Float64Array.BYTES_PER_ELEMENT,i=4*Float64Array.BYTES_PER_ELEMENT,n=3*Uint16Array.BYTES_PER_ELEMENT;let s=Uint16Array.BYTES_PER_ELEMENT;const a=new DataView(r);t+=e;const o=a.getFloat32(t,!0);t+=Float32Array.BYTES_PER_ELEMENT;const c=a.getFloat32(t,!0);t+=Float32Array.BYTES_PER_ELEMENT,t+=i,t+=e;const h=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const f=new Uint16Array(r,t,3*h);t+=h*n,h>65536&&(s=Uint32Array.BYTES_PER_ELEMENT);!function(r,t,e){const i=r.length;let n=0,s=0,a=0;for(let o=0;o<i;++o)n+=x(r[o]),s+=x(t[o]),r[o]=n,t[o]=s,e&&(a+=x(e[o]),e[o]=a)}(f.subarray(0,h),f.subarray(h,2*h),f.subarray(2*h,3*h)),t%s!=0&&(t+=s-t%s);const u=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const l=h>65536?new Uint32Array(r,t,3*u):new Uint16Array(r,t,3*u);let y=0;const d=l.length;for(let r=0;r<d;++r){const t=l[r];l[r]=y-t,0===t&&++y}const A={minimumHeight:o,maximumHeight:c,quantizedVertices:f,indices:l}.quantizedVertices,w=A.length/3,p=A.subarray(0,w),b=A.subarray(w,2*w),v=A.subarray(2*w,3*w),k=new Float32Array(3*w),m=new Float32Array(2*w);for(let r=0;r<w;++r){const t=p[r]/32767,e=b[r]/32767,i=(U=o,g=c,(1-(E=v[r]/32767))*U+E*g);m[2*r]=t,m[2*r+1]=1-e,k[3*r]=256*t,k[3*r+1]=256*-(1-e),k[3*r+2]=i}var U,g,E;return{positions:k,texcoords:m,triangles:l}}function T(r,t,e,i,n,s,a){"cesium"===e&&(t={"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01",Authorization:"Bearer "+g}),function(r,t,e){const i={method:"GET",referrer:e,headers:t},n=o.getArrayBuffer(r,i),s=n.xhr;return y[r]=s,n.then(t=>(delete y[r],t))}(r,t,origin).then(r=>{if(!r||r.message)a({error:r||{canceled:!0}});else{const t=r.data;let o=null;if("tianditu"===e){o=E(t);const e=z(n,o,i);r.transferables.push(e.positions.buffer,e.texcoords.buffer,e.triangles.buffer),a({data:o,mesh:e},r.transferables)}else if("cesium"===e){o=M(t);const r=[o.positions.buffer,o.texcoords.buffer,o.triangles.buffer];a(o,r)}else"mapbox"===e&&(o=function(r){const t=new self.Blob([new Uint8Array(r)],{type:"image/png"});return self.createImageBitmap(t)}(t),o.then(r=>{const t=function(r){const{width:t,height:e}=r;return u.width=t,u.height=e,l.drawImage(r,0,0,t,e),l.getImageData(0,0,t,e)}(r),e=D(t,i);F(n,e,i,s,t,!0,a)}))}}).catch(t=>{delete y[r],a({error:t})})}function F(r,t,e,i,n,s,a){const o=z(r,t.data,e),c=[o.positions.buffer,o.texcoords.buffer,o.triangles.buffer],h={mesh:o};if(s)if(h.data=t,i){const r=D(n,n.width+1);h.data=r,c.push(r.data.buffer)}else c.push(t.data.buffer);a(h,c)}function D(r,t){const{data:e,width:i}=r;let n=1/0,s=-1/0;const a=new Float32Array(t*t),o=Math.round(i/t),c=t-1-1;for(let r=0;r<t;r++)for(let h=0;h<t;h++){const f=r+h*t;let u=0,l=0,y=r,d=h;y>=c&&(y=c),d>=c&&(d=c);for(let r=0;r<o;r++)for(let t=0;t<o;t++){const n=y*o+r+(d*o+t)*i,s=e[4*n],a=e[4*n+1],c=e[4*n+2];0===e[4*n+3]?l+=1:u+=.1*(256*s*256+256*a+c)-1e4}u/=o*o-l||1,u>s&&(s=u),u<n&&(n=u),a[f]=u}return{data:a,width:t,height:t,min:n,max:s}}function z(r,t,e){const i=new c(e).createTile(t).getMesh(r),{triangles:n,vertices:s}=i,a=[],o=[];for(let r=0;r<s.length/2;r++){const i=s[2*r],n=s[2*r+1];a.push(1*i),a.push(1*-n),a.push(t[n*e+i]),o.push(i/e),o.push(n/e)}return{positions:new Float32Array(a),texcoords:new Float32Array(o),triangles:n}}const q={};r.initialize=function(){},r.onmessage=function(r,t){const e=r.data;if("addLayer"===e.command||"removeLayer"===e.command)f=r.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:f,params:"ok",callback:r.callback});else if("createTerrainMesh"===e.command){const{error:r,terrainHeights:i,terrainWidth:n}=e.params;let s=i;i.width!==n&&(s=function(r,t){const{data:e,width:i}=r,n=q[t]=q[t]||new Float32Array(t*t);let s=1/0,a=-1/0;const o=i>t?Math.round(i/t):Math.round(t/i),c=t-1;for(let r=0;r<t;r++)for(let h=0;h<t;h++){const f=r+h*t;let u=0,l=r,y=h;if(l>=c&&(l=c),y>=c&&(y=c),i>t){for(let r=0;r<o;r++)for(let t=0;t<o;t++){u+=e[l*o+r+(y*o+t)*i]}u/=o*o||1}else{u=e[Math.floor(l/o)+Math.floor(y/o)*i]}u>a&&(a=u),u<s&&(s=u),n[f]=u}return{data:n,width:t,height:t,min:s,max:a}}(i,n)),F(r,s,n,null,null,!1,(r,e)=>{r.data=i,e.push(i.data.buffer),t(r.error,r,e)})}else"fetchTerrain"===e.command?function(r,t){const{url:e,origin:i,type:n,accessToken:s,terrainWidth:a,error:o,maxAvailable:c}=r,h=r.headers||U[n];if("tianditu"===n)T(e,h,n,a,o,c,t);else if("cesium"===n){const r="https://api.cesium.com/v1/assets/1/endpoint?access_token="+s;g?T(e,h,n,a,o,c,t):fetch(r,{responseType:"json",method:"GET",referrer:i,headers:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"}}).then(r=>r.json()).then(r=>{g=r.accessToken,T(e,h,n,a,o,c,t)})}else"mapbox"===n&&T(e,h,n,a,o,c,t)}(e.params,(r,e)=>{t(r.error,r,e)}):"abortTerrain"===e.command&&(i=e.params.url,y[i]&&(y[i].abort(),delete y[i]));var i}}`;o.registerWorkerAdapter("@maptalks/terrain",gA),t.GLContext=mw,t.GroundPainter=bT,t.GroupGLLayer=HM,t.HeatmapProcess=iA,t.HighlightUtil=eA,t.MaskLayerMixin=oA,t.MaskRendererMixin=aA,t.createREGL=a,t.glMatrix=g,t.mat2=G,t.mat2d=mt,t.mat3=Zt,t.mat4=ze,t.quat=ur,t.quat2=Jr,t.reshader=ew,t.transcoders=cA,t.vec2=Uo,t.vec3=Nn,t.vec4=Ti,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("@maptalks/gl v0.80.0")}(e,n(238))}}]);